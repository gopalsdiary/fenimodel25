<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Result Viewer</title>
    <style>
        :root { --bg:#f6f8fa; --card:#ffffff; --border:#d0d7de; --accent:#0366d6; --accent-hover:#024c9e; --danger:#d73a49; --warning:#ff8a00; --radius:6px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
        body { margin:0; background:var(--bg); color:#24292f; }
    header { background:#0d1117; color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    .hdr-badge { font-size:12px; color:#bbb; }
        h1 { font-size:20px; margin:0; font-weight:600; }
        .container { width:100%; max-width:100%; margin:0 0 60px 0; background:var(--card); border:1px solid var(--border); border-radius:0; padding:18px 12px 28px; box-shadow:0 2px 4px rgba(0,0,0,.04); }
        .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:14px; }
        .toolbar label { font-size:12px; color:#555; display:block; margin-bottom:4px; }
        .toolbar select { padding:8px 10px; border:1px solid var(--border); border-radius:4px; font-size:14px; background:#fff; }
        button { cursor:pointer; font-size:12px; line-height:1.2; padding:6px 10px; border-radius:4px; border:1px solid var(--accent); background:var(--accent); color:#fff; font-weight:500; }
        button:hover { background:var(--accent-hover); }
        button.secondary { background:#fff; color:var(--accent); }
        button.secondary:hover { background:#e7f3ff; }
        button.warning { background:var(--warning); border-color:var(--warning); }
        button.warning:hover { background:#e07000; }
        .status { font-size:13px; min-height:18px; }
        .status.ok { color:#1a7f37; }
        .status.err { color:var(--danger); }
        .fail-cell { background-color: #ffebee !important; color: #d73a49 !important; }
    .table-wrap { overflow:auto; max-height:none; overflow-x:hidden; }
        table { width:100%; border-collapse:collapse; font-size:13.5px; margin-top:4px; }
        thead { background:#fafbfc; position:sticky; top:0; z-index:5; }
    th, td { border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:middle; }
        th { font-weight:600; font-size:12.5px; letter-spacing:.5px; background:#f0f3f6; }
    /* Two-level header grouping */
    thead tr:first-child th { position:sticky; top:0; z-index:6; }
    thead tr:nth-child(2) th { position:sticky; top:34px; z-index:6; }
    th.base-col { background:#e9edf1; }
    /* Fixed width columns for key identity fields */
    .fixedcm { width:3cm; min-width:1.5cm; max-width:1.5cm; white-space:normal; overflow:visible; text-overflow:clip; word-break:break-word; line-height:1.1; }
    .fixedcm-wrap { width:3cm; min-width:3cm; max-width:1cm; white-space:normal; }
    
    /* Specific column widths */
    .col-iid { width:1.8cm; min-width:1.8cm; max-width:1.8cm; white-space:normal; overflow:visible; text-overflow:clip; word-break:break-word; line-height:1.1; }
    .col-student-name { width:3cm; min-width:3cm; max-width:3cm; white-space:normal; overflow:visible; text-overflow:clip; word-break:break-word; line-height:1.1; }
    .col-father-name { width:3cm; min-width:3cm; max-width:3cm; white-space:normal; overflow:visible; text-overflow:clip; word-break:break-word; line-height:1.1; }
    .col-roll { width:1cm; min-width:1cm; max-width:1cm; white-space:normal; overflow:visible; text-overflow:clip; word-break:break-word; line-height:1.1; }
    .col-class { width:auto; min-width:fit-content; max-width:none; white-space:nowrap; overflow:visible; text-overflow:clip; padding:6px 8px; }
    th.subject-group { 
        writing-mode:vertical-rl; 
        transform:rotate(180deg); 
        padding:4px 2px; 
        font-size:11px; 
        letter-spacing:.5px; 
        background:#dfe6ed; 
        white-space:normal; 
        word-wrap:break-word; 
        height:2.5cm; 
        min-height:2.5cm; 
        max-height:2.5cm; 
        vertical-align:top; 
        text-align:center; 
        border: 1px solid var(--border) !important; 
        box-sizing: border-box; 
    }
    th.subject-group span { display:inline-block; }
    th.component-col { background:#f0f3f6; font-size:11px; padding:4px 4px; min-width:40px; writing-mode:vertical-rl; transform:rotate(180deg); white-space:nowrap; border: 1px solid var(--border) !important; box-sizing: border-box; }
    td.component-col { text-align:center; padding:4px 4px; font-size:12px; }
    table { table-layout:fixed; }
    /* Make numeric cells wrap less */
    td.component-col { white-space:nowrap; }
    /* Responsive fallback: remove vertical writing on narrow screens */
    @media (max-width:820px){
        th.subject-group { 
            writing-mode:initial; 
            transform:none; 
            padding:6px 4px; 
            height:2.5cm; 
            min-height:2.5cm; 
            max-height:2.5cm; 
            white-space:normal; 
            word-wrap:break-word; 
            vertical-align:top; 
            text-align:center; 
            border: 1px solid var(--border) !important; 
            box-sizing: border-box; 
        }
        th.component-col { writing-mode:initial; transform:none; padding:6px 4px; text-align:center; border: 1px solid var(--border) !important; box-sizing: border-box; }
        thead tr:nth-child(2) th { top:56px; }
    }
        tbody tr:nth-child(even){ background:#fcfcfd; }
        tbody tr:hover { background:#fffbe6; }
    .export-bar { margin-top:18px; display:flex; gap:10px; flex-wrap:wrap; }
    .toolbar-actions { display:flex; gap:8px; align-items:flex-end; margin-left:auto; }
    .hidden { display:none !important; }
    .cs-banner { text-align:center; font-weight:600; margin:6px 0 10px; font-size:14px; letter-spacing:.5px; }
        #count { font-size:12px; color:#6a737d; margin-top:6px; }
        
        /* Print styles */
        @media print {
            @page { size: legal landscape; margin: 0.3cm; }
            
            /* Hide UI elements */
            header, .toolbar, .export-bar, #msg, #count, .toolbar-actions { display: none !important; }
            
            body { 
                background: #fff; 
                color: #000; 
                font-size: 10pt;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Reset container */
            .container {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }
            
            /* Print Header */
            .cs-banner {
                display: block !important;
                position: static !important;
                background: transparent !important;
                color: #000 !important;
                border: none !important;
                border-bottom: 2px solid #000 !important;
                padding: 10px 0 !important;
                margin-bottom: 10px !important;
                font-size: 14pt !important;
                text-align: center !important;
            }
            
            /* Table Layout */
            .table-wrap {
                overflow: visible !important;
                max-height: none !important;
                border: none !important;
                box-shadow: none !important;
            }
            
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 13px !important;
                table-layout: fixed !important;
                page-break-after: auto !important;
                page-break-inside: auto !important;
            }
            
            thead { 
                display: table-header-group !important;
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }
            
            tbody { 
                display: table-row-group !important;
            }
            
            tr { 
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            /* Borders & Cells */
            th, td {
                border: 1px solid #000 !important;
                padding: 4px 4px !important;
                color: #000 !important;
            }
            
            th {
                background-color: #f0f0f0 !important;
                font-weight: bold !important;
                vertical-align: middle !important;
            }
            
            /* Specific Column Adjustments for Print */
            th.subject-group {
                height: 3.2cm !important;
                min-height: 3.2cm !important;
                max-height: 3.2cm !important;
                vertical-align: bottom !important;
                background-color: #e0e0e0 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                padding: 4px !important;
                text-align: center !important;
            }
            
            th.subject-group span {
                display: block !important;
                writing-mode: vertical-rl !important;
                transform: rotate(180deg) !important;
                width: 100% !important;
                white-space: nowrap !important;
                margin: 0 auto !important;
            }
            
            th.component-col {
                font-size: 11px !important;
                padding: 2px !important;
                min-width: auto !important;
                vertical-align: bottom !important;
                text-align: center !important;
            }
            
            th.component-col div {
                display: block !important;
                writing-mode: vertical-rl !important;
                transform: rotate(180deg) !important;
                white-space: nowrap !important;
                margin: 0 auto !important;
            }
            
            td.component-col {
                font-size: 13px !important;
            }
            
            /* Ensure Fail Color Prints */
            .fail-cell {
                background-color: #ffebee !important;
                color: #d73a49 !important;
                font-weight: bold !important;
            }
            
            /* Hide sticky positioning for print */
            thead tr:first-child th,
            thead tr:nth-child(2) th {
                position: static !important;
                top: auto !important;
            }
            
            /* Adjust fixed columns */
            .col-iid { width: 1.5cm !important; min-width: 1.5cm !important; }
            .col-student-name { width: 2.5cm !important; min-width: 2.5cm !important; }
            .col-father-name { width: 2.5cm !important; min-width: 2.5cm !important; }
            .col-roll { width: 0.8cm !important; min-width: 0.8cm !important; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Result Viewer</h1>
    <span class="hdr-badge">exam_test_2025</span>
    </header>
    <div class="container">
        <div class="toolbar">
            <div>
                <label for="classSelect">Class</label>
                <select id="classSelect"><option value="">Loading...</option></select>
            </div>
            <div>
                <label for="sectionSelect">Section</label>
                <select id="sectionSelect" disabled><option value="">Select Class first</option></select>
            </div>
            <div>
                <label for="toggleIID">Show IID</label>
                <input type="checkbox" id="toggleIID" />
            </div>
            <div>
                <label for="toggleFatherName">Show Father Name</label>
                <input type="checkbox" id="toggleFatherName" />
            </div>
            <div>
                <label for="toggleTotal">Show Total</label>
                <input type="checkbox" id="toggleTotal" />
            </div>
            <div>
                <label for="toggleGpa">Show GPA</label>
                <input type="checkbox" id="toggleGpa" />
            </div>
            <div>
                <label for="toggleColorFail">Color Fail</label>
                <input type="checkbox" id="toggleColorFail" checked />
            </div>
            <div class="toolbar-actions">
                <button id="clearBtn" class="secondary" disabled>Clear</button>
            </div>
        </div>
    <div id="msg" class="status"></div>
    <div id="classSectionBanner" class="cs-banner hidden"></div>
    <div id="count"></div>
    <div class="table-wrap hidden" id="tableWrap">
            <table id="dataTable">
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="export-bar">
            <!-- Fullscreen functionality removed -->
            <button id="exportExcelBtn" disabled>Export Excel</button>
            <button id="exportCsvBtn" disabled class="secondary">Export CSV</button>
            <button id="exportPdfBtn" disabled class="secondary">Export PDF</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w'
        const supabase = createClient(supabaseUrl, supabaseKey)

    const TABLE = 'exam_ann25'
    let showGpa = false
    let showTotal = false
    let showIID = false
    let showFatherName = false
    let colorFail = true

        const classSelect = document.getElementById('classSelect')
        const sectionSelect = document.getElementById('sectionSelect')
        const clearBtn = document.getElementById('clearBtn')
        const toggleGpa = document.getElementById('toggleGpa')
        const toggleTotal = document.getElementById('toggleTotal')
        const toggleIID = document.getElementById('toggleIID')
        const toggleFatherName = document.getElementById('toggleFatherName')
        const toggleColorFail = document.getElementById('toggleColorFail')
        const classSectionBanner = document.getElementById('classSectionBanner')
        const msg = document.getElementById('msg')
        const countEl = document.getElementById('count')
        const tableWrap = document.getElementById('tableWrap')
        const thead = document.getElementById('thead')
        const tbody = document.getElementById('tbody')
        const exportExcelBtn = document.getElementById('exportExcelBtn')
        const exportCsvBtn = document.getElementById('exportCsvBtn')
        const exportPdfBtn = document.getElementById('exportPdfBtn')

        // Configuration: treat numeric 0 as empty for specific columns (by exact key or regex pattern)
        // Example: add keys like '*Bangla_Total' or patterns like /_GPA$/i to ignore zeros
        const zeroEmptyColumns = new Set([
            // 'some_column_key',
        ])
        const zeroEmptyPatterns = [
            // /_GPA$/i,
            // /_Total$/i,
        ]

        function shouldTreatZeroAsEmpty(colKey){
            if(zeroEmptyColumns.has(colKey)) return true
            return zeroEmptyPatterns.some(rx=> rx.test(colKey))
        }

        function isValueEmptyForColumn(colKey, value){
            if(value === null || value === undefined) return true
            const s = String(value).trim()
            if(s === '') return true
            if(shouldTreatZeroAsEmpty(colKey)){
                const n = Number(s)
                if(!isNaN(n) && n === 0) return true
            }
            return false
        }

        let meta = { classCol:null, sectionCol:null }
        let currentRows = []

        function pickKey(keys, candidates){
            const lower = keys.reduce((m,k)=> (m[k.toLowerCase()] = k, m), {})
            for(const c of candidates){
                if(typeof c === 'string'){
                    if(lower[c.toLowerCase()]) return lower[c.toLowerCase()]
                } else if(c instanceof RegExp){
                    const found = keys.find(k=> c.test(k))
                    if(found) return found
                }
            }
            return null
        }

            async function detectMeta(){
                msg.textContent = 'Detecting columns...'
                try {
                    const { data, error } = await supabase.from(TABLE).select('*').limit(1)
                    if(error){
                        console.error('Meta detection error', error)
                        msg.textContent = 'Error reading table: '+ error.message
                        msg.className='status err'
                        return false
                    }
                    if(!data || !data.length){
                        msg.textContent = 'No rows yet. Please insert data in '+TABLE
                        msg.className='status'
                        return false
                    }
                    const sample = data[0]
                    const keys = Object.keys(sample)
                    console.log('Available columns:', keys)
                    meta.classCol = pickKey(keys, ['class_2025','class','Class','class_name','cls']) || 'class_2025'
                    meta.sectionCol = pickKey(keys, ['section_2025','section','Section','sec']) || 'section_2025'
                    if(!keys.includes(meta.classCol)){
                        msg.textContent = 'Class column not found (tried class_2025 / class).'
                        msg.className='status err'
                        return false
                    }
                    if(!keys.includes(meta.sectionCol)){
                        msg.textContent = 'Section column not found (tried section_2025 / section).'
                        msg.className='status err'
                        return false
                    }
                    return true
                } catch(e){
                    console.error('Unexpected meta detection failure', e)
                    msg.textContent = 'Unexpected error detecting columns.'
                    msg.className='status err'
                    return false
                }
            }

            async function ensureAuthAndInit(){
                msg.textContent = 'Checking session...'
                try {
                    const { data: { user } } = await supabase.auth.getUser()
                    if(!user){
                        msg.textContent = 'Not signed in. Redirecting to login...'
                        setTimeout(()=> location.href='login.html', 1200)
                        return
                    }
                    const ok = await detectMeta()
                    if(ok){ await loadClasses() }
                } catch(e){
                    console.error('Auth/init error', e)
                    msg.textContent = 'Auth/init error: ' + e.message
                    msg.className='status err'
                }
            }

        async function loadClasses(){
            msg.textContent = 'Loading classes...'
            console.log('loadClasses called, meta:', meta)
            const { data, error } = await supabase
                .from(TABLE)
                .select(`${meta.classCol}`)
                .not(meta.classCol,'is',null)
                .limit(5000)
            if(error){ 
                console.error('loadClasses error:', error)
                msg.textContent = 'Error: '+error.message; 
                msg.className='status err'; 
                return 
            }
            console.log('Class data loaded:', data?.length, 'rows')
            const values = Array.from(new Set((data||[]).map(r=> r[meta.classCol]).filter(Boolean)))
            values.sort()
            console.log('Unique classes:', values)
            classSelect.innerHTML = '<option value="">Select Class</option>' + values.map(v=>`<option value="${String(v)}">${String(v)}</option>`).join('')
            classSelect.disabled = false
            msg.textContent = 'Select a class'
        }

        async function loadSections(cls){
            sectionSelect.disabled = true
            sectionSelect.innerHTML = '<option value="">Loading...</option>'
            const { data, error } = await supabase
                .from(TABLE)
                .select(`${meta.sectionCol}`)
                .eq(meta.classCol, cls)
                .not(meta.sectionCol,'is',null)
                .limit(5000)
            if(error){ msg.textContent = 'Error: '+error.message; msg.className='status err'; return }
            const values = Array.from(new Set((data||[]).map(r=> r[meta.sectionCol]).filter(Boolean)))
            values.sort()
            sectionSelect.innerHTML = '<option value="">Select Section</option>' + values.map(v=>`<option value="${String(v)}">${String(v)}</option>`).join('')
            sectionSelect.disabled = false
            msg.textContent = 'Select section then Load Data'
        }

        async function loadRows(){
            const cls = classSelect.value
            const sec = sectionSelect.value
            if(!cls || !sec){ msg.textContent='Select class & section'; msg.className='status'; return }
            msg.textContent = 'Loading rows...'
            const { data, error } = await supabase
                .from(TABLE)
                .select('*')
                .eq(meta.classCol, cls)
                .eq(meta.sectionCol, sec)
                .limit(2000)
            if(error){ msg.textContent = 'Error: '+error.message; msg.className='status err'; return }
            currentRows = data || []
            renderTable()
            
            // Show class and section banner
            classSectionBanner.textContent = `Class: ${cls} | Section: ${sec}`
            classSectionBanner.classList.remove('hidden')
            msg.textContent = 'Loaded successfully.'
            msg.className='status ok'
            setTimeout(()=> msg.textContent='', 3000)
        }

    let orderedKeys = [] // stores the display order for export

        function renderTable(){
            if(!currentRows.length){
                thead.innerHTML=''
                tbody.innerHTML='<tr><td style="padding:12px;text-align:center" colspan="5">No rows found</td></tr>'
                tableWrap.classList.remove('hidden')
                tableWrap.style.display='block'
                exportExcelBtn.disabled = true
                exportCsvBtn.disabled = true
                exportPdfBtn.disabled = true
                countEl.textContent = ''
                return
            }
            const allKeys = Object.keys(currentRows[0])

            // Detect the Average column key (e.g., average_mark), case-insensitive -- 
            const averageKey = (function(){
                // try exact then regex variants
                const lowerMap = allKeys.reduce((m,k)=> (m[k.toLowerCase()] = k, m), {})
                if(lowerMap['average_mark']) return lowerMap['average_mark']
                // Generic matcher for 'average' or 'average_mark'
                const found = allKeys.find(k=> /^average(_mark)?$/i.test(k))
                return found || null
            })()

            // Determine which columns actually have any data across all rows
            const nonEmptyColumns = new Set()
            for(const k of allKeys){
                for(const r of currentRows){
                    const v = r[k]
                    if(!isValueEmptyForColumn(k, v)){ nonEmptyColumns.add(k); break }
                }
            }

            // Determine base columns and preferred order (class & section hidden from table)
            const baseOrderPreferred = [
                'iid',
                'student_name_en','name','student_name','student','student_en',
                'roll_2025','roll','student_roll',
                'father_name_en','father_name','father','f_name','father_name_bn'
            ]
            const baseCols = []
            for(const c of baseOrderPreferred){
                if(c && allKeys.includes(c) && !baseCols.includes(c)) baseCols.push(c)
            }
            const baseSet = new Set(baseCols)

            // Detect subject component columns (exclude GPA for grouping)
            const compRegex = /^(.*)_(CQ|MCQ|Practical|Total)$/i
            const gpaRegex = /^(.*)_GPA$/i
            const groupsMap = new Map() // baseName -> array of components
            const gpaCols = []
            for(const k of allKeys){
                if(baseSet.has(k)) continue
                let m = k.match(compRegex)
                if(m){
                    if(!nonEmptyColumns.has(k)) continue // skip empty component columns
                    const base = m[1]
                    const suffix = m[2].toUpperCase().replace('PRACTICAL','Practical')
                    if(!groupsMap.has(base)) groupsMap.set(base, [])
                    groupsMap.get(base).push({ key:k, suffix })
                    continue
                }
                m = k.match(gpaRegex)
                if(m){
                    if(!nonEmptyColumns.has(k)) continue // skip empty GPA columns
                    gpaCols.push({ key:k, base:m[1] })
                    continue
                }
                // Non-matching extras become additional base columns (rowspan=2)
                // Exclude specific columns we don't want to show
                const hiddenCols = ['class_2025', 'section_2025', 'father_mobile', 'class', 'section']
                // Also exclude the Average column here; we'll place it at the very end separately
                if(!baseSet.has(k) && !hiddenCols.includes(k) && nonEmptyColumns.has(k) && k !== averageKey) { 
                    baseCols.push(k); baseSet.add(k) 
                }
            }

            // Remove any empty groups (shouldn't exist) and sort groups alphabetically by base name
            const groups = Array.from(groupsMap.entries()).map(([base, comps])=>({ base, comps }))
                .filter(g=> g.comps.length)
                .sort((a,b)=> a.base.localeCompare(b.base))

            // Order components inside group (CQ, MCQ, Practical, Total)
            const compOrder = ['CQ','MCQ','Practical','TOTAL']
            for(const g of groups){
                g.comps.sort((a,b)=> compOrder.indexOf(a.suffix.toUpperCase()) - compOrder.indexOf(b.suffix.toUpperCase()))
            }

            // Sort GPA columns alphabetically by base name
            gpaCols.sort((a,b)=> a.base.localeCompare(b.base))

            const firstRowParts = []
            const secondRowParts = []

            // Base column headers (rowspan=2)
            const fixedTargets = new Set(['iid','student_name_en','roll_2025','father_name_en'])
            for(const b of baseCols){
                // Skip IID column if not enabled
                if(b === 'iid' && !showIID) continue
                // Skip Father Name column if not enabled
                if(b === 'father_name_en' && !showFatherName) continue
                
                const clean = b.replace(/_/g,' ')
                let cls = 'base-col'
                if(fixedTargets.has(b)) {
                    // Assign specific CSS class based on column type
                    if(b === 'iid') cls += ' col-iid'
                    else if(b === 'student_name_en') cls += ' col-student-name'
                    else if(b === 'father_name_en') cls += ' col-father-name'
                    else if(b === 'roll_2025') cls += ' col-roll'
                    else if(b === 'class_2025' || b === 'class') cls += ' col-class'
                    else cls += ' fixedcm' // fallback for other fixed columns
                }
                firstRowParts.push(`<th class="${cls}" rowspan="2">${clean}</th>`)
            }

            // Subject groups
            for(const g of groups){
                // Filter components based on visibility settings
                const visibleComps = g.comps.filter(c => {
                    const suffix = c.suffix.toUpperCase()
                    if(suffix === 'TOTAL') return showTotal
                    // Show CQ, MCQ, Practical by default, but only if column has data
                    return nonEmptyColumns.has(c.key)
                })
                
                if(visibleComps.length > 0) {
                    firstRowParts.push(`<th class="subject-group" colspan="${visibleComps.length}"><span>${g.base}</span></th>`)
                    for(const c of visibleComps){
                        const mapLbl = { 'CQ':'CQ','MCQ':'MCQ','Practical':'Pr','TOTAL':'Total' }
                        const lbl = mapLbl[c.suffix.toUpperCase()] || c.suffix
                        secondRowParts.push(`<th class="component-col" title="${c.key}"><div>${lbl}</div></th>`)
                    }
                }
            }

            // GPA columns appended at end (rowspan=2) if toggle ON
            if(showGpa){
                for(const g of gpaCols){
                    firstRowParts.push(`<th class="base-col gpa-col" rowspan="2" title="${g.key}">${g.base} GPA</th>`)
                }
            }

            // Append Average column header at the far right (rowspan=2)
            if(averageKey && nonEmptyColumns.has(averageKey)){
                const avgLabel = averageKey.replace(/_/g, ' ')
                firstRowParts.push(`<th class="base-col" rowspan="2" title="${averageKey}">${avgLabel}</th>`)
            }

            if(secondRowParts.length){
                thead.innerHTML = '<tr>' + firstRowParts.join('') + '</tr><tr>' + secondRowParts.join('') + '</tr>'
            } else {
                thead.innerHTML = '<tr>' + firstRowParts.join('') + '</tr>'
            }


            
            // Build ordered keys array
            orderedKeys = [...baseCols.filter(col => {
                // Filter out IID if not enabled
                if(col === 'iid' && !showIID) return false
                // Filter out Father Name if not enabled
                if(col === 'father_name_en' && !showFatherName) return false
                // Remove empty columns
                if(!nonEmptyColumns.has(col)) return false
                return true
            })]
            for(const g of groups){ 
                for(const c of g.comps){ 
                    const suffix = c.suffix.toUpperCase()
                    if(suffix === 'TOTAL' && !showTotal) continue
                    if(nonEmptyColumns.has(c.key)) orderedKeys.push(c.key)
                } 
            }
            if(showGpa){ for(const g of gpaCols){ if(nonEmptyColumns.has(g.key)) orderedKeys.push(g.key) } }
            // Finally, push Average column as the last column
            if(averageKey && nonEmptyColumns.has(averageKey)) orderedKeys.push(averageKey)

            // Sort rows by roll_2025 column (numeric sort)
            currentRows.sort((a, b) => {
                const rollA = parseInt(a['roll_2025'] || a['roll']) || 0
                const rollB = parseInt(b['roll_2025'] || b['roll']) || 0
                return rollA - rollB
            })

            // Pre-calculate maps for F-grade highlighting
            const colToBaseMap = {}
            for(const g of groups){
                for(const c of g.comps){
                    colToBaseMap[c.key] = g.base
                }
            }
            const baseToGpaKey = {}
            for(const g of gpaCols){
                baseToGpaKey[g.base] = g.key
            }

            // Render body rows in that order
            // reuse fixedTargets defined above
            tbody.innerHTML = currentRows.map(r=> '<tr>' + orderedKeys.map(k=> {
                const val = r[k] ?? ''
                let cellClass = /_(CQ|MCQ|Practical|Total)$/i.test(k) ? 'component-col' : ''
                
                // Check for F grade
                const base = colToBaseMap[k]
                if(base && colorFail){
                    const gpaKey = baseToGpaKey[base]
                    if(gpaKey){
                        const gpaVal = r[gpaKey]
                        if(String(gpaVal).trim().toUpperCase() === 'F'){
                            cellClass += ' fail-cell'
                        }
                    }
                }

                if(fixedTargets.has(k)) {
                    // Assign specific CSS class based on column type
                    if(k === 'iid') cellClass += (cellClass? ' ':'') + 'col-iid'
                    else if(k === 'student_name_en') cellClass += (cellClass? ' ':'') + 'col-student-name'
                    else if(k === 'father_name_en') cellClass += (cellClass? ' ':'') + 'col-father-name'
                    else if(k === 'roll_2025') cellClass += (cellClass? ' ':'') + 'col-roll'
                    else if(k === 'class_2025' || k === 'class') cellClass += (cellClass? ' ':'') + 'col-class'
                    else cellClass += (cellClass? ' ':'') + 'fixedcm' // fallback for other fixed columns
                }
                return `<td class="${cellClass}">${val}</td>`
            }).join('') + '</tr>').join('')

            tableWrap.classList.remove('hidden')
            tableWrap.style.display='block'
            exportExcelBtn.disabled = false
            exportCsvBtn.disabled = false
            exportPdfBtn.disabled = false
            countEl.textContent = currentRows.length + ' rows'
        }

        function exportExcel(){
            if(!currentRows.length) return
            if(!orderedKeys.length){ orderedKeys = Object.keys(currentRows[0]) }
            // Simple single-row header for Excel with full column names (keeps clarity)
            const header = '<tr>' + orderedKeys.map(k=> `<th>${k}</th>`).join('') + '</tr>'
            const body = currentRows.map(r=> '<tr>' + orderedKeys.map(k=> `<td>${r[k] ?? ''}</td>`).join('') + '</tr>').join('')
            const html = `<table><thead>${header}</thead><tbody>${body}</tbody></table>`
            const blob = new Blob([html], { type:'application/vnd.ms-excel' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `results_${classSelect.value}_${sectionSelect.value}.xls`
            document.body.appendChild(a)
            a.click()
            a.remove()
            URL.revokeObjectURL(url)
        }

        function exportCsv(){
            if(!currentRows.length) return
            if(!orderedKeys.length){ orderedKeys = Object.keys(currentRows[0]) }
            const lines = [ orderedKeys.join(',') ]
            currentRows.forEach(r=>{
                lines.push(orderedKeys.map(k=> '"'+ String(r[k] ?? '').replace(/"/g,'""') +'"').join(','))
            })
            const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `results_${classSelect.value}_${sectionSelect.value}.csv`
            document.body.appendChild(a)
            a.click()
            a.remove()
            URL.revokeObjectURL(url)
        }

        classSelect.addEventListener('change', ()=>{
            sectionSelect.innerHTML = '<option value="">Select Class first</option>'
            sectionSelect.disabled = true
            if(classSelect.value){ 
                loadSections(classSelect.value); 
                clearBtn.disabled = false 
            }
            else { 
                clearBtn.disabled = true 
            }
        })
        sectionSelect.addEventListener('change', ()=>{
            // Auto-load data when both class and section are selected
            if(classSelect.value && sectionSelect.value) {
                loadRows()
            }
        })
        clearBtn.addEventListener('click', ()=>{
            tbody.innerHTML=''; thead.innerHTML=''; currentRows=[]; exportExcelBtn.disabled=true; exportCsvBtn.disabled=true; exportPdfBtn.disabled=true; countEl.textContent=''; msg.textContent='Cleared.'; msg.className='status'; tableWrap.classList.add('hidden'); classSectionBanner.classList.add('hidden');
        })
        exportExcelBtn.addEventListener('click', exportExcel)
        exportCsvBtn.addEventListener('click', exportCsv)
        exportPdfBtn.addEventListener('click', () => window.print())

        // Initialize checkbox states
        showGpa = toggleGpa.checked
        showTotal = toggleTotal.checked
        showIID = toggleIID.checked
        showFatherName = toggleFatherName.checked
        colorFail = toggleColorFail.checked
        
        // Add event listeners for checkboxes
        toggleGpa.addEventListener('change', ()=>{ showGpa = toggleGpa.checked; if(currentRows.length) renderTable() })
        toggleTotal.addEventListener('change', ()=>{ showTotal = toggleTotal.checked; if(currentRows.length) renderTable() })
        toggleIID.addEventListener('change', ()=>{ showIID = toggleIID.checked; if(currentRows.length) renderTable() })
        toggleFatherName.addEventListener('change', ()=>{ showFatherName = toggleFatherName.checked; if(currentRows.length) renderTable() })
        toggleColorFail.addEventListener('change', ()=>{ colorFail = toggleColorFail.checked; if(currentRows.length) renderTable() })

        ensureAuthAndInit()
    </script>
</body>
</html>