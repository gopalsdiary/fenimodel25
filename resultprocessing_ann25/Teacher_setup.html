<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
    <title>Subject Setup - Result Processing</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg:#f6f8fa; 
            --card:#ffffff; 
            --border:#d0d7de; 
            --accent:#0366d6; 
            --accent-hover:#024c9e; 
            --danger:#d73a49; 
            --radius:6px; 
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; 
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            margin:0; 
            background:var(--bg); 
            color:#24292f; 
        }
        
        header { 
            background:#0d1117; 
            color:#fff; 
            padding:8px 15px; 
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
        }
        
        h1 { 
            font-size:18px; 
            margin:0; 
            font-weight:600; 
        }

        .container {
            width:100%; 
            max-width:100%; 
            margin:0 0 30px 0; 
            background:var(--card); 
            border:1px solid var(--border); 
            border-radius:0; 
            padding:12px 10px 18px; 
            box-shadow:0 2px 4px rgba(0,0,0,.04);
        }

        .form-section {
            background: var(--card);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,.03);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 4px;
            color: #57606a;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .3px;
        }

        select, input, textarea {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 13px;
            background: #fff;
            transition: all 0.2s ease;
            font-family: inherit;
            resize: vertical;
        }

        select:focus, input:focus, textarea:focus {
            outline: 2px solid #84c5ff;
            border-color: var(--accent);
        }

        .marks-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: var(--radius);
            margin-top: 8px;
            border: 1px solid var(--border);
        }

        .marks-table-container {
            overflow-x: auto;
            margin-top: 8px;
        }

        .marks-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .marks-table th {
            background: #f0f3f6;
            color: #24292f;
            font-weight: 600;
            font-size: 11px;
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .marks-table td {
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .marks-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .marks-table .total-row {
            background: #e7f3ff !important;
            font-weight: 600;
        }

        .marks-table .total-row td {
            border-top: 2px solid var(--accent);
        }

        .marks-input {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 3px;
            text-align: center;
            font-size: 12px;
            background: white;
        }

        .marks-input:focus {
            outline: 1px solid #84c5ff;
            border-color: var(--accent);
        }

        .btn {
            cursor: pointer;
            font-size: 11px;
            line-height: 1.1;
            padding: 6px 10px;
            border-radius: 3px;
            border: 1px solid var(--accent);
            background: var(--accent);
            color: #fff;
            font-weight: 500;
            margin: 3px 2px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .message {
            padding: 8px;
            border-radius: 3px;
            margin: 8px 0;
            font-weight: 500;
            font-size: 11px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .table-section {
            background: var(--card);
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,.03);
            display: block !important;
            visibility: visible !important;
        }

        #subjectTable {
            display: table !important;
            visibility: visible !important;
        }

        .table-wrap { 
            overflow-x: auto; 
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 6px;
        }

        thead { 
            background: #fafbfc; 
            position: sticky; 
            top: 0; 
            z-index: 5; 
        }

        th, td {
            border: 1px solid var(--border);
            padding: 4px 6px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            font-weight: 600;
            font-size: 11px;
            letter-spacing: .3px;
            background: #f0f3f6;
        }

        tbody tr:nth-child(even) { 
            background: #fcfcfd; 
        }

        tbody tr:hover {
            background: #fffbe6;
        }

        /* Enhanced styling for merged table cells */
        #subjectTable th {
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
            padding: 8px 6px;
            border: 1px solid var(--border);
            font-size: 11px;
        }

        #subjectTable td {
            padding: 6px 8px;
            text-align: center;
            border: 1px solid var(--border);
            vertical-align: middle;
            font-size: 11px;
        }

        #subjectTable tbody tr:hover {
            background: #f0f8ff;
        }

        /* Special styling for merged cells */
        #subjectTable td[rowspan] {
            background-color: #f8f9fa !important;
            font-weight: 600;
            border-right: 2px solid var(--accent);
        }

        /* Action buttons styling in table */
        #subjectTable .btn {
            padding: 3px 6px;
            font-size: 9px;
            margin: 1px;
        }

        #subjectTable .delete-btn {
            padding: 3px 6px;
            font-size: 9px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--card);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 16px;
            color: #24292f;
        }

        .close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            text-align: right;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .modal-footer .btn {
            margin-left: 10px;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
        }

        .delete-btn:hover {
            background: #b02a37;
        }

        .loading {
            text-align: center;
            color: #6a737d;
            font-style: italic;
            font-size: 11px;
        }

        .section-header {
            margin-bottom: 8px !important;
            color: #24292f !important;
            font-size: 14px;
            font-weight: 600;
        }

        .marks-header {
            text-align: center !important;
            color: #24292f !important;
            margin-bottom: 8px !important;
            font-size: 13px;
            font-weight: 600;
        }

        .form-actions {
            text-align: center !important;
            margin-top: 12px !important;
        }



        #cancelBtn {
            display: none !important;
        }



        @media (max-width: 820px) {
            .container { 
                padding: 8px 8px 15px; 
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .marks-table th, 
            .marks-table td {
                padding: 4px 3px;
                font-size: 10px;
            }
            
            .marks-input {
                width: 45px;
                font-size: 10px;
                padding: 3px 4px;
            }
            
            th, td {
                padding: 3px 4px;
                font-size: 10px;
            }
            
            .btn {
                padding: 4px 6px;
                font-size: 10px;
            }
            
            .form-section {
                padding: 8px;
                margin-bottom: 8px;
            }
            
            label {
                font-size: 10px;
            }
            
            select, input {
                padding: 4px 6px;
                font-size: 11px;
            }
        }
        
        /* Message Styles */
        .message {
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: var(--radius);
            font-weight: 500;
            border: 1px solid transparent;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 16px;">
            <button onclick="window.location.href='result_dashboard.html'" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                ‚Üê Dashboard
            </button>
            <h1>üìö Subject Setup</h1>
        </div>
    </header>
    <div class="container">
        
        <div class="form-section">
            <h2 class="section-header">Add New Subject</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="classSelect">Class</label>
                    <select id="classSelect" onchange="loadSubjects()">
                        <option value="">Select Class</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="sectionSelect">Section</label>
                    <select id="sectionSelect">
                        <option value="">Select Section</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subjectSelect">Subject</label>
                    <select id="subjectSelect">
                        <option value="">Select Subject</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teacherSelect">Teacher Name</label>
                    <select id="teacherSelect" onchange="fillTeacherEmail()">
                        <option value="">Select Teacher</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teacherEmail">Teacher Email</label>
                    <input type="email" id="teacherEmail" placeholder="Teacher email will auto-fill" readonly>
                </div>
                
                <div class="form-group">
                    <label for="comment">Comment</label>
                    <textarea id="comment" placeholder="Enter comment (optional)" rows="3"></textarea>
                </div>
            </div>



            <div class="form-actions">
                <button class="btn" onclick="saveSubject()" id="saveBtn">üíæ Save Subject</button>
                <button class="btn btn-secondary" onclick="resetForm()">üîÑ Reset Form</button>
                <button class="btn btn-secondary" onclick="cancelEdit()" id="cancelBtn">‚ùå Cancel Edit</button>
            </div>

            <div id="message"></div>
        </div>

        <div class="table-section">
            <h2 class="section-header">Existing Subject Configurations</h2>
            <div id="loadingTable" class="loading">Loading subjects...</div>
            <div class="table-wrap">
                <table id="subjectTable">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Section</th>
                        <th>Subject</th>
                        <th>Teacher Name</th>
                        <th>Teacher Email</th>
                        <th>Comment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="subjectTableBody">
                </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Subject Configuration</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editClassSelect">Class</label>
                        <select id="editClassSelect" onchange="loadEditSections()">
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSectionSelect">Section</label>
                        <select id="editSectionSelect" onchange="loadEditSubjects()">
                            <option value="">Select Section</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSubjectSelect">Subject</label>
                        <select id="editSubjectSelect">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTeacherSelect">Teacher</label>
                        <select id="editTeacherSelect" onchange="fillEditTeacherEmail()">
                            <option value="">Select Teacher</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTeacherEmail">Teacher Email</label>
                        <input type="email" id="editTeacherEmail" placeholder="Teacher email will auto-fill" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editComment">Comment</label>
                        <textarea id="editComment" placeholder="Enter comment (optional)" rows="3"></textarea>
                    </div>
                </div>


            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn" onclick="saveEditedSubject()">üíæ Save Changes</button>
            </div>
            <div id="editMessage"></div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Authorized users for editing
        const authorizedUsers = [
            'fenimodelhighschool@gmail.com',
            'gopalsdiary@gmail.com', 
            'roy.gopal159@gmail.com'
        ];

        // Global variables for edit mode and user session
        let editMode = false;
        let editingSubjectCode = null;
        let currentUser = null;
        let userCanEdit = false;



        // Generate action buttons based on user permissions
        function generateActionButtons(subjectCode) {
            if (userCanEdit) {
                return `
                    <button class="btn" style="background: #ffc107; color: #000; padding: 4px 8px; margin-right: 3px; font-size: 10px;" onclick="editSubject(${subjectCode})">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="delete-btn" onclick="deleteSubject(${subjectCode})">
                        üóëÔ∏è Delete
                    </button>
                `;
            } else {
                return '<span style="color: #6c757d; font-style: italic; font-size: 11px;">Read-only</span>';
            }
        }

        // Check user authentication and authorization
        async function checkUserAuth() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (user && user.email) {
                    currentUser = user;
                    userCanEdit = authorizedUsers.includes(user.email);
                    
                    // Show user info in header
                    showUserInfo(user.email);
                    
                    // Enable/disable editing based on authorization
                    toggleEditingInterface(userCanEdit);
                    
                    return true;
                } else {
                    // Redirect to login if no user session
                    window.location.href = 'login.html';
                    return false;
                }
            } catch (error) {
                console.error('Authentication error:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Show user information in header
        function showUserInfo(email) {
            const headerTitle = document.querySelector('h1');
            if (headerTitle) {
                headerTitle.innerHTML = `üìö Subject Setup <span style="font-size: 12px; font-weight: normal; margin-left: 20px; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 4px;">${email}</span> <button onclick="logout()" style="font-size: 11px; margin-left: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">Sign out</button>`;
            }
        }

        // Logout function
        async function logout() {
            try {
                await supabaseClient.auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            }
        }

        // Toggle editing interface based on user permissions
        function toggleEditingInterface(canEdit) {
            const saveButton = document.getElementById('saveBtn');
            const resetButton = document.getElementById('resetBtn');
            const formInputs = document.querySelectorAll('#subjectForm input, #subjectForm select');
            
            if (canEdit) {
                // Enable editing for authorized users
                if (saveButton) saveButton.style.display = 'inline-block';
                if (resetButton) resetButton.style.display = 'inline-block';
                formInputs.forEach(input => input.disabled = false);
                
                // Show edit permission message
                showMessage('‚úì You have editing permissions for this system.', 'success');
            } else {
                // Disable editing for unauthorized users
                if (saveButton) saveButton.style.display = 'none';
                if (resetButton) resetButton.style.display = 'none';
                formInputs.forEach(input => input.disabled = true);
                
                // Show read-only message
                showMessage('‚ÑπÔ∏è You have read-only access. Contact admin for editing permissions.', 'info');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // First check user authentication
            const isAuthenticated = await checkUserAuth();
            
            if (isAuthenticated) {
                loadClasses();
                loadSections();
                loadTeachers();
                loadExistingSubjects();
                
                // Ensure table is visible
                setTimeout(() => {
                    const table = document.getElementById('subjectTable');
                    const loading = document.getElementById('loadingTable');
                    if (table) {
                        table.style.display = 'table';
                        table.style.visibility = 'visible';
                    }
                    if (loading) {
                        loading.style.display = 'none';
                    }
                }, 2000); // Show table after 2 seconds regardless
            }
        });

        // Load classes
        async function loadClasses() {
            try {
                const { data, error } = await supabaseClient
                    .from('exam_ann25')
                    .select('class_2025')
                    .not('class_2025', 'is', null);

                if (error) throw error;

                const classes = [...new Set(data.map(item => item.class_2025))].sort();
                const classSelect = document.getElementById('classSelect');
                
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = `Class ${className}`;
                    classSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
                showMessage('Error loading classes: ' + error.message, 'error');
            }
        }

        // Load sections
        async function loadSections() {
            try {
                const { data, error } = await supabaseClient
                    .from('exam_ann25')
                    .select('section_2025')
                    .not('section_2025', 'is', null);

                if (error) throw error;

                const sections = [...new Set(data.map(item => item.section_2025))].sort();
                const sectionSelect = document.getElementById('sectionSelect');
                
                sections.forEach(sectionName => {
                    const option = document.createElement('option');
                    option.value = sectionName;
                    option.textContent = sectionName;
                    sectionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sections:', error);
                showMessage('Error loading sections: ' + error.message, 'error');
            }
        }

        // Load subjects based on selected class
        async function loadSubjects() {
            const selectedClass = document.getElementById('classSelect').value;
            const subjectSelect = document.getElementById('subjectSelect');
            
            // Clear previous subjects
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            
            if (!selectedClass) return;

            try {
                const { data, error } = await supabaseClient
                    .from('exam_ann25')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    console.log('All columns:', columns); // Debug: see all columns
                    
                    // Look for columns that start with asterisk (*) 
                    const asteriskColumns = columns.filter(col => col.startsWith('*'));
                    console.log('Asterisk columns:', asteriskColumns); // Debug: see asterisk columns
                    
                    // Extract subject names from asterisk columns
                    const subjects = [];
                    asteriskColumns.forEach(col => {
                        let subjectName = null;
                        
                        // Pattern for *subjectname_cq/mcq/practical/total/gpa
                        const match = col.match(/^\*(.+?)(?:_(?:cq|mcq|practical|total|gpa))?$/i);
                        if (match) {
                            subjectName = match[1].trim();
                        }
                        
                        if (subjectName && !subjects.includes(subjectName)) {
                            subjects.push(subjectName);
                        }
                    });
                    
                    console.log('Extracted subjects:', subjects); // Debug: see extracted subjects

                    if (subjects.length > 0) {
                        subjects.sort().forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject;
                            option.textContent = subject;
                            subjectSelect.appendChild(option);
                        });
                        showMessage(`Found ${subjects.length} subjects`, 'info');
                    } else {
                        showMessage('No subjects found with asterisk (*) prefix in column names', 'error');
                    }
                } else {
                    showMessage('No data found in exam_ann25 table', 'error');
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
                showMessage('Error loading subjects: ' + error.message, 'error');
            }
        }

        // Load teachers
        async function loadTeachers() {
            try {
                const { data, error } = await supabaseClient
                    .from('teacher_database')
                    .select('teacher_name_en, teacher_email_id')
                    .not('teacher_name_en', 'is', null);

                if (error) throw error;

                const teacherSelect = document.getElementById('teacherSelect');
                
                data.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.teacher_email_id;
                    option.textContent = teacher.teacher_name_en;
                    option.dataset.email = teacher.teacher_email_id;
                    teacherSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teachers:', error);
                showMessage('Error loading teachers: ' + error.message, 'error');
            }
        }



        // Fill teacher email automatically
        function fillTeacherEmail() {
            const teacherSelect = document.getElementById('teacherSelect');
            const teacherEmail = document.getElementById('teacherEmail');
            
            if (teacherSelect.value) {
                teacherEmail.value = teacherSelect.value;
            } else {
                teacherEmail.value = '';
            }
        }



        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        });

        // Save subject (handles both create and update)
        async function saveSubject() {
            // Check if user has editing permissions
            if (!userCanEdit) {
                showMessage('‚ùå You do not have permission to save subjects. Contact administrator for editing access.', 'error');
                return;
            }

            const classValue = document.getElementById('classSelect').value;
            const section = document.getElementById('sectionSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const teacherEmail = document.getElementById('teacherEmail').value;
            const teacherName = document.getElementById('teacherSelect').selectedOptions[0]?.textContent;
            const comment = document.getElementById('comment').value;

            // Debug log to check comment value
            console.log('Comment value:', comment);

            // Validation
            if (!classValue || !section || !subject || !teacherEmail) {
                showMessage('Please fill in all required fields: Class, Section, Subject, Teacher Name, Teacher Email', 'error');
                return;
            }

            const subjectData = {
                subject_name: subject,
                class: parseInt(classValue),
                section: section,
                teacher_email_id: teacherEmail,
                teacher_name_en: teacherName,
                comment: comment
            };

            // Debug log to check subject data
            console.log('Subject data to save:', subjectData);

            try {
                if (editMode && editingSubjectCode) {
                    // Update existing subject
                    const { error } = await supabaseClient
                        .from('subject_selection')
                        .update(subjectData)
                        .eq('subject_code', editingSubjectCode);

                    if (error) throw error;
                    showMessage('Subject updated successfully!', 'success');
                } else {
                    // Create new subject
                    const { error } = await supabaseClient
                        .from('subject_selection')
                        .insert([subjectData]);

                    if (error) throw error;
                    showMessage('Subject saved successfully!', 'success');
                }

                resetForm();
                loadExistingSubjects();
            } catch (error) {
                console.error('Error saving subject:', error);
                console.error('Full error details:', JSON.stringify(error, null, 2));
                showMessage('Error saving subject: ' + (error.message || error.error_description || 'Unknown error'), 'error');
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('classSelect').value = '';
            document.getElementById('sectionSelect').value = '';
            document.getElementById('subjectSelect').value = '';
            document.getElementById('teacherSelect').value = '';
            document.getElementById('teacherEmail').value = '';
            document.getElementById('comment').value = '';
            
            // Enable save button
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('saveBtn').style.opacity = '1';
            
            // Reset edit mode
            editMode = false;
            editingSubjectCode = null;
            document.getElementById('saveBtn').textContent = 'üíæ Save Subject';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // Edit subject
        async function editSubject(subjectCode) {
            // Check if user has editing permissions
            if (!userCanEdit) {
                showMessage('‚ùå You do not have permission to edit subjects. Contact administrator for editing access.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('subject_selection')
                    .select('*')
                    .eq('subject_code', subjectCode)
                    .single();

                if (error) throw error;

                // Set editing subject code
                editingSubjectCode = subjectCode;
                
                // Show modal first
                document.getElementById('editModal').style.display = 'block';
                
                // Load dropdown options
                await loadEditDropdowns();
                await loadEditSubjects();
                
                // Add a small delay to ensure dropdowns are populated
                setTimeout(async () => {
                    // Fill modal with existing data - the 6 required fields
                    document.getElementById('editClassSelect').value = data.class || '';
                    document.getElementById('editSectionSelect').value = data.section || '';
                    document.getElementById('editTeacherEmail').value = data.teacher_email_id || '';
                    document.getElementById('editComment').value = data.comment || '';
                    
                    // Set subject value with an additional delay to ensure options are loaded
                    setTimeout(() => {
                        document.getElementById('editSubjectSelect').value = data.subject_name || '';
                    }, 200);

                    // Set teacher dropdown based on email
                    const editTeacherSelect = document.getElementById('editTeacherSelect');
                    for (let option of editTeacherSelect.options) {
                        if (option.value === data.teacher_email_id) {
                            option.selected = true;
                            break;
                        }
                    }
                    
                    // Setup event listeners for dropdowns
                    document.getElementById('editClassSelect').addEventListener('change', loadEditSections);
                    document.getElementById('editTeacherSelect').addEventListener('change', fillEditTeacherEmail);
                }, 150);
                
            } catch (error) {
                console.error('Error loading subject for edit:', error);
                showMessage('Error loading subject: ' + error.message, 'error');
            }
        }

        // Cancel edit
        function cancelEdit() {
            resetForm();
            showMessage('Edit cancelled', 'info');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingSubjectCode = null;
            document.getElementById('editMessage').innerHTML = '';
            
            // Reset edit form fields
            document.getElementById('editClassSelect').value = '';
            document.getElementById('editSectionSelect').value = '';
            document.getElementById('editSubjectSelect').value = '';
            document.getElementById('editTeacherSelect').value = '';
            document.getElementById('editTeacherEmail').value = '';
            document.getElementById('editComment').value = '';
        }



        // Configure edit marks table to show only available rows


        // Load dropdown options for edit modal
        async function loadEditDropdowns() {
            console.log('Loading edit dropdowns...');
            // Load classes
            await loadEditClasses();
            // Load sections
            await loadEditAllSections();
            // Load teachers
            await loadEditTeachers();
            console.log('Edit dropdowns loaded');
        }

        // Load classes for edit modal
        async function loadEditClasses() {
            try {
                const { data, error } = await supabaseClient
                    .from('exam_ann25')
                    .select('class_2025')
                    .not('class_2025', 'is', null);

                if (error) throw error;

                const classes = [...new Set(data.map(item => item.class_2025))].sort();
                const editClassSelect = document.getElementById('editClassSelect');
                editClassSelect.innerHTML = '<option value="">Select Class</option>';
                
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = `Class ${className}`;
                    editClassSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes for edit:', error);
            }
        }

        // Load all sections for edit modal
        async function loadEditAllSections() {
            try {
                const { data, error } = await supabaseClient
                    .from('exam_ann25')
                    .select('section_2025')
                    .not('section_2025', 'is', null);

                if (error) throw error;

                const sections = [...new Set(data.map(item => item.section_2025))].sort();
                const editSectionSelect = document.getElementById('editSectionSelect');
                editSectionSelect.innerHTML = '<option value="">Select Section</option>';
                
                sections.forEach(sectionName => {
                    const option = document.createElement('option');
                    option.value = sectionName;
                    option.textContent = sectionName;
                    editSectionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sections for edit:', error);
            }
        }

        // Load sections based on selected class in edit modal
        async function loadEditSections() {
            const selectedClass = document.getElementById('editClassSelect').value;
            if (!selectedClass) return;

            await loadEditAllSections(); // Load all sections regardless of class for now
        }

        // Load subjects for edit modal (dynamic from database)
        async function loadEditSubjects() {
            const subjectSelect = document.getElementById('editSubjectSelect');
            
            // Clear previous subjects
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';

            try {
                const { data, error } = await supabaseClient
                    .from('exam_ann25')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    
                    // Look for columns that start with asterisk (*) 
                    const asteriskColumns = columns.filter(col => col.startsWith('*'));
                    
                    // Extract subject names from asterisk columns
                    const subjects = [];
                    asteriskColumns.forEach(col => {
                        let subjectName = null;
                        
                        // Pattern for *subjectname_cq/mcq/practical/total/gpa
                        const match = col.match(/^\*(.+?)(?:_(?:cq|mcq|practical|total|gpa))?$/i);
                        if (match) {
                            subjectName = match[1].trim();
                        }
                        
                        if (subjectName && !subjects.includes(subjectName)) {
                            subjects.push(subjectName);
                        }
                    });

                    if (subjects.length > 0) {
                        subjects.sort().forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject;
                            option.textContent = subject;
                            subjectSelect.appendChild(option);
                        });
                    } else {
                        // Fallback to common subjects if no asterisk columns found
                        const fallbackSubjects = ['Bangla', 'English', 'Mathematics', 'Physics', 'Chemistry', 'Biology', 'ICT', 'Accounting', 'Finance', 'Business Studies', 'Economics'];
                        fallbackSubjects.forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject;
                            option.textContent = subject;
                            subjectSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading subjects for edit:', error);
                // Fallback to common subjects on error
                const fallbackSubjects = ['Bangla', 'English', 'Mathematics', 'Physics', 'Chemistry', 'Biology', 'ICT', 'Accounting', 'Finance', 'Business Studies', 'Economics'];
                fallbackSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
            }
        }

        // Load teachers for edit modal
        async function loadEditTeachers() {
            try {
                const { data, error } = await supabaseClient
                    .from('teacher_database')
                    .select('teacher_name_en, teacher_email_id')
                    .not('teacher_name_en', 'is', null)
                    .not('teacher_email_id', 'is', null);

                if (error) {
                    console.warn('teacher_database not found, trying subject_selection table for teachers:', error);
                    await loadTeachersFromSubjectSelection();
                    return;
                }

                const editTeacherSelect = document.getElementById('editTeacherSelect');
                editTeacherSelect.innerHTML = '<option value="">Select Teacher</option>';
                
                if (data && data.length > 0) {
                    console.log('Found teachers in teacher_database:', data);
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.teacher_email_id;
                        option.textContent = teacher.teacher_name_en;
                        editTeacherSelect.appendChild(option);
                    });
                } else {
                    console.log('No teachers found in teacher_database');
                    // If no teachers found, add manual entry option
                    const option = document.createElement('option');
                    option.value = 'manual';
                    option.textContent = 'Enter Teacher Manually';
                    editTeacherSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading teachers for edit:', error);
                // Add manual entry as fallback
                const editTeacherSelect = document.getElementById('editTeacherSelect');
                editTeacherSelect.innerHTML = '<option value="">Select Teacher</option>';
                const option = document.createElement('option');
                option.value = 'manual';
                option.textContent = 'Enter Teacher Manually';
                editTeacherSelect.appendChild(option);
            }
        }

        // Load teachers from subject_selection table as fallback
        async function loadTeachersFromSubjectSelection() {
            try {
                const { data, error } = await supabaseClient
                    .from('subject_selection')
                    .select('teacher_name_en, teacher_email_id')
                    .not('teacher_name_en', 'is', null);

                if (error) throw error;

                const editTeacherSelect = document.getElementById('editTeacherSelect');
                editTeacherSelect.innerHTML = '<option value="">Select Teacher</option>';
                
                // Get unique teachers
                const uniqueTeachers = [];
                const seen = new Set();
                
                data.forEach(teacher => {
                    if (!seen.has(teacher.teacher_email_id)) {
                        seen.add(teacher.teacher_email_id);
                        uniqueTeachers.push(teacher);
                    }
                });
                
                if (uniqueTeachers.length > 0) {
                    uniqueTeachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.teacher_email_id || '';
                        option.textContent = teacher.teacher_name_en;
                        editTeacherSelect.appendChild(option);
                    });
                } else {
                    // Add manual entry option
                    const option = document.createElement('option');
                    option.value = 'manual';
                    option.textContent = 'Enter Teacher Manually';
                    editTeacherSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading teachers from subject_selection:', error);
            }
        }

        // Fill teacher email in edit modal
        function fillEditTeacherEmail() {
            const teacherSelect = document.getElementById('editTeacherSelect');
            const teacherEmail = document.getElementById('editTeacherEmail');
            
            if (teacherSelect.value === 'manual' || teacherSelect.value === '') {
                teacherEmail.value = '';
                teacherEmail.readOnly = false;
                teacherEmail.placeholder = 'Enter teacher email manually';
            } else {
                teacherEmail.value = teacherSelect.value;
                teacherEmail.readOnly = true;
                teacherEmail.placeholder = '';
            }
        }

        // Save edited subject
        async function saveEditedSubject() {
            // Check if user has editing permissions
            if (!userCanEdit) {
                showMessage('‚ùå You do not have permission to save changes. Contact administrator for editing access.', 'error');
                return;
            }

            if (!editingSubjectCode) return;
            
            try {
                const selectedTeacher = document.getElementById('editTeacherSelect');
                const teacherName = selectedTeacher.options[selectedTeacher.selectedIndex]?.text || '';
                const commentValue = document.getElementById('editComment').value;

                // Debug log for edit comment
                console.log('Edit comment value:', commentValue);

                const updateData = {
                    class: document.getElementById('editClassSelect').value,
                    section: document.getElementById('editSectionSelect').value,
                    subject_name: document.getElementById('editSubjectSelect').value,
                    teacher_name_en: teacherName,
                    teacher_email_id: document.getElementById('editTeacherEmail').value,
                    comment: commentValue
                };

                console.log('Edit data to update:', updateData);

                const { error } = await supabaseClient
                    .from('subject_selection')
                    .update(updateData)
                    .eq('subject_code', editingSubjectCode);

                if (error) throw error;

                closeEditModal();
                loadExistingSubjects();
                showMessage('Subject updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error updating subject:', error);
                document.getElementById('editMessage').innerHTML = 
                    '<div class="message error">Error updating subject: ' + error.message + '</div>';
            }
        }

        // Load existing subjects
        async function loadExistingSubjects() {
            const loadingDiv = document.getElementById('loadingTable');
            const table = document.getElementById('subjectTable');
            const tbody = document.getElementById('subjectTableBody');

            if (loadingDiv) loadingDiv.style.display = 'block';
            if (table) table.style.display = 'none';

            try {
                const { data, error } = await supabaseClient
                    .from('subject_selection')
                    .select('*')
                    .order('subject_code', { ascending: true });

                if (error) throw error;

                // Debug log to check data from database
                console.log('Data loaded from database:', data);

                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    // Group data by class and section for merging
                    const groupedData = {};
                    
                    data.forEach(subject => {
                        // Debug log for each subject's comment field
                        console.log(`Subject: ${subject.subject_name}, Comment: "${subject.comment}"`);
                        
                        const key = `${subject.class || 'N/A'}_${subject.section || 'N/A'}`;
                        if (!groupedData[key]) {
                            groupedData[key] = {
                                class: subject.class || 'N/A',
                                section: subject.section || 'N/A',
                                subjects: []
                            };
                        }
                        groupedData[key].subjects.push({
                            name: subject.subject_name || 'N/A',
                            teacher: subject.teacher_name_en || 'N/A',
                            teacher_email: subject.teacher_email_id || 'N/A',
                            comment: subject.comment || '',
                            subject_code: subject.subject_code
                        });
                    });

                    // Debug log to check grouped data with comments
                    console.log('Grouped data with comments:', groupedData);

                    // Create merged rows
                    Object.values(groupedData).forEach(group => {
                        const rowCount = group.subjects.length;
                        
                        group.subjects.forEach((subject, index) => {
                            const row = document.createElement('tr');
                            
                            if (index === 0) {
                                // First row gets the merged class and section cells
                                row.innerHTML = `
                                    <td rowspan="${rowCount}" style="vertical-align: middle; background-color: #f8f9fa; font-weight: 600;">${group.class === 'N/A' ? 'N/A' : 'Class ' + group.class}</td>
                                    <td rowspan="${rowCount}" style="vertical-align: middle; background-color: #f8f9fa; font-weight: 600;">${group.section}</td>
                                    <td>${subject.name}</td>
                                    <td>${subject.teacher}</td>
                                    <td>${subject.teacher_email || 'N/A'}</td>
                                    <td>${subject.comment || ''}</td>
                                    <td>
                                        ${generateActionButtons(subject.subject_code)}
                                    </td>
                                `;
                            } else {
                                // Subsequent rows have all columns except merged ones
                                row.innerHTML = `
                                    <td>${subject.name}</td>
                                    <td>${subject.teacher}</td>
                                    <td>${subject.teacher_email || 'N/A'}</td>
                                    <td>${subject.comment || ''}</td>
                                    <td>
                                        ${generateActionButtons(subject.subject_code)}
                                    </td>
                                `;
                            }
                            
                            tbody.appendChild(row);
                        });
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6c757d;">No subjects found</td></tr>';
                }

                if (loadingDiv) loadingDiv.style.display = 'none';
                if (table) table.style.display = 'table';
            } catch (error) {
                console.error('Error loading subjects:', error);
                showMessage('Error loading subjects: ' + error.message, 'error');
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (table) table.style.display = 'table'; // Show table even on error
            }
        }

        // Delete subject
        async function deleteSubject(subjectCode) {
            // Check if user has editing permissions
            if (!userCanEdit) {
                showMessage('‚ùå You do not have permission to delete subjects. Contact administrator for editing access.', 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete this subject?')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('subject_selection')
                    .delete()
                    .eq('subject_code', subjectCode);

                if (error) throw error;

                showMessage('Subject deleted successfully!', 'success');
                loadExistingSubjects();
            } catch (error) {
                console.error('Error deleting subject:', error);
                showMessage('Error deleting subject: ' + error.message, 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // Auto hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            }
        }
    </script>
</body>
</html>