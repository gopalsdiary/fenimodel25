 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Entry System - Result Processing</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>:root{--bg:#f6f8fa;--card:#fff;--border:#d0d7de;--accent:#0366d6;--accent-hover:#024c9e;--danger:#d73a49;--success:#1a7f37;--warning:#ff8a00;--radius:6px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}*{margin:0;padding:0;box-sizing:border-box}body{margin:0;background:var(--bg);color:#24292f}.header{background:linear-gradient(135deg,var(--accent) 0%,var(--accent-hover) 100%);color:#fff;padding:1rem 2rem;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center}.header h1{font-size:1.8rem;font-weight:600}.user-info{display:flex;align-items:center;gap:12px;font-size:14px}.container{width:100%;margin:0;padding:18px 12px 28px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 2px 4px rgba(0,0,0,.04)}.toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:14px}.btn{cursor:pointer;font-size:12px;line-height:1.2;padding:6px 10px;border-radius:4px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:500;display:inline-flex;align-items:center;gap:6px}.btn:hover{background:var(--accent-hover);opacity:.9;transform:translateY(-1px)}.btn-info{background:#3b82f6;border-color:#3b82f6;color:#fff}.btn-info:hover{background:#2563eb}.btn-success{background:var(--success);border-color:var(--success);color:#fff}.btn-success:hover{background:#0f5132}.btn-outline{background:#fff;color:var(--accent)}.btn-outline:hover{background:#e7f3ff}.btn-orange{background:var(--warning);border-color:var(--warning);color:#fff}.btn-orange:hover{background:#e07000}.form-group{display:flex;flex-direction:column;min-width:150px}.form-group label{font-weight:700;margin-bottom:5px;color:#495057}.form-group input{padding:10px;border:2px solid var(--border);border-radius:8px;font-size:14px;transition:all .3s}.form-group input:focus{border-color:var(--accent);outline:0;box-shadow:0 0 0 3px rgba(3,102,214,.1)}.status{font-size:13px;min-height:18px;padding:4px 8px;border-radius:4px;font-weight:500}.status.loading{background:#fef3c7;color:#92400e}.status.success{color:var(--success)}.status.error{color:var(--danger)}.table-container{background:#fff;border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,.1);overflow-x:auto;overflow-y:auto;max-height:70vh;border:1px solid var(--border);margin-top:16px}.table-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:#f8fafc}.table-header h2{font-size:1.3rem;font-weight:600;color:#24292f}.table-wrap{overflow-x:auto;background:#fff;border:1px solid var(--border);border-radius:0 0 var(--radius) var(--radius)}table{width:100%;border-collapse:collapse;font-size:13.5px;margin:0;background:#fff;table-layout:fixed;min-width:800px;word-wrap:break-word}thead{background:#fafbfc;position:sticky;top:0;z-index:5}th,td{border:1px solid var(--border);padding:6px 8px;text-align:left;vertical-align:middle}th{font-weight:600;font-size:12.5px;letter-spacing:.5px;background:#f0f3f6;text-align:center;writing-mode:vertical-rl;text-orientation:mixed;vertical-align:bottom;height:120px;min-width:50px;padding:8px 4px;border-bottom:2px solid var(--border)}tbody tr:nth-child(even){background:#fcfcfd}tbody tr:hover{background:#fffbe6}th:nth-child(1),th:nth-child(2),th:nth-child(3),th:nth-child(4),th:nth-child(5),th:nth-child(6){writing-mode:horizontal-tb;text-orientation:initial;height:auto;padding:4px 6px;white-space:normal;word-wrap:break-word;line-height:1.1;vertical-align:middle;text-align:center}th:nth-child(n+6){writing-mode:vertical-rl;text-orientation:mixed;vertical-align:bottom;height:120px;min-width:50px;padding:8px 4px;white-space:nowrap;word-wrap:normal;line-height:1.2;text-align:center}td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}td:nth-child(4){white-space:normal;word-wrap:break-word;word-break:break-word;line-height:1.2;max-width:120px}.mark-input{width:60px;padding:4px 6px;border:1px solid var(--border);border-radius:4px;text-align:center;font-size:12px;background:#fff}.mark-input:focus{outline:0;border-color:var(--accent);box-shadow:0 0 0 2px rgba(3,102,214,.1)}.mark-input{background-color:#fff;border-color:#ced4da;color:#495057}.readonly-input{background-color:#f8f9fa;border-color:#dee2e6;color:#6c757d;cursor:not-allowed}.mark-cell{text-align:center;padding:2px 1px;font-size:10px;min-width:30px;max-width:40px;width:35px;background:#fff;border:1px solid #dee2e6}.subject-header{padding:2px 1px!important;font-size:8px!important;text-align:center;word-break:break-word;line-height:1.1;writing-mode:horizontal-tb;text-orientation:initial;white-space:normal;overflow-wrap:break-word;hyphens:auto;height:auto;min-height:40px}table th,table td{padding:2px 3px;font-size:10px;border:1px solid #dee2e6;text-align:center;vertical-align:middle}table th{white-space:normal;word-wrap:break-word;hyphens:auto;overflow-wrap:break-word}table td{overflow:hidden;text-overflow:ellipsis}.main-header{white-space:normal!important;word-wrap:break-word!important;overflow-wrap:break-word!important;hyphens:auto!important;line-height:1.1!important;height:auto!important;min-height:30px}table th,table td{display:table-cell!important;visibility:visible!important;min-width:40px}.mark-cell,.total-cell,.gpa-cell{min-width:30px;max-width:45px;width:auto}.action-cell{min-width:60px}.action-btn{font-size:9px;padding:2px 4px}.mark-cell{text-align:center;padding:8px 4px;font-size:14px;min-width:45px;max-width:60px}th:has-text("_CQ"),th:has-text("_MCQ"),th:has-text("_Practical"),th:has-text("_Total"),th:has-text("_GPA"){width:60px;min-width:45px;max-width:70px}.total-cell{font-weight:600;background:#f0f9ff;text-align:center;padding:2px 1px;font-size:10px;min-width:30px;max-width:45px}.gpa-cell{font-weight:600;color:var(--accent);text-align:center;padding:2px 1px;font-size:10px;min-width:30px;max-width:45px;width:35px}.loading{text-align:center;padding:40px;color:#6a737d;display:none}.loading.show{display:block}.hidden{display:none}.ml-auto{margin-left:auto}.action-cell{text-align:center;min-width:120px}.action-btn{font-size:10px;padding:4px 8px}.no-data{text-align:center;padding:20px}.error{background:#fef2f2;color:var(--danger);padding:16px;border-radius:8px;margin:16px 0;border-left:4px solid var(--danger)}.success{background:#f0fdf4;color:var(--success);padding:16px;border-radius:8px;margin:16px 0;border-left:4px solid var(--success)}input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield;appearance:textfield}

/* Checkbox styling */
input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
    cursor: pointer;
}

.toggle-label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 600;
    color: #495057;
    cursor: pointer;
    user-select: none;
}

.toggle-container {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-left: 20px;
    padding: 5px 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

/* Full-width layout overrides */
.container{padding:0 0 28px;border-left:0;border-right:0}
.table-container{border-radius:0;border-left:0;border-right:0;width:100%}
.table-wrap{border-left:0;border-right:0}
table{width:100%}

/* Helpers to toggle columns (classes used by JS) */
/* No visual styles needed; classes mark columns for toggling */

@media(max-width:768px){.container{margin:8px;padding:12px;border-radius:6px}.header h1{font-size:18px}.toolbar{flex-direction:column;align-items:stretch}.btn{min-width:auto!important;width:100%;padding:10px 8px;font-size:14px}table{font-size:12px;white-space:nowrap;display:block;overflow-x:auto;border:1px solid #ddd}table thead,table tbody{display:table;width:100%;table-layout:fixed}th,td{padding:4px;min-width:45px;word-break:keep-all;overflow:hidden;text-overflow:ellipsis}th{height:80px;font-size:10px;min-width:35px;padding:4px 2px}th:nth-child(1),th:nth-child(2),th:nth-child(3),th:nth-child(4),th:nth-child(5){writing-mode:horizontal-tb;text-orientation:initial;height:auto;white-space:normal!important;word-wrap:break-word;line-height:1.2;vertical-align:top;min-width:50px;padding:4px}th:nth-child(n+6){writing-mode:vertical-rl;text-orientation:mixed;white-space:nowrap!important;word-wrap:normal;text-align:center}td:nth-child(4){white-space:normal!important;word-wrap:break-word;word-break:break-word;line-height:1.1;padding:2px}.mark-input{width:50px!important;padding:2px!important;font-size:12px}.table-header h2{font-size:18px}}@media(max-width:480px){.container{margin:4px;padding:8px}table{font-size:11px}th,td{padding:2px;min-width:45px}.mark-input{width:40px!important;padding:1px!important;font-size:11px}}</style>
</head>
<body>
    <header class="header">
        <h1>Grade Entry System - Pre Test 2025</h1>
        <div class="user-info">
            <span>ðŸ‘¤</span>
            <span id="userInfo">System User</span>
        </div>
    </header>

    <div class="container">
        <div class="toolbar">
            <button class="btn" onclick="loadAllStudents()">
                ðŸ“Š Refresh All Data
            </button>
            <button class="btn btn-info" onclick="calculateAllTotals()">
                âž• Calculate Total & Average
            </button>
            <button class="btn btn-success" onclick="calculateAllGPA()">
                ðŸ”„ Calculate All GPA
            </button>
            <button class="btn btn-outline" onclick="updateAllResults()" id="updateDbBtn">
                ðŸ’¾ Update Calculated Fields
            </button>
            
            <div class="toggle-container">
                <label class="toggle-label">
                    <input type="checkbox" id="showTotal" checked onchange="toggleColumns()">
                    âœ“ Total
                </label>
                <label class="toggle-label">
                    <input type="checkbox" id="showGPA" checked onchange="toggleColumns()">
                    âœ“ GPA
                </label>
            </div>
            
            <!-- search input removed as per request -->
            <div class="ml-auto">
                <span id="status" class="status"></span>
            </div>
        </div>

        <div id="loadingMessage" class="loading">
            <div>ðŸ“š Loading student data...</div>
        </div>

        <div id="messageContainer"></div>

        <div class="table-container hidden" id="tableContainer">
            <div class="table-header">
                <h2>Grade Entry & Result Processing</h2>
                <div>
                    <span id="studentCount">0 students</span>
                </div>
            </div>
            <div class="table-wrap">
                <table id="gradesTable">
                    <thead id="gradesTableHead">
                        <!-- Dynamic header will be inserted here -->
                    </thead>
                    <tbody id="gradesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        let studentsData = [];
        let allStudentsData = [];
        let subjectsData = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadSubjects();
            loadAllStudents();
        });

        // Load all students from database
        async function loadAllStudents() {
            document.getElementById('loadingMessage').classList.add('show');
            document.getElementById('tableContainer').classList.add('hidden');
            showStatus('Loading all students...', 'loading');

            try {
                // Load students data from exam_ann25
                const { data: students, error: studentsError } = await supabaseClient
                    .from('exam_ann25')
                    .select('*')
                    .order('class_2025', { ascending: true })
                    .order('section_2025', { ascending: true });

                if (studentsError) throw studentsError;

                // Load student database information separately
                const { data: studentDB, error: studentDBError } = await supabaseClient
                    .from('student_database')
                    .select('*');

                if (studentDBError) throw studentDBError;

                // Create a map for quick lookup of student database info
                const studentDBMap = {};
                if (studentDB) {
                    studentDB.forEach(student => {
                        studentDBMap[student.iid] = student;
                    });
                }

                // Merge the data
                const mergedStudents = (students || []).map(student => {
                    const studentInfo = studentDBMap[student.iid] || {};
                    return {
                        ...student,
                        student_database: studentInfo
                    };
                }).filter(student => student.student_database && Object.keys(student.student_database).length > 1); // Only include students with valid database info

                // Sort students by class, section, then roll number
                const sortedStudents = mergedStudents.sort((a, b) => {
                    // First sort by class
                    if (a.class_2025 !== b.class_2025) {
                        return (a.class_2025 || '').localeCompare(b.class_2025 || '');
                    }
                    // Then by section
                    if (a.section_2025 !== b.section_2025) {
                        return (a.section_2025 || '').localeCompare(b.section_2025 || '');
                    }
                    // Finally by roll number - try different possible column names
                    const rollA = parseInt(a.student_database?.roll_2025 || a.student_database?.roll || a.student_database?.roll_no) || 0;
                    const rollB = parseInt(b.student_database?.roll_2025 || b.student_database?.roll || b.student_database?.roll_no) || 0;
                    return rollA - rollB;
                });

                studentsData = sortedStudents;
                allStudentsData = [...studentsData]; // Keep original data for filtering
                generateTable();
                
                generateTable();
                document.getElementById('studentCount').textContent = `${studentsData.length} students`;
                showStatus(`Loaded ${studentsData.length} students from Pre Test 2025`, 'success');
                
            } catch (error) {
                showMessage('Failed to load student data: ' + error.message, 'error');
            } finally {
                document.getElementById('loadingMessage').classList.remove('show');
            }
        }

        // Search functionality removed as requested

        // Load subjects data
        async function loadSubjects() {
            try {
                const { data, error } = await supabaseClient
                    .from('subject_class_9_10')
                    .select('*');

                if (error) throw error;
                subjectsData = data;
                console.log('Subject data loaded:', subjectsData);
            } catch (error) {
                showMessage('Failed to load subject data: ' + error.message, 'error');
            }
        }



        // Generate dynamic table header
        function generateTableHeader() {
            // Get all subject columns from the first student
            if (!studentsData || studentsData.length === 0) {
                return '<tr><th colspan="20">No data available</th></tr>';
            }

            const sampleStudent = studentsData[0];
            const subjectColumns = [];
            
            // Extract subject names and their column types
            for (const key in sampleStudent) {
                if (key.startsWith('*') && (key.includes('_CQ') || key.includes('_MCQ') || key.includes('_Practical') || key.includes('_Total') || key.includes('_GPA'))) {
                    subjectColumns.push(key);
                }
            }

            // Group columns by subject
            const subjects = {};
            subjectColumns.forEach(col => {
                const parts = col.split('_');
                const subjectName = parts[0]; // Subject name with *
                const type = parts[parts.length - 1]; // CQ, MCQ, Practical, Total, GPA
                
                if (!subjects[subjectName]) {
                    subjects[subjectName] = {};
                }
                subjects[subjectName][type] = col;
            });

            let headerHTML = `
                <tr>
                    <th class="main-header" style="width: 40px; min-width: 40px;">iid</th>
                    <th class="main-header" style="width: 35px; min-width: 35px;">class</th>
                    <th class="main-header" style="width: 45px; min-width: 45px;">section</th>
                    <th class="main-header" style="width: 40px; min-width: 40px;">roll</th>
                    <th class="main-header" style="width: 70px; min-width: 70px;">optional</th>
                    <th class="main-header" style="width: 60px; min-width: 60px;">Action</th>
                    <th class="main-header col-total" style="width: 50px;">total</th>
                    <th class="main-header col-total" style="width: 50px;">avg</th>
                    <th class="main-header" style="width: 45px;">absent</th>
                    <th class="main-header" style="width: 50px;">remark</th>
                    <th class="main-header col-gpa" style="width: 45px;">gpa</th>`;

            // Add subject columns dynamically
            Object.keys(subjects).forEach(subjectName => {
                const subject = subjects[subjectName];
                ['CQ', 'MCQ', 'Practical', 'Total'].forEach(type => {
                    if (subject[type]) {
                        const cls = type === 'Total' ? 'col-total' : '';
                        headerHTML += `<th class="${cls}">${subject[type]}</th>`;
                    }
                });
                if (subject['GPA']) {
                    headerHTML += `<th class="col-gpa">${subject['GPA']}</th>`;
                }
            });
            
            headerHTML += `
                </tr>`;
            
            return headerHTML;
        }

        // Render students table
        function renderStudentsTable() {
            if (!studentsData || studentsData.length === 0) {
                document.getElementById('gradesTableBody').innerHTML = '<tr><td colspan="20" class="no-data">No students found</td></tr>';
                return;
            }

            // Get all subject columns from the first student
            const sampleStudent = studentsData[0];
            const subjectColumns = [];
            
            // Extract subject names and their column types
            for (const key in sampleStudent) {
                if (key.startsWith('*') && (key.includes('_CQ') || key.includes('_MCQ') || key.includes('_Practical') || key.includes('_Total') || key.includes('_GPA'))) {
                    subjectColumns.push(key);
                }
            }

            // Group columns by subject
            const subjects = {};
            subjectColumns.forEach(col => {
                const parts = col.split('_');
                const subjectName = parts[0]; // Subject name with *
                const type = parts[parts.length - 1]; // CQ, MCQ, Practical, Total, GPA
                
                if (!subjects[subjectName]) {
                    subjects[subjectName] = {};
                }
                subjects[subjectName][type] = col;
            });

            const tbody = document.getElementById('gradesTableBody');
            tbody.innerHTML = '';

            studentsData.forEach((student, index) => {
                // Get student info with fallback column names
                const studentInfo = student.student_database || {};
                const name = studentInfo.name_2025 || studentInfo.name || studentInfo.name_en || '';
                const roll = studentInfo.roll_2025 || studentInfo.roll || studentInfo.roll_no || '';
                const optional = studentInfo.optional_subject || studentInfo.optional || '';
                
                let row = `
                    <tr>
                        <td style="width: 40px; cursor: pointer; color: #0366d6; text-decoration: underline;" onclick="viewDetailedResult(${index})" title="Click to view detailed result">${student.iid || ''}</td>
                        <td style="width: 35px;">${student.class_2025 || ''}</td>
                        <td style="width: 45px;">${student.section_2025 || ''}</td>
                        <td style="width: 40px;">${roll}</td>
                        <td style="width: 70px;">${optional || 'N/A'}</td>
                        <td class="action-cell" style="width: 60px;">
                            <button class="btn btn-outline action-btn" id="editBtn_${index}" onclick="updateStudentResult(${index})">
                                ðŸ“Š
                            </button>
                        </td>
                        <td class="total-cell col-total" id="totalMark_${index}">${student.total_mark || 0}</td>
                        <td class="total-cell col-total" id="averageMark_${index}">${student.average_mark || 0}</td>
                        <td id="countAbsent_${index}">${student.count_absent || 0}</td>
                        <td id="remark_${index}">${student.remark || ''}</td>
                        <td class="gpa-cell col-gpa" id="gpaFinal_${index}">${student.gpa_final || ''}</td>`;

                // Subject marks and GPA
                Object.keys(subjects).forEach(subjectName => {
                    const subject = subjects[subjectName];
                    ['CQ', 'MCQ', 'Practical', 'Total'].forEach(type => {
                        if (subject[type]) {
                            const value = student[subject[type]] || '';
                            if (type === 'Total') {
                                row += `<td class="total-cell col-total" id="total_${index}_${subjectName}">${value || ''}</td>`;
                            } else {
                                // Plain text for CQ, MCQ, Practical - no input boxes
                                row += `<td class="mark-cell">${value || ''}</td>`;
                            }
                        }
                    });
                    if (subject['GPA']) {
                        const gpa = student[subject['GPA']] || '';
                        const gpaClass = getGPAClass(gpa);
                        row += `<td id="gpa_${index}_${subjectName}" class="gpa-cell col-gpa ${gpaClass}">${gpa}</td>`;
                    }
                });

                row += '</tr>';
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Generate dynamic table
        function generateTable() {
            // Update table header dynamically
            const tableHead = document.querySelector('#gradesTableHead');
            tableHead.innerHTML = generateTableHeader();
            
            // Render table body
            renderStudentsTable();
            
            // Show table container
            document.getElementById('tableContainer').classList.remove('hidden');
            
            // Apply column visibility toggles
            setTimeout(() => {
                toggleColumns();
            }, 100);
        }

        // Update individual mark
        function updateMark(studentIndex, columnName, value) {
            if (studentsData[studentIndex]) {
                studentsData[studentIndex][columnName] = value ? parseFloat(value) : null;
                calculateSubjectTotal(studentIndex, columnName);
            }
        }

        // Calculate subject total and GPA
        function calculateSubjectTotal(studentIndex, changedColumn) {
            const student = studentsData[studentIndex];
            
            // Find subject name from changed column
            const subjectName = changedColumn.split('_')[0]; // Get subject name with *
            const subjectNameClean = subjectName.substring(1); // Remove the * prefix
            
            // Get subject configuration
            const subjectConfig = subjectsData.find(s => s.subject_name === subjectNameClean);
            if (!subjectConfig) return;

            // Check if this is Bangla or English with 1st/2nd papers
            const isBangla1st = subjectNameClean.includes('à¦¬à¦¾à¦‚à¦²à¦¾ à§§à¦® à¦ªà¦¤à§à¦°') || subjectNameClean.includes('Bangla 1st');
            const isBangla2nd = subjectNameClean.includes('à¦¬à¦¾à¦‚à¦²à¦¾ à§¨à¦¯à¦¼ à¦ªà¦¤à§à¦°') || subjectNameClean.includes('Bangla 2nd');
            const isEnglish1st = subjectNameClean.includes('English 1st') || subjectNameClean.includes('à¦‡à¦‚à¦°à§‡à¦œà¦¿ à§§à¦® à¦ªà¦¤à§à¦°');
            const isEnglish2nd = subjectNameClean.includes('English 2nd') || subjectNameClean.includes('à¦‡à¦‚à¦°à§‡à¦œà¦¿ à§¨à¦¯à¦¼ à¦ªà¦¤à§à¦°');

            // Handle Bangla combined calculation
            if (isBangla1st || isBangla2nd) {
                calculateCombinedSubjectGPA(studentIndex, 'Bangla', ['*à¦¬à¦¾à¦‚à¦²à¦¾ à§§à¦® à¦ªà¦¤à§à¦°', '*à¦¬à¦¾à¦‚à¦²à¦¾ à§¨à¦¯à¦¼ à¦ªà¦¤à§à¦°']);
                return;
            }

            // Handle English combined calculation
            if (isEnglish1st || isEnglish2nd) {
                calculateCombinedSubjectGPA(studentIndex, 'English', ['*English 1st', '*English 2nd']);
                return;
            }

            // Normal subject calculation for all other subjects
            let total = 0;
            let hasAllMarks = true;

            // Calculate total from available components
            const cqCol = `${subjectName}_CQ`;
            const mcqCol = `${subjectName}_MCQ`;
            const practicalCol = `${subjectName}_Practical`;
            const totalCol = `${subjectName}_Total`;
            const gpaCol = `${subjectName}_GPA`;

            if (student.hasOwnProperty(cqCol) && student[cqCol] !== null) {
                total += parseFloat(student[cqCol]) || 0;
            } else if (student.hasOwnProperty(cqCol)) {
                hasAllMarks = false;
            }

            if (student.hasOwnProperty(mcqCol) && student[mcqCol] !== null) {
                total += parseFloat(student[mcqCol]) || 0;
            } else if (student.hasOwnProperty(mcqCol)) {
                hasAllMarks = false;
            }

            if (student.hasOwnProperty(practicalCol) && student[practicalCol] !== null) {
                total += parseFloat(student[practicalCol]) || 0;
            } else if (student.hasOwnProperty(practicalCol)) {
                hasAllMarks = false;
            }

            // Update total if all marks are provided
            if (hasAllMarks) {
                student[totalCol] = total;
                const totalElement = document.getElementById(`total_${studentIndex}_${subjectName}`);
                if (totalElement) totalElement.textContent = total;

                // Calculate GPA
                const gpa = calculateGPA(total, subjectConfig);
                student[gpaCol] = gpa;
                const gpaElement = document.getElementById(`gpa_${studentIndex}_${subjectName}`);
                if (gpaElement) {
                    gpaElement.textContent = gpa;
                    gpaElement.className = 'gpa-cell ' + getGPAClass(gpa);
                }
            } else {
                // Clear total and GPA if not all marks are provided
                student[totalCol] = null;
                student[gpaCol] = '';
                const totalElement = document.getElementById(`total_${studentIndex}_${subjectName}`);
                if (totalElement) totalElement.textContent = '';
                const gpaElement = document.getElementById(`gpa_${studentIndex}_${subjectName}`);
                if (gpaElement) {
                    gpaElement.textContent = '';
                    gpaElement.className = 'gpa-cell';
                }
            }

            // Recalculate overall results
            calculateOverallResults(studentIndex);
        }

        // Calculate combined GPA for Bangla and English (1st + 2nd papers)
        function calculateCombinedSubjectGPA(studentIndex, subjectType, subjectNames) {
            const student = studentsData[studentIndex];
            const [firstPaper, secondPaper] = subjectNames;

            let total1st = 0, total2nd = 0;
            let hasMarks1st = false, hasMarks2nd = false;

            // Calculate totals for both papers
            for (const paperName of [firstPaper, secondPaper]) {
                const cqCol = `${paperName}_CQ`;
                const mcqCol = `${paperName}_MCQ`;
                const practicalCol = `${paperName}_Practical`;
                const totalCol = `${paperName}_Total`;
                
                let paperTotal = 0;
                let hasPaperMarks = true;

                if (student.hasOwnProperty(cqCol) && student[cqCol] !== null) {
                    paperTotal += parseFloat(student[cqCol]) || 0;
                } else if (student.hasOwnProperty(cqCol)) {
                    hasPaperMarks = false;
                }

                if (student.hasOwnProperty(mcqCol) && student[mcqCol] !== null) {
                    paperTotal += parseFloat(student[mcqCol]) || 0;
                } else if (student.hasOwnProperty(mcqCol)) {
                    hasPaperMarks = false;
                }

                if (student.hasOwnProperty(practicalCol) && student[practicalCol] !== null) {
                    paperTotal += parseFloat(student[practicalCol]) || 0;
                } else if (student.hasOwnProperty(practicalCol)) {
                    hasPaperMarks = false;
                }

                // Update paper total
                if (hasPaperMarks) {
                    student[totalCol] = paperTotal;
                    const totalElement = document.getElementById(`total_${studentIndex}_${paperName}`);
                    if (totalElement) totalElement.textContent = paperTotal;

                    if (paperName === firstPaper) {
                        total1st = paperTotal;
                        hasMarks1st = true;
                    } else {
                        total2nd = paperTotal;
                        hasMarks2nd = true;
                    }
                } else {
                    student[totalCol] = null;
                    const totalElement = document.getElementById(`total_${studentIndex}_${paperName}`);
                    if (totalElement) totalElement.textContent = '';
                }
            }

            // Calculate combined GPA if both papers have marks
            if (hasMarks1st && hasMarks2nd) {
                const combinedAverage = (total1st + total2nd) / 2;
                
                // Find subject config for GPA calculation (use first paper config)
                const subjectConfig = subjectsData.find(s => 
                    s.subject_name.includes(subjectType === 'Bangla' ? 'à¦¬à¦¾à¦‚à¦²à¦¾' : 'English')
                );

                if (subjectConfig) {
                    const combinedGPA = calculateGPA(combinedAverage, subjectConfig);
                    
                    // Set 1st paper GPA to combined result
                    const gpa1stCol = `${firstPaper}_GPA`;
                    student[gpa1stCol] = combinedGPA;
                    const gpa1stElement = document.getElementById(`gpa_${studentIndex}_${firstPaper}`);
                    if (gpa1stElement) {
                        gpa1stElement.textContent = combinedGPA;
                        gpa1stElement.className = 'gpa-cell ' + getGPAClass(combinedGPA);
                    }

                    // Set 2nd paper GPA to 0
                    const gpa2ndCol = `${secondPaper}_GPA`;
                    student[gpa2ndCol] = '0';
                    const gpa2ndElement = document.getElementById(`gpa_${studentIndex}_${secondPaper}`);
                    if (gpa2ndElement) {
                        gpa2ndElement.textContent = '0';
                        gpa2ndElement.className = 'gpa-cell';
                    }
                }
            } else {
                // Clear GPAs if marks are incomplete
                for (const paperName of [firstPaper, secondPaper]) {
                    const gpaCol = `${paperName}_GPA`;
                    student[gpaCol] = '';
                    const gpaElement = document.getElementById(`gpa_${studentIndex}_${paperName}`);
                    if (gpaElement) {
                        gpaElement.textContent = '';
                        gpaElement.className = 'gpa-cell';
                    }
                }
            }

            // Recalculate overall results
            calculateOverallResults(studentIndex);
        }

        // Update mark in student data
        function updateMark(studentIndex, columnName, value) {
            if (studentsData[studentIndex]) {
                studentsData[studentIndex][columnName] = value === '' ? null : parseFloat(value);
            }
        }

        // Calculate GPA based on marks and subject configuration
        function calculateGPA(totalMarks, subjectConfig) {
            if (!subjectConfig || totalMarks === null || totalMarks === undefined) return '';

            // Use subject_class_9_10 table structure
            const passMarkTotal = (subjectConfig.passmark_cq || 0) + 
                                (subjectConfig.passmark_mcq || 0) + 
                                (subjectConfig.passmark_practical || 0);

            // Use passmark_total if available, otherwise use calculated total
            const totalPassMark = subjectConfig.passmark_total || passMarkTotal;

            if (totalMarks < totalPassMark) return 'F';

            // Calculate total possible marks from subject_class_9_10
            const fullMarks = (subjectConfig.total_cq || 0) + 
                             (subjectConfig.total_mcq || 0) + 
                             (subjectConfig.total_practical || 0);

            if (fullMarks === 0) return '';

            // Calculate percentage
            const percentage = (totalMarks / fullMarks) * 100;
            
            if (percentage >= 80) return '5';      // A+ = 5
            if (percentage >= 70) return '4';      // A = 4
            if (percentage >= 60) return '3.5';    // A- = 3.5
            if (percentage >= 50) return '3';      // B = 3
            if (percentage >= 40) return '2';      // C = 2
            if (percentage >= 33) return '1';      // D = 1
            return 'F';                             // F = F
        }

        // Calculate overall results for a student
        function calculateOverallResults(studentIndex) {
            const student = studentsData[studentIndex];
            let totalMark = 0;
            let subjectCount = 0;
            let failedSubjects = 0;
            let gpaSum = 0;
            let gpaCount = 0;

            // Count subjects and calculate totals
            for (const key in student) {
                if (key.startsWith('*') && key.endsWith('_Total') && student[key] !== null) {
                    totalMark += parseFloat(student[key]) || 0;
                    subjectCount++;
                }
                if (key.startsWith('*') && key.endsWith('_GPA') && student[key]) {
                    const gpa = student[key];
                    if (gpa === 'F') {
                        failedSubjects++;
                    } else if (gpa !== '') {
                        // Convert letter grade to point for average calculation
                        const point = getGPAPoint(gpa);
                        if (point > 0) {
                            // Skip optional subject if GPA > 2.0 and it's failed
                            const subjectName = key.replace('_GPA', '').substring(1);
                            const isOptional = student.student_database?.optional_subject === subjectName;
                            
                            if (!isOptional || point <= 2.0) {
                                gpaSum += point;
                                gpaCount++;
                            }
                        }
                    }
                }
            }

            // Update calculated fields
            student.total_mark = totalMark;
            student.average_mark = subjectCount > 0 ? (totalMark / subjectCount).toFixed(2) : 0;
            student.count_absent = Math.max(0, 9 - subjectCount);
            student.remark = failedSubjects > 0 ? `Fail : ${failedSubjects} subject${failedSubjects > 1 ? 's' : ''}` : 'Pass';
            // If there is any fail OR any absence, do not calculate final GPA
            if ((failedSubjects + (student.count_absent || 0)) > 0) {
                student.gpa_final = '';
            } else {
                student.gpa_final = gpaCount > 0 ? (gpaSum / gpaCount).toFixed(2) : '';
            }

            // Update UI
            document.getElementById(`totalMark_${studentIndex}`).textContent = student.total_mark;
            document.getElementById(`averageMark_${studentIndex}`).textContent = student.average_mark;
            document.getElementById(`countAbsent_${studentIndex}`).textContent = student.count_absent;
            document.getElementById(`remark_${studentIndex}`).textContent = student.remark;
            const gpaFinalElement = document.getElementById(`gpaFinal_${studentIndex}`);
            gpaFinalElement.textContent = student.gpa_final;
            const gpaClassFinal = student.gpa_final === '' ? '' : getGPAClass(student.gpa_final);
            gpaFinalElement.className = 'gpa-cell col-gpa ' + gpaClassFinal;
        }

        // Get GPA point value
        function getGPAPoint(grade) {
            // Handle both numeric and letter grades
            if (grade === 'F') return 0.0;
            const numericGrade = parseFloat(grade);
            if (!isNaN(numericGrade)) return numericGrade;
            
            // Fallback for letter grades
            const gradePoints = {
                'A+': 5.0,
                'A': 4.0,
                'A-': 3.5,
                'B': 3.0,
                'C': 2.0,
                'D': 1.0,
                'F': 0.0
            };
            return gradePoints[grade] || 0;
        }

        // Get CSS class for GPA display
        function getGPAClass(gpa) {
            if (gpa === 'F') return 'gpa-F';
            
            const numGPA = parseFloat(gpa);
            if (isNaN(numGPA)) {
                // Handle letter grades as fallback
                if (typeof gpa === 'string') {
                    return `gpa-${gpa.replace('+', '-plus').replace('-', '-minus')}`;
                }
                return '';
            }
            
            if (numGPA >= 5.0) return 'gpa-A-plus';
            if (numGPA >= 4.0) return 'gpa-A';
            if (numGPA >= 3.5) return 'gpa-A-minus';
            if (numGPA >= 3.0) return 'gpa-B';
            if (numGPA >= 2.0) return 'gpa-C';
            if (numGPA >= 1.0) return 'gpa-D';
            return 'gpa-F';
        }

        // Calculate total marks for all students
        function calculateAllTotals() {
            if (studentsData.length === 0) {
                showStatus('No data to calculate', 'error');
                return;
            }

            showStatus('Calculating total and average marks...', 'loading');

            for (let i = 0; i < studentsData.length; i++) {
                calculateStudentTotal(i);
            }

            // Re-render the table to show updated totals
            renderStudentsTable();
            showStatus('Total marks and average marks calculated successfully!', 'success');
        }

        // Calculate total marks for a single student
        function calculateStudentTotal(studentIndex) {
            const student = studentsData[studentIndex];
            let totalMarks = 0;
            let subjectCount = 0;
            let hasAnyMarks = false;

            // Sum all subject total marks
            for (const key in student) {
                if (key.startsWith('*') && key.endsWith('_Total')) {
                    const value = parseFloat(student[key]);
                    if (!isNaN(value)) {
                        totalMarks += value;
                        subjectCount++;
                        hasAnyMarks = true;
                    }
                }
            }

            // Update total_mark and average_mark in student data
            student.total_mark = hasAnyMarks ? totalMarks : null;
            student.average_mark = (hasAnyMarks && subjectCount > 0) ? (totalMarks / subjectCount).toFixed(2) : null;
        }

        // Calculate all GPA for all students
        function calculateAllGPA() {
            if (studentsData.length === 0) {
                showStatus('No data to calculate', 'error');
                return;
            }

            showStatus('Updating calculations...', 'loading');

            studentsData.forEach((student, index) => {
                // Recalculate all subjects for this student
                for (const key in student) {
                    if (key.startsWith('*') && (key.includes('_CQ') || key.includes('_MCQ') || key.includes('_Practical'))) {
                        calculateSubjectTotal(index, key);
                    }
                }
            });
            
            showStatus('Calculations updated successfully!', 'success');
        }

        // Update individual student result (only calculated fields)
        async function updateStudentResult(studentIndex) {
            const student = studentsData[studentIndex];
            
            try {
                // Prepare update data - only calculated fields
                const updateData = {
                    iid: student.iid,
                    total_mark: student.total_mark,
                    average_mark: student.average_mark,
                    count_absent: student.count_absent,
                    remark: student.remark,
                    gpa_final: student.gpa_final
                };

                // Add dynamic Subject GPA fields
                for (const key in student) {
                    if (key.startsWith('*') && key.endsWith('_GPA')) {
                        updateData[key] = student[key];
                    }
                }

                const { error } = await supabaseClient
                    .from('exam_ann25')
                    .update(updateData)
                    .eq('iid', student.iid);

                if (error) throw error;
                
                const roll = student.student_database?.roll_2025 || student.student_database?.roll || student.student_database?.roll_no || 'Unknown';
                showMessage(`Student Roll ${roll} calculated fields updated successfully`, 'success');
            } catch (error) {
                showMessage('Failed to update: ' + error.message, 'error');
            }
        }

        // Update all results
        async function updateAllResults() {
            if (!studentsData || studentsData.length === 0) {
                showStatus('No data to update', 'error');
                return;
            }

            const confirmUpdate = confirm('Are you sure you want to update calculated fields (total_mark, average_mark, count_absent, remark, gpa_final, and Subject GPAs)?');
            if (!confirmUpdate) return;

            showStatus('Updating database...', 'loading');
            
            try {
                // Prepare update data - only calculated fields
                const updates = studentsData.map(student => {
                    const updateData = {
                        iid: student.iid,
                        total_mark: student.total_mark,
                        average_mark: student.average_mark,
                        count_absent: student.count_absent,
                        remark: student.remark,
                        gpa_final: student.gpa_final
                    };
                    
                    // Add dynamic Subject GPA fields
                    for (const key in student) {
                        if (key.startsWith('*') && key.endsWith('_GPA')) {
                            updateData[key] = student[key];
                        }
                    }
                    
                    return updateData;
                });

                console.log('Updating database with:', updates.length, 'records');

                // Update the database in batches
                for (const updateData of updates) {
                    const { error } = await supabaseClient
                        .from('exam_ann25')
                        .update(updateData)
                        .eq('iid', updateData.iid);

                    if (error) throw error;
                }

                // Change button to orange after successful update
                const updateBtn = document.getElementById('updateDbBtn');
                updateBtn.className = 'btn btn-orange';
                updateBtn.innerHTML = 'âœ… Calculated Fields Updated';

                showStatus('Database updated successfully!', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    updateBtn.className = 'btn btn-outline';
                    updateBtn.innerHTML = 'ðŸ’¾ Update Calculated Fields';
                }, 3000);

            } catch (error) {
                console.error('Error updating database:', error);
                showStatus('Failed to update database: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(messageDiv);

            // Also show in status
            showStatus(message, type);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 5000);
        }

        // View detailed result for a student
        function viewDetailedResult(studentIndex) {
            if (!studentsData || !studentsData[studentIndex]) {
                showMessage('Student data not found', 'error');
                return;
            }

            const student = studentsData[studentIndex];
            const studentIID = student.iid;

            if (!studentIID) {
                showMessage('Student IID not found', 'error');
                return;
            }

            // Store student information in sessionStorage for detailsresult.html
            const studentInfo = {
                iid: studentIID,
                IID: studentIID, // Also store as uppercase for compatibility
                isAdminAccess: true, // Flag to bypass access control in detailsresult.html
                ...student.student_database, // Include all student database info
                ...student // Include all result data
            };

            try {
                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
                
                // Open detailsresult.html with the student IID as URL parameter
                const baseURL = window.location.pathname.replace(/[^/]*$/, '');
                const detailsURL = `${baseURL}detailsresult.html?iid=${encodeURIComponent(studentIID)}`;
                
                // Open in new tab/window
                window.open(detailsURL, '_blank');
                
                showMessage(`Opening detailed result for Student IID: ${studentIID}`, 'success');
            } catch (error) {
                showMessage('Failed to open detailed result: ' + error.message, 'error');
            }
        }

        // Toggle column visibility function (reliable)
        function toggleColumns() {
            const showTotal = document.getElementById('showTotal')?.checked ?? true;
            const showGPA = document.getElementById('showGPA')?.checked ?? true;

            const totalCells = document.querySelectorAll('th.col-total, td.col-total');
            const gpaCells = document.querySelectorAll('th.col-gpa, td.col-gpa');

            totalCells.forEach(el => { el.style.display = showTotal ? '' : 'none'; });
            gpaCells.forEach(el => { el.style.display = showGPA ? '' : 'none'; });
        }

        // Initialize toggle on page load
        document.addEventListener('DOMContentLoaded', function() {
            const totalCb = document.getElementById('showTotal');
            const gpaCb = document.getElementById('showGPA');
            if (totalCb) totalCb.checked = true;
            if (gpaCb) gpaCb.checked = true;
            // Apply once in case table is already rendered
            setTimeout(toggleColumns, 0);
        });
    </script>
</body>
</html>