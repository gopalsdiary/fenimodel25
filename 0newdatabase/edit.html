<!doctype html>
<html lang="bn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Edit Student</title>
	<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
	<style>
		:root{ color-scheme: light dark; }
		body{ margin:0; font-family:'Kalpurush','Noto Sans Bengali','Hind Siliguri', system-ui, Arial, sans-serif; background:#f6f7f9; color:#0f172a; }
		header{ position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:5; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
		.container{ max-width:900px; margin:0 auto; padding:1.5rem; }
		h1{ margin:.25rem 0 .5rem; font-size:1.35rem; }
		.breadcrumb{ display:flex; gap:0.5rem; font-size:0.9rem; color:#6b7280; margin-bottom:1.5rem; }
		.breadcrumb a{ color:#0b74de; text-decoration:none; }
		.breadcrumb a:hover{ text-decoration:underline; }
		.breadcrumb span{ color:#d1d5db; margin:0 0.25rem; }
		.form-group{ margin-bottom:1.5rem; }
		label{ display:block; margin-bottom:0.5rem; font-weight:600; color:#0f172a; }
		input, textarea, select{ width:100%; padding:0.7rem; border:1px solid #d1d5db; border-radius:6px; font-family:inherit; font-size:1rem; }
		input:focus, textarea:focus, select:focus{ outline:none; border-color:#0b74de; box-shadow:0 0 0 3px rgba(11,116,222,0.1); }
		textarea{ resize:vertical; min-height:100px; }
		.form-row{ display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
		@media (max-width:600px){ .form-row{ grid-template-columns:1fr; } }
		.button-group{ display:flex; gap:1rem; margin-top:2rem; }
		button{ padding:0.75rem 1.5rem; border:none; border-radius:6px; font-weight:600; cursor:pointer; font-size:1rem; transition:all 0.2s; }
		.btn-primary{ background:#0b74de; color:#fff; }
		.btn-primary:hover{ background:#0953ba; }
		.btn-primary:disabled{ background:#cbd5e1; cursor:not-allowed; }
		.btn-secondary{ background:#e5e7eb; color:#0f172a; }
		.btn-secondary:hover{ background:#d1d5db; }
		.status-message{ padding:1rem; border-radius:6px; margin-bottom:1.5rem; display:none; }
		.status-message.success{ background:#d1fae5; color:#065f46; border:1px solid #6ee7b7; }
		.status-message.error{ background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
		.status-message.info{ background:#dbeafe; color:#0c2340; border:1px solid #93c5fd; }
		.loading{ display:none; text-align:center; }
		.spinner{ display:inline-block; width:20px; height:20px; border:3px solid #e5e7eb; border-top-color:#0b74de; border-radius:50%; animation:spin 0.8s linear infinite; }
		@keyframes spin{ to{ transform:rotate(360deg); } }
		.field-group{ background:#f8fafc; padding:1.5rem; border-radius:6px; border-left:4px solid #0b74de; margin-bottom:2rem; }
		.field-group:last-of-type{ margin-bottom:0; }
		.field-group h3{ margin-top:0; margin-bottom:1.5rem; font-size:1rem; color:#0f172a; }
		.field-group .form-row{ margin-bottom:1.5rem; }
		.field-group .form-row:last-child{ margin-bottom:0; }
		.field-group .form-group{ margin-bottom:1.5rem; }
		.field-group .form-group:last-child{ margin-bottom:0; }
		@media (prefers-color-scheme: dark){
			body{ background:#0b1020; color:#e5e7eb; }
			header{ background:#111729; border-color:#263148; }
			input, textarea, select{ background:#0f162a; border-color:#263148; color:#e5e7eb; }
			input:focus, textarea:focus, select:focus{ border-color:#0b74de; box-shadow:0 0 0 3px rgba(11,116,222,0.2); }
			label{ color:#e5e7eb; }
			.field-group{ background:#0f162a; border-left-color:#0b74de; }
			.field-group h3{ color:#e5e7eb; }
			.btn-secondary{ background:#263148; color:#e5e7eb; }
			.btn-secondary:hover{ background:#354152; }
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
	<header>
		<div class="container">
			<h1>‚úèÔ∏è Edit Student Data</h1>
			<div class="breadcrumb">
				<a href="datalist.html">‚Üê Back to List</a>
				<span>|</span>
				<span id="iidDisplay"></span>
			</div>
		</div>
	</header>

	<div class="container">
		<div class="status-message" id="statusMessage"></div>

		<div class="loading" id="loadingIndicator">
			<div class="spinner"></div>
			<p>Loading student data...</p>
		</div>

		<form id="editForm" style="display:none;">
			<!-- Year 2024 -->
			<div class="field-group">
				<h3>üìö Year 2024</h3>
				<div class="form-row">
					<div class="form-group">
						<label for="class_2024">Class 2024</label>
						<input type="text" id="class_2024" name="class_2024" />
					</div>
					<div class="form-group">
						<label for="section_2024">Section 2024</label>
						<input type="text" id="section_2024" name="section_2024" />
					</div>
					<div class="form-group">
						<label for="roll_2024">Roll 2024</label>
						<input type="text" id="roll_2024" name="roll_2024" />
					</div>
				</div>
			</div>

			<!-- Year 2025 -->
			<div class="field-group">
				<h3>üìö Year 2025</h3>
				<div class="form-row">
					<div class="form-group">
						<label for="class_2025">Class 2025</label>
						<input type="text" id="class_2025" name="class_2025" />
					</div>
					<div class="form-group">
						<label for="section_2025">Section 2025</label>
						<input type="text" id="section_2025" name="section_2025" />
					</div>
					<div class="form-group">
						<label for="roll_2025">Roll 2025</label>
						<input type="text" id="roll_2025" name="roll_2025" />
					</div>
				</div>
			</div>

			<!-- Year 2026 -->
			<div class="field-group">
				<h3>üìö Year 2026</h3>
				<div class="form-row">
					<div class="form-group">
						<label for="class_2026">Class 2026</label>
						<input type="text" id="class_2026" name="class_2026" />
					</div>
					<div class="form-group">
						<label for="section_2026">Section 2026</label>
						<input type="text" id="section_2026" name="section_2026" />
					</div>
					<div class="form-group">
						<label for="roll_2026">Roll 2026</label>
						<input type="text" id="roll_2026" name="roll_2026" />
					</div>
				</div>
			</div>

			<!-- Other Fields -->
			<div class="field-group">
				<h3>‚ÑπÔ∏è Other Information</h3>
				<div class="form-row">
					<div class="form-group">
						<label for="status">Status</label>
						<input type="text" id="status" name="status" />
					</div>
					<div class="form-group">
						<label for="religion">Religion</label>
						<input type="text" id="religion" name="religion" />
					</div>
					<div class="form-group">
						<label for="session">Session</label>
						<input type="text" id="session" name="session" />
					</div>
				</div>
			</div>

			<!-- Buttons -->
			<div class="button-group">
				<button type="submit" class="btn-primary">üíæ Save Changes</button>
				<button type="button" class="btn-secondary" onclick="window.history.back();">Cancel</button>
			</div>
		</form>
	</div>

	<script>
		// Supabase config
		const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
		const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
		const tableName = 'student_database';

		const form = document.getElementById('editForm');
		const statusEl = document.getElementById('statusMessage');
		const loadingEl = document.getElementById('loadingIndicator');
		const iidDisplay = document.getElementById('iidDisplay');

		let currentIid = null;
		let originalData = {};

		function showStatus(message, type = 'info') {
			statusEl.textContent = message;
			statusEl.className = `status-message ${type}`;
			statusEl.style.display = 'block';
		}

		function hideStatus() {
			statusEl.style.display = 'none';
		}

		async function loadData() {
			try {
				// Get iid from URL parameter
				const params = new URLSearchParams(window.location.search);
				currentIid = params.get('iid');

				if (!currentIid) {
					showStatus('‚ùå No student ID provided', 'error');
					return;
				}

				iidDisplay.textContent = `IID: ${currentIid}`;
				loadingEl.style.display = 'block';

				// Fetch from Supabase
				const { data, error } = await supabase
					.from(tableName)
					.select('*')
					.eq('iid', currentIid)
					.limit(1);

				if (error) throw error;

				if (!data || data.length === 0) {
					showStatus('‚ùå Student not found', 'error');
					loadingEl.style.display = 'none';
					return;
				}

				originalData = data[0];

				// Populate form
				const fields = [
					'class_2024', 'section_2024', 'roll_2024',
					'class_2025', 'section_2025', 'roll_2025',
					'class_2026', 'section_2026', 'roll_2026',
					'status', 'religion', 'session'
				];

				for (const field of fields) {
					const el = document.getElementById(field);
					if (el) {
						el.value = originalData[field] || '';
					}
				}

				loadingEl.style.display = 'none';
				form.style.display = 'block';
				hideStatus();

			} catch (err) {
				showStatus(`‚ùå Error loading data: ${err.message}`, 'error');
				loadingEl.style.display = 'none';
			}
		}

		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			if (!currentIid) return;

			try {
				// Collect form data
				const fields = [
					'class_2024', 'section_2024', 'roll_2024',
					'class_2025', 'section_2025', 'roll_2025',
					'class_2026', 'section_2026', 'roll_2026',
					'status', 'religion', 'session'
				];

				const updates = {};
				for (const field of fields) {
					const el = document.getElementById(field);
					if (el) {
						updates[field] = el.value || null;
					}
				}

				// Update in Supabase
				const { error } = await supabase
					.from(tableName)
					.update(updates)
					.eq('iid', currentIid);

				if (error) throw error;

				showStatus('‚úÖ Student data updated successfully!', 'success');
				setTimeout(() => {
					window.location.href = `datalist.html#sclass-${originalData.class_2025}-${String(originalData.section_2025 || '').toLowerCase()}-2025`;
				}, 1500);

			} catch (err) {
				showStatus(`‚ùå Error saving data: ${err.message}`, 'error');
			}
		});

		// Load data on page load
		loadData();
	</script>
</body>
</html>
