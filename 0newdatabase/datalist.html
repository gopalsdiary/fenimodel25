<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
	<title>All Students List - Dynamic Columns</title>
	<style>
		html{font-size:85%}
		body{font-family:'Kalpurush', Arial, Helvetica, sans-serif; padding:20px 10px 20px 20px; color:#1f2937; background:#f3f4f6}
		h2{margin:0 0 12px}
		.status{margin:4px 0 16px;color:#4b5563}

		/* landscape cards stacked vertically, aligned to left */
		.container{display:flex;flex-direction:column;gap:16px;align-items:flex-start}

		/* card - left aligned, no centering */
		.card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.04);width:100%;max-width:none;margin:0}
		.card-header{display:flex;justify-content:space-between;align-items:baseline;padding:12px 14px;border-bottom:1px solid #f1f5f9;background:#fafafa;border-top-left-radius:10px;border-top-right-radius:10px}
		.card-title{font-size:18px;color:#0f172a;margin:0}
		.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#e2e8f0;color:#334155}
		.count{font-size:12px;color:#6b7280;margin-left:8px}
		.card-body{padding:10px 12px}

		table{width:100%;border-collapse:collapse;margin-top:0;table-layout:auto}
		.table-wrapper{overflow-x:auto;width:100%}
		th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:middle;white-space:nowrap}
		th{background:#f4f4f4;position:sticky;top:0}
		tbody tr:nth-child(odd){ background:#ffffff }
		tbody tr:nth-child(even){ background:#f5f5f5 }
		tbody tr.status-tc{background-color:rgba(250,187,187,.5) !important}
		.col-sl{width:56px;max-width:56px;padding:4px;text-align:center}
		.col-action{width:80px;max-width:80px;padding:6px;text-align:center}
		
		/* Modal styles */
		.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);animation:fadeIn 0.3s ease}
		.modal.show{display:flex;align-items:center;justify-content:center}
		@keyframes fadeIn{from{opacity:0}to{opacity:1}}
		.modal-content{background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);max-width:600px;width:90%;max-height:90vh;overflow-y:auto;animation:slideIn 0.3s ease}
		@keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
		.modal-header{padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
		.modal-title{font-size:18px;font-weight:700;margin:0}
		.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#6b7280;transition:color 0.2s}
		.modal-close:hover{color:#0f172a}
		.modal-body{padding:20px}
		.modal-body p{margin:0 0 12px 0;color:#374151}
		.modal-body .field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
		.modal-body .field-row.full{grid-template-columns:1fr}
		.modal-body label{display:block;font-size:12px;font-weight:600;color:#6b7280;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
		.modal-body .value{font-size:14px;color:#0f172a;padding:8px;background:#f9fafb;border-radius:6px;border:1px solid #e5e7eb}
		.modal-body .modal-input{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;font-family:inherit;box-sizing:border-box}
		.modal-body .modal-input:focus{outline:none;border-color:#0b74de;box-shadow:0 0 0 3px rgba(11,116,222,0.1)}
		.modal-footer{padding:20px;border-top:1px solid #e5e7eb;display:flex;gap:12px;justify-content:flex-end}
		.modal-btn{padding:8px 16px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s}
		.modal-btn-primary{background:#0b74de;color:#fff}
		.modal-btn-primary:hover{background:#0953ba}
		.modal-btn-secondary{background:#e5e7eb;color:#0f172a}
		.modal-btn-secondary:hover{background:#d1d5db}
		@media (prefers-color-scheme:dark){
			.modal-content{background:#111729;border-color:#263148}
			.modal-header{border-bottom-color:#263148}
			.modal-title{color:#e5e7eb}
			.modal-body p{color:#cbd5e1}
			.modal-body .value{background:#0f162a;color:#e5e7eb;border-color:#263148}
			.modal-body .modal-input{background:#0f162a;color:#e5e7eb;border-color:#263148}
			.modal-body .modal-input:focus{border-color:#0b74de;box-shadow:0 0 0 3px rgba(11,116,222,0.2)}
			.modal-body label{color:#9ca3af}
			.modal-footer{border-top-color:#263148}
			.modal-btn-secondary{background:#263148;color:#e5e7eb}
			.modal-btn-secondary:hover{background:#354152}
		}
	</style>
</head>
<body>
	<h2>All Students List (Dynamic Columns by Session)</h2>
	<div class="toolbar">
		<span id="status" class="status"></span>
	</div>

	<div id="container" class="container">
		<!-- groups will be rendered here -->
	</div>

	<!-- Edit Modal -->
	<div id="editModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 class="modal-title">‚úèÔ∏è Edit Student</h2>
				<button class="modal-close" onclick="closeEditModal()">&times;</button>
			</div>
			<div class="modal-body" id="modalBody">
				<!-- Student data will be loaded here -->
			</div>
			<div class="modal-footer">
				<button class="modal-btn modal-btn-secondary" onclick="closeEditModal()">Cancel</button>
				<button class="modal-btn modal-btn-primary" onclick="saveModalChanges()">üíæ Save Changes</button>
				<a class="modal-btn modal-btn-primary" id="editLinkBtn" href="#" target="_blank">Open Full Editor</a>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	  <script src="../login/auth-check_copy.js"></script>

	<script>
		//Datalist (datalist.html) ‚Üí localStorage key: datalist_rows_v2
		
		// Supabase config (same project as other pages)
		const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
		const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
		const tableName = 'student_database';

		// Cache (1000000 minutes for faster perceived load, reduced from 30m for freshness)
		const CACHE_KEY = 'datalist_rows_v2';
		const CACHE_TTL_MS = 1000000*60*1000;

		const container = document.getElementById('container');
		const statusEl = document.getElementById('status');

		// Column spec from CSV
		let columnSpec = []; // [{field, label}]

		async function loadColumnSpec(){
			const res = await fetch('data_show_datalist.csv');
			const text = await res.text();
			const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
			const spec = [];
			for(const line of lines){
				if(line.toLowerCase().includes('colm name')) continue;
				const parts = line.split(' > ');
				if(parts.length >= 2){
					const field = parts[0].trim();
					const label = parts[1].trim();
					if(field) spec.push({ field, label });
				}
			}
			columnSpec = spec;
		}

		// Cache helpers
		function saveCache(rows){
			try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), rows})); }catch(e){}
		}
		function loadCache(){
			try{
				const raw = localStorage.getItem(CACHE_KEY);
				if(!raw) return null;
				const obj = JSON.parse(raw);
				if(!obj || !Array.isArray(obj.rows)) return null;
				return obj;
			}catch(e){ return null; }
		}

		async function fetchAll(){
			let all = [];
			let lastId = 0;
			let hasMore = true;
			// Use 1000 to align with PostgREST per-request cap
			const batchSize = 10000;
			let batchCount = 0;
			let prevLastId = null; // plateau guard
			const maxBatches = 10000; // generous safety cap
			
			while(hasMore && batchCount < maxBatches){
				batchCount++;
				statusEl.textContent = `Loading... (${all.length} records loaded, batch ${batchCount})`;
				
				// Select only needed columns to reduce payload
				const selectColsArr = (columnSpec && columnSpec.length > 0)
					? Array.from(new Set(columnSpec.map(c => c.field).concat([
						'iid',
						'class_2025','section_2025','roll_2025',
						'class_2026','section_2026','roll_2026',
						'session','status'
					])))
						.filter(Boolean)
						.map(c => String(c).replace(/["\s]+/g, '').trim())
					: null;
				const selectArg = selectColsArr ? selectColsArr.join(',') : '*';
				
				// Primary attempt
				let data, error;
				try{
					({ data, error } = await supabase
						.from(tableName)
						.select(selectArg)
						.gt('iid', lastId)
						.order('iid', { ascending: true })
						.limit(batchSize));
				}catch(e){ data = null; error = e; }
				
				// Fallback to '*' if needed
				if(error || !Array.isArray(data)){
					({ data, error } = await supabase
						.from(tableName)
						.select('*')
						.gt('iid', lastId)
						.order('iid', { ascending: true })
						.limit(batchSize));
				}
				
				if(error) throw error;
				
				if(!data || data.length === 0){
					hasMore = false;
					break;
				}
				
				// Use push instead of concat for better performance
				for(const row of data) all.push(row);
				lastId = data[data.length - 1].iid;
				// plateau guard
				if(prevLastId !== null && Number(lastId) === Number(prevLastId)){
					console.warn('Pagination stalled (iid not advancing). Stopping. lastId=', lastId);
					hasMore = false;
					break;
				}
				prevLastId = lastId;
			}
			return all;
		}

		function groupByClassSection(rows){
			// Check for hash-based filter (e.g., #sclass-6-golap-2025 or #sclass-10-shapla-science-2025)
			// Format: sclass-{classNum}-{sectionName (may have multiple parts)}-{year}
			// Year is always the last 4 digits
			let filterClass = '', filterSection = '', filterYear = '';
			const hash = window.location.hash.substring(1); // Remove '#'
			console.log('Hash from URL:', hash);
			
			if(hash && hash.startsWith('sclass-')){
				// Remove 'sclass-' prefix
				let slug = hash.substring(7);
				
				// Extract year from end: year is always last -YYYY part
				const yearMatch = slug.match(/-(\d{4})$/);
				if(yearMatch){
					filterYear = yearMatch[1]; // e.g., '2025'
					slug = slug.substring(0, slug.length - 5); // Remove '-2025'
					
					// Split remaining by '-': className-sectionName (sectionName may have hyphens)
					const parts = slug.split('-');
					if(parts.length >= 1){
						filterClass = parts[0]; // e.g., '6' or '10'
						filterSection = parts.slice(1).join('-'); // e.g., 'golap' or 'shapla-science'
						console.log(`Hash filter parsed: class=${filterClass}, section=${filterSection}, year=${filterYear}`);
					}
				}
			}

			console.log('Total rows before filter:', rows.length);
			console.log('First row sample:', rows[0]);

			// Exclude TC-status rows from display
			const filtered = rows.filter(r => {
				// Apply hash-based filter if present
				if(filterClass || filterSection || filterYear){
					const c = String(r[`class_${filterYear}`] || '');
					const s = String(r[`section_${filterYear}`] || '').toLowerCase();
					
					// Check class match
					if(filterClass && c !== filterClass) return false;
					// Check section match: extract first word from both database section and filter section
					if(filterSection){
						const sectionFirstWord = s.split(/[\s\-_]+/)[0];
						const filterFirstWord = filterSection.split(/[\s\-_]+/)[0];
						console.log(`Comparing: db section="${s}" (first word="${sectionFirstWord}") vs filter="${filterSection}" (first word="${filterFirstWord}")`);
						if(sectionFirstWord !== filterFirstWord.toLowerCase()) return false;
					}
				}
				
				// Filter out TC status rows
				return !String(r.status||'').toUpperCase().includes('TC');
			});
			
			console.log('Filtered rows count:', filtered.length);
			
			// Return all rows as a single group for unified table display
			const allRows = [...filtered].sort((a,b)=>{
				// Sort by class, section, roll, then iid
				const ca = Number(a.class_2025) || 0, cb = Number(b.class_2025) || 0;
				if(ca !== cb) return ca - cb;
				const secCmp = (a.section_2025 || '').localeCompare(b.section_2025 || '');
				if(secCmp !== 0) return secCmp;
				const ra = Number(a.roll_2025) || 0, rb = Number(b.roll_2025) || 0;
				if(ra !== rb) return ra - rb;
				const ia = Number(a.iid) || 0, ib = Number(b.iid) || 0;
				return ia - ib;
			});
			const titleText = filterClass ? `Class ${filterClass}${filterSection ? ' - ' + filterSection.toUpperCase() : ''}${filterYear ? ' (' + filterYear + ')' : ''}` : 'All Classes';
			console.log('Title:', titleText);
			return [{ class_: titleText, section: '', session: '', rows: allRows }];
		}

		function escapeHtml(s){
			if(s===null||s===undefined) return '';
			return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
		}

		function render(groups){
			container.innerHTML = '';
			let total = 0;
			// Use document fragment for better performance
			const fragment = document.createDocumentFragment();
			
			// Single table for all data
			const card = document.createElement('div');
			card.className = 'card';
			
			// Card header
			const header = document.createElement('div');
			header.className = 'card-header';
			const title = document.createElement('h3');
			title.className = 'card-title';
			const sampleRow = groups[0].rows[0];
			const sessionValue = sampleRow ? String(sampleRow.session || '').trim() : '';
			title.textContent = 'All Students';
			const badge = document.createElement('span');
			badge.className = 'badge';
			badge.textContent = `${groups[0].rows.length} students`;
			header.appendChild(title);
			header.appendChild(badge);
			
			// Card body with table wrapper
			const body = document.createElement('div');
			body.className = 'card-body';
			const tableWrapper = document.createElement('div');
			tableWrapper.className = 'table-wrapper';
			const table = document.createElement('table');
			
			// Table header
			const thead = document.createElement('thead');
			const htr = document.createElement('tr');
			
			// Add Action column first (leftmost)
			const actionHeader = document.createElement('th');
			actionHeader.className = 'col-action';
			actionHeader.textContent = 'Action';
			htr.appendChild(actionHeader);
			
			const sl = document.createElement('th'); 
			sl.className='col-sl'; 
			sl.textContent = 'SL'; 
			htr.appendChild(sl);

			// Always show CSV columns; ensure 'iid' exists and insert active_* after it
			let hasIid = columnSpec.some(c => c.field === 'iid');
			// Build a working copy, injecting iid at start if missing
			const colsForHeader = hasIid ? [...columnSpec] : [{ field: 'iid', label: 'iid' }, ...columnSpec];
			for(const col of colsForHeader){
				const th = document.createElement('th');
				th.textContent = col.label || col.field;
				htr.appendChild(th);
					if(col.field === 'iid'){
					// Insert the three active columns right after iid
						const thCSY = document.createElement('th'); thCSY.textContent = 'class_section_year'; htr.appendChild(thCSY);
						const thAR = document.createElement('th'); thAR.textContent = 'active_roll'; htr.appendChild(thAR);
						const thAC = document.createElement('th'); thAC.textContent = 'active_class'; htr.appendChild(thAC);
						const thAS = document.createElement('th'); thAS.textContent = 'active_section'; htr.appendChild(thAS);
				}
			}
			
			thead.appendChild(htr);
			table.appendChild(thead);

			// Table body
			const tbody = document.createElement('tbody');
			groups[0].rows.forEach((row, idx) =>{
				const tr = document.createElement('tr');
				if(String(row.status||'').toUpperCase().includes('TC')) tr.className = 'status-tc';
				
				// Add Action cell (leftmost, before SL)
				const actionTd = document.createElement('td');
				actionTd.className = 'col-action';
				const editBtn = document.createElement('button');
				editBtn.textContent = 'Edit';
				editBtn.style.display = 'inline-block';
				editBtn.style.padding = '0.4rem 0.8rem';
				editBtn.style.backgroundColor = '#0b74de';
				editBtn.style.color = '#fff';
				editBtn.style.border = 'none';
				editBtn.style.borderRadius = '4px';
				editBtn.style.fontSize = '0.9rem';
				editBtn.style.fontWeight = '600';
				editBtn.style.cursor = 'pointer';
				editBtn.style.transition = 'background-color 0.2s';
				editBtn.onmouseover = () => { editBtn.style.backgroundColor = '#0953ba'; };
				editBtn.onmouseout = () => { editBtn.style.backgroundColor = '#0b74de'; };
				editBtn.onclick = (e) => {
					e.preventDefault();
					openEditModal(row);
				};
				actionTd.appendChild(editBtn);
				tr.appendChild(actionTd);
				
				const sltd = document.createElement('td'); 
				sltd.className='col-sl'; 
				sltd.textContent = (idx+1); 
				tr.appendChild(sltd);

				// Helper to compute active values based on session thresholds
				const sNum = Number(row.session);
				let active_roll = '', active_class = '', active_section = '';
				if(Number.isFinite(sNum) && sNum === 2026){
					active_roll = row.roll_2026 ?? '';
					active_class = row.class_2026 ?? '';
					active_section = row.section_2026 ?? '';
				}else if(Number.isFinite(sNum) && sNum === 2025){
					active_roll = row.roll_2025 ?? '';
					active_class = row.class_2025 ?? '';
					active_section = row.section_2025 ?? '';
				}

				// Build cells from CSV spec, ensuring iid and inserting active_* right after it
				let hasIidRow = columnSpec.some(c => c.field === 'iid');
				const colsForRow = hasIidRow ? [...columnSpec] : [{ field: 'iid', label: 'iid' }, ...columnSpec];
				for(const col of colsForRow){
					const td = document.createElement('td');
					const v = row[col.field];
					if(col.field === 'iid'){
						const link = document.createElement('a');
						link.href = `detailsinfo.html?iid=${encodeURIComponent(v)}`;
						link.textContent = escapeHtml(v==null?'':String(v));
						link.style.color = '#0b74de';
						link.style.textDecoration = 'underline';
						td.appendChild(link);
						tr.appendChild(td);
						// Insert class_section_year and the three active columns right after iid
						let csY = '';
						const hasActiveRoll = !(active_roll === null || active_roll === undefined || (typeof active_roll === 'string' && active_roll.trim() === ''));
						if(hasActiveRoll){
							csY = [active_class ?? '', active_section ?? '', (row.session ?? '')]
								.map(x => String(x ?? ''))
								.join('-');
						}
						const tdCSY = document.createElement('td'); tdCSY.textContent = escapeHtml(csY); tr.appendChild(tdCSY);
						const tdAR = document.createElement('td'); tdAR.textContent = escapeHtml(active_roll==null?'':String(active_roll)); tr.appendChild(tdAR);
						const tdAC = document.createElement('td'); tdAC.textContent = escapeHtml(active_class==null?'':String(active_class)); tr.appendChild(tdAC);
						const tdAS = document.createElement('td'); tdAS.textContent = escapeHtml(active_section==null?'':String(active_section)); tr.appendChild(tdAS);
						continue; // iid already appended with active_*; skip generic append below
					}else{
						td.textContent = escapeHtml(v==null?'':String(v));
					}
					tr.appendChild(td);
				}
				
				tbody.appendChild(tr);
			});
			table.appendChild(tbody);
			tableWrapper.appendChild(table);
			body.appendChild(tableWrapper);
			card.appendChild(header);
			card.appendChild(body);
			fragment.appendChild(card);
			
			container.appendChild(fragment);
			statusEl.textContent = `Total Students: ${groups[0].rows.length} | Session sample: ${sessionValue || 'N/A'} | Extra: active_roll/active_class/active_section`;
		}

		async function loadAll(background=false){
			if(!background) statusEl.textContent = 'Loading...';
			try{
				if(columnSpec.length===0) await loadColumnSpec();
				const rows = await fetchAll();
				saveCache(rows);
				const groups = groupByClassSection(rows);
				render(groups);
			}catch(err){
				const msg = (err && err.message) ? err.message : String(err);
				statusEl.textContent = `Load error: ${msg}`;
				// Try cache fallback
				const cached = loadCache();
				if(cached && Array.isArray(cached.rows)){
					const groups = groupByClassSection(cached.rows);
					render(groups);
					const ageM = Math.floor((Date.now()-cached.ts)/60000);
					statusEl.textContent = `Total Students: ${cached.rows.length} (offline cache, ${ageM}m old)`;
				}
			}
		}

		// Initial: try fresh cache then revalidate
		(async function init(){
			try{ if(columnSpec.length===0) await loadColumnSpec(); }catch(e){}
			const cached = loadCache();
			if(cached && (Date.now()-cached.ts) < CACHE_TTL_MS){
				const groups = groupByClassSection(cached.rows);
				render(groups);
				const ageM = Math.floor((Date.now()-cached.ts)/60000);
				statusEl.textContent = `Groups: ${groups.length} | Total: ${cached.rows.length} (from cache, ${ageM}m old)`;
				setTimeout(()=> loadAll(true), 0);
			}else{
				loadAll(false);
			}
		})();

		// Modal functions
		function openEditModal(row){
			const modal = document.getElementById('editModal');
			const modalBody = document.getElementById('modalBody');
			const editLinkBtn = document.getElementById('editLinkBtn');
			
			// Store current row data for updating
			window.currentEditRow = { ...row };
			
			// Update the edit link
			editLinkBtn.href = `edit.html?iid=${encodeURIComponent(row.iid)}`;
			
			// Build HTML for modal body with editable fields
			let html = `<p><strong>IID:</strong> ${row.iid}</p>`;
			
			// Year 2024
			html += `<div class="field-row full"><strong>üìö Year 2024</strong></div>`;
			html += `<div class="field-row">
				<div><label>Class</label><input type="text" class="modal-input" data-field="class_2024" value="${row.class_2024 || ''}" placeholder="Class"></div>
				<div><label>Section</label><input type="text" class="modal-input" data-field="section_2024" value="${row.section_2024 || ''}" placeholder="Section"></div>
			</div>`;
			html += `<div class="field-row">
				<div><label>Roll</label><input type="text" class="modal-input" data-field="roll_2024" value="${row.roll_2024 || ''}" placeholder="Roll"></div>
			</div>`;
			
			// Year 2025
			html += `<div class="field-row full"><strong>üìö Year 2025</strong></div>`;
			html += `<div class="field-row">
				<div><label>Class</label><input type="text" class="modal-input" data-field="class_2025" value="${row.class_2025 || ''}" placeholder="Class"></div>
				<div><label>Section</label><input type="text" class="modal-input" data-field="section_2025" value="${row.section_2025 || ''}" placeholder="Section"></div>
			</div>`;
			html += `<div class="field-row">
				<div><label>Roll</label><input type="text" class="modal-input" data-field="roll_2025" value="${row.roll_2025 || ''}" placeholder="Roll"></div>
			</div>`;
			
			// Year 2026
			html += `<div class="field-row full"><strong>üìö Year 2026</strong></div>`;
			html += `<div class="field-row">
				<div><label>Class</label><input type="text" class="modal-input" data-field="class_2026" value="${row.class_2026 || ''}" placeholder="Class"></div>
				<div><label>Section</label><input type="text" class="modal-input" data-field="section_2026" value="${row.section_2026 || ''}" placeholder="Section"></div>
			</div>`;
			html += `<div class="field-row">
				<div><label>Roll</label><input type="text" class="modal-input" data-field="roll_2026" value="${row.roll_2026 || ''}" placeholder="Roll"></div>
			</div>`;
			
			// Personal Info
			html += `<div class="field-row full"><strong>üë§ Personal Info</strong></div>`;
			html += `<div class="field-row">
				<div><label>Status</label><input type="text" class="modal-input" data-field="status" value="${row.status || ''}" placeholder="Status"></div>
				<div><label>Religion</label><input type="text" class="modal-input" data-field="religion" value="${row.religion || ''}" placeholder="Religion"></div>
			</div>`;
			html += `<div class="field-row">
				<div><label>Session</label><input type="text" class="modal-input" data-field="session" value="${row.session || ''}" placeholder="Session"></div>
			</div>`;
			
			// Additional fields if available
			const knownFields = ['iid', 'class_2024', 'section_2024', 'roll_2024', 'class_2025', 'section_2025', 'roll_2025', 'class_2026', 'section_2026', 'roll_2026', 'status', 'religion', 'session'];
			const additionalFields = Object.keys(row).filter(k => !knownFields.includes(k) && row[k]);
			if(additionalFields.length > 0){
				html += `<div class="field-row full"><strong>üìã Other Fields</strong></div>`;
				for(const field of additionalFields){
					html += `<div class="field-row full">
						<div><label>${field}</label><input type="text" class="modal-input" data-field="${field}" value="${row[field] || ''}" placeholder="${field}"></div>
					</div>`;
				}
			}
			
			modalBody.innerHTML = html;
			modal.classList.add('show');
		}
		
		function closeEditModal(){
			const modal = document.getElementById('editModal');
			modal.classList.remove('show');
		}
		
		async function saveModalChanges(){
			if(!window.currentEditRow) return;
			
			const iid = window.currentEditRow.iid;
			const updateData = {};
			
			// Collect all input values
			document.querySelectorAll('.modal-input').forEach(input => {
				const field = input.dataset.field;
				const value = input.value.trim();
				if(value !== (window.currentEditRow[field] || '')) {
					updateData[field] = value || null;
				}
			});
			
			if(Object.keys(updateData).length === 0) {
				closeEditModal();
				return;
			}
			
			try {
				const { error } = await supabase
					.from(tableName)
					.update(updateData)
					.eq('iid', iid);
				
				if(error) throw error;
				
				closeEditModal();
				
				// Refresh the list
				setTimeout(() => loadAll(false), 500);
			} catch(err) {
				const msg = (err && err.message) ? err.message : String(err);
				alert(`‚ùå Save failed: ${msg}`);
			}
		}
		
		// Close modal when clicking outside
		window.onclick = function(event){
			const modal = document.getElementById('editModal');
			if(event.target === modal){
				modal.classList.remove('show');
			}
		};

	</script>
</body>
</html>
