<!doctype html>
<html lang="bn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>ডাটা লিস্ট — 0newdatabase</title>
	<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
	<!-- Bangla font for better rendering -->
	<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
	<style>
		:root { color-scheme: light dark; }
		body { margin:0; font-family:'Kalpurush','Noto Sans Bengali','Hind Siliguri', system-ui, Arial, sans-serif; background:#f6f7f9; color:#111; }
		header { position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:10; }
		.container { max-width:1100px; margin:0 auto; padding:1rem; }
		h1 { margin:.25rem 0; font-size:1.25rem; text-align:center; }
		.toolbar { display:flex; gap:.75rem; align-items:center; justify-content:center; flex-wrap:wrap; margin:.5rem 0 1rem; }
		input[type="search"]{ padding:.55rem .8rem; min-width:280px; border:1px solid #d1d5db; border-radius:10px; }
		select{ padding:.55rem .8rem; border:1px solid #d1d5db; border-radius:10px; background:#fff; }
		.muted { color:#6b7280; font-size:.85rem; }
		.group { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:1rem; margin:1rem 0; box-shadow:0 8px 24px rgba(0,0,0,.06); }
		.group h2 { margin:.1rem 0 .75rem; font-size:1.05rem; }
		/* Enhanced class title styling */
		.group h2 { text-align:center; font-size:1.365rem; font-weight:700; line-height:1.25; }
		.group h2 .count { display:block; font-size:.55em; font-weight:400; margin-top:.2rem; color:#555; }
		/* Colored class name bars */
		.group h2 { background:#eef2f7; padding:.55rem .85rem; border-radius:10px; position:relative; }
		.group[data-class="6"] h2 { background:linear-gradient(90deg,#2196F3,#64b5f6); color:#fff; }
		.group[data-class="7"] h2 { background:linear-gradient(90deg,#2e7d32,#66bb6a); color:#fff; }
		.group[data-class="8"] h2 { background:linear-gradient(90deg,#6a1b9a,#ab47bc); color:#fff; }
		.group[data-class="9"] h2 { background:linear-gradient(90deg,#ef6c00,#ffa726); color:#fff; }
		.group[data-class="10"] h2 { background:linear-gradient(90deg,#c2185b,#ec407a); color:#fff; }
		.group h2 .count { color:rgba(255,255,255,0.85); }
		@media (prefers-color-scheme: dark){
			.group h2 { background:#1d2840; }
			.group[data-class="6"] h2 { background:linear-gradient(90deg,#1565c0,#1e88e5); }
			.group[data-class="7"] h2 { background:linear-gradient(90deg,#1b5e20,#2e7d32); }
			.group[data-class="8"] h2 { background:linear-gradient(90deg,#4a148c,#6a1b9a); }
			.group[data-class="9"] h2 { background:linear-gradient(90deg,#e65100,#ef6c00); }
			.group[data-class="10"] h2 { background:linear-gradient(90deg,#880e4f,#ad1457); }
		}
		.table-wrap { overflow:auto; border-radius:10px; }
		table { border-collapse:collapse; width:100%; min-width:720px; }
		thead th { position:sticky; top:0; background:#f9fafb; border-bottom:1px solid #e5e7eb; text-align:left; padding:.6rem .7rem; font-size:.9rem; }
		tbody td { border-top:1px solid #f1f5f9; padding:.55rem .7rem; font-size:.92rem; }
		tbody tr:hover { background:#f9fafb; }
		.status { font-size:.85rem; }
		.error { color:#b91c1c; }
		.ok { color:#16a34a; }
		details > summary { cursor:pointer; -webkit-user-select:none; user-select:none; }
		@media (prefers-color-scheme: dark){
			body { background:#0b1020; color:#e5e7eb; }
			header, .group { background:#111729; border-color:#263148; }
			thead th { background:#0f162a; border-bottom-color:#263148; }
			tbody td { border-top-color:#1d2845; }
			input[type="search"]{ background:#0f162a; color:#e5e7eb; border-color:#263148; }
			.muted { color:#9aa5b1; }
		}
	</style>
		<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
	<script>
		// Parse sheet list from sheetidname.text
		async function loadSheetList(){
			const res = await fetch('sheetidname.text', {cache:'no-store'});
			if(!res.ok) throw new Error('Failed to load sheetidname.text');
			const txt = await res.text();
			const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
			const pairs=[]; let cols=null; let curId=null;
			const idRe = /^let\s+sheetId\s*=\s*['"]([^'"]+)['"];?$/i;
			const nameRe = /^let\s+sheetName\s*=\s*['"]([^'"]+)['"];?$/i;
			const homeColsRe = /^(?:let|var|const)?\s*homeShowColumns\s*=\s*\[([^\]]*)\];?$/i;
			for(const line of lines){
				const cm = homeColsRe.exec(line);
				if(cm){
					const nums = cm[1].split(',').map(s=>parseInt(s,10)).filter(n=>Number.isFinite(n));
					if(nums.length) cols = nums; continue;
				}
				const im = idRe.exec(line);
				if(im){ curId = im[1]; continue; }
				const nm = nameRe.exec(line);
				if(nm && curId){ pairs.push({ id:curId, name:nm[1] }); curId=null; continue; }
			}
			return { pairs, cols };
		}

			function csvUrl(id, sheet){
			// Using gviz CSV for predictable CORS and header row
			return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(id)}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;
		}

			function parseSheetMeta(name){
				// Expect patterns like "6-shapla", "7_golap", "8 morning"
				const m = String(name||'').trim().match(/^(\d{1,2})\s*[-_\s]\s*([A-Za-zঅ-য়]+)\s*$/i);
				if(!m) return { cls:'', shift:'' };
				const cls = m[1];
				const rawShift = m[2];
				const shift = rawShift;
				return { cls, shift };
			}

		function normHeader(s){ return String(s||'').toLowerCase().replace(/[\s_\-]+/g,'').trim(); }
		function findIidKey(fields){
			// Prefer 'iid', but accept common variants
			const order = ['iid','id','studentid','sid'];
			const map = new Map(fields.map(f=>[normHeader(f), f]));
			for(const key of order){ if(map.has(key)) return map.get(key); }
			return null;
		}

		function selectColumns(fields, cols){
			if(!Array.isArray(cols) || cols.length===0) return fields.slice(0, Math.min(3, fields.length));
			// Treat as 1-based indices
			const out=[]; cols.forEach(n=>{ const idx=n-1; if(idx>=0 && idx<fields.length) out.push(fields[idx]); });
			return out.length? out : fields.slice(0, Math.min(3, fields.length));
		}

				function renderGroup(container, title, fields, rows, meta, src){
				const group = document.createElement('section'); group.className='group';
				if(meta){ if(meta.cls) group.dataset.class = meta.cls; if(meta.shift) group.dataset.shift = meta.shift.toLowerCase(); }
				const h = document.createElement('h2'); h.innerHTML = `${title} <span class="count">(Total: ${rows.length})</span>`; group.appendChild(h);
			const wrap = document.createElement('div'); wrap.className='table-wrap'; group.appendChild(wrap);
			const table = document.createElement('table'); wrap.appendChild(table);
			const thead = document.createElement('thead'); const trh=document.createElement('tr');
			fields.forEach(f=>{ const th=document.createElement('th'); th.textContent=String(f||''); trh.appendChild(th); });
			thead.appendChild(trh); table.appendChild(thead);
			const tbody = document.createElement('tbody');
					rows.forEach((r, idx)=>{
						const tr=document.createElement('tr');
						fields.forEach((f, fi)=>{ 
							const td=document.createElement('td'); 
							const val = r[f] ?? '';
							if(fi === 0 && src && src.id && src.name){
								const a=document.createElement('a');
								a.textContent = val || '(open)';
								// Prefer linking by a unique IID if present; fallback to row index
								let href = `detailsinfo.html?id=${encodeURIComponent(src.id)}&sheet=${encodeURIComponent(src.name)}`;
								try{
									const allFields = Object.keys(r||{});
									const iidKey = findIidKey(allFields);
									const iidVal = iidKey ? (r[iidKey]) : '';
									if(iidVal!=null && String(iidVal).trim()!== ''){
										href += `&iid=${encodeURIComponent(String(iidVal))}`;
									}else{
										href += `&r=${idx}`;
									}
								}catch(_){ href += `&r=${idx}`; }
								a.href = href;
								a.className = 'link';
								td.appendChild(a);
							} else {
								td.textContent = val;
							}
							tr.appendChild(td); 
						});
				tbody.appendChild(tr);
			});
			table.appendChild(tbody);
			container.appendChild(group);
		}

			function filterAll(q){
			const query = q.toLowerCase();
			document.querySelectorAll('.group tbody tr').forEach(tr=>{
				const show = !query || tr.textContent.toLowerCase().includes(query);
				tr.style.display = show ? '' : 'none';
			});
		}

			function populateFilters(classes, shifts){
				const clsSel = document.getElementById('classFilter');
				const shSel = document.getElementById('shiftFilter');
				// Reset
				clsSel.innerHTML = '';
				shSel.innerHTML = '';
				const mkOpt = (v,l)=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; return o; };
				clsSel.appendChild(mkOpt('', 'Class: All'));
				shSel.appendChild(mkOpt('', 'Shift: All'));
				// Sort classes numerically if possible
				const clsList = Array.from(classes);
				clsList.sort((a,b)=>{ const na=+a, nb=+b; if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a).localeCompare(String(b)); });
				clsList.forEach(c=>clsSel.appendChild(mkOpt(c, c)));
				// Sort shifts alpha (case-insensitive)
				const shList = Array.from(shifts);
				shList.sort((a,b)=>String(a).toLowerCase().localeCompare(String(b).toLowerCase()));
				shList.forEach(s=>{ const label = s.charAt(0).toUpperCase()+s.slice(1); shSel.appendChild(mkOpt(s.toLowerCase(), label)); });
			}

			function applyGroupFilters(){
				const clsVal = (document.getElementById('classFilter').value||'').trim();
				const shVal = (document.getElementById('shiftFilter').value||'').trim();
				document.querySelectorAll('.group').forEach(sec=>{
					// Only filter sections that are real groups (have table)
					const secCls = (sec.dataset.class||'');
					const secShift = (sec.dataset.shift||'');
					// If section has no meta (e.g., an error details), hide only when a filter is selected
					let visible = true;
					if(clsVal){ visible = visible && (secCls===clsVal); }
					if(shVal){ visible = visible && (secShift===shVal); }
					sec.style.display = visible ? '' : 'none';
				});
			}

		async function init(){
			const status = document.getElementById('status');
			try{
				status.textContent = 'Loading sheet list…';
						const { pairs, cols } = await loadSheetList();
				if(!pairs.length){ status.textContent='No sheets defined'; status.classList.add('error'); return; }
						status.textContent = `Found ${pairs.length} sheets. Fetching…`;
				const host = document.getElementById('groups');
						let ok=0, fail=0;
						const classSet = new Set();
						const shiftSet = new Set();
						await Promise.all(pairs.map(async ({id,name})=>{
					try{
						const url = csvUrl(id, name);
						const results = await new Promise((resolve,reject)=>{
							Papa.parse(url, { download:true, header:true, skipEmptyLines:true, complete:r=>resolve(r), error:e=>reject(e) });
						});
						const allRows = (results && results.data) ? results.data : [];
						const fields = (results && results.meta && results.meta.fields) ? results.meta.fields : Object.keys(allRows[0]||{});
						const useFields = selectColumns(fields, cols);
								const meta = parseSheetMeta(name);
								if(meta.cls) classSet.add(meta.cls);
								if(meta.shift) shiftSet.add(meta.shift.toLowerCase());
								renderGroup(host, `${name}`, useFields, allRows, meta, { id, name });
						ok++;
					}catch(e){
						console.error('Fetch error for', name, e);
						fail++;
								const meta = parseSheetMeta(name);
								const d=document.createElement('details'); d.className='group';
								if(meta.cls) d.dataset.class = meta.cls;
								if(meta.shift) d.dataset.shift = meta.shift.toLowerCase();
						const s=document.createElement('summary'); s.innerHTML = `<span class="error">Failed</span> — ${name}`; d.appendChild(s);
						const pre=document.createElement('pre'); pre.textContent=String(e && e.message || e); pre.style.padding='.75rem'; d.appendChild(pre);
						document.getElementById('groups').appendChild(d);
					}
					status.textContent = `Loaded ${ok}/${pairs.length}` + (fail? `, failed ${fail}`:'');
				}));
						// Populate filters after scanned all meta
						populateFilters(classSet, shiftSet);
						applyGroupFilters();
				status.classList.add('ok');
			}catch(err){
				console.error(err);
				status.textContent = 'Init failed';
				status.classList.add('error');
			}
		}

		window.addEventListener('DOMContentLoaded', ()=>{
			init();
			const s=document.getElementById('search');
					s.addEventListener('input', ()=>filterAll(s.value));
					document.getElementById('classFilter').addEventListener('change', applyGroupFilters);
					document.getElementById('shiftFilter').addEventListener('change', applyGroupFilters);
		});
	</script>
</head>
<body>
	<header>
		<div class="container">
			<h1>ডাটা লিস্ট</h1>
						<h1>শিক্ষার্থী খুজে পেতে Search করুণ</h1>

					<div class="toolbar">
						<select id="classFilter" aria-label="Class filter"></select>
						<select id="shiftFilter" aria-label="Shift filter"></select>
						<input id="search" type="search" placeholder="ফিল্টার… (Filter all)" aria-label="Filter" />
				<span id="status" class="muted status"></span>
			</div>
		</div>
	</header>
	<main>
		<div id="groups" class="container"></div>
	</main>
</body>
</html>
