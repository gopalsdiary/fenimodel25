<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
	<title>Class-Section Wise Lists</title>
	<style>
		html{font-size:100%}
		body{font-family:'Kalpurush', Arial, Helvetica, sans-serif; padding:20px 10px 20px 20px; color:#1f2937; background:#f3f4f6}
		h2{margin:0 0 12px}
		.status{margin:4px 0 16px;color:#4b5563}

		/* landscape cards stacked vertically, aligned to left */
		.container{display:flex;flex-direction:column;gap:16px;align-items:flex-start}

		/* card - left aligned, no centering */
		.card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.04);width:100%;max-width:none;margin:0}
		.card-header{display:flex;justify-content:space-between;align-items:baseline;padding:12px 14px;border-bottom:1px solid #f1f5f9;background:#fafafa;border-top-left-radius:10px;border-top-right-radius:10px}
		.card-title{font-size:18px;color:#0f172a;margin:0}
		.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#e2e8f0;color:#334155}
		.count{font-size:12px;color:#6b7280;margin-left:8px}
		.card-body{padding:10px 12px}

		table{width:100%;border-collapse:collapse;margin-top:0;table-layout:auto}
		.table-wrapper{overflow-x:auto;width:100%}
		th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:middle;white-space:nowrap}
		th{background:#f4f4f4;position:sticky;top:0}
		tbody tr:nth-child(odd){ background:#ffffff }
		tbody tr:nth-child(even){ background:#f5f5f5 }
		tbody tr.status-tc{background-color:rgba(250,187,187,.5) !important}
		.col-sl{width:56px;max-width:56px;padding:4px;text-align:center}
	</style>
</head>
<body>
	<h2>Student List by Class & Section</h2>
	<div class="toolbar">
		<span id="status" class="status"></span>
	</div>

	<div id="container" class="container">
		<!-- groups will be rendered here -->
	</div>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
		// Supabase config (same project as other pages)
		const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
		const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
		const tableName = 'student_database';

		// Cache (10 minutes for faster perceived load, reduced from 30m for freshness)
		const CACHE_KEY = 'datalist_rows_v2';
		const CACHE_TTL_MS = 10*60*1000;

		const container = document.getElementById('container');
		const statusEl = document.getElementById('status');

		// Column spec from CSV
		let columnSpec = []; // [{field, label}]

		async function loadColumnSpec(){
			const res = await fetch('data_show_datalist.csv');
			const text = await res.text();
			const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
			const spec = [];
			for(const line of lines){
				if(line.toLowerCase().includes('colm name')) continue;
				const parts = line.split(' > ');
				if(parts.length >= 2){
					const field = parts[0].trim();
					const label = parts[1].trim();
					if(field) spec.push({ field, label });
				}
			}
			columnSpec = spec;
		}

		// Cache helpers
		function saveCache(rows){
			try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), rows})); }catch(e){}
		}
		function loadCache(){
			try{
				const raw = localStorage.getItem(CACHE_KEY);
				if(!raw) return null;
				const obj = JSON.parse(raw);
				if(!obj || !Array.isArray(obj.rows)) return null;
				return obj;
			}catch(e){ return null; }
		}

		async function fetchAll(){
			let all = [];
			let lastId = 0;
			let hasMore = true;
			// Use 1000 to align with PostgREST per-request cap
			const batchSize = 1000;
			let batchCount = 0;
			let prevLastId = null; // plateau guard
			const maxBatches = 10000; // generous safety cap
			
			while(hasMore && batchCount < maxBatches){
				batchCount++;
				statusEl.textContent = `Loading... (${all.length} records loaded, batch ${batchCount})`;
				
				// Select only needed columns to reduce payload
				const selectColsArr = (columnSpec && columnSpec.length > 0)
					? Array.from(new Set(columnSpec.map(c => c.field).concat(['iid','class_2025','section_2025','roll_2025','status'])))
						.filter(Boolean)
						.map(c => String(c).replace(/["\s]+/g, '').trim())
					: null;
				const selectArg = selectColsArr ? selectColsArr.join(',') : '*';
				
				// Primary attempt
				let data, error;
				try{
					({ data, error } = await supabase
						.from(tableName)
						.select(selectArg)
						.gt('iid', lastId)
						.order('iid', { ascending: true })
						.limit(batchSize));
				}catch(e){ data = null; error = e; }
				
				// Fallback to '*' if needed
				if(error || !Array.isArray(data)){
					({ data, error } = await supabase
						.from(tableName)
						.select('*')
						.gt('iid', lastId)
						.order('iid', { ascending: true })
						.limit(batchSize));
				}
				
				if(error) throw error;
				
				if(!data || data.length === 0){
					hasMore = false;
					break;
				}
				
				// Use push instead of concat for better performance
				for(const row of data) all.push(row);
				lastId = data[data.length - 1].iid;
				// plateau guard
				if(prevLastId !== null && Number(lastId) === Number(prevLastId)){
					console.warn('Pagination stalled (iid not advancing). Stopping. lastId=', lastId);
					hasMore = false;
					break;
				}
				prevLastId = lastId;
			}
			return all;
		}

		function groupByClassSection(rows){
			const map = new Map();
			// Optimized grouping with single pass
			for(const r of rows){
				const c = r.class_2025 == null ? '' : String(r.class_2025);
				const s = r.section_2025 == null ? '' : String(r.section_2025);
				const sess = r.session == null ? '' : String(r.session);
				const key = `${c}__${s}__${sess}`;
				if(!map.has(key)) map.set(key, { class_: c, section: s, session: sess, rows: [] });
				map.get(key).rows.push(r);
			}
			// Optimized sorting: pre-calculate numeric values
			for(const g of map.values()){
				g.rows.sort((a,b)=>{
					const ra = Number(a.roll_2025) || 0, rb = Number(b.roll_2025) || 0;
					if(ra !== rb) return ra - rb;
					const ia = Number(a.iid) || 0, ib = Number(b.iid) || 0;
					return ia - ib;
				});
			}
			// Convert to array and sort groups
			const groups = Array.from(map.values()).sort((a,b)=>{
				const ca = Number(a.class_) || 0, cb = Number(b.class_) || 0;
				if(ca !== cb) return ca - cb;
				const secCmp = a.section.localeCompare(b.section);
				if(secCmp !== 0) return secCmp;
				return a.session.localeCompare(b.session);
			});
			return groups;
		}

		function escapeHtml(s){
			if(s===null||s===undefined) return '';
			return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
		}

		function render(groups){
			container.innerHTML = '';
			let total = 0;
			// Use document fragment for better performance
			const fragment = document.createDocumentFragment();
			
			for(const g of groups){
				total += g.rows.length;
				const card = document.createElement('div');
				card.className = 'card';
				
				// Card header
				const header = document.createElement('div');
				header.className = 'card-header';
				const title = document.createElement('h3');
				title.className = 'card-title';
				const cls = g.class_ || 'N/A';
				const sec = g.section || 'N/A';
				const sess = g.session || 'N/A';
				title.textContent = `Class : ${cls}-${sec}-${sess}`;
				const badge = document.createElement('span');
				badge.className = 'badge';
				badge.textContent = `${g.rows.length} students`;
				header.appendChild(title);
				header.appendChild(badge);
				
				// Card body with table wrapper
				const body = document.createElement('div');
				body.className = 'card-body';
				const tableWrapper = document.createElement('div');
				tableWrapper.className = 'table-wrapper';
				const table = document.createElement('table');
				
				// Table header
				const thead = document.createElement('thead');
				const htr = document.createElement('tr');
				const sl = document.createElement('th'); 
				sl.className='col-sl'; 
				sl.textContent = 'SL'; 
				htr.appendChild(sl);
				for(const col of columnSpec){
					const th = document.createElement('th'); 
					th.textContent = col.label || col.field; 
					htr.appendChild(th);
				}
				thead.appendChild(htr);
				table.appendChild(thead);

				// Table body
				const tbody = document.createElement('tbody');
				g.rows.forEach((row, idx) =>{
					const tr = document.createElement('tr');
					if(String(row.status||'').toUpperCase().includes('TC')) tr.className = 'status-tc';
					const sltd = document.createElement('td'); 
					sltd.className='col-sl'; 
					sltd.textContent = (idx+1); 
					tr.appendChild(sltd);
					for(const col of columnSpec){
						const td = document.createElement('td');
						const v = row[col.field];
						if(col.field === 'iid'){
							const link = document.createElement('a');
							link.href = `detailsinfo.html?iid=${encodeURIComponent(v)}`;
							link.textContent = escapeHtml(v==null?'':String(v));
							link.style.color = '#0b74de';
							link.style.textDecoration = 'underline';
							td.appendChild(link);
						}else{
							td.textContent = escapeHtml(v==null?'':String(v));
						}
						tr.appendChild(td);
					}
					tbody.appendChild(tr);
				});
				table.appendChild(tbody);
				tableWrapper.appendChild(table);
				body.appendChild(tableWrapper);
				card.appendChild(header);
				card.appendChild(body);
				fragment.appendChild(card);
			}
			container.appendChild(fragment);
			statusEl.textContent = `Groups: ${groups.length} | Total: ${total}`;
		}

		async function loadAll(background=false){
			if(!background) statusEl.textContent = 'Loading...';
			try{
				if(columnSpec.length===0) await loadColumnSpec();
				const rows = await fetchAll();
				saveCache(rows);
				const groups = groupByClassSection(rows);
				render(groups);
			}catch(err){
				const msg = (err && err.message) ? err.message : String(err);
				statusEl.textContent = `Load error: ${msg}`;
				// Try cache fallback
				const cached = loadCache();
				if(cached && Array.isArray(cached.rows)){
					const groups = groupByClassSection(cached.rows);
					render(groups);
					const ageM = Math.floor((Date.now()-cached.ts)/60000);
					statusEl.textContent = `Groups: ${groups.length} | Total: ${cached.rows.length} (offline cache, ${ageM}m old)`;
				}
			}
		}

		// Initial: try fresh cache then revalidate
		(async function init(){
			try{ if(columnSpec.length===0) await loadColumnSpec(); }catch(e){}
			const cached = loadCache();
			if(cached && (Date.now()-cached.ts) < CACHE_TTL_MS){
				const groups = groupByClassSection(cached.rows);
				render(groups);
				const ageM = Math.floor((Date.now()-cached.ts)/60000);
				statusEl.textContent = `Groups: ${groups.length} | Total: ${cached.rows.length} (from cache, ${ageM}m old)`;
				setTimeout(()=> loadAll(true), 0);
			}else{
				loadAll(false);
			}
		})();
	</script>
</body>
</html>
