<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
	<title>All Students List - Dynamic Columns</title>
	<style>
		html{font-size:85%}
		body{font-family:'Kalpurush', Arial, Helvetica, sans-serif; padding:20px 10px 20px 20px; color:#1f2937; background:#f3f4f6}
		h2{margin:0 0 12px}
		.status{margin:4px 0 16px;color:#4b5563}

		/* landscape cards stacked vertically, aligned to left */
		.container{display:flex;flex-direction:column;gap:16px;align-items:flex-start}

		/* card - left aligned, no centering */
		.card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.04);width:100%;max-width:none;margin:0}
		.card-header{display:flex;justify-content:space-between;align-items:baseline;padding:12px 14px;border-bottom:1px solid #f1f5f9;background:#fafafa;border-top-left-radius:10px;border-top-right-radius:10px}
		.card-title{font-size:18px;color:#0f172a;margin:0}
		.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#e2e8f0;color:#334155}
		.count{font-size:12px;color:#6b7280;margin-left:8px}
		.card-body{padding:10px 12px}

		table{width:100%;border-collapse:collapse;margin-top:0;table-layout:auto}
		.table-wrapper{overflow-x:auto;width:100%}
		th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:middle;white-space:nowrap}
		th{background:#f4f4f4;position:sticky;top:0}
		tbody tr:nth-child(odd){ background:#ffffff }
		tbody tr:nth-child(even){ background:#f5f5f5 }
		tbody tr.status-tc{background-color:rgba(250,187,187,.5) !important}
		.col-sl{width:56px;max-width:56px;padding:4px;text-align:center}
	</style>
</head>
<body>
	<h2>All Students List (Dynamic Columns by Session)</h2>
	<div class="toolbar">
		<span id="status" class="status"></span>
	</div>

	<div id="container" class="container">
		<!-- groups will be rendered here -->
	</div>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	  <script src="../login/auth-check.js"></script>

	<script>
		//Datalist (datalist.html) â†’ localStorage key: datalist_rows_v2
		
		// Supabase config (same project as other pages)
		const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
		const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
		const tableName = 'student_database';

		// Cache (1000000 minutes for faster perceived load, reduced from 30m for freshness)
		const CACHE_KEY = 'datalist_rows_v2';
		const CACHE_TTL_MS = 1000000*60*1000;

		const container = document.getElementById('container');
		const statusEl = document.getElementById('status');

		// Column spec from CSV
		let columnSpec = []; // [{field, label}]

		async function loadColumnSpec(){
			const res = await fetch('data_show_datalist.csv');
			const text = await res.text();
			const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
			const spec = [];
			for(const line of lines){
				if(line.toLowerCase().includes('colm name')) continue;
				const parts = line.split(' > ');
				if(parts.length >= 2){
					const field = parts[0].trim();
					const label = parts[1].trim();
					if(field) spec.push({ field, label });
				}
			}
			columnSpec = spec;
		}

		// Cache helpers
		function saveCache(rows){
			try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), rows})); }catch(e){}
		}
		function loadCache(){
			try{
				const raw = localStorage.getItem(CACHE_KEY);
				if(!raw) return null;
				const obj = JSON.parse(raw);
				if(!obj || !Array.isArray(obj.rows)) return null;
				return obj;
			}catch(e){ return null; }
		}

		async function fetchAll(){
			let all = [];
			let lastId = 0;
			let hasMore = true;
			// Use 1000 to align with PostgREST per-request cap
			const batchSize = 10000;
			let batchCount = 0;
			let prevLastId = null; // plateau guard
			const maxBatches = 10000; // generous safety cap
			
			while(hasMore && batchCount < maxBatches){
				batchCount++;
				statusEl.textContent = `Loading... (${all.length} records loaded, batch ${batchCount})`;
				
				// Select only needed columns to reduce payload
				const selectColsArr = (columnSpec && columnSpec.length > 0)
					? Array.from(new Set(columnSpec.map(c => c.field).concat([
						'iid',
						'class_2025','section_2025','roll_2025',
						'class_2026','section_2026','roll_2026',
						'session','status'
					])))
						.filter(Boolean)
						.map(c => String(c).replace(/["\s]+/g, '').trim())
					: null;
				const selectArg = selectColsArr ? selectColsArr.join(',') : '*';
				
				// Primary attempt
				let data, error;
				try{
					({ data, error } = await supabase
						.from(tableName)
						.select(selectArg)
						.gt('iid', lastId)
						.order('iid', { ascending: true })
						.limit(batchSize));
				}catch(e){ data = null; error = e; }
				
				// Fallback to '*' if needed
				if(error || !Array.isArray(data)){
					({ data, error } = await supabase
						.from(tableName)
						.select('*')
						.gt('iid', lastId)
						.order('iid', { ascending: true })
						.limit(batchSize));
				}
				
				if(error) throw error;
				
				if(!data || data.length === 0){
					hasMore = false;
					break;
				}
				
				// Use push instead of concat for better performance
				for(const row of data) all.push(row);
				lastId = data[data.length - 1].iid;
				// plateau guard
				if(prevLastId !== null && Number(lastId) === Number(prevLastId)){
					console.warn('Pagination stalled (iid not advancing). Stopping. lastId=', lastId);
					hasMore = false;
					break;
				}
				prevLastId = lastId;
			}
			return all;
		}

		function groupByClassSection(rows){
			// Exclude TC-status rows from display
			const filtered = rows.filter(r => !String(r.status||'').toUpperCase().includes('TC'));
			// Return all rows as a single group for unified table display
			const allRows = [...filtered].sort((a,b)=>{
				// Sort by class, section, roll, then iid
				const ca = Number(a.class_2025) || 0, cb = Number(b.class_2025) || 0;
				if(ca !== cb) return ca - cb;
				const secCmp = (a.section_2025 || '').localeCompare(b.section_2025 || '');
				if(secCmp !== 0) return secCmp;
				const ra = Number(a.roll_2025) || 0, rb = Number(b.roll_2025) || 0;
				if(ra !== rb) return ra - rb;
				const ia = Number(a.iid) || 0, ib = Number(b.iid) || 0;
				return ia - ib;
			});
			return [{ class_: 'All Classes', section: '', session: '', rows: allRows }];
		}

		function escapeHtml(s){
			if(s===null||s===undefined) return '';
			return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
		}

		function render(groups){
			container.innerHTML = '';
			let total = 0;
			// Use document fragment for better performance
			const fragment = document.createDocumentFragment();
			
			// Single table for all data
			const card = document.createElement('div');
			card.className = 'card';
			
			// Card header
			const header = document.createElement('div');
			header.className = 'card-header';
			const title = document.createElement('h3');
			title.className = 'card-title';
			const sampleRow = groups[0].rows[0];
			const sessionValue = sampleRow ? String(sampleRow.session || '').trim() : '';
			title.textContent = 'All Students';
			const badge = document.createElement('span');
			badge.className = 'badge';
			badge.textContent = `${groups[0].rows.length} students`;
			header.appendChild(title);
			header.appendChild(badge);
			
			// Card body with table wrapper
			const body = document.createElement('div');
			body.className = 'card-body';
			const tableWrapper = document.createElement('div');
			tableWrapper.className = 'table-wrapper';
			const table = document.createElement('table');
			
			// Table header
			const thead = document.createElement('thead');
			const htr = document.createElement('tr');
			const sl = document.createElement('th'); 
			sl.className='col-sl'; 
			sl.textContent = 'SL'; 
			htr.appendChild(sl);

			// Always show CSV columns; ensure 'iid' exists and insert active_* after it
			let hasIid = columnSpec.some(c => c.field === 'iid');
			// Build a working copy, injecting iid at start if missing
			const colsForHeader = hasIid ? [...columnSpec] : [{ field: 'iid', label: 'iid' }, ...columnSpec];
			for(const col of colsForHeader){
				const th = document.createElement('th');
				th.textContent = col.label || col.field;
				htr.appendChild(th);
					if(col.field === 'iid'){
					// Insert the three active columns right after iid
						const thCSY = document.createElement('th'); thCSY.textContent = 'class_section_year'; htr.appendChild(thCSY);
						const thAR = document.createElement('th'); thAR.textContent = 'active_roll'; htr.appendChild(thAR);
						const thAC = document.createElement('th'); thAC.textContent = 'active_class'; htr.appendChild(thAC);
						const thAS = document.createElement('th'); thAS.textContent = 'active_section'; htr.appendChild(thAS);
				}
			}
			
			thead.appendChild(htr);
			table.appendChild(thead);

			// Table body
			const tbody = document.createElement('tbody');
			groups[0].rows.forEach((row, idx) =>{
				const tr = document.createElement('tr');
				if(String(row.status||'').toUpperCase().includes('TC')) tr.className = 'status-tc';
				const sltd = document.createElement('td'); 
				sltd.className='col-sl'; 
				sltd.textContent = (idx+1); 
				tr.appendChild(sltd);

				// Helper to compute active values based on session thresholds
				const sNum = Number(row.session);
				let active_roll = '', active_class = '', active_section = '';
				if(Number.isFinite(sNum) && sNum === 2026){
					active_roll = row.roll_2026 ?? '';
					active_class = row.class_2026 ?? '';
					active_section = row.section_2026 ?? '';
				}else if(Number.isFinite(sNum) && sNum === 2025){
					active_roll = row.roll_2025 ?? '';
					active_class = row.class_2025 ?? '';
					active_section = row.section_2025 ?? '';
				}

				// Build cells from CSV spec, ensuring iid and inserting active_* right after it
				let hasIidRow = columnSpec.some(c => c.field === 'iid');
				const colsForRow = hasIidRow ? [...columnSpec] : [{ field: 'iid', label: 'iid' }, ...columnSpec];
				for(const col of colsForRow){
					const td = document.createElement('td');
					const v = row[col.field];
					if(col.field === 'iid'){
						const link = document.createElement('a');
						link.href = `detailsinfo.html?iid=${encodeURIComponent(v)}`;
						link.textContent = escapeHtml(v==null?'':String(v));
						link.style.color = '#0b74de';
						link.style.textDecoration = 'underline';
						td.appendChild(link);
						tr.appendChild(td);
						// Insert class_section_year and the three active columns right after iid
						let csY = '';
						const hasActiveRoll = !(active_roll === null || active_roll === undefined || (typeof active_roll === 'string' && active_roll.trim() === ''));
						if(hasActiveRoll){
							csY = [active_class ?? '', active_section ?? '', (row.session ?? '')]
								.map(x => String(x ?? ''))
								.join('-');
						}
						const tdCSY = document.createElement('td'); tdCSY.textContent = escapeHtml(csY); tr.appendChild(tdCSY);
						const tdAR = document.createElement('td'); tdAR.textContent = escapeHtml(active_roll==null?'':String(active_roll)); tr.appendChild(tdAR);
						const tdAC = document.createElement('td'); tdAC.textContent = escapeHtml(active_class==null?'':String(active_class)); tr.appendChild(tdAC);
						const tdAS = document.createElement('td'); tdAS.textContent = escapeHtml(active_section==null?'':String(active_section)); tr.appendChild(tdAS);
						continue; // iid already appended with active_*; skip generic append below
					}else{
						td.textContent = escapeHtml(v==null?'':String(v));
					}
					tr.appendChild(td);
				}
				
				tbody.appendChild(tr);
			});
			table.appendChild(tbody);
			tableWrapper.appendChild(table);
			body.appendChild(tableWrapper);
			card.appendChild(header);
			card.appendChild(body);
			fragment.appendChild(card);
			
			container.appendChild(fragment);
			statusEl.textContent = `Total Students: ${groups[0].rows.length} | Session sample: ${sessionValue || 'N/A'} | Extra: active_roll/active_class/active_section`;
		}

		async function loadAll(background=false){
			if(!background) statusEl.textContent = 'Loading...';
			try{
				if(columnSpec.length===0) await loadColumnSpec();
				const rows = await fetchAll();
				saveCache(rows);
				const groups = groupByClassSection(rows);
				render(groups);
			}catch(err){
				const msg = (err && err.message) ? err.message : String(err);
				statusEl.textContent = `Load error: ${msg}`;
				// Try cache fallback
				const cached = loadCache();
				if(cached && Array.isArray(cached.rows)){
					const groups = groupByClassSection(cached.rows);
					render(groups);
					const ageM = Math.floor((Date.now()-cached.ts)/60000);
					statusEl.textContent = `Total Students: ${cached.rows.length} (offline cache, ${ageM}m old)`;
				}
			}
		}

		// Initial: try fresh cache then revalidate
		(async function init(){
			try{ if(columnSpec.length===0) await loadColumnSpec(); }catch(e){}
			const cached = loadCache();
			if(cached && (Date.now()-cached.ts) < CACHE_TTL_MS){
				const groups = groupByClassSection(cached.rows);
				render(groups);
				const ageM = Math.floor((Date.now()-cached.ts)/60000);
				statusEl.textContent = `Groups: ${groups.length} | Total: ${cached.rows.length} (from cache, ${ageM}m old)`;
				setTimeout(()=> loadAll(true), 0);
			}else{
				loadAll(false);
			}
		})();
	</script>
</body>
</html>
