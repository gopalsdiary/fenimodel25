<!doctype html>
<html lang="bn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>ডাটা লিস্ট — 0newdatabase</title>
	<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
	<!-- Bangla font for better rendering -->
	<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
	<style>
		:root { color-scheme: light dark; }
		body { margin:0; font-family:'Noto Sans Bengali','Hind Siliguri', system-ui, Arial, sans-serif; background:#f6f7f9; color:#111; }
		header { position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:10; }
		.container { max-width:1100px; margin:0 auto; padding:1rem; }
		h1 { margin:.25rem 0; font-size:1.25rem; text-align:center; }
		.toolbar { display:flex; gap:.75rem; align-items:center; justify-content:center; flex-wrap:wrap; margin:.5rem 0 1rem; }
		input[type="search"]{ padding:.55rem .8rem; min-width:280px; border:1px solid #d1d5db; border-radius:10px; }
		select{ padding:.55rem .8rem; border:1px solid #d1d5db; border-radius:10px; background:#fff; }
		.muted { color:#6b7280; font-size:.85rem; }
		.group { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:1rem; margin:1rem 0; box-shadow:0 8px 24px rgba(0,0,0,.06); }
		.group h2 { margin:.1rem 0 .75rem; font-size:1.05rem; }
		/* Enhanced class title styling */
		.group h2 { text-align:center; font-size:1.365rem; font-weight:700; line-height:1.25; }
		.group h2 .count { display:block; font-size:.55em; font-weight:400; margin-top:.2rem; color:#555; }
		/* Colored class name bars */
		.group h2 { background:#eef2f7; padding:.55rem .85rem; border-radius:10px; position:relative; }
		.group[data-class="6"] h2 { background:linear-gradient(90deg,#2196F3,#64b5f6); color:#fff; }
		.group[data-class="7"] h2 { background:linear-gradient(90deg,#2e7d32,#66bb6a); color:#fff; }
		.group[data-class="8"] h2 { background:linear-gradient(90deg,#6a1b9a,#ab47bc); color:#fff; }
		.group[data-class="9"] h2 { background:linear-gradient(90deg,#ef6c00,#ffa726); color:#fff; }
		.group[data-class="10"] h2 { background:linear-gradient(90deg,#c2185b,#ec407a); color:#fff; }
		.group h2 .count { color:rgba(255,255,255,0.85); }
		@media (prefers-color-scheme: dark){
			.group h2 { background:#1d2840; }
			.group[data-class="6"] h2 { background:linear-gradient(90deg,#1565c0,#1e88e5); }
			.group[data-class="7"] h2 { background:linear-gradient(90deg,#1b5e20,#2e7d32); }
			.group[data-class="8"] h2 { background:linear-gradient(90deg,#4a148c,#6a1b9a); }
			.group[data-class="9"] h2 { background:linear-gradient(90deg,#e65100,#ef6c00); }
			.group[data-class="10"] h2 { background:linear-gradient(90deg,#880e4f,#ad1457); }
		}
		.table-wrap { overflow:auto; border-radius:10px; }
		table { border-collapse:collapse; width:100%; min-width:720px; }
		thead th { position:sticky; top:0; background:#f9fafb; border-bottom:1px solid #e5e7eb; text-align:left; padding:.6rem .7rem; font-size:.9rem; }
		tbody td { border-top:1px solid #f1f5f9; padding:.55rem .7rem; font-size:.92rem; }
		tbody tr:hover { background:#f9fafb; }

		/* Simple button */
		.btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .85rem;border:1px solid #d1d5db;border-radius:10px;background:#fff;color:#111;text-decoration:none;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.04)}
		.btn:hover{background:#f8fafc}
		.btn-primary{background:#0ea5e9;border-color:#0284c7;color:#fff}
		.btn-primary:hover{background:#0284c7}
		.status { font-size:.85rem; }
		.error { color:#b91c1c; }
		.ok { color:#16a34a; }
		details > summary { cursor:pointer; -webkit-user-select:none; user-select:none; }
		@media (prefers-color-scheme: dark){
			body { background:#0b1020; color:#e5e7eb; }
			header, .group { background:#111729; border-color:#263148; }
			thead th { background:#0f162a; border-bottom-color:#263148; }
			tbody td { border-top-color:#1d2845; }
			input[type="search"]{ background:#0f162a; color:#e5e7eb; border-color:#263148; }
			.muted { color:#9aa5b1; }
			.btn{background:#0f162a;color:#e5e7eb;border-color:#263148}
			.btn:hover{background:#0c1424}
			.btn-primary{background:#0ea5e9;border-color:#0284c7;color:#0b1020}
		}

		/* Summary table (class list like all_data_field.html) */
		.summary-wrap{max-width:1100px;margin:.25rem auto 0;overflow:auto}
		.summary-table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e8eef8}
		.summary-table thead th{background:linear-gradient(180deg,#f8fafc,#f1f5f9);text-align:left;padding:.6rem .7rem;border-bottom:2px solid #e6eef7}
		.summary-table thead th.sortable{cursor:pointer;user-select:none}
		.summary-table thead th .arrow{margin-left:6px;color:#64748b;font-size:.85em}
		.summary-table td{padding:.55rem .7rem;border-bottom:1px solid #f1f5f9}
		.summary-table tfoot td{padding:.6rem .7rem;font-weight:600;background:#f8fafc;border-top:2px solid #e6eef7}
		.summary-table tr:hover{background:#fbfdff}
		.summary-table a{color:#0f172a;text-decoration:none}
		.summary-table a:hover{text-decoration:underline}
	</style>
		<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
		<!-- Chart.js for the column graph -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script>
		// Parse sheet list from sheetidname.text
		async function loadSheetList(){
			const res = await fetch('sheetidname.text', {cache:'no-store'});
			if(!res.ok) throw new Error('Failed to load sheetidname.text');
			const txt = await res.text();
			const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
			const pairs=[]; let cols=null; let curId=null;
			const idRe = /^let\s+sheetId\s*=\s*['"]([^'"]+)['"];?$/i;
			const nameRe = /^let\s+sheetName\s*=\s*['"]([^'"]+)['"];?$/i;
			const homeColsRe = /^(?:let|var|const)?\s*homeShowColumns\s*=\s*\[([^\]]*)\];?$/i;
			for(const line of lines){
				const cm = homeColsRe.exec(line);
				if(cm){
					const nums = cm[1].split(',').map(s=>parseInt(s,10)).filter(n=>Number.isFinite(n));
					if(nums.length) cols = nums; continue;
				}
				const im = idRe.exec(line);
				if(im){ curId = im[1]; continue; }
				const nm = nameRe.exec(line);
				if(nm && curId){ pairs.push({ id:curId, name:nm[1] }); curId=null; continue; }
			}
			return { pairs, cols };
		}

			function csvUrl(id, sheet){
			// Using gviz CSV for predictable CORS and header row
			return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(id)}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;
		}

			function parseSheetMeta(name){
				// Expect patterns like "6-shapla", "7_golap", "8 morning"
				const m = String(name||'').trim().match(/^(\d{1,2})\s*[-_\s]\s*([A-Za-zঅ-য়]+)\s*$/i);
				if(!m) return { cls:'', shift:'' };
				const cls = m[1];
				const rawShift = m[2];
				const shift = rawShift;
				return { cls, shift };
			}

		function normHeader(s){ return String(s||'').toLowerCase().replace(/[\s_\-]+/g,'').trim(); }
		function findIidKey(fields){
			// Prefer 'iid', but accept common variants
			const order = ['iid','id','studentid','sid'];
			const map = new Map(fields.map(f=>[normHeader(f), f]));
			for(const key of order){ if(map.has(key)) return map.get(key); }
			return null;
		}

		// --- Summary helpers (same behavior as all_data_field.html) ---
		function slugify(s){ return 's'+String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
		function scrollToSection(targetId){
			const el=document.getElementById(targetId); if(!el) return;
			const header=document.querySelector('header');
			const offset=(header? header.offsetHeight:0)+8;
			const top=el.getBoundingClientRect().top+window.scrollY-offset;
			window.scrollTo({ top, behavior:'smooth' });
		}
		const summaryData=[]; let summarySort={ key:'name', dir:'asc' };
		function addSummaryRow({ name, total, tc, existing, targetId }){ summaryData.push({ name, total, tc, existing, targetId }); }
		function renderSummaryTableInto(host){
			if(!host) return; const table=document.createElement('table'); table.className='summary-table';
			const thead=document.createElement('thead'); const trh=document.createElement('tr');
			const cols=[
				{ key:'name', label:'Class name' },
				{ key:'total', label:'Total student' },
				{ key:'tc', label:'TC count' },
				{ key:'existing', label:'Existing Student count' },
			];
			cols.forEach(col=>{ const th=document.createElement('th'); th.textContent=col.label; th.classList.add('sortable');
				if(summarySort.key===col.key){ const arrow=document.createElement('span'); arrow.className='arrow'; arrow.textContent=summarySort.dir==='asc'?'▲':'▼'; th.appendChild(arrow); }
				th.addEventListener('click', ()=>{ if(summarySort.key===col.key){ summarySort.dir = summarySort.dir==='asc'?'desc':'asc'; } else { summarySort.key=col.key; summarySort.dir='asc'; } renderSummaryTable(); });
				trh.appendChild(th);
			}); thead.appendChild(trh); table.appendChild(thead);
			const tbody=document.createElement('tbody');
			const data=[...summaryData].sort((a,b)=>{ const k=summarySort.key; const dir=summarySort.dir==='asc'?1:-1; const av=a[k], bv=b[k]; if(typeof av==='number'&&typeof bv==='number') return (av-bv)*dir; return String(av).localeCompare(String(bv))*dir; });
			data.forEach(row=>{ const tr=document.createElement('tr'); const link=document.createElement('a'); link.href='#'; link.textContent=row.name; link.addEventListener('click', e=>{ e.preventDefault(); scrollToSection(row.targetId); });
				const td0=document.createElement('td'); td0.appendChild(link); tr.appendChild(td0);
				['total','tc','existing'].forEach(k=>{ const td=document.createElement('td'); td.textContent=row[k]; tr.appendChild(td); });
				tbody.appendChild(tr);
			}); table.appendChild(tbody);
			const totals=data.reduce((acc,r)=>({ total:acc.total+(+r.total||0), tc:acc.tc+(+r.tc||0), existing:acc.existing+(+r.existing||0) }), { total:0, tc:0, existing:0 });
			const tfoot=document.createElement('tfoot'); const trf=document.createElement('tr');
			['Total', totals.total, totals.tc, totals.existing].forEach((v,i)=>{ const td=document.createElement('td'); td.textContent=v; trf.appendChild(td); });
			tfoot.appendChild(trf); table.appendChild(tfoot);
			host.innerHTML=''; host.appendChild(table);
		}
		function renderSummaryTable(){
			renderSummaryTableInto(document.getElementById('summaryHost'));
			renderSummaryTableInto(document.getElementById('summaryBottomHost'));
		}

		// --- Column graph of total students per sheet/group ---
		function renderSummaryChart(){
			const canvas = document.getElementById('summaryChart');
			if(!canvas || typeof Chart === 'undefined') return;
			const labels = summaryData.map(r => r.name);
			const totals = summaryData.map(r => Number(r.total)||0);
			// Destroy previous chart if any
			if(window.__summaryChart){ try{ window.__summaryChart.destroy(); }catch(_){} }
			// Give the canvas a reasonable height for readability
			canvas.style.height = '320px';
			const ctx = canvas.getContext('2d');
			window.__summaryChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels,
					datasets: [{
						label: 'Total students',
						data: totals,
						backgroundColor: 'rgba(14, 165, 233, 0.55)',
						borderColor: 'rgba(2, 132, 199, 1)',
						borderWidth: 1,
						borderRadius: 6,
						maxBarThickness: 48
					}]
				},
				options: {
					maintainAspectRatio: false,
					plugins: {
						legend: { display: false },
						title: { display: true, text: 'শিক্ষার্থীদের যোগফল (সেকশনভিত্তিক)' },
						tooltip: { callbacks: { label: (ctx)=> `Total: ${ctx.formattedValue}` } }
					},
					scales: {
						y: { beginAtZero: true, title: { display: true, text: 'Total' } },
						x: { ticks: { maxRotation: 45, minRotation: 0 } }
					}
				}
			});
		}

		function selectColumns(fields, cols){
			if(!Array.isArray(cols) || cols.length===0) return fields.slice(0, Math.min(3, fields.length));
			// Treat as 1-based indices
			const out=[]; cols.forEach(n=>{ const idx=n-1; if(idx>=0 && idx<fields.length) out.push(fields[idx]); });
			return out.length? out : fields.slice(0, Math.min(3, fields.length));
		}

				function renderGroup(container, title, fields, rows, meta, src){
				const group = document.createElement('section'); group.className='group';
				if(meta){ if(meta.cls) group.dataset.class = meta.cls; if(meta.shift) group.dataset.shift = meta.shift.toLowerCase(); }
				const h = document.createElement('h2'); h.innerHTML = `${title} <span class="count">(Total: ${rows.length})</span>`; group.appendChild(h);
			const wrap = document.createElement('div'); wrap.className='table-wrap'; group.appendChild(wrap);
			const table = document.createElement('table'); wrap.appendChild(table);
			const thead = document.createElement('thead'); const trh=document.createElement('tr');
			fields.forEach(f=>{ const th=document.createElement('th'); th.textContent=String(f||''); trh.appendChild(th); });
			thead.appendChild(trh); table.appendChild(thead);
			const tbody = document.createElement('tbody');
					rows.forEach((r, idx)=>{
						const tr=document.createElement('tr');
						fields.forEach((f, fi)=>{ 
							const td=document.createElement('td'); 
							const val = r[f] ?? '';
							if(fi === 0 && src && src.id && src.name){
								const a=document.createElement('a');
								a.textContent = val || '(open)';
								// Prefer linking by a unique IID if present; fallback to row index
								let href = `detailsinfo.html?id=${encodeURIComponent(src.id)}&sheet=${encodeURIComponent(src.name)}`;
								try{
									const allFields = Object.keys(r||{});
									const iidKey = findIidKey(allFields);
									const iidVal = iidKey ? (r[iidKey]) : '';
									if(iidVal!=null && String(iidVal).trim()!== ''){
										href += `&iid=${encodeURIComponent(String(iidVal))}`;
									}else{
										href += `&r=${idx}`;
									}
								}catch(_){ href += `&r=${idx}`; }
								a.href = href;
								a.className = 'link';
								td.appendChild(a);
							} else {
								td.textContent = val;
							}
							tr.appendChild(td); 
						});
				tbody.appendChild(tr);
			});
			table.appendChild(tbody);
			container.appendChild(group);
		}

			function filterAll(q){
			const query = q.toLowerCase();
			document.querySelectorAll('.group tbody tr').forEach(tr=>{
				const show = !query || tr.textContent.toLowerCase().includes(query);
				tr.style.display = show ? '' : 'none';
			});
		}

			function populateFilters(classes, shifts){
				const clsSel = document.getElementById('classFilter');
				const shSel = document.getElementById('shiftFilter');
				// Reset
				clsSel.innerHTML = '';
				shSel.innerHTML = '';
				const mkOpt = (v,l)=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; return o; };
				clsSel.appendChild(mkOpt('', 'Class: All'));
				shSel.appendChild(mkOpt('', 'Shift: All'));
				// Sort classes numerically if possible
				const clsList = Array.from(classes);
				clsList.sort((a,b)=>{ const na=+a, nb=+b; if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a).localeCompare(String(b)); });
				clsList.forEach(c=>clsSel.appendChild(mkOpt(c, c)));
				// Sort shifts alpha (case-insensitive)
				const shList = Array.from(shifts);
				shList.sort((a,b)=>String(a).toLowerCase().localeCompare(String(b).toLowerCase()));
				shList.forEach(s=>{ const label = s.charAt(0).toUpperCase()+s.slice(1); shSel.appendChild(mkOpt(s.toLowerCase(), label)); });
			}

			function applyGroupFilters(){
				const clsVal = (document.getElementById('classFilter').value||'').trim();
				const shVal = (document.getElementById('shiftFilter').value||'').trim();
				document.querySelectorAll('.group').forEach(sec=>{
					// Only filter sections that are real groups (have table)
					const secCls = (sec.dataset.class||'');
					const secShift = (sec.dataset.shift||'');
					// If section has no meta (e.g., an error details), hide only when a filter is selected
					let visible = true;
					if(clsVal){ visible = visible && (secCls===clsVal); }
					if(shVal){ visible = visible && (secShift===shVal); }
					sec.style.display = visible ? '' : 'none';
				});
			}

		async function init(){
			const status = document.getElementById('status');
			try{
				status.textContent = 'Loading sheet list…';
						const { pairs, cols } = await loadSheetList();
				if(!pairs.length){ status.textContent='No sheets defined'; status.classList.add('error'); return; }
						status.textContent = `Found ${pairs.length} sheets. Fetching…`;
				const host = document.getElementById('groups');
						let ok=0, fail=0;
						const classSet = new Set();
						const shiftSet = new Set();
						await Promise.all(pairs.map(async ({id,name})=>{
					try{
						const url = csvUrl(id, name);
						const results = await new Promise((resolve,reject)=>{
							Papa.parse(url, { download:true, header:true, skipEmptyLines:true, complete:r=>resolve(r), error:e=>reject(e) });
						});
						const allRows = (results && results.data) ? results.data : [];
						const fields = (results && results.meta && results.meta.fields) ? results.meta.fields : Object.keys(allRows[0]||{});
						const useFields = selectColumns(fields, cols);
								const meta = parseSheetMeta(name);
								if(meta.cls) classSet.add(meta.cls);
								if(meta.shift) shiftSet.add(meta.shift.toLowerCase());
								// set an id for scroll target
								const targetId = slugify(name);
								// compute TC counts and existing count
								const tcFieldIndex = fields.findIndex(f => String(f||'').trim().toLowerCase() === 'tc');
								let tcCount = 0; if(tcFieldIndex>=0){ const key=fields[tcFieldIndex]; tcCount = allRows.reduce((n,r)=>{ const v=(r&&Object.prototype.hasOwnProperty.call(r,key))? r[key]:''; return n + (String(v||'').trim().toLowerCase()==='tc'?1:0); },0); }
								const effective = allRows.length - tcCount;
								// add to summary list
								addSummaryRow({ name, total: allRows.length, tc: tcCount, existing: effective, targetId });
								renderGroup(host, `${name}`, useFields, allRows, Object.assign({}, meta), { id, name });
								// assign id to the last section created
								const secs = host.querySelectorAll('.group'); if(secs.length){ secs[secs.length-1].id = targetId; }
						ok++;
					}catch(e){
						console.error('Fetch error for', name, e);
						fail++;
								const meta = parseSheetMeta(name);
								const d=document.createElement('details'); d.className='group';
								if(meta.cls) d.dataset.class = meta.cls;
								if(meta.shift) d.dataset.shift = meta.shift.toLowerCase();
						const s=document.createElement('summary'); s.innerHTML = `<span class="error">Failed</span> — ${name}`; d.appendChild(s);
						const pre=document.createElement('pre'); pre.textContent=String(e && e.message || e); pre.style.padding='.75rem'; d.appendChild(pre);
						document.getElementById('groups').appendChild(d);
					}
					status.textContent = `Loaded ${ok}/${pairs.length}` + (fail? `, failed ${fail}`:'');
				}));
						// Populate filters after scanned all meta
						populateFilters(classSet, shiftSet);
						applyGroupFilters();
						renderSummaryTable();
						renderSummaryChart();
				status.classList.add('ok');
			}catch(err){
				console.error(err);
				status.textContent = 'Init failed';
				status.classList.add('error');
			}
		}

		window.addEventListener('DOMContentLoaded', ()=>{
			init();
			const s=document.getElementById('search');
					s.addEventListener('input', ()=>filterAll(s.value));
					document.getElementById('classFilter').addEventListener('change', applyGroupFilters);
					document.getElementById('shiftFilter').addEventListener('change', applyGroupFilters);
		});
	</script>
</head>
<body>
	<header>
		<div class="container">
			<h1>ডাটা লিস্ট</h1>
						<h1>শিক্ষার্থী খুজে পেতে Search করুণ</h1>

					<div class="toolbar">
						<a class="btn btn-primary" href="all_data_field.html" target="_blank" rel="noopener">All data table</a>
						<select id="classFilter" aria-label="Class filter"></select>
						<select id="shiftFilter" aria-label="Shift filter"></select>
						<input id="search" type="search" placeholder="ফিল্টার… (Filter all)" aria-label="Filter" />
				<span id="status" class="muted status"></span>
			</div>
		</div>
	</header>
	<!-- Column graph: Total students per sheet/group -->
	<div class="summary-wrap" style="background:#fff;border:1px solid #e8eef8;border-radius:10px;padding:12px 12px 4px;margin-top:.5rem;max-width:1100px;">
		<canvas id="summaryChart" aria-label="শিক্ষার্থীদের যোগফল চার্ট" role="img"></canvas>
	</div>
	<div id="summaryHost" class="summary-wrap" aria-label="Summary"></div>
	<main>
		<div id="groups" class="container"></div>
		<div id="summaryBottomHost" class="summary-wrap" aria-label="Summary (bottom)"></div>
	</main>
</body>
</html>
