<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Passwords - Selected Columns</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#f7fafc;color:#0f172a}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#eef2f7}
    .col-sl{width:56px;text-align:center}
    a.link{color:#0b74de;text-decoration:underline}
  </style>
</head>
<body>
  <h2>Students (selected columns)</h2>
  <div id="controls" style="margin-bottom:12px;display:flex;gap:12px;align-items:center">
    <button id="copy-import" style="padding:6px 10px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;cursor:pointer">Copy IMPORTHTML</button>
    <span style="color:#374151;font-size:13px">শুধু পেজটি পাব্লিক হলে গুগল শীটে এই পেজের টেবিল ইম্পোর্ট হবে — নিচের বোতন ক্লিক করে IMPORTHTML ফর্মুলা ক্লিপবোর্ডে কপি করুন।</span>
  </div>
  <div id="status"></div>
  <div id="table-wrap"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase config - match other pages
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const tableName = 'student_database';

    const statusEl = document.getElementById('status');
    const wrap = document.getElementById('table-wrap');

    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    async function fetchRows(){
      statusEl.textContent = 'Loading...';
      try{
        const { data, error } = await supabase
          .from(tableName)
          .select('iid,father_number,session,class_2025,section_2025,roll_2025,class_2026,section_2026,roll_2026,status')
          .order('iid', { ascending:true })
          .limit(10000);
        if(error) throw error;
        return Array.isArray(data) ? data : [];
      }catch(err){ statusEl.textContent = 'Load error: '+(err.message||err); return []; }
    }

    function computeActive(row){
      const sNum = Number(row.session);
      let active_roll = '', active_class = '', active_section = '';
      if(Number.isFinite(sNum) && sNum === 2026){
        active_roll = row.roll_2026 ?? '';
        active_class = row.class_2026 ?? '';
        active_section = row.section_2026 ?? '';
      }else if(Number.isFinite(sNum) && sNum === 2025){
        active_roll = row.roll_2025 ?? '';
        active_class = row.class_2025 ?? '';
        active_section = row.section_2025 ?? '';
      }
      return { active_roll, active_class, active_section };
    }

    function render(rows){
      wrap.innerHTML = '';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const htr = document.createElement('tr');
  ['SL','iid','father_number','class_section_year','active_roll','active_class','active_section','session'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; if(h==='SL') th.className='col-sl'; htr.appendChild(th); });
      thead.appendChild(htr); table.appendChild(thead);

      const tbody = document.createElement('tbody');
      let idx=0;
      for(const row of rows){
        if(String(row.status||'').toUpperCase().includes('TC')) continue; // skip TC
        idx++;
        const tr = document.createElement('tr');
        const tdSL = document.createElement('td'); tdSL.className='col-sl'; tdSL.textContent = idx; tr.appendChild(tdSL);

        // iid
        const tdIid = document.createElement('td');
        const a = document.createElement('a'); a.href = `detailsinfo.html?iid=${encodeURIComponent(row.iid)}`; a.className='link'; a.textContent = escapeHtml(row.iid==null?'':String(row.iid));
        tdIid.appendChild(a); tr.appendChild(tdIid);

  // father number
  const tdFather = document.createElement('td'); tdFather.textContent = escapeHtml(row.father_number==null?'':String(row.father_number)); tr.appendChild(tdFather);

  // active values
        const { active_roll, active_class, active_section } = computeActive(row);
        const hasActive = !(active_roll==='' && active_class==='' && active_section==='');
        const csY = hasActive ? [active_class, active_section, row.session||''].join('-') : '';
        const tdCSY = document.createElement('td'); tdCSY.textContent = escapeHtml(csY); tr.appendChild(tdCSY);

        const tdAR = document.createElement('td'); tdAR.textContent = escapeHtml(active_roll||''); tr.appendChild(tdAR);
        const tdAC = document.createElement('td'); tdAC.textContent = escapeHtml(active_class||''); tr.appendChild(tdAC);
        const tdAS = document.createElement('td'); tdAS.textContent = escapeHtml(active_section||''); tr.appendChild(tdAS);

        const tdSession = document.createElement('td'); tdSession.textContent = escapeHtml(row.session==null?'':String(row.session)); tr.appendChild(tdSession);

        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      wrap.appendChild(table);
      statusEl.textContent = `Displayed ${idx} rows`;
    }

    (async function init(){
      const rows = await fetchRows();
      render(rows);
      // attach copy-import behaviour
      const btn = document.getElementById('copy-import');
      btn.addEventListener('click', ()=>{
        const url = window.location.href.split('#')[0];
        const formula = `=IMPORTHTML("${url}","table",1)`;
        navigator.clipboard.writeText(formula).then(()=>{
          btn.textContent = 'Copied ✓';
          setTimeout(()=> btn.textContent = 'Copy IMPORTHTML', 2000);
        }).catch(()=>{
          // fallback: show prompt
          window.prompt('Copy this formula:', formula);
        });
      });
    })();
  </script>
</body>
</html>
