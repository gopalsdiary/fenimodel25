<!doctype html>
<html lang="bn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Student Count Summary</title>
	<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
	<style>
		:root{ color-scheme: light dark; }
		body{ margin:0; font-family:'Kalpurush','Noto Sans Bengali','Hind Siliguri', system-ui, Arial, sans-serif; background:#f6f7f9; color:#0f172a; }
		header{ position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:5; }
		.container{ max-width:1100px; margin:0 auto; padding:1rem; }
		h1{ margin:.25rem 0 .5rem; font-size:1.35rem; text-align:center; }
		.muted{ color:#6b7280; font-size:.9rem; }
		.table-wrap{ max-width:1100px; margin:1rem auto; overflow:auto; border-radius:10px; }
		table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid #e5e7eb; min-width:700px; }
	thead th{ background:linear-gradient(90deg,#e3f2fd,#e8f5e9,#fff8e1,#f3e5f5,#e3f2fd); background-size:200% 100%; animation:bg-pan 12s ease-in-out infinite; text-align:left; padding:.65rem .75rem; border-bottom:2px solid #e5e7eb; color:#0f172a; }
	@keyframes bg-pan{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
	tbody td{ padding:.6rem .75rem; border-top:1px solid #f1f5f9; transition:background .25s ease, color .25s ease; }
		tfoot td{ padding:.7rem .75rem; font-weight:700; background:#f8fafc; border-top:2px solid #e5e7eb; }
		/* Light zebra striping */
		tbody tr:nth-child(odd) td{ background:#ffffff; }
		tbody tr:nth-child(even) td{ background:#fffef7; }
	/* Subtle hover */
	tbody tr:hover td{ background:#eaf6ff; }
	/* Row enter animation */
	@keyframes rowIn{ from{ opacity:0; transform:translateY(6px);} to{ opacity:1; transform:translateY(0);} }
	tbody tr.row-anim{ animation:rowIn .5s ease both; }
		/* First column accent */
		tbody td:first-child{ font-weight:600; color:#0f172a; border-left:4px solid #93c5fd; background-image:linear-gradient(90deg,rgba(147,197,253,.15),transparent 60%); }
		/* Rotate accent colors for a light colorful feel */
		tbody tr:nth-child(2) td:first-child{ border-left-color:#a7f3d0; background-image:linear-gradient(90deg,rgba(167,243,208,.18),transparent 60%); }
		tbody tr:nth-child(3) td:first-child{ border-left-color:#fde68a; background-image:linear-gradient(90deg,rgba(253,230,138,.22),transparent 60%); }
		tbody tr:nth-child(4) td:first-child{ border-left-color:#fbcfe8; background-image:linear-gradient(90deg,rgba(251,207,232,.20),transparent 60%); }
		tbody tr:nth-child(5) td:first-child{ border-left-color:#c7d2fe; background-image:linear-gradient(90deg,rgba(199,210,254,.18),transparent 60%); }
		tbody tr:nth-child(6) td:first-child{ border-left-color:#bbf7d0; background-image:linear-gradient(90deg,rgba(187,247,208,.18),transparent 60%); }
		tbody tr:nth-child(7) td:first-child{ border-left-color:#fecaca; background-image:linear-gradient(90deg,rgba(254,202,202,.18),transparent 60%); }
		tbody tr:nth-child(8) td:first-child{ border-left-color:#bae6fd; background-image:linear-gradient(90deg,rgba(186,230,253,.18),transparent 60%); }
		tbody tr:nth-child(9) td:first-child{ border-left-color:#ddd6fe; background-image:linear-gradient(90deg,rgba(221,214,254,.18),transparent 60%); }
		tbody tr:nth-child(10) td:first-child{ border-left-color:#fcd34d; background-image:linear-gradient(90deg,rgba(252,211,77,.18),transparent 60%); }
		a.link{ color:#0ea5e9; text-decoration:none; font-weight:600; }
		a.link:hover{ text-decoration:underline; }
		.toolbar{ display:flex; gap:.6rem; justify-content:center; align-items:center; flex-wrap:wrap; }
		.btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .85rem;border:1px solid #d1d5db;border-radius:10px;background:#fff;color:#111;text-decoration:none;font-weight:600}
		.btn:hover{background:#f8fafc}
		@media (prefers-color-scheme: dark){
			body{ background:#0b1020; color:#e5e7eb; }
			header{ background:#111729; border-color:#263148; }
			table{ background:#111729; border-color:#263148; }
			thead th{ background:linear-gradient(90deg,#0f162a,#0b1426,#121a33,#0f162a); background-size:200% 100%; animation:bg-pan 12s ease-in-out infinite; border-bottom-color:#263148; }
			tbody td{ border-top-color:#1d2845; }
			tbody tr:nth-child(odd) td{ background:#111729; }
			tbody tr:nth-child(even) td{ background:#0f162a; }
			tbody tr:hover td{ background:#0c1424; }
			tbody td:first-child{ color:#e5e7eb; }
			tfoot td{ background:#0f162a; border-top-color:#263148; }
			.btn{ background:#0f162a; border-color:#263148; color:#e5e7eb; }
			.btn:hover{ background:#0c1424; }
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<!-- Supabase for loading the same data as datalist.html -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
		// Build a colorful palette for the chart bars
		function makePalette(n){
			const base = [
				[14,165,233], [34,197,94], [234,179,8], [244,114,182], [99,102,241],
				[45,212,191], [251,146,60], [168,85,247], [59,130,246], [239,68,68]
			];
			const fills=[], borders=[], hovers=[];
			for(let i=0;i<n;i++){
				const [r,g,b] = base[i % base.length];
				fills.push(`rgba(${r},${g},${b},0.65)`);
				borders.push(`rgba(${r},${g},${b},1)`);
				hovers.push(`rgba(${r},${g},${b},0.85)`);
			}
			return { fills, borders, hovers };
		}
		function slugify(s){ return 's'+String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }

		// --- Supabase config (same as other pages) ---
		const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
		const supabase = (typeof window !== 'undefined' && window.supabase) ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;
		const tableName = 'student_database';

		// Fetch all rows with pagination (1k per batch) similar to datalist.html
		async function fetchAllFromSupabase(){
			if(!supabase) throw new Error('Supabase not available');
			let all=[]; let lastId=0; let batch=0; const batchSize=1000; let prevLastId=null;
			while(true){
				batch++;
				// Minimal columns for counting and grouping
				const cols = ['iid','class_2025','section_2025','roll_2025','status','religion','session'];
				let { data, error } = await supabase
					.from(tableName)
					.select(cols.join(','))
					.gt('iid', lastId)
					.order('iid', { ascending:true })
					.limit(batchSize);
				if(error) throw error;
				if(!data || data.length===0) break;
				for(const r of data) all.push(r);
				lastId = data[data.length-1].iid;
				if(prevLastId!==null && Number(lastId)===Number(prevLastId)) break; // plateau guard
				prevLastId = lastId;
			}
			return all;
		}

		function aggregateCounts(rows){
			// Group by class_2025 + section_2025 + session
			const map = new Map();
			for(const r of rows){
				const c = r.class_2025==null?'':String(r.class_2025);
				const s = r.section_2025==null?'':String(r.section_2025);
				const sess = r.session==null?'':String(r.session);
				const key = `${c}__${s}__${sess}`;
				if(!map.has(key)) map.set(key,{ class_:c, section:s, session:sess, total:0, tc:0, hindu:0, islam:0 });
				const g = map.get(key);
				g.total += 1;
				const statusStr = String(r.status||'').trim().toUpperCase();
				const isTC = statusStr.includes('TC');
				if(isTC) g.tc += 1;
				// Religion counts should EXCLUDE TC students
				if(!isTC){
					const relRaw = String(r.religion||'').trim();
					const relL = relRaw.toLowerCase();
					if(/^\s*hindu\b/i.test(relRaw) || /হিন্দু/i.test(relRaw) || /হিন্দু/i.test(relL)) g.hindu += 1;
					else if(/^\s*islam\b/i.test(relRaw) || /ইসলাম/i.test(relRaw) || /ইসলাম/i.test(relL)) g.islam += 1;
				}
			}
			// To array with display names
			const arr = Array.from(map.values()).map(g=>{
				const displayName = `Class : ${g.class_}-${g.section}-${g.session||'Session'}`;
				return {
					name: displayName,
					originalName: `${g.class_}_${g.section}`,
					session: g.session || '',
					total: g.total,
					tc: g.tc,
					existing: g.total - g.tc,
					hindu: g.hindu,
					islam: g.islam,
					targetId: slugify(displayName)
				};
			});
			// sort by class then section
			arr.sort((a,b)=>{
				const ax = parseInt(String(a.originalName).match(/^\s*(\d{1,2})/)?.[1]||'999',10);
				const bx = parseInt(String(b.originalName).match(/^\s*(\d{1,2})/)?.[1]||'999',10);
				if(Number.isFinite(ax)&&Number.isFinite(bx) && ax!==bx) return ax-bx;
				return String(a.originalName).localeCompare(String(b.originalName));
			});
			return arr;
		}
		async function loadSheetPairs(){
			const res = await fetch('0newdatabase/sheetidname.text', { cache:'no-store' });
			if(!res.ok) throw new Error('Failed to load sheetidname.text');
			const txt = await res.text();
			const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
			const pairs=[]; let curId=null;
			const idRe = /^let\s+sheetId\s*=\s*['"]([^'"]+)['"];?$/i;
			const nameRe = /^let\s+sheetName\s*=\s*['"]([^'"]+)['"];?$/i;
			for(const line of lines){
				const im = idRe.exec(line); if(im){ curId = im[1]; continue; }
				const nm = nameRe.exec(line); if(nm && curId){ pairs.push({ id:curId, name:nm[1] }); curId=null; continue; }
			}
			return pairs;
		}
		
		
		async function fetchCounts({id,name}){
						try{
							const url = csvUrl(id,name);
							const results = await new Promise((resolve,reject)=>{
								Papa.parse(url,{
									download:true,
									header:true,
									skipEmptyLines:'greedy',
									dynamicTyping:false,
									complete:r=>resolve(r),
									error:e=>reject(e)
								});
							});
							const rows = (results && results.data) ? results.data : [];
							const fields = (results && results.meta && results.meta.fields) ? results.meta.fields : Object.keys(rows[0]||{});
							// TC detection (same as before)
							let tcIdx = fields.findIndex(f => String(f||'').trim().toLowerCase()==='tc');
							let tcCount = 0;
							if(tcIdx>=0){ const key = fields[tcIdx]; tcCount = rows.reduce((n,r)=> n + (String(r[key]||'').trim().toLowerCase()==='tc'?1:0), 0); }

							// Religion field detection: look for field names containing 'relig' or common misspelling 'religon'
							const religFieldName = fields.find(f=> /relig/i.test(String(f||''))) || fields.find(f=> /religon/i.test(String(f||'')));
							// If not found among fields, try keys of first row (robustness)
							let religKey = religFieldName;
							if(!religKey && rows[0]){
								religKey = Object.keys(rows[0]).find(k=> /relig/i.test(String(k||'')) || /religon/i.test(String(k||'')));
							}

							// Count hindu and islam (case-insensitive, allow Bangla words too)
							const hinduMatches = [/^\s*hindu\b/i, /হিন্দু/i];
							const islamMatches = [/^\s*islam\b/i, /ইসলাম/i];
							let hinduCount = 0, islamCount = 0;
							if(religKey){
								for(const r of rows){
									const raw = String(r[religKey]||'').trim();
									const v = raw.toLowerCase();
									if(hinduMatches.some(rx=> rx.test(raw) || rx.test(v))) hinduCount++;
									else if(islamMatches.some(rx=> rx.test(raw) || rx.test(v))) islamCount++;
								}
							}

							// Smart formatting: Convert "6_SHAPLA" to "Class : 6-SHAPLA-2025"
							const smartName = parseSmartClassName(name);
							return { name: smartName, originalName: name, total: rows.length, tc: tcCount, existing: rows.length - tcCount, hindu: hinduCount, islam: islamCount, targetId: slugify(smartName) };
						}catch(err){
							const smartName = parseSmartClassName(name);
							return { name: smartName, originalName: name, total: 0, tc: 0, existing: 0, hindu:0, islam:0, targetId: slugify(smartName), error: String(err && err.message || err) };
						}
					}
		
		// Smart class name parser: "6_SHAPLA" -> "Class : 6-SHAPLA-2025"
		function parseSmartClassName(sheetName) {
			const currentYear = new Date().getFullYear(); // Get current year (2025)
			const parts = sheetName.split('_');
			if (parts.length >= 2) {
				const classNum = parts[0];
				const section = parts[1];
				return `Class : ${classNum}-${section}-${currentYear}`;
			}
			// Fallback for unexpected format
			return `Class : ${sheetName}-${currentYear}`;
		}
		function renderTable(rows){
			const host = document.getElementById('tableHost');
			const status = document.getElementById('status');
			const table = document.createElement('table');
			const thead = document.createElement('thead'); const trh = document.createElement('tr');
			['Class name','Total student','TC count','Existing Student count','HINDU','ISLAM'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
			thead.appendChild(trh); table.appendChild(thead);
			const tbody = document.createElement('tbody');
			(rows||[]).forEach((r, idx)=>{
				const tr=document.createElement('tr');
				tr.classList.add('row-anim');
				tr.style.animationDelay = (idx*45)+'ms';
				const td0=document.createElement('td');
				const a=document.createElement('a'); a.href=`0newdatabase/datalist.html#${r.targetId}`; a.target='_blank'; a.rel='noopener'; a.className='link'; a.textContent=r.name; td0.appendChild(a); tr.appendChild(td0);
				;['total','tc','existing'].forEach(k=>{ const td=document.createElement('td'); const v = Number.isFinite(Number(r[k])) ? Number(r[k]) : 0; td.textContent=v; tr.appendChild(td); });
				// Hindu / Islam columns (fall back to 0 if undefined)
				const tdH = document.createElement('td'); tdH.textContent = (Number.isFinite(Number(r.hindu))?r.hindu:0); tr.appendChild(tdH);
				const tdI = document.createElement('td'); tdI.textContent = (Number.isFinite(Number(r.islam))?r.islam:0); tr.appendChild(tdI);
				tbody.appendChild(tr);
			});
			table.appendChild(tbody);
			const totals = rows.reduce((acc,r)=>({ total:acc.total+(+r.total||0), tc:acc.tc+(+r.tc||0), existing:acc.existing+(+r.existing||0), hindu:acc.hindu+(+r.hindu||0), islam:acc.islam+(+r.islam||0) }), { total:0, tc:0, existing:0, hindu:0, islam:0 });
			const tfoot=document.createElement('tfoot'); const trf=document.createElement('tr');
			['Total', totals.total, totals.tc, totals.existing, totals.hindu, totals.islam].forEach(v=>{ const td=document.createElement('td'); td.textContent=v; trf.appendChild(td); });
			tfoot.appendChild(trf); table.appendChild(tfoot);
			host.innerHTML=''; host.appendChild(table);
			status.textContent = `Loaded ${rows.length} sections.`;
			// Render class-wise religion summary at bottom
			renderBottomSummary(rows);
		}
				function renderChart(rows){
					const wrap = document.getElementById('chartHost');
					const canvas = document.getElementById('countChart');
					if(!wrap || !canvas || typeof Chart === 'undefined') return;
					const labels = rows.map(r=>r.name);
					const totals = rows.map(r=>Number(r.total)||0);
					const targets = rows.map(r=>r.targetId);
					if(window.__countChart){ try{ window.__countChart.destroy(); }catch(_){} }
					canvas.style.height = '340px';
					const ctx = canvas.getContext('2d');
					const pal = makePalette(totals.length);
					window.__countChart = new Chart(ctx, {
						type:'bar',
						data:{ labels, datasets:[{ label:'Total students', data:totals, backgroundColor:pal.fills, hoverBackgroundColor:pal.hovers, borderColor:pal.borders, borderWidth:1, borderRadius:8, maxBarThickness:48 }] },
						options:{
							maintainAspectRatio:false,
							animation:{ duration:900, easing:'easeOutQuart' },
							onClick:(evt,elements)=>{
								if(elements && elements.length){ const i=elements[0].index; const target=targets[i]; if(target){ window.open('0newdatabase/datalist.html#'+target, '_blank'); } }
							},
							plugins:{ legend:{ display:false }, title:{ display:true, text:'শিক্ষার্থীদের যোগফল (সেকশনভিত্তিক)' } },
							scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Total' } }, x:{ ticks:{ maxRotation:45 } } }
						}
					});
				}
		async function init(){
			const status = document.getElementById('status');
			try{
				status.textContent = 'Loading from database…';
				try{
					const allRows = await fetchAllFromSupabase();
					const results = aggregateCounts(allRows);
					renderTable(results);
					renderChart(results);
					status.textContent = `Loaded ${results.length} sections.`;
				}catch(dbErr){
					console.warn('Supabase path failed, falling back to Google Sheets CSV. Error:', dbErr);
					status.textContent = 'Loading from Google Sheets…';
					const pairs = await loadSheetPairs();
					if(!pairs.length){ status.textContent='No sheets found.'; return; }
					const results = await Promise.all(pairs.map(fetchCounts));
					renderTable(results);
					renderChart(results);
					status.textContent = `Loaded ${results.length} sections.`;
				}
			}catch(err){
				console.error(err);
				status.textContent = 'Failed: '+(err && err.message || err);
			}
		}

		// Bottom summary: per-class Hindu/Islam totals
		function renderBottomSummary(rows){
			const host = document.getElementById('summaryHost');
			if(!host) return;
			const byClass = new Map();
			const bySession = new Map();
			(rows||[]).forEach(r=>{
				let cls = '';
				const m = String(r.originalName||'').match(/^\s*(\d{1,2})/);
				cls = m ? m[1] : String(r.originalName||'');
				if(!byClass.has(cls)) byClass.set(cls, { hindu:0, islam:0 });
				const agg = byClass.get(cls);
				agg.hindu += (+r.hindu||0);
				agg.islam += (+r.islam||0);
				// Session totals (use existing = total - tc)
				const sess = (r.session||'').trim() || 'Unknown';
				if(!bySession.has(sess)) bySession.set(sess, 0);
				bySession.set(sess, bySession.get(sess) + (+r.existing||0));
			});
			const items = Array.from(byClass.entries()).sort((a,b)=>{
				const ax = parseInt(a[0],10), bx = parseInt(b[0],10);
				if(Number.isFinite(ax) && Number.isFinite(bx) && ax!==bx) return ax-bx;
				return String(a[0]).localeCompare(String(b[0]));
			});
			const frag = document.createDocumentFragment();
			// Card 1: Religion totals  by Class
			const card1 = document.createElement('div');
			card1.style.cssText = 'max-width:1100px;margin:1rem auto;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;';
			const title1 = document.createElement('div');
			title1.textContent = 'Religion totals (After TC) by Class';
			title1.style.cssText = 'font-weight:700;margin-bottom:.5rem;';
			card1.appendChild(title1);
			// Two-column layout: Hindu (left), Islam (right)
			const colsWrap = document.createElement('div');
			colsWrap.style.cssText = 'display:flex;gap:16px;align-items:flex-start;justify-content:space-between;';
			const leftCol = document.createElement('div'); leftCol.style.cssText='flex:1;';
			const rightCol = document.createElement('div'); rightCol.style.cssText='flex:1;text-align:right;';
			items.forEach(([cls, sums])=>{
				// Hindu box
				const boxH = document.createElement('div');
				boxH.style.cssText = 'border:1px solid #e5e7eb;background:#fff;padding:8px 10px;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 0 rgba(15,23,42,0.03);';
				boxH.textContent = `${cls}-HINDU = ${sums.hindu}`;
				leftCol.appendChild(boxH);
				// Islam box (right)
				const boxI = document.createElement('div');
				boxI.style.cssText = 'border:1px solid #e5e7eb;background:#fff;padding:8px 10px;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 0 rgba(15,23,42,0.03);text-align:right;';
				boxI.textContent = `${cls}-ISLAM = ${sums.islam}`;
				rightCol.appendChild(boxI);
			});
			colsWrap.appendChild(leftCol);
			colsWrap.appendChild(rightCol);
			card1.appendChild(colsWrap);
			frag.appendChild(card1);

			// Card 2: Total students by Session (Existing), centered
			const card2 = document.createElement('div');
			card2.style.cssText = 'max-width:1100px;margin:1rem auto;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:16px;text-align:center;';
			const title2 = document.createElement('div');
			title2.textContent = 'Total students by Session (Existing)';
			title2.style.cssText = 'font-weight:700;margin-bottom:.5rem;';
			card2.appendChild(title2);
			const sessWrap = document.createElement('div');
			sessWrap.style.cssText = 'display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;';
			Array.from(bySession.entries()).sort((a,b)=> String(a[0]).localeCompare(String(b[0]))).forEach(([sess, total])=>{
				const line = document.createElement('div');
				line.textContent = `${sess} = ${total}`;
				sessWrap.appendChild(line);
			});
			card2.appendChild(sessWrap);
			frag.appendChild(card2);
			host.innerHTML = '';
			host.appendChild(frag);
		}
		window.addEventListener('DOMContentLoaded', init);
	</script>
</head>
<body>
	<header>
		<div class="container">
			<h1>শিক্ষার্থীদের যোগফল (সেকশনভিত্তিক)</h1>
			<div class="toolbar">
				<a class="btn" href="0newdatabase/datalist.html" target="_blank" rel="noopener">Open detailed data list</a>
				<span id="status" class="muted"></span>
			</div>
		</div>
	</header>
	<main>
			<div class="table-wrap container" id="chartHost" aria-label="Student count chart" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-top:1rem;">
				<canvas id="countChart" role="img" aria-label="শিক্ষার্থীদের যোগফল চার্ট"></canvas>
			</div>
		<div class="table-wrap container" id="tableHost" aria-label="Student count table"></div>
		<div class="container" id="summaryHost" aria-label="Class-wise religion totals"></div>
	</main>
</body>
</html>
