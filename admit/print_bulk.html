<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admit Cards — Bulk Preview</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
  <style>
    :root{ --bg:#f6f7f9; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Noto Sans Bengali','Hind Siliguri', system-ui, Arial, sans-serif; background:var(--bg); color:#111 }
    header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); z-index:10 }
    .container{ max-width:1200px; margin:0 auto; padding:1rem }
    h1{ margin:.25rem 0; text-align:center; font-size:1.1rem }
    .muted{ color:#6b7280 }
    .actions{ display:flex; gap:.5rem; justify-content:center; padding:1rem }
    .btn{ display:inline-flex; align-items:center; gap:.45rem; padding:.5rem .9rem; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; font-weight:600 }
    @media print{ header,.actions{ display:none !important } body{ background:#fff } @page{ size:A4; margin:6mm } }
    /* Printing layout */
    .sheet{ width:210mm; margin:10px auto; page-break-after:always }
    .print-grid{ display:grid; grid-template-columns:repeat(5, 1fr); gap:4mm; padding:2mm }
    .card{ position:relative; aspect-ratio: 210 / 115; background:#fff url('./admit.png') center/cover no-repeat; overflow:hidden; border:1px solid #e5e7eb }
    .card .t{ position:absolute; font-family:'Times New Roman', Times, serif; color:#111 }
    /* Use the same placements as list page */
  .t.name{ left:10mm; top:66mm; font-size:6.24mm; letter-spacing:.3mm; text-transform:uppercase }
  .t.class{ left:10mm; top:82mm; font-size:5mm }
  .t.section{ left:76mm; top:82mm; font-size:5mm; text-transform:uppercase }
  .t.roll{ left:10mm; top:96mm; font-size:5.5mm; white-space:pre }
  .t.exam{ left:60mm; top:52mm; font-weight:700; font-size:5.52mm }
    .t.year{ left:138mm; top:52mm; font-weight:700; font-size:4.6mm }
    .t.iid{ left:78mm; top:122mm; font-size:4mm }
  /* Page QR (current URL) */
  .qr-page{ position:fixed; top:6mm; right:6mm; width:22mm; height:22mm; z-index:20; background:#fff; border:1px solid #e5e7eb; border-radius:6px; display:flex; align-items:center; justify-content:center }
  .qr-page canvas{ width:100%; height:100% }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    function q(n, d=''){ const v=new URLSearchParams(location.search).get(n); return v==null?d:v; }
    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size){ out.push(arr.slice(i,i+size)); } return out; }
    function makePageQR(){
      const wrap=document.getElementById('pageQR'); if(!wrap) return;
      const text=location.href;
      const Q = window.QRCode || window.qrcode || null;
      if(!Q){ wrap.title='QR library not loaded'; return; }
      // Prefer toCanvas
      if(typeof Q.toCanvas === 'function'){
        const canvas=document.createElement('canvas');
        Q.toCanvas(canvas, text, { width:256, margin:0 }, function(err){
          if(!err){ wrap.innerHTML=''; wrap.appendChild(canvas); }
          else if(typeof Q.toDataURL === 'function'){
            Q.toDataURL(text, { width:256, margin:0 }, function(e,url){ if(!e){ const img=new Image(); img.src=url; wrap.innerHTML=''; wrap.appendChild(img);} });
          }
        });
        return;
      }
      // Fallback to toDataURL
      if(typeof Q.toDataURL === 'function'){
        Q.toDataURL(text, { width:256, margin:0 }, function(e,url){ if(!e){ const img=new Image(); img.src=url; wrap.innerHTML=''; wrap.appendChild(img);} });
        return;
      }
      // Fallback to constructor-style libs
      try{ new Q(wrap, { text, width:256, height:256, correctLevel: Q.CorrectLevel ? Q.CorrectLevel.M : undefined }); }catch(_){ /* ignore */ }
    }
    function render(){
      const key = q('key','');
      if(!key){ document.getElementById('info').textContent = 'No data key provided.'; makePageQR(); return; }
      const raw = sessionStorage.getItem(key);
      if(!raw){ document.getElementById('info').textContent = 'No data found in this session. Please regenerate from the list.'; makePageQR(); return; }
      let payload; try{ payload = JSON.parse(raw); }catch(_){ document.getElementById('info').textContent='Invalid data.'; makePageQR(); return; }
      const { exam='', year='', students=[] } = payload||{};
      document.getElementById('subtitle').textContent = `${exam} — ${year}`;
      const pages = chunk(students, 10);
      const root = document.getElementById('root');
      pages.forEach(group=>{
        const sheet = document.createElement('div'); sheet.className='sheet';
        const grid = document.createElement('div'); grid.className='print-grid'; sheet.appendChild(grid);
        group.forEach(s=>{
          const card = document.createElement('div'); card.className='card';
          const tn = document.createElement('div'); tn.className='t name'; tn.textContent = String(s.name||'').toUpperCase(); card.appendChild(tn);
          const tc = document.createElement('div'); tc.className='t class'; tc.textContent = s.cls||''; card.appendChild(tc);
          const ts = document.createElement('div'); ts.className='t section'; ts.textContent = String(s.section||'').toUpperCase(); card.appendChild(ts);
          const tr = document.createElement('div'); tr.className='t roll';
          tr.textContent = s.iid ? `Roll : ${s.roll||''}       IID : ${s.iid}` : `Roll : ${s.roll||''}`;
          card.appendChild(tr);
          const te = document.createElement('div'); te.className='t exam'; te.textContent = [exam, year].filter(Boolean).join(' - '); card.appendChild(te);
          grid.appendChild(card);
        });
        root.appendChild(sheet);
      });
  // Page QR of current link
  makePageQR();
    }
    window.addEventListener('DOMContentLoaded', render);
  </script>
  </head>
<body>
  <header>
    <div class="container">
      <h1>Admit Cards Preview (Bulk)</h1>
      <div id="subtitle" class="muted" style="text-align:center"></div>
    </div>
  </header>
  <div class="container" id="info" style="text-align:center; padding-top:.5rem"></div>
  <main id="root"></main>
  <div class="actions">
    <button class="btn" onclick="window.print()">Print</button>
  </div>
  <div id="pageQR" class="qr-page" title="Page QR"></div>
</body>
</html>
