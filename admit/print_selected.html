<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Admit Cards — Selected (6 per page)</title>
	<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
	<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
	<style>
		:root{ --bg:#f6f7f9; --border:#e5e7eb }
		*{ box-sizing:border-box }
		body{ margin:0; font-family:'Noto Sans Bengali','Hind Siliguri', system-ui, Arial, sans-serif; background:var(--bg); color:#111 }
		header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); z-index:10 }
		.container{ max-width:1100px; margin:0 auto; padding:1rem }
		h1{ margin:.25rem 0; text-align:center; font-size:1.1rem }
		.actions{ display:flex; gap:.5rem; justify-content:center; padding:.5rem 0 }
		.btn{ display:inline-flex; align-items:center; gap:.45rem; padding:.45rem .9rem; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; font-weight:600 }
		.btn.primary{ background:#0ea5e9; border-color:#0284c7; color:#fff }

		/* Print layout: A4 portrait, 2 columns x 3 rows = 6 cards (each 9.3cm x 9cm) */
		.sheet{ width:200mm; margin:0 auto; padding:0mm 1mm; page-break-inside: avoid; break-inside: avoid-page; background:#fff }
		.sheet + .sheet{ page-break-before: always; break-before: page }
		.grid{ display:grid; grid-template-columns: repeat(2, max-content); gap:8mm }
	/* Wrapper sized to exact card footprint */
		.box{ /* JS sets exact mm sizes */ break-inside: avoid; page-break-inside: avoid; display:block; border:none }
		.box::after{ display:none }
		.grid{ break-inside: avoid; page-break-inside: avoid }
	.card{ position:relative; width:93mm; height:90mm; background:#fff url('./admit.png') center no-repeat; background-size:100% 100%; overflow:hidden; border:0.5mm solid #000 }
	.t{ position:absolute; font-family:'Times New Roman', Times, serif; color:#111; line-height:1.12; -webkit-font-smoothing:antialiased; text-rendering:geometricPrecision }
	.watermark{ position:absolute; left:50%; top:60%; transform:translate(-50%,-50%); width:58mm; max-width:60%; height:auto; opacity:.12; pointer-events:none; filter:grayscale(100%) }
	.labelled::before{ content: attr(data-label) ' : '; font-weight:400; margin-right:1.5mm }
	/* Flow container (same as single-card) */
	.info-block{ position:absolute; left:4.43mm; right:4.43mm; top:51.44mm }
	.info-block .t{ position:static; display:block }
	.info-block .row{ display:flex; align-items:flex-end; justify-content:space-between; gap:6mm }
	/* Text sizes (same as single-card) */
	.t.name{ font-size:3.75mm; font-weight:700; letter-spacing:.2mm; text-transform:uppercase; white-space:normal; overflow-wrap:anywhere; margin:0 0 2mm 0 }
	.t.class{ font-size:3.91mm }
	.t.section{ font-size:3.91mm; text-transform:uppercase; text-align:right }
	.t.roll{ font-size:4.9mm; font-weight:700; max-width:46mm; overflow:hidden; white-space:nowrap; text-overflow:ellipsis }
	.t.iid{ font-size:3.91mm; font-weight:400; white-space:nowrap; max-width:38mm; text-align:right }
	.t.group{ font-size:3.52mm; font-weight:400; text-align:right; margin-top:1.2mm }
	.t.exam{ left:0; top:36.65mm; width:100%; text-align:center; font-weight:700; font-size:4.32mm; text-decoration: underline; text-underline-offset: 1mm; text-decoration-thickness: .4mm }
	.t.year{ left:61.29mm; top:40.70mm; font-weight:400; font-size:3.60mm }
	/* School header & footer */
	.t.school-name{ left:0; top:2.70mm; width:100%; text-align:center; font-weight:400; font-size:8.92mm; color:#111 }
	.t.school-address{ left:0; top:12.52mm; width:100%; text-align:center; font-weight:400; font-size:3.52mm; color:#111 }
	/* Admit Card badge under address */
	.t.admit-badge{ left:50%; top:17.22mm; transform:translateX(-50%); background:#777; color:#fff; padding:3.29mm 8.22mm; border-radius:4.11mm; font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; font-weight:400; font-size:8.22mm; line-height:1; white-space:nowrap }
	/* Footer signatures */
	.t.class-teacher{ left:6.64mm; bottom:2mm; font-weight:400; font-size:3.52mm; color:#111 }
	.t.headteacher{ right:6.64mm; bottom:2mm; font-weight:400; font-size:3.52mm; color:#111 }

		.sheets{ display:flex; flex-direction:column; gap:5mm; padding:5mm 0 }

		@media print{
			header,.actions{ display:none !important }
			body{ background:#fff; margin:0; padding:0 }
			@page{ size:A4; margin:3mm }
			.sheets{ gap:0; padding:0 }
			.sheet{ page-break-inside:avoid; margin:0 auto; padding:0; width:200mm }
			.card{ border:0.5mm solid #000 }
			.box{ border:none; background:none }
			.grid{ gap:8mm }
		}
	/* Export tweaks: ensure solid background, avoid CSS bg images issues */
	body.exporting .card{ background:#fff !important; background-image:none !important }
	</style>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script>
		function q(n, d=''){ const v=new URLSearchParams(location.search).get(n); return v==null?d:v; }
		function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }
		function upper(s){ return String(s||'').toUpperCase(); }

			function loadPayload(){
				const key = q('key',''); if(!key){ return null; }
				try{
					const raw = localStorage.getItem(key);
					if(!raw) return null;
					const data = JSON.parse(raw);
					// Clean up so storage doesn't grow indefinitely
					try{ localStorage.removeItem(key); }catch(_){}
					return data;
				}catch(e){ return null; }
			}

			function render(){
			const payload = loadPayload();
			const info = document.getElementById('info');
			if(!payload || !Array.isArray(payload.students) || payload.students.length===0){
				info.textContent = 'No data found. Please go back and select students again.';
				return;
			}
			const exam = payload.exam||''; const year = payload.year||'';
			info.textContent = `Rendering ${payload.students.length} admits — ${exam} ${year}`;

			const sheetsWrap = document.getElementById('sheets');
			sheetsWrap.innerHTML = '';
			// Fixed card size per single-card: 93mm x 90mm
			const targetW = 93, targetH = 90; // mm

			const pages = chunk(payload.students, 6);
			pages.forEach((page, pageIdx)=>{
				const sheet = document.createElement('div'); sheet.className='sheet';
				const grid = document.createElement('div'); grid.className='grid'; sheet.appendChild(grid);
				page.forEach(s=>{
						const box = document.createElement('div'); box.className='box'; box.style.width = targetW + 'mm'; box.style.height = targetH + 'mm';
						const card = document.createElement('div'); card.className='card';
						// Watermark
						const wm = document.createElement('img'); wm.className='watermark'; wm.src='./logowatermark.png'; wm.alt=''; wm.decoding='async'; card.appendChild(wm);
						// School header
						const tSchoolName = document.createElement('div'); tSchoolName.className='t school-name'; tSchoolName.textContent = 'Feni Model High School'; card.appendChild(tSchoolName);
						const tSchoolAddress = document.createElement('div'); tSchoolAddress.className='t school-address'; tSchoolAddress.textContent = 'Trunk Road, Feni'; card.appendChild(tSchoolAddress);
						const tBadge = document.createElement('div'); tBadge.className='t admit-badge'; tBadge.textContent = 'Admit Card'; card.appendChild(tBadge);
						// Main content (same as single)
						const tExam = document.createElement('div'); tExam.className='t exam'; tExam.textContent = [exam, year].filter(Boolean).join(' - '); card.appendChild(tExam);
						const tYear = document.createElement('div'); tYear.className='t year'; tYear.textContent = ''; card.appendChild(tYear);
						const info = document.createElement('div'); info.className='info-block';
						const nm = document.createElement('div'); nm.className='t name labelled'; nm.setAttribute('data-label','Name'); nm.textContent = upper(s.name||''); info.appendChild(nm);
						const row1 = document.createElement('div'); row1.className='row';
						const tc = document.createElement('div'); tc.className='t class labelled'; tc.setAttribute('data-label','Class'); tc.textContent = s.cls||''; row1.appendChild(tc);
						const ts = document.createElement('div'); ts.className='t section labelled'; ts.setAttribute('data-label','Section'); ts.textContent = upper(s.section||''); row1.appendChild(ts);
						info.appendChild(row1);
						const row2 = document.createElement('div'); row2.className='row';
						const tr = document.createElement('div'); tr.className='t roll labelled'; tr.setAttribute('data-label','Roll'); tr.textContent = `${s.roll||''}`; row2.appendChild(tr);
						const ti = document.createElement('div'); ti.className='t iid labelled'; ti.setAttribute('data-label','IID'); ti.textContent = s.iid? String(s.iid) : ''; row2.appendChild(ti);
						info.appendChild(row2);
						// Group (value only) for class 9 & 10
						const tGroup = document.createElement('div'); tGroup.className='t group';
						const clsNum = parseInt(String(s.cls||'').match(/\d+/)?.[0]||'',10);
						if((clsNum===9 || clsNum===10) && s.group){ tGroup.textContent = String(s.group).toUpperCase(); }
						info.appendChild(tGroup);
						card.appendChild(info);
						// Footer signatures
						const tClassTeacher = document.createElement('div'); tClassTeacher.className='t class-teacher'; tClassTeacher.textContent = 'Class Teacher'; card.appendChild(tClassTeacher);
						const tHeadteacher = document.createElement('div'); tHeadteacher.className='t headteacher'; tHeadteacher.textContent = 'Headteacher'; card.appendChild(tHeadteacher);
						box.appendChild(card);
						grid.appendChild(box);
				});
				// Force a page break between sheets for PDF generation
				if(pageIdx < pages.length-1){ sheet.style.pageBreakAfter = 'always'; }
				sheetsWrap.appendChild(sheet);
			});
		}

		window.addEventListener('DOMContentLoaded', ()=>{
			render();
					/* Print button removed */
							const dl = document.getElementById('downloadBtn');
							if(dl){ dl.addEventListener('click', async ()=>{
								const infoText = (document.getElementById('info')?.textContent||'').trim();
								const filename = (infoText? infoText.replace(/\s+/g,'_').slice(0,60)+'_': '') + 'Selected_Admit_Cards.pdf';
								const liveSheets = Array.from(document.querySelectorAll('.sheet'));
								if(!liveSheets.length){ alert('Nothing to export.'); return; }

								try {
									// Manual composition on a clean clone: html2canvas + jsPDF (reliable, avoids sticky headers/positioning)
									if(!window.html2canvas || !window.jspdf){
										alert('PDF libraries not loaded. Please check internet connection.');
										return;
									}

									const { jsPDF } = window.jspdf;
									// Clone sheets into export root
									const exportRoot = document.createElement('div');
									exportRoot.style.width = '210mm';
									exportRoot.style.margin = '0 auto';
									exportRoot.style.background = '#ffffff';
									exportRoot.id = 'export-root';
									liveSheets.forEach(s => exportRoot.appendChild(s.cloneNode(true)));
									document.body.appendChild(exportRoot);
									document.body.classList.add('exporting');

									try{
										// Wait for fonts and layout
										if(document.fonts && document.fonts.ready){ try{ await document.fonts.ready; }catch(_){}}
										await new Promise(r => setTimeout(r, 80));

					const pdf = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
										const cloneSheets = Array.from(exportRoot.querySelectorAll('.sheet'));
										for(let i = 0; i < cloneSheets.length; i++){
											const sheet = cloneSheets[i];
											const canvas = await window.html2canvas(sheet, {
						scale: 3,
												useCORS: true,
												allowTaint: true,
						imageTimeout: 0,
						removeContainer: true,
						scrollX: -window.scrollX,
						scrollY: -window.scrollY,
												backgroundColor: '#ffffff',
												logging: false
											});
											const imgData = canvas.toDataURL('image/jpeg', 0.95);
											if(i>0) pdf.addPage('a4','portrait');
											const pageW = 210, pageH = 297;
											const margin = 3; // mm on all sides
											const maxW = pageW - margin*2;
											const maxH = pageH - margin*2;
											let w = maxW, h = canvas.height * w / canvas.width;
											if(h > maxH){ const s = maxH / h; w *= s; h = maxH; }
											const x = margin + (maxW - w)/2, y = margin + (maxH - h)/2;
											pdf.addImage(imgData, 'JPEG', x, y, w, h);
										}
										pdf.save(filename);
									} finally {
										document.body.classList.remove('exporting');
										exportRoot.remove();
									}
								} catch(error) {
									console.error('PDF generation error:', error);
									alert('Error generating PDF. Please try again.');
								}
							}); }
		});
	</script>
	<script>
		// Optional: support direct query-based render without sessionStorage (for manual tests)
		// Example: print_selected.html?direct=1&exam=Half%20Yearly&year=2025&data=[{...}]
	</script>
	<noscript>Enable JavaScript to render the selected admit cards.</noscript>
</head>
<body>
	<header>
		<div class="container">
			<h1>Selected Admit Cards (Seatplan style — 6 per A4)</h1>
			<div class="actions">
		<button id="downloadBtn" class="btn">Download PDF</button>
				<button class="btn" onclick="history.back()">Back</button>
			</div>
			<div id="info" class="container" style="text-align:center; color:#6b7280; font-size:.95rem"></div>
		</div>
	</header>

	<main class="sheets" id="sheets"></main>
</body>
</html>

