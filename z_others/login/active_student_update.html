<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Active Student Update (Session-wise)</title>
  <style>
    :root { --bg:#f6f8fa; --card:#ffffff; --border:#d0d7de; --accent:#0366d6; --accent-hover:#024c9e; --danger:#d73a49; --radius:6px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    body { margin:0; background:var(--bg); color:#24292f; }
    header { background:#0d1117; color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    h1 { font-size:20px; margin:0; font-weight:600; }
    .btn-logout { background:#ff8a00; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; font-size:13px; border:1px solid #ff8a00; }
    .btn-logout:hover { background:#e07000; border-color:#e07000; }
    /* Full-width container so table fits left-right */
    .container { width:100%; max-width:100%; margin:0 0 60px 0; background:var(--card); border:1px solid var(--border); border-radius:0; padding:18px 12px 28px; box-shadow:0 2px 4px rgba(0,0,0,.04); }
    /* Ensure table can scroll horizontally on very small screens */
    .table-wrap { overflow-x:auto; }
    .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:14px; }
    .toolbar select, .toolbar input[type=text]{ padding:8px 10px; border:1px solid var(--border); border-radius:4px; font-size:14px; background:#fff; }
    .toolbar button{ height:34px; }
    .status { font-size:13px; min-height:18px; }
    .status.ok { color:#1a7f37; }
    .status.err { color:var(--danger); }
    table { width:100%; border-collapse:collapse; font-size:13.5px; }
    thead { background:#fafbfc; position:sticky; top:0; z-index:5; }
    th, td { border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:middle; }
    th { font-weight:600; font-size:12.5px; letter-spacing:.5px; background:#f0f3f6; }
    tbody tr:nth-child(even){ background:#fcfcfd; }
    tbody tr:hover { background:#fffbe6; }
    .col-sl { width:52px; text-align:center; }
    .actions-col { white-space:nowrap; }
    button { cursor:pointer; font-size:12px; line-height:1.2; padding:6px 10px; border-radius:4px; border:1px solid var(--accent); background:var(--accent); color:#fff; font-weight:500; }
    button:hover { background:var(--accent-hover); }
    button.outline { background:#fff; color:var(--accent); }
    button.outline:hover { background:#e7f3ff; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .muted { color:#6a737d; font-size:12px; }
    /* Space between action buttons */
    .action-cell button + button { margin-left:8px; }
    .action-cell .btn { padding:6px 8px; }
    /* Make Update button orange when needed, blue when up-to-date */
    .btn.update-needed { background:#ff8a00; border-color:#ff8a00; }
    .btn.update-needed:hover { background:#e07000; }
    .btn.up-to-date { background:#10b981; border-color:#10b981; }
    .btn.up-to-date:hover { background:#0f9f74; }
    /* Inline status messages */
    .update-status { font-size:11px; margin-left:8px; font-weight:600; }
    .update-status.success { color:#1a7f37; }
    .update-status.error { color:var(--danger); }
    .update-status.loading { color:#6a737d; }
    @media (max-width:820px){
      .container { padding:14px 14px 24px; }
      .toolbar { gap:8px; }
      th,td{padding:5px 6px;font-size:12.5px;}
      button{padding:5px 8px;}
    }
  </style>
</head>

<body>
  <header>
    <h1>Active Student Update (Session-wise)</h1>
    <button id="logoutBtn" class="btn-logout">Logout</button>
  </header>

  <div class="container">
    <div class="toolbar">
      <div class="filters left" style="align-items:center">
        <label for="sessionFilter" class="filter-label">Session</label>
        <select id="sessionFilter" class="filter-select">
          <option value="">Select Session</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
        <label for="classFilter" class="filter-label">Class</label>
        <select id="classFilter" class="filter-select">
          <option value="">All Classes</option>
        </select>
        <label for="sectionFilter" class="filter-label">Section</label>
        <select id="sectionFilter" class="filter-select">
          <option value="">All Sections</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;align-items:center;margin-left:auto">
        <button id="refreshBtn">Refresh</button>
        <button id="updateAllBtn" class="update-needed">Update All Needed</button>
        <button id="downloadCsvBtn" class="outline">Download CSV</button>
        <button id="downloadJsonBtn" class="outline">Download JSON</button>
        <span id="status" class="status"></span>
      </div>
    </div>

    <div class="table-wrap">
      <table id="dataTable">
        <thead id="tableHeader">
          <tr>
            <th class="col-sl">SL</th>
            <th>IID</th>
            <th>Name</th>
            <th>Father Name</th>
            <th>Father Mobile</th>
            <th>Session</th>
            <th>Class</th>
            <th>Section</th>
            <th>Roll</th>
            <th>Status</th>
            <th>Active Class</th>
            <th>Active Section</th>
            <th>Active Roll</th>
            <th>Student Key</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="15" class="muted">Select a session to view data</td></tr>
        </tbody>
      </table>
    </div>
    <div id="rowCount" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Auth check -->
  <script src="/login/auth-check_copy.js"></script>

  <script>
    // Use the same project URL/key used elsewhere in this repo
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    // Reuse existing Supabase client or create new one
    if (!window.supabaseClient) {
      window.__supabaseClients = window.__supabaseClients || {};
      window.supabaseClient = window.__supabaseClients[supabaseUrl] || window.supabase.createClient(supabaseUrl, supabaseKey);
      window.__supabaseClients[supabaseUrl] = window.supabaseClient;
    }
    const supabaseClient = window.supabaseClient;

    const tableName = 'student_database_others';

    // Elements
    const tbody = document.querySelector('#dataTable tbody');
    const statusEl = document.getElementById('status');
    const sessionFilter = document.getElementById('sessionFilter');
    const classFilter = document.getElementById('classFilter');
    const sectionFilter = document.getElementById('sectionFilter');
    const tableHeader = document.getElementById('tableHeader');
    const rowCountEl = document.getElementById('rowCount');

    // Global data cache
    let allRowsCache = [];
    let filteredSessionData = [];
    let currentSession = '';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      loadData();
    });

    function setupEventListeners() {
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('sessionFilter').addEventListener('change', function() {
        currentSession = this.value;
        if (currentSession) {
          updateTableHeader(currentSession);
          filterDataBySession();
          populateFilters();
        } else {
          clearTable();
        }
      });
      document.getElementById('classFilter').addEventListener('change', filterAndRenderData);
      document.getElementById('sectionFilter').addEventListener('change', filterAndRenderData);
      document.getElementById('updateAllBtn').addEventListener('click', updateAllNeeded);
      document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
      document.getElementById('downloadJsonBtn').addEventListener('click', downloadJSON);
      document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    async function logout() {
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.error('Logout error:', e);
      }
      window.location.href = './index.html';
    }

    async function loadData() {
      try {
        showStatus('Loading data...', 'loading');
        tbody.innerHTML = '<tr><td colspan="15">Loading...</td></tr>';

        console.log('Loading data from table:', tableName);

        const { data, error } = await supabaseClient
          .from(tableName)
          .select('*');

        if (error) {
          console.error('Supabase error:', error);
          throw new Error('Database query failed: ' + error.message);
        }

        if (!data || data.length === 0) {
          showStatus('No data found', 'error');
          tbody.innerHTML = '<tr><td colspan="15" class="muted">No data available.</td></tr>';
          return;
        }

        console.log('Data loaded successfully:', data.length, 'rows');
        allRowsCache = data;
        
        // Don't show data initially - wait for session selection
        clearTable();
        showStatus('Data loaded. Select a session to view students.', 'ok');

      } catch (error) {
        console.error('Load data error:', error);
        showStatus('Failed to load data: ' + error.message, 'error');
        tbody.innerHTML = '<tr><td colspan="15" class="muted">Failed to load data.</td></tr>';
      }
    }

    function clearTable() {
      tbody.innerHTML = '<tr><td colspan="15" class="muted">Select a session to view data</td></tr>';
      rowCountEl.textContent = '';
      classFilter.innerHTML = '<option value="">All Classes</option>';
      sectionFilter.innerHTML = '<option value="">All Sections</option>';
    }

    function filterDataBySession() {
      if (!currentSession) {
        filteredSessionData = [];
        clearTable();
        return;
      }

      const sessionClassCol = `class_${currentSession}`;
      const sessionSectionCol = `section_${currentSession}`;
      const sessionRollCol = `roll_${currentSession}`;

      // Filter data for current session - students who have data in session-specific columns
      filteredSessionData = allRowsCache.filter(row => {
        const hasClass = row[sessionClassCol] != null && row[sessionClassCol] !== '';
        const hasSection = row[sessionSectionCol] != null && row[sessionSectionCol] !== '';
        const hasRoll = row[sessionRollCol] != null && row[sessionRollCol] !== '';
        return hasClass || hasSection || hasRoll;
      });

      console.log(`Filtered data for session ${currentSession}:`, filteredSessionData.length, 'rows');

      if (filteredSessionData.length === 0) {
        showStatus(`No students found for session ${currentSession}`, 'error');
        tbody.innerHTML = `<tr><td colspan="15" class="muted">No students for session ${currentSession}.</td></tr>`;
        rowCountEl.textContent = '';
        return;
      }

      // Sort by class, section, roll for selected session
      filteredSessionData.sort((a, b) => {
        const aClass = String(a[sessionClassCol] || '');
        const bClass = String(b[sessionClassCol] || '');
        if (aClass !== bClass) {
          return aClass.localeCompare(bClass, undefined, { numeric: true });
        }

        const aSection = String(a[sessionSectionCol] || '');
        const bSection = String(b[sessionSectionCol] || '');
        if (aSection !== bSection) {
          return aSection.localeCompare(bSection, undefined, { numeric: true });
        }

        const aRoll = parseInt(a[sessionRollCol]) || 0;
        const bRoll = parseInt(b[sessionRollCol]) || 0;
        return aRoll - bRoll;
      });

      filterAndRenderData();
    }

    function populateFilters() {
      console.log('populateFilters called');
      console.log('currentSession:', currentSession);
      console.log('filteredSessionData length:', filteredSessionData.length);
      
      if (!currentSession || filteredSessionData.length === 0) return;

      const sessionClassCol = `class_${currentSession}`;
      const sessionSectionCol = `section_${currentSession}`;
      
      console.log('Session columns:', sessionClassCol, sessionSectionCol);

      // Get unique classes and sections
      const classes = [...new Set(filteredSessionData.map(row => row[sessionClassCol]).filter(Boolean))].sort((a, b) => {
        // Sort classes numerically if they are numbers, otherwise alphabetically
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return aNum - bNum;
        }
        return String(a).localeCompare(String(b));
      });
      const sections = [...new Set(filteredSessionData.map(row => row[sessionSectionCol]).filter(Boolean))].sort();
      
      console.log('Unique classes:', classes);
      console.log('Unique sections:', sections);
      console.log('Sample data for debugging:', filteredSessionData.slice(0, 3).map(row => ({
        iid: row.iid,
        [sessionClassCol]: row[sessionClassCol],
        [sessionSectionCol]: row[sessionSectionCol],
        classType: typeof row[sessionClassCol],
        sectionType: typeof row[sessionSectionCol]
      })));

      // Populate class filter
      classFilter.innerHTML = '<option value="">All Classes</option>';
      classes.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        classFilter.appendChild(option);
      });

      // Populate section filter
      sectionFilter.innerHTML = '<option value="">All Sections</option>';
      sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        sectionFilter.appendChild(option);
      });
      
      console.log('Filters populated successfully');
    }

    function updateTableHeader(session) {
      tableHeader.innerHTML = `
        <tr>
          <th class="col-sl">SL</th>
          <th>IID</th>
          <th>Name</th>
          <th>Father Name</th>
          <th>Father Mobile</th>
          <th>Session</th>
          <th>Class (${session})</th>
          <th>Section (${session})</th>
          <th>Roll (${session})</th>
          <th>Status</th>
          <th>Active Class</th>
          <th>Active Section</th>
          <th>Active Roll</th>
          <th>Student Key</th>
          <th>Action</th>
        </tr>
      `;
    }

    function filterAndRenderData() {
      console.log('filterAndRenderData called');
      console.log('currentSession:', currentSession);
      console.log('filteredSessionData length:', filteredSessionData.length);
      
      if (!currentSession || filteredSessionData.length === 0) {
        console.log('No session or no data, clearing table');
        clearTable();
        return;
      }

      const sessionClassCol = `class_${currentSession}`;
      const sessionSectionCol = `section_${currentSession}`;

      const selectedClass = classFilter.value;
      const selectedSection = sectionFilter.value;
      
      console.log('Selected filters - Class:', selectedClass, 'Section:', selectedSection);

      // Apply class and section filters
      let displayData = filteredSessionData;
      
      if (selectedClass) {
        displayData = displayData.filter(row => {
          // Convert both values to string for comparison to handle type mismatch
          return String(row[sessionClassCol]) === String(selectedClass);
        });
        console.log('After class filter:', displayData.length, 'rows');
        console.log('Filtered by class:', selectedClass, 'sessionClassCol:', sessionClassCol);
      }
      
      if (selectedSection) {
        displayData = displayData.filter(row => {
          // Convert both values to string for comparison
          return String(row[sessionSectionCol]) === String(selectedSection);
        });
        console.log('After section filter:', displayData.length, 'rows');
      }

      console.log('Final displayData length:', displayData.length);

      if (displayData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="15" class="muted">No students match the selected filters.</td></tr>';
        rowCountEl.textContent = '';
        return;
      }

      renderTable(displayData, currentSession);
    }

    function renderTable(data, session) {
      const sessionClassCol = `class_${session}`;
      const sessionSectionCol = `section_${session}`;
      const sessionRollCol = `roll_${session}`;

      let needsUpdateCount = 0;
      const updateNeededRows = [];
      const upToDateRows = [];
      let indexCounter = 0;

      const normalize = (val) => (val === null || val === undefined || val === '') ? '' : String(val);
      // Do NOT strip leading zeros; we want exactly 6-digit key. Any other length (1-5, >6) triggers update.
      const isValidSixDigit = (val) => /^\d{6}$/.test(String(val||''));

      data.forEach((row) => {
        indexCounter++;
        const sessionClass = row[sessionClassCol];
        const sessionSection = row[sessionSectionCol];
        const sessionRoll = row[sessionRollCol];
        
        // Show session-specific values as "target" active values
        // If status is 'TC', set active fields to null
        let targetActiveClass = sessionClass;
        let targetActiveSection = sessionSection;
        let targetActiveRoll = sessionRoll;
        
        if (row.status === 'TC') {
          targetActiveClass = null;
          targetActiveSection = null;
          targetActiveRoll = null;
        }
        
        // Current active values from database
        const currentActiveClass = row.active_class;
        const currentActiveSection = row.active_section;
        const currentActiveRoll = row.active_roll;
        
        // Generate student key from father mobile last 6 digits
        const fatherMobile = String(row.father_mobile_en || row.father_mobile || '').replace(/\D/g, ''); // Remove non-digits
        let generatedStudentKey = '';
        
        if (fatherMobile.length >= 6) {
          generatedStudentKey = fatherMobile.slice(-6); // This preserves leading zeros like "003695"
        } else if (fatherMobile.length > 0) {
          generatedStudentKey = fatherMobile; // Use whatever digits are available
        }
        
        // If status is TC, set student key to null as well
        if (row.status === 'TC') {
          generatedStudentKey = null;
        }
        
        const currentStudentKey = row.student_key;

        // Check if update is needed - compare what should be with what currently is
        // For TC status: active fields should be null, for others: active fields should match session fields
        // Special handling for student key to preserve leading zeros and handle null properly
        const targetStudentKeyStr = generatedStudentKey === null ? '' : String(generatedStudentKey);
        const currentStudentKeyStr = currentStudentKey === null ? '' : String(currentStudentKey || '');
        
        // Normalize values for comparison - treat null, undefined, and empty string as equivalent
        const normalizeValue = (val) => (val === null || val === undefined || val === '') ? null : String(val);
        
  const needsUpdate = (normalizeValue(targetActiveClass) !== normalizeValue(currentActiveClass)) || 
         (normalizeValue(targetActiveSection) !== normalizeValue(currentActiveSection)) || 
         (normalizeValue(targetActiveRoll) !== normalizeValue(currentActiveRoll)) ||
         // Student key update rules:
         // 1. If generated key is null (TC) but current not null -> update
         // 2. If generated key exists and is not exactly 6 digits -> update (needs padding not allowed; we always store derived last 6 exactly)
         // 3. If stored key !== generated key (exact string compare) -> update
         ( (generatedStudentKey === null && (currentStudentKey !== null && currentStudentKey !== '')) ||
           (generatedStudentKey !== null && (!isValidSixDigit(generatedStudentKey) || String(currentStudentKey||'') !== String(generatedStudentKey))) );

        if (needsUpdate) needsUpdateCount++;

        const buttonClass = needsUpdate ? 'update-needed' : 'up-to-date';
        const buttonText = needsUpdate ? 'Update' : 'Up-to-date';
        // Don't disable button for TC students - they need to update to null values
        // Only disable if no session data exists at all
        const isDisabled = !sessionClass && !sessionSection && !sessionRoll && row.status !== 'TC';

        const rowHtml = `
          <tr data-iid="${escapeHtml(row.iid || '')}">
            <td class="col-sl">${indexCounter}</td>
            <td>${escapeHtml(row.iid || '')}</td>
            <td>${escapeHtml(row.student_name_en || '')}</td>
            <td>${escapeHtml(row.father_name_en || '')}</td>
            <td>${escapeHtml(row.father_mobile_en || row.father_mobile || '')}</td>
            <td>${escapeHtml(row.session || '')}</td>
            <td>${escapeHtml(sessionClass || '')}</td>
            <td>${escapeHtml(sessionSection || '')}</td>
            <td>${escapeHtml(sessionRoll || '')}</td>
            <td>${escapeHtml(row.status || '')}</td>
            <td style="color: ${needsUpdate ? '#ff8a00' : '#10b981'}; font-weight: ${needsUpdate ? '600' : 'normal'};">
              <div style="font-weight: bold;">${escapeHtml(currentActiveClass || '')}</div>
              ${needsUpdate ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">→ ${escapeHtml(targetActiveClass || '')}</div>` : ''}
            </td>
            <td style="color: ${needsUpdate ? '#ff8a00' : '#10b981'}; font-weight: ${needsUpdate ? '600' : 'normal'};">
              <div style="font-weight: bold;">${escapeHtml(currentActiveSection || '')}</div>
              ${needsUpdate ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">→ ${escapeHtml(targetActiveSection || '')}</div>` : ''}
            </td>
            <td style="color: ${needsUpdate ? '#ff8a00' : '#10b981'}; font-weight: ${needsUpdate ? '600' : 'normal'};">
              <div style="font-weight: bold;">${escapeHtml(currentActiveRoll || '')}</div>
              ${needsUpdate ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">→ ${escapeHtml(targetActiveRoll || '')}</div>` : ''}
            </td>
            <td style="font-family: monospace; color: ${ (generatedStudentKey === null && currentStudentKey) || (generatedStudentKey && String(generatedStudentKey) !== String(currentStudentKey || '')) || (generatedStudentKey && !isValidSixDigit(generatedStudentKey)) ? '#ff8a00' : '#10b981'}; font-size: 12px; font-weight: ${ (generatedStudentKey === null && currentStudentKey) || (generatedStudentKey && String(generatedStudentKey) !== String(currentStudentKey || '')) || (generatedStudentKey && !isValidSixDigit(generatedStudentKey)) ? 'bold' : 'normal'};">
              <div style="font-weight: bold;">${escapeHtml(currentStudentKey || '')}</div>
              ${( (generatedStudentKey === null && currentStudentKey) || (generatedStudentKey && String(generatedStudentKey) !== String(currentStudentKey || '')) || (generatedStudentKey && !isValidSixDigit(generatedStudentKey)) ) ? `<div style="font-size: 10px; color: #666; margin-top: 2px;">→ ${escapeHtml(generatedStudentKey || '')}</div>` : ''}
            </td>
            <td class="action-cell">
              <button 
                class="btn ${buttonClass}" 
                onclick="updateStudent(this,'${escapeHtml(row.iid || '')}', ${targetActiveClass === null ? 'null' : `'${escapeHtml(targetActiveClass || '')}'`}, ${targetActiveSection === null ? 'null' : `'${escapeHtml(targetActiveSection || '')}'`}, ${targetActiveRoll === null ? 'null' : `'${escapeHtml(targetActiveRoll || '')}'`}, ${generatedStudentKey === null ? 'null' : `'${escapeHtml(generatedStudentKey || '')}' `})"
                ${isDisabled ? 'disabled' : ''}
              >
                ${buttonText}
              </button>
              <span class="update-status" id="status-${escapeHtml(row.iid || '')}"></span>
            </td>
          </tr>
        `;
        if (needsUpdate) {
          updateNeededRows.push(rowHtml);
        } else {
          upToDateRows.push(rowHtml);
        }
      });

      // Show update-needed first
      tbody.innerHTML = updateNeededRows.join('') + upToDateRows.join('');
      
      const totalStudents = data.length;
      showStatus(`Showing ${totalStudents} students · ${needsUpdateCount} need update`, 'ok');
      rowCountEl.textContent = `Total: ${totalStudents} students (${needsUpdateCount} need update)`;
    }

    async function updateStudent(button, iid, sessionClass, sessionSection, sessionRoll, studentKey, opts = {}) {
      const statusEl = document.getElementById(`status-${iid}`);
      if (!statusEl) {
        console.warn('Status element not found for iid', iid);
      }
      // Show confirmation only for direct user clicks (event.isTrusted === true)
      // For bulk updates we trigger button.click() programmatically (isTrusted === false) so we skip prompts.
      try {
        const rowData = allRowsCache.find(row => row.iid === iid) || {};
        if (!opts.skipConfirm && window.event && window.event.isTrusted) {
          // Build a human-readable list of changes that will occur
            const changes = [];
            const currentMap = {
              'Active Class': rowData.active_class,
              'Active Section': rowData.active_section,
              'Active Roll': rowData.active_roll,
              'Student Key': rowData.student_key
            };
            const targetMap = {
              'Active Class': sessionClass,
              'Active Section': sessionSection,
              'Active Roll': sessionRoll,
              'Student Key': studentKey
            };
            for (const label in currentMap) {
              const curVal = (currentMap[label] === null || currentMap[label] === undefined || currentMap[label] === '') ? '' : String(currentMap[label]);
              const newVal = (targetMap[label] === null || targetMap[label] === undefined || targetMap[label] === '') ? '' : String(targetMap[label]);
              if (curVal !== newVal) {
                changes.push(`${label}: '${curVal || '∅'}' → '${newVal || '∅'}'`);
              }
            }
            if (changes.length === 0) {
              // Nothing to change; just exit silently
              statusEl.textContent = 'Already up-to-date';
              statusEl.className = 'update-status success';
              setTimeout(()=>{ statusEl.textContent=''; }, 2500);
              return;
            }
            const confirmMsg = [
              `আইডি (IID): ${iid}`,
              'নিচের পরিবর্তনগুলি আপডেট হবে:',
              '',
              ...changes,
              '',
              'আপনি কি নিশ্চিত আপডেট করতে চান?'
            ].join('\n');
            if (!window.confirm(confirmMsg)) {
              return; // User cancelled
            }
        }
        // Proceed with update after confirmation (or skipped for bulk)
      } catch(confirmErr) {
        console.error('Confirmation build error:', confirmErr);
        // Fail safe: continue without blocking update
      }
      
      try {
        if (statusEl) {
          statusEl.textContent = 'Updating...';
          statusEl.className = 'update-status loading';
        }
        if (button) button.disabled = true;

        const updates = {
          active_class: sessionClass === null ? null : (sessionClass && sessionClass !== '' ? sessionClass : null),
          active_section: sessionSection === null ? null : (sessionSection && sessionSection !== '' ? sessionSection : null),
          active_roll: sessionRoll === null ? null : (sessionRoll && sessionRoll !== '' ? sessionRoll : null),
          student_key: studentKey === null ? null : (studentKey && studentKey !== '' ? studentKey : null)
        };

        const { data: updatedRows, error } = await supabaseClient
          .from(tableName)
          .update(updates)
          .eq('iid', iid)
          .select();

        if (error) throw new Error(error.message);
        const updatedRow = updatedRows && updatedRows[0];

        // Update success
        if (statusEl) {
          statusEl.textContent = 'Updated ✓';
          statusEl.className = 'update-status success';
        }
        if (button) {
          button.className = 'btn up-to-date';
          button.textContent = 'Up-to-date';
        }
        
        // Update local cache
        // rowData already fetched earlier (inside confirmation block). Fetch again only if not available.
        if (updatedRow) {
          const idx = allRowsCache.findIndex(r => String(r.iid) === String(iid));
          if (idx !== -1) allRowsCache[idx] = { ...allRowsCache[idx], ...updatedRow };
        } else {
          // Fallback local cache patch
          let rowDataForUpdate = allRowsCache.find(row => String(row.iid) === String(iid));
          if (rowDataForUpdate) {
            rowDataForUpdate.active_class = updates.active_class;
            rowDataForUpdate.active_section = updates.active_section;
            rowDataForUpdate.active_roll = updates.active_roll;
            rowDataForUpdate.student_key = updates.student_key;
          }
        }

        // Wait a moment to show the success message, then refresh
        if (!opts.deferRerender) {
          setTimeout(() => { filterAndRenderData(); }, 1200);
        }

        // Clear status message after 4 seconds
        if (statusEl) {
          setTimeout(() => { statusEl.textContent = ''; }, 4000);
        }

      } catch (error) {
        console.error('Update error:', error);
        if (statusEl) {
          statusEl.textContent = 'Failed ✗';
          statusEl.className = 'update-status error';
        }
        if (button) button.disabled = false;
      }
    }

    async function updateAllNeeded() {
      const updateButtons = Array.from(tbody.querySelectorAll('.btn.update-needed:not(:disabled)'));
      const updateAllBtn = document.getElementById('updateAllBtn');

      if (updateButtons.length === 0) {
        showStatus('No updates needed.', 'ok');
        return;
      }

      // Disable button & show progress
      if (updateAllBtn) {
        updateAllBtn.disabled = true;
        updateAllBtn.textContent = `Updating (${updateButtons.length})...`;
      }

      showStatus(`Updating ${updateButtons.length} students...`, 'loading');
      
      // Prepare all update promises and run them in parallel
      const promises = updateButtons.map(button => {
        const iid = button.closest('tr')?.getAttribute('data-iid');
        if (!iid) return Promise.resolve({ iid, ok: false });
        const rowData = allRowsCache.find(r => String(r.iid) === String(iid));
        if (!rowData) return Promise.resolve({ iid, ok: false });

        const targetSession = currentSession;
        const targetClass = rowData[`class_${targetSession}`];
        const targetSection = rowData[`section_${targetSession}`];
        const targetRoll = rowData[`roll_${targetSession}`];
        const fatherMobile = String(rowData.father_mobile_en || rowData.father_mobile || '').replace(/\D/g,'');
        let genKey = '';
        if (rowData.status !== 'TC') {
          if (fatherMobile.length >= 6) genKey = fatherMobile.slice(-6); else if (fatherMobile.length>0) genKey = fatherMobile;
        }

        return updateStudent(button, iid, rowData.status === 'TC' ? null : targetClass || null, rowData.status === 'TC' ? null : targetSection || null, rowData.status === 'TC' ? null : targetRoll || null, rowData.status === 'TC' ? null : (genKey || null), { skipConfirm:true, deferRerender:true })
          .then(ok => ({ iid, ok: !!ok }))
          .catch(err => { console.error('Bulk update error for', iid, err); return { iid, ok: false }; });
      });

      const results = await Promise.all(promises);
      const successCount = results.filter(r => r && r.ok).length;
      const failCount = results.length - successCount;

      // Single rerender after all done
      filterAndRenderData();

      showStatus(`Bulk update completed. ${successCount} updated, ${failCount} failed.`, 'ok');

      if (updateAllBtn) {
        updateAllBtn.disabled = false;
        updateAllBtn.textContent = 'Update All Needed';
      }
    }

    async function downloadCSV() {
      try {
        if (!currentSession || filteredSessionData.length === 0) {
          showStatus('No data to download. Please select a session first.', 'error');
          return;
        }

        const selectedClass = classFilter.value;
        const selectedSection = sectionFilter.value;

        // Apply current filters to data
        let exportData = filteredSessionData;
        
        if (selectedClass) {
          const sessionClassCol = `class_${currentSession}`;
          exportData = exportData.filter(row => String(row[sessionClassCol]) === String(selectedClass));
        }
        
        if (selectedSection) {
          const sessionSectionCol = `section_${currentSession}`;
          exportData = exportData.filter(row => String(row[sessionSectionCol]) === String(selectedSection));
        }

        if (exportData.length === 0) {
          showStatus('No data to download with current filters.', 'error');
          return;
        }

        // Filter out rows where iid, active_class, active_section, and active_roll are all empty
        exportData = exportData.filter(row => {
          const iid = row.iid;
          const activeClass = row.active_class;
          const activeSection = row.active_section;
          const activeRoll = row.active_roll;
          
          // Check if any of the fields are empty (null, undefined, or empty string)
          const isEmpty = (val) => val === null || val === undefined || val === '';
          
          // Keep row only if ALL four fields have values (exclude if ANY field is empty)
          return !isEmpty(iid) && !isEmpty(activeClass) && !isEmpty(activeSection) && !isEmpty(activeRoll);
        });

        if (exportData.length === 0) {
          showStatus('No valid data to download. All rows have empty required fields.', 'error');
          return;
        }

        // Custom headers for specific columns only
        const headers = [
          'iid', 'status', 'active_class', 'active_section', 'active_roll', 'session', 'student_name_en', 'student_key'
        ];

        const csvContent = [
          headers.join(','),
          ...exportData.map((row) => {
            const fatherMobile = String(row.father_mobile_en || row.father_mobile || '').replace(/\D/g, ''); // Remove non-digits
            let studentKey = '';
            if (fatherMobile.length >= 6) {
              studentKey = fatherMobile.slice(-6); // Preserves leading zeros like "003695"
            } else if (fatherMobile.length > 0) {
              studentKey = fatherMobile;
            }
            
            return [
              row.iid || '',
              row.status || '',
              row.active_class || '',
              row.active_section || '',
              row.active_roll || '',
              row.session || '',
              row.student_name_en || '',
              studentKey
            ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
          })
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `active_students_${currentSession}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showStatus('CSV downloaded successfully.', 'ok');

      } catch (error) {
        console.error('CSV download error:', error);
        showStatus('Failed to download CSV: ' + error.message, 'error');
      }
    }

    async function downloadJSON() {
      try {
        if (!currentSession || filteredSessionData.length === 0) {
          showStatus('No data to download. Please select a session first.', 'error');
          return;
        }

        const selectedClass = classFilter.value;
        const selectedSection = sectionFilter.value;

        // Apply current filters to data
        let exportData = filteredSessionData;
        
        if (selectedClass) {
          const sessionClassCol = `class_${currentSession}`;
          exportData = exportData.filter(row => String(row[sessionClassCol]) === String(selectedClass));
        }
        
        if (selectedSection) {
          const sessionSectionCol = `section_${currentSession}`;
          exportData = exportData.filter(row => String(row[sessionSectionCol]) === String(selectedSection));
        }

        if (exportData.length === 0) {
          showStatus('No data to download with current filters.', 'error');
          return;
        }

        // Filter out rows where any of the required fields are empty
        exportData = exportData.filter(row => {
          const iid = row.iid;
          const activeClass = row.active_class;
          const activeSection = row.active_section;
          const activeRoll = row.active_roll;
          
          // Check if any of the fields are empty (null, undefined, or empty string)
          const isEmpty = (val) => val === null || val === undefined || val === '';
          
          // Keep row only if ALL four fields have values (exclude if ANY field is empty)
          return !isEmpty(iid) && !isEmpty(activeClass) && !isEmpty(activeSection) && !isEmpty(activeRoll);
        });

        if (exportData.length === 0) {
          showStatus('No valid data to download. All rows have empty required fields.', 'error');
          return;
        }

        // Prepare JSON data with specific fields only
        const jsonData = exportData.map((row) => {
          const fatherMobile = String(row.father_mobile_en || row.father_mobile || '').replace(/\D/g, '');
          let studentKey = '';
          if (fatherMobile.length >= 6) {
            studentKey = fatherMobile.slice(-6);
          } else if (fatherMobile.length > 0) {
            studentKey = fatherMobile;
          }
          
          return {
            iid: row.iid || '',
            active_class: row.active_class || '',
            active_section: row.active_section || '',
            active_roll: row.active_roll || '',
            session: row.session || '',
            student_name_en: row.student_name_en || '',
            student_key: studentKey
          };
        });

        // Create JSON file
        const jsonContent = JSON.stringify(jsonData, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `active_students_${currentSession}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showStatus('JSON downloaded successfully.', 'ok');

      } catch (error) {
        console.error('JSON download error:', error);
        showStatus('Failed to download JSON: ' + error.message, 'error');
      }
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showStatus(message, type = 'ok') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
  </script>
</body>
</html>