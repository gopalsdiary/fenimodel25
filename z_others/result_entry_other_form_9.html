<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Result Entry - Others School</title>
  <style>
    :root { 
      --bg:#f6f8fa; 
      --card:#ffffff; 
      --border:#d0d7de; 
      --accent:#0366d6; 
      --accent-hover:#024c9e; 
      --danger:#d73a49; 
      --success:#1a7f37; 
      --warning:#ff8a00; 
      --radius:6px; 
      font-family:  system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; 
    }
    body { margin:0; background:var(--bg); color:#24292f; padding: 20px; }
    .wrap { 
      width:100%; 
      max-width:900px; 
      margin:0 auto 60px; 
      background:var(--card); 
      border:1px solid var(--border); 
      border-radius:var(--radius); 
      padding:24px; 
      box-shadow:0 2px 4px rgba(0,0,0,.04); 
    }
    h2 { font-size:22px; margin:0 0 8px 0; font-weight:600; color:#24292f; }
    p { font-size:14px; color:#6a737d; margin:0 0 20px 0; }
    .card-section { 
      margin:20px 0; 
      padding:16px; 
      border:1px solid var(--border); 
      background:var(--card); 
      border-radius:var(--radius); 
    }
    .form-group { margin-bottom:16px; }
    .form-group label { 
      display:block; 
      font-size:13px; 
      font-weight:600; 
      color:#555; 
      margin-bottom:6px; 
    }
    input[type=text], input[type=number], select { 
      width:100%; 
      padding:10px 12px; 
      border:1px solid var(--border); 
      border-radius:4px; 
      font-size:14px; 
      background:#fff; 
      font-family: inherit;
    }
    input[type=number]::-webkit-outer-spin-button, 
    input[type=number]::-webkit-inner-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] { -moz-appearance: textfield; appearance: textfield; }
    input:focus, select:focus { 
      outline:none; 
      border-color:var(--accent); 
      box-shadow:0 0 0 3px rgba(3,102,214,0.1); 
    }
    .row { display:flex; gap:16px; margin-bottom:16px; }
    .row .form-group { flex:1; margin-bottom:0; }
    button { 
      cursor:pointer; 
      font-size:14px; 
      padding:10px 20px; 
      border-radius:4px; 
      border:1px solid var(--accent); 
      background:var(--accent); 
      color:#fff; 
      font-weight:500; 
      font-family: inherit;
    }
    button:hover { background:var(--accent-hover); }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    button.success { background:var(--success); border-color:var(--success); }
    button.success:hover { background:#0f5132; }
    button.warning { background:var(--warning); border-color:var(--warning); }
    button.warning:hover { background:#e07000; }
    .status { font-size:13px; margin-top:8px; min-height:18px; }
    .status.ok { color:var(--success); font-weight:600; }
    .status.err { color:var(--danger); font-weight:600; }
    .note-danger { color:var(--danger); font-weight:700; }
    .subject-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    .subject-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      background: #fafbfc;
      display: grid;
      grid-template-columns: 200px repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      align-items: center;
    }
    .subject-card h4 {
      margin: 0;
      font-size: 14px;
      color: #0366d6;
      font-weight: 600;
      grid-column: 1;
    }
    .subject-card .form-group {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
    }
    .subject-card .form-group label {
      font-size: 11px;
      margin-bottom: 4px;
      font-weight: 600;
      color: #666;
    }
    .subject-card input {
      padding: 6px 8px;
      font-size: 13px;
    }
    .subject-card .readonly-field {
      padding: 6px 8px;
      font-size: 13px;
      min-height: auto;
    }
    .gpa-input {
      width: 84px;
      padding: 6px 8px;
      border-radius: 4px;
      text-align: center;
    }
    .readonly-field {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      border-radius: 4px;
      font-size: 14px;
      color: #374151;
      min-height: 38px;
      display: flex;
      align-items: center;
    }
    .gpa-display {
      font-weight: 700;
      color: var(--success);
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>üìä Result Entry - Others School</h2>
    <p>‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶¨‡¶ß‡¶æ‡¶®‡¶§‡¶æ ‡¶Ö‡¶¨‡¶≤‡¶Æ‡ßç‡¶¨‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá IID ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    <p class="note-danger">GPA ‡¶ò‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã‡¶§ ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>

    <!-- Step 1: Load Student by IID -->
    <div class="card-section" style="background:#f8fbff;">
      <h3 style="margin:0 0 12px 0; font-size:16px;">Step 1: Load Student Information</h3>
      <div class="row">
        <div class="form-group">
          <label for="iidInput">Enter IID</label>
          <input type="number" id="iidInput" placeholder="Enter student IID">
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button id="loadBtn">Load Student</button>
        </div>
      </div>
      <div id="loadStatus" class="status"></div>
    </div>

    <!-- Step 2: Student Info Display (Hidden initially) -->
    <div id="studentInfoSection" class="card-section" style="background:#fff9f0; display:none;">
      <h3 style="margin:0 0 12px 0; font-size:16px;">Step 2: Student Information</h3>
      <div class="row">
        <div class="form-group">
          <label>Student Name (English)</label>
          <div id="studentNameDisplay" class="readonly-field">-</div>
        </div>
        <div class="form-group">
          <label>Father Name (English)</label>
          <div id="fatherNameDisplay" class="readonly-field">-</div>
        </div>
        <div class="form-group">
          <label>Father Mobile</label>
          <div id="fatherMobileDisplay" class="readonly-field">-</div>
        </div>
        <div class="form-group">
          <label>Record Owner</label>
          <div id="studentOwnerDisplay" class="readonly-field">-</div>
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="class2025Input">Class</label>
          <input type="text" id="class2025Input" placeholder="e.g., Six">
        </div>
        <div class="form-group">
          <label for="section2025Input">Section </label>
          <input type="text" id="section2025Input" placeholder="e.g., Shapla">
        </div>
        <div class="form-group">
          <label for="roll2025Input">Roll </label>
          <input type="number" id="roll2025Input" placeholder="Roll number">
        </div>
        <div class="form-group">
          <label for="examNameYearInput">Exam Name/Year</label>
          <input type="text" id="examNameYearInput" placeholder="e.g., Half Yearly 2025">
        </div>
      </div>
      <button id="proceedBtn" class="success">Proceed to Marks Entry</button>
      <div id="proceedStatus" class="status"></div>
    </div>

    <!-- Step 3: Marks Entry (Hidden initially) -->
    <div id="marksEntrySection" class="card-section" style="background:#f0fff4; display:none;">
      <h3 style="margin:0 0 12px 0; font-size:16px;">Step 3: Enter Subject Marks</h3>
      <p style="margin:6px 0 0 0; font-size:13px; color:#555;">‡¶®‡ßã‡¶ü: ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá‡¶∞ <strong>Total</strong> ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ; ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶¨ ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡•§</p>
      
      <div id="subjectGrid" class="subject-grid">
        <!-- Subject cards are rendered dynamically by JavaScript from the SUBJECTS array -->
      </div>

      <div style="margin-top:24px; padding:16px; background:#f8fafc; border-radius:6px;">
        <h4 style="margin:0 0 12px 0;">üìä Overall Result</h4>
        <div class="row">
          <div class="form-group">
            <label>Total Marks</label>
            <div id="totalMarkDisplay" class="readonly-field" style="font-weight:700; font-size:18px;">0</div>
          </div>
          <div class="form-group">
            <label>Average</label>
            <div id="averageDisplay" class="readonly-field" style="font-weight:700; font-size:18px;">0</div>
          </div>
          <div class="form-group">
            <label>Final GPA</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input type="number" id="gpaFinalInput" class="gpa-input" step="0.01" min="0" max="5" placeholder="-" />
              <button id="gpaAutoBtn" type="button" class="warning" style="padding:6px 10px; font-size:13px;">Auto</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-section">
        <div class="row">
          <div class="form-group" style="flex:0 0 180px;">
            <label>Class Rank</label>
            <input type="number" id="class_rank" min="0" step="1" placeholder="" />
          </div>
          <div class="form-group" style="flex:1;">
            <label>Remark</label>
            <input type="text" id="remark" placeholder="" />
          </div>
        </div>
      </div>

      <div style="margin-top:20px; display:flex; gap:12px;">
        <button id="saveBtn" class="success">üíæ Save Result</button>
        <button id="clearBtn" class="warning">üîÑ Clear Form</button>
      </div>
      <div id="saveStatus" class="status"></div>

      <div style="margin-top:10px; max-width:420px;">
        <label style="font-size:13px; color:#555; font-weight:600; display:block; margin-bottom:6px;">Input User</label>
        <div id="inputUserDisplay" class="readonly-field" style="width:260px;">-</div>
      </div> 
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    // Use a global cache to avoid creating multiple GoTrueClient instances in the same browser context
    window.__supabaseClients = window.__supabaseClients || {};
    window.__supabaseClients[SUPABASE_URL] = window.__supabaseClients[SUPABASE_URL] || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const sb = window.__supabaseClients[SUPABASE_URL];

    // Require login: if no admin session, redirect to login page
    try{
      if(!localStorage.getItem('adminButton')){
        // replace so user can't go back to a protected page easily
        window.location.replace('index.html');
      }
    }catch(e){}

    const TABLE_STUDENT = 'student_database_others';
    const TABLE_EXAM = 'exam_9_10_other_school';

    // DOM Elements
    const iidInput = document.getElementById('iidInput');
    const loadBtn = document.getElementById('loadBtn');
    const loadStatus = document.getElementById('loadStatus');

    // Allow pressing Enter in the IID input to trigger the Load action
    try{ iidInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); loadBtn.click(); } }); }catch(e){}

    const studentInfoSection = document.getElementById('studentInfoSection');
    const studentNameDisplay = document.getElementById('studentNameDisplay');
    const fatherNameDisplay = document.getElementById('fatherNameDisplay');
    const class2025Input = document.getElementById('class2025Input');
    const section2025Input = document.getElementById('section2025Input');
    const roll2025Input = document.getElementById('roll2025Input');
    const examNameYearInput = document.getElementById('examNameYearInput');
    const proceedBtn = document.getElementById('proceedBtn');
    const proceedStatus = document.getElementById('proceedStatus');
    const marksEntrySection = document.getElementById('marksEntrySection');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveStatus = document.getElementById('saveStatus');
    const inputUserDisplay = document.getElementById('inputUserDisplay');

    // Show currently logged-in user (from localStorage 'adminButton')
    try{ if(inputUserDisplay) inputUserDisplay.textContent = localStorage.getItem('adminButton') || '-'; }catch(e){}

    let currentIID = null;
    let currentStudentData = null;
    // when true, user's manual edit of Final GPA should not be overwritten by auto-calc
    let finalGpaManual = false;

    // GPA Calculation Function
    function calculateGPA(marks) {
      if (marks === null || marks === undefined || isNaN(marks)) return null;
      const m = parseFloat(marks);
      if (m >= 80) return 5.0;
      if (m >= 70) return 4.0;
      if (m >= 60) return 3.5;
      if (m >= 50) return 3.0;
      if (m >= 40) return 2.0;
      if (m >= 33) return 1.0;
      return 0.0;
    }

    // Subjects definition and dynamic renderer
    const SUBJECTS = [
      { id: 'bangla1', db: '*Bangla 1st Paper', label: 'Bangla 1st Paper', parts: ['CQ','MCQ'], gpa: true },
      { id: 'bangla2', db: '*Bangla 2nd Paper', label: 'Bangla 2nd Paper', parts: ['CQ','MCQ'], gpa: false },
      { id: 'english1', db: '*English 1st Paper', label: 'English 1st Paper', parts: ['CQ'], gpa: true },
      { id: 'english2', db: '*English 2nd Paper', label: 'English 2nd Paper', parts: ['CQ'], gpa: false },
      { id: 'math', db: '*Mathematics', label: 'Mathematics', parts: ['CQ','MCQ'], gpa: true },
      { id: 'religion', db: '*Religion', label: 'Religion', parts: ['CQ','MCQ'], gpa: true },
      { id: 'science', db: '*Science', label: 'Science', parts: ['CQ','MCQ'], gpa: true },
      { id: 'ict', db: '*ICT', label: 'ICT', parts: ['MCQ','Practical'], gpa: true },
      { id: 'bgs', db: '*Bangladesh And Global Studies', label: 'Bangladesh And Global Studies', parts: ['CQ','MCQ'], gpa: true },
      { id: 'history', db: '*History', label: 'History', parts: ['CQ','MCQ'], gpa: true },
      { id: 'geography', db: '*Geography', label: 'Geography', parts: ['CQ','MCQ'], gpa: true },
      { id: 'civics', db: '*Civics', label: 'Civics', parts: ['CQ','MCQ'], gpa: true },
      { id: 'agriculture', db: '*Agriculture', label: 'Agriculture', parts: ['CQ','MCQ','Practical'], gpa: true },
      { id: 'physics', db: '*Physics', label: 'Physics', parts: ['CQ','MCQ','Practical'], gpa: true },
      { id: 'chemistry', db: '*Chemistry', label: 'Chemistry', parts: ['CQ','MCQ','Practical'], gpa: true },
      { id: 'biology', db: '*Biology', label: 'Biology', parts: ['CQ','MCQ','Practical'], gpa: true },
      { id: 'higher_math', db: '*Higher Mathematics', label: 'Higher Mathematics', parts: ['CQ','MCQ','Practical'], gpa: true },
      { id: 'accounting', db: '*Accounting', label: 'Accounting', parts: ['CQ','MCQ'], gpa: true },
      { id: 'finance', db: '*Finance And Banking', label: 'Finance And Banking', parts: ['CQ','MCQ'], gpa: true },
      { id: 'business', db: '*Business Entrepreneurship', label: 'Business Entrepreneurship', parts: ['CQ','MCQ'], gpa: true }
    ];

    function renderSubjectGrid() {
      const container = document.getElementById('subjectGrid');
      container.innerHTML = '';
      SUBJECTS.forEach(sub => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        let inner = `<h4>${sub.label}</h4>`;
        sub.parts.forEach(p => {
          const id = `${sub.id}_${p.toLowerCase()}`;
          inner += `\n  <div class="form-group">\n    <label>${p}</label>\n    <input type="number" id="${id}" min="0" max="100" step="0.01">\n  </div>`;
        });
        inner += `\n  <div class="form-group">\n    <label>Total</label>\n    <div id="${sub.id}_total" class="readonly-field">0</div>\n  </div>`;
        if(sub.gpa) {
          inner += `\n  <div class="form-group">\n    <label>GPA</label>\n    <input type="number" id="${sub.id}_gpa" class="gpa-input" step="0.01" min="0" max="5" placeholder="-" />\n  </div>`;
        }
        card.innerHTML = inner;
        container.appendChild(card);
      });
    }

    function setupAutoCalculations() {
      renderSubjectGrid();

      SUBJECTS.forEach(sub => {
        const parts = sub.parts.map(p => `${sub.id}_${p.toLowerCase()}`);
        const totalId = `${sub.id}_total`;
        const gpaId = sub.gpa ? `${sub.id}_gpa` : null;

        function recalc() {
          let sum = 0;
          parts.forEach(pid => { const v = parseFloat(document.getElementById(pid).value) || 0; sum += v; });
          document.getElementById(totalId).textContent = sum.toFixed(2);
          if (gpaId) {
            const g = calculateGPA(sum);
            document.getElementById(gpaId).value = g !== null ? g.toFixed(1) : '';
          }
          calculateOverall();
        }

        parts.forEach(pid => {
          try { document.getElementById(pid).addEventListener('input', recalc); }catch(e){}
        });
      });

      // keep manual GPA edits wired
      document.querySelectorAll('.gpa-input').forEach(el => el.addEventListener('input', () => { calculateOverall(); }));
    }

    // load subjects from DB into form
    function loadSubjectsToForm(examData) {
      SUBJECTS.forEach(sub => {
        sub.parts.forEach(p => {
          const key = sub.db + '_' + p;
          const el = document.getElementById(`${sub.id}_${p.toLowerCase()}`);
          if (el) el.value = examData[key] || '';
        });
        // set GPA if stored
        if (sub.gpa) {
          const gpakey = sub.db + '_GPA';
          try { document.getElementById(`${sub.id}_gpa`).value = examData[gpakey] || document.getElementById(`${sub.id}_gpa`).value || ''; }catch(e){}
        }
      });

      // trigger calculations
      SUBJECTS.forEach(sub => {
        sub.parts.forEach(p => { try{ document.getElementById(`${sub.id}_${p.toLowerCase()}`).dispatchEvent(new Event('input')); }catch(e){} });
      });
    }

    // gather subject fields for payload
    function gatherSubjectPayload() {
      const out = {};
      SUBJECTS.forEach(sub => {
        sub.parts.forEach(p => {
          const key = sub.db + '_' + p;
          const id = `${sub.id}_${p.toLowerCase()}`;
          const el = document.getElementById(id);
          out[key] = el ? (parseFloat(el.value) || null) : null;
        });
        out[sub.db + '_Total'] = parseFloat(document.getElementById(`${sub.id}_total`).textContent) || null;
        if (sub.gpa) out[sub.db + '_GPA'] = document.getElementById(`${sub.id}_gpa`).value || null;
      });
      return out;
    }

    // Calculate overall marks and GPA
    function calculateOverall() {
      const subjectTotals = [
        'bangla1_total','bangla2_total','english1_total','english2_total','math_total','religion_total','science_total','ict_total','bgs_total',
        'history_total','geography_total','civics_total','agriculture_total','physics_total','chemistry_total','biology_total','higher_math_total',
        'accounting_total','finance_total','business_total'
      ];

      let totalMark = 0;
      let filledCount = 0;
      subjectTotals.forEach(id => {
        const v = parseFloat(document.getElementById(id).textContent) || 0;
        if (v > 0) filledCount++;
        totalMark += v;
      });

      const average = filledCount > 0 ? (totalMark / filledCount) : 0;

      document.getElementById('totalMarkDisplay').textContent = totalMark.toFixed(2);
      document.getElementById('averageDisplay').textContent = average.toFixed(2);

      // Final GPA: average of any non-empty GPA inputs
      const gpaEls = Array.from(document.querySelectorAll('.gpa-input'));
      const gpas = gpaEls.map(el => parseFloat(el.value || '')).filter(g => !isNaN(g));
      const finalGPA = gpas.length > 0 ? (gpas.reduce((a,b) => a+b, 0) / gpas.length) : 0;
      const gEl = document.getElementById('gpaFinalInput');
      if (!finalGpaManual) {
        if (gEl) {
          gEl.value = finalGPA > 0 ? finalGPA.toFixed(2) : '';
          if (finalGPA > 0) gEl.classList.add('gpa-display'); else gEl.classList.remove('gpa-display');
        } else {
          document.getElementById('gpaFinalDisplay').textContent = finalGPA > 0 ? finalGPA.toFixed(2) : '-';
        }
      }
    }

    // Load Student by IID
    loadBtn.addEventListener('click', async () => {
      const iid = parseInt(iidInput.value);
      if (!iid || isNaN(iid)) {
        loadStatus.textContent = '‚ùå Please enter a valid IID';
        loadStatus.className = 'status err';
        return;
      }

      loadStatus.textContent = 'üîÑ Loading student data...';
      loadStatus.className = 'status';
      loadBtn.disabled = true;

      try {
        const { data, error } = await sb.from(TABLE_STUDENT).select('*').eq('iid', iid);
        
        if (error) {
          loadStatus.textContent = '‚ùå Error: ' + error.message;
          loadStatus.className = 'status err';
          loadBtn.disabled = false;
          return;
        }

        if (!data || data.length === 0) {
          loadStatus.textContent = '‚ùå No student found with this IID';
          loadStatus.className = 'status err';
          loadBtn.disabled = false;
          return;
        }

        const student = data[0];
        currentIID = iid;
        currentStudentData = student;

        studentNameDisplay.textContent = student.student_name_en || '-';
        fatherNameDisplay.textContent = student.father_name_en || '-';
        // show father's mobile beside name
        try{ document.getElementById('fatherMobileDisplay').textContent = student.father_mobile || '-'; }catch(e){}

        // Owner enforcement: show owner and only block edits when owner exists and differs from current user
        const currentUser = (function(){ try{ return localStorage.getItem('adminButton') || null; }catch(e){ return null; } })();
        try{ document.getElementById('studentOwnerDisplay').textContent = student.input_user_name || '-'; }catch(e){}

        let ownerConflict = false;
        try{
          const owner = student.input_user_name || null;
          // If owner exists and is not the current user, block edits. If owner is empty, allow any user to edit.
          if(owner && owner !== currentUser) {
            loadStatus.textContent = '‚ùå Not authorized to edit this student. Owned by: ' + owner;
            loadStatus.className = 'status err';
            ownerConflict = true;
            try{ document.getElementById('studentOwnerDisplay').textContent = owner; }catch(e){}
          }
        }catch(e){ console.error('Owner check failed', e); }

        // Disable proceed/save when owner conflict exists and hide Step 3 if conflict
        try{
          if(ownerConflict) {
            proceedBtn.disabled = true;
            saveBtn.disabled = true;
            try{ marksEntrySection.style.display = 'none'; }catch(e){}
          } else {
            proceedBtn.disabled = false;
            saveBtn.disabled = false;
          }
        }catch(e){}

        studentInfoSection.style.display = 'block';
        loadStatus.textContent = '‚úÖ Student loaded successfully!';
        loadStatus.className = 'status ok';
        loadBtn.disabled = false;

        // Try to load existing exam data
        await loadExistingExamData(iid);

      } catch (e) {
        loadStatus.textContent = '‚ùå Error: ' + e.message;
        loadStatus.className = 'status err';
        loadBtn.disabled = false;
      }
    });

    // Load existing exam data if available
    async function loadExistingExamData(iid) {
      try {
        const { data, error } = await sb.from(TABLE_EXAM).select('*').eq('iid', iid);
        
        if (!error && data && data.length > 0) {
          const examData = data[0];
          // Populate form with existing data
          class2025Input.value = examData.class_2025 || '';
          section2025Input.value = examData.section_2025 || '';
          roll2025Input.value = examData.roll_2025 || '';
          examNameYearInput.value = examData.exam_name_year || '';
          
          // Populate subject fields dynamically
          try{ loadSubjectsToForm(examData); }catch(e){ console.error('Error loading subjects', e); }

          // If DB stored a final GPA, prefer that and mark as manual override; otherwise allow auto-calc
          try{
            if (examData.gpa_final !== undefined && examData.gpa_final !== null) {
              try{ document.getElementById('gpaFinalInput').value = examData.gpa_final; document.getElementById('gpaFinalInput').classList.add('gpa-display'); }catch(e){}
              finalGpaManual = true;
            } else {
              finalGpaManual = false;
            }
          }catch(e){ finalGpaManual = false; }

          // Recalculate overall to account for any manual/DB GPA values
          try{ calculateOverall(); }catch(e){}

          // Populate class rank and remark if present
          try {
            document.getElementById('class_rank').value = examData.class_rank || '';
            document.getElementById('remark').value = examData.remark || '';
          } catch(e){}

          // Show marks entry only if the student owner is empty or matches current user
          try{
            const currentUser = (function(){ try{ return localStorage.getItem('adminButton') || null; }catch(e){ return null; } })();
            if (currentStudentData && currentStudentData.input_user_name && currentStudentData.input_user_name !== currentUser) {
              marksEntrySection.style.display = 'none';
              proceedStatus.textContent = '‚ùå You are not authorized to view marks entry (owned by: ' + currentStudentData.input_user_name + ')';
              proceedStatus.className = 'status err';
            } else {
              marksEntrySection.style.display = 'block';
              proceedStatus.textContent = '‚úÖ Existing data loaded!';
              proceedStatus.className = 'status ok';
            }
          }catch(e){
            // fallback: show the section
            marksEntrySection.style.display = 'block';
            proceedStatus.textContent = '‚úÖ Existing data loaded!';
            proceedStatus.className = 'status ok';
          }
        }
      } catch (e) {
        console.log('No existing exam data');
      }
    }

    // Proceed to marks entry
    proceedBtn.addEventListener('click', () => {
      const class2025 = class2025Input.value.trim();
      const section2025 = section2025Input.value.trim();
      const roll2025 = roll2025Input.value.trim();
      const examNameYear = examNameYearInput.value.trim();

      if (!class2025 || !section2025 || !roll2025 || !examNameYear) {
        proceedStatus.textContent = '‚ùå Please fill all fields';
        proceedStatus.className = 'status err';
        return;
      }

      // Authorization: check owner before showing marks entry
      const currentUser = (function(){ try{ return localStorage.getItem('adminButton') || null; }catch(e){ return null; } })();
      if(currentStudentData && currentStudentData.input_user_name && currentStudentData.input_user_name !== currentUser) {
        proceedStatus.textContent = '‚ùå Not authorized to proceed. Owned by: ' + currentStudentData.input_user_name;
        proceedStatus.className = 'status err';
        marksEntrySection.style.display = 'none';
        return;
      }

      marksEntrySection.style.display = 'block';
      proceedStatus.textContent = '‚úÖ Ready for marks entry!';
      proceedStatus.className = 'status ok';
    });

    // Save Result
    saveBtn.addEventListener('click', async () => {
      if (!currentIID) {
        saveStatus.textContent = '‚ùå Please load a student first';
        saveStatus.className = 'status err';
        return;
      }

      // Authorization check: only owner can save edits
      const currentUser = (function(){ try{ return localStorage.getItem('adminButton') || null; }catch(e){ return null; } })();
      try{
        if(currentStudentData && currentStudentData.input_user_name && currentStudentData.input_user_name !== currentUser) {
          saveStatus.textContent = '‚ùå You are not authorized to save for this student (owned by: ' + currentStudentData.input_user_name + ')';
          saveStatus.className = 'status err';
          return;
        }
      }catch(e){}

      saveStatus.textContent = 'üíæ Saving result...';
      saveStatus.className = 'status';
      saveBtn.disabled = true;

      const payload = {
        iid: currentIID,
        class_2025: class2025Input.value.trim(),
        section_2025: section2025Input.value.trim(),
        roll_2025: parseFloat(roll2025Input.value) || null,
        student_name_en: currentStudentData.student_name_en,
        father_name_en: currentStudentData.father_name_en,
        father_mobile: currentStudentData.father_mobile || null,
        exam_name_year: examNameYearInput.value.trim(),

        // subject fields are included dynamically below via gatherSubjectPayload()
        
        
        // dynamically include subject fields
        ...gatherSubjectPayload(),

        class_rank: parseFloat(document.getElementById('class_rank').value) || null,
        remark: document.getElementById('remark').value.trim() || null,

        // user who saved this entry (button_name stored as adminButton in localStorage)
        input_user_name: (function(){ try{ return localStorage.getItem('adminButton') || null; }catch(e){ return null; } })(),

        total_mark: parseFloat(document.getElementById('totalMarkDisplay').textContent) || null,
        average_mark: parseFloat(document.getElementById('averageDisplay').textContent) || null,
        gpa_final: (function(){ const el = document.getElementById('gpaFinalInput'); if (el) { return el.value !== '' ? parseFloat(el.value) : null; } const old = document.getElementById('gpaFinalDisplay'); return (old && old.textContent !== '-') ? parseFloat(old.textContent) : null; })()
      };

      try {
        const { data, error } = await sb.from(TABLE_EXAM).upsert(payload, { onConflict: 'iid' }).select();
        
        if (error) throw error;

        saveStatus.textContent = '‚úÖ Result saved successfully! Updated data shown above.';
        saveStatus.className = 'status ok';
        saveBtn.disabled = false;

      } catch (e) {
        saveStatus.textContent = '‚ùå Error saving: ' + e.message;
        saveStatus.className = 'status err';
        saveBtn.disabled = false;
      }
    });

    // Clear form
    clearBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all marks? Student information will be kept.')) {
        document.querySelectorAll('input[type=number]').forEach(inp => {
          if (inp.id !== 'iidInput' && inp.id !== 'roll2025Input') {
            inp.value = '';
          }
        });
        // also clear remark
        try{ document.getElementById('remark').value = ''; }catch(e){}
        // Trigger recalculation for all subject inputs
        try{
          SUBJECTS.forEach(sub => sub.parts.forEach(p => { try{ document.getElementById(`${sub.id}_${p.toLowerCase()}`).dispatchEvent(new Event('input')); }catch(e){} }));
        }catch(e){ try{ document.getElementById('bangla1_cq').dispatchEvent(new Event('input')); }catch(e){} }
        saveStatus.textContent = 'üîÑ Form cleared';
        saveStatus.className = 'status';
      }
    });

    // Final GPA manual/auto handling
    try {
      const gEl = document.getElementById('gpaFinalInput');
      const gAutoBtn = document.getElementById('gpaAutoBtn');
      if (gEl) {
        gEl.addEventListener('input', function(){ finalGpaManual = true; if (parseFloat(this.value) > 0) this.classList.add('gpa-display'); else this.classList.remove('gpa-display'); });
      }
      if (gAutoBtn) {
        gAutoBtn.addEventListener('click', function(){ finalGpaManual = false; calculateOverall(); try{ saveStatus.textContent = 'üîÑ Final GPA set to auto'; saveStatus.className='status'; }catch(e){} });
      }
    }catch(e){}

    // Initialize auto-calculations
    setupAutoCalculations();
  </script>
</body>
</html>
