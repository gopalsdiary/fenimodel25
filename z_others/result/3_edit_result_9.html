<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="/login/auth-check_copy.js"></script>
  <title>Result Entry - Others School</title>
  <style>
    :root { 
      --bg:#f6f8fa; 
      --card:#ffffff; 
      --border:#d0d7de; 
      --accent:#0366d6; 
      --accent-hover:#024c9e; 
      --danger:#d73a49; 
      --success:#1a7f37; 
      --warning:#ff8a00; 
      --radius:6px; 
      font-family:  system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; 
    }
    body { margin:0; background:var(--bg); color:#24292f; padding: 20px; }
    .wrap { 
      width:100%; 
      max-width:900px; 
      margin:0 auto 60px; 
      background:var(--card); 
      border:1px solid var(--border); 
      border-radius:var(--radius); 
      padding:24px; 
      box-shadow:0 2px 4px rgba(0,0,0,.04); 
    }
    h2 { font-size:22px; margin:0 0 8px 0; font-weight:600; color:#24292f; }
    p { font-size:14px; color:#6a737d; margin:0 0 20px 0; }
    .card-section { 
      margin:20px 0; 
      padding:16px; 
      border:1px solid var(--border); 
      background:var(--card); 
      border-radius:var(--radius); 
    }
    .form-group { margin-bottom:16px; }
    .form-group label { 
      display:block; 
      font-size:13px; 
      font-weight:600; 
      color:#555; 
      margin-bottom:6px; 
    }
    input[type=text], input[type=number], select { 
      width:100%; 
      padding:10px 12px; 
      border:1px solid var(--border); 
      border-radius:4px; 
      font-size:14px; 
      background:#fff; 
      font-family: inherit;
    }
    input[type=number]::-webkit-outer-spin-button, 
    input[type=number]::-webkit-inner-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] { -moz-appearance: textfield; appearance: textfield; }
    input:focus, select:focus { 
      outline:none; 
      border-color:var(--accent); 
      box-shadow:0 0 0 3px rgba(3,102,214,0.1); 
    }
    .row { display:flex; gap:16px; margin-bottom:16px; }
    .row .form-group { flex:1; margin-bottom:0; }
    button { 
      cursor:pointer; 
      font-size:14px; 
      padding:10px 20px; 
      border-radius:4px; 
      border:1px solid var(--accent); 
      background:var(--accent); 
      color:#fff; 
      font-weight:500; 
      font-family: inherit;
    }
    button:hover { background:var(--accent-hover); }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    button.success { background:var(--success); border-color:var(--success); }
    button.success:hover { background:#0f5132; }
    button.warning { background:var(--warning); border-color:var(--warning); }
    button.warning:hover { background:#e07000; }
    .status { font-size:13px; margin-top:8px; min-height:18px; }
    .status.ok { color:var(--success); font-weight:600; }
    .status.err { color:var(--danger); font-weight:600; }
    .note-danger { color:var(--danger); font-weight:700; }
    .subject-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    .subject-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      background: #fafbfc;
      display: grid;
      grid-template-columns: 200px repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      align-items: center;
    }
    .subject-card h4 {
      margin: 0;
      font-size: 14px;
      color: #0366d6;
      font-weight: 600;
      grid-column: 1;
    }
    .subject-card .form-group {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
    }
    .subject-card .form-group label {
      font-size: 11px;
      margin-bottom: 4px;
      font-weight: 600;
      color: #666;
    }
    .subject-card input {
      padding: 6px 8px;
      font-size: 13px;
    }
    .subject-card .readonly-field {
      padding: 6px 8px;
      font-size: 13px;
      min-height: auto;
    }
    .gpa-input {
      width: 84px;
      padding: 6px 8px;
      border-radius: 4px;
      text-align: center;
    }
    .readonly-field {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      border-radius: 4px;
      font-size: 14px;
      color: #374151;
      min-height: 38px;
      display: flex;
      align-items: center;
    }
    .gpa-display {
      font-weight: 700;
      color: var(--success);
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>üìä Result Entry - Others School</h2>
    <p>‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶¨‡¶ß‡¶æ‡¶®‡¶§‡¶æ ‡¶Ö‡¶¨‡¶≤‡¶Æ‡ßç‡¶¨‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá IID ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    <p class="note-danger">GPA ‡¶ò‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã‡¶§ ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>

    <!-- Step 1: Load Student by IID -->
    <div class="card-section" style="background:#f8fbff;">
      <h3 style="margin:0 0 12px 0; font-size:16px;">Step 1: Load Student Information</h3>
      <div class="row">
        <div class="form-group">
          <label for="iidInput">Enter IID</label>
          <input type="number" id="iidInput" placeholder="Enter student IID">
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button id="loadBtn">Load Student</button>
        </div>
      </div>
      <div id="loadStatus" class="status"></div>
    </div>

    <!-- Step 2: Student Info Display (Hidden initially) -->
    <div id="studentInfoSection" class="card-section" style="background:#fff9f0; display:none;">
      <h3 style="margin:0 0 12px 0; font-size:16px;">Step 2: Student Information</h3>
      <div class="row">
        <div class="form-group">
          <label>Student Name (English)</label>
          <div id="studentNameDisplay" class="readonly-field">-</div>
        </div>
        <div class="form-group">
          <label>Father Name (English)</label>
          <div id="fatherNameDisplay" class="readonly-field">-</div>
        </div>
        <div class="form-group">
          <label>Father Mobile</label>
          <div id="fatherMobileDisplay" class="readonly-field">-</div>
        </div>
        <div class="form-group">
          <label>Record Owner</label>
          <div id="studentOwnerDisplay" class="readonly-field">-</div>
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="class2025Input">Class</label>
          <input type="text" id="class2025Input" placeholder="e.g., Six">
        </div>
        <div class="form-group">
          <label for="section2025Input">Section </label>
          <input type="text" id="section2025Input" placeholder="e.g., Shapla">
        </div>
        <div class="form-group">
          <label for="roll2025Input">Roll </label>
          <input type="number" id="roll2025Input" placeholder="Roll number">
        </div>
        <div class="form-group">
          <label for="examNameYearInput">Exam Name/Year</label>
          <input type="text" id="examNameYearInput" placeholder="e.g., Half Yearly 2025">
        </div>
      </div>
      <button id="proceedBtn" class="success">Proceed to Marks Entry</button>
      <div id="proceedStatus" class="status"></div>
    </div>

    <!-- Step 3: Marks Entry (Hidden initially) -->
    <div id="marksEntrySection" class="card-section" style="background:#f0fff4; display:none;">
      <h3 style="margin:0 0 12px 0; font-size:16px;">Step 3: Enter Subject Marks</h3>
      
      <!-- All subjects displayed dynamically from Supabase exam table columns -->
      <div id="subjectGrid" class="subject-grid">
        <!-- will be populated dynamically from TABLE_EXAM columns -->
      </div>

      <div style="margin-top:24px; padding:16px; background:#f8fafc; border-radius:6px;">
        <h4 style="margin:0 0 12px 0;">üìä Overall Result</h4>
        <div class="row">
          <div class="form-group">
            <label>Total Marks</label>
            <div id="totalMarkDisplay" class="readonly-field" style="font-weight:700; font-size:18px;">0</div>
          </div>
          <div class="form-group">
            <label>Average</label>
            <div id="averageDisplay" class="readonly-field" style="font-weight:700; font-size:18px;">0</div>
          </div>
          <div class="form-group">
            <label>Final GPA</label>
            <div style="display:flex;gap:.5rem;align-items:center;">
              <input type="number" id="gpaFinalInput" class="gpa-input" step="0.01" min="0" max="5" placeholder="-" />
              <button type="button" id="gpaAutoBtn" class="btn" style="padding:6px 8px;border-radius:6px;background:#e2e8f0;color:#111;border:1px solid #cbd5e1;">Auto</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-section">
        <div class="row">
          <div class="form-group" style="flex:0 0 180px;">
            <label>Class Rank</label>
            <input type="number" id="class_rank" min="0" step="1" placeholder="" />
          </div>
          <div class="form-group" style="flex:1;">
            <label>Remark</label>
            <input type="text" id="remark" placeholder="" />
          </div>
        </div>
      </div>

      <div style="margin-top:20px; display:flex; gap:12px;">
        <button id="saveBtn" class="success">üíæ Save Result</button>
        <button id="clearBtn" class="warning">üîÑ Clear Form</button>
      </div>
      <div id="saveStatus" class="status"></div>

      <div style="margin-top:10px; max-width:420px;">
        <label style="font-size:13px; color:#555; font-weight:600; display:block; margin-bottom:6px;">Input User</label>
        <div id="inputUserDisplay" class="readonly-field" style="width:260px;">-</div>
      </div> 
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    // Use a global cache to avoid creating multiple GoTrueClient instances in the same browser context
    window.__supabaseClients = window.__supabaseClients || {};
    window.__supabaseClients[SUPABASE_URL] = window.__supabaseClients[SUPABASE_URL] || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const sb = window.__supabaseClients[SUPABASE_URL];
    // Require login: if no admin session, do NOT redirect; mark page to require login and show inline warning
    try{
      if(!localStorage.getItem('adminButton')){
        // Do not redirect ‚Äî set a flag that will be handled after DOM elements are available
        window.requireLogin = true;
      } else {
        window.requireLogin = false;
      }
    }catch(e){
      // On error, be conservative: require login
      window.requireLogin = true;
    }

    const TABLE_STUDENT = 'student_database_others';
    const TABLE_EXAM = 'exam_9_10_other_school';

    // DOM Elements
    const iidInput = document.getElementById('iidInput');
    const loadBtn = document.getElementById('loadBtn');
    const loadStatus = document.getElementById('loadStatus');

    // Allow pressing Enter in the IID input to trigger the Load action
    try{ iidInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); loadBtn.click(); } }); }catch(e){}

    const studentInfoSection = document.getElementById('studentInfoSection');
    const studentNameDisplay = document.getElementById('studentNameDisplay');
    const fatherNameDisplay = document.getElementById('fatherNameDisplay');
    const class2025Input = document.getElementById('class2025Input');
    const section2025Input = document.getElementById('section2025Input');
    const roll2025Input = document.getElementById('roll2025Input');
    const examNameYearInput = document.getElementById('examNameYearInput');
    const proceedBtn = document.getElementById('proceedBtn');
    const proceedStatus = document.getElementById('proceedStatus');
    const marksEntrySection = document.getElementById('marksEntrySection');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveStatus = document.getElementById('saveStatus');
    const inputUserDisplay = document.getElementById('inputUserDisplay');

    // Show currently logged-in user (from localStorage 'adminButton')
    try{ if(inputUserDisplay) inputUserDisplay.textContent = localStorage.getItem('adminButton') || '-'; }catch(e){}

    // If page is flagged as requiring login, show inline warning and disable load/save/proceed actions
    try{
      if(window.requireLogin){
        const warn = document.createElement('div');
        warn.style.background = '#fff4e5';
        warn.style.border = '1px solid #ffd39b';
        warn.style.padding = '10px';
        warn.style.margin = '0 0 12px 0';
        warn.style.borderRadius = '6px';
        warn.style.color = '#7a4a00';
        warn.innerHTML = '‚ö†Ô∏è <strong>Login required:</strong> You are not signed in. Loading/saving is disabled. <a href="/login/index.html?returnTo=' + encodeURIComponent(window.location.pathname + window.location.search) + '">Login</a>';
        const container = document.querySelector('.wrap') || document.body;
        container.insertBefore(warn, container.firstChild);
        try{ if(loadBtn) loadBtn.disabled = true; }catch(e){}
        try{ if(proceedBtn) proceedBtn.disabled = true; }catch(e){}
        try{ if(saveBtn) saveBtn.disabled = true; }catch(e){}

        // Additionally try to detect Supabase session and auto-enable if valid
        (async function tryDetectSession(){
          try{
            const client = (typeof sb !== 'undefined' && sb) || (window.__supabaseClients ? Object.values(window.__supabaseClients)[0] : null);
            if(client && client.auth && typeof client.auth.getSession === 'function'){
              const { data: { session }, error } = await client.auth.getSession();
              if(!error && session){
                try{ if(warn && warn.parentNode) warn.parentNode.removeChild(warn); }catch(e){}
                try{ if(loadBtn) loadBtn.disabled = false; }catch(e){}
                try{ if(proceedBtn) proceedBtn.disabled = false; }catch(e){}
                try{ if(saveBtn) saveBtn.disabled = false; }catch(e){}
                window.requireLogin = false;
                try{
                  const email = session.user && session.user.email;
                  if(email){
                    if(!localStorage.getItem('adminButton')) localStorage.setItem('adminButton', email);
                    if(inputUserDisplay) inputUserDisplay.textContent = localStorage.getItem('adminButton') || email;
                  }
                }catch(e){}
              }
            }
          }catch(e){ console.warn('Session detect failed', e); }
        })();
      }
    }catch(e){}

    let currentIID = null;
    let currentStudentData = null;
    // When user types final GPA manually this flag prevents auto overwrite
    let finalGpaManual = false;

    // GPA Calculation Function
    function calculateGPA(marks) {
      if (marks === null || marks === undefined || isNaN(marks)) return null;
      const m = parseFloat(marks);
      if (m >= 80) return 5.0;
      if (m >= 70) return 4.0;
      if (m >= 60) return 3.5;
      if (m >= 50) return 3.0;
      if (m >= 40) return 2.0;
      if (m >= 33) return 1.0;
      return 0.0;
    }

    // Auto-calculate totals and GPAs (safe: only attach listeners when elements exist)
    function setupAutoCalculations() {
      // Helper to attach safely
      function safeAttach(id, ev, cb){ const el = document.getElementById(id); if(el && typeof el.addEventListener === 'function') el.addEventListener(ev, cb); }

      // Bangla 1st Paper
      ['bangla1_cq','bangla1_mcq'].forEach(id => {
        safeAttach(id,'input', ()=>{
          const aEl = document.getElementById('bangla1_cq');
          const bEl = document.getElementById('bangla1_mcq');
          const a = aEl ? aEl.value : '';
          const b = bEl ? bEl.value : '';
          const hasAny = (a !== undefined && a !== null && String(a).trim() !== '') || (b !== undefined && b !== null && String(b).trim() !== '');
          if (!hasAny) {
            const t = document.getElementById('bangla1_total'); if(t) t.textContent = '';
            const g = document.getElementById('bangla1_gpa'); if(g) g.value = '';
            calculateOverall(); return;
          }
          const cq = parseFloat(a) || 0; const mcq = parseFloat(b) || 0; const total = cq + mcq;
          const t = document.getElementById('bangla1_total'); if(t) t.textContent = total.toFixed(2);
          const g = document.getElementById('bangla1_gpa'); if(g){ const gp = calculateGPA(total); g.value = gp !== null ? gp.toFixed(1) : ''; }
          calculateOverall();
        });
      });

      // Bangla 2nd Paper
      ['bangla2_cq','bangla2_mcq'].forEach(id => {
        safeAttach(id,'input', ()=>{
          const a = document.getElementById('bangla2_cq')?.value || '';
          const b = document.getElementById('bangla2_mcq')?.value || '';
          const hasAny = (a.trim() !== '') || (b.trim() !== '');
          const t = document.getElementById('bangla2_total');
          if(!hasAny){ if(t) t.textContent = ''; calculateOverall(); return; }
          const total = (parseFloat(a)||0) + (parseFloat(b)||0); if(t) t.textContent = total.toFixed(2); calculateOverall();
        });
      });

      // English 1st Paper
      safeAttach('english1_cq','input', ()=>{
        const v = document.getElementById('english1_cq')?.value || '';
        const t = document.getElementById('english1_total'); const g = document.getElementById('english1_gpa');
        if(v.trim() === ''){ if(t) t.textContent = ''; if(g) g.value = ''; calculateOverall(); return; }
        const cq = parseFloat(v)||0; if(t) t.textContent = cq.toFixed(2); if(g){ const gp = calculateGPA(cq); g.value = gp !== null ? gp.toFixed(1) : ''; } calculateOverall();
      });

      // English 2nd Paper
      safeAttach('english2_cq','input', ()=>{
        const v = document.getElementById('english2_cq')?.value || ''; const t = document.getElementById('english2_total');
        if(v.trim() === ''){ if(t) t.textContent = ''; calculateOverall(); return; }
        if(t) t.textContent = (parseFloat(v)||0).toFixed(2); calculateOverall();
      });

      // Mathematics
      ['math_cq','math_mcq'].forEach(id => {
        safeAttach(id,'input', ()=>{
          const a = document.getElementById('math_cq')?.value || '';
          const b = document.getElementById('math_mcq')?.value || '';
          const t = document.getElementById('math_total'); const g = document.getElementById('math_gpa');
          const hasAny = (a.trim() !== '') || (b.trim() !== ''); if(!hasAny){ if(t) t.textContent = ''; if(g) g.value = ''; calculateOverall(); return; }
          const total = (parseFloat(a)||0) + (parseFloat(b)||0); if(t) t.textContent = total.toFixed(2); if(g){ const gp = calculateGPA(total); g.value = gp !== null ? gp.toFixed(1) : ''; } calculateOverall();
        });
      });

      // Religion
      ['religion_cq','religion_mcq'].forEach(id => {
        safeAttach(id,'input', ()=>{
          const a = document.getElementById('religion_cq')?.value || '';
          const b = document.getElementById('religion_mcq')?.value || '';
          const t = document.getElementById('religion_total'); const g = document.getElementById('religion_gpa');
          const hasAny = (a.trim() !== '') || (b.trim() !== ''); if(!hasAny){ if(t) t.textContent = ''; if(g) g.value = ''; calculateOverall(); return; }
          const total = (parseFloat(a)||0) + (parseFloat(b)||0); if(t) t.textContent = total.toFixed(2); if(g){ const gp = calculateGPA(total); g.value = gp !== null ? gp.toFixed(1) : ''; } calculateOverall();
        });
      });

      // Science
      ['science_cq','science_mcq'].forEach(id => {
        safeAttach(id,'input', ()=>{
          const a = document.getElementById('science_cq')?.value || '';
          const b = document.getElementById('science_mcq')?.value || '';
          const t = document.getElementById('science_total'); const g = document.getElementById('science_gpa');
          const hasAny = (a.trim() !== '') || (b.trim() !== ''); if(!hasAny){ if(t) t.textContent = ''; if(g) g.value = ''; calculateOverall(); return; }
          const total = (parseFloat(a)||0) + (parseFloat(b)||0); if(t) t.textContent = total.toFixed(2); if(g){ const gp = calculateGPA(total); g.value = gp !== null ? gp.toFixed(1) : ''; } calculateOverall();
        });
      });

      // ICT
      ['ict_mcq','ict_practical'].forEach(id => {
        safeAttach(id,'input', ()=>{
          const a = document.getElementById('ict_mcq')?.value || '';
          const b = document.getElementById('ict_practical')?.value || '';
          const t = document.getElementById('ict_total'); const g = document.getElementById('ict_gpa');
          const hasAny = (a.trim() !== '') || (b.trim() !== ''); if(!hasAny){ if(t) t.textContent = ''; if(g) g.value = ''; calculateOverall(); return; }
          const total = (parseFloat(a)||0) + (parseFloat(b)||0); if(t) t.textContent = total.toFixed(2); if(g){ const gp = calculateGPA(total); g.value = gp !== null ? gp.toFixed(1) : ''; } calculateOverall();
        });
      });

      // BGS
      ['bgs_cq','bgs_mcq'].forEach(id => {
        safeAttach(id,'input', ()=>{
          const a = document.getElementById('bgs_cq')?.value || '';
          const b = document.getElementById('bgs_mcq')?.value || '';
          const t = document.getElementById('bgs_total'); const g = document.getElementById('bgs_gpa');
          const hasAny = (a.trim() !== '') || (b.trim() !== ''); if(!hasAny){ if(t) t.textContent = ''; if(g) g.value = ''; calculateOverall(); return; }
          const total = (parseFloat(a)||0) + (parseFloat(b)||0); if(t) t.textContent = total.toFixed(2); if(g){ const gp = calculateGPA(total); g.value = gp !== null ? gp.toFixed(1) : ''; } calculateOverall();
        });
      });

      // allow manual GPA edits to recalc final GPA
      Array.from(document.querySelectorAll('.gpa-input') || []).forEach(el => { try{ el.addEventListener('input', () => { calculateOverall(); }); }catch(e){} });
    }

    // Calculate overall marks and GPA
    function calculateOverall() {
      // Sum all subject totals (dynamic)
      const totalEls = Array.from(document.querySelectorAll('[id$="_total"]'));
      let totalMark = 0;
      let filledCount = 0;
      totalEls.forEach(el => {
        let t = '';
        try{
          if(el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') t = String(el.value).trim(); else t = String(el.textContent).trim();
        }catch(e){ t = String(el.textContent || '').trim(); }
        if (t !== '') {
          const v = parseFloat(t) || 0;
          totalMark += v;
          filledCount++;
        }
      });

      if (filledCount > 0) {
        document.getElementById('totalMarkDisplay').textContent = totalMark.toFixed(2);
        document.getElementById('averageDisplay').textContent = (totalMark / filledCount).toFixed(2);
      } else {
        document.getElementById('totalMarkDisplay').textContent = '';
        document.getElementById('averageDisplay').textContent = '';
      }

      // Calculate final GPA (average of provided GPAs dynamically)
      const gpaEls = Array.from(document.querySelectorAll('[id$="_gpa"]'));
      const gpas = gpaEls.map(el => {
        try{ const v = el.value; const n = parseFloat(v); return !isNaN(n) ? n : null; }catch(e){ return null; }
      }).filter(g => g !== null);

      const finalGPA = gpas.length > 0 ? (gpas.reduce((a, b) => a + b, 0) / gpas.length) : 0;
      const gpi = document.getElementById('gpaFinalInput');
      if (gpi) {
        if (!finalGpaManual) {
          gpi.value = finalGPA > 0 ? finalGPA.toFixed(2) : '';
        }
      } else {
        try{ document.getElementById('gpaFinalDisplay').textContent = finalGPA > 0 ? finalGPA.toFixed(2) : '-'; }catch(e){}
      }
    }

    // === Dynamic subjects helpers ===
    // SUBJECT_MAP: { 'Bangla 1st Paper': { CQ: '*Bangla 1st Paper_CQ', MCQ: '*Bangla 1st Paper_MCQ', GPA: '*Bangla 1st Paper_GPA', Total: '*Bangla 1st Paper_Total' } }
    const SUBJECT_MAP = {};
    const DYNAMIC_SUBJECTS = [];
    function sanitizeForId(s){ return String(s||'').replace(/\*/g,'').trim().toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]/g,'_').replace(/_+/g,'_').replace(/^_|_$/g,''); }

    function parseAndBuildSubjectsFromRow(row){
      // build SUBJECT_MAP from a single row's keys (very tolerant: tries splitting on last token, then regex fallback)
      try{
        const TOKENS = ['CQ','WRITTEN','MCQ','CA','PRACTICAL','PRAC','PRACT','TOTAL','GPA'];
        Object.keys(row||{}).forEach(h => {
          const orig = String(h);
          const clean = orig.replace(/\*/g,'').trim();

          // Attempt 1: split by separators and check last token
          let subject = null;
          let comp = null;
          const parts = clean.split(/[_\s-]+/);
          if(parts.length > 1){
            const last = parts[parts.length - 1].toUpperCase();
            if(TOKENS.includes(last)){
              comp = last;
              subject = parts.slice(0, -1).join(' ').trim();
            }
          }

          // Attempt 2: regex fallback (captures trailing component)
          if(!subject){
            const m = clean.match(/^(.*?)(?:[_\s-]+)?(CQ|WRITTEN|MCQ|CA|PRACTICAL|PRAC|Practical|Total|GPA)$/i);
            if(m){ subject = m[1].trim(); comp = m[2].toUpperCase(); }
          }

          // If still not recognized, skip this header
          if(!subject) return;

          // normalize synonyms
          if(comp === 'CA') comp = 'MCQ';
          if(comp === 'PRAC' || comp === 'PRACT') comp = 'PRACTICAL';
          if(comp === 'TOTAL') comp = 'TOTAL';

          SUBJECT_MAP[subject] = SUBJECT_MAP[subject] || {};
          SUBJECT_MAP[subject][comp] = h; // store original header name

          // Keep legacy 'Total' key for compatibility with older code paths
          if(comp === 'TOTAL') SUBJECT_MAP[subject]['Total'] = h;
        });

        // Convert to sorted list
        DYNAMIC_SUBJECTS.length = 0;
        Object.keys(SUBJECT_MAP).sort((a,b)=> a.localeCompare(b)).forEach(s => DYNAMIC_SUBJECTS.push(s));

        if(DYNAMIC_SUBJECTS.length === 0) {
          console.warn('No subjects detected from sample row. Headers:', Object.keys(row || {}));
          const det = document.getElementById('detectedSubjects'); if(det) det.textContent = 'No subjects detected from exam table. Please check the table columns (e.g., "*Subject_CQ", "*Subject_MCQ", etc.).';
          const container = document.getElementById('subjectGrid'); if(container) container.innerHTML = '';
        } else {
          buildSubjectGrid(DYNAMIC_SUBJECTS);
          updateDetectedSubjectsUI(DYNAMIC_SUBJECTS);
        }
      }catch(e){ console.error('parse subjects failed', e); }
    }

    async function buildSubjectGridFromSample(){
      try{
        const { data, error } = await sb.from(TABLE_EXAM).select('*').limit(1);
        if(!error && data && data.length>0){
          parseAndBuildSubjectsFromRow(data[0]);
        } else {
          const det = document.getElementById('detectedSubjects'); if(det) det.textContent = 'No sample exam row found; subjects not detected.';
        }

        // Log detected subjects for debugging
        if(DYNAMIC_SUBJECTS.length === 0) {
          console.warn('No subjects detected from exam table.');
        } else {
          console.log('Detected subjects:', DYNAMIC_SUBJECTS.map(s => s.replace(/^\*+\s*/,'')).join(', '));
        }
      }catch(e){
        console.warn('Could not fetch sample exam row for subjects', e);
        try{ buildSubjectGrid(DEFAULT_SUBJECTS); }catch(e2){}
      }
    }

    function buildSubjectGrid(subjects){
      const container = document.getElementById('subjectGrid');
      if(!container) return;
      container.innerHTML = '';

      subjects.forEach(sub => {
        const comps = SUBJECT_MAP[sub] || {};
        const sid = sanitizeForId(sub);
        const card = document.createElement('div');
        card.className = 'subject-card';

        const h4 = document.createElement('h4'); h4.textContent = sub.replace(/^\*+\s*/,''); card.appendChild(h4);

        function addField(labelText, id, attrs){
          const fg = document.createElement('div'); fg.className = 'form-group';
          const label = document.createElement('label'); label.textContent = labelText; fg.appendChild(label);
          let field;
          if(attrs && attrs.readonly){ field = document.createElement('div'); field.id = id; field.className = 'readonly-field'; } else { field = document.createElement('input'); field.type = 'number'; field.id = id; field.step = '0.01'; if(attrs && attrs.min !== undefined) field.min = attrs.min; if(attrs && attrs.max !== undefined) field.max = attrs.max; }
          if(attrs && attrs.dataKey) field.setAttribute('data-key', attrs.dataKey);
          fg.appendChild(field); card.appendChild(fg);
          return field;
        }

        // Always show all standard fields for every subject
        const cqHeader = comps['CQ'] || comps['WRITTEN'];
        const mcqHeader = comps['MCQ'];
        const prHeader = comps['PRACTICAL'];
        const gpaHeader = comps['GPA'];
        const totalHeader = comps['TOTAL'] || comps['Total'];

        // Always create all fields (whether database column exists or not)
        const cqEl = addField('CQ', sid + '_cq', { dataKey: cqHeader });
        const mcqEl = addField('MCQ', sid + '_mcq', { dataKey: mcqHeader });
        const prEl = addField('Practical', sid + '_practical', { dataKey: prHeader });
        const totalEl = addField('Total', sid + '_total', { dataKey: totalHeader });
        const gpaEl = addField('GPA', sid + '_gpa', { dataKey: gpaHeader });

        // Attach listeners
        function onInput(){
          const a = cqEl ? parseFloat(cqEl.value) || 0 : 0;
          const b = mcqEl ? parseFloat(mcqEl.value) || 0 : 0;
          const c = prEl ? parseFloat(prEl.value) || 0 : 0;
          const hasAny = (cqEl && String(cqEl.value).trim()!=='') || (mcqEl && String(mcqEl.value).trim()!=='') || (prEl && String(prEl.value).trim()!=='');
          if(!hasAny){ if(totalEl && totalEl.tagName === 'INPUT') totalEl.value = ''; else if(totalEl) totalEl.textContent = ''; if(gpaEl) gpaEl.value = ''; calculateOverall(); return; }
          const total = a + b + c;
          if(totalEl && totalEl.tagName === 'INPUT') totalEl.value = total.toFixed(2); else if(totalEl) totalEl.textContent = total.toFixed(2);
          if(gpaEl){ const g = calculateGPA(total); gpaEl.value = g !== null ? g.toFixed(1) : ''; }
          calculateOverall();
        }
        if(cqEl) cqEl.addEventListener('input', onInput);
        if(mcqEl) mcqEl.addEventListener('input', onInput);
        if(prEl) prEl.addEventListener('input', onInput);

        // When user types into Total directly, update GPA
        try{ if(totalEl && totalEl.tagName === 'INPUT') totalEl.addEventListener('input', ()=>{ const t = parseFloat(totalEl.value) || 0; if(gpaEl){ const g = calculateGPA(t); gpaEl.value = g !== null ? g.toFixed(1) : ''; } calculateOverall(); }); }catch(e){}
        if(gpaEl) gpaEl.addEventListener('input', ()=>{ calculateOverall(); });
      });
      // After building, update detection summary UI
      try{ updateDetectedSubjectsUI(subjects); }catch(e){}
    }

    function updateDetectedSubjectsUI(subjects){
      try{
        const det = document.getElementById('detectedSubjects'); if(!det) return;
        if(!subjects || subjects.length === 0){ det.textContent = 'No subjects detected from exam table.'; return; }
        det.innerHTML = subjects.map(s=>{ const comps = Object.keys(SUBJECT_MAP[s]||{}).join(', '); return `<div style="margin-top:4px">${String(s).replace(/^\*+\s*/,'')} ‚Äî <small style="color:#666">${comps}</small></div>`}).join('');
      }catch(e){}
    }

    function ensureSubjectGrid(){
      try{
        const container = document.getElementById('subjectGrid');
        if(!container) return;
        const hasCards = container.querySelector('.subject-card');
        const det = document.getElementById('detectedSubjects');
        if(!hasCards){
          if(det) det.textContent = 'No subjects detected yet. Ensure the exam table has subject columns and reload.';
        } else {
          // update detected subjects UI to reflect current map
          updateDetectedSubjectsUI(DYNAMIC_SUBJECTS);
        }
      }catch(e){}
    }

    function populateSubjectValues(examData){
      try{
        if(!examData) return;
        Object.keys(SUBJECT_MAP).forEach(sub => {
          const sid = sanitizeForId(sub);
          const comps = SUBJECT_MAP[sub] || {};
          const cqKey = comps['CQ'] || comps['WRITTEN'];
          if(cqKey && document.getElementById(sid + '_cq')){ const v = examData[cqKey]; if(v !== undefined && v !== null) document.getElementById(sid + '_cq').value = v; }
          if(comps['MCQ'] && document.getElementById(sid + '_mcq')){ const v = examData[comps['MCQ']]; if(v !== undefined && v !== null) document.getElementById(sid + '_mcq').value = v; }
          if(comps['PRACTICAL'] && document.getElementById(sid + '_practical')){ const v = examData[comps['PRACTICAL']]; if(v !== undefined && v !== null) document.getElementById(sid + '_practical').value = v; }
          if((comps['TOTAL'] || comps['Total']) && document.getElementById(sid + '_total')){
            const key = comps['TOTAL'] || comps['Total']; const v = examData[key];
            try{
              const el = document.getElementById(sid + '_total');
              if(v !== undefined && v !== null){
                if(el.tagName === 'INPUT') el.value = (isNaN(parseFloat(v)) ? String(v) : parseFloat(v).toFixed(2)); else el.textContent = (isNaN(parseFloat(v)) ? String(v) : parseFloat(v).toFixed(2));
              }
            }catch(e){}
          }
          if(comps['GPA'] && document.getElementById(sid + '_gpa')){ const v = examData[comps['GPA']]; if(v !== undefined && v !== null) document.getElementById(sid + '_gpa').value = v; }
        });

        // Trigger recalculation for all subjects
        Object.keys(SUBJECT_MAP).forEach(sub => {
          const sid = sanitizeForId(sub);
          try{ const cqEl = document.getElementById(sid + '_cq'); if(cqEl) cqEl.dispatchEvent(new Event('input')); }catch(e){}
          try{ const mcqEl = document.getElementById(sid + '_mcq'); if(mcqEl) mcqEl.dispatchEvent(new Event('input')); }catch(e){}
          try{ const prEl = document.getElementById(sid + '_practical'); if(prEl) prEl.dispatchEvent(new Event('input')); }catch(e){}
        });

        // Recalculate overall after populating all subjects
        setTimeout(() => { try{ calculateOverall(); }catch(e){} }, 100);
      }catch(e){ console.error('populate dynamic subjects failed', e); }
    }

    // Try to build subject grid at startup
    try{ buildSubjectGridFromSample(); }catch(e){}
    try{ ensureSubjectGrid(); }catch(e){}

    // Load Student by IID
    loadBtn.addEventListener('click', async () => {
      const iid = parseInt(iidInput.value);
      if (!iid || isNaN(iid)) {
        loadStatus.textContent = '‚ùå Please enter a valid IID';
        loadStatus.className = 'status err';
        return;
      }

      loadStatus.textContent = 'üîÑ Loading student data...';
      loadStatus.className = 'status';
      loadBtn.disabled = true;

      try {
        const { data, error } = await sb.from(TABLE_STUDENT).select('*').eq('iid', iid);
        
        if (error) {
          loadStatus.textContent = '‚ùå Error: ' + error.message;
          loadStatus.className = 'status err';
          loadBtn.disabled = false;
          return;
        }

        if (!data || data.length === 0) {
          loadStatus.textContent = '‚ùå No student found with this IID';
          loadStatus.className = 'status err';
          loadBtn.disabled = false;
          return;
        }

        const student = data[0];
        currentIID = iid;
        currentStudentData = student;

        studentNameDisplay.textContent = student.student_name_en || '-';
        fatherNameDisplay.textContent = student.father_name_en || '-';
        // show father's mobile beside name
        try{ document.getElementById('fatherMobileDisplay').textContent = student.father_mobile || '-'; }catch(e){}

        // Show owner (no blocking) ‚Äî editing allowed for any user regardless of owner
        try{ document.getElementById('studentOwnerDisplay').textContent = student.input_user_name || '-'; }catch(e){ }

        // Ensure proceed and save buttons are enabled for editing
        try{ proceedBtn.disabled = false; saveBtn.disabled = false; }catch(e){}

        // No owner-based restrictions: keep proceed and save enabled
        try{ proceedBtn.disabled = false; saveBtn.disabled = false; }catch(e){}

        studentInfoSection.style.display = 'block';
        loadStatus.textContent = '‚úÖ Student loaded successfully!';
        loadStatus.className = 'status ok';
        loadBtn.disabled = false;

        // Try to load existing exam data
        await loadExistingExamData(iid);

      } catch (e) {
        loadStatus.textContent = '‚ùå Error: ' + e.message;
        loadStatus.className = 'status err';
        loadBtn.disabled = false;
      }
    });

    // Load existing exam data if available
    async function loadExistingExamData(iid) {
      try {
        const { data, error } = await sb.from(TABLE_EXAM).select('*').eq('iid', iid);
        
        if (!error && data && data.length > 0) {
          const examData = data[0];
          // Populate form with existing data
          class2025Input.value = examData.class_2025 || '';
          section2025Input.value = examData.section_2025 || '';
          roll2025Input.value = examData.roll_2025 || '';
          examNameYearInput.value = examData.exam_name_year || '';
          
          // Populate marks using dynamic subject mapping
          populateSubjectValues(examData);

          // Recalculate overall to account for any manual/DB GPA values
          try{ calculateOverall(); }catch(e){}

          // Populate class rank and remark if present
          try {
            document.getElementById('class_rank').value = examData.class_rank || '';
            document.getElementById('remark').value = examData.remark || '';
          } catch(e){}

          // Populate input user and overall stored fields if present (override calculated values when available)
          try{
            if(examData.input_user_name) {
              inputUserDisplay.textContent = examData.input_user_name;
              // also keep currentStudentData in sync
              if(currentStudentData) currentStudentData.input_user_name = examData.input_user_name;
            }
            if(examData.total_mark != null) document.getElementById('totalMarkDisplay').textContent = parseFloat(examData.total_mark).toFixed(2);
            if(examData.average_mark != null) document.getElementById('averageDisplay').textContent = parseFloat(examData.average_mark).toFixed(2);
            try {
              const gpi = document.getElementById('gpaFinalInput');
              if (gpi) {
                if (examData.gpa_final != null && examData.gpa_final !== '') {
                  gpi.value = parseFloat(examData.gpa_final).toFixed(2);
                  finalGpaManual = true; // Respect DB-stored final GPA as a manual override
                } else {
                  finalGpaManual = false;
                }
              } else if (examData.gpa_final != null && examData.gpa_final !== '') {
                document.getElementById('gpaFinalDisplay').textContent = parseFloat(examData.gpa_final).toFixed(2);
                finalGpaManual = true;
              } else {
                finalGpaManual = false;
              }
            } catch(e) { console.error('set gpa_final failed', e); }
          }catch(e){console.error('populate overall fields failed',e);}

          // Show marks entry and indicate existing data was loaded
          try{
            marksEntrySection.style.display = 'block';
            proceedStatus.textContent = '‚úÖ Existing data loaded!';
            proceedStatus.className = 'status ok';
            try{ ensureSubjectGrid(); }catch(e){}
          }catch(e){
            // fallback: show the section
            marksEntrySection.style.display = 'block';
            proceedStatus.textContent = '‚úÖ Existing data loaded!';
            proceedStatus.className = 'status ok';
            try{ ensureSubjectGrid(); }catch(e){}
          }
        }
      } catch (e) {
        console.log('No existing exam data');
      }
    }

    // Proceed to marks entry
    proceedBtn.addEventListener('click', () => {
      const class2025 = class2025Input.value.trim();
      const section2025 = section2025Input.value.trim();
      const roll2025 = roll2025Input.value.trim();
      const examNameYear = examNameYearInput.value.trim();

      if (!class2025 || !section2025 || !roll2025 || !examNameYear) {
        proceedStatus.textContent = '‚ùå Please fill all fields';
        proceedStatus.className = 'status err';
        return;
      }

      // Proceed allowed regardless of record owner ‚Äî editing permitted for any user
      // (Owner displayed for traceability but does not block editing) 

      // Ensure subject cards list is up-to-date
      try{ ensureSubjectGrid(); }catch(e){}

      marksEntrySection.style.display = 'block';
      proceedStatus.textContent = '‚úÖ Ready for marks entry!';
      proceedStatus.className = 'status ok';
    });

    // Save Result
    saveBtn.addEventListener('click', async () => {
      if (!currentIID) {
        saveStatus.textContent = '‚ùå Please load a student first';
        saveStatus.className = 'status err';
        return;
      }

      // Helper parsers to preserve explicit zeros while treating empty inputs as null
    function numValue(id){ try{ const el=document.getElementById(id); if(!el) return null; const v=el.value; return (v !== undefined && String(v).trim() !== '') ? parseFloat(v) : null; }catch(e){ return null; } }
    function textNumValue(id){ try{ const el=document.getElementById(id); if(!el) return null; const t=String(el.textContent).trim(); return t !== '' ? parseFloat(t) : null; }catch(e){ return null; } }

    // Saving allowed for all users (owner info retained for audit)

      saveStatus.textContent = 'üíæ Saving result...';
      saveStatus.className = 'status';
      saveBtn.disabled = true;

      const payload = {
        iid: currentIID,
        class_2025: class2025Input.value.trim(),
        section_2025: section2025Input.value.trim(),
        roll_2025: (function(){ const v = roll2025Input.value; return (v !== undefined && String(v).trim() !== '') ? parseFloat(v) : null; })(),
        student_name_en: currentStudentData.student_name_en,
        father_name_en: currentStudentData.father_name_en,
        father_mobile: currentStudentData.father_mobile || null,
        exam_name_year: examNameYearInput.value.trim(),
        
       
        class_rank: (function(){ const v = document.getElementById('class_rank').value; return (v !== undefined && String(v).trim() !== '') ? parseFloat(v) : null; })(),
        remark: document.getElementById('remark').value.trim() || null,

        // user who saved this entry (button_name stored as adminButton in localStorage)
        input_user_name: (function(){ try{ return localStorage.getItem('adminButton') || null; }catch(e){ return null; } })(),

        total_mark: (function(){ const t = String(document.getElementById('totalMarkDisplay').textContent).trim(); return t !== '' ? parseFloat(t) : null; })(),
        average_mark: (function(){ const t = String(document.getElementById('averageDisplay').textContent).trim(); return t !== '' ? parseFloat(t) : null; })(),
        gpa_final: (function(){ const el = document.getElementById('gpaFinalInput'); return el && el.value !== '' ? parseFloat(el.value) : null; })()
      };

      // Merge dynamic subject fields collected from SUBJECT_MAP into the payload
      try{
        Object.keys(SUBJECT_MAP||{}).forEach(function(sub){
          const comps = SUBJECT_MAP[sub] || {};
          const sid = sanitizeForId(sub);
          if(comps['CQ'] || comps['WRITTEN']) payload[comps['CQ'] || comps['WRITTEN']] = numValue(sid + '_cq');
          if(comps['MCQ']) payload[comps['MCQ']] = numValue(sid + '_mcq');
          if(comps['PRACTICAL']) payload[comps['PRACTICAL']] = numValue(sid + '_practical');
          // Prefer normalized TOTAL key but accept legacy 'Total' as fallback
          if(comps['TOTAL'] || comps['Total']) payload[(comps['TOTAL'] || comps['Total'])] = numValue(sid + '_total');
          if(comps['GPA']) payload[comps['GPA']] = (function(){ const el = document.getElementById(sid + '_gpa'); return el && el.value !== '' ? parseFloat(el.value) : null; })();
        });
      }catch(e){ console.error('Failed to merge dynamic subjects into payload', e); }

      try {
        const { data, error } = await sb.from(TABLE_EXAM).upsert(payload, { onConflict: 'iid' }).select();
        
        if (error) throw error;

        saveStatus.textContent = '‚úÖ Result saved successfully! Updated data shown above.';
        saveStatus.className = 'status ok';
        saveBtn.disabled = false;

      } catch (e) {
        saveStatus.textContent = '‚ùå Error saving: ' + e.message;
        saveStatus.className = 'status err';
        saveBtn.disabled = false;
      }
    });

    // Clear form
    clearBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all marks? Student information will be kept.')) {
        document.querySelectorAll('input[type=number]').forEach(inp => {
          if (inp.id !== 'iidInput' && inp.id !== 'roll2025Input') {
            inp.value = '';
          }
        });
        // also clear remark
        try{ document.getElementById('remark').value = ''; }catch(e){}
        // reset manual final-gpa override and clear input if present
        try{ finalGpaManual = false; const gpi = document.getElementById('gpaFinalInput'); if(gpi) gpi.value = ''; }catch(e){}
        // Trigger recalculation
        document.getElementById('bangla1_cq').dispatchEvent(new Event('input'));
        saveStatus.textContent = 'üîÑ Form cleared';
        saveStatus.className = 'status';
      }
    });

    // Initialize auto-calculations
    setupAutoCalculations();

    // Wire Final GPA editable behavior: typing sets manual override, 'Auto' reverts to calculated
    try{
      const gpi = document.getElementById('gpaFinalInput');
      const gpaAuto = document.getElementById('gpaAutoBtn');
      if(gpi) gpi.addEventListener('input', ()=>{ finalGpaManual = true; });
      if(gpaAuto) gpaAuto.addEventListener('click', ()=>{ finalGpaManual = false; calculateOverall(); });
    }catch(e){ console.error('GPA input handlers failed', e); }

    // Auto-load IID from URL if present (accepts '‡¶á‡¶á‡¶¶', 'IID' or 'iid')
    (function autoLoadFromURL(){
      try{
        const params = new URLSearchParams(window.location.search);
        const keys = ['‡¶á‡¶á‡¶¶','IID','iid'];
        for(const k of keys){
          if(params.has(k)){
            const v = params.get(k);
            const n = Number(v);
            if(v && !isNaN(n)){
              iidInput.value = String(v);
              // trigger the same load behavior as clicking the Load button
              loadBtn.click();
            }
            break;
          }
        }
      }catch(e){console.error('Auto load failed',e);}    
    })();
  </script>
</body>
</html>
