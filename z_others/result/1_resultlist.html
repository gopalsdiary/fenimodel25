<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result Processing System - 2025 (fmhs.edu.bd)/</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add security headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <script src="/login/auth-check_copy.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts & Responsive styles inspired by with-typescript layout -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{ --brand:#1976D2; --accent:#2e7d32; --muted:#6b7280; --card-bg:#fff; --page-bg:#f6f8fa; --radius:12px }
        html,body{height:100%;margin:0;padding:0;font-family:Inter, 'Segoe UI', Roboto, Arial, sans-serif;background:var(--page-bg);color:#111}
        .header{text-align:center;padding:18px 12px;background:linear-gradient(180deg,#fff,#fbfdff);border-bottom:1px solid rgba(0,0,0,0.04)}
        .header h1{margin:0;font-size:1.3rem;font-weight:800;color:var(--brand)}
        .header p{margin:6px 0 0;color:var(--muted)}

        .container{max-width:980px;margin:18px auto;padding:12px}

        /* Search & filters */
        .search-box{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;margin-bottom:10px;box-sizing:border-box}
        .search-box:focus{outline:none;box-shadow:0 6px 20px rgba(25,118,210,0.08);border-color:rgba(25,118,210,0.6)}
        select.search-box{max-width:220px;margin-right:8px}

        .actions-row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:8px}

        /* Student list - single-row list (desktop) */
        .student-list{display:grid;grid-template-columns:1fr;gap:10px}
        .student-card{background:var(--card-bg);border-radius:10px;padding:12px 14px;border:1px solid rgba(0,0,0,0.04);box-shadow:0 6px 18px rgba(2,6,23,0.04);transition:transform .14s ease,box-shadow .14s ease;cursor:pointer;display:flex;flex-direction:row;align-items:center;gap:14px}
        .student-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(2,6,23,0.08)}
        .student-card h3{margin:0;font-size:1.05rem}
        .student-info{flex:1;min-width:0}
        .student-info p{margin:2px 0;color:var(--muted);font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

        .card-footer{display:flex;gap:.6rem;align-items:center;justify-content:flex-end;margin-top:0}
        .student-action{color:var(--brand);font-weight:700;margin-right:8px}

        /* Mobile: stack into column again */
        @media (max-width:640px){
            .student-list{grid-template-columns:1fr}
            .student-card{flex-direction:column;align-items:flex-start;gap:8px}
            .student-action{margin-right:0}
            .student-info p{white-space:normal;overflow:visible;text-overflow:unset}
        }

        /* Approval & Edit button styles */
        .approval-btn{padding:8px 10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;cursor:pointer;font-weight:700;font-size:0.95rem}
        .approval-btn.approved{background:#e8f5e9;border-color:#c8e6c9;color:var(--accent)}
        .approval-btn.not-approved{background:#fff7e6;border-color:#ffe0b2;color:#ef6c00}
        .edit-btn{padding:8px 10px;border-radius:8px;border:1px solid #e1f0ff;background:#eaf6ff;color:var(--brand);cursor:pointer;font-weight:700;font-size:0.95rem}
        .edit-btn:hover{box-shadow:0 6px 16px rgba(25,118,210,0.08)}

        /* Count box */
        .data-count{border-radius:8px;padding:10px;background:#fff;border:1px solid rgba(0,0,0,0.03);box-shadow:0 6px 16px rgba(2,6,23,0.03)}

        /* Empty / Loading states */
        .loading, .error{text-align:center;padding:34px 16px;font-size:1.05rem}

        /* Responsive tweaks */
        @media (max-width:640px){
            .container{padding:10px}
            .student-card{padding:12px}
            .student-info p{font-size:0.9rem}
            select.search-box{max-width:48%}
        }

        /* Print tweaks */
        @media print{
            body{background:#fff}
            .student-card{page-break-inside:avoid}
            .search-box,.approval-btn{display:none}
        }
    </style>
</head>
<body oncontextmenu="return false;" onselectstart="return false;" oncopy="return false;">
    <div class="header">
        <h1>Feni Model High School</h1>
        <p> Other School Examination Report Card</p>
    </div>

    <div class="container">
      
        <input type="text" id="searchBox" class="search-box" placeholder="Search by Name, Roll, IID, or Mobile" oninput="filterStudentList()">
        
        <!-- New filter options -->
        <select id="classFilter" class="search-box" onchange="filterStudentList()">
            <option value="">All Classes</option>
            <!-- Add class options dynamically -->
        </select>
        <select id="shiftFilter" class="search-box" onchange="filterStudentList()">
            <option value="">All Sections</option>
            <!-- Add shift options dynamically -->
        </select>
        
        <div id="studentList" class="student-list"></div>
        <div id="dataCount" class="data-count" style="text-align: center; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; color: #666;">
            <p id="countText">Loading student data...</p>
        </div>
        <div id="marksheet" style="display: none;">
            <div class="marksheet" id="marksheetContent"></div>
            <button class="back-btn" style="margin-top: 0.5rem;" onclick="showStudentList()">← Back to List</button>
        </div>
    </div>
    <script>

// Supabase setup
const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let students = [];
let headers = [];
let SUBJECT_MAP = {};
let authenticatedStudents = new Set();

function cleanHeaderKey(h){
    if(!h) return '';
    return String(h)
        .replace(/\*/g,'')
        .replace(/"/g,'')
        .toLowerCase()
        .trim()
        .replace(/\s+/g,'_')
        .replace(/[^\w_]/g,'_')
        .replace(/_+/g,'_')
        .replace(/^_|_$/g,'');
}

function normalizeRow(row, rawHeaders){
    const out = {};
    const seen = new Set();
    const cols = Array.isArray(rawHeaders) && rawHeaders.length ? rawHeaders : Object.keys(row||{});
    cols.forEach(h=>{
        const cleanKey = cleanHeaderKey(h);
        if(!cleanKey || seen.has(cleanKey)) return;
        seen.add(cleanKey);
        let v;
        if(row && Object.prototype.hasOwnProperty.call(row,h)) v = row[h];
        else if(row && Object.prototype.hasOwnProperty.call(row, h?.toLowerCase?.())) v = row[h.toLowerCase()];
        else if(row && Object.prototype.hasOwnProperty.call(row, h?.toUpperCase?.())) v = row[h.toUpperCase()];
        else v = '';
        out[cleanKey] = (v===null||v===undefined) ? '' : String(v).trim();
    });
    return out;
}

async function loadData() {
    try {
        // Load data from Supabase table
        const { data, error } = await supabaseClient
            .from('exam_others_school')
            .select('*');

        if (error) throw error;

        if (!data || data.length === 0) {
            document.getElementById('countText').innerHTML = `
                <strong style="color: #d32f2f;">No student data found</strong><br>
                <small>Please check the Supabase table "pre_test_2025"</small>
            `;
            return;
        }

        // Derive headers from the table columns of first row
        headers = Object.keys(data[0]);
        // Normalize and order student objects to match headers order
        students = data.map(row => normalizeRow(row, headers));

        if (students.length === 0) {
            document.getElementById('countText').innerHTML = `
                <strong style="color: #d32f2f;">No student data found</strong><br>
                <small>Please check the Supabase table and try again</small>
            `;
            return;
        }

        // Dynamically generate SUBJECT_MAP
        generateSubjectMap(headers);

        console.log('Total students loaded:', students.length);
        renderStudentList();
        renderClassAndShiftOptions();
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('countText').innerHTML = `
            <strong style="color: #d32f2f;">Error loading data</strong><br>
            <small>Please check console for more details</small>
        `;
        alert('ডেটা লোড করতে সমস্যা হয়েছে!');
    }
}

function generateSubjectMap(headers) {
    // First collect all subjects and their column indices
    const subjectColumns = {};
    
    // List of non-subject columns to exclude
    const excludeColumns = ['fail+gpa', 'gpa', 'total', 'rank', 'remark', 'mobile', 'password', 'class_2025', 'shift_2025', 'sms', 'absent', 'fail count', 'gpa/remark'];
    
    headers.forEach((header, index) => {
        const cleanHeader = header.replace(/\*/g, '').trim();
        
        // Skip non-subject columns
        if (excludeColumns.some(exclude => cleanHeader.toLowerCase().includes(exclude.toLowerCase()))) {
            return;
        }
        
        const match = cleanHeader.match(/^(.*?)(_CQ|_WRITTEN|_MCQ|_CA|_Practical|_Total|_GPA)$/i);
        if (match) {
            const subject = match[1];
            const component = match[2];
            
            // Skip if subject name is too generic or in exclude list
            if (excludeColumns.some(exclude => subject.toLowerCase().includes(exclude.toLowerCase()))) {
                return;
            }
            
            if (!subjectColumns[subject]) {
                subjectColumns[subject] = {};
            }
            subjectColumns[subject][component] = index;
        }
    });

    // Check if subject has any valid data (not empty, not "-", and not just whitespace)
    function hasValidData(subject) {
        const indices = Object.values(subjectColumns[subject] || {});
        if (indices.length === 0) return false;
        
        // Check data in all rows for this subject's columns
        for (let student of students) {
            for (let index of indices) {
                const value = (Object.values(student)[index] || '').toString().trim();
                // If we find any non-empty value that's not "-", consider it valid
                if (value && value !== '-' && value !== '0' && value.toLowerCase() !== 'fail') {
                    return true;
                }
            }
        }
        return false;
    }

    // Only include subjects that have valid data
    const validSubjects = Object.keys(subjectColumns).filter(hasValidData);
    
    validSubjects.forEach(subject => {
        SUBJECT_MAP[subject] = {
            CQ: headers.find(h => /_(CQ|WRITTEN)\b/i.test(h) && h.startsWith(subject)) || '',
            MCQ: headers.find(h => h.includes(`${subject}_MCQ`)) || '',
            Practical: headers.find(h => h.includes(`${subject}_Practical`)) || '',
            Total: headers.find(h => h.includes(`${subject}_Total`)) || '',
            GPA: headers.find(h => h.includes(`${subject}_GPA`)) || ''
        };
    });
}

function renderStudentList() {
    const container = document.getElementById('studentList');
    container.innerHTML = '';

    const initialStudents = students.slice(0, 201); // Show first 201 students initially

    initialStudents.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card';
        const isApproved = ['1','true','t','yes','y'].includes(String(student.result_approval||'').toLowerCase());
        card.innerHTML = `
            <h3>${student.student_name_en || 'N/A'}</h3>
            <div class="student-info">
                <p>Roll: ${student.roll_2025 || 'N/A'}</p>
                <p>IID: ${student.iid || 'N/A'}</p>
                <p>Class: ${student.class_2025 || 'N/A'}</p>
                <p>Input by: ${student.input_user_name || student.input_user || 'N/A'}</p>
            </div>
            <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between;">
                <div style="display:flex;gap:.5rem;align-items:center;">
                    <div class="student-action">View Result →</div>
                    <button class="edit-btn" onclick="editStudent(event,'${student.iid}')">Edit</button>
                </div>
                <button class="${isApproved ? 'approval-btn approved' : 'approval-btn not-approved'}" onclick="toggleApproval(event,'${student.iid}', this)">${isApproved ? 'Approved' : 'Not approved'}</button>
            </div>
        `;
        card.onclick = () => showMarksheet(student);
        container.appendChild(card);
    });

    const comment = document.createElement('p');
    comment.textContent = 'দ্রুত কাজ করার জন্য , রোল/নাম লিখে খুঁজুন এবং মোবাইল নাম্বার (শেষ ৭টি সংখ্যা) দিয়ে ফলাফল দেখুন।';
    comment.style.textAlign = 'center';
    comment.style.marginTop = '1rem';
    container.appendChild(comment);
    
    // Update data count
    updateDataCount(initialStudents.length, students.length);
}

function filterStudentList() {
    const query = document.getElementById('searchBox').value.toLowerCase();
    const classFilter = document.getElementById('classFilter').value;
    const shiftFilter = document.getElementById('shiftFilter').value;

    const filteredStudents = students.filter(student => {
        // Use normalized field names present in the CSV/table
        const name = (student.student_name_en || student.name || '').toString().toLowerCase();
        const roll = (student.roll_2025 || student.roll || '').toString().toLowerCase();
        const iid = (student.iid || '').toString().toLowerCase();
        const mobile = (student.mobile || '').toString().toLowerCase();

        const matchesQuery = (!!name && name.includes(query)) ||
                             (!!roll && roll.includes(query)) ||
                             (!!iid && iid.includes(query)) ||
                             (!!mobile && mobile.includes(query));

        const matchesClass = !classFilter || (student.class_2025 === classFilter || student.class === classFilter);
        const studentSection = (student.section_2025 || student.shift_2025 || student.section || '').toString();
        const matchesShift = !shiftFilter || studentSection === shiftFilter;

        return matchesQuery && matchesClass && matchesShift;
    });

    // Sort by numeric Roll ascending when filtering
    const toRoll = s => {
        if(!s) return Number.POSITIVE_INFINITY;
        const m = String(s).match(/\d+/);
        return m ? parseInt(m[0],10) : Number.POSITIVE_INFINITY;
    };
    const sorted = filteredStudents.slice().sort((a,b)=>{
        const ra = toRoll(a.roll_2025 || a.roll);
        const rb = toRoll(b.roll_2025 || b.roll);
        if(ra !== rb) return ra - rb;
        return ( (a.student_name_en || a.name || '') ).localeCompare( (b.student_name_en || b.name || '') );
    });

    renderFilteredStudentList(sorted);
}

function renderFilteredStudentList(filteredStudents) {
    const container = document.getElementById('studentList');
    container.innerHTML = '';

    filteredStudents.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card';
        const isApproved = ['1','true','t','yes','y'].includes(String(student.result_approval||'').toLowerCase());
        card.innerHTML = `
            <h3>${student.student_name_en || student.name || 'N/A'}</h3>
            <div class="student-info">
                <p>Roll: ${student.roll_2025 || 'N/A'}</p>
                <p>IID: ${student.iid || 'N/A'}</p>
                <p>Class: ${student.class_2025 || 'N/A'}</p>
                <p>Input by: ${student.input_user_name || student.input_user || 'N/A'}</p>
            </div>
            <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between;">
                <div style="display:flex;gap:.5rem;align-items:center;">
                    <div class="student-action">View Result →</div>
                    <button class="edit-btn" onclick="editStudent(event,'${student.iid}')">Edit</button>
                </div>
                <button class="${isApproved ? 'approval-btn approved' : 'approval-btn not-approved'}" onclick="toggleApproval(event,'${student.iid}', this)">${isApproved ? 'Approved' : 'Not approved'}</button>
            </div>
        `;
        card.onclick = () => showMarksheet(student);
        container.appendChild(card);
    });
    
    // Update data count for filtered results
    updateDataCount(filteredStudents.length, students.length);
}

function renderClassAndShiftOptions() {
    // Use the normalized fields used in rendering: class_2025 and section_2025
    const classValues = students.map(s => s.class_2025).filter(Boolean);
    const sectionValues = students.map(s => s.section_2025 || s.shift_2025 || s.section).filter(Boolean);

    const uniqueSorted = arr => Array.from(new Set(arr.map(x=>String(x).trim()))).filter(Boolean).sort((a,b)=>{
        // try numeric compare first
        const an = parseInt(a,10); const bn = parseInt(b,10);
        if(!isNaN(an) && !isNaN(bn)) return an - bn;
        return a.localeCompare(b);
    });

    const classList = uniqueSorted(classValues);
    const sectionList = uniqueSorted(sectionValues);

    const classFilter = document.getElementById('classFilter');
    classList.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        classFilter.appendChild(option);
    });

    const shiftFilter = document.getElementById('shiftFilter');
    sectionList.forEach(shift => {
        const option = document.createElement('option');
        option.value = shift;
        option.textContent = shift;
        shiftFilter.appendChild(option);
    });
}

function isTrueVal(v){ return ['1','true','t','yes','y'].includes(String(v||'').toLowerCase()); }

async function toggleApproval(e, iid, btn){
    // prevent list item click
    if(e && e.stopPropagation) e.stopPropagation();
    if(!iid) return;
    btn.disabled = true;
    const idx = students.findIndex(s => String(s.iid) === String(iid));
    const cur = idx>-1 ? students[idx].result_approval : null;
    const newVal = !isTrueVal(cur);
    try{
        const { data, error } = await supabaseClient
            .from('exam_others_school')
            .update({ result_approval: newVal })
            .eq('iid', iid)
            .select()
            .single();
        if(error) throw error;
        // update local cache
        if(idx>-1 && data){
            students[idx] = normalizeRow(data, headers);
        } else if(idx>-1){
            students[idx].result_approval = newVal;
        }
        btn.disabled = false;
        btn.className = newVal ? 'approval-btn approved' : 'approval-btn not-approved';
        btn.textContent = newVal ? 'Approved' : 'Not approved';
    }catch(err){
        btn.disabled = false;
        alert('Update failed: '+(err.message||err));
        console.error(err);
    }
}

function editStudent(e, iid){
    if(e && e.stopPropagation) e.stopPropagation();
    if(!iid) return;
    // Navigate to edit page with Bangla query param name
    window.location.href = `3_edit_result.html?iid=${encodeURIComponent(iid)}`;
}

function showMarksheet(student) {
    // Redirect to detailed result page with IID parameter
    const iid = student.iid || 'unknown';
    window.location.href = `2_details_result.html?IID=${encodeURIComponent(iid)}`;
}

function showStudentList() {
    document.getElementById('searchBox').style.display = 'block';
    document.getElementById('classFilter').style.display = 'block';
    document.getElementById('shiftFilter').style.display = 'block';
    document.getElementById('studentList').style.display = 'block';
    document.getElementById('marksheet').style.display = 'none';
}

function updateDataCount(displayedCount, totalCount) {
    const countElement = document.getElementById('countText');
    if (countElement) {
        if (displayedCount === totalCount) {
            countElement.innerHTML = `
                <strong>Total Students: ${totalCount}</strong><br>
                <small>Displaying all ${displayedCount} students</small>
            `;
        } else {
            countElement.innerHTML = `
                <strong>Showing: ${displayedCount} of ${totalCount} students</strong><br>
                <small>Use search or filters to narrow down results</small>
            `;
        }
    }
}

// Initialize
loadData();

    </script>
</body>
</html>
