<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Teacher</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./auth-check_copy.js"></script>

  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f6f8fa;color:#24292f;}
    header{background:#0d1117;color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;}
    h1{margin:0;font-size:20px;font-weight:600;}
    a.back{color:#58a6ff;text-decoration:none;font-size:13px;}
    a.back:hover{text-decoration:underline;}
    .wrap{max-width:1200px;margin:24px auto 80px;background:#fff;padding:22px 26px 40px;border:1px solid #d0d7de;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.05);}    
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px 20px;}
    .grid.wide{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));}
    label{display:block;font-size:11px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:#57606a;margin:0 0 4px;}
    input,textarea{width:100%;box-sizing:border-box;padding:8px 9px;border:1px solid #d0d7de;border-radius:5px;font-size:13px;background:#fff;}
    input:focus,textarea:focus{outline:2px solid #84c5ff;outline-offset:0;}
    textarea{min-height:90px;resize:vertical;}
    .readonly{background:#f3f4f6;}
    .actions{margin-top:28px;display:flex;gap:12px;flex-wrap:wrap;}
    button{cursor:pointer;padding:9px 18px;border-radius:5px;border:1px solid #0366d6;background:#0366d6;color:#fff;font-size:14px;font-weight:600;}
    button:hover{background:#024c9e;}
    button.outline{background:#fff;color:#0366d6;}
    button.outline:hover{background:#e7f3ff;}
    .status{margin-top:12px;font-size:14px;min-height:22px;}
    .status.ok{color:#1a7f37;} .status.err{color:#d73a49;}
    .two-col{display:flex;flex-wrap:wrap;gap:26px;margin-top:20px;}
    .panel{flex:1 1 460px;min-width:360px;background:#fafbfc;padding:16px 18px 22px;border:1px solid #d8dee4;border-radius:6px;}
    .panel h2{margin:0 0 14px;font-size:16px;font-weight:600;}
    .photo-preview{width:120px;height:120px;border:1px solid #d0d7de;border-radius:6px;object-fit:cover;background:#fff;margin-top:4px;cursor:pointer;}
    .photo-preview:hover{opacity:0.9;box-shadow:0 2px 8px rgba(0,0,0,0.15);}
    .muted{color:#57606a;font-size:12px;}
    .photo-upload-wrapper{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .upload-btn{padding:6px 12px;font-size:12px;background:#10b981;border-color:#10b981;color:#fff;}
    .upload-btn:hover{background:#0d9f74;}
    .view-btn{padding:6px 12px;font-size:12px;background:#0366d6;border-color:#0366d6;color:#fff;}
    .view-btn:hover{background:#024c9e;}
    
    /* Upload Modal */
    .upload-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;}
    .upload-modal.active{display:flex;}
    .modal-content{background:#fff;border-radius:8px;padding:24px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.3);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #e5e7eb;}
    .modal-header h3{margin:0;font-size:18px;}
    .modal-close{background:transparent;border:none;font-size:28px;color:#6b7280;cursor:pointer;padding:0;width:32px;height:32px;line-height:1;}
    .modal-close:hover{color:#000;}
    .upload-area{border:2px dashed #d0d7de;border-radius:8px;padding:30px;text-align:center;background:#fafbfc;cursor:pointer;transition:all 0.2s;}
    .upload-area:hover{border-color:#0366d6;background:#f0f6ff;}
    .upload-area.dragover{border-color:#0366d6;background:#e7f3ff;}
    .preview-container{margin-top:16px;display:none;}
    .preview-image{max-width:100%;max-height:300px;border:1px solid #d0d7de;border-radius:6px;}
    .loading{display:none;text-align:center;color:#0366d6;margin-top:12px;}
  </style>
</head>
<body>
  <header>
    <h1>Edit Teacher</h1>
    <a class="back" href="teacherlist.html">‚Üê Back to list</a>
  </header>
  <div class="wrap">
    <div id="loadStatus" class="status"></div>
    <form id="teacherForm" autocomplete="off"></form>
    <div class="actions">
      <button type="button" id="saveBtn">Save Changes</button>
      <button type="button" class="outline" id="backBtn">Back</button>
    </div>
    <div id="formStatus" class="status"></div>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="upload-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Upload Photo</h3>
        <button class="modal-close" onclick="closeUploadModal()">&times;</button>
      </div>
      <div class="upload-area" id="uploadArea">
        <div style="font-size:48px;margin-bottom:10px;">üì∑</div>
        <p style="margin:0 0 8px;font-weight:500;">Click or drag photo here</p>
        <p class="muted">Supported: JPG, PNG (Max 5MB)</p>
        <input type="file" id="photoInput" accept="image/jpeg,image/jpg,image/png" style="display:none;">
      </div>
      <div class="preview-container" id="previewContainer">
        <img id="previewImage" class="preview-image" alt="Preview">
      </div>
      <div class="loading" id="uploadLoading">
        <div style="font-size:24px;margin-bottom:8px;">‚è≥</div>
        <div>Uploading...</div>
      </div>
      <div class="status" id="uploadStatus"></div>
      <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" class="outline" onclick="closeUploadModal()">Cancel</button>
        <button type="button" class="upload-btn" id="confirmUploadBtn" style="display:none;" onclick="confirmUpload()">Upload</button>
      </div>
    </div>
  </div>

<script>
const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
const TABLE='teacher_database';

// ImgBB Configuration
const IMGBB_API_KEY = 'c555ef879d5e6891f2ba5fcf6c9b2c6e';
const IMGBB_UPLOAD_URL = 'https://api.imgbb.com/1/upload';

const FIELD_GROUPS = [
  { title:'Identity', fields:['iid','teacher_name_en','teacher_name_bn','pp_photo','nid_photo'] },
  { title:'Designation & Sector', fields:['sector','designation_en','designation_bn','subject_en','subject_bn','index_number','pds_number','pay_code','basic','1st_mpo'] },
  { title:'Parents', fields:['father_name_en','father_name_bn','mother_name_en','mother_name_bn'] },
  { title:'Personal', fields:['date_of_birth_en','date_of_birth_bn','gender_en','gender_bn','religion_en','religion_bn','nid_number_en','nid_number_bn','birth_certificate_number'] },
  { title:'Contact', fields:['mobile_number_en','mobile_number_bn','email_id'] },
  { title:'Addresses', fields:['village_en','village_bn','post_office_en','post_office_bn','upazilla_en','upazilla_bn','district_en','district_bn','home_district'] },
  { title:'Service', fields:['this_school_join_date','join_date','created_at'] },
];

const LABELS = { iid:'IID', teacher_name_en:'Teacher Name (EN)', teacher_name_bn:'Teacher Name (BN)', pp_photo:'Profile Photo URL', nid_photo:'NID Photo URL', sector:'Sector', designation_en:'Designation (EN)', designation_bn:'Designation (BN)', subject_en:'Subject (EN)', subject_bn:'Subject (BN)', index_number:'Index Number', pds_number:'PDS Number', pay_code:'Pay Code', basic:'Basic', '1st_mpo':'1st MPO', father_name_en:'Father Name (EN)', father_name_bn:'Father Name (BN)', mother_name_en:'Mother Name (EN)', mother_name_bn:'Mother Name (BN)', date_of_birth_en:'DOB (EN)', date_of_birth_bn:'DOB (BN)', gender_en:'Gender (EN)', gender_bn:'Gender (BN)', religion_en:'Religion (EN)', religion_bn:'Religion (BN)', nid_number_en:'NID (EN)', nid_number_bn:'NID (BN)', birth_certificate_number:'Birth Certificate No', mobile_number_en:'Mobile (EN)', mobile_number_bn:'Mobile (BN)', email_id:'Email', village_en:'Village (EN)', village_bn:'Village (BN)', post_office_en:'Post Office (EN)', post_office_bn:'Post Office (BN)', upazilla_en:'Upazilla (EN)', upazilla_bn:'Upazilla (BN)', district_en:'District (EN)', district_bn:'District (BN)', home_district:'Home District', this_school_join_date:'This School Join Date', join_date:'Join Date', created_at:'Created At' };

const READONLY = new Set(['iid','created_at']);
let originalRow = null;
let currentUploadField = null;
let selectedFile = null;

function qs(k){return new URLSearchParams(location.search).get(k);} 
function setStatus(el,msg,type=''){ el.textContent=msg||''; el.className='status'+(type?' '+type:''); }

async function load(){
  const iid = qs('iid');
  if(!iid){ setStatus(loadStatus,'Missing iid parameter','err'); return; }
  setStatus(loadStatus,'Loading teacher #'+iid+' ...');
  const { data, error } = await supabase.from(TABLE).select('*').eq('iid', iid).single();
  if(error){ setStatus(loadStatus,'Load failed: '+error.message,'err'); return; }
  originalRow = data;
  buildForm(data);
  setStatus(loadStatus,'Loaded','ok');
}

function buildForm(row){
  const form = document.getElementById('teacherForm');
  form.innerHTML='';
  FIELD_GROUPS.forEach(group=>{
    const panel = document.createElement('section');
    panel.className='panel';
    const h2=document.createElement('h2'); h2.textContent=group.title; panel.appendChild(h2);
    const grid=document.createElement('div'); grid.className='grid';
    group.fields.forEach(field=>{
      if(!(field in row)) return; // skip absent
      const wrap=document.createElement('div');
      const label=document.createElement('label'); label.htmlFor='f_'+field; label.textContent=LABELS[field]||field; wrap.appendChild(label);
      
      const input=document.createElement('input');
      input.id='f_'+field; input.name=field; input.value=row[field]??'';
      if(/date/i.test(field) && !READONLY.has(field)) input.placeholder='YYYY-MM-DD';
      if(READONLY.has(field)){ input.readOnly=true; input.classList.add('readonly'); }
      wrap.appendChild(input);
      
      // Check if it's a URL/photo field
      const isUrlField = field.includes('url') || field.includes('photo');
      
      // Photo preview and upload button
      if(isUrlField && row[field]){
        const img=document.createElement('img'); 
        img.src=row[field]; 
        img.alt=field==='pp_photo'?'Profile Photo':'NID Photo'; 
        img.className='photo-preview';
        img.onclick=()=>window.open(row[field],'_blank');
        wrap.appendChild(img);
      }
      
      // Add upload and view buttons for URL/photo fields
      if(isUrlField){
        const uploadWrapper=document.createElement('div');
        uploadWrapper.className='photo-upload-wrapper';
        
        // Upload button
        const uploadBtn=document.createElement('button');
        uploadBtn.type='button';
        uploadBtn.className='upload-btn';
        uploadBtn.textContent='üì∑ Upload';
        uploadBtn.onclick=()=>openUploadModal(field);
        uploadWrapper.appendChild(uploadBtn);
        
        // View button (only if URL exists)
        if(row[field]){
          const viewBtn=document.createElement('button');
          viewBtn.type='button';
          viewBtn.className='view-btn';
          viewBtn.textContent='üëÅÔ∏è View';
          viewBtn.onclick=()=>window.open(row[field],'_blank');
          uploadWrapper.appendChild(viewBtn);
        }
        
        wrap.appendChild(uploadWrapper);
      }
      
      grid.appendChild(wrap);
    });
    panel.appendChild(grid);
    form.appendChild(panel);
  });
  
  // Check for URL columns after groups
  addUrlFieldsAfterGroups(row, form);
}

// Add fields that are not in groups
function addUrlFieldsAfterGroups(row, form){
  const allGroupFields = FIELD_GROUPS.flatMap(g => g.fields);
  const remainingFields = Object.keys(row).filter(key => !allGroupFields.includes(key));
  
  if(remainingFields.length > 0){
    const panel = document.createElement('section');
    panel.className='panel';
    const h2=document.createElement('h2'); h2.textContent='Other Fields'; panel.appendChild(h2);
    const grid=document.createElement('div'); grid.className='grid';
    
    remainingFields.forEach(field=>{
      const wrap=document.createElement('div');
      const label=document.createElement('label'); 
      label.htmlFor='f_'+field; 
      label.textContent=field.replace(/_/g,' ').replace(/\b\w/g, l => l.toUpperCase()); 
      wrap.appendChild(label);
      
      const input=document.createElement('input');
      input.id='f_'+field; input.name=field; input.value=row[field]??'';
      wrap.appendChild(input);
      
      // Check if it's a photo/URL field
      const isPhotoField = field.includes('_url') || field.toLowerCase().includes('photo') || field.includes('url');
      
      // Photo preview for URL/photo fields
      if(isPhotoField && row[field]){
        const img=document.createElement('img'); 
        img.src=row[field]; 
        img.alt=field; 
        img.className='photo-preview';
        img.onclick=()=>window.open(row[field],'_blank');
        wrap.appendChild(img);
      }
      
      // Upload button for photo/URL fields
      if(isPhotoField){
        const uploadWrapper=document.createElement('div');
        uploadWrapper.className='photo-upload-wrapper';
        
        // Upload button
        const uploadBtn=document.createElement('button');
        uploadBtn.type='button';
        uploadBtn.className='upload-btn';
        uploadBtn.textContent='üì∑ Upload';
        uploadBtn.onclick=()=>openUploadModal(field);
        uploadWrapper.appendChild(uploadBtn);
        
        // View button (only if URL exists)
        if(row[field]){
          const viewBtn=document.createElement('button');
          viewBtn.type='button';
          viewBtn.className='view-btn';
          viewBtn.textContent='üëÅÔ∏è View';
          viewBtn.onclick=()=>window.open(row[field],'_blank');
          uploadWrapper.appendChild(viewBtn);
        }
        
        wrap.appendChild(uploadWrapper);
      }
      
      grid.appendChild(wrap);
    });
    panel.appendChild(grid);
    form.appendChild(panel);
  }
}

function formDataObj(){
  const form=document.getElementById('teacherForm');
  const inputs=[...form.querySelectorAll('input,textarea')];
  const obj={};
  inputs.forEach(i=>{ obj[i.name]=i.value.trim(); if(obj[i.name]==='') obj[i.name]=null; });
  return obj;
}

function diff(orig, updated){
  const changes={};
  Object.keys(updated).forEach(k=>{
    if(READONLY.has(k)) return;
    const o = orig[k]==null?null:String(orig[k]);
    const n = updated[k]==null?null:String(updated[k]);
    if(o!==n) changes[k]=updated[k];
  });
  return changes;
}

// Photo Upload Functions
function openUploadModal(fieldName){
  currentUploadField = fieldName;
  selectedFile = null;
  const fieldLabel = LABELS[fieldName] || fieldName.replace(/_/g,' ').replace(/\b\w/g, l => l.toUpperCase());
  document.getElementById('modalTitle').textContent = 'Upload ' + fieldLabel;
  document.getElementById('uploadModal').classList.add('active');
  document.getElementById('previewContainer').style.display = 'none';
  document.getElementById('confirmUploadBtn').style.display = 'none';
  document.getElementById('photoInput').value = '';
  setStatus(document.getElementById('uploadStatus'), '');
}

function closeUploadModal(){
  document.getElementById('uploadModal').classList.remove('active');
  currentUploadField = null;
  selectedFile = null;
}

// Setup upload area
document.addEventListener('DOMContentLoaded', ()=>{
  const uploadArea = document.getElementById('uploadArea');
  const photoInput = document.getElementById('photoInput');
  
  uploadArea.addEventListener('click', ()=> photoInput.click());
  uploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('dragover'));
  uploadArea.addEventListener('drop', (e)=>{
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if(e.dataTransfer.files.length > 0){
      handleFileSelect(e.dataTransfer.files[0]);
    }
  });
  
  photoInput.addEventListener('change', (e)=>{
    if(e.target.files.length > 0){
      handleFileSelect(e.target.files[0]);
    }
  });
});

function handleFileSelect(file){
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
  
  if(!allowedTypes.includes(file.type)){
    setStatus(document.getElementById('uploadStatus'), 'Please select JPG or PNG image', 'err');
    return;
  }
  
  if(file.size > 5 * 1024 * 1024){
    setStatus(document.getElementById('uploadStatus'), 'File size must be under 5MB', 'err');
    return;
  }
  
  selectedFile = file;
  
  // Show preview
  const reader = new FileReader();
  reader.onload = (e)=>{
    document.getElementById('previewImage').src = e.target.result;
    document.getElementById('previewContainer').style.display = 'block';
    document.getElementById('confirmUploadBtn').style.display = 'inline-block';
  };
  reader.readAsDataURL(file);
  
  setStatus(document.getElementById('uploadStatus'), 'Photo ready to upload', 'ok');
}

async function confirmUpload(){
  if(!selectedFile || !currentUploadField || !originalRow){
    setStatus(document.getElementById('uploadStatus'), 'Missing file or field info', 'err');
    return;
  }
  
  try {
    document.getElementById('uploadLoading').style.display = 'block';
    setStatus(document.getElementById('uploadStatus'), 'Uploading...', 'ok');
    
    // Upload to ImgBB
    const formData = new FormData();
    formData.append('key', IMGBB_API_KEY);
    formData.append('image', selectedFile, `teacher-${originalRow.iid}-${currentUploadField}.jpg`);
    
    const response = await fetch(IMGBB_UPLOAD_URL, {
      method: 'POST',
      body: formData
    });
    
    if(!response.ok){
      throw new Error('Upload failed: ' + response.statusText);
    }
    
    const data = await response.json();
    
    if(!data.success){
      throw new Error(data.error?.message || 'Upload failed');
    }
    
    const photoUrl = data.data.url;
    
    // Update database
    setStatus(document.getElementById('uploadStatus'), 'Updating database...', 'ok');
    const updateData = {};
    updateData[currentUploadField] = photoUrl;
    
    const { error } = await supabase
      .from(TABLE)
      .update(updateData)
      .eq('iid', originalRow.iid);
    
    if(error){
      throw new Error('Database update failed: ' + error.message);
    }
    
    // Update local data and UI
    originalRow[currentUploadField] = photoUrl;
    document.getElementById('f_'+currentUploadField).value = photoUrl;
    
    setStatus(document.getElementById('uploadStatus'), '‚úÖ Photo uploaded successfully!', 'ok');
    
    setTimeout(()=>{
      closeUploadModal();
      buildForm(originalRow); // Refresh to show new photo
    }, 1500);
    
  } catch(error){
    console.error('Upload error:', error);
    setStatus(document.getElementById('uploadStatus'), 'Error: ' + error.message, 'err');
  } finally {
    document.getElementById('uploadLoading').style.display = 'none';
  }
}

async function save(){
  if(!originalRow) return;
  setStatus(formStatus,'Saving...');
  disable(true);
  const updated=formDataObj();
  updated.iid=originalRow.iid; // ensure
  const changes=diff(originalRow, updated);
  if(Object.keys(changes).length===0){ setStatus(formStatus,'No changes','ok'); disable(false); return; }
  const { error } = await supabase.from(TABLE).update(changes).eq('iid', originalRow.iid);
  if(error){ setStatus(formStatus,'Update failed: '+error.message,'err'); disable(false); return; }
  Object.assign(originalRow, changes);
  setStatus(formStatus,'Saved','ok');
  disable(false);
}

function disable(dis){
  document.getElementById('saveBtn').disabled=dis;
}

function resetForm(){ if(!originalRow) return; buildForm(originalRow); setStatus(formStatus,'Form reset'); }

document.getElementById('saveBtn').addEventListener('click', save);
const formStatus=document.getElementById('formStatus');
const loadStatus=document.getElementById('loadStatus');


document.getElementById('backBtn').addEventListener('click', ()=>{ location.href='teacherlist.html'; });

load();
</script>
</body>
</html>
