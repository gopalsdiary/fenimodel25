<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Entry - Show & Edit</title>
  <style>
  /* reduced base font size by 20% (reset to 100%) and use Kalpurush font */
  html{font-size:100%;}
    body{font-family: 'Kalpurush', Arial, Helvetica, sans-serif; padding:16px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f4f4f4}
    .btn{padding:6px 10px;border:none;background:#0b74de;color:#fff;border-radius:4px;cursor:pointer}
    .btn.secondary{background:#6c757d}
    /* modal */
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
  .modal .panel{background:#fff;padding:16px;border-radius:6px;max-width:720px;width:100%;max-height:80vh;overflow:auto}
  /* view modal portrait style: tall centered card with left/right space */
  #viewModal{align-items:center;justify-content:center}
  /* make the panel a portrait card: narrow width, full height, centered */
  #viewModal .panel{position:relative;max-width:720px;width:min(92vw,720px);height:100vh;border-radius:8px;margin:0;overflow:auto;box-shadow:0 8px 30px rgba(0,0,0,0.35)}
  #viewModal .view-close-x{position:absolute;right:12px;top:8px;background:transparent;border:none;font-size:28px;line-height:1;padding:6px 8px;cursor:pointer;color:#333}
    .field-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
    .field-row label{min-width:140px}
    .field-row input, .field-row textarea{flex:1;padding:8px}
    .notice{margin-top:8px;color:#a00}
    .error-details{font-family:monospace;font-size:12px;color:#900;margin-top:6px}
    /* photo column */
    .row-thumb{width:36px;height:36px;object-fit:cover;border-radius:4px;border:1px solid #ddd}
    .no-image{font-size:14px;color:rgb(243, 0, 0);font-style:italic;font-weight:bold}
    /* photo preview */
    #photo-preview{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;width:350px;height:500px;border:4px solid #000;background:#fff;padding:10px;border-radius:10px;display:none;pointer-events:none}
    /* status column */
    .status-tc{background-color:rgba(250, 187, 187, 0.5)}
  /* SL column */
  .col-sl{width:56px;max-width:56px;padding:4px;text-align:center}
  </style>
</head>
<body>
  <a href="/login/all_data_field.html" class="btn" style="background: orange; float: right; border-radius: 50%; padding: 10px 20px;" target="_blank">All data field</a>
  <h2>student_database : Data Overview </h2>
  <div>
    <button id="refreshBtn" class="btn">Refresh</button>
    <span id="status" style="margin-left:12px;color:#444"></span>
    <div style="display:inline-block;margin-left:18px;vertical-align:middle">
      <label for="classFilter" style="margin-right:6px;color:#333">Class:</label>
      <select id="classFilter" style="padding:6px;border-radius:4px;border:1px solid #ccc"></select>
      <label for="sectionFilter" style="margin:0 6px 0 12px;color:#333">Section:</label>
      <select id="sectionFilter" style="padding:6px;border-radius:4px;border:1px solid #ccc"></select>
      <button id="clearFilters" class="btn secondary" style="margin-left:8px;padding:6px 8px">Clear</button>
    </div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
  <th class="col-sl">SL</th>
        <th>IID</th>
        <th>Class</th>
        <th>Section</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Father Name</th>
        <th>Photo</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="10">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Edit modal -->
  <div id="editModal" class="modal">
    <div class="panel">
      <h3>Edit Record</h3>

      <!-- Dynamic fields will be rendered here -->
      <div id="editFields"></div>

      <div style="text-align:right;margin-top:12px">
        <button id="cancelBtn" class="btn secondary">Cancel</button>
        <button id="saveBtn" class="btn">Save</button>
      </div>
      <div id="modalNotice" class="notice"></div>
    </div>
  </div>

  <!-- View modal (read-only) -->
  <div id="viewModal" class="modal">
    <div class="panel">
      <h3>View Record</h3>
      <button id="viewCloseX" class="view-close-x" aria-label="Close">&times;</button>
      <div id="viewFields"></div>
      <div style="text-align:right;margin-top:12px">
        <button id="closeViewBtn" class="btn secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Use the same project URL/key used elsewhere in this repo
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const tableName = 'student_database';

  const tbody = document.querySelector('#dataTable tbody');
    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');
  const classFilter = document.getElementById('classFilter');
  const sectionFilter = document.getElementById('sectionFilter');
  const clearFilters = document.getElementById('clearFilters');

  // photo preview
  const photoPreview = document.createElement('div');
  photoPreview.id = 'photo-preview';
  const previewImg = document.createElement('img');
  previewImg.style.width = '100%';
  previewImg.style.height = '100%';
  previewImg.style.objectFit = 'cover';
  photoPreview.appendChild(previewImg);
  document.body.appendChild(photoPreview);

  tbody.addEventListener('mouseover', (e) => {
    if(e.target.classList.contains('row-thumb')){
      previewImg.src = e.target.src;
      photoPreview.style.display = 'block';
    }
  });

  tbody.addEventListener('mouseout', (e) => {
    if(e.target.classList.contains('row-thumb')){
      photoPreview.style.display = 'none';
    }
  });

  // keep full dataset in memory for client-side filtering
  let allRowsCache = [];

    // modal elems
    const editModal = document.getElementById('editModal');
    const editFields = document.getElementById('editFields');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const modalNotice = document.getElementById('modalNotice');

    refreshBtn.addEventListener('click', () => {
      const cls = classFilter.value;
      if(cls) loadDataForClass(cls);
    });

  classFilter.addEventListener('change', onClassChange);
  sectionFilter.addEventListener('change', () => {
    // only apply section filter when a class is selected
    if(classFilter.value) applyFilters();
  });
  clearFilters.addEventListener('click', ()=>{ classFilter.value=''; sectionFilter.value=''; tbody.innerHTML = '<tr><td colspan="10">Select class to view data</td></tr>'; statusEl.textContent = 'Select class to view data'; });
    cancelBtn.addEventListener('click', closeModal);
    saveBtn.addEventListener('click', saveEdit);

    // store the currently editing IID
    let currentIID = null;

  // view modal elems
  const viewModal = document.getElementById('viewModal');
  const viewFields = document.getElementById('viewFields');
  const closeViewBtn = document.getElementById('closeViewBtn');
  const viewCloseX = document.getElementById('viewCloseX');
  closeViewBtn.addEventListener('click', () => { viewModal.style.display = 'none'; viewFields.innerHTML = ''; });
  if(viewCloseX) viewCloseX.addEventListener('click', () => { viewModal.style.display = 'none'; viewFields.innerHTML = ''; });

    // photo links loaded from photo/link.csv (one URL per line).
    let photoLinks = [];

  // data order loaded from dataorder.csv (defines preview field order and labels)
  let dataOrder = []; // array of { key, label }

    async function loadPhotoLinks(){
      try{
        const res = await fetch('../photo/link.csv');
        if(!res.ok) return;
        const txt = await res.text();
        photoLinks = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      }catch(e){
        photoLinks = [];
      }
    }
    // start loading photo links in background
    loadPhotoLinks();

    // load dataorder.csv to determine preview order and labels
    async function loadDataOrder(){
      try{
        // dataorder.csv is in the same `login/` folder as this page
        const res = await fetch('dataorder.csv');
        if(!res.ok) return;
        const txt = await res.text();
        const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        const parsed = [];
        for(const line of lines){
          // expect lines like: key > Label
          const parts = line.split('>');
          if(parts.length < 2) continue;
          const key = parts[0].trim();
          const label = parts.slice(1).join('>').trim();
          if(key) parsed.push({ key, label });
        }
        dataOrder = parsed;
      }catch(e){
        console.warn('loadDataOrder failed', e);
        dataOrder = [];
      }
    }
    loadDataOrder();

    // Load records for a specific class only
    async function loadDataForClass(classValue){
      statusEl.textContent = `Loading class ${classValue}...`;
      try{
        const { data, error } = await supabase
          .from(tableName)
          .select('iid, class_2025, section_2025, roll_2025, student_name_en, father_name_en, student_photo_url, status')
          .eq('class_2025', classValue)
          .order('iid', { ascending: true })
          .limit(10000);
        if(error){
          const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
          throw new Error(`${error.message} | details: ${details}`);
        }
        allRowsCache = data || [];
        populateFilterOptions(allRowsCache);
        renderTable(allRowsCache);
        statusEl.textContent = `Total: ${allRowsCache ? allRowsCache.length : 0}`;
      }catch(err){
        console.error('loadDataForClass error:', err);
        statusEl.textContent = 'Data loading error';
        const msg = err && err.message ? err.message : String(err);
  tbody.innerHTML = `<tr><td colspan="10">Data loading error: <div class="error-details">${escapeHtml(msg)}</div></td></tr>`;
      }
    }

    // Load class list for the dropdown (fixed classes: 6,7,8,9,10)
    async function loadClassList(){
      try{
        // Fixed class list instead of fetching from database
        const classes = ['6', '7', '8', '9', '10'];
        classFilter.innerHTML = '';
  // first option: All (empty value means no class filter)
  const opt = document.createElement('option'); 
  opt.value=''; 
  opt.textContent='All'; 
  classFilter.appendChild(opt);
        classes.forEach(c=>{ 
          const o=document.createElement('option'); 
          o.value=c; 
          o.textContent=c; 
          classFilter.appendChild(o); 
        });
        statusEl.textContent = 'Select class to view data';
      }catch(e){
        console.warn('loadClassList failed', e);
      }
    }

    function onClassChange(){
      const cls = classFilter.value;
      if(!cls){ 
        // 'All' selected - load all data (existing function)
  tbody.innerHTML = '<tr><td colspan="10">Loading all data...</td></tr>'; 
        statusEl.textContent='Loading all data';
        loadData();
        return; 
      }
      // load only when a specific class is selected
      loadDataForClass(cls);
    }

    async function loadData(){
      // Batched fetch to load ALL rows (handles Supabase default limits)
      statusEl.textContent = 'Loading all data...';
      try{
        const batchSize = 1000;
        let allData = [];
        let lastId = 0;
        let round = 0;
        while(true){
          round++;
          statusEl.textContent = `Loading... fetched ${allData.length} rows (batch ${round})`;
          const { data, error } = await supabase
            .from(tableName)
            .select('iid, class_2025, section_2025, roll_2025, student_name_en, father_name_en, student_photo_url, status')
            .gt('iid', lastId)
            .order('iid', { ascending: true })
            .limit(batchSize);
          if(error){
            const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
            throw new Error(`${error.message} | details: ${details}`);
          }
          if(!data || data.length === 0) break;
          allData = allData.concat(data);
          lastId = data[data.length-1].iid || lastId;
          if(data.length < batchSize) break; // last batch
        }

        allRowsCache = allData;
        // sort by roll number
        allRowsCache = allRowsCache.sort((a,b)=> (Number(a.roll_2025)||0) - (Number(b.roll_2025)||0));
        populateFilterOptions(allRowsCache);
        renderTable(allRowsCache);
        statusEl.textContent = `Total: ${allRowsCache.length} records (ALL)`;
      }catch(err){
        console.error('loadData error:', err);
        statusEl.textContent = 'Data loading error';
        const msg = err && err.message ? err.message : String(err);
  tbody.innerHTML = `<tr><td colspan="10">Data loading error: <div class="error-details">${escapeHtml(msg)}</div></td></tr>`;
      }
    }

    function populateFilterOptions(rows){
      // collect unique classes and sections from provided rows
      const classes = new Set();
      const sections = new Set();
      rows.forEach(r=>{ 
        if(r && r.class_2025) classes.add(String(r.class_2025)); 
        if(r && r.section_2025) sections.add(String(r.section_2025)); 
      });

      // preserve current selections where possible
      const selClass = classFilter.value;
      const selSection = sectionFilter.value;

      // rebuild class options only if they differ
      const sortedClasses = Array.from(classes).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
      classFilter.innerHTML = '';
      const optAnyC = document.createElement('option'); optAnyC.value=''; optAnyC.textContent='All'; classFilter.appendChild(optAnyC);
      sortedClasses.forEach(c=>{ const o = document.createElement('option'); o.value=c; o.textContent=c; classFilter.appendChild(o); });
      if(selClass) classFilter.value = selClass;

      // build section options based on rows (sections are class-specific)
      sectionFilter.innerHTML = '';
      const optAnyS = document.createElement('option'); optAnyS.value=''; optAnyS.textContent='All'; sectionFilter.appendChild(optAnyS);
      const sortedSections = Array.from(sections).sort();
      sortedSections.forEach(s=>{ const o = document.createElement('option'); o.value=s; o.textContent=s; sectionFilter.appendChild(o); });
      if(selSection) sectionFilter.value = selSection;

      // ensure section change triggers filtering
      sectionFilter.onchange = () => { if(classFilter.value) applyFilters(); };
    }

    function applyFilters(){
      const c = classFilter.value;
      const s = sectionFilter.value;
      let filtered = allRowsCache;
      if(c) filtered = filtered.filter(r => String(r.class_2025) === c);
      if(s) filtered = filtered.filter(r => String(r.section_2025) === s);
  // sort by roll_2025 numerically
  filtered = filtered.sort((a,b)=> (Number(a.roll_2025)||0) - (Number(b.roll_2025)||0));
  renderTable(filtered);
      statusEl.textContent = `Total: ${filtered ? filtered.length : 0}`;
    }

    function renderTable(rows){
      if(!rows || rows.length === 0){
  tbody.innerHTML = '<tr><td colspan="10">No records found</td></tr>';
        return;
      }
      tbody.innerHTML = '';

      function getThumbnailSrc(rec, iid){
        // First, check student_photo_url
        if(rec && rec.student_photo_url){
          return rec.student_photo_url;
        }
        // Then, search photoLinks for avatar-{iid}.jpg or .png
        if(photoLinks && iid){
          const targetJpg = 'avatar-' + iid + '.jpg';
          const targetPng = 'avatar-' + iid + '.png';
          for(const url of photoLinks){
            try{
              const filename = new URL(url).pathname.split('/').pop();
              if(filename === targetJpg || filename === targetPng){
                return url;
              }
            }catch(e){}
          }
        }
        // No image found
        return '';
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        // SL cell
        const tdSl = document.createElement('td'); tdSl.className = 'col-sl'; tdSl.textContent = idx + 1; tr.appendChild(tdSl);
        const iid = (r['iid'] ?? r.iid ?? r['IID'] ?? r.IID) || '';

        const tdIid = document.createElement('td'); tdIid.textContent = escapeHtml(iid);
        const tdClass = document.createElement('td'); tdClass.textContent = escapeHtml(r['class_2025']||'');
        const tdSection = document.createElement('td'); tdSection.textContent = escapeHtml(r['section_2025']||'');
        const tdRoll = document.createElement('td'); tdRoll.textContent = escapeHtml(r['roll_2025']||'');
        const tdName = document.createElement('td'); tdName.textContent = escapeHtml(r['student_name_en']||'');
        const tdFatherName = document.createElement('td'); tdFatherName.textContent = escapeHtml(r['father_name_en']||'');

        const tdPhoto = document.createElement('td');
        const src = getThumbnailSrc(r, iid);
        if (src) {
          const img = document.createElement('img'); img.className = 'row-thumb'; img.alt = 'Photo';
          img.src = src;
          tdPhoto.appendChild(img);
        } else {
          const noImg = document.createElement('span'); noImg.className = 'no-image'; noImg.textContent = 'No Image';
          tdPhoto.appendChild(noImg);
        }

        const tdStatus = document.createElement('td');
        const statusText = escapeHtml(r['status'] || '');
        tdStatus.textContent = statusText;
        if (statusText && statusText.toUpperCase().includes('TC')) {
          tr.className = 'status-tc';
        }

        const tdAction = document.createElement('td');
        // Edit button (existing behaviour)
        const btnEdit = document.createElement('button'); btnEdit.className = 'btn'; btnEdit.textContent = 'Edit'; btnEdit.setAttribute('data-iid', iid);
        btnEdit.addEventListener('click', () => {
          const url = `editdetailsnew.html?iid=${encodeURIComponent(iid)}`;
          const w = window.open(url, '_blank');
          try{ if(w) w.opener = null; }catch(e){}
        });
        tdAction.appendChild(btnEdit);

        // View button (new) - open read-only modal
        const btnView = document.createElement('button'); btnView.className = 'btn secondary'; btnView.style.marginLeft = '8px'; btnView.textContent = 'View'; btnView.setAttribute('data-iid', iid);
        btnView.addEventListener('click', () => { openViewByIID(iid); });
        tdAction.appendChild(btnView);

        tr.appendChild(tdIid);
        tr.appendChild(tdClass);
        tr.appendChild(tdSection);
        tr.appendChild(tdRoll);
        tr.appendChild(tdName);
        tr.appendChild(tdFatherName);
        tr.appendChild(tdPhoto);
        tr.appendChild(tdStatus);
        tr.appendChild(tdAction);

  tbody.appendChild(tr);
      });
    }

  async function openEditByIID(iid){
      // fetch full row from DB to ensure we have all columns
      modalNotice.textContent = '';
      currentIID = iid;
      try{
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
      .eq('iid', Number(iid))
          .limit(1)
          .single();
        if(error){
          const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
          throw new Error(`${error.message} | details: ${details}`);
        }
        renderEditFields(data || {});
        editModal.style.display = 'flex';
      }catch(err){
        console.error('openEdit error:', err);
        modalNotice.style.color = '#a00';
        modalNotice.textContent = 'Failed to load record: ' + (err.message || err);
        // fallback: if we had a row in the table view, user can still edit minimal fields (not implemented here)
      }
    }

    // Open a read-only view modal for a given IID
    async function openViewByIID(iid){
      try{
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
          .eq('iid', Number(iid))
          .limit(1)
          .single();
        if(error){
          const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
          throw new Error(`${error.message} | details: ${details}`);
        }
        renderViewFields(data || {});
        viewModal.style.display = 'flex';
      }catch(err){
        console.error('openView error:', err);
        alert('Failed to load record for view: ' + (err.message || err));
      }
    }

    // Render record fields in read-only form (labels + values)
    function renderViewFields(record){
      viewFields.innerHTML = '';
      const rendered = new Set();

      // helper to render a single key/value
      function renderField(key, label, val){
        const row = document.createElement('div');
        row.className = 'field-row';
        const lab = document.createElement('label'); lab.textContent = (label || key) + ':';
        const container = document.createElement('div');
        container.style.padding = '8px';
        container.style.background = '#f9f9f9';
        container.style.border = '1px solid #eee';
        container.style.flex = '1';
        container.style.whiteSpace = 'pre-wrap';

        // special-case photo URL to render image
        if(key === 'student_photo_url' && val){
          const img = document.createElement('img');
          img.src = String(val);
          img.alt = 'Photo';
          img.style.maxWidth = '220px';
          img.style.maxHeight = '220px';
          img.style.objectFit = 'cover';
          container.appendChild(img);
        } else {
          container.textContent = val === null || val === undefined ? '' : String(val);
        }

        row.appendChild(lab);
        row.appendChild(container);
        viewFields.appendChild(row);
      }

      // 1) Render fields according to dataOrder.csv
      if(Array.isArray(dataOrder) && dataOrder.length){
        dataOrder.forEach(entry => {
          const key = entry.key;
          if(Object.prototype.hasOwnProperty.call(record, key)){
            const val = record[key] === null || record[key] === undefined ? '' : record[key];
            renderField(key, entry.label || key, val);
            rendered.add(key);
          }
        });
      }

      // 2) Render any remaining fields not listed in dataOrder, alphabetically
      const leftover = Object.keys(record).filter(k => !rendered.has(k)).sort();
      leftover.forEach(k => {
        const val = record[k] === null || record[k] === undefined ? '' : record[k];
        renderField(k, k, val);
        rendered.add(k);
      });
    }

    function renderEditFields(record){
      editFields.innerHTML = '';
      // iterate keys in sorted order for predictability
      const keys = Object.keys(record).sort();
      keys.forEach(key => {
        const val = record[key] === null || record[key] === undefined ? '' : record[key];
        const row = document.createElement('div');
        row.className = 'field-row';
        const label = document.createElement('label');
        label.textContent = key + ':';
        // decide input type: use textarea for long text fields (heuristic)
        let input;
        if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note')){
          input = document.createElement('textarea');
          input.rows = 4;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }
        input.value = val;
        input.setAttribute('data-field', key);
        if(key === 'IID'){
          input.readOnly = true;
        }
        row.appendChild(label);
        row.appendChild(input);
        editFields.appendChild(row);
      });
    }

    async function saveEdit(){
      modalNotice.textContent = '';
      if(!currentIID){ modalNotice.textContent = 'No record selected'; return; }
      // build payload from inputs
      const inputs = editFields.querySelectorAll('[data-field]');
      const payload = {};
      inputs.forEach(inp =>{
        const field = inp.getAttribute('data-field');
    if(field === 'iid' || field === 'IID') return; // don't try to update primary key
        const v = inp.value === '' ? null : inp.value;
        payload[field] = v;
      });
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      try{
        const { data, error } = await supabase
          .from(tableName)
          .update(payload)
          .eq('iid', Number(currentIID));
        if(error){
          const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
          throw new Error(`${error.message} | details: ${details}`);
        }
        modalNotice.style.color = 'green';
        modalNotice.textContent = 'Updated successfully';
        // refresh list and close
        await loadData();
        setTimeout(()=>{ closeModal(); modalNotice.textContent = ''; }, 700);
      }catch(err){
        console.error('saveEdit error:', err);
        modalNotice.style.color = '#a00';
        modalNotice.textContent = 'Update error: ' + (err.message || err);
      }finally{
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }

    function closeModal(){
      editModal.style.display = 'none';
      editFields.innerHTML = '';
      currentIID = null;
    }

    function escapeHtml(s){
      if(s === null || s === undefined) return '';
      return String(s).replace(/[&<>\\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\\"':'&quot;',"'":'&#39;'}[c]));
    }

    // close modal when clicking outside panel
    editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeModal(); });

    // close view modal when clicking outside panel
    viewModal.addEventListener('click', (e)=>{ if(e.target===viewModal) { viewModal.style.display = 'none'; viewFields.innerHTML = ''; } });

  // initial load: only populate class list, don't fetch records
  tbody.innerHTML = '<tr><td colspan="10">Select class to view data</td></tr>';
    loadClassList();
  </script>
</body>
</html>

