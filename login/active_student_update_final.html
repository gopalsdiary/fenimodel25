<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Active Student Update (Session-wise)</title>
  <style>
    :root { --bg:#f6f8fa; --card:#ffffff; --border:#d0d7de; --accent:#0366d6; --accent-hover:#024c9e; --danger:#d73a49; --radius:6px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    body { margin:0; background:var(--bg); color:#24292f; }
    header { background:#0d1117; color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    h1 { font-size:20px; margin:0; font-weight:600; }
    .btn-logout { background:#ff8a00; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; font-size:13px; border:1px solid #ff8a00; }
    .btn-logout:hover { background:#e07000; border-color:#e07000; }
    /* Full-width container so table fits left-right */
    .container { width:100%; max-width:100%; margin:0 0 60px 0; background:var(--card); border:1px solid var(--border); border-radius:0; padding:18px 12px 28px; box-shadow:0 2px 4px rgba(0,0,0,.04); }
    /* Ensure table can scroll horizontally on very small screens */
    .table-wrap { overflow-x:auto; }
    .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:14px; }
    .toolbar select, .toolbar input[type=text]{ padding:8px 10px; border:1px solid var(--border); border-radius:4px; font-size:14px; background:#fff; }
    .toolbar button{ height:34px; }
    .status { font-size:13px; min-height:18px; }
    .status.ok { color:#1a7f37; }
    .status.err { color:var(--danger); }
    table { width:100%; border-collapse:collapse; font-size:13.5px; }
    thead { background:#fafbfc; position:sticky; top:0; z-index:5; }
    th, td { border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:middle; }
    th { font-weight:600; font-size:12.5px; letter-spacing:.5px; background:#f0f3f6; }
    tbody tr:nth-child(even){ background:#fcfcfd; }
    tbody tr:hover { background:#fffbe6; }
    .col-sl { width:52px; text-align:center; }
    .actions-col { white-space:nowrap; }
    button { cursor:pointer; font-size:12px; line-height:1.2; padding:6px 10px; border-radius:4px; border:1px solid var(--accent); background:var(--accent); color:#fff; font-weight:500; }
    button:hover { background:var(--accent-hover); }
    button.outline { background:#fff; color:var(--accent); }
    button.outline:hover { background:#e7f3ff; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .muted { color:#6a737d; font-size:12px; }
    /* Space between action buttons */
    .action-cell button + button { margin-left:8px; }
    .action-cell .btn { padding:6px 8px; }
    /* Make Update button orange when needed, blue when up-to-date */
    .btn.update-needed { background:#ff8a00; border-color:#ff8a00; }
    .btn.update-needed:hover { background:#e07000; }
    .btn.up-to-date { background:#10b981; border-color:#10b981; }
    .btn.up-to-date:hover { background:#0f9f74; }
    /* Inline status messages */
    .update-status { font-size:11px; margin-left:8px; font-weight:600; }
    .update-status.success { color:#1a7f37; }
    .update-status.error { color:var(--danger); }
    .update-status.loading { color:#6a737d; }
    @media (max-width:820px){
      .container { padding:14px 14px 24px; }
      .toolbar { gap:8px; }
      th,td{padding:5px 6px;font-size:12.5px;}
      button{padding:5px 8px;}
    }
  </style>
</head>

<body>
  <header>
    <h1>Active Student Update (Session-wise)</h1>
    <button id="logoutBtn" class="btn-logout">Logout</button>
  </header>

  <div class="container">
    <div class="toolbar">
      <div class="filters left" style="align-items:center">
        <label for="sessionFilter" class="filter-label">Session</label>
        <select id="sessionFilter" class="filter-select">
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;align-items:center;margin-left:auto">
        <button id="refreshBtn">Refresh</button>
        <button id="updateAllBtn" class="update-needed">Update All Needed</button>
        <button id="downloadCsvBtn" class="outline">Download CSV</button>
        <span id="status" class="status"></span>
      </div>
    </div>

    <div class="table-wrap">
      <table id="dataTable">
        <thead id="tableHeader">
          <tr>
            <th class="col-sl">SL</th>
            <th>IID</th>
            <th>Name</th>
            <th>Father Name</th>
            <th>Session</th>
            <th>Class (2025)</th>
            <th>Section (2025)</th>
            <th>Roll (2025)</th>
            <th>Active Class</th>
            <th>Active Section</th>
            <th>Active Roll</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="12">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div id="rowCount" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Auth check -->
  <script src="./auth-check.js"></script>

  <script>
    // Use the same project URL/key used elsewhere in this repo
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const tableName = 'student_database';

    // Elements
    const tbody = document.querySelector('#dataTable tbody');
    const statusEl = document.getElementById('status');
    const sessionFilter = document.getElementById('sessionFilter');
    const tableHeader = document.getElementById('tableHeader');
    const rowCountEl = document.getElementById('rowCount');

    // Global data cache
    let allRowsCache = [];
    let currentSession = '2025';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      loadData();
    });

    function setupEventListeners() {
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('sessionFilter').addEventListener('change', function() {
        currentSession = this.value;
        updateTableHeader(currentSession);
        filterAndRenderData();
      });
      document.getElementById('updateAllBtn').addEventListener('click', updateAllNeeded);
      document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
      document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    async function logout() {
      try {
        await supabase.auth.signOut();
      } catch (e) {
        console.error('Logout error:', e);
      }
      window.location.href = './index.html';
    }

    async function loadData() {
      try {
        showStatus('Loading data...', 'loading');
        tbody.innerHTML = '<tr><td colspan="12">Loading...</td></tr>';

        console.log('Loading data from table:', tableName);

        const { data, error } = await supabase
          .from(tableName)
          .select('*');

        if (error) {
          console.error('Supabase error:', error);
          throw new Error('Database query failed: ' + error.message);
        }

        if (!data || data.length === 0) {
          showStatus('No data found', 'error');
          tbody.innerHTML = '<tr><td colspan="12" class="muted">No data available.</td></tr>';
          return;
        }

        console.log('Data loaded successfully:', data.length, 'rows');
        allRowsCache = data;
        currentSession = sessionFilter.value;
        updateTableHeader(currentSession);
        filterAndRenderData();

      } catch (error) {
        console.error('Load data error:', error);
        showStatus('Failed to load data: ' + error.message, 'error');
        tbody.innerHTML = '<tr><td colspan="12" class="muted">Failed to load data.</td></tr>';
      }
    }

    function updateTableHeader(session) {
      tableHeader.innerHTML = `
        <tr>
          <th class="col-sl">SL</th>
          <th>IID</th>
          <th>Name</th>
          <th>Father Name</th>
          <th>Session</th>
          <th>Class (${session})</th>
          <th>Section (${session})</th>
          <th>Roll (${session})</th>
          <th>Active Class</th>
          <th>Active Section</th>
          <th>Active Roll</th>
          <th>Action</th>
        </tr>
      `;
    }

    function filterAndRenderData() {
      const sessionClassCol = `class_${currentSession}`;
      const sessionSectionCol = `section_${currentSession}`;
      const sessionRollCol = `roll_${currentSession}`;

      // Filter data for current session - students who have data in session-specific columns
      const filteredData = allRowsCache.filter(row => {
        const hasClass = row[sessionClassCol] != null && row[sessionClassCol] !== '';
        const hasSection = row[sessionSectionCol] != null && row[sessionSectionCol] !== '';
        const hasRoll = row[sessionRollCol] != null && row[sessionRollCol] !== '';
        return hasClass || hasSection || hasRoll;
      });

      console.log(`Filtered data for session ${currentSession}:`, filteredData.length, 'rows');

      if (filteredData.length === 0) {
        showStatus(`No students found for session ${currentSession}`, 'error');
        tbody.innerHTML = `<tr><td colspan="12" class="muted">No students for session ${currentSession}.</td></tr>`;
        rowCountEl.textContent = '';
        return;
      }

      // Sort by class, section, roll for selected session
      filteredData.sort((a, b) => {
        const aClass = String(a[sessionClassCol] || '');
        const bClass = String(b[sessionClassCol] || '');
        if (aClass !== bClass) {
          return aClass.localeCompare(bClass, undefined, { numeric: true });
        }

        const aSection = String(a[sessionSectionCol] || '');
        const bSection = String(b[sessionSectionCol] || '');
        if (aSection !== bSection) {
          return aSection.localeCompare(bSection, undefined, { numeric: true });
        }

        const aRoll = parseInt(a[sessionRollCol]) || 0;
        const bRoll = parseInt(b[sessionRollCol]) || 0;
        return aRoll - bRoll;
      });

      renderTable(filteredData, currentSession);
    }

    function renderTable(data, session) {
      const sessionClassCol = `class_${session}`;
      const sessionSectionCol = `section_${session}`;
      const sessionRollCol = `roll_${session}`;

      let needsUpdateCount = 0;
      
      const rows = data.map((row, index) => {
        const sessionClass = row[sessionClassCol];
        const sessionSection = row[sessionSectionCol];
        const sessionRoll = row[sessionRollCol];
        
        const activeClass = row.active_class;
        const activeSection = row.active_section;
        const activeRoll = row.active_roll;

        // Check if update is needed
        const needsUpdate = (sessionClass !== activeClass) || 
                           (sessionSection !== activeSection) || 
                           (sessionRoll !== activeRoll);

        if (needsUpdate) needsUpdateCount++;

        const buttonClass = needsUpdate ? 'update-needed' : 'up-to-date';
        const buttonText = needsUpdate ? 'Update Active' : 'Up-to-date';
        const isDisabled = !sessionClass && !sessionSection && !sessionRoll;

        return `
          <tr data-iid="${escapeHtml(row.iid || '')}">
            <td class="col-sl">${index + 1}</td>
            <td>${escapeHtml(row.iid || '')}</td>
            <td>${escapeHtml(row.student_name_en || '')}</td>
            <td>${escapeHtml(row.father_name_en || '')}</td>
            <td>${escapeHtml(row.session || '')}</td>
            <td>${escapeHtml(sessionClass || '')}</td>
            <td>${escapeHtml(sessionSection || '')}</td>
            <td>${escapeHtml(sessionRoll || '')}</td>
            <td>${escapeHtml(activeClass || '')}</td>
            <td>${escapeHtml(activeSection || '')}</td>
            <td>${escapeHtml(activeRoll || '')}</td>
            <td class="action-cell">
              <button 
                class="btn ${buttonClass}" 
                onclick="updateStudent('${escapeHtml(row.iid || '')}', '${escapeHtml(sessionClass || '')}', '${escapeHtml(sessionSection || '')}', '${escapeHtml(sessionRoll || '')}')"
                ${isDisabled ? 'disabled' : ''}
              >
                ${buttonText}
              </button>
              <span class="update-status" id="status-${escapeHtml(row.iid || '')}"></span>
            </td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
      
      const totalStudents = data.length;
      showStatus(`Showing ${totalStudents} students · ${needsUpdateCount} need update`, 'ok');
      rowCountEl.textContent = `Total: ${totalStudents} students (${needsUpdateCount} need update)`;
    }

    async function updateStudent(iid, sessionClass, sessionSection, sessionRoll) {
      const statusEl = document.getElementById(`status-${iid}`);
      const button = event.target;
      
      try {
        statusEl.textContent = 'Updating...';
        statusEl.className = 'update-status loading';
        button.disabled = true;

        const updates = {
          active_class: sessionClass || null,
          active_section: sessionSection || null,
          active_roll: sessionRoll || null
        };

        const { error } = await supabase
          .from(tableName)
          .update(updates)
          .eq('iid', iid);

        if (error) {
          throw new Error(error.message);
        }

        // Update success
        statusEl.textContent = 'Updated ✓';
        statusEl.className = 'update-status success';
        button.className = 'btn up-to-date';
        button.textContent = 'Up-to-date';
        
        // Update local cache
        const rowData = allRowsCache.find(row => row.iid === iid);
        if (rowData) {
          rowData.active_class = updates.active_class;
          rowData.active_section = updates.active_section;
          rowData.active_roll = updates.active_roll;
        }

        // Clear status message after 3 seconds
        setTimeout(() => {
          statusEl.textContent = '';
        }, 3000);

      } catch (error) {
        console.error('Update error:', error);
        statusEl.textContent = 'Failed ✗';
        statusEl.className = 'update-status error';
        button.disabled = false;
      }
    }

    async function updateAllNeeded() {
      const updateButtons = tbody.querySelectorAll('.btn.update-needed:not(:disabled)');
      
      if (updateButtons.length === 0) {
        showStatus('No updates needed.', 'ok');
        return;
      }

      showStatus(`Updating ${updateButtons.length} students...`, 'loading');
      
      let successCount = 0;
      for (const button of updateButtons) {
        try {
          button.click();
          await new Promise(resolve => setTimeout(resolve, 200)); // Small delay
          successCount++;
        } catch (error) {
          console.error('Bulk update error:', error);
        }
      }

      setTimeout(() => {
        showStatus(`Bulk update completed. ${successCount} students updated.`, 'ok');
      }, 2000);
    }

    async function downloadCSV() {
      try {
        const filteredData = allRowsCache.filter(row => {
          const sessionClassCol = `class_${currentSession}`;
          const sessionSectionCol = `section_${currentSession}`;
          const sessionRollCol = `roll_${currentSession}`;
          const hasClass = row[sessionClassCol] != null && row[sessionClassCol] !== '';
          const hasSection = row[sessionSectionCol] != null && row[sessionSectionCol] !== '';
          const hasRoll = row[sessionRollCol] != null && row[sessionRollCol] !== '';
          return hasClass || hasSection || hasRoll;
        });

        if (filteredData.length === 0) {
          showStatus('No data to download.', 'error');
          return;
        }

        const headers = [
          'SL', 'IID', 'Name', 'Father_Name', 'Session',
          `Class_${currentSession}`, `Section_${currentSession}`, `Roll_${currentSession}`,
          'Active_Class', 'Active_Section', 'Active_Roll'
        ];

        const csvContent = [
          headers.join(','),
          ...filteredData.map((row, index) => [
            index + 1,
            row.iid || '',
            row.student_name_en || '',
            row.father_name_en || '',
            row.session || '',
            row[`class_${currentSession}`] || '',
            row[`section_${currentSession}`] || '',
            row[`roll_${currentSession}`] || '',
            row.active_class || '',
            row.active_section || '',
            row.active_roll || ''
          ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `active_students_${currentSession}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showStatus('CSV downloaded successfully.', 'ok');

      } catch (error) {
        console.error('CSV download error:', error);
        showStatus('Failed to download CSV: ' + error.message, 'error');
      }
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showStatus(message, type = 'ok') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
  </script>
</body>
</html>