<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
	<!-- Authentication Protection -->
	<script src="./auth-check_copy.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<title>All Students List - Dynamic Columns</title>
	<style>
		html{font-size:85%}
		body{font-family: Kalpurush, sans-serif; padding:20px 10px 20px 20px; color:#1f2937; background:#f3f4f6}
		h2{margin:0 0 12px}
		.status{margin:4px 0 16px;color:#4b5563}

		/* landscape cards stacked vertically, aligned to left */
		/* full-page container: table should span page width */
		.container{display:block;width:100%;box-sizing:border-box}

		/* simplified header styles */
		.page-header{display:flex;justify-content:space-between;align-items:center;padding:8px 0;margin-bottom:6px}
		.page-title{font-size:18px;color:#0f172a;margin:0}
		.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#e2e8f0;color:#334155}

		table{width:100%;border-collapse:collapse;margin-top:0;table-layout:auto}
		.table-wrapper{overflow:auto;width:100%}
		th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:middle;white-space:nowrap}
		th{background:#f4f4f4;position:sticky;top:0}
		tbody tr:nth-child(odd){ background:#ffffff }
		tbody tr:nth-child(even){ background:#f5f5f5 }
		tbody tr.status-tc{background-color:rgba(250,187,187,.5) !important}
		.col-sl{width:56px;max-width:56px;padding:4px;text-align:center}

		/* top layout */
		.school-title{ text-align:center; font-size:22px; margin:0 0 6px; color:#0f172a }
		.toolbar{ display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px }
		.selected-csy-print{ display:none; text-align:center; margin:4px 0 8px; font-weight:600 }

		/* column chooser */
		.column-controls{display:none;margin:8px 0 10px;padding:8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px}
		.column-controls .actions{display:flex;gap:8px;margin-bottom:8px}
		.column-controls .actions button{padding:4px 8px;border:1px solid #cbd5e1;border-radius:6px;background:#f8fafc;color:#334155;cursor:pointer}
		.column-controls .actions button:hover{background:#eef2f7}
		.column-controls .list{display:flex;flex-wrap:wrap;gap:8px;max-height:180px;overflow:auto}
		.column-controls .col-item{display:flex;align-items:center;gap:6px;padding:2px 6px;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa}

		@media print {
			/* general */
			html, body{ background:#fff; height:100%; margin:0; padding:0 }
			.column-controls, .toolbar .badge, .status{ display:none !important }
			.selected-csy-print{ display:block !important }
			.school-title{ font-size:18px; margin:0 0 2px; padding:0 }
			/* hide on-screen controls; keep title and selected text visible */
			.toolbar, .print-controls, .print-button, div[style*="position:fixed"][style*="top"] select{ display:none !important }
			/* table layout for print: normal flow with repeating thead */
			thead{ display:table-header-group }
			tfoot{ display:table-footer-group }
			/* prevent rows from being broken across pages and allow headers to repeat */
			table{ page-break-inside:auto; table-layout:fixed !important; width:100% !important; max-width:100% !important; border-collapse:collapse !important }
			tr{ page-break-inside:auto; page-break-after:auto }
			/* hide fixed header in print; rely on thead repeating automatically */
			#printHeader{ display:none !important }
			th, td{ white-space:normal !important; padding:var(--print-pad-v, 4px) var(--print-pad-h, 6px); font-size:var(--print-font, 15.5px); text-align:center; vertical-align:middle; word-break:break-word; overflow-wrap:anywhere; overflow:visible; border:0.5px solid #666 !important }
			th{ background:#e8e8e8 !important; font-weight:bold; font-size:var(--print-font, 15.5px); padding:calc(var(--print-pad-v, 4px) + 1px) var(--print-pad-h, 6px) }
			/* remove reserved space for fixed header */
			#container{ padding-top:0 }
			#container .table-wrapper{ display:block; width:100%; max-width:100%; overflow:visible !important; text-align:center }
			#container .table-wrapper > table{ display:table; margin:0 auto; width:100% !important; text-align:left }
			th{ position:static }
			/* fixed header placed in the page margin; ensure adequate top page margin so content won't overlap */
			#printHeader{ display:block; position:fixed; left:0; right:0; top:0; z-index:9999; background:#fff; padding:4px 0; border-bottom:1px solid #999; font-size:11px; text-align:center; font-weight:bold }
			/* per-page page-number: removed as per user request */
			/* caption.page-caption{ caption-side:top; display:table-caption; text-align:right; font-size:11px; font-weight:700; text-transform:lowercase; padding-bottom:4px } */
			/* print footer */
			/* hide bottom footer in print â€” page numbering is handled by the top-right labels */
			.print-footer{ display:none !important }
			/* ensure content doesn't overlap footer area (kept minimal for printers) */
			body{ padding-bottom:3mm }
			/* standard page margins */
			@page{ margin:0.3cm }
			/* allow natural column widths with wrapping; no forced widths */
		}

		/* floating print button (visible on-screen only) */
		.print-button{
			position:fixed;
			right:16px;
			bottom:16px;
			z-index:10000;
			background:#f97316;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;box-shadow:0 4px 10px rgba(249,115,22,0.22);font-weight:600;
		}
		.print-button:active{ transform:translateY(1px) }
	</style>
</head>
<body>
	<h1 class="school-title">FENI MODEL HIGH SCHOOL</h1>
	<!-- print header that repeats on every page -->
	<div id="printHeader" style="display:none; text-align:center; font-weight:700; font-size:14px; margin-bottom:6px"></div>
	<!-- print footer placeholder will be inserted at end of body for reliable positioning -->
	<div class="toolbar">
		<label for="sessionFilter">Session:</label>
		<select id="sessionFilter">
			<option value="">Select Session</option>
			<option value="2024">2024</option>
			<option value="2025">2025</option>
			<option value="2026">2026</option>
		</select>
		<label for="classFilter">Class:</label>
		<select id="classFilter" disabled>
			<option value="">Select Class</option>
		</select>
		<label for="sectionFilter">Section:</label>
		<select id="sectionFilter" disabled>
			<option value="">All Sections</option>
		</select>
		<span id="status" class="status"></span>
		<div id="columnControls" class="column-controls"></div>
	</div>

	<div id="selectedCsyPrint" class="selected-csy-print" style="text-align:center; font-weight:600; margin-bottom:6px"></div>

	<div id="container" class="container">
		<!-- groups will be rendered here -->
	</div>
	<script>
		// --- Supabase client init for update operations ---
		// Reuse existing project credentials (same as other pages)
		const SUPABASE_URL = 'https://rtfefxghfbtirfnlbucb.supabase.co';
		const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
		let supabaseClient = null;
		(function ensureSupabase(){
			if(window.supabaseClient){
				// Reuse existing client
				supabaseClient = window.supabaseClient;
			} else if(window.supabase){
				window.__supabaseClients = window.__supabaseClients || {};
				window.supabaseClient = window.__supabaseClients[SUPABASE_URL] || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
				window.__supabaseClients[SUPABASE_URL] = window.supabaseClient;
				supabaseClient = window.supabaseClient;
			} else {
				// dynamically inject script if missing
				const s = document.createElement('script');
				s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
				s.onload = () => { 
					window.__supabaseClients = window.__supabaseClients || {};
					window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
					window.__supabaseClients[SUPABASE_URL] = window.supabaseClient;
					supabaseClient = window.supabaseClient;
				};
				document.head.appendChild(s);
			}
		})();
		async function waitForSupabase(){
			if(supabaseClient) return;
			await new Promise(res=>{
				const start=Date.now();
				const t=setInterval(()=>{
					if(supabaseClient || Date.now()-start>8000){ clearInterval(t); res(); }
				},100);
			});
		}
		// Data source: Direct Supabase (two-phase: lite for dropdown, filtered full for selected group)
		const CACHE_KEY = null;
		const CACHE_TTL_MS = 0;

		const container = document.getElementById('container');
		const statusEl = document.getElementById('status');

		// Fixed columns always shown (hide class_section_year and active_roll)
		const FIXED_COLS = ['iid','student_name_en']; // SL is added separately

	// Master dataset removed; full data loaded on-demand for selected group
	let columnSpec = [];
	let liteRows = []; // minimal rows for dropdown + basic display before selection
	let currentGroupRows = []; // full rows for selected group (with all fields)
	let allColumns = []; // discovered columns after first full fetch
	let columnOrder = []; // order from dataorder.csv (field names in preferred sequence)

		async function fetchLite(){
			if(!supabaseClient){ return []; }
			statusEl.textContent='Loading list (lite)...';
			try{
				const { data, error } = await supabaseClient
					.from('student_database')
					.select('iid,session,roll_2025,class_2025,section_2025,roll_2026,class_2026,section_2026,student_name_en,status')
					.limit(20000);
				if(error) throw error;
				return data||[];
			}catch(e){ console.error(e); statusEl.textContent='Lite load error'; return []; }
		}
		async function fetchGroupFull(csy){
			if(!supabaseClient){ return []; }
			statusEl.textContent='Loading group data...';
			try{
				if(csy==='__ALL__'){
					const { data, error } = await supabaseClient.from('student_database').select('*').order('iid',{ascending:true}).limit(20000);
					if(error) throw error; return data||[];
				}
				// csy format: class-section-session
				const parts = csy.split('-');
				const cls = parts[0]||''; const sec = parts[1]||''; const ses = parts[2]||'';
				// Need records where active (session) matches; active means for that session use matching class/section/roll
				// We'll fetch rows with that session then filter in JS (keeps query simple)
				const { data, error } = await supabaseClient.from('student_database').select('*').eq('session', ses).limit(20000);
				if(error) throw error;
				const rows = (data||[]).filter(r=>{
					if(Number(r.session)===2026) return String(r.class_2026||'')===cls && String(r.section_2026||'')===sec;
					if(Number(r.session)===2025) return String(r.class_2025||'')===cls && String(r.section_2025||'')===sec;
					return false;
				});
				return rows;
			}catch(e){ console.error(e); statusEl.textContent='Group load error'; return []; }
		}

		function groupByClassSection(rows){
			// Exclude TC-status rows from display
			const filtered = rows.filter(r => !String(r.status||'').toUpperCase().includes('TC'));
			// Return all rows as a single group for unified table display
			const allRows = [...filtered].sort((a,b)=>{
				// Sort by class, section, roll, then iid
				const ca = Number(a.class_2025) || 0, cb = Number(b.class_2025) || 0;
				if(ca !== cb) return ca - cb;
				const secCmp = (a.section_2025 || '').localeCompare(b.section_2025 || '');
				if(secCmp !== 0) return secCmp;
				const ra = Number(a.roll_2025) || 0, rb = Number(b.roll_2025) || 0;
				if(ra !== rb) return ra - rb;
				const ia = Number(a.iid) || 0, ib = Number(b.iid) || 0;
				return ia - ib;
			});
			return [{ class_: 'All Classes', section: '', session: '', rows: allRows }];
		}

		function escapeHtml(s){
			if(s===null||s===undefined) return '';
			return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
		}

		const SELECTED_COLS_KEY = 'print_data_selected_columns_v1';
		const SELECTED_EDITABLE_KEY = 'print_data_selected_editable_v1';
		let selectedColumns = [];
		let selectedEditable = null; // single column that is editable (last selected)
		let latestFilteredRows = [];
		const columnControlsEl = document.getElementById('columnControls');

		function loadSelectedColumns(){
			try{ const raw = localStorage.getItem(SELECTED_COLS_KEY); return raw? JSON.parse(raw): []; }catch(e){ return []; }
		}
		function saveSelectedColumns(){
			try{ localStorage.setItem(SELECTED_COLS_KEY, JSON.stringify(selectedColumns)); }catch(e){}
		}
		function loadSelectedEditable(){
			try{ const raw = localStorage.getItem(SELECTED_EDITABLE_KEY); return raw? String(raw): null; }catch(e){ return null; }
		}
		function saveSelectedEditable(){
			try{ if(selectedEditable) localStorage.setItem(SELECTED_EDITABLE_KEY, String(selectedEditable)); else localStorage.removeItem(SELECTED_EDITABLE_KEY); }catch(e){}
		}
		function computeAvailableColumns(){
			if(allColumns.length) return allColumns;
			const set = new Set();
			for(const r of currentGroupRows||[]){ for(const k of Object.keys(r||{})){ set.add(k); } }
			FIXED_COLS.forEach(c=> set.delete(c));
			// Do not offer these auto columns for selection
			set.delete('class_section_year');
			set.delete('active_roll');
			set.delete('SL');
			let cols = Array.from(set);
			// If we loaded a preferred column order from dataorder.csv, sort by that order.
			if(Array.isArray(columnOrder) && columnOrder.length){
				cols.sort((a,b)=>{
					const ia = columnOrder.indexOf(a);
					const ib = columnOrder.indexOf(b);
					if(ia === -1 && ib === -1) return a.localeCompare(b);
					if(ia === -1) return 1; // unknown columns go after known ones
					if(ib === -1) return -1;
					return ia - ib;
				});
			} else {
				cols.sort((a,b)=> a.localeCompare(b));
			}
			allColumns = cols;
			return allColumns;
		}

		// Load and parse dataorder.csv (simple parser: takes left side of '>' for each mapping line)
		async function loadColumnOrder(){
			try{
				const res = await fetch('dataorder.csv');
				if(!res.ok) throw new Error('Failed to fetch dataorder.csv');
				const text = await res.text();
				const lines = text.split(/\r?\n/);
				const order = [];
				for(const line of lines){
					const t = line.trim();
					if(!t) continue;
					if(t.startsWith('#')) continue;
					// only consider lines with '>' mapping
					if(t.includes('>')){
						const parts = t.split('>');
						const key = parts[0].trim();
						if(key) order.push(key);
					}
				}
				// dedupe while preserving order
				columnOrder = Array.from(new Set(order));
			}catch(err){
				console.warn('Could not load dataorder.csv, falling back to alphabetical order', err);
				columnOrder = [];
			}
		}
		function buildColumnControls(columns){
			if(!columnControlsEl) return;
			// keep only selections that still exist
			selectedColumns = (selectedColumns||[]).filter(c => columns.includes(c));
			// ensure selectedEditable still exists and is in selectedColumns
			if(selectedEditable && !columns.includes(selectedEditable)){
				selectedEditable = null; saveSelectedEditable();
			}
			// enforce max 4 viewable columns
			if(selectedColumns.length > 8){ selectedColumns = selectedColumns.slice(0,8); saveSelectedColumns(); }
			columnControlsEl.style.display = columns.length? 'block':'none';
			columnControlsEl.innerHTML = '';
			const actions = document.createElement('div'); actions.className = 'actions';
			const btnAll = document.createElement('button'); btnAll.type='button'; btnAll.textContent='Select all';
			const btnClear = document.createElement('button'); btnClear.type='button'; btnClear.textContent='Clear';
			actions.appendChild(btnAll); actions.appendChild(btnClear);
			columnControlsEl.appendChild(actions);
			const list = document.createElement('div'); list.className='list';
			const warn = document.createElement('div'); warn.style.fontSize='11px'; warn.style.marginTop='4px'; warn.style.color='#b45309'; warn.textContent='Max 4 columns can be ticked to view; the last selected column is editable.';
			columns.forEach(col=>{
				const label = document.createElement('label'); label.className='col-item';
				const cb = document.createElement('input'); cb.type='checkbox'; cb.value=col; cb.checked = selectedColumns.includes(col);
				const txt = document.createElement('span'); txt.textContent = col;
				label.appendChild(cb); label.appendChild(txt);
				// editable badge
				const badge = document.createElement('span'); badge.style.fontSize='11px'; badge.style.color='#059669'; badge.style.marginLeft='6px'; badge.textContent='(editable)';
				if(selectedEditable !== col) badge.style.display='none';
				label.appendChild(badge);
				list.appendChild(label);
			});
			columnControlsEl.appendChild(list);
			columnControlsEl.appendChild(warn);
			btnAll.onclick = ()=>{ selectedColumns = [...columns].slice(0,8); selectedEditable = selectedColumns[selectedColumns.length-1] || null; saveSelectedColumns(); saveSelectedEditable(); reRenderTable(); buildColumnControls(columns); };
			btnClear.onclick = ()=>{ selectedColumns = []; selectedEditable = null; saveSelectedColumns(); saveSelectedEditable(); reRenderTable(); buildColumnControls(columns); };
			list.addEventListener('change', (e)=>{
				const t = e.target;
				if(t && t.tagName==='INPUT' && t.type==='checkbox'){
					if(t.checked){ 
						if(!selectedColumns.includes(t.value)){
							if(selectedColumns.length >= 8){ t.checked=false; warn.style.color='#dc2626'; warn.textContent='Limit 8 reached'; return; }
							selectedColumns.push(t.value);
						}
						// last selected becomes editable
						selectedEditable = t.value;
						saveSelectedEditable();
						warn.style.color='#b45309'; warn.textContent='Max 8 columns can be ticked to view; the last selected column is editable.';
					} else {
						selectedColumns = selectedColumns.filter(x=>x!==t.value);
						if(selectedEditable === t.value){ selectedEditable = selectedColumns[selectedColumns.length-1] || null; saveSelectedEditable(); }
						warn.style.color='#b45309'; warn.textContent='Max 8 columns can be ticked to view; the last selected column is editable.';
					}
					saveSelectedColumns();
					reRenderTable();
					buildColumnControls(columns);
				}
			});
		}

		function reRenderTable(){
			// rebuild only the table area inside container using latestFilteredRows and selectedColumns
			container.innerHTML = '';
			if(!latestFilteredRows || latestFilteredRows.length===0){ return; }
			// No columns selected -> show hint and stop
			if(!selectedColumns || selectedColumns.length===0){
				statusEl.textContent = 'Tick columns to display';
				return;
			}
			const tableWrapper = document.createElement('div'); tableWrapper.className='table-wrapper';
			const table = document.createElement('table');
			const thead = document.createElement('thead');
			const htr = document.createElement('tr');
			const headerCols = ['SL', 'iid', 'student_name_en'];
			selectedColumns.forEach(c => { headerCols.push(c + (selectedEditable === c ? ' (editable)' : '')); });
			headerCols.push('Update');
			headerCols.forEach(h=>{ const th = document.createElement('th'); th.textContent = h; htr.appendChild(th); });
			thead.appendChild(htr); table.appendChild(thead);
			const tbody = document.createElement('tbody');
			latestFilteredRows.forEach((row, idx)=>{
				const tr = document.createElement('tr');
				if(String(row.status||'').toUpperCase().includes('TC')) tr.className = 'status-tc';
				const sltd = document.createElement('td'); sltd.className='col-sl'; sltd.textContent=(idx+1); tr.appendChild(sltd);
				// Fixed: iid link
				const iidRaw = row.iid ?? row.IID ?? '';
				const tdIid = document.createElement('td');
				const a = document.createElement('a'); a.href=`detailsinfo.html?iid=${encodeURIComponent(iidRaw)}`; a.textContent=escapeHtml(String(iidRaw)); a.style.color='#0b74de'; a.style.textDecoration='underline';
				tdIid.appendChild(a); tr.appendChild(tdIid);
				// Fixed: class_section_year + active_roll (now build class-section-year even if roll missing)
				const sNum = Number(row.session);
				let active_roll = '', active_class = '', active_section = '';
				if(Number.isFinite(sNum) && sNum === 2026){ active_roll = row.roll_2026 ?? ''; active_class = row.class_2026 ?? ''; active_section = row.section_2026 ?? ''; }
				else if(Number.isFinite(sNum) && sNum === 2025){ active_roll = row.roll_2025 ?? ''; active_class = row.class_2025 ?? ''; active_section = row.section_2025 ?? ''; }
			// Fixed: student_name_en (class_section_year and active_roll hidden as requested)
			const nameEn = row.student_name_en ?? '';
			const tdName = document.createElement('td'); tdName.textContent = escapeHtml(nameEn); tr.appendChild(tdName);

				// Render selected columns: only selectedEditable is editable; others shown as text
				selectedColumns.forEach(col=>{
					const td = document.createElement('td');
					const v = row[col];
					const valStr = v==null? '' : String(v);
					if(selectedEditable === col){
						const inp = document.createElement('input');
						inp.type='text'; inp.value=valStr; inp.setAttribute('data-field', col); inp.setAttribute('data-original', valStr); inp.setAttribute('data-iid', iidRaw);
						inp.style.width='140px'; inp.style.boxSizing='border-box'; inp.style.padding='4px 6px'; inp.style.border='1px solid #cbd5e1'; inp.style.borderRadius='4px'; inp.style.fontSize='12px';
						inp.addEventListener('input', ()=>{
							const orig = inp.getAttribute('data-original') || '';
							if(inp.value !== orig){ inp.style.background='#fff7e6'; inp.style.borderColor='#f59e0b'; }
							else { inp.style.background='#ffffff'; inp.style.borderColor='#cbd5e1'; }
						});
						td.appendChild(inp);
					} else {
						td.textContent = escapeHtml(valStr);
					}
					tr.appendChild(td);
				});

				// Update button
				const tdUpdate = document.createElement('td');
				const btn = document.createElement('button'); btn.type='button'; btn.textContent='Update';
				btn.style.padding='4px 8px'; btn.style.fontSize='12px'; btn.style.background='#2563eb'; btn.style.color='#fff'; btn.style.border='1px solid #1d4ed8'; btn.style.borderRadius='4px'; btn.style.cursor='pointer';
				btn.addEventListener('click', ()=> updateRow(iidRaw, tr, btn));
				tdUpdate.appendChild(btn); tr.appendChild(tdUpdate);
				tbody.appendChild(tr);
			});
			table.appendChild(tbody);
			tableWrapper.appendChild(table);
			container.appendChild(tableWrapper);
			const sampleRow = latestFilteredRows[0];
			const sessionValue = sampleRow ? String(sampleRow.session || '').trim() : '';
			statusEl.textContent = `Total Students: ${latestFilteredRows.length} | Session sample: ${sessionValue || 'N/A'}`;
		}

		async function updateRow(iidRaw, tr, btn){
			if(!supabaseClient){ alert('Supabase not ready yet'); return; }
			const iidNum = Number(iidRaw);
			if(!Number.isFinite(iidNum)){ alert('Invalid IID'); return; }
			const inputs = tr.querySelectorAll('input[data-field]');
			const payload = {}; let changed = 0;
			inputs.forEach(inp=>{
				const field = inp.getAttribute('data-field');
				const orig = inp.getAttribute('data-original') || '';
				if(inp.value !== orig){
					payload[field] = inp.value === '' ? null : inp.value;
					changed++;
				}
			});
			if(changed === 0){ btn.textContent='No change'; setTimeout(()=>{ btn.textContent='Update'; }, 800); return; }
			btn.disabled = true; const oldTxt = btn.textContent; btn.textContent='Updating...'; btn.style.opacity='0.7';
			try{
				const { error } = await supabaseClient.from('student_database').update(payload).eq('iid', iidNum);
				if(error) throw error;
				// success: update originals + caches
				inputs.forEach(inp=>{
					const field = inp.getAttribute('data-field');
					if(Object.prototype.hasOwnProperty.call(payload, field)){
						inp.setAttribute('data-original', inp.value);
						inp.style.background='#e6ffed'; inp.style.borderColor='#10b981';
					}
				});
				// update current arrays
				for(let r of latestFilteredRows){ if(Number(r.iid)===iidNum){ Object.assign(r, payload); break; } }
				for(let r of currentGroupRows){ if(Number(r.iid)===iidNum){ Object.assign(r, payload); break; } }
				btn.textContent='Saved'; btn.style.background='#059669'; btn.style.borderColor='#047857';
				setTimeout(()=>{ btn.textContent='Update'; btn.style.background='#2563eb'; btn.style.borderColor='#1d4ed8'; inputs.forEach(inp=>{ if(inp.style.background==='#e6ffed'){ inp.style.background='#ffffff'; inp.style.borderColor='#cbd5e1'; } }); }, 1100);
			}catch(err){
				console.error('Update error', err);
				btn.textContent='Error'; btn.style.background='#dc2626'; btn.style.borderColor='#b91c1c';
				setTimeout(()=>{ btn.textContent=oldTxt; btn.style.background='#2563eb'; btn.style.borderColor='#1d4ed8'; }, 1600);
			}finally{
				btn.disabled=false; btn.style.opacity='1';
			}
		}

		selectedColumns = loadSelectedColumns();

		/* ===================== NEW FILTER RENDER FLOW (Class -> Section, Session=2025) ===================== */
		let selectedSession = '';
		let selectedClass = '';
		let selectedSection = '';
		const sessionFilterEl = document.getElementById('sessionFilter');
		const classFilterEl = document.getElementById('classFilter');
		const sectionFilterEl = document.getElementById('sectionFilter');

		function getActiveFields(row){
			const sNum = Number(row.session);
			if(sNum === 2026){
				return {active_class: row.class_2026 ?? '', active_section: row.section_2026 ?? '', active_roll: row.roll_2026 ?? ''};
			}
			if(sNum === 2025){
				return {active_class: row.class_2025 ?? '', active_section: row.section_2025 ?? '', active_roll: row.roll_2025 ?? ''};
			}
			// fallback
			return {active_class: '', active_section: '', active_roll: ''};
		}

		function buildSessionOptions(){
			// Provide fixed session options for selection
			sessionFilterEl.innerHTML = '<option value="">Select Session</option>\n\t\t\t<option value="2024">2024</option>\n\t\t\t<option value="2025">2025</option>\n\t\t\t<option value="2026">2026</option>';
			classFilterEl.innerHTML = '<option value="">Select Class</option>';
			sectionFilterEl.innerHTML = '<option value="">All Sections</option>';
			classFilterEl.disabled = true; sectionFilterEl.disabled = true;
		}

		async function buildClassOptions(){
			if(!selectedSession) return; // need session selected
			console.debug('buildClassOptions (edit): selectedSession=', selectedSession, 'liteRows=', liteRows ? liteRows.length : 0);
			statusEl.textContent = 'Loading classes...';
			const field = `class_${selectedSession}`; // e.g., class_2025
			const classes = new Set();
			// derive classes from class_<session> field across liteRows (don't require row.session)
			liteRows.forEach(r=>{ try{ const v = r && (r[field] !== undefined ? r[field] : (r[field.toUpperCase()]!==undefined ? r[field.toUpperCase()] : undefined)); if(v!==undefined && v!==null && String(v).trim()!==''){ classes.add(String(v)); } }catch(e){} });
			// DB fallback if none found in liteRows
			if(classes.size === 0 && typeof supabaseClient !== 'undefined' && supabaseClient){
				try{
					console.debug('buildClassOptions (edit): DB fallback for', field);
					const { data: dbData, error: dbErr } = await supabaseClient.from('student_database').select(field).not(field, 'is', null).limit(20000);
					if(!dbErr && dbData){ dbData.forEach(r=>{ const v = r && (r[field] !== undefined ? r[field] : (r[field.toUpperCase()]!==undefined ? r[field.toUpperCase()] : undefined)); if(v!==undefined && v!==null && String(v).trim()!=='') classes.add(String(v)); }); }
					else if(dbErr) console.warn('DB fallback error', dbErr);
				}catch(e){ console.warn('DB fallback exception', e); }
			}
			const sorted = Array.from(classes).sort((a,b)=>{ const na=Number(a), nb=Number(b); if(!isNaN(na)&&!isNaN(nb)) return na-nb; return String(a).localeCompare(String(b)); });
			console.debug('buildClassOptions (edit): found classes=', sorted);
			classFilterEl.innerHTML = '<option value="">Select Class</option>' + sorted.map(c=>`<option value="${c}">${c}</option>`).join('');
			classFilterEl.disabled = sorted.length === 0; sectionFilterEl.disabled = true; sectionFilterEl.innerHTML = '<option value="">All Sections</option>';
			statusEl.textContent = sorted.length ? 'Pick class' : 'No classes found for selected session';
		}

		function buildSectionOptions(){
			if(!selectedClass){ return; }
			const rows = currentGroupRows; // already filtered by class
			const sections = new Set();
			rows.forEach(r=>{ const {active_section} = getActiveFields(r); if(active_section){ sections.add(String(active_section)); } });
			const sorted = Array.from(sections).sort((a,b)=> String(a).localeCompare(String(b)));
			sectionFilterEl.innerHTML = '<option value="">All Sections</option>' + sorted.map(s=>`<option value="${s}">${s}</option>`).join('');
			sectionFilterEl.disabled = false;
		}

		function applySectionFilter(){
			if(!selectedClass){ latestFilteredRows = []; container.innerHTML=''; statusEl.textContent='Select Class'; return; }
			if(!currentGroupRows.length){ container.innerHTML=''; statusEl.textContent='No data for selection'; return; }
			if(!selectedSection){
				latestFilteredRows = currentGroupRows.slice();
			}else{
				latestFilteredRows = currentGroupRows.filter(r=>{ const {active_section} = getActiveFields(r); return String(active_section)===String(selectedSection); });
			}
			
			// Sort rows by active_roll numerically
			latestFilteredRows.sort((a, b) => {
				const {active_roll: rollA} = getActiveFields(a);
				const {active_roll: rollB} = getActiveFields(b);
				const numA = Number(rollA) || 0;
				const numB = Number(rollB) || 0;
				if(isNaN(numA) || isNaN(numB)) return String(rollA).localeCompare(String(rollB));
				return numA - numB;
			});
			
			const availableColumns = computeAvailableColumns();
			if((!selectedColumns || selectedColumns.length===0) && availableColumns.length){
				selectedColumns = availableColumns.slice(0, Math.min(4, availableColumns.length));
				selectedEditable = selectedColumns[selectedColumns.length-1] || null; saveSelectedColumns(); saveSelectedEditable();
			}
			buildColumnControls(availableColumns);
			reRenderTable();
			statusEl.textContent = `Loaded ${latestFilteredRows.length} rows (Session: ${selectedSession}, Class: ${selectedClass}${selectedSection? ', Section: '+selectedSection:''})`;
		}

		async function loadGroupData(){
			if(!selectedClass){ return; }
			statusEl.textContent='Loading data...';
			try {
				const field = `class_${selectedSession}`; // e.g., class_2025
				const { data, error } = await supabaseClient.from('student_database').select('*').eq(field, selectedClass).limit(20000);
				if(error) throw error;
				// exclude TC rows
				currentGroupRows = (data||[]).filter(r=> !String(r.status||'').toUpperCase().includes('TC'));
				allColumns = []; // reset for recompute
				buildSectionOptions();
				applySectionFilter();
			} catch(err){
				console.error(err); statusEl.textContent='Load error';
			}
		}

		// Allow selecting session; update classes on change
		sessionFilterEl.addEventListener('change', async ()=>{
			selectedSession = sessionFilterEl.value; console.debug('session changed (edit) ->', selectedSession, 'liteRows:', liteRows ? liteRows.length : 0);
			selectedClass=''; selectedSection='';
			container.innerHTML=''; currentGroupRows=[]; latestFilteredRows=[];
			await buildClassOptions();
			statusEl.textContent = selectedSession? 'Select Class' : 'Select Session';
		});
		classFilterEl.addEventListener('change', async ()=>{
			selectedClass = classFilterEl.value; selectedSection=''; container.innerHTML=''; currentGroupRows=[]; latestFilteredRows=[]; sectionFilterEl.innerHTML = '<option value="">All Sections</option>'; sectionFilterEl.disabled=true;
			if(selectedClass){ await loadGroupData(); } else { statusEl.textContent='Select Class'; }
		});
		sectionFilterEl.addEventListener('change', ()=>{ selectedSection = sectionFilterEl.value; applySectionFilter(); });

		/* ===================== LEGACY RENDER FUNCTION (unused now) LEFT FOR REFERENCE ===================== */
		async function render(groups){
			container.innerHTML = '';
			// Use document fragment for better performance
			const fragment = document.createDocumentFragment();
			statusEl.textContent='(Legacy render not used)';
		}

		// legacy loadLite/loadGroup removed in favor of new flow

		// Init: lite first
		(async function init(){
			await waitForSupabase();
			await loadColumnOrder();
			liteRows = await fetchLite();
			buildSessionOptions();
			statusEl.textContent='Select Session';
		})();
	</script>
</body>
</html>
