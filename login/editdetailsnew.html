<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Edit Details</title>
  <style>
  /* Clean monochromatic design with white and shadows only */
  html{font-size:125%;}
  html,body{height:100%}
  body{font-family:'Kalpurush', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding:28px; background:#f8f9fa; color:#333; margin:0}
  
  .container{max-width:980px;margin:0 auto}
  .card{background:#ffffff;border-radius:12px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.1);}
  
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
  .title{font-size:22px;font-weight:600;color:#333}
  .meta{color:#666; font-size:14px}
  .iid-badge{display:inline-block;margin-left:8px;padding:6px 12px;background:#f0f0f0;color:#666;border-radius:20px;font-weight:500;font-size:13px}

  .form-grid{display:flex;flex-direction:column;gap:16px}
  
  /* Photo area */
  .photo-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:20px}
  .photo-wrap img{width:140px;height:140px;object-fit:cover;border-radius:12px;border:3px solid #fff;box-shadow:0 8px 24px rgba(0,0,0,0.15);background:#fff}
  .student-name{margin-top:10px;font-weight:600;font-size:1.1rem;color:#333}
  
  /* Form fields */
  .field-row{display:grid;grid-template-columns:180px 1.4fr;gap:12px;align-items:start;background:#ffffff;padding:16px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.08);border:1px solid #f0f0f0}
  .field-row label{font-size:14px;color:#555;font-weight:500;padding:8px 0}
  .field-row input, .field-row textarea{width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:8px;font-size:14px;background:#ffffff;color:#333}
  .field-row textarea{min-height:100px;resize:vertical}
  
  .field-row:hover{box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  .field-row input:focus, .field-row textarea:focus{outline:none;border-color:#ccc;box-shadow:0 0 0 2px rgba(0,0,0,0.1)}

  .actions{display:flex;justify-content:flex-end;gap:12px;margin-top:24px}
  .btn{padding:12px 20px;border:none;background:#333;color:#fff;border-radius:8px;cursor:pointer;font-weight:500;font-size:14px}
  .btn:hover{background:#555}
  .btn.secondary{background:#f0f0f0;color:#666;border:1px solid #e0e0e0}
  .btn.secondary:hover{background:#e0e0e0}
  
  .notice{margin-top:16px;color:#d32f2f;font-weight:500}
  .notice.success{color:#2e7d32}

  /* Group headers */
  .field-group {
    margin: 24px 0 16px 0;
  }
  .field-group h3 {
    font-size: 16px;
    font-weight: 600;
    color: #555;
    margin: 0 0 12px 0;
    padding: 8px 16px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #ddd;
  }
  .field-group:first-child h3 {
    margin-top: 0;
  }
  /* photo preview */
  #photo-preview{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;width:350px;height:500px;border:4px solid #000;background:#fff;padding:10px;border-radius:10px;display:none;pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Edit Record</div>
          <div class="meta">Modify fields below and click <strong>Update</strong></div>
        </div>
        <div id="info" class="meta"></div>
      </div>

  <div id="photoWrap" class="photo-wrap"></div>
  <div id="fields" class="form-grid"></div>

      <div class="actions">
        <button id="updateBtn" class="btn">Update</button>
      </div>
      <div id="notice" class="notice"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // same supabase creds as entry.html
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const tableName = 'student_database';

    const params = new URLSearchParams(window.location.search);
    const iid = params.get('iid');

    const fieldsEl = document.getElementById('fields');
    const infoEl = document.getElementById('info');
    const noticeEl = document.getElementById('notice');
    const updateBtn = document.getElementById('updateBtn');
    const backBtn = document.getElementById('backBtn');

    // Store field order mapping
    let fieldOrderMap = {};
    let fieldDisplayNames = {};
    let fieldGroups = [];

    updateBtn.addEventListener('click', saveChanges);

    // Load field order from CSV
    async function loadFieldOrder(){
      try{
        const response = await fetch('dataorder.csv');
        if(!response.ok) throw new Error('Could not load dataorder.csv');
        const csvText = await response.text();
        const lines = csvText.split('\n');
        
        let currentGroup = [];
        let groupIndex = 0;
        
        lines.forEach((line, index) => {
          const trimmedLine = line.trim();
          
          // Skip header and empty lines
          if(trimmedLine === '' || trimmedLine.startsWith('colm name')) {
            // If we have a current group and encounter a blank line, save the group
            if(currentGroup.length > 0) {
              fieldGroups.push({
                index: groupIndex++,
                fields: [...currentGroup]
              });
              currentGroup = [];
            }
            return;
          }
          
          // Parse field mapping
          const parts = trimmedLine.split('>').map(part => part.trim());
          if(parts.length >= 2){
            const dbField = parts[0];
            const displayName = parts[1];
            fieldOrderMap[dbField] = displayName;
            fieldDisplayNames[dbField] = displayName;
            currentGroup.push(dbField);
          }
        });
        
        // Add the last group if it exists
        if(currentGroup.length > 0) {
          fieldGroups.push({
            index: groupIndex,
            fields: [...currentGroup]
          });
        }
        
      }catch(err){
        console.warn('Could not load field order:', err);
        // Fallback to default alphabetical order
      }
    }

    if(!iid){
      infoEl.innerHTML = '<span class="iid-badge">No IID</span>';
      updateBtn.disabled = true;
    } else {
      // safe display
      const span = document.createElement('span');
      span.className = 'iid-badge';
      span.textContent = iid;
      infoEl.appendChild(span);
      loadRecord(iid);
    }

    async function loadRecord(iid){
      noticeEl.textContent = 'Loading...';
      try{
        // First load field order
        await loadFieldOrder();
        
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
          .eq('iid', Number(iid))
          .limit(1)
          .single();
        if(error) throw error;
        
        renderFields(data || {});
        // render photo and name
        try{ await renderPhotoForIID(iid, data); }catch(e){ console.warn('photo render failed', e); }
        noticeEl.textContent = '';
      }catch(err){
        console.error('loadRecord error', err);
        noticeEl.textContent = 'Failed to load record: ' + (err.message || err);
        updateBtn.disabled = true;
      }
    }

    async function renderPhotoForIID(iid, record){
      const wrap = document.getElementById('photoWrap');
      wrap.innerHTML = '';
      // fetch CSV of image links
      try{
        const resp = await fetch('../photo/link.csv');
        if(!resp.ok) throw new Error('photo list not loaded');
        const txt = await resp.text();
        const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(lines.length === 0) return;

        // Find the link that matches the pattern: ends with avatar-{iid}.jpg or avatar-{iid}.png
        let imgUrl = null;
        const jpgPattern = new RegExp(`avatar-${iid}\\.jpg$`);
        const pngPattern = new RegExp(`avatar-${iid}\\.png$`);

        for(const line of lines){
          if(line && (jpgPattern.test(line) || pngPattern.test(line))){
            imgUrl = line;
            break;
          }
        }

        // If no matching image found, show default avatar
        if(!imgUrl){
          const img = document.createElement('img');
          img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDE0MCAxNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNDAiIGhlaWdodD0iMTQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjcwIiBjeT0iNTUiIHI9IjMwIiBmaWxsPSIjQzRDNEM0Ii8+CjxwYXRoIGQ9Ik03MCA4NUM2MCA4NSA2MCA3NSA3MCA3NUM4MCA3NSA4MCA4NSA3MCA4NVoiIGZpbGw9IiNDNEM0RDQiLz4KPHBhdGggZD0iTTcwIDEwNUM2MCAxMDUgNjAgMTE1IDcwIDExNUM4MCAxMTUgODAgMTA1IDcwIDEwNVoiIGZpbGw9IiNDNEM0RDQiLz4KPC9zdmc+';
          img.alt = 'Default Avatar';
          img.style.maxWidth = '140px';
          img.style.maxHeight = '320px';

          const nameEl = document.createElement('div');
          nameEl.className = 'student-name';
          nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

          wrap.appendChild(img);
          wrap.appendChild(nameEl);
          return;
        }

        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = 'Student Photo';
        img.style.maxWidth = '140px';
        img.style.maxHeight = '220px';

        const nameEl = document.createElement('div');
        nameEl.className = 'student-name';
        nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

        wrap.appendChild(img);
        wrap.appendChild(nameEl);
      }catch(err){
        console.warn('renderPhotoForIID error', err);
        // Show default avatar on error
        const img = document.createElement('img');
        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDE0MCAxNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNDAiIGhlaWdodD0iMTQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjcwIiBjeT0iNTUiIHI9IjMwIiBmaWxsPSIjQzRDNEM0Ii8+CjxwYXRoIGQ9Ik03MCA4NUM2MCA4NSA2MCA3NSA3MCA3NUM4MCA3NSA4MCA4NSA3MCA4NVoiIGZpbGw9IiNDNEM0RDQiLz4KPHBhdGggZD0iTTcwIDEwNUM2MCAxMDUgNjAgMTE1IDcwIDExNUM4MCAxMTUgODAgMTA1IDcwIDEwNVoiIGZpbGw9IiNDNEM0RDQiLz4KPC9zdmc+';
        img.alt = 'Default Avatar';
        img.style.maxWidth = '140px';
        img.style.maxHeight = '220px';

        const nameEl = document.createElement('div');
        nameEl.className = 'student-name';
        nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

        wrap.appendChild(img);
        wrap.appendChild(nameEl);
      }
    }

    function renderFields(record){
      fieldsEl.innerHTML = '';
      
      // Get all field keys
      const allKeys = Object.keys(record);
      
      // Separate ordered and unordered fields
      const orderedFields = [];
      const unorderedFields = [];
      
      allKeys.forEach(key => {
        if(fieldOrderMap.hasOwnProperty(key)){
          orderedFields.push(key);
        } else {
          unorderedFields.push(key);
        }
      });
      
      // Function to get group name based on first field in group
      function getGroupName(fields) {
        if(fields.includes('iid') || fields.includes('student_name_en')) return 'Basic Information';
        if(fields.includes('class_2025')) return 'Class Information';
        if(fields.includes('father_name_en')) return 'Father Information';
        if(fields.includes('mother_name_en')) return 'Mother Information';
        if(fields.includes('guardian_name_en')) return 'Guardian Information';
        if(fields.includes('board_name')) return 'Board Information';
        if(fields.includes('village_bn')) return 'Address Information';
        if(fields.includes('previous_school')) return 'School Information';
        return 'Other Information';
      }
      
      // Render grouped fields
      fieldGroups.forEach(group => {
        const groupFields = group.fields.filter(field => orderedFields.includes(field));
        
        if(groupFields.length > 0) {
          // Create group container
          const groupDiv = document.createElement('div');
          groupDiv.className = 'field-group';
          
          // Create group header
          const groupHeader = document.createElement('h3');
          groupHeader.textContent = getGroupName(groupFields);
          groupDiv.appendChild(groupHeader);
          
          // Add fields in this group
          groupFields.forEach(key => {
            const val = record[key] === null || record[key] === undefined ? '' : record[key];
            const row = document.createElement('div');
            row.className = 'field-row';
            
            const label = document.createElement('label');
            const displayName = fieldDisplayNames[key] || key;
            label.textContent = displayName + ':';
            
            let input;
            if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
              input = document.createElement('textarea');
              input.rows = 4;
            } else {
              input = document.createElement('input');
              input.type = 'text';
            }
            input.value = val;
            input.setAttribute('data-field', key);
            if(key === 'iid') input.readOnly = true;
            
            row.appendChild(label);
            row.appendChild(input);
            groupDiv.appendChild(row);
          });
          
          fieldsEl.appendChild(groupDiv);
        }
      });
      
      // Render unordered fields at the end
      if(unorderedFields.length > 0) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'field-group';
        
        const groupHeader = document.createElement('h3');
        groupHeader.textContent = 'Additional Information';
        groupDiv.appendChild(groupHeader);
        
        unorderedFields.sort().forEach(key => {
          const val = record[key] === null || record[key] === undefined ? '' : record[key];
          const row = document.createElement('div');
          row.className = 'field-row';
          
          const label = document.createElement('label');
          const displayName = fieldDisplayNames[key] || key;
          label.textContent = displayName + ':';
          
          let input;
          if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
            input = document.createElement('textarea');
            input.rows = 4;
          } else {
            input = document.createElement('input');
            input.type = 'text';
          }
          input.value = val;
          input.setAttribute('data-field', key);
          if(key === 'iid') input.readOnly = true;
          
          row.appendChild(label);
          row.appendChild(input);
          groupDiv.appendChild(row);
        });
        
        fieldsEl.appendChild(groupDiv);
      }
    }

    async function saveChanges(){
      noticeEl.textContent = '';
      const inputs = fieldsEl.querySelectorAll('[data-field]');
      const payload = {};
      inputs.forEach(inp =>{
        const field = inp.getAttribute('data-field');
        if(field === 'iid') return;
        const v = inp.value === '' ? null : inp.value;
        payload[field] = v;
      });
      updateBtn.disabled = true;
      updateBtn.textContent = 'Updating...';
      try{
        const { data, error } = await supabase
          .from(tableName)
          .update(payload)
          .eq('iid', Number(iid));
        if(error) throw error;
  noticeEl.classList.remove('');
  noticeEl.classList.add('success');
  noticeEl.textContent = 'Updated successfully.';
      }catch(err){
        console.error('update error', err);
  noticeEl.classList.remove('success');
  noticeEl.textContent = 'Update failed: ' + (err.message || err);
      }finally{
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update';
      }
    }

    // photo preview functionality
    const photoWrap = document.getElementById('photoWrap');
    const photoPreview = document.createElement('div');
    photoPreview.id = 'photo-preview';
    const previewImg = document.createElement('img');
    previewImg.style.width = '100%';
    previewImg.style.height = '100%';
    previewImg.style.objectFit = 'cover';
    photoPreview.appendChild(previewImg);
    document.body.appendChild(photoPreview);

    photoWrap.addEventListener('mouseover', (e) => {
      if(e.target.tagName === 'IMG'){
        previewImg.src = e.target.src;
        photoPreview.style.display = 'block';
      }
    });

    photoWrap.addEventListener('mouseout', (e) => {
      if(e.target.tagName === 'IMG'){
        photoPreview.style.display = 'none';
      }
    });
  </script>
</body>
</html>
