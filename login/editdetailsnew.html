<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <!-- Authentication Protection -->
  <script src="./auth-check_copy.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>Edit Details</title>
  <style>
  /* Clean monochromatic design with white and shadows only */
  html{font-size:125%;}
  html,body{height:100%}
  body{font-family: -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding:16px; background:#f8f9fa; color:#333; margin:0}
  
  .container{max-width:720px;margin:0 auto}
  
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:600;color:#333}
  .meta{color:#666; font-size:13px}
  .iid-badge{display:inline-block;margin-left:8px;padding:6px 12px;background:#f0f0f0;color:#666;border-radius:20px;font-weight:500;font-size:13px}

  .form-grid{display:flex;flex-direction:column;gap:4px}
  
  /* Photo area */
  .photo-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;padding:8px;background:#ffffff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #f0f0f0}
  .photo-wrap img{width:120px;height:120px;object-fit:cover;border-radius:8px;border:2px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:#fff}
  .student-name{margin-top:8px;font-weight:600;font-size:1rem;color:#333;text-align:center}
  
  /* Form fields */
  .field-row{display:grid;grid-template-columns:160px 1.4fr;gap:10px;align-items:start;background:#ffffff;padding:8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #f0f0f0}
  .field-row label{font-size:13px;color:#555;font-weight:500;padding:6px 0}
  .field-row input, .field-row textarea{width:100%;padding:8px;border:1px solid #e0e0e0;border-radius:6px;font-size:13px;background:#ffffff;color:#333}
  .field-row textarea{min-height:100px;resize:vertical}
  
  /* Paired fields (English & Bangla side by side) */
  .field-pair{display:grid;grid-template-columns:80px 1fr 80px 1fr;gap:8px;align-items:start;background:#ffffff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #f0f0f0}
  .field-pair .field-label{font-size:12px;color:#555;font-weight:500;padding:4px 0;text-align:center}
  .field-pair .field-input{width:100%;padding:6px;border:1px solid #e0e0e0;border-radius:4px;font-size:12px;background:#ffffff;color:#333}
  
  /* Two column layout for specific fields */
  .field-two-column{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:4px;margin-bottom:2px}
  .field-two-column .field-column{display:flex;flex-direction:column;gap:2px}
  .field-two-column .field-item{display:flex;flex-direction:column;gap:2px;padding:4px}
  .field-two-column .field-item label{font-size:12px;color:#555;font-weight:600;margin-bottom:1px;text-transform:uppercase;letter-spacing:0.5px}
  .field-two-column .field-item input, .field-two-column .field-item textarea{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px;background:#ffffff;color:#333}
  .field-two-column .field-item textarea{min-height:60px;resize:vertical}

  .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px}
  .btn{padding:10px 16px;border:none;background:#333;color:#fff;border-radius:6px;cursor:pointer;font-weight:500;font-size:13px}
  .btn:hover{background:#555}
  .btn.secondary{background:#f0f0f0;color:#666;border:1px solid #e0e0e0}
  .btn.secondary:hover{background:#e0e0e0}
  .btn.orange{background:#ff8c00;color:#fff}
  .btn.orange:hover{background:#e07600}
  .btn.green{background:#28a745;color:#fff;cursor:default}
  .btn.green:hover{background:#28a745}
  
  .notice{margin-top:16px;color:#d32f2f;font-weight:500}
  .notice.success{color:#2e7d32}

  /* Group headers */
  .field-group {
    margin: 4px 0 2px 0;
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  .field-group h3 {
    font-size: 15px;
    font-weight: 600;
    color: #ff6b35;
    margin: 0 0 8px 0;
    padding: 8px 12px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    border-left: 3px solid #ff6b35;
  }
  .field-group:first-child h3 {
    margin-top: 0;
  }
  /* photo preview */
  #photo-preview{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;width:350px;height:500px;border:4px solid #000;background:#fff;padding:10px;border-radius:10px;display:none;pointer-events:none}
  
  /* Modal styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .modal-panel {
    background: white;
    border-radius: 8px;
    padding: 24px;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    width: 90%;
  }
  
  .modal-panel h3 {
    margin: 0 0 20px 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }
  
  .modal-panel h4 {
    margin: 0 0 10px 0;
    font-size: 16px;
    font-weight: 500;
    color: #333;
  }
  
  /* Upload section styles */
  .upload-section {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    margin-bottom: 20px;
    transition: all 0.2s;
    background: #fafafa;
  }
  
  .upload-section.dragover {
    border-color: #ff6b35;
    background: rgba(255, 107, 53, 0.05);
  }
  
  .upload-section p {
    margin: 10px 0;
    color: #666;
  }
  
  /* Crop container styles */
  .crop-container {
    margin-top: 20px;
    text-align: center;
  }
  
  .crop-area {
    max-width: 100%;
    margin: 0 auto 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    display: inline-block;
  }
  
  .crop-canvas {
    display: block;
    max-width: 100%;
    height: auto;
    cursor: crosshair;
  }
  
  .crop-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .crop-info {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
  }
  
  /* Preview container styles */
  .preview-container {
    text-align: center;
    margin-top: 20px;
  }
  
  .preview-image {
    max-width: 200px;
    max-height: 200px;
    border: 1px solid #ddd;
    border-radius: 8px;
  }
  
  /* Loading indicator styles */
  .loading {
    text-align: center;
    padding: 20px;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #ff6b35;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Button styles for modals */
  .btn.outline {
    background: transparent;
    color: #666;
    border: 1px solid #ddd;
  }
  
  .btn.outline:hover {
    background: #f5f5f5;
  }
  
  .btn.btn-primary {
    background: #ff6b35;
    color: white;
    border: 1px solid #ff6b35;
  }
  
  .btn.btn-primary:hover {
    background: #e55a2b;
  }
  
  .btn.btn-success {
    background: #28a745;
    color: white;
    border: 1px solid #28a745;
  }
  
  .btn.btn-success:hover {
    background: #218838;
  }
  
  /* Upload button styles */
  .upload-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    transition: all 0.2s ease;
  }
  
  /* Specific hover colors for upload buttons */
  .upload-btn[style*="background-color: rgb(255, 107, 53)"]:hover,
  .upload-btn[style*="background-color: #ff6b35"]:hover {
    background-color: #e55a2b !important;
  }
  
  .upload-btn[style*="background-color: rgb(40, 167, 69)"]:hover,
  .upload-btn[style*="background-color: #28a745"]:hover {
    background-color: #218838 !important;
  }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Edit Record</div>
        <div class="meta">Modify fields below and click <strong>Update</strong></div>
      </div>
      <div id="info" class="meta"></div>
    </div>

    <div id="photoWrap" class="photo-wrap"></div>
    <div id="fields" class="form-grid"></div>

    <div class="actions">
      <button id="idCardBtn" class="btn orange">Apply For ID Card</button>
      <button id="updateBtn" class="btn">Update</button>
    </div>
    <div id="notice" class="notice"></div>
  </div>

  <!-- Photo Upload Modal -->
  <div id="uploadModal" class="modal" style="display: none;">
    <div class="modal-panel">
      <h3>Upload Student Photo</h3>
      
      <!-- File Upload Area -->
      <div class="upload-section" id="uploadArea">
        <div>
          <h4>üì∑ Select or Drop Image File</h4>
          <p>Drag & drop an image here, or click to select</p>
          <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
            Supported formats: JPG, PNG, GIF (Max size: 5MB)<br>
            Recommended size: 944x1181 pixels (96 DPI)
          </p>
          <button type="button" class="btn btn-primary" id="selectFileBtn">
            üìÇ Choose Image File
          </button>
        </div>
      </div>

      <input type="file" id="fileInput" accept="image/*">

      <!-- Cropping Interface -->
      <div class="crop-container" id="cropContainer" style="display: none;">
        <h4>Crop Your Image</h4>
        <p class="crop-info">Click and drag to create a rectangular crop area (944:1181 ratio). The cropped image will be resized to 944x1181 pixels.</p>
        
        <div class="crop-area">
          <canvas id="cropCanvas" class="crop-canvas"></canvas>
        </div>

        <div class="crop-controls">
          <button type="button" class="btn btn-primary" id="resetCropBtn">
            üîÑ Reset Crop
          </button>
          <button type="button" class="btn btn-success" id="confirmCropBtn">
            ‚úÖ Confirm & Upload
          </button>
          <button type="button" class="btn" id="cancelCropBtn">
            ‚ùå Cancel
          </button>
        </div>
      </div>

      <!-- Preview Section -->
      <div class="preview-container" id="previewContainer" style="display: none;">
        <h4>Preview</h4>
        <img id="previewImage" class="preview-image" alt="Cropped preview">
      </div>

      <!-- Loading Indicator -->
      <div class="loading" id="loadingIndicator" style="display: none;">
        <div class="spinner"></div>
        <p>Uploading and updating...</p>
      </div>

      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn outline" id="closeModalBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Document Upload Modal -->
  <div id="documentModal" class="modal" style="display: none;">
    <div class="modal-panel">
      <h3>Upload <span id="modalDocType"></span></h3>
      
      <!-- File Upload Area -->
      <div class="upload-section" id="documentUploadArea">
        <div>
          <h4>üìÑ Select or Drop Document File</h4>
          <p>Drag & drop a document here, or click to select</p>
          <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
            Supported formats: PDF, JPG, PNG (Max size: 10MB)
          </p>
          <button type="button" class="btn btn-primary" id="selectDocFileBtn">
            üìÇ Choose Document File
          </button>
        </div>
      </div>

      <input type="file" id="docFileInput" accept=".pdf,.jpg,.jpeg,.png">

      <!-- Document Preview -->
      <div class="preview-container" id="docPreviewContainer" style="display: none;">
        <h4>Document Preview</h4>
        <div id="docPreview"></div>
      </div>

      <!-- Loading Indicator -->
      <div class="loading" id="docLoadingIndicator" style="display: none;">
        <div class="spinner"></div>
        <p>Uploading document...</p>
      </div>

      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-success" id="confirmDocUploadBtn" style="display: none;">
          ‚úÖ Confirm & Upload
        </button>
        <button type="button" class="btn outline" id="closeDocModalBtn">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // same supabase creds as entry.html
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    // Reuse existing Supabase client or create new one
    if (!window.supabaseClient) {
      window.__supabaseClients = window.__supabaseClients || {};
      window.supabaseClient = window.__supabaseClients[supabaseUrl] || window.supabase.createClient(supabaseUrl, supabaseKey);
      window.__supabaseClients[supabaseUrl] = window.supabaseClient;
    }
    const supabaseClient = window.supabaseClient;
    const tableName = 'student_database';

    // ImgBB configuration for photo uploads
    const IMGBB_API_KEY = '4d2cdd03bb1da4404f875c22f0bfdf31';
    const IMGBB_UPLOAD_URL = 'https://api.imgbb.com/1/upload';
    const IMGBB_ALBUM = 'new_student';

    const params = new URLSearchParams(window.location.search);
    const iid = params.get('iid');

    const fieldsEl = document.getElementById('fields');
    const infoEl = document.getElementById('info');
    const noticeEl = document.getElementById('notice');
    const updateBtn = document.getElementById('updateBtn');
    const idCardBtn = document.getElementById('idCardBtn');
    const backBtn = document.getElementById('backBtn');

    // Store field order mapping
    let fieldOrderMap = {};
    let fieldDisplayNames = {};
    let fieldGroups = [];

    updateBtn.addEventListener('click', saveChanges);
    idCardBtn.addEventListener('click', handleIdCardApplication);

    // Check ID card application status on page load
    if (iid) {
      checkIdCardStatus(iid);
    }

    // Check if IID already exists in idcard_data table
    async function checkIdCardStatus(iid) {
      try {
        const { data, error } = await supabaseClient
          .from('idcard_data')
          .select('iid')
          .eq('iid', Number(iid))
          .limit(1);

        if (error) {
          console.error('Error checking ID card status:', error);
          return;
        }

        if (data && data.length > 0) {
          // Already applied
          idCardBtn.textContent = 'Already Applied';
          idCardBtn.className = 'btn green';
          idCardBtn.disabled = true;
        } else {
          // Not applied yet
          idCardBtn.textContent = 'Apply For ID Card';
          idCardBtn.className = 'btn orange';
          idCardBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error checking ID card status:', error);
      }
    }

    // Handle ID card application
    async function handleIdCardApplication() {
      if (!iid) {
        alert('IID not found');
        return;
      }

      // Show confirmation popup
      const confirmed = confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ID Card ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?');
      if (!confirmed) {
        return;
      }

      try {
        // Disable button during submission
        idCardBtn.disabled = true;
        idCardBtn.textContent = 'Submitting...';

        const { data, error } = await supabaseClient
          .from('idcard_data')
          .insert([{ iid: Number(iid) }]);

        if (error) {
          throw error;
        }

        // Success - update button state
        idCardBtn.textContent = 'Already Applied';
        idCardBtn.className = 'btn green';
        alert('ID Card ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');

      } catch (error) {
        console.error('Error applying for ID card:', error);
        alert('Error: ' + (error.message || error));
        
        // Reset button state on error
        idCardBtn.textContent = 'Apply For ID Card';
        idCardBtn.className = 'btn orange';
        idCardBtn.disabled = false;
      }
    }

    // Load field order from CSV
    async function loadFieldOrder(){
      try{
        const response = await fetch('dataorder.csv');
        if(!response.ok) throw new Error('Could not load dataorder.csv');
        const csvText = await response.text();
        const lines = csvText.split('\n');

        let currentGroup = [];
        let currentGroupName = '';
        let groupIndex = 0;

        lines.forEach((line, index) => {
          const trimmedLine = line.trim();

          // Skip header and empty lines
          if(trimmedLine === '' || trimmedLine.startsWith('colm name')) {
            return;
          }

          // Check if this is a group header (starts with *)
          if(trimmedLine.startsWith('*')) {
            // Save previous group if it exists
            if(currentGroup.length > 0) {
              fieldGroups.push({
                index: groupIndex++,
                name: currentGroupName || `Group ${groupIndex}`,
                fields: [...currentGroup]
              });
              currentGroup = [];
            }
            // Extract group name (remove *)
            currentGroupName = trimmedLine.substring(1).trim();
            return;
          }

          // Parse field mapping
          const parts = trimmedLine.split('>').map(part => part.trim());
          if(parts.length >= 2){
            const dbField = parts[0];
            const displayName = parts[1];
            fieldOrderMap[dbField] = displayName;
            fieldDisplayNames[dbField] = displayName;
            currentGroup.push(dbField);
          }
        });

        // Add the last group if it exists
        if(currentGroup.length > 0) {
          fieldGroups.push({
            index: groupIndex,
            name: currentGroupName || `Group ${groupIndex + 1}`,
            fields: [...currentGroup]
          });
        }

      }catch(err){
        console.warn('Could not load field order:', err);
        // Fallback to default alphabetical order
      }
    }

    if(!iid){
      infoEl.innerHTML = '<span class="iid-badge">No IID</span>';
      updateBtn.disabled = true;
    } else {
      // safe display
      const span = document.createElement('span');
      span.className = 'iid-badge';
      span.textContent = iid;
      infoEl.appendChild(span);
      loadRecord(iid);
    }

    async function loadRecord(iid){
      noticeEl.textContent = 'Loading...';
      try{
        // First load field order
        await loadFieldOrder();

        const { data, error } = await supabaseClient
          .from(tableName)
          .select('*')
          .eq('iid', Number(iid))
          .limit(1)
          .single();
        if(error) throw error;

        renderFields(data || {});
        // render photo and name
        try{ await renderPhotoForIID(iid, data); }catch(e){ console.warn('photo render failed', e); }
        noticeEl.textContent = '';
      }catch(err){
        console.error('loadRecord error', err);
        noticeEl.textContent = 'Failed to load record: ' + (err.message || err);
        updateBtn.disabled = true;
      }
    }

    async function renderPhotoForIID(iid, record){
      const wrap = document.getElementById('photoWrap');
      wrap.innerHTML = '';
      
      try{
        // Get photo URL from database record
        const imgUrl = record && record.student_photo_url ? record.student_photo_url.trim() : null;

        // If no photo URL found in database, only show name without default avatar
        if(!imgUrl){
          const nameEl = document.createElement('div');
          nameEl.className = 'student-name';
          nameEl.style.marginTop = '0px'; // No image above, so remove top margin
          nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

          wrap.appendChild(nameEl);
          return;
        }

        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = 'Student Photo';
        img.style.maxWidth = '140px';
        img.style.maxHeight = '220px';
        
        // Add error handler to hide image if URL is invalid
        img.onerror = function() {
          this.style.display = 'none';
          // Update name element margin if image fails to load
          const nameEl = wrap.querySelector('.student-name');
          if(nameEl) nameEl.style.marginTop = '0px';
        };

        const nameEl = document.createElement('div');
        nameEl.className = 'student-name';
        nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

        wrap.appendChild(img);
        wrap.appendChild(nameEl);
      }catch(err){
        console.warn('renderPhotoForIID error', err);
        // Show only name without default avatar on error
        const nameEl = document.createElement('div');
        nameEl.className = 'student-name';
        nameEl.style.marginTop = '0px'; // No image above, so remove top margin
        nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

        wrap.appendChild(nameEl);
      }
    }

    function renderFields(record){
      fieldsEl.innerHTML = '';

      // Get all field keys
      const allKeys = Object.keys(record);

      // Separate ordered and unordered fields
      const orderedFields = [];
      const unorderedFields = [];

      allKeys.forEach(key => {
        if(fieldOrderMap.hasOwnProperty(key)){
          orderedFields.push(key);
        } else {
          unorderedFields.push(key);
        }
      });

      // Render grouped fields
      fieldGroups.forEach(group => {
        const groupFields = group.fields.filter(field => orderedFields.includes(field));

        if(groupFields.length > 0) {
          // Create group container
          const groupDiv = document.createElement('div');
          groupDiv.className = 'field-group';

          // Create group header
          const groupHeader = document.createElement('h3');
          groupHeader.textContent = group.name;
          groupDiv.appendChild(groupHeader);

          // Add fields in this group
          groupFields.forEach(key => {
            const val = record[key] === null || record[key] === undefined ? '' : record[key];
            
            // Apply two-column layout to all fields starting from student_name_en
            const isTwoColumnField = key !== 'iid' && key !== 'session';
            
            if (isTwoColumnField) {
              // Handle special two-column layout
              if (!groupDiv.querySelector('.field-two-column')) {
                const twoColumnDiv = document.createElement('div');
                twoColumnDiv.className = 'field-two-column';
                
                const leftColumn = document.createElement('div');
                leftColumn.className = 'field-column';
                
                const rightColumn = document.createElement('div');
                rightColumn.className = 'field-column';
                
                twoColumnDiv.appendChild(leftColumn);
                twoColumnDiv.appendChild(rightColumn);
                groupDiv.appendChild(twoColumnDiv);
              }
              
              const twoColumnDiv = groupDiv.querySelector('.field-two-column');
              const columns = twoColumnDiv.querySelectorAll('.field-column');
              const targetColumn = columns[columns[0].children.length <= columns[1].children.length ? 0 : 1];
              
              const fieldItem = document.createElement('div');
              fieldItem.className = 'field-item';
              
              const label = document.createElement('label');
              const displayName = fieldDisplayNames[key] || key;
              label.textContent = displayName;
              
              // Add view link for URL fields
              if (isUploadField(key)) {
                const viewLink = document.createElement('span');
                viewLink.textContent = ' *view';
                viewLink.style.color = '#ff6b35';
                viewLink.style.cursor = 'pointer';
                viewLink.style.fontSize = '12px';
                viewLink.style.textDecoration = 'underline';
                viewLink.setAttribute('data-view-field', key);
                viewLink.addEventListener('click', () => openUrlInNewTab(key));
                label.appendChild(viewLink);
              }
              
              // Field-specific selects (religion/gender/class/section/blood/group/freedom)
              let input;
              const lk = String(key).toLowerCase();
              if(lk.includes('relig') || lk === 'religion'){
                input = document.createElement('select');
                ['','HINDU','ISLAM','BUDDHA','CHRISTIAN'].forEach(o=>{ const el = document.createElement('option'); el.value = o; el.textContent = o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('gender') || lk === 'sex' || lk.includes('student_gender')){
                input = document.createElement('select');
                ['','MALE','FEMALE'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if((lk === 'class' || lk.includes('class_') || lk === 'class_2025' || lk === 'class_2026' || lk === 'class ') && lk !== 'previous_class_roll'){
                input = document.createElement('select');
                ['','6','7','8','9','10'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('section')){
                input = document.createElement('input');
                input.type = 'text';
              } else if(lk.includes('blood')){
                input = document.createElement('select');
                ['','A+','A-','B+','B-','AB+','AB-','O+','O-'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('group') && !lk.includes('field-group')){
                input = document.createElement('select');
                ['','SCIENCE','BUSINESS STUDIES','HUMANITIES'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('freedom') || lk.includes('freedom_fighter') || (lk.includes('quote') && lk.includes('freedom'))){
                input = document.createElement('select');
                ['','YES','NO'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
                input = document.createElement('textarea');
                input.rows = 3;
              } else {
                input = document.createElement('input');
                input.type = 'text';
              }
              input.value = val;
              input.setAttribute('data-field', key);
              if(key === 'iid') input.readOnly = true;
              
              fieldItem.appendChild(label);
              fieldItem.appendChild(input);
              
              // Add upload button for URL fields
              if (isUploadField(key)) {
                const uploadBtn = createUploadButton(key);
                fieldItem.appendChild(uploadBtn);
              }
              
              targetColumn.appendChild(fieldItem);
            } else {
              // Regular field-row layout for iid and session
              const row = document.createElement('div');
              row.className = 'field-row';

              const label = document.createElement('label');
              const displayName = fieldDisplayNames[key] || key;
              label.textContent = displayName + ':';

              // Add view link for URL fields
              if (isUploadField(key)) {
                const viewLink = document.createElement('span');
                viewLink.textContent = ' *view';
                viewLink.style.color = '#ff6b35';
                viewLink.style.cursor = 'pointer';
                viewLink.style.fontSize = '12px';
                viewLink.style.textDecoration = 'underline';
                viewLink.setAttribute('data-view-field', key);
                viewLink.addEventListener('click', () => openUrlInNewTab(key));
                label.appendChild(viewLink);
              }

              let input;
              if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
                input = document.createElement('textarea');
                input.rows = 4;
              } else {
                input = document.createElement('input');
                input.type = 'text';
              }
              input.value = val;
              input.setAttribute('data-field', key);
              if(key === 'iid') input.readOnly = true;

              row.appendChild(label);
              row.appendChild(input);
              
              // Add upload button for URL fields in regular layout
              if (isUploadField(key)) {
                const uploadBtn = createUploadButton(key);
                row.appendChild(uploadBtn);
              }
              
              groupDiv.appendChild(row);
            }
          });

          fieldsEl.appendChild(groupDiv);
        }
      });
      // Render unordered fields at the end
      if(unorderedFields.length > 0) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'field-group';

        const groupHeader = document.createElement('h3');
        groupHeader.textContent = 'Additional Information';
        groupDiv.appendChild(groupHeader);

        unorderedFields.sort().forEach(key => {
          const val = record[key] === null || record[key] === undefined ? '' : record[key];
          
          // Apply two-column layout to all fields starting from student_name_en
          const isTwoColumnField = key !== 'iid' && key !== 'session';
          
          if (isTwoColumnField) {
            // Handle special two-column layout
            if (!groupDiv.querySelector('.field-two-column')) {
              const twoColumnDiv = document.createElement('div');
              twoColumnDiv.className = 'field-two-column';
              
              const leftColumn = document.createElement('div');
              leftColumn.className = 'field-column';
              
              const rightColumn = document.createElement('div');
              rightColumn.className = 'field-column';
              
              twoColumnDiv.appendChild(leftColumn);
              twoColumnDiv.appendChild(rightColumn);
              groupDiv.appendChild(twoColumnDiv);
            }
            
            const twoColumnDiv = groupDiv.querySelector('.field-two-column');
            const columns = twoColumnDiv.querySelectorAll('.field-column');
            const targetColumn = columns[columns[0].children.length <= columns[1].children.length ? 0 : 1];
            
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';
            
            const label = document.createElement('label');
            const displayName = fieldDisplayNames[key] || key;
            label.textContent = displayName;
            
            // Add view link for URL fields
            if (isUploadField(key)) {
              const viewLink = document.createElement('span');
              viewLink.textContent = ' *view';
              viewLink.style.color = '#ff6b35';
              viewLink.style.cursor = 'pointer';
              viewLink.style.fontSize = '12px';
              viewLink.style.textDecoration = 'underline';
              viewLink.setAttribute('data-view-field', key);
              viewLink.addEventListener('click', () => openUrlInNewTab(key));
              label.appendChild(viewLink);
            }
            
            // Field-specific selects
            let input;
            const lk = String(key).toLowerCase();
            if(lk.includes('relig') || lk === 'religion'){
              input = document.createElement('select');
              ['','HINDU','ISLAM','BUDDHA','CHRISTIAN'].forEach(o=>{ const el = document.createElement('option'); el.value = o; el.textContent = o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('gender') || lk === 'sex' || lk.includes('student_gender')){
              input = document.createElement('select');
              ['','MALE','FEMALE'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if((lk === 'class' || lk.includes('class_') || lk === 'class_2025' || lk === 'class_2026' || lk === 'class ') && lk !== 'previous_class_roll'){
              input = document.createElement('select');
              ['','6','7','8','9','10'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('section')){
              input = document.createElement('select');
              ['','SHAPLA','GOLAP','MORNING'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('blood')){
              input = document.createElement('select');
              ['','A+','A-','B+','B-','AB+','AB-','O+','O-'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('group') && !lk.includes('field-group')){
              input = document.createElement('select');
              ['','SCIENCE','BUSINESS STUDIES','HUMANITIES'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('freedom') || lk.includes('freedom_fighter') || (lk.includes('quote') && lk.includes('freedom'))){
              input = document.createElement('select');
              ['','YES','NO'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
              input = document.createElement('textarea');
              input.rows = 3;
            } else {
              input = document.createElement('input');
              input.type = 'text';
            }
            input.value = val;
            input.setAttribute('data-field', key);
            if(key === 'iid') input.readOnly = true;
            
            fieldItem.appendChild(label);
            fieldItem.appendChild(input);
            
            // Add upload button for URL fields
            if (isUploadField(key)) {
              const uploadBtn = createUploadButton(key);
              fieldItem.appendChild(uploadBtn);
            }
            
            targetColumn.appendChild(fieldItem);
          } else {
            // Regular field-row layout for iid and session
            const row = document.createElement('div');
            row.className = 'field-row';

            const label = document.createElement('label');
            const displayName = fieldDisplayNames[key] || key;
            label.textContent = displayName + ':';

            // Add view link for URL fields
            if (isUploadField(key)) {
              const viewLink = document.createElement('span');
              viewLink.textContent = ' *view';
              viewLink.style.color = '#ff6b35';
              viewLink.style.cursor = 'pointer';
              viewLink.style.fontSize = '12px';
              viewLink.style.textDecoration = 'underline';
              viewLink.setAttribute('data-view-field', key);
              viewLink.addEventListener('click', () => openUrlInNewTab(key));
              label.appendChild(viewLink);
            }

            // Field-specific selects
            let input;
            const lk = String(key).toLowerCase();
            if(lk.includes('relig') || lk === 'religion'){
              input = document.createElement('select');
              ['','HINDU','ISLAM','BUDDHA','CHRISTIAN'].forEach(o=>{ const el = document.createElement('option'); el.value = o; el.textContent = o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('gender') || lk === 'sex' || lk.includes('student_gender')){
              input = document.createElement('select');
              ['','MALE','FEMALE'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if((lk === 'class' || lk.includes('class_') || lk === 'class_2025' || lk === 'class_2026' || lk === 'class ') && lk !== 'previous_class_roll'){
              input = document.createElement('select');
              ['','6','7','8','9','10'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('section')){
              input = document.createElement('select');
              ['','SHAPLA','GOLAP','MORNING'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('blood')){
              input = document.createElement('select');
              ['','A+','A-','B+','B-','AB+','AB-','O+','O-'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('group') && !lk.includes('field-group')){
              input = document.createElement('select');
              ['','SCIENCE','BUSINESS STUDIES','HUMANITIES'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('freedom') || lk.includes('freedom_fighter') || (lk.includes('quote') && lk.includes('freedom'))){
              input = document.createElement('select');
              ['','YES','NO'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
              input = document.createElement('textarea');
              input.rows = 4;
            } else {
              input = document.createElement('input');
              input.type = 'text';
            }
            input.value = val;
            input.setAttribute('data-field', key);
            if(key === 'iid') input.readOnly = true;

            row.appendChild(label);
            row.appendChild(input);
            
            // Add upload button for URL fields in unordered fields
            if (isUploadField(key)) {
              const uploadBtn = createUploadButton(key);
              row.appendChild(uploadBtn);
            }
            
            groupDiv.appendChild(row);
          }
        });

        fieldsEl.appendChild(groupDiv);
      }
      
      // Update upload button colors after all fields are rendered
      setTimeout(() => {
        updateAllUploadButtonColors();
      }, 100);
    }

    async function saveChanges(){
      noticeEl.textContent = '';
      const inputs = fieldsEl.querySelectorAll('[data-field]');
      const payload = {};
      inputs.forEach(inp =>{
        const field = inp.getAttribute('data-field');
        if(field === 'iid') return;
        const v = inp.value === '' ? null : inp.value;
        payload[field] = v;
      });
      updateBtn.disabled = true;
      updateBtn.textContent = 'Updating...';
      try{
        const { data, error } = await supabaseClient
          .from(tableName)
          .update(payload)
          .eq('iid', Number(iid));
        if(error) throw error;
        noticeEl.className = 'notice success';
        noticeEl.textContent = 'Updated successfully.';
        // Show popup alert
        alert('Updated successfully!');
      }catch(err){
        console.error('update error', err);
        noticeEl.className = 'notice';
        noticeEl.textContent = 'Update failed: ' + (err.message || err);
      }finally{
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update';
      }
    }

    // photo preview functionality
    const photoWrap = document.getElementById('photoWrap');
    const photoPreview = document.createElement('div');
    photoPreview.id = 'photo-preview';
    const previewImg = document.createElement('img');
    previewImg.style.width = '100%';
    previewImg.style.height = '100%';
    previewImg.style.objectFit = 'cover';
    photoPreview.appendChild(previewImg);
    document.body.appendChild(photoPreview);

    photoWrap.addEventListener('mouseover', (e) => {
      if(e.target.tagName === 'IMG'){
        previewImg.src = e.target.src;
        photoPreview.style.display = 'block';
      }
    });

    photoWrap.addEventListener('mouseout', (e) => {
      if(e.target.tagName === 'IMG'){
        photoPreview.style.display = 'none';
      }
    });

    // Upload functionality helper functions
    function isUploadField(fieldName) {
      const lowerFieldName = fieldName.toLowerCase();
      return lowerFieldName === 'student_photo_url' || 
             lowerFieldName === 'registration_card_url' || 
             lowerFieldName === 'birth_certificate_url';
    }

    function createUploadButton(fieldName) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'upload-btn';
      btn.textContent = 'Upload';
      btn.style.marginLeft = '10px';
      btn.style.padding = '6px 12px';
      btn.style.fontSize = '12px';
      btn.style.backgroundColor = '#ff6b35';
      btn.style.color = 'white';
      btn.style.border = 'none';
      btn.style.borderRadius = '4px';
      btn.style.cursor = 'pointer';
      
      // Store field name for later updates
      btn.setAttribute('data-upload-field', fieldName);
      
      btn.addEventListener('click', () => {
        if (fieldName.toLowerCase() === 'student_photo_url') {
          openPhotoUploadModal();
        } else {
          const docType = fieldName.toLowerCase() === 'birth_certificate_url' ? 'birth_certificate' : 'registration_card';
          openDocumentUploadModal(docType);
        }
      });
      
      return btn;
    }

    function updateUploadButtonColor(btn, fieldName) {
      // Find the input field with the corresponding data-field attribute
      const input = document.querySelector(`[data-field="${fieldName}"]`);
      const hasValue = input && input.value && input.value.trim() !== '';
      
      if (hasValue) {
        // Green for uploaded
        btn.style.backgroundColor = '#28a745';
        btn.style.borderColor = '#28a745';
        btn.textContent = 'Uploaded';
      } else {
        // Orange for not uploaded
        btn.style.backgroundColor = '#ff6b35';
        btn.style.borderColor = '#ff6b35';
        btn.textContent = 'Upload';
      }
    }

    function updateAllUploadButtonColors() {
      // Update all upload buttons after the form is rendered
      const uploadButtons = document.querySelectorAll('[data-upload-field]');
      uploadButtons.forEach(btn => {
        const fieldName = btn.getAttribute('data-upload-field');
        updateUploadButtonColor(btn, fieldName);
      });
    }

    function openUrlInNewTab(fieldName) {
      // Find the input field with the corresponding data-field attribute
      const input = document.querySelector(`[data-field="${fieldName}"]`);
      if (input && input.value && input.value.trim() !== '') {
        const url = input.value.trim();
        // Open URL in new tab
        window.open(url, '_blank');
      } else {
        alert('No URL available to view');
      }
    }

    // Global variables for upload functionality
    let originalImage = null;
    let cropSelection = { x: 0, y: 0, width: 0, height: 0 };
    let selectedDocumentFile = null;
    let currentDocumentType = null;

    // DOM elements
    const uploadModal = document.getElementById('uploadModal');
    const documentModal = document.getElementById('documentModal');
    const fileInput = document.getElementById('fileInput');
    const docFileInput = document.getElementById('docFileInput');
    const cropCanvas = document.getElementById('cropCanvas');
    const cropContainer = document.getElementById('cropContainer');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const docLoadingIndicator = document.getElementById('docLoadingIndicator');
    const docPreviewContainer = document.getElementById('docPreviewContainer');
    const docPreview = document.getElementById('docPreview');
    const uploadArea = document.getElementById('uploadArea');
    const documentUploadArea = document.getElementById('documentUploadArea');

    // Photo upload functions
    function openPhotoUploadModal() {
      uploadModal.style.display = 'flex';
      resetPhotoModal();
    }

    function closePhotoUploadModal() {
      uploadModal.style.display = 'none';
      resetPhotoModal();
    }

    function resetPhotoModal() {
      fileInput.value = '';
      cropContainer.style.display = 'none';
      previewContainer.style.display = 'none';
      loadingIndicator.style.display = 'none';
      originalImage = null;
      cropSelection = { x: 0, y: 0, width: 0, height: 0 };
    }

    function openDocumentUploadModal(docType) {
      currentDocumentType = docType;
      const docTypeText = docType === 'birth_certificate' ? 'Birth Certificate' : 'Registration Card';
      document.getElementById('modalDocType').textContent = docTypeText;
      documentModal.style.display = 'flex';
      resetDocumentModal();
    }

    function closeDocumentUploadModal() {
      documentModal.style.display = 'none';
      resetDocumentModal();
    }

    function resetDocumentModal() {
      docFileInput.value = '';
      docPreviewContainer.style.display = 'none';
      docLoadingIndicator.style.display = 'none';
      selectedDocumentFile = null;
      currentDocumentType = null;
      document.getElementById('confirmDocUploadBtn').style.display = 'none';
    }

    // Event listeners
    document.getElementById('selectFileBtn').addEventListener('click', () => fileInput.click());
    document.getElementById('selectDocFileBtn').addEventListener('click', () => docFileInput.click());
    document.getElementById('closeModalBtn').addEventListener('click', closePhotoUploadModal);
    document.getElementById('closeDocModalBtn').addEventListener('click', closeDocumentUploadModal);
    document.getElementById('confirmCropBtn').addEventListener('click', processCropAndUpload);
    document.getElementById('confirmDocUploadBtn').addEventListener('click', processDocumentUpload);
    document.getElementById('resetCropBtn').addEventListener('click', resetCrop);
    document.getElementById('cancelCropBtn').addEventListener('click', () => {
      cropContainer.style.display = 'none';
    });

    fileInput.addEventListener('change', handleFileSelection);
    docFileInput.addEventListener('change', handleDocumentFileSelection);

    // File handling functions
    function handleFileSelection(e) {
      const file = e.target.files[0];
      if (file) {
        processSelectedFile(file);
      }
    }

    function handleDocumentFileSelection(e) {
      const file = e.target.files[0];
      if (file) {
        processSelectedDocumentFile(file);
      }
    }

    function processSelectedFile(file) {
      // Validate file
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
      const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif'];
      
      const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
      
      if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
        alert('Please select a valid image file (JPG, PNG, GIF)');
        return;
      }

      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        alert('File size too large. Please select an image under 5MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        originalImage = new Image();
        originalImage.onload = function() {
          setupCropCanvas();
        };
        originalImage.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function processSelectedDocumentFile(file) {
      if (!currentDocumentType) {
        alert('Please select a document type first');
        return;
      }

      // Validate file
      const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
      const allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png'];
      
      const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
      
      if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
        alert('Please select a valid document file (PDF, JPG, PNG)');
        return;
      }

      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        alert('File size too large. Please select a document under 10MB');
        return;
      }

      selectedDocumentFile = file;
      showDocumentPreview(file);
      document.getElementById('confirmDocUploadBtn').style.display = 'inline-flex';
    }

    function showDocumentPreview(file) {
      const fileType = file.type;
      const fileName = file.name;
      
      if (fileType === 'application/pdf') {
        docPreview.innerHTML = `
          <div style="padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
            <div style="font-weight: 500; color: #334155;">${fileName}</div>
            <div style="font-size: 12px; color: #64748b; margin-top: 5px;">PDF Document</div>
          </div>
        `;
      } else if (fileType.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          docPreview.innerHTML = `
            <div style="text-align: center;">
              <img src="${e.target.result}" alt="Document preview" style="max-width: 300px; max-height: 200px; border: 1px solid #e2e8f0; border-radius: 8px;">
              <div style="font-size: 12px; color: #64748b; margin-top: 5px;">${fileName}</div>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      }
      
      docPreviewContainer.style.display = 'block';
    }

    function setupCropCanvas() {
      const canvas = cropCanvas;
      const context = canvas.getContext('2d');
      
      // Set canvas size
      const containerWidth = 400;
      const aspectRatio = originalImage.width / originalImage.height;
      canvas.width = containerWidth;
      canvas.height = containerWidth / aspectRatio;
      
      // Draw image
      context.clearRect(0, 0, canvas.width, canvas.height);
      context.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
      
      // Show crop container
      cropContainer.style.display = 'block';
      
      // Initialize crop selection (full image)
      cropSelection = { x: 0, y: 0, width: canvas.width, height: canvas.height };
      drawCropArea();
      
      // Add event listeners for cropping
      setupCropEventListeners();
    }

    function setupCropEventListeners() {
      const canvas = cropCanvas;
      let isDragging = false;
      let startX, startY;
      
      canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        isDragging = true;
      });
      
      canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        cropSelection.x = Math.min(startX, currentX);
        cropSelection.y = Math.min(startY, currentY);
        cropSelection.width = Math.abs(currentX - startX);
        cropSelection.height = Math.abs(currentY - startY);
        
        drawCropArea();
      });
      
      canvas.addEventListener('mouseup', () => {
        isDragging = false;
      });
    }

    function drawCropArea() {
      const canvas = cropCanvas;
      const context = canvas.getContext('2d');
      
      // Redraw image
      context.clearRect(0, 0, canvas.width, canvas.height);
      context.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
      
      // Draw crop overlay
      context.fillStyle = 'rgba(0, 0, 0, 0.5)';
      context.fillRect(0, 0, canvas.width, canvas.height);
      
      // Clear crop area
      context.globalCompositeOperation = 'destination-out';
      context.fillRect(cropSelection.x, cropSelection.y, cropSelection.width, cropSelection.height);
      context.globalCompositeOperation = 'source-over';
      
      // Draw crop border
      context.strokeStyle = '#fff';
      context.lineWidth = 2;
      context.strokeRect(cropSelection.x, cropSelection.y, cropSelection.width, cropSelection.height);
    }

    function resetCrop() {
      if (originalImage) {
        setupCropCanvas();
      }
    }

    async function processCropAndUpload() {
      if (!originalImage || cropSelection.width === 0) {
        alert('Please select an image and crop area');
        return;
      }

      try {
        showLoading(true, 'photo');

        // Create cropped image
        const croppedCanvas = document.createElement('canvas');
        const croppedContext = croppedCanvas.getContext('2d');

        // Set target size (944x1181 for rectangle as per requirements)
        const targetWidth = 944;
        const targetHeight = 1181;
        croppedCanvas.width = targetWidth;
        croppedCanvas.height = targetHeight;

        // Calculate source coordinates
        const scaleX = originalImage.width / cropCanvas.width;
        const scaleY = originalImage.height / cropCanvas.height;
        
        const sourceX = cropSelection.x * scaleX;
        const sourceY = cropSelection.y * scaleY;
        const sourceWidth = cropSelection.width * scaleX;
        const sourceHeight = cropSelection.height * scaleY;

        // Draw cropped image
        croppedContext.drawImage(
          originalImage,
          sourceX, sourceY, sourceWidth, sourceHeight,
          0, 0, targetWidth, targetHeight
        );

        // Convert to blob
        const blob = await new Promise(resolve => croppedCanvas.toBlob(resolve, 'image/jpeg', 0.9));

        // Show preview
        const previewUrl = URL.createObjectURL(blob);
        previewImage.src = previewUrl;
        previewContainer.style.display = 'block';

        // Upload to ImgBB
        const imgbbUrl = await uploadToImgBB(blob, `avatar-${iid}.jpg`);

        // Update database
        await updateStudentField('student_photo_url', imgbbUrl);

        // Update local field
        updateFieldValue('student_photo_url', imgbbUrl);

        // Success
        alert('Photo uploaded and updated successfully! ‚úÖ');
        
        // Clean up
        URL.revokeObjectURL(previewUrl);
        
        // Close modal after successful upload
        setTimeout(() => {
          closePhotoUploadModal();
        }, 1000);

      } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to upload photo: ' + error.message);
      } finally {
        showLoading(false, 'photo');
      }
    }

    async function processDocumentUpload() {
      if (!selectedDocumentFile || !currentDocumentType) {
        alert('Please select a file and document type');
        return;
      }

      try {
        showLoading(true, 'document');

        // Generate filename
        const fileExtension = selectedDocumentFile.name.toLowerCase().substring(selectedDocumentFile.name.lastIndexOf('.'));
        const prefix = currentDocumentType === 'birth_certificate' ? 'birth' : 'reg';
        const filename = `${prefix}-${iid}${fileExtension}`;

        // Upload to ImgBB
        const imgbbUrl = await uploadDocumentToImgBB(selectedDocumentFile, filename);

        // Update database
        const dbColumn = currentDocumentType === 'birth_certificate' ? 'birth_certificate_url' : 'registration_card_url';
        await updateStudentField(dbColumn, imgbbUrl);

        // Update local field
        updateFieldValue(dbColumn, imgbbUrl);

        // Success
        alert('Document uploaded and updated successfully! ‚úÖ');
        
        // Close modal after successful upload
        setTimeout(() => {
          closeDocumentUploadModal();
        }, 1000);

      } catch (error) {
        console.error('Document upload error:', error);
        alert('Failed to upload document: ' + error.message);
      } finally {
        showLoading(false, 'document');
      }
    }

    async function uploadToImgBB(blob, filename) {
      const formData = new FormData();
      formData.append('key', IMGBB_API_KEY);
      formData.append('image', blob, filename);
      formData.append('album', IMGBB_ALBUM);

      const response = await fetch(IMGBB_UPLOAD_URL, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error('ImgBB upload failed: ' + response.statusText);
      }

      const data = await response.json();
      
      if (!data.success) {
        throw new Error('ImgBB upload failed: ' + (data.error?.message || 'Unknown error'));
      }

      return data.data.url;
    }

    async function uploadDocumentToImgBB(file, filename) {
      const formData = new FormData();
      formData.append('key', IMGBB_API_KEY);
      formData.append('image', file, filename);
      formData.append('album', 'student_documents');

      const response = await fetch(IMGBB_UPLOAD_URL, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error('ImgBB upload failed: ' + response.statusText);
      }

      const data = await response.json();
      
      if (!data.success) {
        throw new Error('ImgBB upload failed: ' + (data.error?.message || 'Unknown error'));
      }

      return data.data.url;
    }

    async function updateStudentField(fieldName, value) {
      const updateData = {};
      updateData[fieldName] = value;
      
      const { error } = await supabaseClient
        .from(tableName)
        .update(updateData)
        .eq('iid', Number(iid));

      if (error) {
        throw new Error('Database update failed: ' + error.message);
      }
    }

    function updateFieldValue(fieldName, value) {
      const input = document.querySelector(`[data-field="${fieldName}"]`);
      if (input) {
        input.value = value;
        
        // Update the corresponding upload button color
        const uploadBtn = document.querySelector(`[data-upload-field="${fieldName}"]`);
        if (uploadBtn) {
          updateUploadButtonColor(uploadBtn, fieldName);
        }
      }
    }

    function showLoading(show, type = 'photo') {
      const indicator = type === 'photo' ? loadingIndicator : docLoadingIndicator;
      indicator.style.display = show ? 'block' : 'none';
      
      // Disable controls during upload
      const modal = type === 'photo' ? uploadModal : documentModal;
      const controls = modal.querySelectorAll('button, select, input');
      controls.forEach(control => {
        control.disabled = show;
      });
    }
  </script>
</body>
</html>
