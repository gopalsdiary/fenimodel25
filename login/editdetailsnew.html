<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Edit Details</title>
  <style>
  /* Clean monochromatic design with white and shadows only */
  html{font-size:125%;}
  html,body{height:100%}
  body{font-family: -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding:16px; background:#f8f9fa; color:#333; margin:0}
  
  .container{max-width:720px;margin:0 auto}
  
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:600;color:#333}
  .meta{color:#666; font-size:13px}
  .iid-badge{display:inline-block;margin-left:8px;padding:6px 12px;background:#f0f0f0;color:#666;border-radius:20px;font-weight:500;font-size:13px}

  .form-grid{display:flex;flex-direction:column;gap:4px}
  
  /* Photo area */
  .photo-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:12px}
  .photo-wrap img{width:120px;height:120px;object-fit:cover;border-radius:8px;border:2px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:#fff}
  .student-name{margin-top:8px;font-weight:600;font-size:1rem;color:#333}
  
  /* Form fields */
  .field-row{display:grid;grid-template-columns:160px 1.4fr;gap:10px;align-items:start;background:#ffffff;padding:8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #f0f0f0}
  .field-row label{font-size:13px;color:#555;font-weight:500;padding:6px 0}
  .field-row input, .field-row textarea{width:100%;padding:8px;border:1px solid #e0e0e0;border-radius:6px;font-size:13px;background:#ffffff;color:#333}
  .field-row textarea{min-height:100px;resize:vertical}
  
  /* Paired fields (English & Bangla side by side) */
  .field-pair{display:grid;grid-template-columns:80px 1fr 80px 1fr;gap:8px;align-items:start;background:#ffffff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #f0f0f0}
  .field-pair .field-label{font-size:12px;color:#555;font-weight:500;padding:4px 0;text-align:center}
  .field-pair .field-input{width:100%;padding:6px;border:1px solid #e0e0e0;border-radius:4px;font-size:12px;background:#ffffff;color:#333}
  
  /* Two column layout for specific fields */
  .field-two-column{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:4px;margin-bottom:2px}
  .field-two-column .field-column{display:flex;flex-direction:column;gap:2px}
  .field-two-column .field-item{display:flex;flex-direction:column;gap:2px;padding:4px}
  .field-two-column .field-item label{font-size:12px;color:#555;font-weight:600;margin-bottom:1px;text-transform:uppercase;letter-spacing:0.5px}
  .field-two-column .field-item input, .field-two-column .field-item textarea{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px;background:#ffffff;color:#333}
  .field-two-column .field-item textarea{min-height:60px;resize:vertical}

  .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px}
  .btn{padding:10px 16px;border:none;background:#333;color:#fff;border-radius:6px;cursor:pointer;font-weight:500;font-size:13px}
  .btn:hover{background:#555}
  .btn.secondary{background:#f0f0f0;color:#666;border:1px solid #e0e0e0}
  .btn.secondary:hover{background:#e0e0e0}
  
  .notice{margin-top:16px;color:#d32f2f;font-weight:500}
  .notice.success{color:#2e7d32}

  /* Group headers */
  .field-group {
    margin: 4px 0 2px 0;
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  .field-group h3 {
    font-size: 15px;
    font-weight: 600;
    color: #ff6b35;
    margin: 0 0 8px 0;
    padding: 8px 12px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    border-left: 3px solid #ff6b35;
  }
  .field-group:first-child h3 {
    margin-top: 0;
  }
  /* photo preview */
  #photo-preview{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;width:350px;height:500px;border:4px solid #000;background:#fff;padding:10px;border-radius:10px;display:none;pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Edit Record</div>
        <div class="meta">Modify fields below and click <strong>Update</strong></div>
      </div>
      <div id="info" class="meta"></div>
    </div>

    <div id="photoWrap" class="photo-wrap"></div>
    <div id="fields" class="form-grid"></div>

    <div class="actions">
      <button id="updateBtn" class="btn">Update</button>
    </div>
    <div id="notice" class="notice"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // same supabase creds as entry.html
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const tableName = 'student_database';

    const params = new URLSearchParams(window.location.search);
    const iid = params.get('iid');

    const fieldsEl = document.getElementById('fields');
    const infoEl = document.getElementById('info');
    const noticeEl = document.getElementById('notice');
    const updateBtn = document.getElementById('updateBtn');
    const backBtn = document.getElementById('backBtn');

    // Store field order mapping
    let fieldOrderMap = {};
    let fieldDisplayNames = {};
    let fieldGroups = [];

    updateBtn.addEventListener('click', saveChanges);

    // Load field order from CSV
    async function loadFieldOrder(){
      try{
        const response = await fetch('dataorder.csv');
        if(!response.ok) throw new Error('Could not load dataorder.csv');
        const csvText = await response.text();
        const lines = csvText.split('\n');

        let currentGroup = [];
        let currentGroupName = '';
        let groupIndex = 0;

        lines.forEach((line, index) => {
          const trimmedLine = line.trim();

          // Skip header and empty lines
          if(trimmedLine === '' || trimmedLine.startsWith('colm name')) {
            return;
          }

          // Check if this is a group header (starts with *)
          if(trimmedLine.startsWith('*')) {
            // Save previous group if it exists
            if(currentGroup.length > 0) {
              fieldGroups.push({
                index: groupIndex++,
                name: currentGroupName || `Group ${groupIndex}`,
                fields: [...currentGroup]
              });
              currentGroup = [];
            }
            // Extract group name (remove *)
            currentGroupName = trimmedLine.substring(1).trim();
            return;
          }

          // Parse field mapping
          const parts = trimmedLine.split('>').map(part => part.trim());
          if(parts.length >= 2){
            const dbField = parts[0];
            const displayName = parts[1];
            fieldOrderMap[dbField] = displayName;
            fieldDisplayNames[dbField] = displayName;
            currentGroup.push(dbField);
          }
        });

        // Add the last group if it exists
        if(currentGroup.length > 0) {
          fieldGroups.push({
            index: groupIndex,
            name: currentGroupName || `Group ${groupIndex + 1}`,
            fields: [...currentGroup]
          });
        }

      }catch(err){
        console.warn('Could not load field order:', err);
        // Fallback to default alphabetical order
      }
    }

    if(!iid){
      infoEl.innerHTML = '<span class="iid-badge">No IID</span>';
      updateBtn.disabled = true;
    } else {
      // safe display
      const span = document.createElement('span');
      span.className = 'iid-badge';
      span.textContent = iid;
      infoEl.appendChild(span);
      loadRecord(iid);
    }

    async function loadRecord(iid){
      noticeEl.textContent = 'Loading...';
      try{
        // First load field order
        await loadFieldOrder();

        const { data, error } = await supabase
          .from(tableName)
          .select('*')
          .eq('iid', Number(iid))
          .limit(1)
          .single();
        if(error) throw error;

        renderFields(data || {});
        // render photo and name
        try{ await renderPhotoForIID(iid, data); }catch(e){ console.warn('photo render failed', e); }
        noticeEl.textContent = '';
      }catch(err){
        console.error('loadRecord error', err);
        noticeEl.textContent = 'Failed to load record: ' + (err.message || err);
        updateBtn.disabled = true;
      }
    }

    async function renderPhotoForIID(iid, record){
      const wrap = document.getElementById('photoWrap');
      wrap.innerHTML = '';
      // fetch CSV of image links
      try{
        const resp = await fetch('../photo/link.csv');
        if(!resp.ok) throw new Error('photo list not loaded');
        const txt = await resp.text();
        const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(lines.length === 0) return;

        // Find the link that matches the pattern: ends with avatar-{iid}.jpg or avatar-{iid}.png
        let imgUrl = null;
        const jpgPattern = new RegExp(`avatar-${iid}\\.jpg$`);
        const pngPattern = new RegExp(`avatar-${iid}\\.png$`);

        for(const line of lines){
          if(line && (jpgPattern.test(line) || pngPattern.test(line))){
            imgUrl = line;
            break;
          }
        }

        // If no matching image found, show default avatar
        if(!imgUrl){
          const img = document.createElement('img');
          img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDE0MCAxNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNDAiIGhlaWdodD0iMTQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjcwIiBjeT0iNTUiIHI9IjMwIiBmaWxsPSIjQzRDNEM0Ii8+CjxwYXRoIGQ9Ik03MCA4NUM2MCA4NSA2MCA3NSA3MCA3NUM4MCA3NSA4MCA4NSA3MCA4NVoiIGZpbGw9IiNDNEM0RDQiLz4KPHBhdGggZD0iTTcwIDEwNUM2MCAxMDUgNjAgMTE1IDcwIDExNUM4MCAxMTUgODAgMTA1IDcwIDEwNVoiIGZpbGw9IiNDNEM0RDQiLz4KPC9zdmc+';
          img.alt = 'Default Avatar';
          img.style.maxWidth = '140px';
          img.style.maxHeight = '320px';

          const nameEl = document.createElement('div');
          nameEl.className = 'student-name';
          nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

          wrap.appendChild(img);
          wrap.appendChild(nameEl);
          return;
        }

        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = 'Student Photo';
        img.style.maxWidth = '140px';
        img.style.maxHeight = '220px';

        const nameEl = document.createElement('div');
        nameEl.className = 'student-name';
        nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

        wrap.appendChild(img);
        wrap.appendChild(nameEl);
      }catch(err){
        console.warn('renderPhotoForIID error', err);
        // Show default avatar on error
        const img = document.createElement('img');
        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDE0MCAxNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNDAiIGhlaWdodD0iMTQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjcwIiBjeT0iNTUiIHI9IjMwIiBmaWxsPSIjQzRDNEM0Ii8+CjxwYXRoIGQ9Ik03MCA4NUM2MCA4NSA2MCA3NSA3MCA3NUM4MCA3NSA4MCA4NSA3MCA4NVoiIGZpbGw9IiNDNEM0RDQiLz4KPHBhdGggZD0iTTcwIDEwNUM2MCAxMDUgNjAgMTE1IDcwIDExNUM4MCAxMTUgODAgMTA1IDcwIDEwNVoiIGZpbGw9IiNDNEM0RDQiLz4KPC9zdmc+';
        img.alt = 'Default Avatar';
        img.style.maxWidth = '140px';
        img.style.maxHeight = '220px';

        const nameEl = document.createElement('div');
        nameEl.className = 'student-name';
        nameEl.textContent = (record && record.student_name_en) ? record.student_name_en : `Student ID: ${iid}`;

        wrap.appendChild(img);
        wrap.appendChild(nameEl);
      }
    }

    function renderFields(record){
      fieldsEl.innerHTML = '';

      // Get all field keys
      const allKeys = Object.keys(record);

      // Separate ordered and unordered fields
      const orderedFields = [];
      const unorderedFields = [];

      allKeys.forEach(key => {
        if(fieldOrderMap.hasOwnProperty(key)){
          orderedFields.push(key);
        } else {
          unorderedFields.push(key);
        }
      });

      // Render grouped fields
      fieldGroups.forEach(group => {
        const groupFields = group.fields.filter(field => orderedFields.includes(field));

        if(groupFields.length > 0) {
          // Create group container
          const groupDiv = document.createElement('div');
          groupDiv.className = 'field-group';

          // Create group header
          const groupHeader = document.createElement('h3');
          groupHeader.textContent = group.name;
          groupDiv.appendChild(groupHeader);

          // Add fields in this group
          groupFields.forEach(key => {
            const val = record[key] === null || record[key] === undefined ? '' : record[key];
            
            // Apply two-column layout to all fields starting from student_name_en
            const isTwoColumnField = key !== 'iid' && key !== 'session';
            
            if (isTwoColumnField) {
              // Handle special two-column layout
              if (!groupDiv.querySelector('.field-two-column')) {
                const twoColumnDiv = document.createElement('div');
                twoColumnDiv.className = 'field-two-column';
                
                const leftColumn = document.createElement('div');
                leftColumn.className = 'field-column';
                
                const rightColumn = document.createElement('div');
                rightColumn.className = 'field-column';
                
                twoColumnDiv.appendChild(leftColumn);
                twoColumnDiv.appendChild(rightColumn);
                groupDiv.appendChild(twoColumnDiv);
              }
              
              const twoColumnDiv = groupDiv.querySelector('.field-two-column');
              const columns = twoColumnDiv.querySelectorAll('.field-column');
              const targetColumn = columns[columns[0].children.length <= columns[1].children.length ? 0 : 1];
              
              const fieldItem = document.createElement('div');
              fieldItem.className = 'field-item';
              
              const label = document.createElement('label');
              const displayName = fieldDisplayNames[key] || key;
              label.textContent = displayName;
              
              // Field-specific selects (religion/gender/class/section/blood/group/freedom)
              let input;
              const lk = String(key).toLowerCase();
              if(lk.includes('relig') || lk === 'religion'){
                input = document.createElement('select');
                ['','HINDU','ISLAM','BUDDHA','CHRISTIAN'].forEach(o=>{ const el = document.createElement('option'); el.value = o; el.textContent = o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('gender') || lk === 'sex' || lk.includes('student_gender')){
                input = document.createElement('select');
                ['','MALE','FEMALE'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if((lk === 'class' || lk.includes('class_') || lk === 'class_2025' || lk === 'class_2026' || lk === 'class ') && lk !== 'previous_class_roll'){
                input = document.createElement('select');
                ['','6','7','8','9','10'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('section')){
                input = document.createElement('select');
                ['','SHAPLA','GOLAP','MORNING'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('blood')){
                input = document.createElement('select');
                ['','A+','A-','B+','B-','AB+','AB-','O+','O-'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('group') && !lk.includes('field-group')){
                input = document.createElement('select');
                ['','SCIENCE','BUSINESS STUDIES','HUMANITIES'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(lk.includes('freedom') || lk.includes('freedom_fighter') || (lk.includes('quote') && lk.includes('freedom'))){
                input = document.createElement('select');
                ['','YES','NO'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
                input.value = val || '';
              } else if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
                input = document.createElement('textarea');
                input.rows = 3;
              } else {
                input = document.createElement('input');
                input.type = 'text';
              }
              input.value = val;
              input.setAttribute('data-field', key);
              if(key === 'iid') input.readOnly = true;
              
              fieldItem.appendChild(label);
              fieldItem.appendChild(input);
              targetColumn.appendChild(fieldItem);
            } else {
              // Regular field-row layout for iid and session
              const row = document.createElement('div');
              row.className = 'field-row';

              const label = document.createElement('label');
              const displayName = fieldDisplayNames[key] || key;
              label.textContent = displayName + ':';

              let input;
              if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
                input = document.createElement('textarea');
                input.rows = 4;
              } else {
                input = document.createElement('input');
                input.type = 'text';
              }
              input.value = val;
              input.setAttribute('data-field', key);
              if(key === 'iid') input.readOnly = true;

              row.appendChild(label);
              row.appendChild(input);
              groupDiv.appendChild(row);
            }
          });

          fieldsEl.appendChild(groupDiv);
        }
      });
      // Render unordered fields at the end
      if(unorderedFields.length > 0) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'field-group';

        const groupHeader = document.createElement('h3');
        groupHeader.textContent = 'Additional Information';
        groupDiv.appendChild(groupHeader);

        unorderedFields.sort().forEach(key => {
          const val = record[key] === null || record[key] === undefined ? '' : record[key];
          
          // Apply two-column layout to all fields starting from student_name_en
          const isTwoColumnField = key !== 'iid' && key !== 'session';
          
          if (isTwoColumnField) {
            // Handle special two-column layout
            if (!groupDiv.querySelector('.field-two-column')) {
              const twoColumnDiv = document.createElement('div');
              twoColumnDiv.className = 'field-two-column';
              
              const leftColumn = document.createElement('div');
              leftColumn.className = 'field-column';
              
              const rightColumn = document.createElement('div');
              rightColumn.className = 'field-column';
              
              twoColumnDiv.appendChild(leftColumn);
              twoColumnDiv.appendChild(rightColumn);
              groupDiv.appendChild(twoColumnDiv);
            }
            
            const twoColumnDiv = groupDiv.querySelector('.field-two-column');
            const columns = twoColumnDiv.querySelectorAll('.field-column');
            const targetColumn = columns[columns[0].children.length <= columns[1].children.length ? 0 : 1];
            
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';
            
            const label = document.createElement('label');
            const displayName = fieldDisplayNames[key] || key;
            label.textContent = displayName;
            
            // Field-specific selects
            let input;
            const lk = String(key).toLowerCase();
            if(lk.includes('relig') || lk === 'religion'){
              input = document.createElement('select');
              ['','HINDU','ISLAM','BUDDHA','CHRISTIAN'].forEach(o=>{ const el = document.createElement('option'); el.value = o; el.textContent = o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('gender') || lk === 'sex' || lk.includes('student_gender')){
              input = document.createElement('select');
              ['','MALE','FEMALE'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if((lk === 'class' || lk.includes('class_') || lk === 'class_2025' || lk === 'class_2026' || lk === 'class ') && lk !== 'previous_class_roll'){
              input = document.createElement('select');
              ['','6','7','8','9','10'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('section')){
              input = document.createElement('select');
              ['','SHAPLA','GOLAP','MORNING'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('blood')){
              input = document.createElement('select');
              ['','A+','A-','B+','B-','AB+','AB-','O+','O-'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('group') && !lk.includes('field-group')){
              input = document.createElement('select');
              ['','SCIENCE','BUSINESS STUDIES','HUMANITIES'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('freedom') || lk.includes('freedom_fighter') || (lk.includes('quote') && lk.includes('freedom'))){
              input = document.createElement('select');
              ['','YES','NO'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
              input = document.createElement('textarea');
              input.rows = 3;
            } else {
              input = document.createElement('input');
              input.type = 'text';
            }
            input.value = val;
            input.setAttribute('data-field', key);
            if(key === 'iid') input.readOnly = true;
            
            fieldItem.appendChild(label);
            fieldItem.appendChild(input);
            targetColumn.appendChild(fieldItem);
          } else {
            // Regular field-row layout for iid and session
            const row = document.createElement('div');
            row.className = 'field-row';

            const label = document.createElement('label');
            const displayName = fieldDisplayNames[key] || key;
            label.textContent = displayName + ':';

            // Field-specific selects
            let input;
            const lk = String(key).toLowerCase();
            if(lk.includes('relig') || lk === 'religion'){
              input = document.createElement('select');
              ['','HINDU','ISLAM','BUDDHA','CHRISTIAN'].forEach(o=>{ const el = document.createElement('option'); el.value = o; el.textContent = o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('gender') || lk === 'sex' || lk.includes('student_gender')){
              input = document.createElement('select');
              ['','MALE','FEMALE'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if((lk === 'class' || lk.includes('class_') || lk === 'class_2025' || lk === 'class_2026' || lk === 'class ') && lk !== 'previous_class_roll'){
              input = document.createElement('select');
              ['','6','7','8','9','10'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('section')){
              input = document.createElement('select');
              ['','SHAPLA','GOLAP','MORNING'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('blood')){
              input = document.createElement('select');
              ['','A+','A-','B+','B-','AB+','AB-','O+','O-'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('group') && !lk.includes('field-group')){
              input = document.createElement('select');
              ['','SCIENCE','BUSINESS STUDIES','HUMANITIES'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(lk.includes('freedom') || lk.includes('freedom_fighter') || (lk.includes('quote') && lk.includes('freedom'))){
              input = document.createElement('select');
              ['','YES','NO'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent=o || 'Select'; input.appendChild(el); });
              input.value = val || '';
            } else if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note') || key.toLowerCase().includes('comment')){
              input = document.createElement('textarea');
              input.rows = 4;
            } else {
              input = document.createElement('input');
              input.type = 'text';
            }
            input.value = val;
            input.setAttribute('data-field', key);
            if(key === 'iid') input.readOnly = true;

            row.appendChild(label);
            row.appendChild(input);
            groupDiv.appendChild(row);
          }
        });

        fieldsEl.appendChild(groupDiv);
      }
    }

    async function saveChanges(){
      noticeEl.textContent = '';
      const inputs = fieldsEl.querySelectorAll('[data-field]');
      const payload = {};
      inputs.forEach(inp =>{
        const field = inp.getAttribute('data-field');
        if(field === 'iid') return;
        const v = inp.value === '' ? null : inp.value;
        payload[field] = v;
      });
      updateBtn.disabled = true;
      updateBtn.textContent = 'Updating...';
      try{
        const { data, error } = await supabase
          .from(tableName)
          .update(payload)
          .eq('iid', Number(iid));
        if(error) throw error;
        noticeEl.classList.remove('');
        noticeEl.classList.add('success');
        noticeEl.textContent = 'Updated successfully.';
      }catch(err){
        console.error('update error', err);
        noticeEl.classList.remove('success');
        noticeEl.textContent = 'Update failed: ' + (err.message || err);
      }finally{
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update';
      }
    }

    // photo preview functionality
    const photoWrap = document.getElementById('photoWrap');
    const photoPreview = document.createElement('div');
    photoPreview.id = 'photo-preview';
    const previewImg = document.createElement('img');
    previewImg.style.width = '100%';
    previewImg.style.height = '100%';
    previewImg.style.objectFit = 'cover';
    photoPreview.appendChild(previewImg);
    document.body.appendChild(photoPreview);

    photoWrap.addEventListener('mouseover', (e) => {
      if(e.target.tagName === 'IMG'){
        previewImg.src = e.target.src;
        photoPreview.style.display = 'block';
      }
    });

    photoWrap.addEventListener('mouseout', (e) => {
      if(e.target.tagName === 'IMG'){
        photoPreview.style.display = 'none';
      }
    });
  </script>
</body>
</html>
