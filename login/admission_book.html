<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Admission Book 2025</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="./auth-check_copy.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
 body{ margin:0; font-family:Inter, system-ui, Arial, sans-serif; background:#f5f7fa; color:#111; }
 header{ background:#fff; border-bottom:1px solid #e2e8f0; padding:1rem 1.25rem; }
 .header-row{ display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; margin-bottom:.75rem; }
 .header-row:last-child{ margin-bottom:0; }
 h1{ font-size:1.25rem; margin:0; min-width:180px; }
 select, button, input[type=search]{ padding:.55rem .8rem; font-size:.9rem; border:1px solid #cbd5e1; border-radius:8px; background:#fff; font-family:inherit; min-width:120px; }
 button{ background:#0ea5e9; color:#fff; border-color:#0284c7; cursor:pointer; font-weight:600; }
 button:disabled{ opacity:.6; cursor:not-allowed; }
 #pdfAdvancedBtn{ background:#059669; border-color:#047857; }
 #pdfAdvancedBtn:hover{ background:#047857; }
 .status{ font-size:.85rem; color:#475569; min-width:160px; }
 input[type=search]{ min-width:200px; }
 main{ max-width: 1400px; margin:1rem auto 2rem; background:#fff; border:1px solid #e2e8f0; border-radius:12px; overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,.04); }
 table{ border-collapse:collapse; width:100%; font-size:.72rem; }
 thead th{ background:#dfeff5; padding:.5rem .4rem; text-align:left; border:1px solid #e2e8f0; font-weight:600; }
 tbody td{ padding:.45rem .4rem; border:1px solid #eef2f5; vertical-align:top; background:#f9fbfc; }
 tbody tr:nth-child(even) td{ background:#f3f8fa; }
 .group-row td{ background:#f0f6f8; font-weight:600; font-size:.78rem; letter-spacing:.4px; }
 .sticky-head thead th{ position:sticky; top:0; z-index:5; }
 .small{ font-size:.65rem; color:#555; }
 .toolbar-spacer{ flex:1 1 auto; }
 .print-note{ font-size:.65rem; color:#64748b; margin-left:.75rem; }
 
 /* Style for auto-generated admission dates */
 .auto-date{ color:#e11d48; font-weight:600; }
 .auto-date::after{ content:" *"; font-size:.6em; color:#9ca3af; }
 
 /* Print styles for exact Ctrl+P appearance */
 @media print{ 
   * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
   
   body{ background:#fff; font-size:14px; margin:0; padding:0; }
   header{ position:static; padding:0.8rem; border:none; page-break-inside:avoid; }
   .header-row{ justify-content:center; margin-bottom:0.5rem; }
   h1{ font-size:20px; text-align:center; font-weight:bold; margin-bottom:10px; }
   button, #searchBox, select, .status{ display:none !important; }
   main{ box-shadow:none; border:none; margin:0; border-radius:0; max-width:none; height:auto; }
   table{ 
     font-size:12px; 
     width:100%; 
     border-collapse:collapse;
     page-break-inside:auto;
     table-layout: fixed;
   }
   thead{ 
     display:table-header-group; 
     break-inside:avoid;
   }
   thead th{ 
     background:#f0f0f0 !important; 
     padding:8px 4px; 
     font-size:11px; 
     border:2px solid #000;
     page-break-inside:avoid;
     font-weight:bold;
     text-align:center;
     height:40px;
     vertical-align:middle;
   }
   tbody{ 
     display:table-row-group;
   }
   tbody tr{ 
     page-break-inside:avoid; 
     break-inside:avoid;
     height:auto;
     min-height:40px;
   }
   tbody tr:not(.group-row) {
     height:auto !important;
     min-height:40px !important;
   }
   tbody td{ 
     padding:6px 4px; 
     font-size:10px; 
     border:1.5px solid #000;
     line-height:1.3;
     vertical-align:top;
     height:auto;
     min-height:40px;
     overflow:hidden;
   }
   .group-row{ 
     page-break-before:auto; 
     page-break-after:avoid;
     break-after:avoid;
     height:30px !important;
   }
   .group-row td{ 
     background:#e0e0e0 !important; 
     font-size:12px; 
     padding:8px;
     font-weight:bold;
     text-align:center;
     border:2px solid #000;
     height:30px;
   }
   .small{ font-size:9px; }
   img{ 
     max-width:35px !important; 
     max-height:40px !important; 
     object-fit:cover;
   }
   @page{ 
     size:A4 landscape; 
     margin:0.3cm; 
   }
   
   /* Ensure table headers repeat on each page */
   thead{ 
     display:table-header-group;
   }
   
   /* Natural page breaks - allow minimum 8 rows per page */
   tbody tr:not(.group-row):nth-child(8n) { 
     page-break-after: auto;
   }
   
   /* Avoid breaking rows */
   tr{ 
     page-break-inside:avoid;
   }
   
   /* Keep group headers with their content */
   .group-row{ 
     page-break-after:avoid;
     page-break-before:auto;
   }
   
   /* Prevent section headers from being orphaned */
   .group-row + tr:not(.group-row) {
     page-break-before: avoid;
   }
   
   /* Better widow/orphan control */
   tbody {
     orphans: 3;
     widows: 3;
   }
   
   /* Custom page break classes */
   .page-break-after {
     page-break-after: always !important;
   }
   
   .page-break-before {
     page-break-before: always !important;
   }
   
   /* Prevent orphan rows - ensure at least 3 rows stay together */
   tbody tr:not(.group-row):nth-last-child(-n+3) {
     page-break-before: avoid;
   }
   
   /* Natural flow with good spacing */
   .print-optimized tbody tr:not(.group-row) {
     height: auto !important;
     min-height: 40px !important;
   }
   
   .print-optimized thead th {
     height: 40px;
   }
   
   /* Better page utilization */
   .print-optimized {
     height: auto;
     orphans: 3;
     widows: 3;
   }
   
   /* Auto-generated dates in print */
   .auto-date {
     color: #000 !important;
     font-weight: bold !important;
   }
 }
</style>
</head>
<body>
 <header>
  <div class="header-row">
   <h1>Admission Book</h1>
   <select id="classYearSelect" aria-label="Class Year">
    <option value="">Select Class Year</option>
    <option value="class_2024">Class 2024</option>
    <option value="class_2025">Class 2025</option>
    <option value="class_2026">Class 2026</option>
   </select>
   <select id="classSelect" aria-label="Class"><option value="">Select Class</option></select>
   <select id="sectionSelect" aria-label="Section"><option value="">Select Section</option></select>
   <span id="status" class="status">Select class year</span>
  </div>
  <div class="header-row">
   <input id="searchBox" type="search" placeholder="Search name / IID / roll" />
   <button id="printBtn" onclick="window.print()">Print (Ctrl+P)</button>
   <div style="flex:1;"></div>
  </div>
 </header>
 <main>
	<table id="bookTable" class="sticky-head">
	 <thead>
		<tr>
		 <th>S.L</th>
		 <th>ADMISSION<br>DATE<br>UID</th>
		 <th>NAME<br>FATHER'S NAME<br>MOTHER'S NAME<br>MOBILE NO</th>
		 <th>CLASS<br>SECTION<br>ROLL<br>SESSION</th>
		 <th>DATE OF BIRTH<br>GENDER<br>RELIGION<br>BIRTH REG NUMBER</th>
		 <th>VILLAGE<br>POST OFFICE<br>UPAZILLA<br>DISTRICT</th>
		 <th>OCCUPATION<br>STUDENT AGE<br>PREVIOUS SCHOOL</th>
		 <th>FREEDOM FIGHTER CHILD</th>
		 <th>PHOTO</th>
		 <th>HEAD MASTER<br>SINE</th>
		 <th>COMMENT</th>
		</tr>
	 </thead>
	 <tbody></tbody>
	</table>
 </main>
 <script>
 const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
 const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
 const tableName = 'student_database';
 let supabaseClient;
 let allRows = [];
 let currentClassYear = ''; // e.g., 'class_2025'
 let currentClass = '';
 let currentSection = '';

 function setStatus(msg){ const el=document.getElementById('status'); if(el) el.textContent=msg; }
 function initSupabase(){ if(supabaseClient) return supabaseClient; supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey); return supabaseClient; }

 async function loadClassOptions(){
   if(!currentClassYear){ document.getElementById('classSelect').innerHTML='<option value="">Select Class</option>'; return; }
   setStatus('Loading classes…'); initSupabase();
   const { data, error } = await supabaseClient.from(tableName).select(currentClassYear).not(currentClassYear,'is',null);
   if(error){ setStatus('Class load failed'); console.error(error); return; }
   const set = new Set(); data.forEach(r=>{ const c=String(r[currentClassYear]||'').trim(); if(c) set.add(c); });
   const list = [...set].sort((a,b)=>Number(a)-Number(b));
   const sel = document.getElementById('classSelect'); sel.innerHTML='<option value="">Select Class</option>' + list.map(c=>`<option value="${c}">${c}</option>`).join('');
   setStatus('Select class');
 }

 async function loadSectionOptions(){
   if(!currentClassYear || !currentClass){ document.getElementById('sectionSelect').innerHTML='<option value="">Select Section</option>'; return; }
   setStatus('Loading sections…');
   const sectionCol = currentClassYear.replace('class_', 'section_'); // class_2025 -> section_2025
   const { data, error } = await supabaseClient.from(tableName).select(sectionCol).eq(currentClassYear, currentClass).not(sectionCol,'is',null);
   if(error){ setStatus('Section load failed'); console.error(error); return; }
   const set = new Set(); data.forEach(r=>{ const s=String(r[sectionCol]||'').trim(); if(s) set.add(s); });
   const list=[...set].sort();
   const sel=document.getElementById('sectionSelect'); sel.innerHTML='<option value="">Select Section</option>' + list.map(s=>`<option value="${s}">${s}</option>`).join('');
   setStatus('Select section');
 }

 async function loadRows(){
   if(!currentClassYear){ setStatus('Select class year'); return; }
   setStatus('Loading students…');
   const sectionCol = currentClassYear.replace('class_', 'section_'); // class_2025 -> section_2025
   const rollCol = currentClassYear.replace('class_', 'roll_'); // class_2025 -> roll_2025
   
   try {
     let query = supabaseClient
       .from('student_database')
       .select(`
         iid,admission_date,student_name_en,father_name_en,mother_name_en,father_mobile,
         ${currentClassYear},session,student_dateofbirth,religion,birth_registration,student_gender,
         village_en,postoffice_en,upazilla_en,district_en,father_occupation,previous_school,
         quote_freedomfighter,student_photo_url,status,${sectionCol},${rollCol}
       `)
       .not('iid','is',null)
       .not(currentClassYear,'is',null)
       .order(currentClassYear)
       .order(sectionCol)
       .order(rollCol,{ ascending:true });
       
     // If class is selected, filter by class
     if(currentClass){
       query = query.eq(currentClassYear, currentClass);
     }
       
     // If section is selected, filter by section too
     if(currentSection){
       query = query.eq(sectionCol, currentSection);
     }
       
     const { data, error } = await query;
       
     if(error){ 
       setStatus('Student load failed: ' + error.message); 
       console.error('Supabase error:', error); 
       return; 
     }
     
     allRows = data || [];
     setStatus(`Loaded ${allRows.length} students`);
     renderTable();
     
   } catch(err) {
     setStatus('Network error: ' + err.message);
     console.error('Network error:', err);
   }
 } function simplify(val){ return (val==null||val==='null'||val==='undefined')? '' : String(val); }

 function calculateAge(birthDate, admissionDate, classYear = null) {
   if (!birthDate) return '';
   
   // Handle null admission date based on class year
   if (!admissionDate || admissionDate === 'null' || admissionDate === null) {
     if (classYear) {
       const year = classYear.replace('class_', '');
       admissionDate = `01-01-${year}`;
     } else {
       return ''; // Can't calculate without admission date or class year
     }
   }
   
   // Parse dates in dd-mm-yyyy format
   function parseDate(dateStr) {
     if (!dateStr) return null;
     
     // Handle different date formats
     const dateString = String(dateStr).trim().replace('*', ''); // Remove * mark for parsing
     
     // Check if it's in dd-mm-yyyy format (22-12-2024)
     if (dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
       const [day, month, year] = dateString.split('-');
       return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
     }
     
     // Check if it's in yyyy-mm-dd format
     if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
       return new Date(dateString);
     }
     
     // Try other common formats
     return new Date(dateString);
   }
   
   const birth = parseDate(birthDate);
   const admission = parseDate(admissionDate);
   
   if (!birth || !admission || isNaN(birth.getTime()) || isNaN(admission.getTime())) {
     return '';
   }
   
   // Calculate age in years and months
   let years = admission.getFullYear() - birth.getFullYear();
   let months = admission.getMonth() - birth.getMonth();
   let days = admission.getDate() - birth.getDate();
   
   // Adjust if day difference is negative
   if (days < 0) {
     months--;
     const daysInPrevMonth = new Date(admission.getFullYear(), admission.getMonth(), 0).getDate();
     days += daysInPrevMonth;
   }
   
   // Adjust if month difference is negative
   if (months < 0) {
     years--;
     months += 12;
   }
   
   // Format the result
   if (years > 0) {
     if (months > 0) {
       return `${years} years ${months} months`;
     } else {
       return `${years} years`;
     }
   } else if (months > 0) {
     return `${months} months`;
   } else {
     return `${days} days`;
   }
 }

 // Helper function to get admission date (handle null values)
 function getAdmissionDate(admissionDate, classYear) {
   if (admissionDate && admissionDate !== 'null' && admissionDate !== null && admissionDate.trim() !== '') {
     return admissionDate;
   }
   
   // Return default date based on class year with * mark
   if (classYear) {
     const year = classYear.replace('class_', '');
     return `01-01-${year}*`;
   }
   
   return '01-01-2025*'; // fallback with * mark
 }

 // Test function for age calculation - you can test in browser console
 function testAgeCalculation() {
   console.log('Testing age calculation:');
   console.log('Birth: 25-02-2014, Admission: 22-12-2024');
   console.log('Calculated Age:', calculateAge('25-02-2014', '22-12-2024'));
   
   console.log('Birth: 15-03-2015, Admission: 01-01-2025');
   console.log('Calculated Age:', calculateAge('15-03-2015', '01-01-2025'));
   
   console.log('Birth: 10-05-2016, Admission: null, Class: class_2026');
   console.log('Calculated Age:', calculateAge('10-05-2016', null, 'class_2026'));
   
   console.log('Testing getAdmissionDate:');
   console.log('Null admission, class_2025:', getAdmissionDate(null, 'class_2025'));
   console.log('Null admission, class_2024:', getAdmissionDate(null, 'class_2024'));
   console.log('Null admission, class_2026:', getAdmissionDate(null, 'class_2026'));
   console.log('Empty string admission, class_2025:', getAdmissionDate('', 'class_2025'));
   console.log('Valid admission date:', getAdmissionDate('15-06-2024', 'class_2025'));
   
   return 'Test completed. Check console for results.';
 }

 async function generatePDF() {
   if (!allRows.length) {
     alert('No data to export');
     return;
   }

   const year = currentClassYear.replace('class_', '');
   const filename = `admission_book_${year}_${new Date().toISOString().split('T')[0]}.pdf`;
   
   try {
     // Show loading message
     const pdfBtn = document.getElementById('pdfBtn');
     const originalText = pdfBtn.textContent;
     pdfBtn.textContent = 'Generating PDF...';
     pdfBtn.disabled = true;
     
     // Get the table element
     const table = document.getElementById('bookTable');
     
     // Create temporary container with print styles
     const tempDiv = document.createElement('div');
     tempDiv.style.position = 'absolute';
     tempDiv.style.left = '-9999px';
     tempDiv.style.top = '0';
     tempDiv.style.background = 'white';
     tempDiv.style.width = '1400px';
     tempDiv.style.fontFamily = 'Arial, sans-serif';
     tempDiv.style.fontSize = '10px'; // Smaller font for better fit
     tempDiv.style.color = 'black';
     
     // Clone and modify table for PDF
     const tableClone = table.cloneNode(true);
     
     // Apply PDF-specific styles to the cloned table
     tableClone.style.width = '100%';
     tableClone.style.fontSize = '8px';
     tableClone.style.borderCollapse = 'collapse';
     
     // Style header
     const headers = tableClone.querySelectorAll('thead th');
     headers.forEach(th => {
       th.style.background = '#f0f0f0';
       th.style.padding = '4px 2px';
       th.style.border = '1px solid #ccc';
       th.style.fontSize = '7px';
       th.style.fontWeight = 'bold';
     });
     
     // Style body cells
     const cells = tableClone.querySelectorAll('tbody td');
     cells.forEach(td => {
       td.style.padding = '3px 2px';
       td.style.border = '1px solid #ddd';
       td.style.fontSize = '7px';
       td.style.lineHeight = '1.2';
     });
     
     // Style group rows
     const groupRows = tableClone.querySelectorAll('.group-row td');
     groupRows.forEach(td => {
       td.style.background = '#e8e8e8';
       td.style.fontSize = '8px';
       td.style.fontWeight = 'bold';
       td.style.padding = '6px';
     });
     
     // Style images in PDF
     const images = tableClone.querySelectorAll('img');
     images.forEach(img => {
       img.style.maxWidth = '25px';
       img.style.maxHeight = '30px';
       img.style.objectFit = 'cover';
     });
     
     // Add title and table to temp div
     tempDiv.innerHTML = `
       <div style="text-align:center;margin-bottom:15px;font-size:16px;font-weight:bold;color:black;">
         Admission Book ${year}
       </div>
       ${tableClone.outerHTML}
     `;
     
     document.body.appendChild(tempDiv);
     
     // Wait for images to load
     const imgElements = tempDiv.querySelectorAll('img');
     await Promise.all(Array.from(imgElements).map(img => {
       return new Promise(resolve => {
         if (img.complete) {
           resolve();
         } else {
           img.onload = resolve;
           img.onerror = resolve;
           setTimeout(resolve, 2000); // Timeout after 2 seconds
         }
       });
     }));
     
     // Create PDF with better page handling
     const { jsPDF } = window.jspdf;
     const pdf = new jsPDF({
       orientation: 'landscape',
       unit: 'mm',
       format: 'a4'
     });
     
     const pageWidth = 297; // A4 landscape width in mm
     const pageHeight = 210; // A4 landscape height in mm
     const margin = 5; // Small margin
     const contentWidth = pageWidth - (margin * 2);
     const contentHeight = pageHeight - (margin * 2);
     
     // Calculate scale to fit content width
     const scale = contentWidth / (tempDiv.scrollWidth * 0.264583); // Convert px to mm
     
     // Generate canvas with better settings
     const canvas = await html2canvas(tempDiv, {
       scale: Math.max(1, scale * 2), // Higher scale for better quality
       useCORS: true,
       allowTaint: true,
       backgroundColor: '#ffffff',
       width: tempDiv.scrollWidth,
       height: tempDiv.scrollHeight,
       scrollX: 0,
       scrollY: 0,
       logging: false
     });
     
     // Remove temporary div
     document.body.removeChild(tempDiv);
     
     const imgData = canvas.toDataURL('image/png', 1.0);
     const imgWidth = contentWidth;
     const imgHeight = (canvas.height * imgWidth) / canvas.width;
     
     // Add pages as needed
     let yPosition = 0;
     let pageNumber = 1;
     
     while (yPosition < imgHeight) {
       if (pageNumber > 1) {
         pdf.addPage();
       }
       
       // Calculate how much of the image fits on this page
       const remainingHeight = imgHeight - yPosition;
       const pageImageHeight = Math.min(contentHeight, remainingHeight);
       
       // Add the image portion to this page
       pdf.addImage(
         imgData, 
         'PNG', 
         margin, 
         margin, 
         imgWidth, 
         imgHeight,
         undefined,
         'FAST',
         0,
         -yPosition // Negative offset to show different part of image
       );
       
       // Add page number
       pdf.setFontSize(8);
       pdf.setTextColor(100);
       pdf.text(`Page ${pageNumber}`, pageWidth - 20, pageHeight - 5);
       
       yPosition += contentHeight;
       pageNumber++;
       
       // Safety break to prevent infinite loop
       if (pageNumber > 50) break;
     }
     
     // Save the PDF
     pdf.save(filename);
     
     // Restore button
     pdfBtn.textContent = originalText;
     pdfBtn.disabled = false;
     
   } catch (error) {
     console.error('PDF generation failed:', error);
     alert('PDF generation failed. Please try using Ctrl+P to print manually.');
     
     // Restore button on error
     const pdfBtn = document.getElementById('pdfBtn');
     pdfBtn.textContent = 'Download as PDF';
     pdfBtn.disabled = false;
   }
 }

 async function generateAdvancedPDF() {
   if (!allRows.length) {
     alert('No data to export');
     return;
   }

   const year = currentClassYear.replace('class_', '');
   const filename = `admission_book_advanced_${year}_${new Date().toISOString().split('T')[0]}.pdf`;
   
   try {
     // Show loading message
     const pdfBtn = document.getElementById('pdfAdvancedBtn');
     const originalText = pdfBtn.textContent;
     pdfBtn.textContent = 'Generating...';
     pdfBtn.disabled = true;
     
     const { jsPDF } = window.jspdf;
     const pdf = new jsPDF({
       orientation: 'landscape',
       unit: 'mm',
       format: 'a4'
     });
     
     const pageWidth = 297;
     const pageHeight = 210;
     const margin = 10;
     const contentWidth = pageWidth - (margin * 2);
     const contentHeight = pageHeight - (margin * 2);
     
     // Title
     pdf.setFontSize(16);
     pdf.setFont(undefined, 'bold');
     pdf.text(`Admission Book ${year}`, pageWidth / 2, 20, { align: 'center' });
     
     // Table setup
     const sectionCol = currentClassYear.replace('class_', 'section_');
     const rollCol = currentClassYear.replace('class_', 'roll_');
     
     // Group data by class and section
     const classes = {};
     allRows.forEach(r => {
       const classValue = r[currentClassYear] || 'Unknown';
       const section = r[sectionCol] || 'Unknown';
       if(!classes[classValue]) classes[classValue] = {};
       if(!classes[classValue][section]) classes[classValue][section] = [];
       classes[classValue][section].push(r);
     });
     
     let yPosition = 35;
     let pageNumber = 1;
     let overallIndex = 0;
     
     // Table headers
     const headers = ['S.L', 'Date\nUID', 'Name\nFather\nMother\nMobile', 'Class\nSection\nRoll\nSession', 
                     'DOB\nGender\nReligion\nBirth Reg', 'Address', 'Occupation\nAge\nPrevious School', 
                     'Freedom Fighter', 'Photo', 'Head Master', 'Comment'];
     
     const colWidths = [15, 25, 45, 30, 35, 40, 35, 25, 20, 20, 25];
     
     function drawTableHeader() {
       pdf.setFontSize(7);
       pdf.setFont(undefined, 'bold');
       
       let xPos = margin;
       headers.forEach((header, i) => {
         pdf.rect(xPos, yPosition, colWidths[i], 15);
         const lines = header.split('\n');
         lines.forEach((line, lineIndex) => {
           pdf.text(line, xPos + colWidths[i]/2, yPosition + 4 + (lineIndex * 3), { align: 'center' });
         });
         xPos += colWidths[i];
       });
       
       yPosition += 15;
     }
     
     function checkPageBreak(neededHeight = 20) {
       if (yPosition + neededHeight > contentHeight + margin) {
         pdf.addPage();
         yPosition = margin + 10;
         
         // Add page number
         pdf.setFontSize(8);
         pdf.setFont(undefined, 'normal');
         pdf.text(`Page ${pageNumber}`, pageWidth - 20, pageHeight - 5);
         pageNumber++;
         
         drawTableHeader();
       }
     }
     
     // Draw initial headers
     drawTableHeader();
     
     // Process each class and section
     Object.keys(classes).sort((a,b)=>Number(a)-Number(b)).forEach(classValue => {
       const classSections = classes[classValue];
       
       Object.keys(classSections).sort().forEach(section => {
         const sectionRows = classSections[section];
         
         // Section header
         checkPageBreak(10);
         pdf.setFontSize(9);
         pdf.setFont(undefined, 'bold');
         pdf.rect(margin, yPosition, contentWidth, 8);
         pdf.text(`Class: ${classValue} || Section: ${section} || ${year}`, pageWidth/2, yPosition + 5, { align: 'center' });
         yPosition += 8;
         
         // Process each student in this section
         sectionRows.forEach(row => {
           overallIndex++;
           checkPageBreak(12);
           
           pdf.setFontSize(6);
           pdf.setFont(undefined, 'normal');
           
           let xPos = margin;
           const admissionDateToShow = getAdmissionDate(row.admission_date, currentClassYear);
           const rowData = [
             overallIndex.toString(),
             `${simplify(admissionDateToShow)}\n${simplify(row.iid)}`,
             `${simplify(row.student_name_en)}\n${simplify(row.father_name_en)}\n${simplify(row.mother_name_en)}\n${simplify(row.father_mobile)}`,
             `${simplify(row[currentClassYear])}\n${simplify(row[sectionCol])}\n${simplify(row[rollCol])}\n${simplify(row.session)}`,
             `${simplify(row.student_dateofbirth)}\n${simplify(row.student_gender)}\n${simplify(row.religion)}\n${simplify(row.birth_registration)}`,
             `${simplify(row.village_en)}\n${simplify(row.postoffice_en)}\n${simplify(row.upazilla_en)}\n${simplify(row.district_en)}`,
             `${simplify(row.father_occupation)}\n${calculateAge(row.student_dateofbirth, admissionDateToShow, currentClassYear)}\n${simplify(row.previous_school)}`,
             simplify(row.quote_freedomfighter),
             row.student_photo_url && row.student_photo_url.trim() && row.student_photo_url !== 'null' ? 'Photo' : 'No Photo',
             '',
             simplify(row.status)
           ];
           
           const cellHeight = 12;
           
           rowData.forEach((cellData, i) => {
             pdf.rect(xPos, yPosition, colWidths[i], cellHeight);
             
             if (cellData) {
               const lines = cellData.toString().split('\n');
               lines.forEach((line, lineIndex) => {
                 if (lineIndex < 4) { // Limit to 4 lines per cell
                   pdf.text(line.substring(0, 25), xPos + 1, yPosition + 3 + (lineIndex * 2.5), { maxWidth: colWidths[i] - 2 });
                 }
               });
             }
             
             xPos += colWidths[i];
           });
           
           yPosition += cellHeight;
         });
       });
     });
     
     // Add final page number
     pdf.setFontSize(8);
     pdf.text(`Page ${pageNumber}`, pageWidth - 20, pageHeight - 5);
     
     // Save the PDF
     pdf.save(filename);
     
     // Restore button
     pdfBtn.textContent = originalText;
     pdfBtn.disabled = false;
     
   } catch (error) {
     console.error('Advanced PDF generation failed:', error);
     alert('Advanced PDF generation failed: ' + error.message);
     
     // Restore button on error
     const pdfBtn = document.getElementById('pdfAdvancedBtn');
     pdfBtn.textContent = 'Advanced PDF';
     pdfBtn.disabled = false;
   }
 }

 function renderTable(){
   const tbody=document.querySelector('#bookTable tbody'); tbody.innerHTML='';
   if(!allRows.length){ tbody.innerHTML='<tr><td colspan="11" style="text-align:center;padding:1rem;">No records</td></tr>'; setStatus('0 rows'); return; }
   
   const year = currentClassYear.replace('class_', ''); // class_2025 -> 2025
   const sectionCol = currentClassYear.replace('class_', 'section_');
   
   // Debug: Check photo URLs
   console.log('Photo URLs check:', allRows.slice(0,3).map(r => ({
     name: r.student_name_en,
     photo_url: r.student_photo_url,
     type: typeof r.student_photo_url,
     length: r.student_photo_url ? r.student_photo_url.length : 0
   })));
   
   // Group by class first, then by section
   const classes = {};
   allRows.forEach(r => {
     const classValue = r[currentClassYear] || 'Unknown';
     const section = r[sectionCol] || 'Unknown';
     if(!classes[classValue]) classes[classValue] = {};
     if(!classes[classValue][section]) classes[classValue][section] = [];
     classes[classValue][section].push(r);
   });
   
   let overallIndex = 0; // Continuous serial number
   
   // Render each class and its sections
   Object.keys(classes).sort((a,b)=>Number(a)-Number(b)).forEach(classValue => {
     const classSections = classes[classValue];
     
     Object.keys(classSections).sort().forEach(section => {
       const sectionRows = classSections[section];
       
       // Section header row
       const groupTr = document.createElement('tr');
       groupTr.className = 'group-row';
       groupTr.innerHTML = `<td colspan="11" style="text-align:center;padding:0.8rem;font-weight:bold;">Class: ${classValue} || Section: ${section} || ${year}</td>`;
       tbody.appendChild(groupTr);
       
       // Section data rows with continuous serial
       sectionRows.forEach((r)=>{
         overallIndex++; // Increment for each row
         const tr=document.createElement('tr');
         const rollCol = currentClassYear.replace('class_', 'roll_');
         const admissionDateToShow = getAdmissionDate(r.admission_date, currentClassYear);
         const calculatedAge = calculateAge(r.student_dateofbirth, admissionDateToShow, currentClassYear);
         const isAutoDate = admissionDateToShow.includes('*');
         const dateClass = isAutoDate ? 'auto-date' : '';
         
         tr.innerHTML = `
           <td>${overallIndex}</td>
           <td><span class="${dateClass}">${simplify(admissionDateToShow)}</span><br><span class="small">${simplify(r.iid)}</span></td>
           <td><strong>${simplify(r.student_name_en)}</strong><br><span class="small">${simplify(r.father_name_en)}<br>${simplify(r.mother_name_en)}<br>${simplify(r.father_mobile)}</span></td>
           <td>${simplify(r[currentClassYear])}<br><span class="small">${simplify(r[sectionCol])}<br>${simplify(r[rollCol])}<br>${simplify(r.session)}</span></td>
           <td>${simplify(r.student_dateofbirth)}<br><span class="small">${simplify(r.student_gender)}<br>${simplify(r.religion)}<br>${simplify(r.birth_registration)}</span></td>
           <td>${[r.village_en,r.postoffice_en,r.upazilla_en,r.district_en].map(simplify).filter(Boolean).join('<br>')}</td>
           <td>${simplify(r.father_occupation)}<br><span class="small">${calculatedAge}<br>${simplify(r.previous_school)}</span></td>
           <td>${simplify(r.quote_freedomfighter)}</td>
           <td style="text-align:center;padding:0.2rem;">${r.student_photo_url && r.student_photo_url.trim() && r.student_photo_url !== 'null' ? `<img src="${r.student_photo_url.trim()}" style="width:40px;height:50px;object-fit:cover;border:1px solid #ddd;background:#f5f5f5;" alt="Photo" onerror="this.style.display='none'; this.nextSibling.style.display='block';" onload="this.nextSibling.style.display='none';"><span style="display:none;font-size:10px;color:#666;padding:2px;">No Photo</span>` : '<span style="font-size:10px;color:#666;">No Photo</span>'}</td>
           <td></td>
           <td>${simplify(r.status)}</td>`;
         tbody.appendChild(tr);
       });
     });
   });
   
   setStatus(`${allRows.length} rows`);
 }

 function applySearch(){
   const q = document.getElementById('searchBox').value.trim().toLowerCase();
   if(!q){ renderTable(); return; }
   const sectionCol = currentClassYear.replace('class_', 'section_');
   const rollCol = currentClassYear.replace('class_', 'roll_');
   const filtered = allRows.filter(r=>{
     return [r.iid,r.student_name_en,r.father_name_en,r.mother_name_en,r[rollCol],r[sectionCol],r[currentClassYear]]
       .map(v=>String(v||'').toLowerCase()).some(txt=>txt.includes(q));
   });
   const tbody=document.querySelector('#bookTable tbody'); tbody.innerHTML='';
   
   if(!filtered.length){ tbody.innerHTML='<tr><td colspan="11" style="text-align:center;padding:1rem;">No search results</td></tr>'; setStatus('No results'); return; }
   
   const year = currentClassYear.replace('class_', '');
   
   // Group filtered results by class first, then by section
   const classes = {};
   filtered.forEach(r => {
     const classValue = r[currentClassYear] || 'Unknown';
     const section = r[sectionCol] || 'Unknown';
     if(!classes[classValue]) classes[classValue] = {};
     if(!classes[classValue][section]) classes[classValue][section] = [];
     classes[classValue][section].push(r);
   });
   
   let overallIndex = 0; // Continuous serial number for filtered results
   
   // Render each class and its sections
   Object.keys(classes).sort((a,b)=>Number(a)-Number(b)).forEach(classValue => {
     const classSections = classes[classValue];
     
     Object.keys(classSections).sort().forEach(section => {
       const sectionRows = classSections[section];
       
       // Section header row for filtered results
       const groupTr = document.createElement('tr');
       groupTr.className = 'group-row';
       groupTr.innerHTML = `<td colspan="11" style="text-align:center;padding:0.8rem;font-weight:bold;">Class: ${classValue} || Section: ${section} || ${year} (Filtered)</td>`;
       tbody.appendChild(groupTr);
       
       // Section data rows with continuous serial
       sectionRows.forEach((r)=>{
         overallIndex++; // Increment for each filtered row
         const tr=document.createElement('tr');
         const admissionDateToShow = getAdmissionDate(r.admission_date, currentClassYear);
         const calculatedAge = calculateAge(r.student_dateofbirth, admissionDateToShow, currentClassYear);
         const isAutoDate = admissionDateToShow.includes('*');
         const dateClass = isAutoDate ? 'auto-date' : '';
         tr.innerHTML = `
           <td>${overallIndex}</td>
           <td><span class="${dateClass}">${simplify(admissionDateToShow)}</span><br><span class="small">${simplify(r.iid)}</span></td>
           <td><strong>${simplify(r.student_name_en)}</strong><br><span class="small">${simplify(r.father_name_en)}<br>${simplify(r.mother_name_en)}<br>${simplify(r.father_mobile)}</span></td>
           <td>${simplify(r[currentClassYear])}<br><span class="small">${simplify(r[sectionCol])}<br>${simplify(r[rollCol])}<br>${simplify(r.session)}</span></td>
           <td>${simplify(r.student_dateofbirth)}<br><span class="small">${simplify(r.student_gender)}<br>${simplify(r.religion)}<br>${simplify(r.birth_registration)}</span></td>
           <td>${[r.village_en,r.postoffice_en,r.upazilla_en,r.district_en].map(simplify).filter(Boolean).join('<br>')}</td>
           <td>${simplify(r.father_occupation)}<br><span class="small">${calculatedAge}<br>${simplify(r.previous_school)}</span></td>
           <td>${simplify(r.quote_freedomfighter)}</td>
           <td style="text-align:center;padding:0.2rem;">${r.student_photo_url && r.student_photo_url.trim() && r.student_photo_url !== 'null' ? `<img src="${r.student_photo_url.trim()}" style="width:40px;height:50px;object-fit:cover;border:1px solid #ddd;background:#f5f5f5;" alt="Photo" onerror="this.style.display='none'; this.nextSibling.style.display='block';" onload="this.nextSibling.style.display='none';"><span style="display:none;font-size:10px;color:#666;padding:2px;">No Photo</span>` : '<span style="font-size:10px;color:#666;">No Photo</span>'}</td>
           <td></td>
           <td>${simplify(r.status)}</td>`;
         tbody.appendChild(tr);
       });
     });
   });
   
   setStatus(`${filtered.length} (filtered)`);
 }

 document.getElementById('classYearSelect').addEventListener('change', async e=>{ currentClassYear=e.target.value; currentClass=''; currentSection=''; document.getElementById('classSelect').innerHTML='<option value="">Select Class</option>'; document.getElementById('sectionSelect').innerHTML='<option value="">Select Section</option>'; if(currentClassYear){ await loadClassOptions(); await loadRows(); } else { allRows=[]; renderTable(); } });
 document.getElementById('classSelect').addEventListener('change', async e=>{ currentClass=e.target.value; currentSection=''; document.getElementById('sectionSelect').innerHTML='<option value="">Select Section</option>'; if(currentClassYear && currentClass){ await loadSectionOptions(); await loadRows(); } else if(currentClassYear) { await loadRows(); } else { allRows=[]; renderTable(); } });
 document.getElementById('sectionSelect').addEventListener('change', async e=>{ currentSection=e.target.value; if(currentClassYear){ await loadRows(); } });
 
 // Add null checks for optional elements
 const searchBox = document.getElementById('searchBox');
 if(searchBox) searchBox.addEventListener('input', ()=>{ applySearch(); });
 
 const printBtn = document.getElementById('printBtn');
 if(printBtn) printBtn.addEventListener('click', ()=>{ 
   preparePrintLayout();
   setTimeout(() => window.print(), 100);
 });

 function preparePrintLayout() {
   // Remove any existing page break classes
   const allRows = document.querySelectorAll('#bookTable tbody tr');
   allRows.forEach(row => row.classList.remove('page-break-before', 'page-break-after'));
   
   // Natural page breaking - no forced breaks every 8 rows
   // Instead, let CSS handle natural breaks with minimum 8 rows preference
   const dataRows = document.querySelectorAll('#bookTable tbody tr:not(.group-row)');
   let currentPageRowCount = 0;
   let lastGroupRow = null;
   
   dataRows.forEach((row, index) => {
     currentPageRowCount++;
     
     // Find if there's a group row before this data row
     const prevElement = row.previousElementSibling;
     if (prevElement && prevElement.classList.contains('group-row')) {
       lastGroupRow = prevElement;
       currentPageRowCount = 1; // Reset count after group header
     }
     
     // Suggest page break after 10-12 rows for better distribution
     if (currentPageRowCount >= 10) {
       // Check if next few rows would be orphaned
       const remainingRows = dataRows.length - index - 1;
       if (remainingRows > 3) { // Don't break if only 1-3 rows left
         row.classList.add('page-break-after');
         currentPageRowCount = 0;
       }
     }
   });
   
   // Add print-specific styling
   const table = document.getElementById('bookTable');
   table.classList.add('print-optimized');
 }

 const pdfBtn = document.getElementById('pdfBtn');
 if(pdfBtn) pdfBtn.addEventListener('click', generatePDF);

 const pdfAdvancedBtn = document.getElementById('pdfAdvancedBtn');
 if(pdfAdvancedBtn) pdfAdvancedBtn.addEventListener('click', generateAdvancedPDF);

 window.addEventListener('DOMContentLoaded', async ()=>{ 
   const ok = !!window.supabase; 
   if(!ok){ console.error('Supabase lib missing'); return; } 
   initSupabase();
   
   // Make test function available globally
   window.testAgeCalculation = testAgeCalculation;
   window.calculateAge = calculateAge;
   window.getAdmissionDate = getAdmissionDate;
   
   console.log('Age calculation test functions loaded. Use testAgeCalculation() in console to test.');
 });
 </script>
</body>
</html>