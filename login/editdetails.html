<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Edit Details</title>
  <style>
  :root{--brand:#0b74de;--muted:#6c757d;--bg:#f6f8fa;--card:#ffffff}
  /* increase base font size by 25% */
  html{font-size:125%;}
  html,body{height:100%}
  body{font-family:'Kalpurush', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding:28px; background:linear-gradient(180deg,#f7fbff 0%,var(--bg) 100%); color:#222}
    .container{max-width:980px;margin:0 auto}
    .card{background:var(--card);border-radius:10px;padding:22px;box-shadow:0 6px 20px rgba(20,30,60,0.08);}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{font-size:20px;font-weight:600;color:#0b2140}
    .meta{color:#445; font-size:14px}
    .iid-badge{display:inline-block;margin-left:8px;padding:4px 8px;background:#eef6ff;color:var(--brand);border-radius:999px;font-weight:600}

  .form-grid{display:flex;flex-direction:column;gap:12px}
  /* photo area */
  .photo-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:12px}
  .photo-wrap img{width:140px;height:140px;object-fit:cover;border-radius:8px;border:4px solid #fff;box-shadow:0 12px 40px rgba(10,20,40,0.2);background:#fff}
  .student-name{margin-top:8px;font-weight:700;font-size:1.05rem;color:#111}
  /* increase left label column by ~30% (140px -> 182px) */
  .field-row{display:grid;grid-template-columns:182px 1.4fr;gap:10px;align-items:start;background:rgba(255,255,255,0.98);padding:10px;border-radius:10px;box-shadow:0 12px 36px rgba(0,0,0,0.08)}
  /* labels: white text on colored rounded pills (two-tone alternating) */
  .field-row label{font-size:14px;color:#000;align-self:center;padding:10px;border-radius:8px;font-weight:600}
  .form-grid .field-row:nth-child(odd) label{background:linear-gradient(90deg,#60a5fa 0%,#7dd3fc 100%)}
  .form-grid .field-row:nth-child(even) label{background:linear-gradient(90deg,#fda4af 0%,#fbcfe8 100%)}
  /* inputs: subtle tinted background matching the label tone */
  .field-row input, .field-row textarea{width:100%;padding:10px;border:1px solid #e4e7eb;border-radius:8px;font-size:14px;background:#fff;color:#000}
  .form-grid .field-row:nth-child(odd) input, .form-grid .field-row:nth-child(odd) textarea{background:linear-gradient(180deg,#fff,#f0fbff)}
  .form-grid .field-row:nth-child(even) input, .form-grid .field-row:nth-child(even) textarea{background:linear-gradient(180deg,#fff,#fff6f9)}
  .field-row textarea{min-height:92px;resize:vertical}
  /* no hover animation */
  .field-row:hover{box-shadow:0 18px 48px rgba(0,0,0,0.12)}
  /* stronger shadow (~20%) */
  .field-row input:focus, .field-row textarea:focus{outline:none;box-shadow:0 12px 40px rgba(11,116,222,0.18);border-color:rgba(11,116,222,0.45)}

    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px}
  .btn{padding:10px 14px;border:none;background:var(--brand);color:#fff;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{filter:none}
    .btn.secondary{background:var(--muted)}
    .notice{margin-top:12px;color:#a00;font-weight:600}
    .notice.success{color:green}

    @media (max-width:640px){
      .field-row{grid-template-columns:1fr}
      .header{flex-direction:column;align-items:flex-start;gap:8px}
      .actions{flex-direction:column-reverse}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Edit Record</div>
          <div class="meta">Modify fields below and click <strong>Update</strong></div>
        </div>
        <div id="info" class="meta"></div>
      </div>

  <div id="photoWrap" class="photo-wrap"></div>
  <div id="fields" class="form-grid"></div>

      <div class="actions">
        <button id="updateBtn" class="btn">Update</button>
      </div>
      <div id="notice" class="notice"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // same supabase creds as datalist_old.html
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const tableName = 'previous_data2025';

    const params = new URLSearchParams(window.location.search);
    const iid = params.get('iid');

    const fieldsEl = document.getElementById('fields');
    const infoEl = document.getElementById('info');
    const noticeEl = document.getElementById('notice');
    const updateBtn = document.getElementById('updateBtn');
    const backBtn = document.getElementById('backBtn');

    updateBtn.addEventListener('click', saveChanges);

    if(!iid){
      infoEl.innerHTML = '<span class="iid-badge">No IID</span>';
      updateBtn.disabled = true;
    } else {
      // safe display
      const span = document.createElement('span');
      span.className = 'iid-badge';
      span.textContent = iid;
      infoEl.appendChild(span);
      loadRecord(iid);
    }

    async function loadRecord(iid){
      noticeEl.textContent = 'Loading...';
      try{
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
          .eq('IID', Number(iid))
          .limit(1)
          .single();
        if(error) throw error;
  renderFields(data || {});
  // render photo and name
  try{ await renderPhotoForIID(iid, data); }catch(e){ console.warn('photo render failed', e); }
        noticeEl.textContent = '';
      }catch(err){
        console.error('loadRecord error', err);
        noticeEl.textContent = 'Failed to load record: ' + (err.message || err);
        updateBtn.disabled = true;
      }
    }

    async function renderPhotoForIID(iid, record){
      const wrap = document.getElementById('photoWrap');
      wrap.innerHTML = '';
      // fetch CSV of image links
      try{
        const resp = await fetch('../photo/link.csv');
        if(!resp.ok) throw new Error('photo list not loaded');
        const txt = await resp.text();
        const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(lines.length === 0) return;
        // pick an index from IID (safe numeric fallback)
        let idx = 0;
        const n = Number(iid);
        if(!Number.isNaN(n) && n > 0) idx = (n - 1) % lines.length;
        else idx = Math.abs(hashString(iid || '0')) % lines.length;
        const imgUrl = lines[idx];
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = 'photo';
        const nameEl = document.createElement('div');
        nameEl.className = 'student-name';
        nameEl.textContent = (record && record.Name) ? record.Name : '';
        wrap.appendChild(img);
        wrap.appendChild(nameEl);
      }catch(err){
        console.warn('renderPhotoForIID error', err);
      }
    }

    function hashString(s){
      let h = 0;
      for(let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h |= 0; }
      return Math.abs(h);
    }

    function renderFields(record){
      fieldsEl.innerHTML = '';
      const keys = Object.keys(record).sort();
      keys.forEach(key =>{
        const val = record[key] === null || record[key] === undefined ? '' : record[key];
        const row = document.createElement('div');
        row.className = 'field-row';
        const label = document.createElement('label');
        label.textContent = key + ':';
        let input;
        if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note')){
          input = document.createElement('textarea');
          input.rows = 4;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }
        input.value = val;
        input.setAttribute('data-field', key);
        if(key === 'IID') input.readOnly = true;
        row.appendChild(label);
        row.appendChild(input);
        fieldsEl.appendChild(row);
      });
    }

    async function saveChanges(){
      noticeEl.textContent = '';
      const inputs = fieldsEl.querySelectorAll('[data-field]');
      const payload = {};
      inputs.forEach(inp =>{
        const field = inp.getAttribute('data-field');
        if(field === 'IID') return;
        const v = inp.value === '' ? null : inp.value;
        payload[field] = v;
      });
      updateBtn.disabled = true;
      updateBtn.textContent = 'Updating...';
      try{
        const { data, error } = await supabase
          .from(tableName)
          .update(payload)
          .eq('IID', Number(iid));
        if(error) throw error;
  noticeEl.classList.remove('');
  noticeEl.classList.add('success');
  noticeEl.textContent = 'Updated successfully.';
      }catch(err){
        console.error('update error', err);
  noticeEl.classList.remove('success');
  noticeEl.textContent = 'Update failed: ' + (err.message || err);
      }finally{
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update';
      }
    }
  </script>
</body>
</html>
