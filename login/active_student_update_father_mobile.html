<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Active Student Update (Session-wise)</title>
  <style>
    :root { --bg:#f6f8fa; --card:#ffffff; --border:#d0d7de; --accent:#0366d6; --accent-hover:#024c9e; --danger:#d73a49; --radius:6px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    body { margin:0; background:var(--bg); color:#24292f; }
    header { background:#0d1117; color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    h1 { font-size:20px; margin:0; font-weight:600; }
    .btn-logout { background:#ff8a00; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; font-size:13px; border:1px solid #ff8a00; }
    .btn-logout:hover { background:#e07000; border-color:#e07000; }
    /* Full-width container so table fits left-right */
    .container { width:100%; max-width:100%; margin:0 0 60px 0; background:var(--card); border:1px solid var(--border); border-radius:0; padding:18px 12px 28px; box-shadow:0 2px 4px rgba(0,0,0,.04); }
    /* Ensure table can scroll horizontally on very small screens */
    .table-wrap { overflow-x:auto; }
    .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:14px; }
    .toolbar select, .toolbar input[type=text]{ padding:8px 10px; border:1px solid var(--border); border-radius:4px; font-size:14px; background:#fff; }
    .toolbar button{ height:34px; }
    .status { font-size:13px; min-height:18px; }
    .status.ok { color:#1a7f37; }
    .status.err { color:var(--danger); }
    table { width:100%; border-collapse:collapse; font-size:13.5px; }
    thead { background:#fafbfc; position:sticky; top:0; z-index:5; }
    th, td { border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:middle; }
    th { font-weight:600; font-size:12.5px; letter-spacing:.5px; background:#f0f3f6; }
    tbody tr:nth-child(even){ background:#fcfcfd; }
    tbody tr:hover { background:#fffbe6; }
    .col-sl { width:52px; text-align:center; }
    .actions-col { white-space:nowrap; }
    button { cursor:pointer; font-size:12px; line-height:1.2; padding:6px 10px; border-radius:4px; border:1px solid var(--accent); background:var(--accent); color:#fff; font-weight:500; }
    button:hover { background:var(--accent-hover); }
    button.outline { background:#fff; color:var(--accent); }
    button.outline:hover { background:#e7f3ff; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .muted { color:#6a737d; font-size:12px; }
    /* Space between action buttons */
    .action-cell button + button { margin-left:8px; }
    .action-cell .btn { padding:6px 8px; }
    /* Make Update button orange when needed, blue when up-to-date */
    .btn.update-needed { background:#ff8a00; border-color:#ff8a00; }
    .btn.update-needed:hover { background:#e07000; }
    .btn.up-to-date { background:#10b981; border-color:#10b981; }
    .btn.up-to-date:hover { background:#0f9f74; }
    /* Inline status messages */
    .update-status { font-size:11px; margin-left:8px; font-weight:600; }
    .update-status.success { color:#1a7f37; }
    .update-status.error { color:var(--danger); }
    .update-status.loading { color:#6a737d; }
    @media (max-width:820px){
      .container { padding:14px 14px 24px; }
      .toolbar { gap:8px; }
      th,td{padding:5px 6px;font-size:12.5px;}
      button{padding:5px 8px;}
    }
  </style>
</head>

<body>
  <header>
    <h1>Active Student Update (Session-wise)</h1>
    <button id="logoutBtn" class="btn-logout">Logout</button>
  </header>

  <div class="container">
    <div class="toolbar">
      <div class="filters left" style="align-items:center">
        <label for="sessionFilter" class="filter-label">Session</label>
        <select id="sessionFilter" class="filter-select">
          <option value="">Select Session</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
        <label for="classFilter" class="filter-label">Class</label>
        <select id="classFilter" class="filter-select">
          <option value="">All Classes</option>
        </select>
        <label for="sectionFilter" class="filter-label">Section</label>
        <select id="sectionFilter" class="filter-select">
          <option value="">All Sections</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;align-items:center;margin-left:auto">
        <button id="refreshBtn">Refresh</button>
        <button id="updateAllBtn" class="update-needed">Update All Needed</button>
        <button id="downloadCsvBtn" class="outline">Download CSV</button>
        <span id="status" class="status"></span>
      </div>
    </div>

    <div class="table-wrap">
      <table id="dataTable">
        <thead id="tableHeader">
          <tr>
            <th class="col-sl">SL</th>
            <th>IID</th>
            <th>Name</th>
            <th>Father Mobile</th>
            <th>Mother Mobile</th>
            <th>Updated Father Mobile</th>
            <th>Updated Mother Mobile</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8" class="muted">Select a session to view data</td></tr>
        </tbody>
      </table>
    </div>
    <div id="rowCount" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Auth check -->
  <script src="./auth-check.js"></script>

  <script>
    // Use the same project URL/key used elsewhere in this repo
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    // Reuse existing Supabase client or create new one
    if (!window.supabaseClient) {
      window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    }
    const supabase = window.supabaseClient;

    const tableName = 'student_database';

    // Elements
    const tbody = document.querySelector('#dataTable tbody');
    const statusEl = document.getElementById('status');
    const sessionFilter = document.getElementById('sessionFilter');
    const classFilter = document.getElementById('classFilter');
    const sectionFilter = document.getElementById('sectionFilter');
    const tableHeader = document.getElementById('tableHeader');
    const rowCountEl = document.getElementById('rowCount');

    // Global data cache
    let allRowsCache = [];
    let filteredSessionData = [];
    let currentSession = '';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      loadData();
    });

    function setupEventListeners() {
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('sessionFilter').addEventListener('change', function() {
        currentSession = this.value;
        if (currentSession) {
          updateTableHeader(currentSession);
          filterDataBySession();
          populateFilters();
        } else {
          clearTable();
        }
      });
      document.getElementById('classFilter').addEventListener('change', filterAndRenderData);
      document.getElementById('sectionFilter').addEventListener('change', filterAndRenderData);
      document.getElementById('updateAllBtn').addEventListener('click', updateAllNeeded);
      document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
      document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    async function logout() {
      try {
        await supabase.auth.signOut();
      } catch (e) {
        console.error('Logout error:', e);
      }
      window.location.href = './index.html';
    }

    async function loadData() {
      try {
        showStatus('Loading data...', 'loading');
        tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';

        console.log('Loading data from table:', tableName);

        const { data, error } = await supabase
          .from(tableName)
          .select('*');

        if (error) {
          console.error('Supabase error:', error);
          throw new Error('Database query failed: ' + error.message);
        }

        if (!data || data.length === 0) {
          showStatus('No data found', 'error');
          tbody.innerHTML = '<tr><td colspan="8" class="muted">No data available.</td></tr>';
          return;
        }

        console.log('Data loaded successfully:', data.length, 'rows');
        allRowsCache = data;
        
        // Don't show data initially - wait for session selection
        clearTable();
        showStatus('Data loaded. Select a session to view students.', 'ok');

      } catch (error) {
        console.error('Load data error:', error);
        showStatus('Failed to load data: ' + error.message, 'error');
        tbody.innerHTML = '<tr><td colspan="8" class="muted">Failed to load data.</td></tr>';
      }
    }

    function clearTable() {
      tbody.innerHTML = '<tr><td colspan="12" class="muted">Select a session to view data</td></tr>';
      rowCountEl.textContent = '';
      classFilter.innerHTML = '<option value="">All Classes</option>';
      sectionFilter.innerHTML = '<option value="">All Sections</option>';
    }

    function filterDataBySession() {
      if (!currentSession) {
        filteredSessionData = [];
        clearTable();
        return;
      }

      const sessionClassCol = `class_${currentSession}`;
      const sessionSectionCol = `section_${currentSession}`;
      const sessionRollCol = `roll_${currentSession}`;

      // Filter data for current session - students who have data in session-specific columns
      filteredSessionData = allRowsCache.filter(row => {
        const hasClass = row[sessionClassCol] != null && row[sessionClassCol] !== '';
        const hasSection = row[sessionSectionCol] != null && row[sessionSectionCol] !== '';
        const hasRoll = row[sessionRollCol] != null && row[sessionRollCol] !== '';
        return hasClass || hasSection || hasRoll;
      });

      console.log(`Filtered data for session ${currentSession}:`, filteredSessionData.length, 'rows');

      if (filteredSessionData.length === 0) {
        showStatus(`No students found for session ${currentSession}`, 'error');
        tbody.innerHTML = `<tr><td colspan="8" class="muted">No students for session ${currentSession}.</td></tr>`;
        rowCountEl.textContent = '';
        return;
      }

      // Sort by class, section, roll for selected session
      filteredSessionData.sort((a, b) => {
        const aClass = String(a[sessionClassCol] || '');
        const bClass = String(b[sessionClassCol] || '');
        if (aClass !== bClass) {
          return aClass.localeCompare(bClass, undefined, { numeric: true });
        }

        const aSection = String(a[sessionSectionCol] || '');
        const bSection = String(b[sessionSectionCol] || '');
        if (aSection !== bSection) {
          return aSection.localeCompare(bSection, undefined, { numeric: true });
        }

        const aRoll = parseInt(a[sessionRollCol]) || 0;
        const bRoll = parseInt(b[sessionRollCol]) || 0;
        return aRoll - bRoll;
      });

      filterAndRenderData();
    }

    function populateFilters() {
      console.log('populateFilters called');
      console.log('currentSession:', currentSession);
      console.log('filteredSessionData length:', filteredSessionData.length);
      
      if (!currentSession || filteredSessionData.length === 0) return;

      const sessionClassCol = `class_${currentSession}`;
      const sessionSectionCol = `section_${currentSession}`;
      
      console.log('Session columns:', sessionClassCol, sessionSectionCol);

      // Get unique classes and sections
      const classes = [...new Set(filteredSessionData.map(row => row[sessionClassCol]).filter(Boolean))].sort((a, b) => {
        // Sort classes numerically if they are numbers, otherwise alphabetically
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return aNum - bNum;
        }
        return String(a).localeCompare(String(b));
      });
      const sections = [...new Set(filteredSessionData.map(row => row[sessionSectionCol]).filter(Boolean))].sort();
      
      console.log('Unique classes:', classes);
      console.log('Unique sections:', sections);
      console.log('Sample data for debugging:', filteredSessionData.slice(0, 3).map(row => ({
        iid: row.iid,
        [sessionClassCol]: row[sessionClassCol],
        [sessionSectionCol]: row[sessionSectionCol],
        classType: typeof row[sessionClassCol],
        sectionType: typeof row[sessionSectionCol]
      })));

      // Populate class filter
      classFilter.innerHTML = '<option value="">All Classes</option>';
      classes.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        classFilter.appendChild(option);
      });

      // Populate section filter
      sectionFilter.innerHTML = '<option value="">All Sections</option>';
      sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        sectionFilter.appendChild(option);
      });
      
      console.log('Filters populated successfully');
    }

    function updateTableHeader(session) {
      tableHeader.innerHTML = `
        <tr>
          <th class="col-sl">SL</th>
          <th>IID</th>
          <th>Name</th>
          <th>Father Mobile</th>
          <th>Mother Mobile</th>
          <th>Updated Father Mobile</th>
          <th>Updated Mother Mobile</th>
          <th>Action</th>
        </tr>
      `;
    }

    function filterAndRenderData() {
      console.log('filterAndRenderData called');
      console.log('currentSession:', currentSession);
      console.log('filteredSessionData length:', filteredSessionData.length);
      
      if (!currentSession || filteredSessionData.length === 0) {
        console.log('No session or no data, clearing table');
        clearTable();
        return;
      }

      const sessionClassCol = `class_${currentSession}`;
      const sessionSectionCol = `section_${currentSession}`;

      const selectedClass = classFilter.value;
      const selectedSection = sectionFilter.value;
      
      console.log('Selected filters - Class:', selectedClass, 'Section:', selectedSection);

      // Apply class and section filters
      let displayData = filteredSessionData;
      
      if (selectedClass) {
        displayData = displayData.filter(row => {
          // Convert both values to string for comparison to handle type mismatch
          return String(row[sessionClassCol]) === String(selectedClass);
        });
        console.log('After class filter:', displayData.length, 'rows');
        console.log('Filtered by class:', selectedClass, 'sessionClassCol:', sessionClassCol);
      }
      
      if (selectedSection) {
        displayData = displayData.filter(row => {
          // Convert both values to string for comparison
          return String(row[sessionSectionCol]) === String(selectedSection);
        });
        console.log('After section filter:', displayData.length, 'rows');
      }

      console.log('Final displayData length:', displayData.length);

      if (displayData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="muted">No students match the selected filters.</td></tr>';
        rowCountEl.textContent = '';
        return;
      }

      renderTable(displayData, currentSession);
    }

    function renderTable(data, session) {
      const sessionClassCol = `class_${session}`;
      const sessionSectionCol = `section_${session}`;
      const sessionRollCol = `roll_${session}`;

      let needsUpdateCount = 0;
      
      const rows = data.map((row, index) => {
        const sessionClass = row[sessionClassCol];
        const sessionSection = row[sessionSectionCol];
        const sessionRoll = row[sessionRollCol];
        
        // Show session-specific values as "target" active values
        const targetActiveClass = sessionClass;
        const targetActiveSection = sessionSection;
        const targetActiveRoll = sessionRoll;
        
        // Current active values from database
        const currentActiveClass = row.active_class;
        const currentActiveSection = row.active_section;
        const currentActiveRoll = row.active_roll;
        
        // Generate student key from father mobile last 6 digits
        const fatherMobile = String(row.father_mobile_en || row.father_mobile || '').replace(/\D/g, ''); // Remove non-digits
        const generatedStudentKey = fatherMobile.length >= 6 ? fatherMobile.slice(-6) : '';
        const currentStudentKey = row.student_key || '';

        // Process father mobile number - add 880 prefix if not present
        const originalFatherMobile = String(row.father_mobile_en || row.father_mobile || '');
        const cleanFatherMobile = originalFatherMobile.replace(/\D/g, ''); // Remove non-digits
        let updatedFatherMobile = cleanFatherMobile;
        
        if (cleanFatherMobile && !cleanFatherMobile.startsWith('880')) {
          updatedFatherMobile = '880' + cleanFatherMobile;
        }
        
        // Check if father mobile needs update
        const fatherMobileNeedsUpdate = cleanFatherMobile && !cleanFatherMobile.startsWith('880');

        // Process mother mobile number - add 880 prefix if not present
        const originalMotherMobile = String(row.mother_mobile_en || row.mother_mobile || '');
        const cleanMotherMobile = originalMotherMobile.replace(/\D/g, ''); // Remove non-digits
        let updatedMotherMobile = cleanMotherMobile;
        
        if (cleanMotherMobile && !cleanMotherMobile.startsWith('880')) {
          updatedMotherMobile = '880' + cleanMotherMobile;
        }
        
        // Check if mother mobile needs update
        const motherMobileNeedsUpdate = cleanMotherMobile && !cleanMotherMobile.startsWith('880');

        // Check if update is needed (compare current active with target session values + student key + mobile updates)
        const needsUpdate = (targetActiveClass !== currentActiveClass) || 
                           (targetActiveSection !== currentActiveSection) || 
                           (targetActiveRoll !== currentActiveRoll) ||
                           (generatedStudentKey !== currentStudentKey) ||
                           fatherMobileNeedsUpdate ||
                           motherMobileNeedsUpdate;

        if (needsUpdate) needsUpdateCount++;

        const buttonClass = needsUpdate ? 'update-needed' : 'up-to-date';
        const buttonText = needsUpdate ? 'Update Data' : 'Up-to-date';
        const isDisabled = !targetActiveClass && !targetActiveSection && !targetActiveRoll && !fatherMobileNeedsUpdate && !motherMobileNeedsUpdate;

        return `
          <tr data-iid="${escapeHtml(row.iid || '')}">
            <td class="col-sl">${index + 1}</td>
            <td>${escapeHtml(row.iid || '')}</td>
            <td>${escapeHtml(row.student_name_en || '')}</td>
            <td>${escapeHtml(originalFatherMobile)}</td>
            <td>${escapeHtml(originalMotherMobile)}</td>
            <td style="font-weight: ${fatherMobileNeedsUpdate ? 'bold' : 'normal'}; color: ${fatherMobileNeedsUpdate ? '#ff8a00' : '#10b981'};">${escapeHtml(updatedFatherMobile)}</td>
            <td style="font-weight: ${motherMobileNeedsUpdate ? 'bold' : 'normal'}; color: ${motherMobileNeedsUpdate ? '#ff8a00' : '#10b981'};">${escapeHtml(updatedMotherMobile)}</td>
            <td class="action-cell">
              <button 
                class="btn ${buttonClass}" 
                onclick="updateStudent('${escapeHtml(row.iid || '')}', '${escapeHtml(targetActiveClass || '')}', '${escapeHtml(targetActiveSection || '')}', '${escapeHtml(targetActiveRoll || '')}', '${generatedStudentKey}', '${escapeHtml(updatedFatherMobile)}', '${escapeHtml(updatedMotherMobile)}')"
                ${isDisabled ? 'disabled' : ''}
              >
                ${buttonText}
              </button>
              <span class="update-status" id="status-${escapeHtml(row.iid || '')}"></span>
            </td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
      
      const totalStudents = data.length;
      showStatus(`Showing ${totalStudents} students · ${needsUpdateCount} need update`, 'ok');
      rowCountEl.textContent = `Total: ${totalStudents} students (${needsUpdateCount} need update)`;
    }

    async function updateStudent(iid, sessionClass, sessionSection, sessionRoll, studentKey, updatedFatherMobile, updatedMotherMobile) {
      const statusEl = document.getElementById(`status-${iid}`);
      const button = event.target;
      
      try {
        statusEl.textContent = 'Updating...';
        statusEl.className = 'update-status loading';
        button.disabled = true;

        const updates = {
          active_class: sessionClass || null,
          active_section: sessionSection || null,
          active_roll: sessionRoll || null,
          student_key: studentKey || null,
          father_mobile: updatedFatherMobile || null,
          mother_mobile: updatedMotherMobile || null
        };

        const { error } = await supabase
          .from(tableName)
          .update(updates)
          .eq('iid', iid);

        if (error) {
          throw new Error(error.message);
        }

        // Update success
        statusEl.textContent = 'Updated ✓';
        statusEl.className = 'update-status success';
        button.className = 'btn up-to-date';
        button.textContent = 'Up-to-date';
        
        // Update local cache
        const rowData = allRowsCache.find(row => row.iid === iid);
        if (rowData) {
          rowData.active_class = updates.active_class;
          rowData.active_section = updates.active_section;
          rowData.active_roll = updates.active_roll;
          rowData.student_key = updates.student_key;
          rowData.father_mobile = updates.father_mobile;
          rowData.father_mobile_en = updates.father_mobile;
          rowData.mother_mobile = updates.mother_mobile;
          rowData.mother_mobile_en = updates.mother_mobile;
        }

        // Clear status message after 3 seconds
        setTimeout(() => {
          statusEl.textContent = '';
        }, 3000);

      } catch (error) {
        console.error('Update error:', error);
        statusEl.textContent = 'Failed ✗';
        statusEl.className = 'update-status error';
        button.disabled = false;
      }
    }

    async function updateAllNeeded() {
      const updateButtons = tbody.querySelectorAll('.btn.update-needed:not(:disabled)');
      
      if (updateButtons.length === 0) {
        showStatus('No updates needed.', 'ok');
        return;
      }

      showStatus(`Updating ${updateButtons.length} students...`, 'loading');
      
      let successCount = 0;
      for (const button of updateButtons) {
        try {
          button.click();
          await new Promise(resolve => setTimeout(resolve, 200)); // Small delay
          successCount++;
        } catch (error) {
          console.error('Bulk update error:', error);
        }
      }

      setTimeout(() => {
        showStatus(`Bulk update completed. ${successCount} students updated.`, 'ok');
      }, 2000);
    }

    async function downloadCSV() {
      try {
        if (!currentSession || filteredSessionData.length === 0) {
          showStatus('No data to download. Please select a session first.', 'error');
          return;
        }

        const selectedClass = classFilter.value;
        const selectedSection = sectionFilter.value;

        // Apply current filters to data
        let exportData = filteredSessionData;
        
        if (selectedClass) {
          const sessionClassCol = `class_${currentSession}`;
          exportData = exportData.filter(row => String(row[sessionClassCol]) === String(selectedClass));
        }
        
        if (selectedSection) {
          const sessionSectionCol = `section_${currentSession}`;
          exportData = exportData.filter(row => String(row[sessionSectionCol]) === String(selectedSection));
        }

        if (exportData.length === 0) {
          showStatus('No data to download with current filters.', 'error');
          return;
        }

        // Custom headers for specific columns only
        const headers = [
          'iid', 'active_class', 'active_section', 'active_roll', 'session', 'student_name_en', 'student_key'
        ];

        const csvContent = [
          headers.join(','),
          ...exportData.map((row) => {
            const fatherMobile = String(row.father_mobile_en || row.father_mobile || '').replace(/\D/g, ''); // Remove non-digits
            const studentKey = fatherMobile.length >= 6 ? fatherMobile.slice(-6) : '';
            
            return [
              row.iid || '',
              row.active_class || '',
              row.active_section || '',
              row.active_roll || '',
              row.session || '',
              row.student_name_en || '',
              studentKey
            ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
          })
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `active_students_${currentSession}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showStatus('CSV downloaded successfully.', 'ok');

      } catch (error) {
        console.error('CSV download error:', error);
        showStatus('Failed to download CSV: ' + error.message, 'error');
      }
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showStatus(message, type = 'ok') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
  </script>
</body>
</html>