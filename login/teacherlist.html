<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher List</title>
  <link rel="icon" type="image/png" href="../pad.png" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg:#f6f8fa; --card:#ffffff; --border:#d0d7de; --accent:#0366d6; --accent-hover:#024c9e; --danger:#d73a49; --radius:6px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    body { margin:0; background:var(--bg); color:#24292f; }
    header { background:#0d1117; color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    h1 { font-size:20px; margin:0; font-weight:600; }
    .container { max-width:1500px; margin:18px auto 60px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px 20px 28px; box-shadow:0 2px 4px rgba(0,0,0,.04); }
    .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:14px; }
    .toolbar input[type=text]{ flex:1 1 320px; padding:8px 10px; border:1px solid var(--border); border-radius:4px; font-size:14px; }
    .status { font-size:13px; min-height:18px; }
    .status.ok { color:#1a7f37; }
    .status.err { color:var(--danger); }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    thead { background:#fafbfc; position:sticky; top:0; z-index:5; }
    th, td { border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:middle; }
    th { font-weight:600; font-size:13px; letter-spacing:.5px; background:#f0f3f6; }
    tbody tr:nth-child(even){ background:#fcfcfd; }
    tbody tr:hover { background:#fffbe6; }
    .sl-col { width:52px; text-align:center; }
    .iid-col { width:90px; font-weight:600; font-family:monospace; }
    .photo-col { width:70px; }
    .photo-col img { width:48px; height:48px; object-fit:cover; border-radius:4px; border:1px solid var(--border); background:#fff; }
    .actions-col { width:70px; text-align:center; }
    button { cursor:pointer; font-size:12px; line-height:1.2; padding:6px 10px; border-radius:4px; border:1px solid var(--accent); background:var(--accent); color:#fff; font-weight:500; }
    button:hover { background:var(--accent-hover); }
    button.outline { background:#fff; color:var(--accent); }
    button.outline:hover { background:#e7f3ff; }
    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:flex-start; justify-content:center; overflow:auto; padding:60px 20px 40px; z-index:100; }
    .modal { background:#fff; width:680px; max-width:100%; border-radius:var(--radius); border:1px solid var(--border); box-shadow:0 4px 18px rgba(0,0,0,.18); animation:pop .25s ease; }
    @keyframes pop { from { transform:translateY(10px); opacity:0;} to { transform:translateY(0); opacity:1; } }
    .modal header { background:#f6f8fa; color:#24292f; padding:14px 18px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal h2 { font-size:17px; margin:0; }
    .modal .close-btn { background:transparent; border:none; color:#57606a; font-size:20px; padding:4px 6px; line-height:1; }
    .modal .close-btn:hover { color:#000; }
    form.edit-form { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:14px 16px; padding:18px; }
    form.edit-form label { font-size:12px; text-transform:uppercase; letter-spacing:.5px; font-weight:600; color:#57606a; display:block; margin-bottom:3px; }
    form.edit-form input { width:100%; padding:7px 8px; font-size:13px; border:1px solid var(--border); border-radius:4px; }
    form.edit-form input:focus { outline:2px solid #84c5ff; outline-offset:0; }
    .modal footer { display:flex; gap:10px; justify-content:flex-end; padding:12px 18px 18px; border-top:1px solid var(--border); }
    .empty { text-align:center; padding:40px 10px; font-size:15px; color:#57606a; }
    .loading { padding:14px 0; font-size:14px; }
    .badge { display:inline-block; padding:2px 6px; border:1px solid var(--border); border-radius:12px; font-size:11px; background:#f6f8fa; }
    .pill { background:#e7f3ff; border-color:#c2e0ff; color:#024c9e; }
    .nowrap { white-space:nowrap; }
    .muted { color:#6a737d; font-size:12px; }
    .flex { display:flex; align-items:center; gap:6px; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body>
  <header>
    <h1>Teacher List</h1>
    <div style="font-size:13px; opacity:.85;">Supabase powered</div>
  </header>
  <div class="container">
    <div class="toolbar">
      <button type="button" id="addTeacherBtn" style="background:#1f883d; border-color:#1f883d;">ADD TEACHER</button>
      <input id="searchBox" type="text" placeholder="Search name / sector / designation / phone / email / NID" autocomplete="off" />
      <div class="status" id="globalStatus"></div>
    </div>
    <div class="table-wrap">
      <table id="teacherTable">
        <thead>
          <tr>
            <th class="sl-col">SL</th>
            <th class="iid-col">IID</th>
            <th class="photo-col">Photo</th>
            <th>Name (EN)</th>
            <th>Sector</th>
            <th>Designation</th>
            <th>Phone</th>
            <th>Email</th>
            <th>NID</th>
            <th>Join Date</th>
            <th class="actions-col">Action</th>
          </tr>
        </thead>
        <tbody id="teacherTbody">
          <tr><td colspan="11" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div id="rowCount" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Modal (Add Teacher Only) -->
  <div class="modal-backdrop" id="editModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <header>
        <h2 id="editTitle">Edit Teacher</h2>
        <button class="close-btn" type="button" id="closeModal" aria-label="Close">×</button>
      </header>
      <form id="editForm" class="edit-form" autocomplete="off"></form>
      <footer>
        <div class="flex" style="margin-right:auto;">
          <span id="modalStatus" class="status"></span>
        </div>
        <button type="button" id="saveBtn">Save</button>
        <button type="button" class="outline" id="cancelBtn">Cancel</button>
      </footer>
    </div>
  </div>

  <script>
    // ---------- Config ----------
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const TABLE = 'teacher_database';

    // ---------- State ----------
    let allRows = []; // full dataset
    let filtered = []; // after search
  let currentEdit = null; // row object being edited
  let addMode = false; // when true, modal is for adding

    // ---------- Elements ----------
    const tbody = document.getElementById('teacherTbody');
    const searchBox = document.getElementById('searchBox');
    const globalStatus = document.getElementById('globalStatus');
    const rowCountEl = document.getElementById('rowCount');
    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const modalStatus = document.getElementById('modalStatus');
  const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const closeModalBtn = document.getElementById('closeModal');
  const addTeacherBtn = document.getElementById('addTeacherBtn');

    function setStatus(el, msg, type='') {
      if(!el) return; el.textContent = msg||''; el.className='status'+(type?(' '+type):'');
    }

    // ---------- Fetch & Render ----------
    async function loadTeachers() {
      setStatus(globalStatus, 'Loading teachers...');
      const { data, error } = await supabase
        .from(TABLE)
        .select('iid, teacher_name_en, sector, designation_en, mobile_number_en, email_id, nid_number_en, join_date, pp_photo')
        .order('iid', { ascending: true });
      if(error){ setStatus(globalStatus, 'Error: '+error.message, 'err'); return; }
      allRows = data || [];
      filtered = allRows.slice();
      renderTable();
      setStatus(globalStatus, 'Loaded '+allRows.length+' teachers', 'ok');
    }

    function renderTable() {
      if(!filtered.length){ tbody.innerHTML = '<tr><td colspan="11" class="empty">No matching teachers</td></tr>'; rowCountEl.textContent='0 rows'; return; }
      const rowsHtml = filtered.map((r, idx) => {
        const safe = (v)=> (v==null||v==='')?'<span class="muted">—</span>':escapeHtml(v);
        const photo = r.pp_photo ? '<img src="'+escapeAttr(r.pp_photo)+'" alt="photo" />' : '<span class="muted">No Photo</span>';
        return `<tr data-iid="${r.iid}">
          <td class="sl-col">${idx+1}</td>
          <td class="iid-col">${r.iid}</td>
          <td class="photo-col">${photo}</td>
          <td>${safe(r.teacher_name_en)}</td>
          <td>${safe(r.sector)}</td>
            <td>${safe(r.designation_en)}</td>
          <td>${safe(r.mobile_number_en)}</td>
          <td>${safe(r.email_id)}</td>
          <td>${safe(r.nid_number_en)}</td>
          <td class="nowrap">${safe(r.join_date)}</td>
          <td class="actions-col"><button type="button" data-link-edit="${r.iid}">Edit</button></td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rowsHtml;
      rowCountEl.textContent = filtered.length + ' row'+(filtered.length!==1?'s':'');
    }

    // ---------- Search ----------
    function applySearch() {
      const q = searchBox.value.trim().toLowerCase();
      if(!q){ filtered = allRows.slice(); return renderTable(); }
      filtered = allRows.filter(r => [
          r.teacher_name_en,
          r.sector,
          r.designation_en,
          r.mobile_number_en,
          r.email_id,
          r.nid_number_en
        ].some(v => (v||'').toLowerCase().includes(q))
      );
      renderTable();
    }
    let searchTimer; 
    searchBox.addEventListener('input', () => { clearTimeout(searchTimer); searchTimer = setTimeout(applySearch, 250); });

    // ---------- Modal Helpers ----------
  // (Legacy) openModal kept for potential future inline editing; not used for edit now.
  async function openModal(rowMeta){
      // Fetch full row fresh to ensure latest data (including columns not listed in table)
      setStatus(globalStatus, 'Loading full record for IID '+rowMeta.iid+' ...');
      const { data, error } = await supabase
        .from(TABLE)
        .select('*')
        .eq('iid', rowMeta.iid)
        .single();
      if(error){ setStatus(globalStatus,'Load failed: '+error.message,'err'); return; }
      currentEdit = data;
      buildDynamicForm(data);
      modal.style.display='flex';
      modal.setAttribute('aria-hidden','false');
      setStatus(modalStatus, '');
      const first = editForm.querySelector('input:not([type=hidden])');
      if(first) first.focus();
    }

    function openAddModal(){
      addMode = true;
      currentEdit = null;
      // Minimal fields for adding new teacher
      const newRowTemplate = {
        teacher_name_en: '',
        sector: '',
        designation_en: '',
        mobile_number_en: '',
        email_id: '',
        nid_number_en: '',
        join_date: '',
        pp_photo: ''
      };
      buildAddForm(newRowTemplate);
      modal.style.display='flex';
      modal.setAttribute('aria-hidden','false');
      setStatus(modalStatus, '');
      const first = editForm.querySelector('input');
      if(first) first.focus();
      document.getElementById('editTitle').textContent='Add Teacher';
      saveBtn.textContent='Create';
    }
    function closeModal(){
      modal.style.display='none';
      modal.setAttribute('aria-hidden','true');
      currentEdit = null;
  addMode = false;
  document.getElementById('editTitle').textContent='Edit Teacher'; // will be replaced to Add Teacher only when addMode
  saveBtn.textContent='Save';
    }
    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.getAttribute('aria-hidden')==='false') closeModal(); });

    // Build dynamic form with all columns
    const FIELD_LABELS = {
      iid:'IID',
      teacher_name_en:'Teacher Name (EN)',
      teacher_name_bn:'Teacher Name (BN)',
      designation_en:'Designation (EN)',
      designation_bn:'Designation (BN)',
      sector:'Sector',
      index_number:'Index Number',
      pds_number:'PDS Number',
      pay_code:'Pay Code',
      basic:'Basic',
      bank_account_number:'Bank A/C 1',
      bank_account_number2:'Bank A/C 2',
      subject_en:'Subject (EN)',
      subject_bn:'Subject (BN)',
      father_name_en:'Father Name (EN)',
      father_name_bn:'Father Name (BN)',
      mother_name_en:'Mother Name (EN)',
      mother_name_bn:'Mother Name (BN)',
      date_of_birth_en:'DOB (EN)',
      date_of_birth_bn:'DOB (BN)',
      nid_number_en:'NID (EN)',
      nid_number_bn:'NID (BN)',
      birth_certificate_number:'Birth Certificate No',
      religion_en:'Religion (EN)',
      religion_bn:'Religion (BN)',
      gender_en:'Gender (EN)',
      gender_bn:'Gender (BN)',
      mobile_number_en:'Mobile (EN)',
      mobile_number_bn:'Mobile (BN)',
      email_id:'Email',
      this_school_join_date:'This School Join Date',
      join_date:'Join Date',
      "1st_mpo":'1st MPO',
      village_en:'Village (EN)',
      village_bn:'Village (BN)',
      post_office_en:'Post Office (EN)',
      post_office_bn:'Post Office (BN)',
      upazilla_en:'Upazilla (EN)',
      upazilla_bn:'Upazilla (BN)',
      district_en:'District (EN)',
      district_bn:'District (BN)',
      home_district:'Home District',
      nid_photo:'NID Photo URL',
      pp_photo:'Profile Photo URL',
      created_at:'Created At'
    };

    const READ_ONLY_FIELDS = new Set(['iid','created_at']);

    function buildDynamicForm(row){
      editForm.innerHTML='';
      Object.entries(row).forEach(([key,val])=>{
        // Skip internal or null columns? Keep all for transparency
        const labelTxt = FIELD_LABELS[key] || key;
        const id = 'field_'+key;
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        label.setAttribute('for', id);
        label.textContent = labelTxt;
        let input = document.createElement('input');
        input.id = id;
        input.name = key;
        input.value = val==null?'' : val;
        if(READ_ONLY_FIELDS.has(key)){
          input.readOnly = true;
          input.style.background = '#f3f4f6';
        }
        // date hint
        if(/date/i.test(key) && !READ_ONLY_FIELDS.has(key)) input.placeholder='YYYY-MM-DD';
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        editForm.appendChild(wrapper);
      });
    }

    function buildAddForm(row){
      editForm.innerHTML='';
      Object.entries(row).forEach(([key,val])=>{
        const labelTxt = FIELD_LABELS[key] || key;
        const id = 'field_'+key;
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        label.setAttribute('for', id);
        label.textContent = labelTxt;
        const input = document.createElement('input');
        input.id = id;
        input.name = key;
        input.value = val;
        if(/date/i.test(key)) input.placeholder='YYYY-MM-DD';
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        editForm.appendChild(wrapper);
      });
    }

    function formDataObject(){
      const fd = new FormData(editForm); const obj={};
      for(const [k,v] of fd.entries()) obj[k]=v.trim();
      return obj;
    }

    function diffChanges(original, updated){
      const changes={};
      for(const k of Object.keys(updated)){
        if(k==='iid') continue;
        const origVal = original[k];
        const newVal = updated[k];
        if((origVal||'') !== (newVal||'')) changes[k]=newVal||null;
      }
      return changes;
    }

    // ---------- Update ----------
    async function saveChanges(){
      if(addMode){
        setStatus(modalStatus,'Creating...');
        saveBtn.disabled=true; cancelBtn.disabled=true;
        const newData = formDataObject();
        // Remove empty string -> null for cleaner DB
        Object.keys(newData).forEach(k=>{ if(newData[k]==='') newData[k]=null; });
        const { data, error } = await supabase.from(TABLE).insert(newData).select('*').single();
        if(error){ setStatus(modalStatus,'Create failed: '+error.message,'err'); saveBtn.disabled=false; cancelBtn.disabled=false; return; }
        // push new row to datasets
        allRows.push(data);
        applySearch();
        setStatus(modalStatus,'Created','ok');
        setTimeout(()=>{ closeModal(); }, 500);
        saveBtn.disabled=false; cancelBtn.disabled=false; return;
      }
      if(!currentEdit){ return; }
      setStatus(modalStatus, 'Saving...');
      saveBtn.disabled=true; cancelBtn.disabled=true;
  const updated = formDataObject();
  // Ensure iid is preserved
  updated.iid = currentEdit.iid;
  const changes = diffChanges(currentEdit, updated);
      if(Object.keys(changes).length===0){ setStatus(modalStatus,'No changes','ok'); saveBtn.disabled=false; cancelBtn.disabled=false; return; }
      const { error } = await supabase.from(TABLE).update(changes).eq('iid', currentEdit.iid);
      if(error){ setStatus(modalStatus,'Update failed: '+error.message,'err'); saveBtn.disabled=false; cancelBtn.disabled=false; return; }
      // merge changes into currentEdit & allRows
      Object.assign(currentEdit, changes);
      const idx = allRows.findIndex(r=>r.iid===currentEdit.iid);
      if(idx>-1) Object.assign(allRows[idx], changes);
      applySearch(); // re-render respecting filter
      setStatus(modalStatus,'Saved','ok');
      setTimeout(()=>{ closeModal(); }, 500);
      saveBtn.disabled=false; cancelBtn.disabled=false;
    }
    saveBtn.addEventListener('click', saveChanges);
  addTeacherBtn.addEventListener('click', openAddModal);

    // ---------- Delegated Edit Click ----------
    tbody.addEventListener('click', e=>{
      const linkBtn = e.target.closest('button[data-link-edit]');
      if(linkBtn){
        const iid = linkBtn.getAttribute('data-link-edit');
        window.location.href = 'teacher_edit.html?iid=' + encodeURIComponent(iid);
        return;
      }
    });

    // ---------- Utils ----------
    function escapeHtml(str){
      return String(str).replace(/[&<>"] /g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',' ':' ' }[c] || c));
    }
    function escapeAttr(str){ return String(str).replace(/"/g,'&quot;'); }

    // Initial load
    loadTeachers();
  </script>
</body>
</html>

