<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>ADD - Show & Edit</title>
  <style>
  /* Polished UI: improved typography, spacing, colors */
  html{font-size:100%;}
  body{font-family:  Helvetica, sans-serif; padding:18px;background:linear-gradient(180deg,#f6f8fb,#fbfdff);color:#0f1724}
  /* Base elements */
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px}
  th,td{padding:6px 8px;text-align:left;font-size:0.92rem}
  th{background:linear-gradient(180deg,#fbfdff,#f1f6fb);font-weight:700;font-size:.78rem;color:#0b1220;border-bottom:1px solid #e6eef8}
  .col-sl{width:44px;max-width:44px;text-align:center}

  /* Buttons */
  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:#ff7a00;color:#fff;box-shadow:0 10px 24px rgba(255,122,0,0.12)}
  .btn.secondary{background:#f8fafc;color:#334155;border:2px solid #cbd5e1;box-shadow:0 4px 12px rgba(0,0,0,0.08)}

  /* Modal styles */
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(6,12,28,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:2500}
  .modal .panel{background:#fff;padding:18px;border-radius:12px;max-width:820px;width:100%;max-height:92vh;overflow:auto;box-shadow:0 20px 60px rgba(12,24,40,0.12);z-index:2600}
  #viewModal{align-items:flex-start}
  #viewModal .panel{position:relative;border-radius:12px}
  /* ensure close button is above sticky header */
  #viewModal .view-close-x{position:absolute;right:14px;top:10px;background:transparent;border:none;font-size:26px;line-height:1;padding:6px 8px;cursor:pointer;color:#334155;z-index:2800}

  .field-row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
  .field-row label{min-width:120px;color:#334155;font-weight:600}
  .field-row input, .field-row textarea{flex:1;padding:10px;border-radius:8px;border:1px solid #eef4fb;background:#fff}
  .notice{margin-top:8px;color:#b42318}
  .error-details{font-family:monospace;font-size:12px;color:#b42318;margin-top:6px}

  /* photo column */
  .row-thumb{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eef4fb;display:block}
  /* photo cell: center and prevent table row from stretching oddly */
  td > .row-thumb{display:block;margin:6px auto}
  td:nth-child(3){width:76px;max-width:76px;text-align:center}
  .no-image{font-size:13px;color:#c12b2b;font-style:italic}
  /* raised z-index so photo preview sits above sticky headers */
  #photo-preview{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2700;width:380px;height:520px;border-radius:12px;border:2px solid rgba(10,40,80,0.06);background:#fff;padding:12px;display:none;box-shadow:0 20px 60px rgba(12,24,40,0.12)}

  /* Top bar and controls */
  .top-bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;background:linear-gradient(180deg,#ffffff,#fbfdff);padding:14px 16px;border:1px solid #eef4fb;border-radius:12px;box-shadow:0 8px 20px rgba(14,24,40,0.04);margin-bottom:14px;position:relative}
  .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  select, input[type="text"]{padding:9px 12px;border:1px solid #e6eef8;border-radius:10px;background:#fff;font-family:inherit;font-size:.96rem;min-width:120px;color:#0b1a2b}
  /* center the status text within top-bar */
  #status{position:absolute;left:50%;transform:translateX(-50%);font-weight:700}
  select:focus, input[type="text"]:focus{outline:2px solid rgba(11,116,222,0.14);box-shadow:0 8px 24px rgba(11,116,222,0.06)}

  /* Orange (কমলা) accent for filters */
  .filter-label{color:#ff7a00;font-weight:700;margin-right:6px}
  .filter-select{border-color:rgba(255,122,0,0.18);box-shadow:0 6px 18px rgba(255,122,0,0.06)}
  .filter-select:focus{outline:2px solid rgba(255,122,0,0.16);box-shadow:0 10px 30px rgba(255,122,0,0.08)}

  /* Table visuals */
  #dataTable{background:#ffffff;border:2px solid #ffb366;border-radius:8px;overflow:hidden;box-shadow:0 4px 6px rgba(255,179,102,0.1), 0 2px 4px rgba(255,179,102,0.06)}
  #dataTable thead th{position:sticky;top:0;z-index:3;padding:16px 20px;background:linear-gradient(135deg,#ffb366,#ffcc80);border:1px solid #ffb366;font-weight:600;color:#ffffff}
  #dataTable tbody td{padding:16px 20px;border:1px solid #ffb366;border-bottom:1px solid #f1f5f9}
  #dataTable tbody tr:hover{background:#fff7ed;border-left:3px solid #ffb366;transition:background-color 0.15s ease}

  /* tint entire row redder when student has TC status (strong highlight) */
  #dataTable tbody tr.status-tc{background:#fef2f2;border-left:4px solid #ef4444}
  .small-muted{font-size:.86rem;color:#64748b}

  .loading-spinner{width:32px;height:32px;border:4px solid #edf4fb;border-top-color:#0b74de;border-radius:50%;animation:spin 1s linear infinite;margin:auto}
  @keyframes spin{to{transform:rotate(360deg)}}
  .fade-in{animation:fade .36s ease}
  @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

  @media (max-width:780px){
    .top-bar{padding:10px}
  th,td{padding:10px 8px}
    .field-row{flex-direction:column;align-items:stretch}
  #dataTable thead{display:none}
  #dataTable, #dataTable tbody, #dataTable tr, #dataTable td{display:block;width:100%}
  #dataTable tr{margin-bottom:12px;border-radius:10px;padding:12px;background:#fff;box-shadow:0 6px 20px rgba(12,24,40,0.04)}
  #dataTable td{border:none;padding:8px 10px}
  #dataTable td:before{content:attr(data-label);font-weight:700;display:block;color:#334155;margin-bottom:6px}
  }
  </style>
</head>
<body>
  <button id="addTeacherBtn" class="btn primary" style="float: right; border-radius:10px; padding:8px 14px; color:#fff; font-weight:700;">ADD TEACHER</button>
  <h2>teacher_database — Overview</h2>
  <div class="top-bar">
    <div class="filters left" style="align-items:center">
      <div class="small-muted">Showing all teachers</div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;margin-left:auto">
      <span id="status" style="margin-left:8px;color:#334155;font-weight:600"></span>
      <button id="clearFilters" class="btn secondary" style="margin-left:8px">Reload</button>
    </div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th class="col-sl">SL</th>
        <th>IID</th>
  <th>Photo</th>
        <th>Teacher Name</th>
        <th>Sector</th>
        <th>Designation</th>
        <th>Phone</th>
        <th>Email</th>
        <th>NID</th>
        <th>Join Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
  <tr><td colspan="11">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Edit modal -->
  <div id="editModal" class="modal">
    <div class="panel">
      <h3>Edit Record</h3>

      <!-- Dynamic fields will be rendered here -->
      <div id="editFields"></div>

      <div style="text-align:right;margin-top:12px">
        <button id="cancelBtn" class="btn secondary">Cancel</button>
        <button id="saveBtn" class="btn">Save</button>
      </div>
      <div id="modalNotice" class="notice"></div>
    </div>
  </div>

  <!-- View modal (read-only) -->
  <div id="viewModal" class="modal">
    <div class="panel">
      <h3>View Record</h3>
      <button id="viewCloseX" class="view-close-x" aria-label="Close">&times;</button>
      <div id="viewFields"></div>
      <div style="text-align:right;margin-top:12px">
        <button id="closeViewBtn" class="btn secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Use the same project URL/key used elsewhere in this repo
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  const tableName = 'teacher_database';

  const tbody = document.querySelector('#dataTable tbody');
  const statusEl = document.getElementById('status');
  // filters removed for teacher list
  const classFilter = null;
  const sectionFilter = null;
  const sessionFilter = null;
  const clearFilters = document.getElementById('clearFilters');
  const addTeacherBtn = document.getElementById('addTeacherBtn');

  // photo preview
  const photoPreview = document.createElement('div');
  photoPreview.id = 'photo-preview';
  const previewImg = document.createElement('img');
  previewImg.style.width = '100%';
  previewImg.style.height = '100%';
  previewImg.style.objectFit = 'cover';
  photoPreview.appendChild(previewImg);
  document.body.appendChild(photoPreview);

  tbody.addEventListener('mouseover', (e) => {
    if(e.target.classList.contains('row-thumb')){
      previewImg.src = e.target.src;
      photoPreview.style.display = 'block';
    }
  });

  tbody.addEventListener('mouseout', (e) => {
    if(e.target.classList.contains('row-thumb')){
      photoPreview.style.display = 'none';
    }
  });

  // keep full dataset in memory for client-side filtering
  let allRowsCache = [];

    // modal elems
    const editModal = document.getElementById('editModal');
    const editFields = document.getElementById('editFields');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const modalNotice = document.getElementById('modalNotice');

  // auto-load all data on page load

  // no-op filter listeners (filters removed)
  
  clearFilters.addEventListener('click', ()=>{ loadData(); });
  if(addTeacherBtn) addTeacherBtn.addEventListener('click', () => { openAddTeacher(); });
    cancelBtn.addEventListener('click', closeModal);
    saveBtn.addEventListener('click', saveEdit);

    // store the currently editing IID
    let currentIID = null;

  // Open add-teacher modal with empty fields
  function openAddTeacher(){
    currentIID = null;
    modalNotice.textContent = '';
    const rec = {
      teacher_name_en: '', teacher_name_bn: '', sector: '', designation_en: '', designation_bn: '', mobile_number_en: '', mobile_number_bn: '', email_id: '', nid_number_en: '', nid_number_bn: '', join_date: ''
    };
    renderEditFields(rec);
    editModal.style.display = 'flex';
  }

  // view modal elems
  const viewModal = document.getElementById('viewModal');
  const viewFields = document.getElementById('viewFields');
  const closeViewBtn = document.getElementById('closeViewBtn');
  const viewCloseX = document.getElementById('viewCloseX');
  closeViewBtn.addEventListener('click', () => { viewModal.style.display = 'none'; viewFields.innerHTML = ''; });
  if(viewCloseX) viewCloseX.addEventListener('click', () => { viewModal.style.display = 'none'; viewFields.innerHTML = ''; });

    // photo links loaded from photo/link.csv (one URL per line).
      let photoLinks = [];

  // data order loaded from dataorder.csv (defines preview field order and labels)
  let dataOrder = []; // array of { key, label }

    async function loadPhotoLinks(){
      try{
        // relative path from login/ to the photo list
        const res = await fetch('../photo/link.csv');
        if(!res || !res.ok) return;
        const txt = await res.text();
        photoLinks = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      }catch(e){
        console.warn('loadPhotoLinks failed', e);
        photoLinks = [];
      }
    }
    // start loading photo links in background (non-blocking)
    loadPhotoLinks();

    // load dataorder.csv to determine preview order and labels
    async function loadDataOrder(){
      try{
        // dataorder.csv is expected next to teacherlist in the login/ folder
        const res = await fetch('dataorder.csv');
        if(!res || !res.ok){ dataOrder = []; return; }
        const txt = await res.text();
        const parsed = [];
        const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        lines.forEach(line => {
          // support CSV with key,label or key>label style
          let parts = [];
          if(line.includes(',')) parts = line.split(','); else parts = line.split('>');
          const key = parts[0] ? parts[0].trim() : '';
          const label = parts.slice(1).join(parts.includes(',') ? ',' : '>').trim() || key;
          if(key) parsed.push({ key, label });
        });
        dataOrder = parsed;
      }catch(e){
        console.warn('loadDataOrder failed', e);
        dataOrder = [];
      }
    }
    loadDataOrder();

  async function loadData(){
      // Batched fetch to load ALL rows (handles Supabase default limits)
      statusEl.textContent = 'Loading all data...';
      try{
        const batchSize = 1000;
        let allData = [];
        let lastId = 0;
        let round = 0;
  while(true){
          round++;
          statusEl.textContent = `Loading... fetched ${allData.length} rows (batch ${round})`;
          // build paginated query and optionally apply session filter
          let q = supabase
            .from(tableName)
            .select('iid, pp_photo, teacher_name_en, sector, designation_en, mobile_number_en, email_id, nid_number_en, join_date')
            .gt('iid', lastId);
          q = q.order('iid', { ascending: true }).limit(batchSize);
          const { data, error } = await q;
          if(error){
            const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
            throw new Error(`${error.message} | details: ${details}`);
          }
          if(!data || data.length === 0) break;
          allData = allData.concat(data);
          lastId = data[data.length-1].iid || lastId;
          if(data.length < batchSize) break; // last batch
        }

        allRowsCache = allData;
  // sort by iid
  allRowsCache = allRowsCache.sort((a,b)=> (Number(a.iid)||0) - (Number(b.iid)||0));
        renderTable(allRowsCache);
        statusEl.textContent = `Total: ${allRowsCache.length} records (ALL)`;
      }catch(err){
        console.error('loadData error:', err);
        statusEl.textContent = 'Data loading error';
        const msg = err && err.message ? err.message : String(err);
  tbody.innerHTML = `<tr><td colspan="11">Data loading error: <div class="error-details">${escapeHtml(msg)}</div></td></tr>`;
      }
    }

    function renderTable(rows){
    if(!rows || rows.length === 0){
  tbody.innerHTML = '<tr><td colspan="11">No records found</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      // Render teacher_database rows
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const tdSl = document.createElement('td'); tdSl.className = 'col-sl'; tdSl.textContent = idx + 1; tr.appendChild(tdSl);
        const iid = (r['iid'] ?? r.iid) || '';

        const tdIid = document.createElement('td'); tdIid.textContent = escapeHtml(iid);
  // photo thumbnail (pp_photo)
  const tdPhoto = document.createElement('td');
        const photoUrl = r['pp_photo'] || r.pp_photo || '';
        if(photoUrl){
          const img = document.createElement('img'); img.src = String(photoUrl); img.alt = 'Photo'; img.className = 'row-thumb';
          tdPhoto.appendChild(img);
        } else {
          const span = document.createElement('div'); span.className = 'no-image'; span.textContent = '—'; tdPhoto.appendChild(span);
        }
  const tdName = document.createElement('td'); tdName.textContent = escapeHtml(r['teacher_name_en'] || r.teacher_name_en || '');
        const tdSector = document.createElement('td'); tdSector.textContent = escapeHtml(r['sector'] || r.sector || '');
  const tdDesignation = document.createElement('td'); tdDesignation.textContent = escapeHtml(r['designation_en'] || r.designation_en || '');
  const tdPhone = document.createElement('td'); tdPhone.textContent = escapeHtml(r['mobile_number_en'] || r.mobile_number_en || '');
  const tdEmail = document.createElement('td'); tdEmail.textContent = escapeHtml(r['email_id'] || r.email_id || '');
  const tdNid = document.createElement('td'); tdNid.textContent = escapeHtml(r['nid_number_en'] || r.nid_number_en || '');
        const tdJoin = document.createElement('td'); tdJoin.textContent = escapeHtml(r['join_date'] || r.join_date || '');

        const tdAction = document.createElement('td');
  const btnEdit = document.createElement('button'); btnEdit.className = 'btn primary'; btnEdit.textContent = 'Edit'; btnEdit.setAttribute('data-iid', iid);
  btnEdit.addEventListener('click', () => { openEditByIID(iid); });
        tdAction.appendChild(btnEdit);
        const btnView = document.createElement('button'); btnView.className = 'btn secondary'; btnView.style.marginLeft = '8px'; btnView.textContent = 'View'; btnView.addEventListener('click', ()=> openViewByIID(iid));
        tdAction.appendChild(btnView);

  tr.appendChild(tdIid);
  tr.appendChild(tdPhoto);
  tr.appendChild(tdName);
        tr.appendChild(tdSector);
        tr.appendChild(tdDesignation);
        tr.appendChild(tdPhone);
        tr.appendChild(tdEmail);
        tr.appendChild(tdNid);
        tr.appendChild(tdJoin);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

  async function openEditByIID(iid){
      // fetch full row from DB to ensure we have all columns
      modalNotice.textContent = '';
      currentIID = iid;
      try{
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
      .eq('iid', Number(iid))
          .limit(1)
          .single();
        if(error){
          const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
          throw new Error(`${error.message} | details: ${details}`);
        }
        renderEditFields(data || {});
        editModal.style.display = 'flex';
      }catch(err){
        console.error('openEdit error:', err);
        modalNotice.style.color = '#a00';
        modalNotice.textContent = 'Failed to load record: ' + (err.message || err);
        // fallback: if we had a row in the table view, user can still edit minimal fields (not implemented here)
      }
    }

    // Open a read-only view modal for a given IID
    async function openViewByIID(iid){
      try{
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
          .eq('iid', Number(iid))
          .limit(1)
          .single();
        if(error){
          const details = JSON.stringify(error, Object.getOwnPropertyNames(error));
          throw new Error(`${error.message} | details: ${details}`);
        }
        renderViewFields(data || {});
        viewModal.style.display = 'flex';
      }catch(err){
        console.error('openView error:', err);
        alert('Failed to load record for view: ' + (err.message || err));
      }
    }

    // Render record fields in read-only form (labels + values)
    function renderViewFields(record){
      viewFields.innerHTML = '';
      const rendered = new Set();

      // Attempt to show student photo at the top (large preview)
      (function renderTopPhoto(){
        // try common keys first
        const possibleKeys = ['student_photo_url','photo_url','photo','student_photo','student_photo_en'];
        let url = '';
        for(const k of possibleKeys){ if(record && record[k]){ url = record[k]; break; } }
        // fallback: try iid-based lookup from photoLinks
        const iid = record && (record.iid || record.IID || record.Iid || record['iid']);
        if(!url && iid && Array.isArray(photoLinks) && photoLinks.length){
          const jpg = 'avatar-' + iid + '.jpg';
          const png = 'avatar-' + iid + '.png';
          for(const p of photoLinks){ try{ const fn = new URL(p).pathname.split('/').pop(); if(fn === jpg || fn === png){ url = p; break; } }catch(e){} }
        }
        if(url){
          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.justifyContent = 'center';
          wrap.style.marginBottom = '12px';
          const img = document.createElement('img');
          img.src = String(url);
          img.alt = 'Student photo';
          img.style.maxWidth = '150px';
          img.style.maxHeight = '150px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '10px';
          img.style.boxShadow = '0 8px 28px rgba(12,24,40,0.12)';
          wrap.appendChild(img);
          viewFields.appendChild(wrap);
          // mark photo key as rendered if it exists in record
          for(const k of possibleKeys){ if(Object.prototype.hasOwnProperty.call(record, k)) rendered.add(k); }
        }
      })();

      // helper to render a single key/value
      function renderField(key, label, val){
        const row = document.createElement('div');
        row.className = 'field-row';
        const lab = document.createElement('label'); lab.textContent = (label || key) + ':';
        const container = document.createElement('div');
        container.style.padding = '8px';
        container.style.background = '#f9f9f9';
        container.style.border = '1px solid #eee';
        container.style.flex = '1';
        container.style.whiteSpace = 'pre-wrap';

        // special-case photo URL to render image
        if(key === 'student_photo_url' && val){
          const img = document.createElement('img');
          img.src = String(val);
          img.alt = 'Photo';
          img.style.maxWidth = '220px';
          img.style.maxHeight = '220px';
          img.style.objectFit = 'cover';
          container.appendChild(img);
        } else {
          container.textContent = val === null || val === undefined ? '' : String(val);
        }

        row.appendChild(lab);
        row.appendChild(container);
        viewFields.appendChild(row);
      }

      // 1) Render fields according to dataOrder.csv
      if(Array.isArray(dataOrder) && dataOrder.length){
        dataOrder.forEach(entry => {
          const key = entry.key;
          if(Object.prototype.hasOwnProperty.call(record, key)){
            const val = record[key] === null || record[key] === undefined ? '' : record[key];
            renderField(key, entry.label || key, val);
            rendered.add(key);
          }
        });
      }

      // 2) Render any remaining fields not listed in dataOrder, alphabetically
      const leftover = Object.keys(record).filter(k => !rendered.has(k)).sort();
      leftover.forEach(k => {
        const val = record[k] === null || record[k] === undefined ? '' : record[k];
        renderField(k, k, val);
        rendered.add(k);
      });
    }

    function renderEditFields(record){
      editFields.innerHTML = '';
  // Define the order: Teacher Name (EN/BN), Father/Mother (EN/BN), Sector, Designation (EN/BN), Phone (EN/BN), Email, NID (EN/BN), Join Date, then others
  const priorityOrder = ['teacher_name_en','teacher_name_bn','father_name_en','father_name_bn','mother_name_en','mother_name_bn','sector','designation_en','designation_bn','mobile_number_en','mobile_number_bn','email_id','nid_number_en','nid_number_bn','join_date'];
      const keys = Object.keys(record);
      const orderedKeys = [];
      priorityOrder.forEach(key => {
        if(keys.includes(key)) orderedKeys.push(key);
      });
      // Add remaining keys not in priority order
      keys.forEach(key => {
        if(!priorityOrder.includes(key)) orderedKeys.push(key);
      });
      orderedKeys.forEach(key => {
        const val = record[key] === null || record[key] === undefined ? '' : record[key];
        const row = document.createElement('div');
        row.className = 'field-row';
        const label = document.createElement('label');
        label.textContent = key + ':';
        // decide input type: use textarea for long text fields (heuristic)
        let input;
        if(String(val).length > 120 || key.toLowerCase().includes('address') || key.toLowerCase().includes('note')){
          input = document.createElement('textarea');
          input.rows = 4;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }
        input.value = val;
        input.setAttribute('data-field', key);
  if(key === 'IID' || key === 'iid'){
          input.readOnly = true;
        }
        row.appendChild(label);
        row.appendChild(input);
        editFields.appendChild(row);
      });
    }

    async function saveEdit(){
      modalNotice.textContent = '';
      // build payload from inputs
      const inputs = editFields.querySelectorAll('[data-field]');
      const payload = {};
      inputs.forEach(inp =>{
        const field = inp.getAttribute('data-field');
        if(field === 'iid' || field === 'IID') return; // don't try to update primary key
        const v = inp.value === '' ? null : inp.value;
        payload[field] = v;
      });
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      try{
        let res;
        if(currentIID){
          // update existing
          res = await supabase.from(tableName).update(payload).eq('iid', Number(currentIID));
        } else {
          // insert new
          res = await supabase.from(tableName).insert([payload]);
        }
        if(res.error){
          const details = JSON.stringify(res.error, Object.getOwnPropertyNames(res.error));
          throw new Error(`${res.error.message} | details: ${details}`);
        }
        modalNotice.style.color = 'green';
        modalNotice.textContent = currentIID ? 'Updated successfully' : 'Added successfully';
        // refresh list and close
        await loadData();
        setTimeout(()=>{ closeModal(); modalNotice.textContent = ''; }, 700);
      }catch(err){
        console.error('saveEdit error:', err);
        modalNotice.style.color = '#a00';
        modalNotice.textContent = 'Save error: ' + (err.message || err);
      }finally{
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }

    function closeModal(){
      editModal.style.display = 'none';
      editFields.innerHTML = '';
      currentIID = null;
    }

    function escapeHtml(s){
      if(s === null || s === undefined) return '';
      return String(s).replace(/[&<>\\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\\"':'&quot;',"'":'&#39;'}[c]));
    }

    // close modal when clicking outside panel
    editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeModal(); });

    // close view modal when clicking outside panel
    viewModal.addEventListener('click', (e)=>{ if(e.target===viewModal) { viewModal.style.display = 'none'; viewFields.innerHTML = ''; } });

  // initial load: fetch and show all teacher records
  tbody.innerHTML = '<tr><td colspan="11">Loading all teacher records...</td></tr>';
  // load class list (harmless) and then fetch all data
  loadData();
  </script>
</body>
</html>

