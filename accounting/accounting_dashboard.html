<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üè¶ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ø‡¶Ç ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
  <style>
    :root{
      --primary:#1e40af; --secondary:#0891b2; --success:#059669; --warning:#d97706; --danger:#dc2626;
      --bg:#f8fafc; --card:#ffffff; --border:#e2e8f0; --text:#1e293b; --muted:#64748b; --accent:#3b82f6;
      --grid-gap:16px; --border-radius:12px; --shadow:0 4px 6px -1px rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box; margin:0; padding:0}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:var(--bg); color:var(--text); line-height:1.5}
    .container{max-width:1400px; margin:0 auto; padding:20px}
    
    /* Header */
    .header{background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:24px; border-radius:var(--border-radius); margin-bottom:24px; box-shadow:var(--shadow)}
    .header h1{font-size:28px; font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:12px}
    .header-meta{display:flex; justify-content:space-between; align-items:center; font-size:14px; opacity:0.9}
    .user-info{display:flex; align-items:center; gap:12px}
    
    /* Toolbar */
    .toolbar{background:var(--card); padding:16px; border-radius:var(--border-radius); margin-bottom:24px; box-shadow:var(--shadow); display:flex; flex-wrap:wrap; gap:12px; align-items:center}
    .toolbar .btn{background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:500; transition:all 0.2s}
    .toolbar .btn:hover{background:#2563eb; transform:translateY(-1px)}
    .toolbar .btn.active{background:var(--success); box-shadow:0 2px 4px rgba(5,150,105,0.3)}
    .toolbar .form-control{padding:8px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px}
    .toolbar select.form-control{min-width:120px}
    .checkbox-label{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:14px}
    
    /* Grid System */
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:var(--grid-gap); margin-bottom:24px}
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    
    /* Cards */
    .card{background:var(--card); padding:20px; border-radius:var(--border-radius); box-shadow:var(--shadow); border:1px solid var(--border)}
    .card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px}
    .card-title{font-size:16px; font-weight:600; color:var(--text)}
    .card-subtitle{font-size:12px; color:var(--muted); margin-top:4px}
    
    /* KPI Cards */
    .kpi-card{text-align:center; position:relative; overflow:hidden}
    .kpi-card::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg,var(--success),var(--accent))}
    .kpi-value{font-size:28px; font-weight:700; color:var(--primary); margin:8px 0}
    .kpi-label{font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px}
    .kpi-change{font-size:12px; margin-top:8px; padding:4px 8px; border-radius:12px}
    .kpi-change.positive{background:#dcfce7; color:#16a34a}
    .kpi-change.negative{background:#fef2f2; color:#dc2626}
    
    /* Table */
    .table-container{overflow-x:auto}
    table{width:100%; border-collapse:collapse}
    th,td{padding:12px; text-align:left; border-bottom:1px solid var(--border); font-size:14px}
    th{background:#f8fafc; font-weight:600; color:var(--text); position:sticky; top:0}
    tr:hover{background:#f8fafc}
    .amount{text-align:right; font-weight:500}
    .positive{color:var(--success)} .negative{color:var(--danger)}
    
    /* Chart Container */
    .chart-container{position:relative; height:300px}
    
    /* Action Buttons */
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:16px}
    .action-btn{background:var(--accent); color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; text-decoration:none; display:inline-flex; align-items:center; gap:6px; transition:all 0.2s}
    .action-btn:hover{background:#2563eb; transform:translateY(-1px)}
    .action-btn.secondary{background:var(--muted); color:white}
    .action-btn.success{background:var(--success)}
    .action-btn.warning{background:var(--warning)}
    .action-btn.danger{background:var(--danger)}
    .action-btn:disabled{opacity:0.5; cursor:not-allowed}
    
    /* Status Indicators */
    .status{padding:4px 8px; border-radius:12px; font-size:11px; font-weight:500; text-transform:uppercase}
    .status.active{background:#dcfce7; color:#16a34a}
    .status.pending{background:#fef3c7; color:#d97706}
    .status.overdue{background:#fef2f2; color:#dc2626}
    
    /* Responsive */
    @media (max-width: 1024px){
      .col-3{grid-column:span 6} .col-8{grid-column:span 12} .col-4{grid-column:span 12}
    }
    @media (max-width: 640px){
      .col-3,.col-4,.col-6,.col-8{grid-column:span 12}
      .toolbar{flex-direction:column; align-items:stretch}
      .header-meta{flex-direction:column; align-items:flex-start; gap:8px}
    }
    
    /* Modal Styles */
    .modal{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000}
    .modal.show{display:flex}
    .modal-content{background:var(--card); border-radius:var(--border-radius); box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); max-width:600px; width:90%; max-height:90vh; overflow-y:auto}
    .modal-header{padding:20px 24px 0; border-bottom:1px solid var(--border)}
    .modal-title{font-size:18px; font-weight:600; margin-bottom:16px}
    .modal-body{padding:24px}
    .modal-footer{padding:0 24px 20px; display:flex; gap:12px; justify-content:flex-end}
    .close-btn{position:absolute; top:16px; right:20px; background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted)}
    
    /* Form Styles */
    .form-group{margin-bottom:16px}
    .form-label{display:block; margin-bottom:6px; font-weight:500; color:var(--text)}
    .form-control{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; transition:border-color 0.2s}
    .form-control:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
    .form-control.error{border-color:var(--danger)}
    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .form-row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .error-message{color:var(--danger); font-size:12px; margin-top:4px}
    .success-message{color:var(--success); font-size:12px; margin-top:4px}
    
    /* Loading and Toast */
    .loading{display:inline-block; width:20px; height:20px; border:2px solid var(--border); border-radius:50%; border-top-color:var(--accent); animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed; top:20px; right:20px; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:16px; box-shadow:var(--shadow); z-index:1100; transform:translateX(400px); transition:transform 0.3s}
    .toast.show{transform:translateX(0)}
    .toast.success{border-left:4px solid var(--success)}
    .toast.error{border-left:4px solid var(--danger)}
    .toast.warning{border-left:4px solid var(--warning)}
    
    /* Student Search Results */
    .student-results{position:relative; z-index:100}
    .results-container{position:absolute; top:100%; left:0; right:0; background:var(--card); border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow); max-height:200px; overflow-y:auto}
    .student-result{padding:12px; cursor:pointer; border-bottom:1px solid var(--border)}
    .student-result:hover{background:var(--hover)}
    .student-result:last-child{border-bottom:none}
    .no-results, .error-results{padding:12px; text-align:center; color:var(--muted)}
    .outstanding-bill{display:flex; align-items:center; gap:8px; margin-bottom:8px; padding:8px; background:var(--hover); border-radius:4px}
    .outstanding-bill label{flex:1; margin-bottom:0; cursor:pointer}
    .outstanding-bill small{display:block; color:var(--muted)}
    .fee-item{display:flex; align-items:center; gap:8px; margin-bottom:8px; padding:8px; background:var(--hover); border-radius:4px}
    .fee-item label{flex:1; margin-bottom:0; cursor:pointer}
    .fee-item small{display:block; color:var(--muted)}
    
    /* Amount Display */
    .amount{font-family:monospace; font-weight:600}
    .amount.positive{color:var(--success)}
    .amount.negative{color:var(--danger)}
    
    /* Utilities */
    .text-center{text-align:center} .text-right{text-align:right} .text-muted{color:var(--muted)}
    .mb-4{margin-bottom:16px} .mt-4{margin-top:16px}
    .hidden{display:none}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üè¶  ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</h1>
      <div class="header-meta">
        <div> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡¶Ø‡¶º: <span id="currentTime"></span></div>
        <div class="user-info">
          <span>üë§ <span id="userArea">Loading...</span></span>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn" data-range="today">‡¶Ü‡¶ú</button>
      <button class="btn active" data-range="month">‡¶ö‡¶≤‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏</button>
      <button class="btn" data-range="quarter">‡¶ï‡ßã‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ü‡¶æ‡¶∞</button>
      <button class="btn" data-range="year">‡¶Ö‡¶∞‡ßç‡¶•‡¶¨‡¶õ‡¶∞</button>
      
      <div style="border-left:1px solid var(--border); height:24px; margin:0 8px"></div>
      
      <label for="fromDate" class="sr-only">From date</label>
      <input type="date" id="fromDate" class="form-control" title="‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ">
      <label for="toDate" class="sr-only">To date</label>
      <input type="date" id="toDate" class="form-control" title="‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ">
      
      <label for="campus" class="sr-only">Campus</label>
      <select id="campus" class="form-control" title="‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®">
        <option value="">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™‡¶æ‡¶∏</option>
        <option value="main">‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™‡¶æ‡¶∏</option>
        <option value="branch1">‡¶∂‡¶æ‡¶ñ‡¶æ-‡ßß</option>
        <option value="branch2">‡¶∂‡¶æ‡¶ñ‡¶æ-‡ß®</option>
      </select>
      
      <label class="checkbox-label">
        <input type="checkbox" id="bnDigits"> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
      </label>
      
      <button id="refreshBtn" class="btn secondary" title="‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®">üîÑ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂</button>
    </div>

    <!-- Data Source Banner -->
    <div id="dataBanner" class="card mb-4 hidden" style="background:#fef3c7; border-color:#f59e0b; color:#92400e">
      ‚ö†Ô∏è ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶® - ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶°‡ßá‡¶Æ‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶°‡ßá‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
    </div>

    <!-- KPI Overview -->
    <div class="grid">
      <div class="col-3">
        <div class="card kpi-card">
          <div class="kpi-label">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶Ø‡¶º</div>
          <div class="kpi-value" id="todayIncome">‡ß≥ ‡ß¶</div>
          <div class="kpi-change positive" id="todayChange">+‡ß¶%</div>
          <div class="card-subtitle">‡¶ó‡¶§‡¶ï‡¶æ‡¶≤‡ßá‡¶∞ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ‡¶Ø‡¶º</div>
        </div>
      </div>
      <div class="col-3">
        <div class="card kpi-card">
          <div class="kpi-label">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º</div>
          <div class="kpi-value" id="monthlyIncome">‡ß≥ ‡ß¶</div>
          <div class="kpi-change positive" id="monthlyChange">+‡ß¶%</div>
          <div class="card-subtitle">‡¶ó‡¶§ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ‡¶Ø‡¶º</div>
        </div>
      </div>
      <div class="col-3">
        <div class="card kpi-card">
          <div class="kpi-label">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶™‡¶æ‡¶ì‡¶®‡¶æ</div>
          <div class="kpi-value" id="outstanding">‡ß≥ ‡ß¶</div>
          <div class="kpi-change negative" id="outstandingChange">+‡ß¶%</div>
          <div class="card-subtitle">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</div>
        </div>
      </div>
      <div class="col-3">
        <div class="card kpi-card">
          <div class="kpi-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
          <div class="kpi-value" id="bankBalance">‡ß≥ ‡ß¶</div>
          <div class="kpi-change positive" id="bankChange">+‡ß¶%</div>
          <div class="card-subtitle">‡¶∏‡¶ï‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</div>
        </div>
      </div>
    </div>

    <!-- Charts and Recent Transactions -->
    <div class="grid">
      <div class="col-8">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üí∞ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º-‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°</div>
          </div>
          <div class="chart-container">
            <canvas id="incomeExpenseChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-4">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üìä ‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶â‡ßé‡¶∏</div>
          </div>
          <div class="chart-container">
            <canvas id="incomeSourceChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="card mb-4">
      <div class="card-header">
        <div class="card-title">üí≥ ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</div>
        <button class="action-btn" onclick="loadTransactions()">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
              <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
              <th>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø</th>
              <th>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</th>
              <th class="amount">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
              <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
            </tr>
          </thead>
          <tbody id="transactionTable">
            <tr><td colspan="6" class="text-center text-muted">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Outstanding Fees -->
    <div class="card mb-4">
      <div class="card-header">
        <div class="card-title">‚ö†Ô∏è ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶´‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
        <button class="action-btn warning" onclick="generateOutstandingReport()">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ID</th>
              <th>‡¶®‡¶æ‡¶Æ</th>
              <th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th>
              <th>‡¶´‡¶ø ‡¶ü‡¶æ‡¶á‡¶™</th>
              <th class="amount">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
              <th>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
              <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
          </thead>
          <tbody id="outstandingTable">
            <tr><td colspan="7" class="text-center text-muted">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">‚ö° ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</div>
      </div>
      <div class="actions">
        <button class="action-btn success" onclick="collectFee()">üí∞ ‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</button>
        <button class="action-btn" onclick="newExpense()">üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</button>
        <button class="action-btn primary" onclick="openDailyEntry()">üìù ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</button>
        <button class="action-btn" onclick="bankReconciliation()">üè¶ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∞‡ßá‡¶ï‡¶®‡¶∏‡¶ø‡¶≤‡¶ø‡¶Ø‡¶º‡ßá‡¶∂‡¶®</button>
        <button class="action-btn warning" onclick="generateInvoice()">üìÑ ‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø</button>
        <button class="action-btn secondary" onclick="viewReports()">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
        <button class="action-btn secondary" onclick="chartOfAccounts()">üìã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü</button>
      </div>
    </div>
  </div>

  <!-- Fee Collection Modal -->
  <div id="feeCollectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üí∞ ‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</h3>
        <button class="close-btn" onclick="closeFeeCollectionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="feeCollectionForm">
          <div class="form-group">
            <label class="form-label">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ID/‡¶®‡¶æ‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</label>
            <input type="text" id="studentSearch" class="form-control" placeholder="‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ID ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®" oninput="searchStudent()">
            <div id="studentResults" class="student-results"></div>
          </div>
          <div id="selectedStudent" class="hidden">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ID</label>
                <input type="text" id="studentId" class="form-control" readonly>
              </div>
              <div class="form-group">
                <label class="form-label">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                <input type="text" id="studentName" class="form-control" readonly>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡¶∏‡ßá‡¶ï‡¶∂‡¶®</label>
                <input type="text" id="studentClass" class="form-control" readonly>
              </div>
              <div class="form-group">
                <label class="form-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</label>
                <input type="text" id="totalOutstanding" class="form-control" readonly>
              </div>
            </div>
            <div id="outstandingBills"></div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ <span style="color:red">*</span></label>
                <input type="number" id="collectionAmount" class="form-control" placeholder="0" required>
              </div>
              <div class="form-group">
                <label class="form-label">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶° <span style="color:red">*</span></label>
                <select id="paymentMethod" class="form-control" onchange="showPaymentDetails()" required>
                  <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                  <option value="CASH">‡¶®‡¶ó‡¶¶</option>
                  <option value="BANK">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</option>
                  <option value="BKASH">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
                  <option value="NAGAD">‡¶®‡¶ó‡¶¶</option>
                  <option value="ROCKET">‡¶∞‡¶ï‡ßá‡¶ü</option>
                </select>
              </div>
            </div>
            <div id="paymentDetails" class="hidden">
              <div class="form-group">
                <label class="form-label">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</label>
                <input type="text" id="paymentInfo" class="form-control" placeholder="‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ID/‡¶ö‡ßá‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">‡¶®‡ßã‡¶ü</label>
              <textarea id="collectionNotes" class="form-control" rows="2" placeholder="‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶ï‡ßã‡¶® ‡¶®‡ßã‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="action-btn secondary" onclick="closeFeeCollectionModal()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button type="button" class="action-btn success" onclick="processFeeCollection()">‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </div>
  </div>

  <!-- Expense Entry Modal -->
  <div id="expenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
        <button class="close-btn" onclick="closeExpenseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="expenseForm">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ <span style="color:red">*</span></label>
              <input type="date" id="expenseDate" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
              <input type="text" id="voucherNumber" class="form-control" readonly>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ß‡¶∞‡¶® <span style="color:red">*</span></label>
            <select id="expenseCategory" class="form-control" required>
              <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
              <option value="SALARY">‡¶¨‡ßá‡¶§‡¶®</option>
              <option value="UTILITIES">‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø (‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé/‡¶™‡¶æ‡¶®‡¶ø/‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏)</option>
              <option value="MAINTENANCE">‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡¶æ‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£</option>
              <option value="SUPPLIES">‡¶∏‡¶∞‡¶¨‡¶∞‡¶æ‡¶π ‡¶ì ‡¶â‡¶™‡¶ï‡¶∞‡¶£</option>
              <option value="TRANSPORT">‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶®</option>
              <option value="FOOD">‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞</option>
              <option value="OTHER">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ <span style="color:red">*</span></label>
            <input type="text" id="expenseDescription" class="form-control" placeholder="‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥) <span style="color:red">*</span></label>
              <input type="number" id="expenseAmount" class="form-control" placeholder="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶° <span style="color:red">*</span></label>
              <select id="expensePaymentMethod" class="form-control" required>
                <option value="CASH">‡¶®‡¶ó‡¶¶</option>
                <option value="BANK">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</option>
                <option value="BKASH">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
                <option value="NAGAD">‡¶®‡¶ó‡¶¶</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
              <input type="text" id="vendorName" class="form-control" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶π‡¶≤‡ßá)">
            </div>
            <div class="form-group">
              <label class="form-label">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</label>
              <input type="text" id="vendorContact" class="form-control" placeholder="‡¶´‡ßã‡¶®/‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="action-btn secondary" onclick="closeExpenseModal()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button type="button" class="action-btn danger" onclick="processExpenseEntry()">‡¶ñ‡¶∞‡¶ö ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </div>
  </div>

  <!-- Bill Generation Modal -->
  <div id="billModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìÑ ‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø</h3>
        <button class="close-btn" onclick="closeBillModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="billForm">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ß‡¶∞‡¶® <span style="color:red">*</span></label>
              <select id="billType" class="form-control" onchange="showBillOptions()" required>
                <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                <option value="INDIVIDUAL">‡¶è‡¶ï‡¶ï ‡¶õ‡¶æ‡¶§‡ßç‡¶∞</option>
                <option value="CLASS">‡¶™‡ßÅ‡¶∞‡ßã ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</option>
                <option value="BULK">‡¶∏‡¶¨ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">‡¶¨‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶∏ <span style="color:red">*</span></label>
              <select id="billMonth" class="form-control" required>
                <option value="">‡¶Æ‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                <option value="January">‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø</option>
                <option value="February">‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø</option>
                <option value="March">‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö</option>
                <option value="April">‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤</option>
                <option value="May">‡¶Æ‡ßá</option>
                <option value="June">‡¶ú‡ßÅ‡¶®</option>
                <option value="July">‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á</option>
                <option value="August">‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü</option>
                <option value="September">‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                <option value="October">‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞</option>
                <option value="November">‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                <option value="December">‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
              </select>
            </div>
          </div>
          <div id="billOptions"></div>
          <div class="form-group">
            <label class="form-label">‡¶´‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
            <div id="feeSelection"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="action-btn secondary" onclick="closeBillModal()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button type="button" class="action-btn warning" onclick="generateBills()">‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Global Button Functions - Must be defined before module script -->
  <script>
    console.log('Loading global button functions...');
    
    // Global button functions for onclick handlers
    window.collectFee = function() {
      console.log('collectFee button clicked');
      const modal = document.getElementById('feeCollectionModal');
      if (modal) {
        modal.classList.add('show');
        // Try to generate receipt number if function exists
        if (typeof generateReceiptNumber === 'function') {
          generateReceiptNumber();
        }
      } else {
        alert('‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
      }
    };

    window.newExpense = function() {
      console.log('newExpense button clicked');
      const modal = document.getElementById('expenseModal');
      if (modal) {
        modal.classList.add('show');
        const dateField = document.getElementById('expenseDate');
        if (dateField) {
          dateField.value = new Date().toISOString().split('T')[0];
        }
        // Try to generate voucher number if function exists
        if (typeof generateVoucherNumber === 'function') {
          generateVoucherNumber();
        }
      } else {
        alert('‡¶ñ‡¶∞‡¶ö ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
      }
    };

    window.openDailyEntry = function() {
      console.log('openDailyEntry button clicked');
      window.open('./daily_entry.html', '_blank');
    };

    window.bankReconciliation = function() {
      console.log('bankReconciliation button clicked');
      alert('‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∞‡ßá‡¶ï‡¶®‡¶∏‡¶ø‡¶≤‡¶ø‡¶Ø‡¶º‡ßá‡¶∂‡¶® ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá');
    };

    window.generateInvoice = function() {
      console.log('generateInvoice button clicked');
      const modal = document.getElementById('billModal');
      if (modal) {
        modal.classList.add('show');
        // Try to load fee structure if function exists
        if (typeof loadFeeStructure === 'function') {
          loadFeeStructure();
        }
      } else {
        alert('‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
      }
    };

    window.viewReports = function() {
      console.log('viewReports button clicked');
      alert('‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá');
    };

    window.chartOfAccounts = function() {
      console.log('chartOfAccounts button clicked');
      alert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá');
    };
    
    console.log('Global button functions loaded successfully');
  </script>
  
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase Configuration
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // User Authorization
    const allowedEditors = [
      'fenimodelhighschool@gmail.com',
      'roy.gopal159@gmail.com',
      'all'
    ];

    // Global Variables
    let incomeExpenseChart, incomeSourceChart;
    const userAreaEl = document.getElementById('userArea');
    const dataBanner = document.getElementById('dataBanner');
    
    // Utility Functions
    function formatBDT(amount, bengali = false) {
      try {
        const locale = bengali ? 'bn-BD' : 'en-IN';
        return new Intl.NumberFormat(locale, {
          style: 'currency',
          currency: 'BDT',
          minimumFractionDigits: 0
        }).format(amount || 0);
      } catch {
        return `‡ß≥ ${(amount || 0).toLocaleString()}`;
      }
    }

    function formatNumber(num, bengali = false) {
      try {
        const locale = bengali ? 'bn-BD' : 'en-IN';
        return new Intl.NumberFormat(locale).format(num || 0);
      } catch {
        return String(num || 0);
      }
    }

    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleString('bn-BD', {
        timeZone: 'Asia/Dhaka',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeStr;
    }

    // Chart Functions
    function initializeCharts() {
      // Income vs Expense Chart
      const incomeCtx = document.getElementById('incomeExpenseChart').getContext('2d');
      incomeExpenseChart = new Chart(incomeCtx, {
        type: 'line',
        data: {
          labels: ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®'],
          datasets: [{
            label: '‡¶Ü‡¶Ø‡¶º',
            data: [120000, 140000, 135000, 150000, 160000, 155000],
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.1)',
            tension: 0.4
          }, {
            label: '‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º',
            data: [80000, 90000, 85000, 95000, 100000, 92000],
            borderColor: '#dc2626',
            backgroundColor: 'rgba(220, 38, 38, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            }
          }
        }
      });

      // Income Source Chart
      const sourceCtx = document.getElementById('incomeSourceChart').getContext('2d');
      incomeSourceChart = new Chart(sourceCtx, {
        type: 'doughnut',
        data: {
          labels: ['‡¶ü‡¶ø‡¶â‡¶∂‡¶® ‡¶´‡¶ø', '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶ø', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶´‡¶ø', '‡¶°‡ßã‡¶®‡ßá‡¶∂‡¶®'],
          datasets: [{
            data: [60, 25, 10, 5],
            backgroundColor: ['#3b82f6', '#059669', '#d97706', '#8b5cf6']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // Load Demo Data
    function loadDemoData() {
      const bengali = document.getElementById('bnDigits').checked;
      
      // Update KPIs
      document.getElementById('todayIncome').textContent = formatBDT(25000, bengali);
      document.getElementById('todayChange').textContent = '+12%';
      
      document.getElementById('monthlyIncome').textContent = formatBDT(450000, bengali);
      document.getElementById('monthlyChange').textContent = '+8%';
      
      document.getElementById('outstanding').textContent = formatBDT(125000, bengali);
      document.getElementById('outstandingChange').textContent = '+3%';
      
      document.getElementById('bankBalance').textContent = formatBDT(850000, bengali);
      document.getElementById('bankChange').textContent = '+15%';

      // Load Recent Transactions
      const transactions = [
        { date: '‡ß®‡ß™/‡ß¶‡ßØ/‡ß®‡ß¶‡ß®‡ß´', desc: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßß‡ß¶ ‡¶ü‡¶ø‡¶â‡¶∂‡¶® ‡¶´‡¶ø', category: '‡¶ü‡¶ø‡¶â‡¶∂‡¶®', method: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂', amount: 5000, status: '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®' },
        { date: '‡ß®‡ß™/‡ß¶‡ßØ/‡ß®‡ß¶‡ß®‡ß´', desc: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßÆ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶ø', category: '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ', method: '‡¶®‡¶ó‡¶¶', amount: 2000, status: '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®' },
        { date: '‡ß®‡ß©/‡ß¶‡ßØ/‡ß®‡ß¶‡ß®‡ß´', desc: '‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶¨‡¶ø‡¶≤', category: '‡¶ñ‡¶∞‡¶ö', method: '‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï', amount: -8000, status: '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®' },
        { date: '‡ß®‡ß©/‡ß¶‡ßØ/‡ß®‡ß¶‡ß®‡ß´', desc: '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶¨‡ßá‡¶§‡¶®', category: '‡¶¨‡ßá‡¶§‡¶®', method: '‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï', amount: -45000, status: '‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ß‡ßÄ‡¶®' }
      ];

      const transactionHtml = transactions.map(t => `
        <tr>
          <td>${t.date}</td>
          <td>${t.desc}</td>
          <td>${t.category}</td>
          <td>${t.method}</td>
          <td class="amount ${t.amount > 0 ? 'positive' : 'negative'}">${formatBDT(Math.abs(t.amount), bengali)}</td>
          <td><span class="status ${t.status === '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®' ? 'active' : 'pending'}">${t.status}</span></td>
        </tr>
      `).join('');
      document.getElementById('transactionTable').innerHTML = transactionHtml;

      // Load Outstanding Fees
      const outstanding = [
        { id: '2025001', name: '‡¶∞‡¶π‡¶ø‡¶Æ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶', class: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßØ', type: '‡¶ü‡¶ø‡¶â‡¶∂‡¶® ‡¶´‡¶ø', amount: 5000, due: '‡ß©‡ß¶/‡ß¶‡ßØ/‡ß®‡ß¶‡ß®‡ß´' },
        { id: '2025002', name: '‡¶´‡¶æ‡¶§‡¶ø‡¶Æ‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®', class: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßß‡ß¶', type: '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶ø', amount: 2500, due: '‡ß®‡ßÆ/‡ß¶‡ßØ/‡ß®‡ß¶‡ß®‡ß´' },
        { id: '2025003', name: '‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶â‡¶¶‡ßç‡¶¶‡¶ø‡¶®', class: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßÆ', type: '‡¶¨‡¶á ‡¶´‡¶ø', amount: 1500, due: '‡ßß‡ß´/‡ßß‡ß¶/‡ß®‡ß¶‡ß®‡ß´' }
      ];

      const outstandingHtml = outstanding.map(o => `
        <tr>
          <td>${o.id}</td>
          <td>${o.name}</td>
          <td>${o.class}</td>
          <td>${o.type}</td>
          <td class="amount negative">${formatBDT(o.amount, bengali)}</td>
          <td>${o.due}</td>
          <td><button class="action-btn success" onclick="collectStudentFee('${o.id}')">‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</button></td>
        </tr>
      `).join('');
      document.getElementById('outstandingTable').innerHTML = outstandingHtml;
    }

    // Event Handlers
    function setDateRange(range) {
      const now = new Date();
      const start = new Date(now);
      
      switch(range) {
        case 'today':
          // Keep same day
          break;
        case 'month':
          start.setDate(1);
          break;
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          start.setMonth(quarter * 3, 1);
          break;
        case 'year':
          // Bangladesh fiscal year: July 1 - June 30
          const fiscalYear = now.getMonth() >= 6 ? now.getFullYear() : now.getFullYear() - 1;
          start.setFullYear(fiscalYear, 6, 1);
          break;
      }
      
      document.getElementById('fromDate').value = start.toISOString().split('T')[0];
      document.getElementById('toDate').value = now.toISOString().split('T')[0];
      
      // Update active button
      document.querySelectorAll('[data-range]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
      });
      
      loadDashboard();
    }

    async function loadDashboard() {
      try {
        // Try to load real data from database
        const user = (await supabase.auth.getUser()).data.user;
        userAreaEl.textContent = user?.email || 'Guest User';
        
        // Check if accounting tables exist
        const { data, error } = await supabase.from('acc_transactions').select('*').limit(1);
        
        if (error) {
          // Show demo data if tables don't exist
          dataBanner.classList.remove('hidden');
          loadDemoData();
        } else {
          // Hide banner and load real data
          dataBanner.classList.add('hidden');
          await loadRealData();
        }
      } catch (err) {
        console.warn('Database connection failed, showing demo data:', err);
        dataBanner.classList.remove('hidden');
        loadDemoData();
      }
    }

    async function loadRealData() {
      // Implementation for loading real data from Supabase tables
      // This will be implemented once tables are created
      console.log('Loading real data from database...');
      loadDemoData(); // Fallback to demo for now
    }

    // Initialize Dashboard
    function initialize() {
      updateTime();
      setInterval(updateTime, 60000); // Update every minute
      
      initializeCharts();
      setDateRange('month'); // Default to current month
      
      // Event listeners
      document.querySelectorAll('[data-range]').forEach(btn => {
        btn.addEventListener('click', () => setDateRange(btn.dataset.range));
      });
      
      document.getElementById('refreshBtn').addEventListener('click', loadDashboard);
      document.getElementById('bnDigits').addEventListener('change', loadDemoData);
      document.getElementById('fromDate').addEventListener('change', loadDashboard);
      document.getElementById('toDate').addEventListener('change', loadDashboard);
      document.getElementById('campus').addEventListener('change', loadDashboard);
    }

    // Real Data Loading Functions
    async function loadRealData() {
      try {
        const bengali = document.getElementById('bnDigits').checked;
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        const campus = document.getElementById('campus').value;

        // Load KPI data
        await loadKPIData(fromDate, toDate, campus, bengali);
        
        // Load recent transactions
        await loadRecentTransactions(fromDate, toDate, campus, bengali);
        
        // Load outstanding fees
        await loadOutstandingFees(campus, bengali);
        
      } catch (error) {
        console.error('Error loading real data:', error);
        showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        loadDemoData();
      }
    }

    async function loadKPIData(fromDate, toDate, campus, bengali) {
      // Today's income
      const { data: todayIncome } = await supabase
        .from('acc_transactions')
        .select('total_amount')
        .eq('transaction_type', 'INCOME')
        .eq('approval_status', 'APPROVED')
        .eq('transaction_date', new Date().toISOString().split('T')[0])
        .eq(campus ? 'campus' : 'id', campus || 0);

      const todayTotal = todayIncome?.reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0) || 0;
      document.getElementById('todayIncome').textContent = formatBDT(todayTotal, bengali);

      // Monthly income
      const monthStart = new Date();
      monthStart.setDate(1);
      const { data: monthlyIncome } = await supabase
        .from('acc_transactions')
        .select('total_amount')
        .eq('transaction_type', 'INCOME')
        .eq('approval_status', 'APPROVED')
        .gte('transaction_date', monthStart.toISOString().split('T')[0])
        .lte('transaction_date', new Date().toISOString().split('T')[0]);

      const monthlyTotal = monthlyIncome?.reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0) || 0;
      document.getElementById('monthlyIncome').textContent = formatBDT(monthlyTotal, bengali);

      // Outstanding fees
      const { data: outstanding } = await supabase
        .from('acc_student_bills')
        .select('outstanding_amount')
        .in('status', ['PENDING', 'PARTIAL', 'OVERDUE']);

      const outstandingTotal = outstanding?.reduce((sum, b) => sum + (parseFloat(b.outstanding_amount) || 0), 0) || 0;
      document.getElementById('outstanding').textContent = formatBDT(outstandingTotal, bengali);

      // Bank balance (sum from all bank accounts)
      const { data: bankAccounts } = await supabase
        .from('acc_bank_accounts')
        .select('current_balance')
        .eq('is_active', true);

      const bankTotal = bankAccounts?.reduce((sum, b) => sum + (parseFloat(b.current_balance) || 0), 0) || 0;
      document.getElementById('bankBalance').textContent = formatBDT(bankTotal, bengali);
    }

    async function loadRecentTransactions(fromDate, toDate, campus, bengali) {
      const { data: transactions } = await supabase
        .from('acc_transactions')
        .select('transaction_date, description, transaction_type, payment_method, total_amount, approval_status')
        .order('transaction_date', { ascending: false })
        .order('created_at', { ascending: false })
        .limit(10);

      if (transactions && transactions.length > 0) {
        const transactionHtml = transactions.map(t => `
          <tr>
            <td>${formatDate(t.transaction_date, bengali)}</td>
            <td>${t.description}</td>
            <td>${getTransactionTypeText(t.transaction_type)}</td>
            <td>${getPaymentMethodText(t.payment_method)}</td>
            <td class="amount ${t.transaction_type === 'INCOME' ? 'positive' : 'negative'}">
              ${t.transaction_type === 'INCOME' ? '' : '-'}${formatBDT(Math.abs(t.total_amount), bengali)}
            </td>
            <td><span class="status ${getStatusClass(t.approval_status)}">${getStatusText(t.approval_status)}</span></td>
          </tr>
        `).join('');
        document.getElementById('transactionTable').innerHTML = transactionHtml;
      } else {
        document.getElementById('transactionTable').innerHTML = '<tr><td colspan="6" class="text-center text-muted">‡¶ï‡ßã‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</td></tr>';
      }
    }

    async function loadOutstandingFees(campus, bengali) {
      const { data: outstanding } = await supabase
        .from('acc_student_bills')
        .select('student_id, student_name, class_section, outstanding_amount, due_date, bill_id')
        .in('status', ['PENDING', 'PARTIAL', 'OVERDUE'])
        .order('due_date', { ascending: true })
        .limit(20);

      if (outstanding && outstanding.length > 0) {
        const outstandingHtml = outstanding.map(o => `
          <tr>
            <td>${o.student_id}</td>
            <td>${o.student_name}</td>
            <td>${o.class_section}</td>
            <td>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶´‡¶ø</td>
            <td class="amount negative">${formatBDT(o.outstanding_amount, bengali)}</td>
            <td>${formatDate(o.due_date, bengali)}</td>
            <td>
              <button class="action-btn success" onclick="collectStudentFee('${o.student_id}', ${o.bill_id})">
                ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º
              </button>
            </td>
          </tr>
        `).join('');
        document.getElementById('outstandingTable').innerHTML = outstandingHtml;
      } else {
        document.getElementById('outstandingTable').innerHTML = '<tr><td colspan="7" class="text-center text-muted">‡¶ï‡ßã‡¶® ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶´‡¶ø ‡¶®‡ßá‡¶á</td></tr>';
      }
    }

    // Utility functions for display
    function formatDate(dateStr, bengali) {
      const date = new Date(dateStr);
      return date.toLocaleDateString(bengali ? 'bn-BD' : 'en-IN');
    }

    function getTransactionTypeText(type) {
      const types = { 'INCOME': '‡¶Ü‡¶Ø‡¶º', 'EXPENSE': '‡¶ñ‡¶∞‡¶ö', 'TRANSFER': '‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞' };
      return types[type] || type;
    }

    function getPaymentMethodText(method) {
      const methods = { 'CASH': '‡¶®‡¶ó‡¶¶', 'BANK': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï', 'BKASH': '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂', 'NAGAD': '‡¶®‡¶ó‡¶¶', 'ROCKET': '‡¶∞‡¶ï‡ßá‡¶ü' };
      return methods[method] || method;
    }

    function getStatusClass(status) {
      const classes = { 'APPROVED': 'active', 'PENDING': 'pending', 'REJECTED': 'overdue' };
      return classes[status] || 'pending';
    }

    function getStatusText(status) {
      const texts = { 'APPROVED': '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§', 'PENDING': '‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶£', 'REJECTED': '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤' };
      return texts[status] || status;
    }

    // Toast notification system
    function showToast(message, type = 'success', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<strong>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '!'}</strong> ${message}`;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, duration);
    }

    // Fee Collection Functions - Fixed
    function collectFee() {
      document.getElementById('feeCollectionModal').classList.add('show');
      generateReceiptNumber();
    }
    window.collectFee = collectFee;

    function closeFeeCollectionModal() {
      document.getElementById('feeCollectionModal').classList.remove('show');
      document.getElementById('feeCollectionForm').reset();
      document.getElementById('selectedStudent').classList.add('hidden');
      document.getElementById('studentResults').innerHTML = '';
    }

    async function searchStudent() {
      const query = document.getElementById('studentSearch').value.trim();
      if (query.length < 2) {
        document.getElementById('studentResults').innerHTML = '';
        return;
      }

      try {
        const { data: students } = await supabase
          .from('student_database')
          .select('iid, student_name_en, class_section')
          .or(`iid.ilike.%${query}%,student_name_en.ilike.%${query}%`)
          .limit(5);

        if (students && students.length > 0) {
          const resultsHtml = students.map(s => `
            <div class="student-result" onclick="selectStudent('${s.iid}', '${s.student_name_en}', '${s.class_section}')">
              <strong>${s.iid}</strong> - ${s.student_name_en} (${s.class_section})
            </div>
          `).join('');
          document.getElementById('studentResults').innerHTML = `<div class="results-container">${resultsHtml}</div>`;
        } else {
          document.getElementById('studentResults').innerHTML = '<div class="no-results">‡¶ï‡ßã‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</div>';
        }
      } catch (error) {
        console.error('Student search error:', error);
        document.getElementById('studentResults').innerHTML = '<div class="error-results">‡¶ñ‡ßã‡¶Å‡¶ú‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
      }
    }

    async function selectStudent(studentId, studentName, studentClass) {
      document.getElementById('studentId').value = studentId;
      document.getElementById('studentName').value = studentName;
      document.getElementById('studentClass').value = studentClass;
      document.getElementById('selectedStudent').classList.remove('hidden');
      document.getElementById('studentResults').innerHTML = '';
      
      // Load outstanding bills
      await loadStudentOutstanding(studentId);
    }

    async function loadStudentOutstanding(studentId) {
      try {
        const { data: bills } = await supabase
          .from('acc_student_bills')
          .select('bill_id, outstanding_amount, due_date, bill_month, total_amount')
          .eq('student_id', studentId)
          .in('status', ['PENDING', 'PARTIAL', 'OVERDUE'])
          .order('due_date', { ascending: true });

        if (bills && bills.length > 0) {
          const totalOutstanding = bills.reduce((sum, b) => sum + parseFloat(b.outstanding_amount), 0);
          document.getElementById('totalOutstanding').value = formatBDT(totalOutstanding);
          
          const billsHtml = bills.map(b => `
            <div class="outstanding-bill">
              <input type="checkbox" id="bill_${b.bill_id}" value="${b.bill_id}" data-amount="${b.outstanding_amount}">
              <label for="bill_${b.bill_id}">
                ${b.bill_month} - ${formatBDT(b.outstanding_amount)} (‡¶Æ‡ßã‡¶ü: ${formatBDT(b.total_amount)})
                <small>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${formatDate(b.due_date)}</small>
              </label>
            </div>
          `).join('');
          document.getElementById('outstandingBills').innerHTML = billsHtml;
        } else {
          document.getElementById('totalOutstanding').value = '‡ß≥ 0';
          document.getElementById('outstandingBills').innerHTML = '<p class="text-muted">‡¶ï‡ßã‡¶® ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶≤ ‡¶®‡ßá‡¶á</p>';
        }
      } catch (error) {
        console.error('Error loading student outstanding:', error);
        showToast('‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ', 'error');
      }
    }

    function showPaymentDetails() {
      const method = document.getElementById('paymentMethod').value;
      const detailsDiv = document.getElementById('paymentDetails');
      const inputField = document.getElementById('paymentInfo');
      
      if (method === 'BANK') {
        detailsDiv.classList.remove('hidden');
        inputField.placeholder = '‡¶ö‡ßá‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ID';
      } else if (['BKASH', 'NAGAD', 'ROCKET'].includes(method)) {
        detailsDiv.classList.remove('hidden');
        inputField.placeholder = '‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ID';
      } else {
        detailsDiv.classList.add('hidden');
      }
    }

    async function processFeeCollection() {
      try {
        const studentId = document.getElementById('studentId').value;
        const amount = parseFloat(document.getElementById('collectionAmount').value);
        const paymentMethod = document.getElementById('paymentMethod').value;
        const paymentInfo = document.getElementById('paymentInfo').value;
        const notes = document.getElementById('collectionNotes').value;
        
        if (!studentId || !amount || !paymentMethod) {
          showToast('‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®', 'error');
          return;
        }

        // Generate receipt number
        const receiptNumber = await generateReceiptNumber();
        
        // Create payment record
        const { data: collection, error: collectionError } = await supabase
          .from('acc_fee_collections')
          .insert({
            receipt_number: receiptNumber,
            student_id: studentId,
            student_name: document.getElementById('studentName').value,
            collection_date: new Date().toISOString().split('T')[0],
            total_amount: amount,
            payment_method: paymentMethod,
            payment_details: paymentInfo ? JSON.stringify({ info: paymentInfo }) : null,
            collected_by: userAreaEl.textContent || 'System',
            campus: document.getElementById('campus').value || 'main',
            academic_year: '2024-25',
            notes: notes
          })
          .select();

        if (collectionError) throw collectionError;

        // Create accounting transaction
        const { error: transactionError } = await supabase
          .from('acc_transactions')
          .insert({
            transaction_date: new Date().toISOString().split('T')[0],
            reference_no: receiptNumber,
            transaction_type: 'INCOME',
            description: `‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º - ${document.getElementById('studentName').value} (${studentId})`,
            total_amount: amount,
            campus: document.getElementById('campus').value || 'main',
            student_id: studentId,
            created_by: userAreaEl.textContent || 'System',
            approval_status: 'APPROVED',
            payment_method: paymentMethod,
            payment_details: paymentInfo ? JSON.stringify({ info: paymentInfo }) : null
          });

        if (transactionError) throw transactionError;

        showToast(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡ß≥${amount} ‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶∞‡¶ø‡¶∏‡¶ø‡¶™‡ßç‡¶ü: ${receiptNumber}`, 'success');
        closeFeeCollectionModal();
        loadDashboard(); // Refresh dashboard
        
      } catch (error) {
        console.error('Fee collection error:', error);
        showToast('‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
      }
    }

    async function generateReceiptNumber() {
      const today = new Date();
      const prefix = 'REC' + today.getFullYear().toString().slice(-2) + (today.getMonth() + 1).toString().padStart(2, '0');
      
      // Get last receipt number for this month
      const { data: lastReceipt } = await supabase
        .from('acc_fee_collections')
        .select('receipt_number')
        .like('receipt_number', `${prefix}%`)
        .order('receipt_number', { ascending: false })
        .limit(1);

      let nextNumber = 1;
      if (lastReceipt && lastReceipt.length > 0) {
        const lastNum = parseInt(lastReceipt[0].receipt_number.slice(-4));
        nextNumber = lastNum + 1;
      }
      
      return prefix + nextNumber.toString().padStart(4, '0');
    }

    // Expense Entry Functions - Fixed
    function newExpense() {
      document.getElementById('expenseModal').classList.add('show');
      document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
      generateVoucherNumber();
    }
    window.newExpense = newExpense;

    function closeExpenseModal() {
      document.getElementById('expenseModal').classList.remove('show');
      document.getElementById('expenseForm').reset();
    }

    async function generateVoucherNumber() {
      const today = new Date();
      const prefix = 'EXP' + today.getFullYear().toString().slice(-2) + (today.getMonth() + 1).toString().padStart(2, '0');
      
      const { data: lastExpense } = await supabase
        .from('acc_expenses')
        .select('voucher_number')
        .like('voucher_number', `${prefix}%`)
        .order('voucher_number', { ascending: false })
        .limit(1);

      let nextNumber = 1;
      if (lastExpense && lastExpense.length > 0) {
        const lastNum = parseInt(lastExpense[0].voucher_number.slice(-4));
        nextNumber = lastNum + 1;
      }
      
      document.getElementById('voucherNumber').value = prefix + nextNumber.toString().padStart(4, '0');
    }

    async function processExpenseEntry() {
      try {
        const formData = {
          voucher_number: document.getElementById('voucherNumber').value,
          expense_date: document.getElementById('expenseDate').value,
          expense_category: document.getElementById('expenseCategory').value,
          description: document.getElementById('expenseDescription').value,
          total_amount: parseFloat(document.getElementById('expenseAmount').value),
          vendor_name: document.getElementById('vendorName').value,
          vendor_contact: document.getElementById('vendorContact').value,
          payment_method: document.getElementById('expensePaymentMethod').value,
          campus: document.getElementById('campus').value || 'main',
          created_by: userAreaEl.textContent || 'System',
          approval_status: 'APPROVED' // Auto-approve for now
        };

        if (!formData.expense_category || !formData.description || !formData.total_amount) {
          showToast('‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®', 'error');
          return;
        }

        // Insert expense record
        const { error: expenseError } = await supabase
          .from('acc_expenses')
          .insert(formData);

        if (expenseError) throw expenseError;

        // Create accounting transaction
        const { error: transactionError } = await supabase
          .from('acc_transactions')
          .insert({
            transaction_date: formData.expense_date,
            reference_no: formData.voucher_number,
            transaction_type: 'EXPENSE',
            description: formData.description,
            total_amount: formData.total_amount,
            campus: formData.campus,
            created_by: formData.created_by,
            approval_status: 'APPROVED',
            payment_method: formData.payment_method
          });

        if (transactionError) throw transactionError;

        showToast(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡ß≥${formData.total_amount} ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
        closeExpenseModal();
        loadDashboard();
        
      } catch (error) {
        console.error('Expense entry error:', error);
        showToast('‡¶ñ‡¶∞‡¶ö ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
      }
    }

    // Bill Generation Functions - Fixed
    function generateInvoice() {
      document.getElementById('billModal').classList.add('show');
      loadFeeStructure();
    }
    window.generateInvoice = generateInvoice;

    function closeBillModal() {
      document.getElementById('billModal').classList.remove('show');
      document.getElementById('billForm').reset();
    }

    async function loadFeeStructure() {
      try {
        const { data: fees } = await supabase
          .from('acc_fee_structure')
          .select('*')
          .eq('is_active', true)
          .order('fee_name');

        if (fees && fees.length > 0) {
          const feeHtml = fees.map(f => `
            <div class="fee-item">
              <input type="checkbox" id="fee_${f.fee_id}" value="${f.fee_id}" data-amount="${f.amount}">
              <label for="fee_${f.fee_id}">
                ${f.fee_name_bn || f.fee_name} - ${formatBDT(f.amount)}
                <small>(${f.fee_type})</small>
              </label>
            </div>
          `).join('');
          document.getElementById('feeSelection').innerHTML = feeHtml;
        }
      } catch (error) {
        console.error('Error loading fee structure:', error);
      }
    }

    function showBillOptions() {
      const billType = document.getElementById('billType').value;
      const optionsDiv = document.getElementById('billOptions');
      
      if (billType === 'INDIVIDUAL') {
        optionsDiv.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</label>
            <input type="text" id="billStudentSearch" class="form-control" placeholder="‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ID ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ" oninput="searchStudentForBill()">
            <div id="billStudentResults"></div>
          </div>
        `;
      } else if (billType === 'CLASS') {
        optionsDiv.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</label>
            <select id="selectedClass" class="form-control">
              <option value="">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
              <option value="Class-1">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßß</option>
              <option value="Class-2">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ß®</option>
              <option value="Class-3">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ß©</option>
              <option value="Class-4">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ß™</option>
              <option value="Class-5">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ß´</option>
              <option value="Class-6">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ß¨</option>
              <option value="Class-7">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ß≠</option>
              <option value="Class-8">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßÆ</option>
              <option value="Class-9">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßØ</option>
              <option value="Class-10">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏-‡ßß‡ß¶</option>
            </select>
          </div>
        `;
      } else {
        optionsDiv.innerHTML = '';
      }
    }

    async function generateBills() {
      try {
        const billType = document.getElementById('billType').value;
        const billMonth = document.getElementById('billMonth').value;
        const selectedFees = Array.from(document.querySelectorAll('#feeSelection input:checked'));
        
        if (!billType || !billMonth || selectedFees.length === 0) {
          showToast('‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®', 'error');
          return;
        }

        showToast('‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', 'success');
        closeBillModal();
        
      } catch (error) {
        console.error('Bill generation error:', error);
        showToast('‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
      }
    }

    // Other Functions - Fixed
    function bankReconciliation() {
      showToast('‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∞‡ßá‡¶ï‡¶®‡¶∏‡¶ø‡¶≤‡¶ø‡¶Ø‡¶º‡ßá‡¶∂‡¶® ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá', 'warning');
    }
    window.bankReconciliation = bankReconciliation;

    function viewReports() {
      showToast('‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá', 'warning');
    }
    window.viewReports = viewReports;

    function chartOfAccounts() {
      showToast('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá', 'warning');
    }
    window.chartOfAccounts = chartOfAccounts;

    function openDailyEntry() {
      window.open('./daily_entry.html', '_blank');
    }
    window.openDailyEntry = openDailyEntry;

    // Essential helper functions for modals to work
    async function generateReceiptNumber() {
      const today = new Date();
      const prefix = 'REC' + today.getFullYear().toString().slice(-2) + (today.getMonth() + 1).toString().padStart(2, '0');
      
      try {
        // Get last receipt number for this month from localStorage for demo
        const lastReceipt = localStorage.getItem('lastReceiptNumber');
        let nextNumber = 1;
        if (lastReceipt && lastReceipt.startsWith(prefix)) {
          const lastNum = parseInt(lastReceipt.slice(-4));
          nextNumber = lastNum + 1;
        }
        
        const receiptNumber = prefix + nextNumber.toString().padStart(4, '0');
        localStorage.setItem('lastReceiptNumber', receiptNumber);
        return receiptNumber;
      } catch (error) {
        console.error('Error generating receipt number:', error);
        return prefix + '0001';
      }
    }

    async function generateVoucherNumber() {
      const today = new Date();
      const prefix = 'EXP' + today.getFullYear().toString().slice(-2) + (today.getMonth() + 1).toString().padStart(2, '0');
      
      try {
        const lastVoucher = localStorage.getItem('lastVoucherNumber');
        let nextNumber = 1;
        if (lastVoucher && lastVoucher.startsWith(prefix)) {
          const lastNum = parseInt(lastVoucher.slice(-4));
          nextNumber = lastNum + 1;
        }
        
        const voucherNumber = prefix + nextNumber.toString().padStart(4, '0');
        localStorage.setItem('lastVoucherNumber', voucherNumber);
        document.getElementById('voucherNumber').value = voucherNumber;
        return voucherNumber;
      } catch (error) {
        console.error('Error generating voucher number:', error);
        document.getElementById('voucherNumber').value = prefix + '0001';
        return prefix + '0001';
      }
    }

    async function loadFeeStructure() {
      try {
        // Demo fee structure for testing
        const fees = [
          {fee_id: 1, fee_name: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ü‡¶ø‡¶â‡¶∂‡¶® ‡¶´‡¶ø', fee_name_bn: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ü‡¶ø‡¶â‡¶∂‡¶® ‡¶´‡¶ø', amount: 1500, fee_type: 'MONTHLY'},
          {fee_id: 2, fee_name: '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶ø', fee_name_bn: '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶ø', amount: 300, fee_type: 'EXAM'},
          {fee_id: 3, fee_name: '‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶® ‡¶´‡¶ø', fee_name_bn: '‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶® ‡¶´‡¶ø', amount: 500, fee_type: 'TRANSPORT'},
          {fee_id: 4, fee_name: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø', fee_name_bn: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø', amount: 2000, fee_type: 'ADMISSION'}
        ];

        const feeHtml = fees.map(f => `
          <div class="fee-item">
            <input type="checkbox" id="fee_${f.fee_id}" value="${f.fee_id}" data-amount="${f.amount}">
            <label for="fee_${f.fee_id}">
              ${f.fee_name_bn || f.fee_name} - ${formatBDT(f.amount)}
              <small>(${f.fee_type})</small>
            </label>
          </div>
        `).join('');
        
        if (document.getElementById('feeSelection')) {
          document.getElementById('feeSelection').innerHTML = feeHtml;
        }
      } catch (error) {
        console.error('Error loading fee structure:', error);
        if (document.getElementById('feeSelection')) {
          document.getElementById('feeSelection').innerHTML = '<p class="text-muted">‡¶´‡¶ø ‡¶ï‡¶æ‡¶†‡¶æ‡¶Æ‡ßã ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ</p>';
        }
      }
    }

    window.collectStudentFee = function(studentId, billId) {
      document.getElementById('studentSearch').value = studentId;
      searchStudent().then(() => {
        if (document.getElementById('studentId').value === studentId) {
          document.getElementById('feeCollectionModal').classList.add('show');
        }
      });
    };

    window.loadTransactions = function() {
      showToast('‡¶∏‡¶¨ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá', 'warning');
    };

    window.generateOutstandingReport = function() {
      showToast('‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', 'success');
    };

    // Format currency for Bangladesh
    function formatBDT(amount, bengali = false) {
      if (!amount) return '‡ß≥ 0';
      
      const formatted = parseFloat(amount).toLocaleString(bengali ? 'bn-BD' : 'en-IN', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      
      return '‡ß≥ ' + formatted;
    }

    // Start the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Initializing application...');
      
      // Ensure all button functions are globally accessible
      window.collectFee = collectFee;
      window.newExpense = newExpense;  
      window.openDailyEntry = openDailyEntry;
      window.bankReconciliation = bankReconciliation;
      window.generateInvoice = generateInvoice;
      window.viewReports = viewReports;
      window.chartOfAccounts = chartOfAccounts;
      
      console.log('Button functions attached to window:', {
        collectFee: typeof window.collectFee,
        newExpense: typeof window.newExpense,
        openDailyEntry: typeof window.openDailyEntry,
        bankReconciliation: typeof window.bankReconciliation,
        generateInvoice: typeof window.generateInvoice,
        viewReports: typeof window.viewReports,
        chartOfAccounts: typeof window.chartOfAccounts
      });
      
      initialize();
      loadDashboard();
    });
  </script>
</body>
</html>
