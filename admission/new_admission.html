<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>New Admission Application</title>
<link rel="icon" href="../logo2.png" />
<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">

<style>
html{font-size:115%;}
:root{--bg:#f5f7fb;--bg-alt:#ffffff;--text:#1f2d3d;--text-soft:#5b6675;--border:#e2e8f0;--brand:#2563eb;--danger:#dc2626;--success:#15803d;--warn:#f59e0b;--shadow:0 6px 20px -2px rgba(0,0,0,.08),0 2px 6px -1px rgba(0,0,0,.04);} 
.dark{--bg:#0d1117;--bg-alt:#161b22;--text:#e6edf3;--text-soft:#93a4b8;--border:#273649;--shadow:0 6px 28px -4px rgba(0,0,0,.65);} 
*{box-sizing:border-box;font-family:'Noto Sans Bengali',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;} body{margin:0;background:var(--bg);color:var(--text);} a{text-decoration:none;color:var(--brand);} 
header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.2rem;flex-wrap:wrap;gap:1rem;} .title{margin:0;font-size:clamp(1.4rem,2.5vw,2.05rem);font-weight:700;letter-spacing:.5px;background:linear-gradient(90deg,#0ea5e9,#6366f1,#10b981);-webkit-background-clip:text;background-clip:text;color:transparent;} 
.mode-btn{background:var(--bg-alt);border:1px solid var(--border);padding:.55rem .85rem;border-radius:10px;font-size:.72rem;font-weight:600;cursor:pointer;color:var(--text-soft);display:inline-flex;align-items:center;gap:.45rem;box-shadow:var(--shadow);} 
.shadow-orange{box-shadow:0 8px 30px -6px rgba(249,115,22,.35), 0 4px 18px -4px rgba(249,115,22,.25) !important;}
.mode-btn.orange{background:linear-gradient(90deg,#f97316,#f59e0b);border-color:transparent;color:#fff;box-shadow:0 6px 18px -4px rgba(249,115,22,.32);} 
.mode-btn.orange:hover{filter:brightness(.97);}
.container{width:100%;max-width:1180px;margin:0 auto;padding:0 1.1rem 4rem;} 
.form-head{display:flex;align-items:center;flex-wrap:wrap;gap:.7rem;margin:.2rem 0 1rem;} .badge{background:var(--brand);color:#fff;font-size:.55rem;padding:.27rem .55rem;border-radius:999px;font-weight:600;letter-spacing:.5px;} 
.section{background:var(--bg-alt);border:1px solid var(--border);border-radius:20px;padding:1.05rem 1.15rem 1.3rem;box-shadow:var(--shadow);margin:0 0 1.25rem;position:relative;} .section h3{margin:0 0 .65rem;font-size:.83rem;letter-spacing:.6px;font-weight:700;display:flex;align-items:center;gap:.5rem;} .section h3 span.icon{font-size:1rem;} 
.grid{display:grid;gap:.85rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));} 
label.field{display:flex;flex-direction:column;gap:.3rem;font-size:.6rem;font-weight:600;letter-spacing:.5px;color:var(--text-soft);} 
label.field input, label.field select{padding:.6rem .7rem;border:1px solid var(--border);border-radius:12px;background:var(--bg);font-size:.72rem;color:var(--text);} 
.actions{display:flex;gap:.7rem;flex-wrap:wrap;margin-top:.5rem;} .btn{border:none;cursor:pointer;font-weight:600;font-size:.7rem;padding:.75rem 1.15rem;border-radius:12px;display:inline-flex;align-items:center;gap:.45rem;letter-spacing:.5px;} .btn.primary{background:linear-gradient(90deg,#2563eb,#1d4ed8);color:#fff;box-shadow:0 4px 14px -2px rgba(37,99,235,.45);} .btn.secondary{background:var(--bg-alt);border:1px solid var(--border);color:var(--text-soft);} .btn.danger{background:linear-gradient(90deg,#ef4444,#dc2626);color:#fff;} 
.notice{margin:.85rem 0 0;font-size:.65rem;color:var(--text-soft);} .alert{display:none;margin:.9rem 0 0;padding:.75rem .85rem;border-radius:14px;font-size:.65rem;border:1px solid transparent;} .alert.success{display:block;background:#dcfce7;border-color:#86efac;color:#166534;} .alert.error{display:block;background:#fee2e2;border-color:#fecaca;color:#991b1b;} 
.autofill{display:flex;gap:1.1rem;flex-wrap:wrap;font-size:.6rem;margin-top:.4rem;color:var(--text-soft);} .autofill label{display:flex;align-items:center;gap:.35rem;font-weight:600;} 
footer{margin:3rem 0 1.5rem;text-align:center;font-size:.55rem;color:var(--text-soft);} 
.required::after{content:' *';color:var(--danger);} 
/* invalid field highlight */
.invalid{border-color:var(--danger) !important;box-shadow:0 0 0 4px rgba(220,38,38,0.06) !important}
@media (max-width:640px){ .grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));} }
</style>
</head>
<body>
<header style="text-align:center;padding:1rem 1.2rem;">
  <div style="width:100%;max-width:900px;margin:0 auto;">
    <div style="font-weight:800;font-size:1.15rem;letter-spacing:.6px;">Feni Model High School</div>
    <h1 class="title" style="margin:.35rem 0 0">New Admission Application</h1>
    <div style="margin-top:.6rem;">
  <a href="download_form.html" class="mode-btn orange shadow-orange" title="Back to Dashboard">üîô Download application</a>
    </div>
  </div>
</header>
<div class="container">
  <div class="form-head">
    <span class="badge">Form</span>
    <p style="margin:0;font-size:.63rem;color:var(--text-soft)">Fill all required fields then save. Required marked with red *</p>
  </div>
  <!-- Admission Selection -->
  <div class="section" id="sec-admission">
    <h3><span class="icon">üéØ</span> Admission Selection</h3>
    <div class="grid">
      <label class="field required">Session
        <select id="session" required>
          <option value="">Select</option>
          <option>2025</option>
          <option>2026</option>
          <option>2027</option>

        </select>
      </label>
      <label class="field required">Admission Class
        <select id="admisson_class" required>
          <option value="">Select</option>
          <option>6</option>
          <option>7</option>
          <option>8</option>
          <option>9</option>
          <option>10</option>
        </select>
      </label>
      <label class="field required">Admission Section
        <select id="admission_section" required>
          <option value="">Select</option>
          <option>Day</option>
          <option>Morning</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Basic Information -->
  <div class="section" id="sec-basic">
    <h3><span class="icon">üßí</span> Basic Information</h3>
    <div class="grid">
      <label class="field required">Student Name English<input id="student_name_en" /></label>
      <label class="field">Student Name Bangla<input id="student_name_bn" /></label>
      <label class="field">Birth Registration<input id="birth_registration" /></label>
      <label class="field">Student Date of Birth<input id="student_dateofbirth" type="date" /></label>
      <label class="field">Religion<input id="religion" /></label>
      <label class="field required">Student Gender
        <select id="student_gender" required>
          <option value="">Select</option>
          <option>Male</option>
          <option>Female</option>
        </select>
      </label>
      <label class="field">Student Photo URL<input id="student_photo_url" placeholder="https://" /></label>
      <label class="field">Blood Group
        <select id="student_blood_group">
          <option value="">Select</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>O+</option><option>O-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Father Information -->
  <div class="section" id="sec-father">
    <h3><span class="icon">üë®</span> Father Information</h3>
    <div class="grid">
      <label class="field required">Father Name English<input id="father_name_en" /></label>
      <label class="field">Father Name Bangla<input id="father_name_bn" /></label>
      <label class="field">Father NID<input id="father_nid" /></label>
      <label class="field">Father Mobile<input id="father_mobile" type="tel" /></label>
      <label class="field">Father Occupation<input id="father_occupation" /></label>
      <label class="field">Father Date of Birth<input id="father_dob" type="date" /></label>
      <label class="field">Father Blood Group
        <select id="father_blood_group">
          <option value="">Select</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>O+</option><option>O-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Mother Information -->
  <div class="section" id="sec-mother">
    <h3><span class="icon">üë©</span> Mother Information</h3>
    <div class="grid">
      <label class="field">Mother Name English<input id="mother_name_en" /></label>
      <label class="field">Mother Name Bangla<input id="mother_name_bn" /></label>
      <label class="field">Mother NID<input id="mother_nid" /></label>
      <label class="field">Mother Mobile<input id="mother_mobile" type="tel" /></label>
      <label class="field">Mother Occupation<input id="mother_occupation" /></label>
      <label class="field">Mother Date of Birth<input id="mother_dob" type="date" /></label>
      <label class="field">Mother Blood Group
        <select id="mother_blood_group">
          <option value="">Select</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>O+</option><option>O-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Guardian Information -->
  <div class="section" id="sec-guardian">
    <h3><span class="icon">üõ°Ô∏è</span> Guardian Information</h3>
    <div class="autofill">
      <label><input type="checkbox" id="guardian_from_father" /> Father as Guardian</label>
      <label><input type="checkbox" id="guardian_from_mother" /> Mother as Guardian</label>
    </div>
    <div class="grid" style="margin-top:.6rem;">
      <label class="field">Guardian Name English<input id="guardian_name_en" /></label>
      <label class="field">Guardian Name Bangla<input id="guardian_name_bn" /></label>
      <label class="field">Guardian NID<input id="guardian_nid" /></label>
      <label class="field">Guardian Mobile<input id="guardian_mobile" type="tel" /></label>
      <label class="field">Guardian Occupation<input id="guardian_occupation" /></label>
    </div>
  </div>

  <!-- Address Information -->
  <div class="section" id="sec-address">
    <h3><span class="icon">üìç</span> Address Information</h3>
    <div class="grid">
      <label class="field required">District English
        <select id="district_en" required>
          <option value="">Select</option>
        </select>
      </label>
      <label class="field required">District Bangla
        <select id="district_bn" required>
          <option value="">Select</option>
        </select>
      </label>
      <label class="field">Upazila English
        <select id="upazilla_en">
          <option value="">Select</option>
        </select>
      </label>
      <label class="field">Upazila Bangla
        <select id="upazilla_bn">
          <option value="">Select</option>
        </select>
      </label>
      <label class="field">Union English
        <select id="union_en">
          <option value="">Select</option>
        </select>
      </label>
      <label class="field">Union Bangla
        <select id="union_bn">
          <option value="">Select</option>
        </select>
      </label>
      <label class="field">Post Office English<input id="postoffice_en" /></label>
      <label class="field">Post Office Bangla<input id="postoffice_bn" /></label>
      <label class="field">Village English<input id="village_en" /></label>
      <label class="field">Village Bangla<input id="village_bn" /></label>
    </div>
  </div>

  <!-- Additional Information -->
  <div class="section" id="sec-additional">
    <h3><span class="icon">‚ûï</span> Additional Information</h3>
    <div class="grid">
      <label class="field">Previous School<input id="previous_school" /></label>
      <label class="field">Previous Class Roll<input id="previous_class_roll" /></label>
      <label class="field">Quote Freedom Fighter
        <select id="quote_freedomfighter">
          <option value="">Select</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </label>
    </div>
  </div>

  <div class="actions">
  <button class="btn primary" id="saveBtn">‚úÖ Submit</button>
  
    <button class="btn secondary" id="resetBtn" type="button">üîÅ Reset</button>
  </div>
  <div id="alertBox" class="alert"></div>
  <p class="notice">After saving you can view / edit. Make sure sensitive data is correct after approval you can't edit.</p>
<footer>¬© <span id="year"></span> Feni Model High School ¬∑ Admission</footer>
</div>
<footer>¬© <span id="year"></span> Feni Model High School ¬∑ Admission</footer>
<script src="district.text"></script>
<script>

// unions.text is in PHP array(...) format. We don't include it directly because
// that would break the page as it's not valid JS. Instead we fetch and parse it
// into a JS array `window.unions` before initializing the dropdown population.

function parsePhpArrayText(txt){
  const unions = [];
  try{
    // Match each array(...) block
    const re = /array\s*\(([^\)]*)\)\s*,?/g;
    let m;
    while((m = re.exec(txt)) !== null){
      const inside = m[1];
      const obj = {};
      // match key => 'value' pairs
      const pairRe = /'([^']+)'\s*=>\s*'((?:\\'|[^'])*)'/g;
      let p;
      while((p = pairRe.exec(inside)) !== null){
        obj[p[1]] = p[2];
      }
      if(Object.keys(obj).length){
        unions.push({
          id: obj.id || '',
          upazila_id: obj.upazila_id || obj.upazila || obj.upazilaId || '',
          name: obj.name || '',
          bn_name: obj.bn_name || obj.bn || '',
          url: obj.url || ''
        });
      }
    }
  }catch(e){ console.warn('parsePhpArrayText error', e); }
  return unions;
}

// load unions.text if needed and then run population init (defined later)
(async function ensureUnionsAndInit(){
  if(typeof unions === 'undefined'){
    try{
      const txt = await fetch('unions.text').then(r=>r.text());
      window.unions = parsePhpArrayText(txt);
    }catch(e){ console.warn('Failed to fetch/parse unions.text', e); window.unions = []; }
  }
  // signal ready by leaving window.unions defined, the population code below
  // will be invoked after its function definition.
})();
// expose a promise so other scripts can await unions readiness
window.__unionsReady = (async function(){
  // wait until window.unions is set (or timeout after 5s)
  const start = Date.now();
  while(typeof window.unions === 'undefined'){
    if(Date.now() - start > 5000) { window.unions = []; break; }
    await new Promise(r=>setTimeout(r,50));
  }
  return window.unions;
})();


const SUPABASE_URL='https://rtfefxghfbtirfnlbucb.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';  
const TABLE='admission_data';

let supabaseClient=null; function initSupabase(){ if(supabaseClient) return supabaseClient; if(!window.supabase){ console.warn('Supabase lib not loaded yet'); return null;} supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY); return supabaseClient; }
// load supabase script
(function(){ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'; s.onload=()=>initSupabase(); document.head.appendChild(s); })();

function $(id){ return document.getElementById(id); }
function val(id){ return $(id).value.trim(); }
function setVal(id,v){ $(id).value=v||''; }
function showAlert(msg,type='error'){ const box=$('alertBox'); box.className='alert '+type; box.textContent=msg; }
function clearAlert(){ const box=$('alertBox'); box.className='alert'; box.textContent=''; }

// guardian autofill
$('guardian_from_father').addEventListener('change',()=>{ if($('guardian_from_father').checked){ copyParent('father','guardian'); $('guardian_from_mother').checked=false; } });
$('guardian_from_mother').addEventListener('change',()=>{ if($('guardian_from_mother').checked){ copyParent('mother','guardian'); $('guardian_from_father').checked=false; } });
function copyParent(src,dst){ const fields=['name_en','name_bn','nid','mobile','occupation']; fields.forEach(f=>{ setVal(dst+'_'+f, val(src+'_'+f)); }); }

function gatherPayload(){
  return {
    session:val('session')||null,
    admisson_class:val('admisson_class')||null,
    admission_section:val('admission_section')||null,
    student_name_en:val('student_name_en')||null,
    student_name_bn:val('student_name_bn')||null,
    birth_registration:val('birth_registration')||null,
    student_dateofbirth:val('student_dateofbirth')||null,
    religion:val('religion')||null,
    student_gender:val('student_gender')||null,
    student_photo_url:val('student_photo_url')||null,
    student_blood_group:val('student_blood_group')||null,
    father_name_en:val('father_name_en')||null,
    father_name_bn:val('father_name_bn')||null,
    father_nid:val('father_nid')||null,
    father_mobile:val('father_mobile')||null,
    father_occupation:val('father_occupation')||null,
    father_dob:val('father_dob')||null,
    father_blood_group:val('father_blood_group')||null,
    mother_name_en:val('mother_name_en')||null,
    mother_name_bn:val('mother_name_bn')||null,
    mother_nid:val('mother_nid')||null,
    mother_mobile:val('mother_mobile')||null,
    mother_occupation:val('mother_occupation')||null,
    mother_dob:val('mother_dob')||null,
    mother_blood_group:val('mother_blood_group')||null,
    guardian_name_en:val('guardian_name_en')||null,
    guardian_name_bn:val('guardian_name_bn')||null,
    guardian_nid:val('guardian_nid')||null,
    guardian_mobile:val('guardian_mobile')||null,
    guardian_occupation:val('guardian_occupation')||null,
    village_bn:val('village_bn')||null,
    village_en:val('village_en')||null,
    postoffice_bn:val('postoffice_bn')||null,
    postoffice_en:val('postoffice_en')||null,
    upazilla_bn:val('upazilla_bn')||null,
    upazilla_en:val('upazilla_en')||null,
    district_bn:val('district_bn')||null,
    district_en:val('district_en')||null,
    previous_school:val('previous_school')||null,
    previous_class_roll:val('previous_class_roll')||null,
    quote_freedomfighter:val('quote_freedomfighter')||null,
    union_bn:val('union_bn')||null,
    union_en:val('union_en')||null
  };
}

// Auto-set gender based on admission section
function syncGenderWithSection(){
  const section = $('admission_section');
  const gender = $('student_gender');
  if(!section || !gender) return;
  function apply(){
    const v = (section.value||'').toLowerCase();
    if(v==='day') { gender.value='Male'; }
    else if(v==='morning') { gender.value='Female'; }
    // else leave as selected
  }
  section.addEventListener('change', apply);
  // run once on load
  apply();
}
syncGenderWithSection();

async function save(stay){
  clearAlert();
  // validate all fields before saving
  if(!validateAll()){ return; }
  const sb=initSupabase(); if(!sb){ showAlert('Supabase not ready yet','error'); return; }
  const payload=gatherPayload();
  try{
    const { error } = await sb.from(TABLE).insert(payload);
    if(error) throw error;
  showAlert('Submitted successfully','success');
    if(!stay){ setTimeout(()=>{ window.location.href='admission_dashboard.html'; }, 900); }
    else { // reset minimal
      $('birth_registration').focus();
    }
  }catch(e){ console.error(e); showAlert('Save failed: '+(e.message||e),'error'); }
}

$('saveBtn').addEventListener('click',()=>save(false));
// saveNewBtn removed
$('resetBtn').addEventListener('click',()=>{ document.querySelectorAll('input,select').forEach(el=>{ if(el.type!=='checkbox') el.value=''; }); clearAlert(); });

// Validate every input/select/textarea (except checkboxes) inside the form container
function validateAll(){
  clearAlert();
  const container = document.querySelector('.container');
  if(!container) return true;
  const controls = Array.from(container.querySelectorAll('input,select,textarea')).filter(el=>el.type!=='checkbox');
  const missing = [];
  controls.forEach(el=>{
    const v = (el.value||'').toString().trim();
    if(!v){
      el.classList.add('invalid');
      if(missing.indexOf(el)===-1) missing.push(el);
    } else {
      el.classList.remove('invalid');
    }
  });
  if(missing.length){
    const first = missing[0];
    const label = first.closest('label.field');
    let labelText = first.id || '';
    if(label){
      const labSpan = label.querySelector('.label-text');
      if(labSpan) labelText = labSpan.textContent.replace('*','').trim();
      else {
        // fallback: use first text node
        const txt = Array.from(label.childNodes).find(n=>n.nodeType===3 && n.textContent.trim());
        labelText = txt? txt.textContent.trim(): label.innerText.trim();
      }
    }
    showAlert('Fill required: '+labelText,'error');
    try{ first.focus(); }catch(e){}
    return false;
  }
  return true;
}


// Clear invalid class when user interacts
document.addEventListener('input', e=>{ const t=e.target; if(t && (t.matches('input')||t.matches('select')||t.matches('textarea'))){ t.classList.remove('invalid'); } });
document.addEventListener('change', e=>{ const t=e.target; if(t && (t.matches('input')||t.matches('select')||t.matches('textarea'))){ t.classList.remove('invalid'); } });

function applyTheme(m){ document.documentElement.classList.toggle('dark',m==='dark'); }
// Guard theme toggle in case the element is not present on this page
const _themeToggleEl = $('themeToggle');
if(_themeToggleEl){
  _themeToggleEl.addEventListener('click',()=>{ const cur=localStorage.getItem('theme')==='dark'?'light':'dark'; localStorage.setItem('theme',cur); applyTheme(cur); });
}
applyTheme(localStorage.getItem('theme')|| (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
$('year').textContent=new Date().getFullYear();


// Auto-capitalize specific English fields (Title Case) while typing ‡¶¨‡ßú ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú
;(function autoCapitalizeFields(){
  const ids = ['student_name_en','father_name_en','father_occupation','mother_name_en','mother_occupation','village_en','postoffice_en','upazilla_en','district_en','previous_school'];
  function toTitleCase(s){ return s.replace(/\w\S*/g, txt=>txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()); }
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', (e)=>{
      const start = el.selectionStart; const end = el.selectionEnd;
      const newVal = toTitleCase(el.value);
      if(newVal!==el.value){ el.value=newVal; try{ el.setSelectionRange(start,end); }catch(e){} }
    });
  });
})();

// Populate district dropdowns (English + Bangla) and upazila mapping
;(async function populateDistrictsAndUpazilas(){
  // ensure unions have been loaded/parsed before building unionsByUpazila
  if(window.__unionsReady) await window.__unionsReady;

//districts & Upazillas take from district.text ** (code mover here)

  // build lookup: districtId => upazila list
  const upazilasByDistrict = {};
  upazilas.forEach(u=>{
    if(!upazilasByDistrict[u.district_id]) upazilasByDistrict[u.district_id]=[];
    // avoid duplicates by upazila id
    const exists = upazilasByDistrict[u.district_id].some(x=>x.id===u.id);
    if(!exists) upazilasByDistrict[u.district_id].push({id:u.id,name:u.name,bn_name:u.bn_name});
  });

  // build lookup: upazilaId => union list (from UnionSeeder.php data if provided as `unions`)
  const unionsByUpazila = {};
  if(typeof unions !== 'undefined' && Array.isArray(unions)){
    unions.forEach(r=>{
      const upId = r.upazila_id || r.upazila || r.upazilaId || '';
      if(!unionsByUpazila[upId]) unionsByUpazila[upId]=[];
      const exists = unionsByUpazila[upId].some(x=>x.id===r.id);
      if(!exists) unionsByUpazila[upId].push({id:r.id,name:r.name,bn_name:r.bn_name||r.bn});
    });
  }

  const selEn = document.getElementById('district_en');
  const selBn = document.getElementById('district_bn');
  const upEn = document.getElementById('upazilla_en');
  const upBn = document.getElementById('upazilla_bn');
  const unionEn = document.getElementById('union_en');
  const unionBn = document.getElementById('union_bn');
  if(!selEn || !selBn) return;

  const prevEn = selEn.value;
  const prevBn = selBn.value;

  // sort districts by English name (ascending) then populate district selects with id values
  districts.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'en', {sensitivity:'base'}));
  districts.forEach(d=>{
    const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; selEn.appendChild(o);
    const p=document.createElement('option'); p.value=d.id; p.textContent=d.bn; selBn.appendChild(p);
  });
  if(prevEn) selEn.value = prevEn;
  if(prevBn) selBn.value = prevBn;

  // two-way sync for district selects (keep same index)
  let _syncing = false;
  selEn.addEventListener('change', ()=>{
    if(_syncing) return;
    try{ _syncing = true; selBn.selectedIndex = selEn.selectedIndex; }finally{ _syncing = false; }
    populateUpazilas(selEn.value);
  });
  selBn.addEventListener('change', ()=>{
    if(_syncing) return;
    try{ _syncing = true; selEn.selectedIndex = selBn.selectedIndex; }finally{ _syncing = false; }
    populateUpazilas(selBn.value);
  });

  // two-way sync for upazila selects
  let _upSync = false;
  upEn.addEventListener('change', ()=>{ if(_upSync) return; try{ _upSync=true; upBn.selectedIndex=upEn.selectedIndex; }finally{ _upSync=false; } });
  upBn.addEventListener('change', ()=>{ if(_upSync) return; try{ _upSync=true; upEn.selectedIndex=upBn.selectedIndex; }finally{ _upSync=false; } });

  // two-way sync for union selects
  let _unionSync = false;
  if(unionEn && unionBn){
    unionEn.addEventListener('change', ()=>{ if(_unionSync) return; try{ _unionSync=true; unionBn.selectedIndex=unionEn.selectedIndex; }finally{ _unionSync=false; } });
    unionBn.addEventListener('change', ()=>{ if(_unionSync) return; try{ _unionSync=true; unionEn.selectedIndex=unionBn.selectedIndex; }finally{ _unionSync=false; } });
  }

  // populate upazilas on current selection if any
  function populateUpazilas(districtId){
    // clear upazila selects and add a consistent 'Select' placeholder (no hyphen)
  [upEn, upBn].forEach(s=>{ while(s.options.length>0) s.remove(0); const def=document.createElement('option'); def.value=''; def.textContent='Select'; s.appendChild(def); });
    // clear unions as well
  if(unionEn && unionBn){ [unionEn, unionBn].forEach(s=>{ while(s.options.length>0) s.remove(0); const def=document.createElement('option'); def.value=''; def.textContent='Select'; s.appendChild(def); }); }
    if(!districtId) return;
    let list = (upazilasByDistrict[districtId]||[]).slice();
    // sort upazilas by English name (ascending)
    list.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'en', {sensitivity:'base'}));
    list.forEach(u=>{
      const oe=document.createElement('option'); oe.value=u.id; oe.textContent=u.name; upEn.appendChild(oe);
      const ob=document.createElement('option'); ob.value=u.id; ob.textContent=u.bn_name; upBn.appendChild(ob);
    });
    // reset unions placeholder to 'Select' (no hyphen)
  if(unionEn && unionBn){ const def1=document.createElement('option'); def1.value=''; def1.textContent='Select'; unionEn.appendChild(def1); const def2=document.createElement('option'); def2.value=''; def2.textContent='Select'; unionBn.appendChild(def2); }
  }

  // Populate unions for selected upazila
  function populateUnions(upazilaId){
    if(!unionEn || !unionBn) return;
  [unionEn, unionBn].forEach(s=>{ while(s.options.length>0) s.remove(0); const d=document.createElement('option'); d.value=''; d.textContent='-'; s.appendChild(d); });
    if(!upazilaId) return;
    const list = (unionsByUpazila[upazilaId]||[]).slice();
    list.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'en', {sensitivity:'base'}));
    list.forEach(u=>{
      const oe=document.createElement('option'); oe.value=u.id; oe.textContent=u.name; unionEn.appendChild(oe);
      const ob=document.createElement('option'); ob.value=u.id; ob.textContent=u.bn_name; unionBn.appendChild(ob);
    });
  }

  // initial population if a district was preselected
  const curDistrict = selEn.value || selBn.value;
  if(curDistrict) populateUpazilas(curDistrict);
  // when upazila changes, populate unions
  upEn.addEventListener('change', ()=>{ populateUnions(upEn.value); });
  upBn.addEventListener('change', ()=>{ populateUnions(upBn.value); });
})();
</script>

</body>
</html>
