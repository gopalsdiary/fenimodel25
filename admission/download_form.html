<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Download Application Form</title>
<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
<style>
body{margin:0;font-family:'Noto Sans Bengali',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;background:#f5f7fb;color:#1f2d3d;}header{padding:14px 20px;border-bottom:4px double #1f2d3d;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;background:#fff;}h1{font-size:1.35rem;margin:0;letter-spacing:.5px;text-transform:uppercase;font-weight:800;} .sub{font-size:.7rem;font-weight:600;letter-spacing:1px;color:#334155;margin-top:4px;} .top-actions{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;}button, input{font-family:inherit;} .btn{cursor:pointer;border:1px solid #334155;background:#1e3a8a;color:#fff;padding:.55rem .9rem;border-radius:8px;font-size:.65rem;font-weight:600;letter-spacing:.5px;display:inline-flex;align-items:center;gap:.35rem;} .btn.outline{background:#fff;color:#1f2d3d;} .search-box{display:flex;align-items:center;gap:.4rem;background:#fff;padding:.45rem .6rem;border:1px solid #cbd5e1;border-radius:10px;} .search-box input{border:none;outline:none;font-size:.7rem;min-width:190px;} main{padding:18px 26px;max-width:900px;margin:0 auto;} #formContainer{background:#fff;border:1px solid #cbd5e1;box-shadow:0 4px 18px -4px rgba(0,0,0,.07);padding:26px 30px;border-radius:18px;min-height:400px;position:relative;}
@media print{body{background:#fff;} header{border:none;padding:6px 0;margin-bottom:6px;} .top-actions{display:none!important;} .search-box{display:none!important;} main{padding:0;max-width:100%;} #formContainer{box-shadow:none;border:none;padding:0;} }
</style>
</head>
<body>
	<header>
		<div>
			<h1>Feni Model High School</h1>
			<div class="sub">Admission Application Form</div>
		</div>
		<div class="top-actions">
			<div class="search-box">
				<input id="birthInput" placeholder="Birth Registration Number" />
				<button class="btn outline" id="loadBtn">Load</button>
			</div>
			<button class="btn" id="printBtn">‚¨áÔ∏è Download PDF</button>
		</div>
	</header>
	<main>
		<div id="status" style="font-size:.7rem;color:#475569;margin-bottom:10px;">Enter birth registration number then click Load.</div>
		<div id="formContainer"></div>
	</main>
<script>
const SUPABASE_URL='https://rtfefxghfbtirfnlbucb.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
let sb=null; function init(){ if(sb) return sb; if(!window.supabase){ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'; s.onload=()=>{ try{ sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY); }catch(e){ console.error('Supabase init failed',e); setStatus('Supabase init failed: '+(e.message||e)); } }; s.onerror=()=>{ console.error('Failed to load Supabase script'); setStatus('Failed to load Supabase library'); }; document.head.appendChild(s); } else { try{ sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY); }catch(e){ console.error('Supabase init failed',e); setStatus('Supabase init failed: '+(e.message||e)); } } }
init();
const statusEl=document.getElementById('status');
const birthInput=document.getElementById('birthInput');
const formContainer=document.getElementById('formContainer');
let lastLoadedRecord = null;
document.getElementById('printBtn').addEventListener('click',()=>generatePdf());
document.getElementById('loadBtn').addEventListener('click',loadApplication);
birthInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ loadApplication(); }});

function setStatus(msg,type='info'){ statusEl.textContent=msg; statusEl.style.color= type==='error'? '#b91c1c':'#475569'; }

async function loadApplication(){
	const br=birthInput.value.trim();
	if(!br){ setStatus('Enter a birth registration number first','error'); return; }
	setStatus('Loading...'); formContainer.innerHTML='<div style="font-size:.7rem;color:#475569;">Fetching data...</div>';
		if(!sb){ setTimeout(loadApplication,300); init(); return; }
	try{
		const { data, error } = await sb.from('admission_data').select('*').eq('birth_registration',br).limit(1);
		if(error) { console.error('Supabase query error', error); setStatus('Error loading: '+(error.message||JSON.stringify(error)),'error'); throw error; }
		if(!data || !data.length){ setStatus('No application found for this birth registration','error'); formContainer.innerHTML=''; return; }
		render(data[0]);
	lastLoadedRecord = data[0];
		setStatus('Loaded application. You can download PDF.');
		}catch(e){ console.error('Fetch exception', e); try{ setStatus('Error loading: '+(e.message||JSON.stringify(e)),'error'); }catch(_){ setStatus('Error loading (see console)','error'); } formContainer.innerHTML=''; }
}

// load html2pdf.js on demand
function loadHtml2Pdf(){
	if(window.html2pdf) return Promise.resolve();
	return new Promise((resolve,reject)=>{
		const s=document.createElement('script');
		s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js';
		s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Failed to load html2pdf'));
		document.head.appendChild(s);
	});
}

// Ensure html2canvas and jsPDF available for fallback single-image PDF creation
function ensureCanvasAndJsPdf(){
	const jobs = [];
	if(!window.html2canvas){ jobs.push(new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); })); }
	if(!window.jspdf && !window.jsPDF){ jobs.push(new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); })); }
	return Promise.all(jobs);
}

async function generatePdf(){
	const root=document.getElementById('sheetRoot');
	if(!root){ setStatus('No sheet available to download','error'); return; }
	// ensure layout scaled to fit A4
	ensureFitOnA4();
	try{
		await loadHtml2Pdf();
	}catch(e){ console.error(e); setStatus('PDF library failed to load, opening print dialog','error'); window.print(); return; }
	// small delay to allow any transform/paint
	await new Promise(r=>setTimeout(r,120));
	const filename = 'admission_' + (lastLoadedRecord && lastLoadedRecord.birth_registration ? lastLoadedRecord.birth_registration : new Date().getTime()) + '.pdf';
	const opt = {
		margin: [8,8,8,8], // mm
		filename: filename,
		image: { type: 'jpeg', quality: 0.95 },
		html2canvas: { scale: 2, useCORS: true, logging: false },
		jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
	};
	try{
			// Try to produce a PDF via html2pdf, but if it would paginate, fall back to rendering
			// the sheet to a single image and embedding that in a one-page jsPDF to guarantee
			// a single-page output that matches the visible sheet.
			try{
				const worker = html2pdf().set(opt).from(root);
				// produce pdf object without immediately saving
				worker.toPdf().get('pdf').then(async (pdf)=>{
					try{
						const num = (pdf.internal && pdf.internal.getNumberOfPages) ? pdf.internal.getNumberOfPages() : 1;
						if(num <= 1){
							pdf.save(filename);
							setStatus('PDF ready');
							return;
						}
					}catch(e){ console.warn('Could not determine page count, falling back', e); }
					// fallback: render to canvas then create single-page pdf
					try{
						const canvas = await html2canvas(root, {scale:2, useCORS:true});
						const imgData = canvas.toDataURL('image/jpeg',0.95);
						// create a fresh one-page PDF
						const single = (typeof jspdf !== 'undefined' && jspdf.jsPDF) ? new jspdf.jsPDF({unit:'mm',format:'a4',orientation:'portrait'}) : (typeof jsPDF !== 'undefined' ? new jsPDF('p','mm','a4') : null);
						if(!single){ console.error('jsPDF not available'); worker.save(); setStatus('Could not create single-page PDF, opening print dialog','error'); window.print(); return; }
						const pw = single.internal.pageSize.getWidth();
						const ph = single.internal.pageSize.getHeight();
						single.addImage(imgData, 'JPEG', 0, 0, pw, ph);
						single.save(filename);
						setStatus('Single-page PDF ready');
					}catch(e){ console.error('Fallback PDF generation failed',e); setStatus('PDF generation failed, opening print dialog','error'); window.print(); }
				}).catch(e=>{ console.error('toPdf/get error', e); setStatus('PDF conversion failed, opening print dialog','error'); window.print(); });
			}catch(e){ console.error('html2pdf error',e); setStatus('PDF generation failed, opening print dialog','error'); window.print(); }
	}catch(e){ console.error('PDF generation failed',e); setStatus('PDF generation failed, opening print dialog','error'); window.print(); }
}

function field(label,value){ value=value==null||value===''?'‚Äî':value; return `<div class="f"><span class="l">${label}</span><span class="v">${escapeHtml(value)}</span></div>`; }
function escapeHtml(str){ return String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

function render(o){
	// Build grouped sections mirroring new_admission.html
	const groups = [
		{ title: 'Admission Selection', fields: [
			['Session', o.session], ['Admission Class', o.admisson_class], ['Admission Section', o.admission_section]
		]},
		{ title: 'Basic Information', fields: [
			['Student Name English', o.student_name_en], ['Student Name Bangla', o.student_name_bn], ['Birth Registration', o.birth_registration], ['Student Date of Birth', o.student_dateofbirth], ['Religion', o.religion], ['Student Gender', o.student_gender], ['Student Photo URL', o.student_photo_url], ['Blood Group', o.student_blood_group]
		]},
		{ title: 'Father Information', fields: [
			['Father Name English', o.father_name_en], ['Father Name Bangla', o.father_name_bn], ['Father NID', o.father_nid], ['Father Mobile', o.father_mobile], ['Father Occupation', o.father_occupation], ['Father Date of Birth', o.father_dob], ['Father Blood Group', o.father_blood_group]
		]},
		{ title: 'Mother Information', fields: [
			['Mother Name English', o.mother_name_en], ['Mother Name Bangla', o.mother_name_bn], ['Mother NID', o.mother_nid], ['Mother Mobile', o.mother_mobile], ['Mother Occupation', o.mother_occupation], ['Mother Date of Birth', o.mother_dob], ['Mother Blood Group', o.mother_blood_group]
		]},
		{ title: 'Guardian Information', fields: [
			['Guardian Name English', o.guardian_name_en], ['Guardian Name Bangla', o.guardian_name_bn], ['Guardian NID', o.guardian_nid], ['Guardian Mobile', o.guardian_mobile], ['Guardian Occupation', o.guardian_occupation]
		]},
		{ title: 'Address Information', fields: [
			['District English', o.district_en], ['District Bangla', o.district_bn], ['Upazila English', o.upazilla_en], ['Upazila Bangla', o.upazilla_bn], ['Union English', o.union_en], ['Union Bangla', o.union_bn], ['Post Office English', o.postoffice_en], ['Post Office Bangla', o.postoffice_bn], ['Village English', o.village_en], ['Village Bangla', o.village_bn]
		]},
		{ title: 'Additional Information', fields: [
			['Previous School', o.previous_school], ['Previous Class Roll', o.previous_class_roll], ['Quote Freedom Fighter', o.quote_freedomfighter], ['Optional Subject', o.optional_subject]
		]}
	];

	// helper to render a group's two-column layout
	function renderGroup(g){
		const half = Math.ceil(g.fields.length/2);
		const left = g.fields.slice(0,half).map(([l,v])=>field(l,v)).join('');
		const right = g.fields.slice(half).map(([l,v])=>field(l,v)).join('');
		return `
			<div class="group section">
				<h3><span class="icon">üìÑ</span> ${escapeHtml(g.title)}</h3>
				<div class="cols" style="margin-top:6px">
					<section>${left}</section>
					<section>${right}</section>
				</div>
			</div>`;
	}

	// assemble html
	const groupsHtml = groups.map(renderGroup).join('');
	formContainer.innerHTML = `
		<div class="sheet" id="sheetRoot">
			<div class="sheet-head">
				<div class="school">Feni Model High School</div>
				<div class="subtitle">Admission Application (${o.session||''})</div>
				<div class="meta">Birth Registration: <strong>${escapeHtml(o.birth_registration||'')}</strong></div>
			</div>
			${groupsHtml}
			<div class="sign-row" style="margin-top:8px"><div>Guardian Signature: ____________________</div><div>Student Signature: ____________________</div><div>Date: _____________</div></div>
		</div>`;
	ensureFitOnA4();
}

function ensureFitOnA4(){
	const root=document.getElementById('sheetRoot');
	if(!root) return; // approximate available height for content (A4 ~ 1122px at 96dpi minus margins)
	requestAnimationFrame(()=>{
		const h=root.offsetHeight; if(h>1000){ root.style.transformOrigin='top left'; const scale=1000/h; root.style.transform=`scale(${scale.toFixed(3)})`; } });
}

// dynamic styles for A4
const style=document.createElement('style');
style.textContent=`
	/* Portrait A4 sheet styling (compact) */
	.sheet{position:relative;box-sizing:border-box;width:210mm;max-width:100%;margin:0 auto;background:linear-gradient(180deg, rgba(255,243,205,0.18), rgba(255,255,255,0.98));padding:14mm 12mm;border-radius:4px;box-shadow:0 6px 20px rgba(2,6,23,.06);font-family:inherit;color:#0b1220}
	.sheet-head{text-align:center;margin-bottom:8px;border-bottom:1px solid rgba(15,23,42,0.035);padding-bottom:8px}
	.sheet-head .school{font-size:18px;font-weight:800;letter-spacing:.4px;color:#92400e}
	.sheet-head .subtitle{font-size:12px;font-weight:700;margin-top:3px;color:#6b4226}
	.sheet-head .meta{font-size:11px;margin-top:4px;color:#475569}
	.cols{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
	section{background:transparent;border-radius:4px;padding:4px 2px}
	.f{display:flex;font-size:11px;padding:4px 4px;border-bottom:1px dashed #f1f6fb;gap:6px;align-items:flex-start;line-height:1.15}
	.f:last-child{border-bottom:none}
	.f .l{flex:0 0 130px;font-weight:700;color:#92400e;font-size:11px}
	.f .v{flex:1;color:#0f172a;font-size:11px}
	.group.section{margin-bottom:6px;padding:6px 0}
	.group.section h3{font-size:12px;margin:0 0 6px}
	.sign-row{display:flex;justify-content:space-between;font-size:11px;margin-top:12px;gap:8px}
	/* Responsive for small screens */
	@media (max-width:760px){ .cols{grid-template-columns:1fr} .sheet{padding:10mm} .f .l{flex-basis:110px} }
	/* Print rules - portrait A4 */
	@media print{ html,body{background:#fff} @page{size:A4 portrait;margin:12mm} body{margin:0} .sheet{box-shadow:none;border-radius:0;padding:8mm 10mm;width:100%;} .top-actions{display:none!important} }
`;
document.head.appendChild(style);
</script>
</body>
</html>
