<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
  <title>Button Settings - Create & Edit</title>
  <style>
  /* reduce base font size by 20% and use Kalpurush font */
  html{font-size:80%;}
    body{font-family: 'Kalpurush', Arial, Helvetica, sans-serif; padding:16px}
    table{width:100%;border-collapse:collapse;margin-top:12px;table-layout:auto}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:middle;white-space:nowrap}
    th{background:#f4f4f4}
  /* zebra striping */
  tbody tr:nth-child(odd){ background:#ffffff }
  tbody tr:nth-child(even){ background:#f5f5f5 }
    .btn{padding:6px 10px;border:none;background:#0b74de;color:#fff;border-radius:4px;cursor:pointer}
    .btn.secondary{background:#6c757d}
    .btn.success{background:#28a745}
    .btn.danger{background:#dc3545}
  .row-update-status{font-weight:600;font-size:13px;margin-left:8px}
    /* modal */
    .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal .panel{background:#fff;padding:16px;border-radius:6px;max-width:500px;width:100%;max-height:80vh;overflow:auto}
    .field-row{display:flex;gap:8px;margin-bottom:12px;align-items:center}
    .field-row label{min-width:140px;font-weight:600}
    .field-row input, .field-row select{flex:1;padding:8px;border:1px solid #ccc;border-radius:4px}
    .notice{margin-top:8px;color:#a00}
    .error-details{font-family:monospace;font-size:12px;color:#900;margin-top:6px}
    /* status badges */
    .status-active{color:#28a745;font-weight:600}
    .status-deactive{color:#dc3545;font-weight:600}
    /* SL (serial) column small */
    .col-sl{width:56px;max-width:56px;padding:4px;text-align:center}
  </style>
</head>
<body>
  <h2>Button Settings - বাটন তৈরি ও সম্পাদনা</h2>
  <div>
    <button id="createBtn" class="btn success">+ নতুন বাটন তৈরি করুন</button>
    <span id="status" style="margin-left:12px;color:#444"></span>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th class="col-sl">SL</th>
        <th>Button Name</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Create/Edit modal -->
  <div id="editModal" class="modal">
    <div class="panel">
      <h3 id="modalTitle">Create New Button</h3>

      <div class="field-row">
        <label>Button Name:</label>
        <input type="text" id="buttonName" placeholder="Enter button name">
      </div>

      <div class="field-row">
        <label>Status:</label>
        <select id="buttonStatus">
          <option value="Active">Active</option>
          <option value="Deactive">Deactive</option>
        </select>
      </div>

      <div style="text-align:right;margin-top:12px">
        <button id="cancelBtn" class="btn secondary">Cancel</button>
        <button id="saveBtn" class="btn">Save</button>
      </div>
      <div id="modalNotice" class="notice"></div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./auth-check_copy.js"></script>

  <script>
    
    // Use the same project URL used elsewhere in this repo
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    // For security, set supabaseKey via window.SUPABASE_ANON_KEY or input
    const supabaseKey = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    // Reuse existing Supabase client or create new one
    if (!window.supabaseClient) {
      window.__supabaseClients = window.__supabaseClients || {};
      window.supabaseClient = window.__supabaseClients[supabaseUrl] || window.supabase.createClient(supabaseUrl, supabaseKey);
      window.__supabaseClients[supabaseUrl] = window.supabaseClient;
    }
    const supabaseClient = window.supabaseClient;

    const tableName = 'button_status';
    
    const tbody = document.querySelector('#dataTable tbody');
    const statusEl = document.getElementById('status');
    const createBtn = document.getElementById('createBtn');
    const editModal = document.getElementById('editModal');
    const modalTitle = document.getElementById('modalTitle');
    const buttonNameInput = document.getElementById('buttonName');
    const buttonStatusSelect = document.getElementById('buttonStatus');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const modalNotice = document.getElementById('modalNotice');

    let allButtons = [];
    let editingButtonId = null; // null for create, number for edit

    // Event listeners
    createBtn.addEventListener('click', openCreateModal);
    cancelBtn.addEventListener('click', closeModal);
    saveBtn.addEventListener('click', saveButton);

    // Load all buttons from database
    async function loadButtons(){
      statusEl.textContent = 'Loading buttons...';
      try{
        const { data, error } = await supabaseClient
          .from(tableName)
          .select('*')
          .order('user_iid', { ascending: true });
          
        if(error) throw new Error(error.message || 'Unknown error');
        
        allButtons = data || [];
        renderTable();
        statusEl.textContent = `Total buttons: ${allButtons.length}`;
      }catch(err){
        console.error('loadButtons error:', err);
        statusEl.textContent = 'Error loading buttons: ' + (err.message || err);
        tbody.innerHTML = `<tr><td colspan="4">Error loading data: ${escapeHtml(err.message || err)}</td></tr>`;
      }
    }

    // Render table with all buttons
    function renderTable(){
      if(!allButtons || allButtons.length === 0){
        tbody.innerHTML = '<tr><td colspan="4">No buttons found. Create your first button!</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      allButtons.forEach((btn, index) => {
        const tr = document.createElement('tr');

        // SL column
        const slTd = document.createElement('td');
        slTd.className = 'col-sl';
        slTd.textContent = index + 1;
        tr.appendChild(slTd);

        // Button Name column
        const nameTd = document.createElement('td');
        nameTd.textContent = btn.button_name || '';
        tr.appendChild(nameTd);

        // Status column
        const statusTd = document.createElement('td');
        const statusSpan = document.createElement('span');
        statusSpan.textContent = btn.button_status || '';
        statusSpan.className = btn.button_status === 'Active' ? 'status-active' : 'status-deactive';
        statusTd.appendChild(statusSpan);
        tr.appendChild(statusTd);

        // Actions column
        const actionsTd = document.createElement('td');
        const editButton = document.createElement('button');
        editButton.className = 'btn';
        editButton.textContent = 'Edit';
        editButton.addEventListener('click', () => openEditModal(btn));
        
        const deleteButton = document.createElement('button');
        deleteButton.className = 'btn danger';
        deleteButton.textContent = 'Delete';
        deleteButton.style.marginLeft = '8px';
        deleteButton.addEventListener('click', () => deleteButton_(btn.user_iid));
        
        actionsTd.appendChild(editButton);
        actionsTd.appendChild(deleteButton);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
      });
    }

    // Open create modal
    function openCreateModal(){
      editingButtonId = null;
      modalTitle.textContent = 'Create New Button';
      buttonNameInput.value = '';
      buttonStatusSelect.value = 'Active';
      modalNotice.textContent = '';
      editModal.style.display = 'flex';
    }

    // Open edit modal
    function openEditModal(btn){
      editingButtonId = btn.user_iid;
      modalTitle.textContent = 'Edit Button';
      buttonNameInput.value = btn.button_name || '';
      buttonStatusSelect.value = btn.button_status || 'Active';
      modalNotice.textContent = '';
      editModal.style.display = 'flex';
    }

    // Close modal
    function closeModal(){
      editModal.style.display = 'none';
      editingButtonId = null;
      buttonNameInput.value = '';
      buttonStatusSelect.value = 'Active';
      modalNotice.textContent = '';
    }

    // Save button (create or update)
    async function saveButton(){
      const buttonName = buttonNameInput.value.trim();
      const buttonStatus = buttonStatusSelect.value;

      if(!buttonName){
        modalNotice.style.color = '#a00';
        modalNotice.textContent = 'Button name is required';
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      modalNotice.textContent = '';

      try{
        if(editingButtonId === null){
          // Create new button
          const { data, error } = await supabaseClient
            .from(tableName)
            .insert({
              button_name: buttonName,
              button_status: buttonStatus
            })
            .select();

          if(error) throw new Error(error.message || 'Unknown error');
          
          modalNotice.style.color = 'green';
          modalNotice.textContent = 'Button created successfully!';
        } else {
          // Update existing button
          const { data, error } = await supabaseClient
            .from(tableName)
            .update({
              button_name: buttonName,
              button_status: buttonStatus
            })
            .eq('user_iid', editingButtonId);

          if(error) throw new Error(error.message || 'Unknown error');
          
          modalNotice.style.color = 'green';
          modalNotice.textContent = 'Button updated successfully!';
        }

        // Reload and close
        await loadButtons();
        setTimeout(() => closeModal(), 700);

      }catch(err){
        console.error('saveButton error:', err);
        modalNotice.style.color = '#a00';
        modalNotice.textContent = 'Error: ' + (err.message || err);
      }finally{
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }

    // Delete button
    async function deleteButton_(buttonId){
      if(!confirm('Are you sure you want to delete this button?')) return;

      statusEl.textContent = 'Deleting...';
      try{
        const { error } = await supabaseClient
          .from(tableName)
          .delete()
          .eq('user_iid', buttonId);

        if(error) throw new Error(error.message || 'Unknown error');

        await loadButtons();
        statusEl.textContent = 'Button deleted successfully';
        setTimeout(() => {
          statusEl.textContent = `Total buttons: ${allButtons.length}`;
        }, 2000);

      }catch(err){
        console.error('deleteButton error:', err);
        statusEl.textContent = 'Error deleting button: ' + (err.message || err);
      }
    }

    function escapeHtml(s){
      if(s === null || s === undefined) return '';
      return String(s).replace(/[&<>\\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\\"':'&quot;',"'":'&#39;'}[c]));
    }

    // Close modal when clicking outside panel
    editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeModal(); });

    // Load buttons on page load
    loadButtons();
  </script>
</body>
</html>
