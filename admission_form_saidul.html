<!DOCTYPE html>
<html lang="bn">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admission Form</title>
  <link rel="icon" href="../logo2.png" />
  <link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Kalpurush', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .form-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .form-header h1 {
      font-size: 28px;
      margin-bottom: 5px;
      font-weight: 700;
    }

    .form-header p {
      font-size: 18px;
      opacity: 0.95;
      font-family: 'Kalpurush', sans-serif;
    }

    .form-body {
      padding: 40px;
    }

    /* Photo Upload Section */
    .photo-section {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
    }

    .photo-section h3 {
      color: white;
      font-size: 20px;
      margin-bottom: 20px;
      font-family: 'Kalpurush', sans-serif;
    }

    .photo-upload-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .photo-preview {
      width: 150px;
      height: 180px;
      border: 4px solid white;
      border-radius: 10px;
      overflow: hidden;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview-placeholder {
      color: #999;
      font-size: 14px;
      text-align: center;
      padding: 10px;
    }

    .photo-upload-btn {
      background: white;
      color: #764ba2;
      padding: 12px 30px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .photo-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    #studentPhoto {
      display: none;
    }

    /* Form Sections */
    .form-section {
      margin-bottom: 35px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
      font-family: 'Kalpurush', sans-serif;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    label .bangla {
      font-family: 'Kalpurush', sans-serif;
      color: #64748b;
      font-weight: 500;
      font-size: 13px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Inter', 'Kalpurush', sans-serif;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input:hover,
    select:hover,
    textarea:hover {
      border-color: #cbd5e1;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px;
      padding-right: 40px;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: 'Kalpurush', sans-serif;
    }

    .radio-group,
    .checkbox-group {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 5px;
    }

    .radio-option,
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .radio-option input[type="radio"],
    .checkbox-option input[type="checkbox"] {
      width: auto;
      cursor: pointer;
      accent-color: #667eea;
    }

    /* Button Section */
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 40px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    /* Required field indicator */
    .required {
      color: #ef4444;
      font-weight: bold;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-body {
        padding: 25px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }

    /* Success Message */
    .success-message {
      display: none;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Student List Section Styles */
    .student-list-container {
      margin-top: 40px;
      border-top: 2px dashed #e2e8f0;
      padding-top: 40px;
    }

    .student-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      position: relative;
    }

    .student-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #667eea;
    }

    .student-card h4 {
      color: #334155;
      margin-bottom: 5px;
    }

    .student-card p {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 3px;
    }

    .student-card .btn-edit {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #667eea;
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Improved Mobile Responsiveness */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .container {
        border-radius: 15px;
      }
      .form-header {
        padding: 20px;
      }
      .form-header h1 {
        font-size: 22px;
      }
      .form-body {
        padding: 20px;
      }
      .photo-preview {
        width: 120px;
        height: 150px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="form-header">
      <h1>Student ID Card Form</h1>
    </div>

    <div class="form-body">
      <div id="successMessage" class="success-message">
        Form submitted successfully!
      </div>

      <form id="admissionForm">
        <input type="hidden" id="editingId" name="iid">
        <input type="hidden" id="existingPhoto" name="existing_photo_url">
        <!-- Photo Upload Section -->
        <div class="photo-section">
          <h3>‡¶õ‡¶æ‡¶§‡ßç‡¶∞/‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶õ‡¶¨‡¶ø</h3>
          <div class="photo-upload-wrapper">
            <div class="photo-preview" id="photoPreview">
              <div class="photo-preview-placeholder">Upload Photo</div>
            </div>
            <input type="file" id="studentPhoto" name="studentPhoto" accept="image/*">
            <button type="button" class="photo-upload-btn" onclick="document.getElementById('studentPhoto').click()">
              üì∏ Select picture
            </button>
          </div>
        </div>

        <input type="hidden" name="session" value="2025">

        <div class="form-section">
          <h2 class="section-title">Admission Information</h2>
          <div class="form-grid">
            <div class="form-group">
              <label>Class</label>
              <select id="admissionClass" name="class_2025" required>
                <option value="">Select Class</option>
                <option value="Play">Play</option>
                <option value="Nursary">Nursary</option>
                <option value="KG1">KG 1</option>
                <option value="KG2">KG 2</option>
                <option value="KG3">KG 3</option>
                <option value="KG4">KG 4</option>
                <option value="KG5">KG 5</option>
              </select>
            </div>

            <div class="form-group">
              <label>Roll No</label>
              <input type="number" id="roll_2025" name="roll_2025" placeholder="Enter Roll Number">
            </div>

            <div class="form-group">
              <label>Student Name (English)</label>
              <input type="text" id="studentNameEn" name="student_name_en" placeholder="Enter name in English" required>
            </div>

            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" id="dateOfBirth" name="student_dateofbirth">
            </div>

            <div class="form-group">
              <label>Valid Till</label>
              <input type="text" id="validTill" name="valid_till" placeholder="e.g., December 2025">
            </div>

            <div class="form-group">
              <label>Gender</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="male" name="student_gender" value="Male">
                  <label for="male" style="margin: 0;">Male</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="female" name="student_gender" value="Female">
                  <label for="female" style="margin: 0;">Female</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="other" name="student_gender" value="Other">
                  <label for="other" style="margin: 0;">Other</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Father's Name (English)</label>
              <input type="text" id="fatherNameEn" name="father_name_en" placeholder="Enter father's name in English" required>
            </div>

            <div class="form-group">
              <label>Father's Mobile</label>
              <input type="tel" id="fatherMobile" name="father_mobile" placeholder="01XXXXXXXXX" pattern="[0-9]{11}" maxlength="11">
            </div>

            <div class="form-group">
              <label>Mother's Name (English)</label>
              <input type="text" id="motherNameEn" name="mother_name_en" placeholder="Enter mother's name in English">
            </div>

            <div class="form-group full-width">
              <label>Full Address</label>
              <textarea id="fullAddress" name="full_address" placeholder="Enter full address" rows="3"></textarea>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button type="submit" class="btn btn-primary">‚úì Submit</button>
          <button type="button" class="btn btn-secondary" onclick="printForm()">üñ®Ô∏è Print</button>
          <button type="button" class="btn btn-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" onclick="toggleList()">üìã ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
          <button type="button" id="cancelEditBtn" class="btn btn-danger" style="display:none;">Cancel Edit</button>
        </div>
      </form>

      <!-- Student List Section -->
      <div id="studentListSection" class="student-list-container" style="display: none; margin-top: 40px; border-top: 2px dashed #e2e8f0; padding-top: 40px;">
        <h2 class="section-title">‡¶õ‡¶æ‡¶§‡ßç‡¶∞-‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
        <div id="loadingMessage" style="text-align: center; padding: 20px; color: #667eea;">Loading...</div>
        <div id="studentListResults" style="overflow-x: auto;"></div>
      </div>

    </div>
  </div>

  <script>

const SUPABASE_URL='https://rtfefxghfbtirfnlbucb.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';  
const TABLE='saidul_database';



// ImageBB Configuration
const IMGBB_API_KEY = '4d2cdd03bb1da4404f875c22f0bfdf31';
const IMGBB_UPLOAD_URL = 'https://api.imgbb.com/1/upload';

// Upload photo to ImageBB
async function uploadPhotoToImageBB(file) {
  if (!file) return null;
  const formData = new FormData();
  formData.append('image', file);
  formData.append('key', IMGBB_API_KEY);
  
  try {
    const response = await fetch(IMGBB_UPLOAD_URL, {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    if (data.success) {
      return data.data.url;
    }
    throw new Error('ImageBB upload failed');
  } catch (err) {
    console.error('ImageBB upload error:', err);
    return null;
  }
}

// Form Submission Handler with Supabase
document.getElementById('admissionForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = this;
  const submitBtn = form.querySelector('button[type="submit"]');
  const successMsg = document.getElementById('successMessage');
  
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Uploading...';
    
    // Upload photo first if exists
    const photoFile = document.getElementById('studentPhoto').files[0];
    let photoUrl = null;
    if (photoFile) {
      successMsg.textContent = 'Uploading photo...';
      successMsg.style.display = 'block';
      photoUrl = await uploadPhotoToImageBB(photoFile);
    }
    
    // Collect form data
    const formData = new FormData(form);

    // Helper to uppercase English string values (return null when empty)
    const toUpperIf = v => v ? String(v).trim().toUpperCase() : null;

    // Normalize father's mobile: ensure +88 prefix when saving
    const rawFatherMobile = formData.get('father_mobile') || '';
    const digitsOnly = rawFatherMobile.replace(/\D/g, ''); // remove non-digits
    const digitsWithCountry = digitsOnly ? (digitsOnly.startsWith('88') ? digitsOnly : '88' + digitsOnly) : null; // e.g. 8801...
    const fatherMobilePlus = digitsWithCountry ? ('+' + digitsWithCountry) : null; // +8801...
    const fatherMobileNumeric = digitsWithCountry ? Number(digitsWithCountry) : null; // 8801...

    const data = {
      student_name_en: toUpperIf(formData.get('student_name_en')),
      student_dateofbirth: formData.get('student_dateofbirth'),
      valid_till: toUpperIf(formData.get('valid_till')),
      father_name_en: toUpperIf(formData.get('father_name_en')),
      // initially attempt to save with "+88" prefix (string); fallback to numeric if server rejects
      father_mobile: fatherMobilePlus,
      mother_name_en: toUpperIf(formData.get('mother_name_en')),
      full_address: toUpperIf(formData.get('full_address')),
      class_2025: toUpperIf(formData.get('class_2025')),
      roll_2025: formData.get('roll_2025') ? parseFloat(formData.get('roll_2025')) : null,
      student_gender: toUpperIf(formData.get('student_gender')),
      session: formData.get('session') ? parseFloat(formData.get('session')) : 2025,
      student_photo_url: photoUrl,
      admission_date: new Date().toISOString().split('T')[0]
    }; 
    
    successMsg.textContent = 'Saving data...';
    
    // Insert or Update into Supabase
    let response;
    const editingId = document.getElementById('editingId').value;
    // Ensure student_photo_url is set (keep existing when editing)
    if (!photoUrl) photoUrl = document.getElementById('existingPhoto').value || null;
    data.student_photo_url = photoUrl;

    // First attempt: save father_mobile with +88 prefix (string)
    try {
      if (editingId) {
        response = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?iid=eq.${editingId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(data)
        });
      } else {
        response = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(data)
        });
      }

      // If server rejects (e.g., numeric column), attempt numeric fallback
      if (!response.ok && fatherMobileNumeric !== null) {
        console.warn('Initial save failed, retrying with numeric father_mobile');
        data.father_mobile = fatherMobileNumeric;

        if (editingId) {
          response = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?iid=eq.${editingId}`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(data)
          });
        }
      }
    } catch (err) {
      console.error('Save attempt error:', err);
      throw err;
    }
    
    if (response.ok) {
      const result = await response.json();
      successMsg.textContent = `‚úì ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! (ID: ${result[0].iid})`;
      successMsg.style.display = 'block';
      successMsg.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
      
      setTimeout(() => { successMsg.style.display = 'none'; }, 4000);
      form.reset();
      // Reset edit state if any
      cancelEdit();
      const preview = document.getElementById('photoPreview');
      if (preview) preview.innerHTML = '<div class="photo-preview-placeholder">Upload Photo</div>';
      // Refresh list if visible
      const listSection = document.getElementById('studentListSection');
      if (listSection && listSection.style.display !== 'none') loadStudentList();
    } else {
      const error = await response.text();
      throw new Error(error || 'Database insert failed');
    }
  } catch (err) {
    console.error('Submission error:', err);
    successMsg.textContent = '‚ùå Error: ' + err.message;
    successMsg.style.display = 'block';
    successMsg.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = '‚úì Submit Form';
  }
});

// Photo Preview Functionality
const photoInput = document.getElementById('studentPhoto');
if (photoInput) {
  photoInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const photoPreview = document.getElementById('photoPreview');
    if (file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        photoPreview.innerHTML = `<img src="${ev.target.result}" alt="Student Photo">`;
      };
      reader.readAsDataURL(file);
    } else {
      photoPreview.innerHTML = '<div class="photo-preview-placeholder">Upload Photo</div>';
    }
  });
}

// Toggle list view
function toggleList() {
  const section = document.getElementById('studentListSection');
  if (section.style.display === 'none') {
    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth' });
    loadStudentList();
  } else {
    section.style.display = 'none';
  }
}

// Load student list from Supabase
async function loadStudentList() {
  const loadingMsg = document.getElementById('loadingMessage');
  const resultsDiv = document.getElementById('studentListResults');
  
  try {
    loadingMsg.style.display = 'block';
    resultsDiv.innerHTML = '';
    
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?select=*&order=iid.desc&limit=50`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    
    if (!response.ok) throw new Error('Failed to load data');
    
    const data = await response.json();
    loadingMsg.style.display = 'none';
    
    if (data.length === 0) {
      resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #64748b;">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</p>';
      return;
    }
    
    // Create table
    let html = `
      <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <thead>
          <tr style="background: #667eea; color: white;">
            <th style="padding: 10px; border: 1px solid #ddd;">ID</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Photo</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Name</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Class</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Roll</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Father's Name</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Mobile</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Valid Till</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Actions</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    data.forEach(student => {
      html += `
        <tr style="border-bottom: 1px solid #ddd;">
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.iid || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            ${student.student_photo_url ? `<img src="${student.student_photo_url}" style="width: 50px; height: 60px; object-fit: cover; border-radius: 5px;">` : '‚Äî'}
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">${student.student_name_en || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.class_2025 || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.roll_2025 || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${student.father_name_en || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${student.father_mobile || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.valid_till || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.admission_date || ''}</td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            <button class="btn btn-secondary" onclick="editStudent(${student.iid})" style="padding:6px 10px; border-radius:6px;">Edit</button>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    resultsDiv.innerHTML = html;
    
  } catch (err) {
    console.error('Load error:', err);
    loadingMsg.style.display = 'none';
    resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #ef4444;">‚ùå Error loading data: ' + err.message + '</p>';
  }
}

// Edit a student: fetch record and populate form
async function editStudent(id) {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?iid=eq.${id}`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) throw new Error('Failed to fetch record');
    const arr = await res.json();
    const student = arr[0];
    if (!student) throw new Error('Record not found');

    // Populate form fields
    document.getElementById('studentNameEn').value = student.student_name_en || '';
    document.getElementById('dateOfBirth').value = student.student_dateofbirth || '';
    document.getElementById('fatherNameEn').value = student.father_name_en || '';    document.getElementById('validTill').value = student.valid_till || '';    // Normalize stored father_mobile for input (show local format starting with 0)
    let storedMobile = student.father_mobile || '';
    if (storedMobile) {
      let sm = String(storedMobile).replace(/\D/g, '');
      if (sm.startsWith('88')) sm = sm.substring(2); // remove country code
      document.getElementById('fatherMobile').value = sm;
    } else {
      document.getElementById('fatherMobile').value = '';
    }
    document.getElementById('motherNameEn').value = student.mother_name_en || '';
    document.getElementById('fullAddress').value = student.full_address || '';
    document.getElementById('admissionClass').value = student.class_2025 || '';
    document.getElementById('roll_2025').value = student.roll_2025 || '';

    // Gender radio
    if (student.student_gender) {
      const r = document.querySelector(`input[name="student_gender"][value="${student.student_gender}"]`);
      if (r) r.checked = true;
    }

    // Photo
    const preview = document.getElementById('photoPreview');
    if (student.student_photo_url) {
      preview.innerHTML = `<img src="${student.student_photo_url}" alt="Student Photo">`;
      document.getElementById('existingPhoto').value = student.student_photo_url;
    } else {
      preview.innerHTML = '<div class="photo-preview-placeholder">Upload Photo</div>';
      document.getElementById('existingPhoto').value = '';
    }

    // Set editing id and show cancel
    document.getElementById('editingId').value = student.iid;
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Update';
    document.getElementById('cancelEditBtn').style.display = 'inline-block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (err) {
    console.error('Edit load error:', err);
    alert('Error loading record: ' + err.message);
  }
}

function cancelEdit() {
  document.getElementById('editingId').value = '';
  document.getElementById('existingPhoto').value = '';
  document.getElementById('admissionForm').reset();
  const preview = document.getElementById('photoPreview');
  if (preview) preview.innerHTML = '<div class="photo-preview-placeholder">Upload Photo</div>';
  document.getElementById('cancelEditBtn').style.display = 'none';
  const submitBtn = document.querySelector('button[type="submit"]');
  if (submitBtn) submitBtn.textContent = '‚úì Submit Form';
}

// Wire Cancel Edit button
const cancelBtn = document.getElementById('cancelEditBtn');
if (cancelBtn) cancelBtn.addEventListener('click', cancelEdit);

    // Print Form Function
    function printForm() {
      window.print();
    }

    // Auto-format father's mobile number (add 0 if not present)
    document.getElementById('fatherMobile').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 0 && value[0] !== '0') {
        value = '0' + value;
      }
      e.target.value = value.substring(0, 11);
    });



    // Print Styles
    const style = document.createElement('style');
    style.textContent = `
      @media print {
        body {
          background: white;
          padding: 0;
        }
        .button-group, .student-list-container {
          display: none !important;
        }
        .container {
          box-shadow: none;
          max-width: 100%;
        }
        .photo-upload-btn {
          display: none;
        }
      }
    `;
    document.head.appendChild(style);


  </script>
</body>

</html>