<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Regular Excel SMS Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f6f8fa; margin: 0; }
        .sidebar { width: 220px; background: #fff; height: 100vh; position: fixed; left: 0; top: 0; box-shadow: 1px 0 8px #eee; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar li { padding: 18px 24px; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #34495e; }
        .sidebar li.active, .sidebar li:hover { background: #eaf6ff; font-weight: bold; }
        .main { margin-left: 240px; padding: 32px; }
        h2 { color: #2c3e50; }
        .excel-upload { margin-bottom: 24px; }
        table { border-collapse: collapse; width: 100%; background: #fff; }
        th, td { border: 1px solid #bfc9d1; padding: 8px 12px; text-align: left; }
        th { background: #eaf6ff; }
        .status-success { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
        .send-btn { margin-top: 18px; padding: 10px 24px; background: #3498db; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .send-btn:disabled { background: #bfc9d1; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="sidebar">
        <ul>
            <li><a href="../index.html" style="color:inherit;text-decoration:none;display:block;">Dashboard</a></li>
            <li class="active">Regular excel SMS</li>
            <li>2022 Anuunal SMS </li>
            <li>2023 Half Yearly SMS </li>
            <li>2023 Anuunal SMS </li>
            <li>2024 Half Yearly SMS </li>
            <li>2024 Anuunal SMS </li>
            <li>2025 Half Yearly SMS </li>
            <li>2025 Anuunal SMS </li>

            <li>Logout</li>
        </ul>
    </div>
    <div class="main">
        <h2>Regular excel SMS <span style="font-size:14px;color:#888;">Send SMS from excel</span></h2>
        <div class="excel-upload">
            <input type="file" id="excelFile" accept=".xlsx,.xls" />
        </div>
        <table id="smsTable" style="display:none;">
            <thead>
                <tr>
                    <th>#</th>
                    <th>phone</th>
                    <th>body</th>
                    <th>status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="manualRowArea" style="margin-top:18px;">
        <input type="text" id="manualPhone" placeholder="Type phone number" style="width:180px;" />
        <input type="text" id="manualBody" placeholder="Type SMS body" style="width:320px;" />
        <button class="send-btn" id="addRowBtn" type="button" style="background:#27ae60;">Add Row</button>
        <button class="send-btn" id="sendSingleBtn" type="button" style="background:#e67e22; margin-left:10px;">Send</button>
        </div>
        <button class="send-btn" id="sendAllBtn" style="display:none;">Send All SMS</button>
        
        <!-- SMS report chart and balance calculator -->
        <div style="margin-top:28px; display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
            <div style="flex:0 0 360px; background:#fff; padding:12px; border:1px solid #ececec; border-radius:6px; height:180px;">
                <h3 style="margin:6px 0 8px 0;font-size:1rem;">Sended SMS Report</h3>
                <canvas id="smsChart" style="width:100%;height:120px;"></canvas>
            </div>
            <div style="width:320px; background:#fff; padding:16px; border:1px solid #ececec; border-radius:6px;">
                <h3 style="margin:6px 0 12px 0;">Balance</h3>
                <div style="font-size:15px;margin-bottom:8px;color:#222;">Show Balance : <strong>101 Taka</strong></div>
                <div style="font-size:16px;margin-top:8px;color:#222;">Sms available  <strong style="font-size:18px;">214</strong></div>
                <div style="margin-top:8px;color:#888;font-size:12px;"> Validity : 30/10/2025 </div>
            </div>
        </div>
    </div>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Data labels plugin for Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        document.getElementById('sendSingleBtn').onclick = async function() {
            let phone = document.getElementById('manualPhone').value.trim();
            const body = document.getElementById('manualBody').value.trim();
            if(phone && body) {
                if(!phone.startsWith('+88')) {
                    phone = '+88' + phone.replace(/^\+?88/, '');
                }
                document.getElementById('sendSingleBtn').textContent = 'Sending...';
                try {
                    const res = await fetch('send.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'single', number: phone, message: body })
                    });
                    const result = await res.json();
                    alert(result.response_code === 200 ? 'SMS Sent Successfully!' : 'SMS Send Failed! ' + (result.error_message||''));
                } catch (e) {
                    alert('SMS Send Failed! ' + e);
                }
                document.getElementById('sendSingleBtn').textContent = 'Send';
            }
        };
        let smsRows = [];
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                // Expecting header: phone, body
                smsRows = [];
                for(let i=1; i<json.length; i++) {
                    const row = json[i];
                    if(row[0] && row[1]) {
                        smsRows.push({phone: row[0], body: row[1], status: ''});
                    }
                }
                renderTable();
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('addRowBtn').onclick = function() {
            let phone = document.getElementById('manualPhone').value.trim();
            const body = document.getElementById('manualBody').value.trim();
            if(phone && body) {
                if(!phone.startsWith('+88')) {
                    phone = '+88' + phone.replace(/^\+?88/, '');
                }
                smsRows.push({phone: phone, body: body, status: ''});
                document.getElementById('manualPhone').value = '';
                document.getElementById('manualBody').value = '';
                renderTable();
            }
        };
        function renderTable() {
            const table = document.getElementById('smsTable');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            smsRows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${idx+1}</td><td>${row.phone}</td><td>${row.body}</td><td class="${row.status==='Success'?'status-success':row.status==='Fail'?'status-fail':''}">${row.status||''}</td>`;
                tbody.appendChild(tr);
            });
            table.style.display = smsRows.length ? '' : 'none';
            document.getElementById('sendAllBtn').style.display = smsRows.length ? '' : 'none';
        }
        document.getElementById('sendAllBtn').onclick = async function() {
            for(let i=0; i<smsRows.length; i++) {
                let phone = smsRows[i].phone;
                if(!phone.startsWith('+88')) {
                    phone = '+88' + phone.replace(/^\+?88/, '');
                    smsRows[i].phone = phone;
                }
                smsRows[i].status = 'Sending...';
                renderTable();
                try {
                    const res = await fetch('send.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'single', number: phone, message: smsRows[i].body })
                    });
                    const result = await res.json();
                    smsRows[i].status = result.response_code === 200 ? 'Success' : (result.error_message ? 'Fail' : JSON.stringify(result));
                } catch (e) {
                    smsRows[i].status = 'Fail';
                }
                renderTable();
            }
        };

        // --- SMS report data (static as requested) ---
        const smsReportLabels = [
            'Dec 2022', 'Aug 2023', 'Dec 2023', 'Aug 2024', 'Dec 2024', 'Aug 2025'
        ];
        const smsReportValues = [4027, 5081, 5120, 5081, 5720, 5319];

        // Initialize Chart.js line chart (enhanced visuals)
        function initSmsChart() {
            const canvas = document.getElementById('smsChart');
            const ctx = canvas.getContext('2d');

            // gradient for fill
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height || 150);
            gradient.addColorStop(0, 'rgba(52,152,219,0.28)');
            gradient.addColorStop(0.6, 'rgba(52,152,219,0.12)');
            gradient.addColorStop(1, 'rgba(52,152,219,0)');

            // small shadow plugin for subtle depth
            const shadowPlugin = {
                id: 'shadowPlugin',
                beforeDatasetsDraw(chart, args, options) {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.shadowColor = 'rgba(52,152,219,0.18)';
                    ctx.shadowBlur = 18;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 8;
                },
                afterDatasetsDraw(chart, args, options) {
                    chart.ctx.restore();
                }
            };
            Chart.register(shadowPlugin);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: smsReportLabels,
                    datasets: [{
                        label: 'Sended SMS',
                        data: smsReportValues,
                        borderColor: '#1e88e5',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2.5,
                        pointRadius: 3.5,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#1e88e5',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0,0,0,0.75)',
                            titleFont: { weight: '600' },
                            callbacks: {
                                label: function(context) {
                                    const v = context.parsed.y;
                                    return 'Sended SMS: ' + (v || 0).toLocaleString();
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            align: 'end',
                            anchor: 'end',
                            formatter: function(value) { return (value || 0).toLocaleString(); },
                            color: '#0f172a',
                            backgroundColor: 'rgba(255,255,255,0.85)',
                            borderRadius: 4,
                            padding: 4,
                            font: { weight: '600', size: 11 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#4b5563', maxRotation: 0 }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(15,23,42,0.04)' },
                            ticks: {
                                color: '#4b5563',
                                callback: function(value){ return value.toLocaleString(); }
                            }
                        }
                    },
                    animation: { duration: 900, easing: 'easeOutQuart' }
                }
            });
        }

    // Initialize chart on load
        initSmsChart();
    </script>

</body>
</html>
