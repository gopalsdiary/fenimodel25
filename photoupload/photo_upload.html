<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Photo, Birth Certificate, Reg card Upload System</title>
    <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg:#f6f8fa; 
            --card:#ffffff; 
            --border:#d0d7de; 
            /* primary button color changed per user request */
            --accent:#019f66; 
            /* slightly darker hover for the new green */
            --accent-hover:#019f66; 
            --danger:#d73a49; 
            --success: #10b981;
            --warning: #f59e0b;
            --radius:6px; 
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            margin:0; 
            background:var(--bg); 
            color:#24292f; 
        }

        .container { 
            width:100%; 
            max-width:100%; 
            margin:0 0 60px 0; 
            background:var(--card); 
            border:1px solid var(--border); 
            border-radius:0; 
            padding:18px 12px 28px; 
            box-shadow:0 2px 4px rgba(0,0,0,.04); 
        }

        header { 
            background:#0d1117; 
            color:#fff; 
            padding:12px 20px; 
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
        }
        
        h1 { 
            font-size:20px; 
            margin:0; 
            font-weight:600; 
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px 20px 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,.04);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .btn {
            cursor: pointer;
            font-size: 12px;
            line-height: 1.2;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--accent);
            background: var(--accent);
            color: #fff;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover:not(:disabled) {
            background: #0d9f74;
        }

        /* Warning style for missing assets */
        .btn.warn {
            background: var(--warning);
            border-color: var(--warning);
            color: #fff;
        }
        .btn.warn:hover:not(:disabled) {
            background: #d97706; /* darker shade of warning */
            border-color: #d97706;
        }

        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            margin-top: 4px;
        }

        .upload-section {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .upload-section.dragover {
            border-color: var(--primary);
            background: rgba(0, 102, 204, 0.05);
        }

        .crop-container {
            display: none;
            margin-top: 20px;
        }

        .crop-area {
            max-width: 100%;
            margin: 0 auto 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .crop-canvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }

        .crop-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .preview-container {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .current-photo {
            max-width: 150px;
            max-height: 150px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 10px;
        }

        @media (max-width:820px){
            .container { 
                padding:14px 14px 24px; 
            }
            .toolbar { 
                gap:8px; 
            }
            th,td{
                padding:5px 6px;
                font-size:12.5px;
            }
            button{
                padding:5px 8px;
            }
            .crop-controls { 
                flex-direction: column; 
            }
        }

        #fileInput {
            display: none;
        }

        .crop-info {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 10px;
        }

        /* Table styles matching datalist_new.html */
        .toolbar { 
            display:flex; 
            flex-wrap:wrap; 
            gap:12px; 
            align-items:center; 
            margin-bottom:14px; 
        }
        
        .toolbar select, .toolbar input[type=text]{ 
            padding:8px 10px; 
            border:1px solid var(--border); 
            border-radius:4px; 
            font-size:14px; 
            background:#fff; 
        }
        
        .toolbar button{ 
            height:34px; 
        }
        
        .status { 
            font-size:13px; 
            min-height:18px; 
        }
        
        .status.ok { 
            color:#1a7f37; 
        }
        
        .status.err { 
            color:var(--danger); 
        }
        
        .table-wrap { 
            overflow-x:auto; 
        }
        
        table { 
            width:100%; 
            border-collapse:collapse; 
            font-size:13.5px; 
        }
        
        thead { 
            background:#fafbfc; 
            position:sticky; 
            top:0; 
            z-index:5; 
        }
        
        th, td { 
            border:1px solid var(--border); 
            padding:6px 8px; 
            text-align:left; 
            vertical-align:middle; 
        }
        
        th { 
            font-weight:600; 
            font-size:12.5px; 
            letter-spacing:.5px; 
            background:#f0f3f6; 
        }
        
        tbody tr:nth-child(even){ 
            background:#fcfcfd; 
        }
        
        tbody tr:hover { 
            background:#fffbe6; 
        }
        
        .col-sl { 
            width:52px; 
            text-align:center; 
        }
        
        .photo-col img { 
            width:100px; 
            height:80px; 
            object-fit:cover; 
            border-radius:4px; 
            border:1px solid var(--border); 
            background:#fff; 
        }
        
        .actions-col { 
            white-space:nowrap; 
        }
        
        button { 
            cursor:pointer; 
            font-size:12px; 
            line-height:1.2; 
            padding:6px 10px; 
            border-radius:4px; 
            border:1px solid var(--accent); 
            background:var(--accent); 
            color:#fff; 
            font-weight:500; 
        }
        
        button:hover { 
            background:var(--accent-hover); 
        }
        
        button.outline { 
            background:#fff; 
            color:var(--accent); 
        }
        
        button.outline:hover { 
            background:#e7f3ff; 
        }

        /* Text-only button: black text and always underlined */
        .text-btn {
            background: transparent;
            border: none;
            color: #000;
            padding: 0;
            margin: 0;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
            display: inline-block;
        }
        .text-btn:hover {
            text-decoration: underline;
            background: transparent;
            opacity: 0.95;
        }
        .text-btn:focus {
            outline: 2px solid rgba(0,0,0,0.12);
            outline-offset: 2px;
        }
        
        .muted { 
            color:#6a737d; 
            font-size:12px; 
        }
        
        .action-cell button + button { 
            margin-left:8px; 
        }
        
        .action-cell .btn { 
            padding:6px 8px; 
        }
        
        .btn.upload { 
            background:#10b981; 
            border-color:#10b981; 
        }
        
        .btn.upload:hover { 
            background:#0d9f74; 
        }

        /* Ensure warn state overrides .btn.upload defaults */
        .btn.upload.warn {
            background: var(--warning) !important;
            border-color: var(--warning) !important;
            color: #fff !important;
        }
        .btn.upload.warn:hover {
            background:#d97706 !important;
            border-color:#d97706 !important;
        }
        
        .row-thumb { 
            width:40px; 
            height:50px; 
            object-fit:cover; 
            border-radius:4px; 
            border:1px solid var(--border); 
            background:#fff;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .row-thumb:hover {
            transform: scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Photo Preview Popup */
        #photo-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 10001;
            display: none;
            max-width: 90vw;
            max-height: 90vh;
            pointer-events: none;
        }

        #photo-preview img {
            max-width: 500px;
            max-height: 600px;
            object-fit: contain;
            display: block;
            border-radius: 6px;
            margin: 0 auto;
            pointer-events: none;
        }

        #photo-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            display: none;
            pointer-events: none; /* don't intercept mouse for hover preview */
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding: 60px 20px 40px;
            z-index: 200;
        }

        .modal-panel {
            background: #fff;
            width: 880px;
            max-width: 100%;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px 20px 24px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.18);
            max-height: 80vh;
            overflow: auto;
        }
    </style>
</head>
<body>
    <header>
        <h1>📸 Student Photo, Birth Certificate, Reg card Upload System</h1>
        <p style="margin:0; font-size:14px; opacity:0.8;">Student Photo, Birth Certificate, Reg card Upload System with automatic database update</p>
    </header>
    
    <!-- Status Messages -->
    <div id="statusMessage" style="display: none;"></div>

    <div class="container">
        <!-- Filters and Controls -->
        <div class="toolbar">
            <div class="filters left" style="align-items:center">
                <label for="sessionFilter" style="font-size:12px;font-weight:600;color:#57606a;margin-right:8px;">Session</label>
                <select id="sessionFilter">
                    <option value="">All Sessions</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
                <label for="classFilter" style="font-size:12px;font-weight:600;color:#57606a;margin-right:8px;">Class</label>
                <select id="classFilter">
                    <option value="">All Classes</option>
                </select>
                <label for="sectionFilter" style="font-size:12px;font-weight:600;color:#57606a;margin-right:8px;">Section</label>
                <select id="sectionFilter">
                    <option value="">All Sections</option>
                </select>
            </div>
            <div style="display:flex;gap:12px;align-items:center;margin-left:auto">
                <button id="refreshBtn">Refresh</button>
                <span id="status" class="status"></span>
                <button id="clearFilters" class="outline">Clear</button>
            </div>
        </div>

        <!-- Student Data Table -->
        <div class="table-wrap">
        <table id="dataTable">
            <thead>
                <tr>
                    <th class="col-sl">SL</th>
                    <th>IID</th>
                    <th>Class</th>
                    <th>Section</th>
                    <th>Roll</th>
                    <th>Name</th>
                    <th>Father Name</th>
                    <th>Father Mobile</th>
                    <th>Photo</th>
                    <th>Photo Action</th>
                    <th>Birth Certificate</th>
                    <th>Birth Cert Action</th>
                    <th>Registration Card</th>
                    <th>Reg Card Action</th>
                    <th>Download</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="15">Loading...</td></tr>
            </tbody>
        </table>
        </div>
        <div id="rowCount" class="muted" style="margin-top:8px;"></div>
    </div>

        <!-- Photo Upload Modal -->
        <div id="uploadModal" class="modal">
            <div class="modal-panel">
                <h3>Upload Photo for: <span id="modalStudentName"></span></h3>
                
                <!-- File Upload Area -->
                <div class="upload-section" id="uploadArea">
                    <div>
                        <h4>📷 Select or Drop Image File</h4>
                        <p>Drag & drop an image here, or click to select</p>
                        <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
                            Supported formats: JPG, PNG, GIF (Max size: 5MB)<br>
                            Recommended size: 944x1181 pixels (96 DPI)
                        </p>
                        <button type="button" class="btn btn-primary" id="selectFileBtn">
                            📂 Choose Image File
                        </button>
                    </div>
                </div>

                <input type="file" id="fileInput" accept="image/*">

                <!-- Cropping Interface -->
                <div class="crop-container" id="cropContainer">
                    <h4>Crop Your Image</h4>
                    <p class="crop-info">Click and drag to create a rectangular crop area (944:1181 ratio). The cropped image will be resized to 944x1181 pixels.</p>
                    
                    <div class="crop-area">
                        <canvas id="cropCanvas" class="crop-canvas"></canvas>
                    </div>

                    <div class="crop-controls">
                        <button type="button" class="btn btn-primary" id="resetCropBtn">
                            🔄 Reset Crop
                        </button>
                        <button type="button" class="btn btn-success" id="confirmCropBtn">
                            ✅ Confirm & Upload
                        </button>
                        <button type="button" class="btn" id="cancelCropBtn">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="preview-container" id="previewContainer">
                    <h4>Preview</h4>
                    <img id="previewImage" class="preview-image" alt="Cropped preview">
                </div>

                <!-- Loading Indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Uploading and updating...</p>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn outline" id="closeModalBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- Document Upload Modal -->
        <div id="documentModal" class="modal">
            <div class="modal-panel">
                <h3>Upload <span id="modalDocType"></span> for: <span id="modalDocStudentName"></span></h3>
                
                <!-- File Upload Area -->
                <div class="upload-section" id="documentUploadArea">
                    <div>
                        <h4>📄 Select or Drop Document File</h4>
                        <p>Drag & drop a document here, or click to select</p>
                        <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
                            Supported formats: PDF, JPG, PNG (Max size: 10MB)
                        </p>
                        <button type="button" class="btn btn-primary" id="selectDocFileBtn">
                            📂 Choose Document File
                        </button>
                    </div>
                </div>

                <input type="file" id="docFileInput" accept=".pdf,.jpg,.jpeg,.png">

                <!-- Document Preview -->
                <div class="preview-container" id="docPreviewContainer" style="display: none;">
                    <h4>Document Preview</h4>
                    <div id="docPreview"></div>
                </div>

                <!-- Loading Indicator -->
                <div class="loading" id="docLoadingIndicator">
                    <div class="spinner"></div>
                    <p>Uploading document...</p>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-success" id="confirmDocUploadBtn" style="display: none;">
                        ✅ Confirm & Upload
                    </button>
                    <button type="button" class="btn outline" id="closeDocModalBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../login/auth-check.js"></script>
    <script>
        // Configuration
        const IMGBB_API_KEY = '4d2cdd03bb1da4404f875c22f0bfdf31';
        const IMGBB_UPLOAD_URL = 'https://api.imgbb.com/1/upload';
        const IMGBB_ALBUM = 'student_photo';
        
        const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
        const tableName = 'student_database';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentStudent = null;
        let originalImage = null;
        let cropCanvas = null;
        let cropContext = null;
        let cropSelection = { x: 0, y: 0, width: 0, height: 0 };
        let isDragging = false;
        let startX, startY;
        let allStudentsData = [];
        let filteredData = [];
        let currentDocumentType = null;
        let selectedDocumentFile = null;

        // DOM Elements
        const tbody = document.querySelector('#dataTable tbody');
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const cropContainer = document.getElementById('cropContainer');
        const cropCanvas_el = document.getElementById('cropCanvas');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const statusMessage = document.getElementById('statusMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const uploadModal = document.getElementById('uploadModal');
        const modalStudentName = document.getElementById('modalStudentName');
        const sessionFilter = document.getElementById('sessionFilter');
        const classFilter = document.getElementById('classFilter');
        const sectionFilter = document.getElementById('sectionFilter');
        const rowCountEl = document.getElementById('rowCount');
        
        // Document modal elements
        const documentModal = document.getElementById('documentModal');
        const modalDocType = document.getElementById('modalDocType');
        const modalDocStudentName = document.getElementById('modalDocStudentName');
        const docFileInput = document.getElementById('docFileInput');
        const documentUploadArea = document.getElementById('documentUploadArea');
        const docPreviewContainer = document.getElementById('docPreviewContainer');
        const docPreview = document.getElementById('docPreview');
        const docLoadingIndicator = document.getElementById('docLoadingIndicator');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            setupPhotoPreview();
        });

        async function initializeApp() {
            try {
                // Don't load students initially - wait for session and class selection
                await initializeFilters();
                showInitialMessage();
                showStatus('Please select Session and Class to view students', 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                showStatus('Failed to initialize application: ' + error.message, 'error');
            }
        }

        async function initializeFilters() {
            try {
                // Load basic data to populate session and class filters without showing students
                const { data, error } = await supabase
                    .from(tableName)
                    .select('active_class, active_section')
                    .order('active_class', { ascending: true })
                    .order('active_section', { ascending: true });

                if (error) throw error;

                allStudentsData = []; // Keep empty initially
                filteredData = [];

                // Populate only class filter initially
                const classes = [...new Set(data.map(s => s.active_class).filter(Boolean))].sort((a, b) => {
                    const aNum = parseInt(a);
                    const bNum = parseInt(b);
                    return !isNaN(aNum) && !isNaN(bNum) ? aNum - bNum : String(a).localeCompare(String(b));
                });

                classFilter.innerHTML = '<option value="">Select Class</option>';
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    classFilter.appendChild(option);
                });

                // Keep section filter empty initially
                sectionFilter.innerHTML = '<option value="">Select Section</option>';

            } catch (error) {
                console.error('Error initializing filters:', error);
                throw error;
            }
        }

        function showInitialMessage() {
            tbody.innerHTML = '<tr><td colspan="15" class="muted" style="text-align: center; padding: 40px; font-size: 16px;">📋 Please select Session and Class from the filters above to view students</td></tr>';
            rowCountEl.textContent = 'No filters selected';
        }

        function setupEventListeners() {
            // Filter controls with debugging
            document.getElementById('sessionFilter').addEventListener('change', function() {
                console.log('Session filter changed to:', this.value);
                filterAndRenderData();
            });
            
            document.getElementById('classFilter').addEventListener('change', function() {
                console.log('Class filter changed to:', this.value);
                filterAndRenderData();
            });
            
            document.getElementById('sectionFilter').addEventListener('change', function() {
                console.log('Section filter changed to:', this.value);
                filterAndRenderData();
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                const selectedClass = classFilter.value;
                if (selectedClass) {
                    loadStudents(selectedClass);
                } else {
                    showStatus('Please select a class first', 'warning');
                }
            });
            document.getElementById('clearFilters').addEventListener('click', clearFilters);

            // File input events
            document.getElementById('selectFileBtn').addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelection);

            // Drag and drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleFileDrop);

            // Crop controls
            document.getElementById('resetCropBtn').addEventListener('click', resetCrop);
            document.getElementById('confirmCropBtn').addEventListener('click', processCropAndUpload);
            document.getElementById('cancelCropBtn').addEventListener('click', cancelCrop);
            document.getElementById('closeModalBtn').addEventListener('click', closeUploadModal);

            // Canvas mouse events for cropping
            cropCanvas_el.addEventListener('mousedown', startCrop);
            cropCanvas_el.addEventListener('mousemove', updateCrop);
            cropCanvas_el.addEventListener('mouseup', endCrop);

            // Event delegation for upload buttons
            tbody.addEventListener('click', function(e) {
                if (e.target.matches('.btn.upload')) {
                    const iid = e.target.getAttribute('data-iid');
                    const studentName = e.target.getAttribute('data-student-name');
                    const docType = e.target.getAttribute('data-doc-type');
                    
                    if (docType) {
                        console.log('Document upload button clicked - IID:', iid, 'Name:', studentName, 'Type:', docType);
                        handleDocumentUploadButtonClick(iid, studentName, docType);
                    } else {
                        console.log('Photo upload button clicked - IID:', iid, 'Name:', studentName);
                        handleUploadButtonClick(iid, studentName);
                    }
                }
            });

            // Document modal events
            document.getElementById('selectDocFileBtn').addEventListener('click', () => docFileInput.click());
            docFileInput.addEventListener('change', handleDocumentFileSelection);
            document.getElementById('confirmDocUploadBtn').addEventListener('click', processDocumentUpload);
            document.getElementById('closeDocModalBtn').addEventListener('click', closeDocumentModal);

            // Document drag and drop
            documentUploadArea.addEventListener('dragover', handleDocumentDragOver);
            documentUploadArea.addEventListener('dragleave', handleDocumentDragLeave);
            documentUploadArea.addEventListener('drop', handleDocumentFileDrop);
        }

        async function loadStudents(selectedClass = null) {
            try {
                showStatus('Loading students...', 'success');
                tbody.innerHTML = '<tr><td colspan="15">Loading...</td></tr>';

                let query = supabase
                    .from(tableName)
                    .select('iid, active_class, active_section, active_roll, student_name_en, father_name_en, father_mobile, student_photo_url, birth_certificate_url, registration_card_url')
                    .order('active_class', { ascending: true })
                    .order('active_section', { ascending: true })
                    .order('active_roll', { ascending: true });

                // If class is selected, filter by class
                if (selectedClass) {
                    query = query.eq('active_class', selectedClass);
                }

                const { data, error } = await query;

                if (error) throw error;

                allStudentsData = data || [];
                filteredData = [...allStudentsData];
                
                console.log('Raw student data sample:', allStudentsData.slice(0, 3));
                
                // Update section filter based on loaded data
                updateSectionFilterFromData();
                renderTable();

                console.log('Loaded students:', data.length);
                showStatus(`Loaded ${data.length} students successfully`, 'success');
            } catch (error) {
                console.error('Error loading students:', error);
                showStatus('Failed to load student data: ' + error.message, 'error');
                tbody.innerHTML = '<tr><td colspan="15" class="muted">Failed to load data.</td></tr>';
            }
        }

        function updateSectionFilterFromData() {
            // Get sections from loaded data
            const sections = [...new Set(allStudentsData.map(s => s.active_section).filter(Boolean))].sort();
            
            const currentSection = sectionFilter.value;
            
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                if (section === currentSection) option.selected = true;
                sectionFilter.appendChild(option);
            });
        }

        function populateFilters() {
            // Get unique classes and sections from current data
            const classes = [...new Set(allStudentsData.map(s => s.active_class).filter(Boolean))].sort((a, b) => {
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                return !isNaN(aNum) && !isNaN(bNum) ? aNum - bNum : String(a).localeCompare(String(b));
            });

            const sections = [...new Set(allStudentsData.map(s => s.active_section).filter(Boolean))].sort();

            // Store current selections
            const currentClass = classFilter.value;
            const currentSection = sectionFilter.value;

            // Populate class filter
            classFilter.innerHTML = '<option value="">All Classes</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                if (cls === currentClass) option.selected = true;
                classFilter.appendChild(option);
            });

            // Populate section filter  
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                if (section === currentSection) option.selected = true;
                sectionFilter.appendChild(option);
            });
        }

        async function filterAndRenderData() {
            const selectedSession = sessionFilter.value;
            const selectedClass = classFilter.value;
            const selectedSection = sectionFilter.value;

            console.log('Filtering with:', { selectedSession, selectedClass, selectedSection });

            // If no session or class selected, show initial message
            if (!selectedSession || !selectedClass) {
                showInitialMessage();
                return;
            }

            // If class is changed, reload students for that class
            if (selectedClass && (allStudentsData.length === 0 || 
                !allStudentsData.some(s => String(s.active_class) === String(selectedClass)))) {
                await loadStudents(selectedClass);
                return; // loadStudents will call renderTable, so return here
            }

            // Filter existing data
            filteredData = allStudentsData.filter(student => {
                // Class filter
                if (selectedClass && String(student.active_class) !== String(selectedClass)) {
                    return false;
                }
                
                // Section filter  
                if (selectedSection && String(student.active_section) !== String(selectedSection)) {
                    return false;
                }

                return true;
            });

            console.log('Filtered data:', filteredData.length, 'students');
            renderTable();
        }

        function renderTable() {
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="muted">No students found with current filters.</td></tr>';
                rowCountEl.textContent = 'No students found';
                return;
            }

            const rows = filteredData.map((student, index) => {
                const hasPhoto = !!(student.student_photo_url && String(student.student_photo_url).trim());
                const photoImg = hasPhoto 
                    ? `<img src="${student.student_photo_url}" alt="Student photo" class="row-thumb">`
                    : '<span style="color: #6a737d; font-size: 12px;">No photo</span>';

                // Birth Certificate display
                const hasBirth = !!(student.birth_certificate_url && String(student.birth_certificate_url).trim());
                const birthCertDisplay = hasBirth
                    ? `<a href="${student.birth_certificate_url}" target="_blank" style="color: #10b981; text-decoration: none;">📄 View</a>`
                    : '<span style="color: #64748b; font-size: 12px;"></span>';

                // Registration Card display  
                const hasReg = !!(student.registration_card_url && String(student.registration_card_url).trim());
                const regCardDisplay = hasReg
                    ? `<a href="${student.registration_card_url}" target="_blank" style="color: #10b981; text-decoration: none;">📄 View</a>`
                    : '<span style="color: #64748b; font-size: 12px;"> </span>';

                return `
                    <tr data-iid="${escapeHtml(student.iid || '')}">
                        <td class="col-sl">${index + 1}</td>
                        <td>${escapeHtml(student.iid || '-')}</td>
                        <td>${escapeHtml(student.active_class || '-')}</td>
                        <td>${escapeHtml(student.active_section || '-')}</td>
                        <td>${escapeHtml(student.active_roll || '-')}</td>
                        <td>${escapeHtml(student.student_name_en || '-')}</td>
                        <td>${escapeHtml(student.father_name_en || '-')}</td>
                        <td>${escapeHtml(student.father_mobile || '-')}</td>
                        <td class="photo-col">${photoImg}</td>
                        <td class="actions-col">
                            <button class="btn upload${hasPhoto ? '' : ' warn'}" 
                                    data-iid="${student.iid || ''}" 
                                    data-student-name="${escapeHtml(student.student_name_en || '')}"
                                    onclick="uploadPhoto('${student.iid || ''}', '${escapeHtml(student.student_name_en || '')}')">
                                📷 Photo Upload
                            </button>
                        </td>
                        <td class="photo-col">${birthCertDisplay}</td>
                        <td class="actions-col">
                            <button class="btn upload${hasBirth ? '' : ' warn'}" 
                                    data-iid="${student.iid || ''}" 
                                    data-student-name="${escapeHtml(student.student_name_en || '')}"
                                    data-doc-type="birth_certificate"
                                    onclick="uploadDocument('${student.iid || ''}', '${escapeHtml(student.student_name_en || '')}', 'birth_certificate')">
                                 Birth Certificate Upload
                            </button>
                        </td>
                        <td class="photo-col">${regCardDisplay}</td>
                        <td class="actions-col">
                            <button class="btn upload${hasReg ? '' : ' warn'}" 
                                    data-iid="${student.iid || ''}" 
                                    data-student-name="${escapeHtml(student.student_name_en || '')}"
                                    data-doc-type="registration_card"
                                    onclick="uploadDocument('${student.iid || ''}', '${escapeHtml(student.student_name_en || '')}', 'registration_card')">
                                Registration Card Upload
                            </button>
                        </td>
                        <td class="actions-col">
                            <a href="/0newdatabase/detailsinfo.html?iid=${student.iid || ''}" 
                               target="_blank" 
                               class="text-btn" 
                               style="margin-bottom:4px; font-size:11px; display:inline-block;">
                                Details
                            </a><br>
                            <button class="text-btn" 
                                    onclick="downloadPhoto('${student.iid || ''}', 'iid')" 
                                    style="margin-bottom:4px; font-size:11px;">
                                Download (IID)
                            </button><br>
                            <button class="text-btn" 
                                    onclick="downloadPhoto('${student.iid || ''}', 'class-roll', '${student.active_class || ''}', '${student.active_section || ''}', '${student.active_roll || ''}')" 
                                    style="font-size:11px;">
                                Download (Class-roll)
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
            rowCountEl.textContent = `Total: ${filteredData.length} students`;
            
            // Show current filters in status
            const selectedClass = classFilter.value;
            const selectedSection = sectionFilter.value;
            let filterText = '';
            if (selectedClass) filterText += `Class: ${selectedClass} `;
            if (selectedSection) filterText += `Section: ${selectedSection} `;
            
            if (filterText) {
                rowCountEl.textContent += ` (filtered by ${filterText.trim()})`;
            }
        }

        function clearFilters() {
            sessionFilter.value = '';
            classFilter.value = '';
            sectionFilter.value = '';
            
            // Clear student data
            allStudentsData = [];
            filteredData = [];
            
            // Repopulate basic filters (without student data)
            initializeFilters();
            
            // Show initial message
            showInitialMessage();
            
            showStatus('Filters cleared', 'success');
        }

        function handleUploadButtonClick(iid, studentName) {
            console.log('Upload button clicked for IID:', iid, 'Student Name:', studentName);
            console.log('All students data length:', allStudentsData.length);
            
            // Find student by IID with string comparison
            currentStudent = allStudentsData.find(s => {
                const studentIID = String(s.iid || '').trim();
                const searchIID = String(iid || '').trim();
                console.log('Comparing:', studentIID, '===', searchIID, ':', studentIID === searchIID);
                return studentIID === searchIID;
            });
            
            if (!currentStudent) {
                console.error('Student not found with IID:', iid);
                console.log('Available IIDs:', allStudentsData.map(s => s.iid));
                showStatus(`Student not found (IID: ${iid})`, 'error');
                return;
            }

            console.log('Found student:', currentStudent);
            openUploadModal(currentStudent, studentName);
        }

        function openUploadModal(student, studentName) {
            currentStudent = student;
            
            modalStudentName.textContent = studentName || student.student_name_en || 'Unknown Student';
            uploadModal.style.display = 'flex';
            
            // Reset modal state
            cropContainer.style.display = 'none';
            previewContainer.style.display = 'none';
            fileInput.value = '';
            originalImage = null;
        }

        function closeUploadModal() {
            uploadModal.style.display = 'none';
            currentStudent = null;
            
            // Reset modal state
            cropContainer.style.display = 'none';
            previewContainer.style.display = 'none';
            fileInput.value = '';
            originalImage = null;
        }



        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processSelectedFile(files[0]);
            }
        }

        function handleFileSelection(e) {
            const file = e.target.files[0];
            if (file) {
                processSelectedFile(file);
            }
        }

        function processSelectedFile(file) {
            if (!currentStudent) {
                showStatus('Please select a student first', 'warning');
                return;
            }

            // Validate file
            if (!file.type.startsWith('image/')) {
                showStatus('Please select a valid image file', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showStatus('File size too large. Please select an image under 5MB', 'error');
                return;
            }

            // Load image for cropping
            const reader = new FileReader();
            reader.onload = function(e) {
                loadImageForCropping(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function loadImageForCropping(imageSrc) {
            const img = new Image();
            img.onload = function() {
                originalImage = img;
                setupCropCanvas();
                cropContainer.style.display = 'block';
                previewContainer.style.display = 'none';
                showStatus('Image loaded. Adjust the crop area and click "Confirm & Upload"', 'success');
            };
            img.src = imageSrc;
        }

        function setupCropCanvas() {
            cropCanvas = cropCanvas_el;
            cropContext = cropCanvas.getContext('2d');

            // Calculate canvas size maintaining aspect ratio
            const maxWidth = 600;
            const maxHeight = 400;
            let canvasWidth = originalImage.width;
            let canvasHeight = originalImage.height;

            if (canvasWidth > maxWidth) {
                canvasHeight = (canvasHeight * maxWidth) / canvasWidth;
                canvasWidth = maxWidth;
            }

            if (canvasHeight > maxHeight) {
                canvasWidth = (canvasWidth * maxHeight) / canvasHeight;
                canvasHeight = maxHeight;
            }

            cropCanvas.width = canvasWidth;
            cropCanvas.height = canvasHeight;

            // Draw image
            cropContext.drawImage(originalImage, 0, 0, canvasWidth, canvasHeight);

            // Initialize crop selection (944x1181 ratio rectangle in center)
            const aspectRatio = 944 / 1181; // width / height
            let cropWidth, cropHeight;
            
            if (canvasWidth / canvasHeight > aspectRatio) {
                // Canvas is wider than target ratio, fit by height
                cropHeight = canvasHeight * 0.8;
                cropWidth = cropHeight * aspectRatio;
            } else {
                // Canvas is taller than target ratio, fit by width  
                cropWidth = canvasWidth * 0.8;
                cropHeight = cropWidth / aspectRatio;
            }
            
            cropSelection = {
                x: (canvasWidth - cropWidth) / 2,
                y: (canvasHeight - cropHeight) / 2,
                width: cropWidth,
                height: cropHeight
            };

            drawCropOverlay();
        }

        function drawCropOverlay() {
            // Redraw image
            cropContext.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            cropContext.drawImage(originalImage, 0, 0, cropCanvas.width, cropCanvas.height);

            // Draw overlay
            cropContext.fillStyle = 'rgba(0, 0, 0, 0.5)';
            cropContext.fillRect(0, 0, cropCanvas.width, cropCanvas.height);

            // Clear crop area
            cropContext.clearRect(cropSelection.x, cropSelection.y, cropSelection.width, cropSelection.height);
            cropContext.drawImage(
                originalImage,
                (cropSelection.x / cropCanvas.width) * originalImage.width,
                (cropSelection.y / cropCanvas.height) * originalImage.height,
                (cropSelection.width / cropCanvas.width) * originalImage.width,
                (cropSelection.height / cropCanvas.height) * originalImage.height,
                cropSelection.x,
                cropSelection.y,
                cropSelection.width,
                cropSelection.height
            );

            // Draw crop border
            cropContext.strokeStyle = '#fff';
            cropContext.lineWidth = 2;
            cropContext.strokeRect(cropSelection.x, cropSelection.y, cropSelection.width, cropSelection.height);
        }

        function startCrop(e) {
            const rect = cropCanvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDragging = true;
        }

        function updateCrop(e) {
            if (!isDragging) return;

            const rect = cropCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            const aspectRatio = 944 / 1181; // width / height ratio

            // Maintain 944:1181 aspect ratio
            let cropWidth, cropHeight;
            if (width / height > aspectRatio) {
                // Wider than target ratio, fit by height
                cropHeight = height;
                cropWidth = cropHeight * aspectRatio;
            } else {
                // Taller than target ratio, fit by width
                cropWidth = width;
                cropHeight = cropWidth / aspectRatio;
            }

            cropSelection.x = Math.min(startX, currentX);
            cropSelection.y = Math.min(startY, currentY);
            cropSelection.width = cropWidth;
            cropSelection.height = cropHeight;

            // Keep within canvas bounds
            if (cropSelection.x + cropSelection.width > cropCanvas.width) {
                cropSelection.width = cropCanvas.width - cropSelection.x;
                cropSelection.height = cropSelection.width / aspectRatio;
            }
            if (cropSelection.y + cropSelection.height > cropCanvas.height) {
                cropSelection.height = cropCanvas.height - cropSelection.y;
                cropSelection.width = cropSelection.height * aspectRatio;
            }

            drawCropOverlay();
        }

        function endCrop() {
            isDragging = false;
        }

        function resetCrop() {
            // Reset to 944:1181 aspect ratio rectangle in center
            const aspectRatio = 944 / 1181; // width / height
            let cropWidth, cropHeight;
            
            if (cropCanvas.width / cropCanvas.height > aspectRatio) {
                // Canvas is wider than target ratio, fit by height
                cropHeight = cropCanvas.height * 0.8;
                cropWidth = cropHeight * aspectRatio;
            } else {
                // Canvas is taller than target ratio, fit by width  
                cropWidth = cropCanvas.width * 0.8;
                cropHeight = cropWidth / aspectRatio;
            }
            
            cropSelection = {
                x: (cropCanvas.width - cropWidth) / 2,
                y: (cropCanvas.height - cropHeight) / 2,
                width: cropWidth,
                height: cropHeight
            };
            drawCropOverlay();
        }

        function cancelCrop() {
            cropContainer.style.display = 'none';
            previewContainer.style.display = 'none';
            fileInput.value = '';
            originalImage = null;
        }

        async function processCropAndUpload() {
            if (!currentStudent || !originalImage || cropSelection.width === 0) {
                showStatus('Please select a student and crop area', 'warning');
                return;
            }

            try {
                showLoading(true);
                showStatus('Processing image...', 'success');

                // Create cropped image
                const croppedCanvas = document.createElement('canvas');
                const croppedContext = croppedCanvas.getContext('2d');

                // Set target size (944x1181 for rectangle as per requirements)
                const targetWidth = 944;
                const targetHeight = 1181;
                croppedCanvas.width = targetWidth;
                croppedCanvas.height = targetHeight;

                // Calculate source coordinates
                const scaleX = originalImage.width / cropCanvas.width;
                const scaleY = originalImage.height / cropCanvas.height;
                
                const sourceX = cropSelection.x * scaleX;
                const sourceY = cropSelection.y * scaleY;
                const sourceWidth = cropSelection.width * scaleX;
                const sourceHeight = cropSelection.height * scaleY;

                // Draw cropped image
                croppedContext.drawImage(
                    originalImage,
                    sourceX, sourceY, sourceWidth, sourceHeight,
                    0, 0, targetWidth, targetHeight
                );

                // Convert to blob
                const blob = await new Promise(resolve => croppedCanvas.toBlob(resolve, 'image/jpeg', 0.9));

                // Show preview
                const previewUrl = URL.createObjectURL(blob);
                previewImage.src = previewUrl;
                previewContainer.style.display = 'block';

                // Upload to ImgBB
                showStatus('Uploading to ImgBB...', 'success');
                const imgbbUrl = await uploadToImgBB(blob, currentStudent.iid);

                // Update database
                showStatus('Updating database...', 'success');
                await updateStudentPhoto(currentStudent.iid, imgbbUrl);

                // Success
                showStatus('Photo uploaded and updated successfully! ✅', 'success');
                
                // Update local data and refresh table
                const studentIndex = allStudentsData.findIndex(s => s.iid === currentStudent.iid);
                if (studentIndex !== -1) {
                    allStudentsData[studentIndex].student_photo_url = imgbbUrl;
                }
                filterAndRenderData(); // Refresh table display

                // Clean up
                URL.revokeObjectURL(previewUrl);
                cropContainer.style.display = 'none';
                
                // Close modal after successful upload
                setTimeout(() => {
                    closeUploadModal();
                }, 2000);

            } catch (error) {
                console.error('Upload error:', error);
                showStatus('Failed to upload photo: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function uploadToImgBB(blob, iid) {
            const formData = new FormData();
            formData.append('key', IMGBB_API_KEY);
            formData.append('image', blob, `avatar-${iid}.jpg`);
            formData.append('album', IMGBB_ALBUM);

            const response = await fetch(IMGBB_UPLOAD_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('ImgBB upload failed: ' + response.statusText);
            }

            const data = await response.json();
            
            if (!data.success) {
                throw new Error('ImgBB upload failed: ' + (data.error?.message || 'Unknown error'));
            }

            return data.data.url;
        }

        async function updateStudentPhoto(iid, photoUrl) {
            const { error } = await supabase
                .from(tableName)
                .update({ student_photo_url: photoUrl })
                .eq('iid', iid);

            if (error) {
                throw new Error('Database update failed: ' + error.message);
            }
        }

        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.style.display = 'block';

            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        function showLoading(show) {
            loadingIndicator.style.display = show ? 'block' : 'none';
            
            // Disable controls during upload
            const controls = document.querySelectorAll('button, select, input');
            controls.forEach(control => {
                control.disabled = show;
            });
        }

        // Photo Preview Functions
        function setupPhotoPreview() {
            // Remove existing preview elements if any
            const existingPreview = document.getElementById('photo-preview');
            const existingOverlay = document.getElementById('photo-preview-overlay');
            if (existingPreview) existingPreview.remove();
            if (existingOverlay) existingOverlay.remove();
            
            // Create photo preview elements
            const photoPreview = document.createElement('div');
            photoPreview.id = 'photo-preview';
            
            const previewImg = document.createElement('img');
            photoPreview.appendChild(previewImg);
            
            const overlay = document.createElement('div');
            overlay.id = 'photo-preview-overlay';
            
            document.body.appendChild(overlay);
            document.body.appendChild(photoPreview);
            
            // Click overlay to close immediately
            overlay.addEventListener('click', () => {
                clearTimeout(previewTimeout);
                const photoPreview = document.getElementById('photo-preview');
                const overlay = document.getElementById('photo-preview-overlay');
                
                if (photoPreview) photoPreview.style.display = 'none';
                if (overlay) overlay.style.display = 'none';
            });
            
            // ESC key to close immediately
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    clearTimeout(previewTimeout);
                    const photoPreview = document.getElementById('photo-preview');
                    const overlay = document.getElementById('photo-preview-overlay');
                    
                    if (photoPreview) photoPreview.style.display = 'none';
                    if (overlay) overlay.style.display = 'none';
                }
            });
            
            // Add event delegation for photo hover with better stability
            document.addEventListener('mouseenter', (e) => {
                if (e.target && e.target.classList && e.target.classList.contains('row-thumb')) {
                    showPhotoPreview(e.target.src, e.target);
                }
            }, true);
            
            document.addEventListener('mouseleave', (e) => {
                if (e.target && e.target.classList && e.target.classList.contains('row-thumb')) {
                    const previewEl = document.getElementById('photo-preview');
                    // If moving into preview element, don't hide
                    if (previewEl && (e.relatedTarget === previewEl || previewEl.contains(e.relatedTarget))) return;
                    if (currentHoveredThumb === e.target) hidePhotoPreview();
                }
            }, true);

            // Keep open while hovering preview itself
            const previewEl = document.getElementById('photo-preview');
            previewEl.addEventListener('mouseenter', () => {
                clearTimeout(previewTimeout);
            });
            previewEl.addEventListener('mouseleave', (e) => {
                // If leaving to a thumbnail, keep it open (the thumb handler will manage)
                if (e.relatedTarget && e.relatedTarget.classList && e.relatedTarget.classList.contains('row-thumb')) return;
                hidePhotoPreview();
            });
        }
        
        let previewTimeout;
        let currentHoveredThumb = null;
        
        function showPhotoPreview(imageSrc, thumbElement) {
            clearTimeout(previewTimeout);
            currentHoveredThumb = thumbElement;
            
            const photoPreview = document.getElementById('photo-preview');
            const overlay = document.getElementById('photo-preview-overlay');
            const previewImg = photoPreview.querySelector('img');
            
            if (photoPreview && overlay && previewImg && imageSrc) {
                // Don't show overlay on hover; it's causing flicker when moving
                overlay.style.display = 'none';

                // Load and show image
                previewImg.onload = () => {
                    photoPreview.style.display = 'block';
                };
                previewImg.onerror = () => {
                    hidePhotoPreview();
                };
                previewImg.src = imageSrc;
            }
        }
        
        function hidePhotoPreview() {
            currentHoveredThumb = null;
            
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                const photoPreview = document.getElementById('photo-preview');
                const overlay = document.getElementById('photo-preview-overlay');
                
                if (photoPreview) photoPreview.style.display = 'none';
                if (overlay) overlay.style.display = 'none';
            }, 60);
        }

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Document Upload Functions
        function handleDocumentUploadButtonClick(iid, studentName, docType) {
            console.log('Document upload button clicked for IID:', iid, 'Student Name:', studentName, 'Doc Type:', docType);
            
            // Find student by IID with string comparison
            currentStudent = allStudentsData.find(s => {
                const studentIID = String(s.iid || '').trim();
                const searchIID = String(iid || '').trim();
                return studentIID === searchIID;
            });
            
            if (!currentStudent) {
                console.error('Student not found with IID:', iid);
                showStatus(`Student not found (IID: ${iid})`, 'error');
                return;
            }

            currentDocumentType = docType;
            openDocumentModal(currentStudent, studentName, docType);
        }

        function openDocumentModal(student, studentName, docType) {
            const docTypeText = docType === 'birth_certificate' ? 'Birth Certificate' : 'Registration Card';
            
            modalDocType.textContent = docTypeText;
            modalDocStudentName.textContent = studentName || student.student_name_en || 'Unknown Student';
            documentModal.style.display = 'flex';
            
            // Reset modal state
            docPreviewContainer.style.display = 'none';
            docFileInput.value = '';
            selectedDocumentFile = null;
            document.getElementById('confirmDocUploadBtn').style.display = 'none';
        }

        function closeDocumentModal() {
            documentModal.style.display = 'none';
            currentStudent = null;
            currentDocumentType = null;
            selectedDocumentFile = null;
            
            // Reset modal state
            docPreviewContainer.style.display = 'none';
            docFileInput.value = '';
        }

        function handleDocumentDragOver(e) {
            e.preventDefault();
            documentUploadArea.classList.add('dragover');
        }

        function handleDocumentDragLeave(e) {
            e.preventDefault();
            documentUploadArea.classList.remove('dragover');
        }

        function handleDocumentFileDrop(e) {
            e.preventDefault();
            documentUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processSelectedDocumentFile(files[0]);
            }
        }

        function handleDocumentFileSelection(e) {
            const file = e.target.files[0];
            if (file) {
                processSelectedDocumentFile(file);
            }
        }

        function processSelectedDocumentFile(file) {
            if (!currentStudent || !currentDocumentType) {
                showStatus('Please select a student and document type first', 'warning');
                return;
            }

            // Validate file
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            const allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png'];
            
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
                showStatus('Please select a valid document file (PDF, JPG, PNG)', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showStatus('File size too large. Please select a document under 5MB', 'error');
                return;
            }

            selectedDocumentFile = file;
            
            // Show preview
            showDocumentPreview(file);
            document.getElementById('confirmDocUploadBtn').style.display = 'inline-flex';
        }

        function showDocumentPreview(file) {
            const fileType = file.type;
            const fileName = file.name;
            
            if (fileType === 'application/pdf') {
                docPreview.innerHTML = `
                    <div style="padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📄</div>
                        <div style="font-weight: 500; color: #334155;">${fileName}</div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 5px;">PDF Document</div>
                    </div>
                `;
            } else if (fileType.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    docPreview.innerHTML = `
                        <div style="text-align: center;">
                            <img src="${e.target.result}" alt="Document preview" style="max-width: 300px; max-height: 200px; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <div style="font-size: 12px; color: #64748b; margin-top: 5px;">${fileName}</div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
            
            docPreviewContainer.style.display = 'block';
        }

        async function processDocumentUpload() {
            if (!currentStudent || !selectedDocumentFile || !currentDocumentType) {
                showStatus('Please select a student, document type and file', 'warning');
                return;
            }

            try {
                showDocumentLoading(true);
                showStatus('Processing document...', 'success');

                // Generate filename based on document type and IID
                const fileExtension = selectedDocumentFile.name.toLowerCase().substring(selectedDocumentFile.name.lastIndexOf('.'));
                const prefix = currentDocumentType === 'birth_certificate' ? 'birth' : 'reg';
                const filename = `${prefix}-${currentStudent.iid}${fileExtension}`;

                // Upload to ImgBB
                showStatus('Uploading to ImgBB...', 'success');
                const imgbbUrl = await uploadDocumentToImgBB(selectedDocumentFile, filename);

                // Update database
                showStatus('Updating database...', 'success');
                const dbColumn = currentDocumentType === 'birth_certificate' ? 'birth_certificate_url' : 'registration_card_url';
                await updateStudentDocument(currentStudent.iid, dbColumn, imgbbUrl);

                // Success
                showStatus('Document uploaded and updated successfully! ✅', 'success');
                
                // Update local data and refresh table
                const studentIndex = allStudentsData.findIndex(s => s.iid === currentStudent.iid);
                if (studentIndex !== -1) {
                    allStudentsData[studentIndex][dbColumn] = imgbbUrl;
                }
                filterAndRenderData(); // Refresh table display

                // Close modal after successful upload
                setTimeout(() => {
                    closeDocumentModal();
                }, 2000);

            } catch (error) {
                console.error('Document upload error:', error);
                showStatus('Failed to upload document: ' + error.message, 'error');
            } finally {
                showDocumentLoading(false);
            }
        }

        async function uploadDocumentToImgBB(file, filename) {
            const formData = new FormData();
            formData.append('key', IMGBB_API_KEY);
            formData.append('image', file, filename);
            formData.append('album', 'student_documents');

            const response = await fetch(IMGBB_UPLOAD_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('ImgBB upload failed: ' + response.statusText);
            }

            const data = await response.json();
            
            if (!data.success) {
                throw new Error('ImgBB upload failed: ' + (data.error?.message || 'Unknown error'));
            }

            return data.data.url;
        }

        async function updateStudentDocument(iid, column, documentUrl) {
            const updateData = {};
            updateData[column] = documentUrl;
            
            const { error } = await supabase
                .from(tableName)
                .update(updateData)
                .eq('iid', iid);

            if (error) {
                throw new Error('Database update failed: ' + error.message);
            }
        }

        function showDocumentLoading(show) {
            docLoadingIndicator.style.display = show ? 'block' : 'none';
            
            // Disable controls during upload
            const controls = document.querySelectorAll('#documentModal button, #documentModal select, #documentModal input');
            controls.forEach(control => {
                control.disabled = show;
            });
        }

        // Global function for onclick fallback (if needed)
        window.uploadPhoto = function(iid, studentName) {
            console.log('Global uploadPhoto called with:', iid, studentName);
            handleUploadButtonClick(iid, studentName);
        };

        window.uploadDocument = function(iid, studentName, docType) {
            console.log('Global uploadDocument called with:', iid, studentName, docType);
            handleDocumentUploadButtonClick(iid, studentName, docType);
        };

        // Download photo function
        window.downloadPhoto = async function(iid, type, activeClass, activeSection, activeRoll) {
            console.log('Download photo called with:', iid, type, activeClass, activeSection, activeRoll);
            
            // Find the student from both filtered data and all students data
            let student = filteredData.find(s => String(s.iid || '').trim() === String(iid || '').trim());
            if (!student) {
                student = allStudentsData.find(s => String(s.iid || '').trim() === String(iid || '').trim());
            }
            
            if (!student) {
                console.error('Student not found with IID:', iid);
                showStatus('Student not found for download', 'error');
                return;
            }

            if (!student.student_photo_url || !String(student.student_photo_url).trim()) {
                console.error('No photo URL found for student:', iid);
                showStatus('No photo available for this student', 'error');
                return;
            }

            console.log('Found student for download:', student);
            console.log('Photo URL:', student.student_photo_url);

            let filename;
            if (type === 'iid') {
                filename = `avater-${iid}.jpg`;
            } else if (type === 'class-roll') {
                filename = `${activeClass}-${activeSection}-${activeRoll}.jpg`;
            } else {
                filename = `photo-${iid}.jpg`;
            }

            try {
                // Use fetch to download the image as blob for direct download
                const response = await fetch(student.student_photo_url, {
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                
                // Create download link and trigger download
                const downloadLink = document.createElement('a');
                downloadLink.href = blobUrl;
                downloadLink.download = filename;
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // Clean up blob URL
                setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
                
                showStatus(`Photo downloaded successfully: ${filename}`, 'success');
                console.log('Direct download completed for:', filename);
                
            } catch (error) {
                console.error('Download error:', error);
                console.log('Falling back to direct link method');
                
                // Fallback method: Try direct link download
                try {
                    const link = document.createElement('a');
                    link.href = student.student_photo_url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showStatus(`Photo download initiated: ${filename}`, 'success');
                } catch (fallbackError) {
                    console.error('Fallback download also failed:', fallbackError);
                    showStatus('Unable to download photo directly. Please try again.', 'error');
                }
            }
        };
    </script>
</body>
</html>