<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>seat List — Generate Cards</title>
	<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
	<link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
	<style>
		:root{ --bg:#f6f7f9; --card:#fff; --muted:#6b7280; --border:#e5e7eb; --primary:#0ea5e9; }
		*{ box-sizing:border-box }
		body{ margin:0; font-family:'Noto Sans Bengali','Hind Siliguri', system-ui, Arial, sans-serif; background:var(--bg); color:#111; }
		header{ position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); z-index:10 }
		.container{ max-width:1200px; margin:0 auto; padding:1rem }
		h1{ margin:.25rem 0; text-align:center }
		.toolbar{ display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; justify-content:center; margin:.5rem 0 1rem }
		select, input[type=search]{ padding:.5rem .7rem; border:1px solid #d1d5db; border-radius:10px; background:#fff }
		.btn{ display:inline-flex; align-items:center; gap:.45rem; padding:.55rem 1rem; border:1px solid #d1d5db; border-radius:10px; background:#fff; color:#111; text-decoration:none; font-weight:600; box-shadow:0 1px 2px rgba(0,0,0,.04); cursor:pointer }
		.btn.primary{ background:var(--primary); border-color:#0284c7; color:#fff }
		.btn:disabled{ opacity:.6; cursor:not-allowed }
		.status{ color:var(--muted); font-size:.9rem }
		table{ border-collapse:collapse; width:100%; background:#fff; border:1px solid #e8eef8 }
		thead th{ position:sticky; top:0; background:linear-gradient(180deg,#f8fafc,#f1f5f9); text-align:left; padding:.6rem .7rem; border-bottom:2px solid #e6eef7 }
		td{ padding:.55rem .7rem; border-top:1px solid #f1f5f9 }
		tbody tr:hover{ background:#fbfdff }
		.left-tools{ display:flex; gap:.5rem; align-items:center }
		.footbar{ display:flex; justify-content:space-between; align-items:center; gap:.75rem; padding:1rem 0 }
		.muted{ color:var(--muted) }
		.btn.pdf{ background:#ef4444; border-color:#dc2626; color:#fff; padding:.35rem .7rem; border-radius:999px; font-size:.85rem }
		.btn.pdf:hover{ background:#dc2626 }
		/* Print area */
		.print-area{ display:none }
		@media print{
			header, .controls, .list-area{ display:none !important }
			body{ background:#fff }
			.print-area{ display:block }
			@page{ size:A4; margin:6mm }
		}
		.sheet{ width:210mm; margin:0 auto }
		.print-grid{ display:grid; grid-template-columns:repeat(5, 1fr); gap:4mm; padding:2mm }
		.card{ position:relative; aspect-ratio: 210 / 115; background:#fff url('admit.png') center/cover no-repeat; overflow:hidden; border:1px solid #e5e7eb }
		.card .t{ position:absolute; font-family:'Times New Roman', Times, serif; color:#111 }
		/* Approximate placements (tweak if needed) */
		.t.name{ left:10mm; top:40mm; font-size:4.8mm; letter-spacing:.3mm; text-transform:uppercase }
		.t.class{ left:10mm; top:86mm; font-size:5mm }
		.t.section{ left:76mm; top:86mm; font-size:5mm; text-transform:uppercase }
		.t.roll{ left:10mm; top:102mm; font-size:5.5mm }
		.t.exam{ left:60mm; top:52mm; font-weight:700; font-size:4.6mm }
		.t.year{ left:138mm; top:52mm; font-weight:700; font-size:4.6mm }
		.t.iid{ left:78mm; top:122mm; font-size:4mm }
	/* QR/Barcode removed */
	</style>


	<script>
		// Data source: datalist.html cache (same as admit/admitlist.html)
		const DATALIST_CACHE_KEY = 'datalist_rows_v2';

		let sheets = []; // dropdown options {id,name,cls,section,session}
		let allStudents = []; // rendered students
		let filters = { cls:'', section:'', session:'' };
		let exam = 'Half Yearly  Examination';
		let year = '2025';

		function updateStatus(msg){ const el=document.getElementById('status'); if(el) el.textContent = msg; }

		function readDatalistCache(){
			try{
				const raw = localStorage.getItem(DATALIST_CACHE_KEY);
				if(!raw) return null;
				const obj = JSON.parse(raw);
				if(!obj || !Array.isArray(obj.rows)) return null;
				return obj.rows;
			}catch(e){ return null; }
		}

		function computeActiveFromRow(r){
			const s = String(r.session||'').trim();
			let active_class='', active_section='', active_roll='';
			if(s==='2026'){ active_class=r.class_2026||''; active_section=r.section_2026||''; active_roll=r.roll_2026||''; }
			else if(s==='2025'){ active_class=r.class_2025||''; active_section=r.section_2025||''; active_roll=r.roll_2025||''; }
			return { session:s, active_class:String(active_class||''), active_section:String(active_section||''), active_roll:String(active_roll||'') };
		}

		function buildGroupOptions(){
			const rows = readDatalistCache();
			if(!rows) return [];
			const seen = new Set(); const pairs=[];
			for(const r of rows){
				if(String(r.status||'').toUpperCase().includes('TC')) continue;
				const a = computeActiveFromRow(r);
				if(!a.active_roll || a.active_roll.trim()==='') continue;
				if(!a.active_class || !a.active_section || !a.session) continue;
				const key = `${a.active_class}-${a.active_section}-${a.session}`;
				if(seen.has(key)) continue; seen.add(key);
				pairs.push({ id:'cache', name:key, cls:a.active_class, section:a.active_section, session:a.session });
			}
			// Sort by class (numeric); tie-breaker by name for consistent order
			pairs.sort((x,y)=>{
				const cx = Number(x.cls)||0, cy = Number(y.cls)||0;
				if(cx!==cy) return cx - cy;
				return String(x.name).localeCompare(String(y.name));
			});
			return pairs;
		}

		function renderTable(){
			const tbody = document.querySelector('#list tbody'); if(!tbody) return;
			tbody.innerHTML='';
			// Sort by roll (numeric asc), non-numeric at the end
			const rows = [...allStudents].sort((a,b)=>{
				const ra = Number(a.roll), rb = Number(b.roll);
				const va = Number.isFinite(ra) ? ra : Infinity;
				const vb = Number.isFinite(rb) ? rb : Infinity;
				if(va !== vb) return va - vb;
				return String(a.roll||'').localeCompare(String(b.roll||''));
			});
			document.getElementById('count').textContent = `${rows.length} students`;
			rows.forEach((s)=>{
				const tr=document.createElement('tr');
				const tdSel=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.className='row-check'; cb.dataset.index = s._idx; tdSel.appendChild(cb); tr.appendChild(tdSel);
				const tdName=document.createElement('td'); tdName.textContent=s.name||''; tr.appendChild(tdName);
				const tdFather=document.createElement('td'); tdFather.textContent=s.father||''; tr.appendChild(tdFather);
				const tdClass=document.createElement('td'); tdClass.textContent=s.cls||''; tr.appendChild(tdClass);
				const tdSection=document.createElement('td'); tdSection.textContent=s.section||''; tr.appendChild(tdSection);
				const tdRoll=document.createElement('td'); tdRoll.textContent=s.roll||''; tr.appendChild(tdRoll);
				const tdIID=document.createElement('td'); tdIID.textContent = s.iid || ''; tr.appendChild(tdIID);
				const tdGroup=document.createElement('td'); tdGroup.textContent = s.group || ''; tr.appendChild(tdGroup);
				const tdPdf=document.createElement('td');
					const btn=document.createElement('a'); btn.target='_blank'; btn.rel='noopener'; btn.className='btn pdf'; btn.textContent='PDF';
					const params = new URLSearchParams({ exam, year, name: s.name||'', father: s.father||'', cls: s.cls||'', section: s.section||'', roll: String(s.roll||''), iid: String(s.iid||''), GROUP: String(s.group||'') });
					btn.href = `print_admit.html?${params.toString()}`;
					tdPdf.appendChild(btn); tr.appendChild(tdPdf);
				tbody.appendChild(tr);
			});
			document.getElementById('selectAll').checked=false;
		}

		function getSelected(){
			const set = new Set([...document.querySelectorAll('.row-check:checked')].map(el=>Number(el.dataset.index)));
			return allStudents.filter(s=> set.has(s._idx) );
		}

		function renderPrint(students){
			const wrap = document.getElementById('printArea'); if(!wrap) return;
			wrap.innerHTML = ''; wrap.style.display = 'block';
			const sheet = document.createElement('div'); sheet.className='sheet';
			const grid = document.createElement('div'); grid.className='print-grid'; sheet.appendChild(grid); wrap.appendChild(sheet);
			students.forEach(s=>{
				const card = document.createElement('div'); card.className='card';
				const tn = document.createElement('div'); tn.className='t name'; tn.textContent = String(s.name||'').toUpperCase(); card.appendChild(tn);
				const tc = document.createElement('div'); tc.className='t class'; tc.textContent = s.cls||''; card.appendChild(tc);
				const ts = document.createElement('div'); ts.className='t section'; ts.textContent = s.section||''; card.appendChild(ts);
				const tr = document.createElement('div'); tr.className='t roll'; tr.textContent = s.roll||''; card.appendChild(tr);
				const te = document.createElement('div'); te.className='t exam'; te.textContent = exam; card.appendChild(te);
				const ty = document.createElement('div'); ty.className='t year'; ty.textContent = year; card.appendChild(ty);
				if(s.iid){ const ti=document.createElement('div'); ti.className='t iid'; ti.textContent = `IID : ${s.iid}`; card.appendChild(ti); }
				grid.appendChild(card);
			});
			// No QR for seat plan
		}

		function loadForCurrentFilter(){
			const { cls, section, session } = filters; if(!cls || !section || !session){ return; }
			updateStatus('Loading students from cache…');
			allStudents = []; let idx=0;
			const rows = readDatalistCache();
			if(!rows){ updateStatus('Cache missing. Open 0newdatabase/datalist.html first.'); return; }
			for(const r of rows){
				if(String(r.status||'').toUpperCase().includes('TC')) continue;
				const a = computeActiveFromRow(r);
				if(!a.active_roll || a.active_roll.trim()==='') continue;
				if(a.session !== String(session)) continue;
				if(String(a.active_class) !== String(cls)) continue;
				if(String(a.active_section).toLowerCase() !== String(section).toLowerCase()) continue;
				const name = r.student_name_en || '';
				const father = r.father_name_en || '';
				const grp = r.group || r.GROUP || '';
				allStudents.push({
					_idx: idx++,
					name: String(name||''),
					father: String(father||''),
					roll: String(a.active_roll||''),
					iid: r.iid || '',
					group: String(grp||''),
					cls: String(a.active_class||''),
					section: String(a.active_section||''),
					sheetId: 'cache', sheetName: 'datalist', row: r.iid
				});
			}
			renderTable();
			updateStatus('Ready — Source: datalist cache');
		}

		function init(){
			updateStatus('Loading Class-Section-Session from cache…');
			sheets = buildGroupOptions();
			const tableSel = document.getElementById('tableFilter');
			if(tableSel){
				tableSel.innerHTML='';
				const opt = document.createElement('option'); opt.value=''; opt.textContent='Class-Section-Session'; tableSel.appendChild(opt);
				for(const {name, cls, section, session} of sheets){ const o=document.createElement('option'); o.value=name; o.textContent=name; tableSel.appendChild(o); }
			}
			document.getElementById('count').textContent = `${sheets.length} groups found — select one`;
			updateStatus('Waiting for selection');
		}

		window.addEventListener('DOMContentLoaded', ()=>{
			init();
			const tableSel = document.getElementById('tableFilter');
			if(tableSel){
				tableSel.addEventListener('change', e=>{
					const key = e.target.value;
					const match = (sheets||[]).find(it=>it.name===key);
					filters.cls = match? match.cls : '';
					filters.section = match? match.section : '';
					filters.session = match? match.session : '';
					if(match && match.session){
						year = String(match.session);
						const yearSel = document.getElementById('yearSelect');
						if(yearSel){ yearSel.value = year; }
					}
					allStudents = []; renderTable();
					if(filters.cls && filters.section && filters.session){ loadForCurrentFilter(); }
				});
			}
			document.getElementById('examSelect').addEventListener('change', e=>{ exam = e.target.value; });
			document.getElementById('yearSelect').addEventListener('change', e=>{ year = e.target.value; });
			document.getElementById('selectAll').addEventListener('change', e=>{ document.querySelectorAll('.row-check').forEach(cb=>{ cb.checked = e.target.checked; }); });
			document.getElementById('generate').addEventListener('click', ()=>{
				const sel = getSelected(); if(!sel.length){ alert('Select at least one student'); return; }
				const payload = { exam, year, students: sel.map(s=>({ name:s.name, father:s.father, roll:s.roll, cls:s.cls, section:s.section, iid:s.iid, group:s.group })) };
				const key = 'admit_bulk_' + Date.now();
				try{ localStorage.setItem(key, JSON.stringify(payload)); }catch(e){ alert('Unable to prepare preview (storage).'); return; }
				const qrParam = new URLSearchParams(location.search).get('qr') || '0';
				window.open(`print_selected.html?key=${encodeURIComponent(key)}&qr=${encodeURIComponent(qrParam)}`, '_blank', 'noopener');
				renderPrint(sel);
			});
			const pdfBtn = document.getElementById('pdfBtn'); if(pdfBtn){ pdfBtn.addEventListener('click', ()=>{ const sel = getSelected(); if(!sel.length){ alert('Select at least one student'); return; } renderPrint(sel); }); }
		});
	</script>
</head>
<body>
	<header>
		<div class="container">
			<h1>Seat Plan — Select and Generate</h1>
			<div class="toolbar controls">
				<div class="left-tools">
					<label><input type="checkbox" id="selectAll"> Select all</label>
				</div>
				<select id="tableFilter" aria-label="Class-Section-Session"></select>
				<select id="examSelect" aria-label="Exam">
					<option>Half Yearly  Examination</option>
					<option>Annual  Examination</option>
					<option>Pre-Test  Examination</option>
					<option>Test Examination</option>
				</select>
				<select id="yearSelect" aria-label="Year">
					<option>2025</option>
					<option>2026</option>
				</select>
				<div style="flex:1 1 auto"></div>
				<button id="generate" class="btn primary">Generate selected</button>
				<button id="pdfBtn" class="btn" title="Print to PDF">PDF</button>
				<span id="status" class="status"></span>
			</div>
		</div>
	</header>
	<main class="container list-area">
		<table id="list">
			<thead>
				<tr>
					<th style="width:48px">Select</th>
					<th>Name</th>
					<th>Father</th>
					<th>Class</th>
					<th>Section</th>
					<th>Roll</th>
					<th>IID</th>
					<th>Group</th>
					<th>PDF</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
		<div class="footbar">
			<div class="muted" id="count">0 students</div>
			<div class="muted">Tip: Use filters above, tick students, then Generate to print 10 per A4 (5×2).</div>
		</div>
	</main>
	<div id="printArea" class="print-area"></div>
</body>
</html>
