<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ID card list </title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- Kalpurush Bangla font -->
  <link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: 'Kalpurush','Noto Sans Bengali','Hind Siliguri','SolaimanLipi','Vrinda','Siyam Rupali', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7f9; color: #111; }
    .container { max-width: 1100px; margin: 0 auto; width: 100%; padding: 0 1rem; box-sizing: border-box; }
    header { position: sticky; top: 0; background: white; padding: 0.85rem 0; border-bottom: 1px solid #e5e7eb; z-index: 10; }
    h1 { margin: 0; font-size: 1.2rem; text-align:center; }
    main { padding: 1rem 0 2rem; }
    .toolbar { display: flex; gap: .75rem; align-items: center; margin: 0.75rem 0 1.1rem; flex-wrap:wrap; justify-content:center; }
    .nav-btn { background:#2563eb; color:#fff; text-decoration:none; padding:.55rem .9rem; font-size:.7rem; font-weight:600; border-radius:6px; letter-spacing:.4px; display:inline-block; }
    .nav-btn:hover { background:#1d4ed8; }
    .nav-btn.secondary { background:#64748b; }
    .nav-btn.secondary:hover { background:#475569; }
    input[type="search"]{ padding: .5rem .75rem; border: 1px solid #d1d5db; border-radius: 8px; min-width: 240px; }
    .table-wrap { overflow: auto; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    table { border-collapse: collapse; width: 100%; min-width: 720px; }
    thead th { position: sticky; top: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; text-align: left; padding: .75rem; font-size: .9rem; }
    tbody td { border-top: 1px solid #f1f5f9; padding: .65rem .75rem; font-size: .92rem; }
    tbody tr:hover { background: #f9fafb; }
    .muted { color: #6b7280; }
    .link { color: #2563eb; text-decoration: none; font-weight: 600; }
    .link:hover { text-decoration: underline; }
    .status { margin-left: .5rem; font-size: .9rem; }
    .error { color: #b91c1c; }
    .sep { color: #9ca3af; margin: 0 .25rem; }
  /* PDF badge */
  .pdf-badge { display:inline-block; background:#dc2626; color:#fff; font-size:.65rem; font-weight:600; padding:.35rem .6rem .4rem; border-radius:999px; text-decoration:none; letter-spacing:.5px; box-shadow:0 2px 4px rgba(0,0,0,.15); line-height:1; }
  .pdf-badge:hover { background:#b91c1c; text-decoration:none; }
  #genAllBtn { background:#0d9488; }
  #genAllBtn:hover { background:#0f766e; }
  .cert-card { position:relative; padding:1rem; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); font-size:.7rem; line-height:1.4; }
  .cert-card h3 { margin:.1rem 0 .4rem; font-size:.85rem; }
  .cert-qr { position:absolute; top:1rem; right:1rem; text-align:center; font-size:.55rem; }
  .cert-qr img { width:80px; height:80px; display:block; }
  #allCertificates { display:none; margin-top:2rem; display:block; }
    @media (prefers-color-scheme: dark) {
      body { background: #0b1020; color: #e5e7eb; }
      header, .table-wrap { background: #111729; border-color: #263148; box-shadow: 0 8px 24px rgba(0,0,0,.4); }
      thead th { background: #0f162a; border-bottom-color: #263148; }
      tbody td { border-top-color: #1d2845; }
      input[type="search"]{ background: #0f162a; color: #e5e7eb; border-color: #263148; }
      .muted { color: #9aa5b1; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9VIF2PCcYdHzOYJbq6y-uI4gZimQlDeoBL-9wi7cbavaPgB9-k42z0smwJ7GDWnpeQ3S4rVT9L-It/pub?gid=0&single=true&output=csv';
    function getVal(row, headers, key){ const h = headers[key]; const v = h ? row[h] : ''; return v == null ? '' : String(v).trim(); }

    function buildHeaderMap(fields){
      const map={};
      const norm = s=>String(s).toLowerCase().replace(/[^a-z0-9]+/g,'');
      const want={
        sl:['sl','serial','serialno','serialnumber','serial_no'],
        name:['name_bangla','studentname','fullname'],
        father:['father_bangla','fathername','fathersname','father_s_name','fname'],
        mother:['mother_bangla','mothername','mothersname','m_name'],
        roll:['roll_bangla','rollno','rollnumber'],
        iid:['iid','id','studentid','sid','uniqueid'],
        registrationnumber:['registrationnumber','registration number','registration','regno','reg no','reg_number'],
        dob:['dob','dateofbirth','birthdate','date of birth'],
        gender:['gender','sex'],
        group:['group','grp'],
        gpa:['gpa','gradepoint','grade point','result'],
        sscmonth:['sscmonth','exammonth','exam month','month'],
        session:['session','academic session','sess','sessionyear','year']
      };
      for(const f of fields){
        const nf=norm(f);
        for(const key of Object.keys(want)){
          if(map[key]) continue;
            if(want[key].some(w=>nf===norm(w))){ map[key]=f; }
        }
      }
      return map;
    }

    function createRow(tr, cells){
      cells.forEach(c => { const td = document.createElement('td'); if(c && c.element) td.appendChild(c.element); else td.textContent = c ?? ''; tr.appendChild(td); });
      return tr;
    }

    function renderTable(rows){ const tbody=document.querySelector('#tbody'); tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r)); document.querySelector('#count').textContent=`${rows.length}`; }

  function buildRows(data, headers){
    const rows=[];
    for(const obj of data){
      const sl=getVal(obj, headers,'sl');
      const name=getVal(obj, headers,'name');
      const father=getVal(obj, headers,'father');
      const roll=getVal(obj, headers,'roll');
      const iid=getVal(obj, headers,'iid');
      // Name link
      const nameLink=document.createElement('a');
      nameLink.className='link';
      nameLink.textContent=name||'(No Name)';
      const hrefBase='verify.html';
      let certHref = hrefBase;
      if(iid) certHref = `${hrefBase}?iid=${encodeURIComponent(iid)}`;
      else if(sl) certHref = `${hrefBase}?sl=${encodeURIComponent(sl)}`;
      nameLink.href = certHref;
      // PDF badge link (open in new tab; can be used by browser print to save as PDF)
      const pdfLink=document.createElement('a');
      pdfLink.className='pdf-badge';
      pdfLink.textContent='PDF';
      pdfLink.href=certHref + (certHref.includes('?') ? '&' : '?') + 'view=pdf';
      pdfLink.target='_blank';
      pdfLink.rel='noopener';
      pdfLink.title='Open certificate (use browser Print to save as PDF)';
      const tr=document.createElement('tr');
  createRow(tr,[sl,{element:nameLink},father,iid,{element:pdfLink}]);
      rows.push(tr);
    }
    return rows;
  }

    function setupFilter(allRows){ const input=document.querySelector('#search'); const apply=()=>{ const q=input.value.toLowerCase().trim(); if(!q) return renderTable(allRows); const filtered=allRows.filter(tr=>tr.textContent.toLowerCase().includes(q)); renderTable(filtered); }; input.addEventListener('input',apply); apply(); }

  function loadFromCache(){ return null; }
  function saveCache(){ /* no-op */ }

    function showRetry(msg){
      const status=document.querySelector('#status');
      status.textContent=msg;
      status.classList.add('error');
      if(!document.getElementById('retryBtn')){
        const btn=document.createElement('button');
        btn.id='retryBtn'; btn.textContent='Retry'; btn.style.marginLeft='.75rem'; btn.style.padding='.35rem .7rem'; btn.style.fontSize='.65rem'; btn.style.cursor='pointer'; btn.onclick=()=>{ btn.remove(); initLoad(true); };
        status.parentElement.appendChild(btn);
      }
    }

    const MAX_ATTEMPTS = 3;
    const RETRY_DELAY_MS = 900;
    let attemptNo = 0;
    const DEBUG = new URLSearchParams(location.search).has('debug');

    function logDbg(...a){ if(DEBUG) console.log('[TL]', ...a); }

    function parseAndRender(results, source){
      const status=document.querySelector('#status');
      if(!results || !results.data){ throw new Error('Empty results'); }
      const fields = (results.meta && results.meta.fields) || Object.keys(results.data[0]||{});
      const headers=buildHeaderMap(fields);
      if(Object.keys(headers).length === 0){ throw new Error('Header map empty'); }
      const rows=buildRows(results.data, headers);
      setupFilter(rows);
      status.textContent = 'Loaded';
      if(DEBUG) status.textContent += ' ('+source+')';
      window.__ALL_CERT_DATA = results.data;
      window.__ALL_CERT_HEADERS = headers;
    }

    async function manualFetchFallback(){
      logDbg('Manual fetch fallback fetching text...');
      const res = await fetch(CSV_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      return new Promise((resolve,reject)=>{
        Papa.parse(text, { header:true, skipEmptyLines:true, complete: r=>resolve(r), error: e=>reject(e) });
      });
    }

    function attemptLoad(){
      attemptNo++;
      const status=document.querySelector('#status');
      status.classList.remove('error');
      status.textContent = 'Loading… (Attempt '+attemptNo+'/'+MAX_ATTEMPTS+')';
      logDbg('Attempt', attemptNo);
      Papa.parse(CSV_URL, {
        download:true, header:true, skipEmptyLines:true,
        complete:(results)=>{
          try { parseAndRender(results, 'direct'); }
          catch(e){
            console.error('Primary parse render error', e);
            if(attemptNo < MAX_ATTEMPTS){ return scheduleRetry('Parse error'); }
            // Last resort: manual fetch parse
            manualFetchFallback().then(r=>{ parseAndRender(r, 'fallback'); })
              .catch(err => { console.error('Fallback failed', err); showRetry('Failed to render data'); });
          }
        },
        error:(err)=>{
          console.error('Papa error', err);
          if(attemptNo < MAX_ATTEMPTS){ return scheduleRetry('Load error'); }
          manualFetchFallback().then(r=>{ parseAndRender(r, 'fallback'); })
            .catch(e2 => { console.error('Fallback fetch failed', e2); showRetry('Failed to load CSV'); });
        }
      });
    }

    function scheduleRetry(reason){
      const status=document.querySelector('#status');
      status.textContent = 'Retrying… '+reason+' ('+attemptNo+'/'+MAX_ATTEMPTS+')';
      setTimeout(attemptLoad, RETRY_DELAY_MS * attemptNo); // backoff
    }

    function initLoad(){
      attemptNo = 0;
      attemptLoad();
    }

    function pronouns(gRaw){
      const g=(gRaw||'').toLowerCase();
      const isFem=/^(f|female|girl|she)/.test(g);
      const isMale=/^(m|male|boy|he)/.test(g)&&!isFem;
      const child=isFem?'Daughter':isMale?'Son':'Son/Daughter';
      const he=isFem?'she':isMale?'he':'he / she';
      const his=isFem?'her':isMale?'his':'his / her';
      const him=isFem?'her':isMale?'him':'him / her';
      return {child,he,his,him,He:he.charAt(0).toUpperCase()+he.slice(1),His:his.charAt(0).toUpperCase()+his.slice(1)};
    }
    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function buildCertHtml(r){
      const p=pronouns(r.gender);
      const line1=`This is to certify that <strong><u>${esc(r.name)}</u></strong> ${p.child} of ${esc(r.father)} and ${esc(r.mother)} duly passed the S.S.C Examination held in the month of ${esc(r.sscmonth)} under the Board of Intermediate and Secondary Education, Cumilla as a regular/irregular candidate in ${esc(r.group)} group and secured G.P.A ${esc(r.gpa)} on a scale of 5.00. ${p.His} S.S.C registration number is ${esc(r.registrationnumber)} & S.S.C roll is ${esc(r.roll)}.`;
      const line2=`${p.His} date of birth is ${esc(r.dob)}. In so far as I know, ${p.he} bears a good moral character and did not take part in any activities subversive of the state or of the school during ${p.his} stay in the school.`;
      const line3=`I wish ${p.him} every success in life.`;
      return `<div class="cert-body">${line1}<br><br><em>${line2}</em><br><br><em>${line3}</em></div>`;
    }
    function generateAll(){
      // Open new page that renders all certificates with full layout like verify.html
      const url = 'verify.html';
      window.open(url, '_blank');
    }
    window.addEventListener('DOMContentLoaded', () => {
      initLoad();
      const b1=document.getElementById('genAllBtn');
      const b2=document.getElementById('genAllBtnBottom');
      if(b1) b1.addEventListener('click', generateAll);
      if(b2) b2.addEventListener('click', generateAll);
    });
  </script>
</head>
<body>
  <header>
    <div class="container">
      <h1>ID Card List <span class="muted status" id="status"></span></h1>
      <p style="text-align:center; margin:.35rem 0 0; font-size:.8rem;" class="muted"> Please wait 5 minutes for processing after ID card entry.</p>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Filter by any text…" aria-label="Filter" />
        <span class="muted">Rows: <span id="count">0</span></span>
        <a class="nav-btn" href="../index.html">Home</a>
        <a class="nav-btn secondary" href="https://docs.google.com/spreadsheets/d/1ET8JKqhrqXUwb1KVbKVN3ldEQeDtHHN2qckzTr5lI4E/edit?gid=0#gid=0'">Database for ID Cards </a>
  <a id="genAllBtn" class="nav-btn" href="/index.html">Home</a>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="table-wrap">
        <table role="table" aria-label="Testimonials">
          <thead>
            <tr>
              <th>SL. NO</th>
              <th>Name (Open Certificate)</th>
              <th>Father’s Name</th>
              <th>iid</th>
            </tr>
          </thead>
            <tbody id="tbody"></tbody>
        </table>
      </div>
  <div id="allCertificates"></div>
      <div class="toolbar" style="justify-content:center; margin-top:1.5rem;">
        <a id="genAllBtnBottom" class="nav-btn" href="javascript:void(0)">Generate All</a>
      </div>
    </div>
  </main>
</body>
</html>
