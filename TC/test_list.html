<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transfer Certificate List </title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7f9; color: #111; }
    .container { max-width: 1100px; margin: 0 auto; width: 100%; padding: 0 1rem; box-sizing: border-box; }
    header { position: sticky; top: 0; background: white; padding: 0.85rem 0; border-bottom: 1px solid #e5e7eb; z-index: 10; }
    h1 { margin: 0; font-size: 1.2rem; text-align:center; }
    main { padding: 1rem 0 2rem; }
    .toolbar { display: flex; gap: .75rem; align-items: center; margin: 0.75rem 0 1.1rem; flex-wrap:wrap; justify-content:center; }
    .nav-btn { background:#2563eb; color:#fff; text-decoration:none; padding:.55rem .9rem; font-size:.7rem; font-weight:600; border-radius:6px; letter-spacing:.4px; display:inline-block; }
    .nav-btn:hover { background:#1d4ed8; }
    .nav-btn.secondary { background:#e65e28; }
    .nav-btn.secondary:hover { background:#475569; }
    input[type="search"]{ padding: .5rem .75rem; border: 1px solid #d1d5db; border-radius: 8px; min-width: 240px; }
    .table-wrap { overflow: auto; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    table { border-collapse: collapse; width: 100%; min-width: 720px; }
    thead th { position: sticky; top: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; text-align: left; padding: .75rem; font-size: .9rem; }
    tbody td { border-top: 1px solid #f1f5f9; padding: .65rem .75rem; font-size: .92rem; }
    tbody tr:hover { background: #f9fafb; }
    .muted { color: #6b7280; }
    .link { color: #2563eb; text-decoration: none; font-weight: 600; }
    .link:hover { text-decoration: underline; }
    .status { margin-left: .5rem; font-size: .9rem; }
    .error { color: #b91c1c; }
    .sep { color: #9ca3af; margin: 0 .25rem; }
    @media (prefers-color-scheme: dark) {
      body { background: #0b1020; color: #e5e7eb; }
      header, .table-wrap { background: #111729; border-color: #263148; box-shadow: 0 8px 24px rgba(0,0,0,.4); }
      thead th { background: #0f162a; border-bottom-color: #263148; }
      tbody td { border-top-color: #1d2845; }
      input[type="search"]{ background: #0f162a; color: #e5e7eb; border-color: #263148; }
      .muted { color: #9aa5b1; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQgl1Atq8imTVqFT0696qsx8yazfgbmm5siS7R6VLvuBbCA4BBvrZKGVdrmPRj6aPtNwAh7zJflG54_/pub?output=csv';
    function getVal(row, headers, key){ const h = headers[key]; const v = h ? row[h] : ''; return v == null ? '' : String(v).trim(); }

  function buildHeaderMap(fields){
      const map={};
      const norm = s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'');
      const want={
        name:['name','studentname','fullname'],
        father:['father','fathername','fathersname','father_s_name','fname'],
        class:['class','cls','classname'],
        roll:['roll','rollno','rollnumber'],
    iid:['iid','id','studentid','sid','uniqueid'],
    sl:['sl','serial','serialno','serialnumber','serial_no']
      };
      for(const f of fields){
        const nf=norm(f);
        for(const key of Object.keys(want)){
          if(map[key]) continue;
            if(want[key].some(w=>nf===norm(w))){ map[key]=f; }
        }
      }
      return map;
    }

    function createRow(tr, cells){
      cells.forEach(c => { const td = document.createElement('td'); if(c && c.element) td.appendChild(c.element); else td.textContent = c ?? ''; tr.appendChild(td); });
      return tr;
    }

    function renderTable(rows){ const tbody=document.querySelector('#tbody'); tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r)); document.querySelector('#count').textContent=`${rows.length}`; }

  function buildRows(data, headers){
      const rows=[];
      for(const obj of data){
    const sl=getVal(obj, headers,'sl');
        const name=getVal(obj, headers,'name');
        const father=getVal(obj, headers,'father');
        const klass=getVal(obj, headers,'class');
        const roll=getVal(obj, headers,'roll');
        const iid=getVal(obj, headers,'iid');
        const pdfLink=document.createElement('a'); pdfLink.className='link'; pdfLink.textContent='PDF'; pdfLink.href=`./test_view.html?iid=${encodeURIComponent(iid)}`;
        const wordLink=document.createElement('a'); wordLink.className='link'; wordLink.textContent='Word'; wordLink.href=`./certificate_word.html?iid=${encodeURIComponent(iid)}`;
        const cell=document.createElement('div'); cell.appendChild(pdfLink); const sep=document.createElement('span'); sep.className='sep'; sep.textContent='|'; cell.appendChild(sep); cell.appendChild(wordLink);
    const tr=document.createElement('tr'); createRow(tr,[sl,name,father,klass,roll,iid,{element:cell}]); rows.push(tr);
      }
      return rows;
    }

    function setupFilter(allRows){ const input=document.querySelector('#search'); const apply=()=>{ const q=input.value.toLowerCase().trim(); if(!q) return renderTable(allRows); const filtered=allRows.filter(tr=>tr.textContent.toLowerCase().includes(q)); renderTable(filtered); }; input.addEventListener('input',apply); apply(); }

  function loadFromCache(){ return null; }
  function saveCache(){ /* no-op */ }

    function showRetry(msg){
      const status=document.querySelector('#status');
      status.textContent=msg;
      status.classList.add('error');
      if(!document.getElementById('retryBtn')){
        const btn=document.createElement('button');
        btn.id='retryBtn'; btn.textContent='Retry'; btn.style.marginLeft='.75rem'; btn.style.padding='.35rem .7rem'; btn.style.fontSize='.65rem'; btn.style.cursor='pointer'; btn.onclick=()=>{ btn.remove(); initLoad(true); };
        status.parentElement.appendChild(btn);
      }
    }

    const MAX_ATTEMPTS = 3;
    const RETRY_DELAY_MS = 900;
    let attemptNo = 0;
    const DEBUG = new URLSearchParams(location.search).has('debug');

    function logDbg(...a){ if(DEBUG) console.log('[TL]', ...a); }

    function parseAndRender(results, source){
      const status=document.querySelector('#status');
      if(!results || !results.data){ throw new Error('Empty results'); }
      const fields = (results.meta && results.meta.fields) || Object.keys(results.data[0]||{});
      const headers=buildHeaderMap(fields);
      if(Object.keys(headers).length === 0){ throw new Error('Header map empty'); }
      const rows=buildRows(results.data, headers);
      setupFilter(rows);
      status.textContent = 'Loaded';
      if(DEBUG) status.textContent += ' ('+source+')';
    }

    async function manualFetchFallback(){
      logDbg('Manual fetch fallback fetching text...');
      const res = await fetch(CSV_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      return new Promise((resolve,reject)=>{
        Papa.parse(text, { header:true, skipEmptyLines:true, complete: r=>resolve(r), error: e=>reject(e) });
      });
    }

    function attemptLoad(){
      attemptNo++;
      const status=document.querySelector('#status');
      status.classList.remove('error');
      status.textContent = 'Loading… (Attempt '+attemptNo+'/'+MAX_ATTEMPTS+')';
      logDbg('Attempt', attemptNo);
      Papa.parse(CSV_URL, {
        download:true, header:true, skipEmptyLines:true,
        complete:(results)=>{
          try { parseAndRender(results, 'direct'); }
          catch(e){
            console.error('Primary parse render error', e);
            if(attemptNo < MAX_ATTEMPTS){ return scheduleRetry('Parse error'); }
            // Last resort: manual fetch parse
            manualFetchFallback().then(r=>{ parseAndRender(r, 'fallback'); })
              .catch(err => { console.error('Fallback failed', err); showRetry('Failed to render data'); });
          }
        },
        error:(err)=>{
          console.error('Papa error', err);
          if(attemptNo < MAX_ATTEMPTS){ return scheduleRetry('Load error'); }
          manualFetchFallback().then(r=>{ parseAndRender(r, 'fallback'); })
            .catch(e2 => { console.error('Fallback fetch failed', e2); showRetry('Failed to load CSV'); });
        }
      });
    }

    function scheduleRetry(reason){
      const status=document.querySelector('#status');
      status.textContent = 'Retrying… '+reason+' ('+attemptNo+'/'+MAX_ATTEMPTS+')';
      setTimeout(attemptLoad, RETRY_DELAY_MS * attemptNo); // backoff
    }

    function initLoad(){
      attemptNo = 0;
      attemptLoad();
    }

    window.addEventListener('DOMContentLoaded', () => initLoad());
  </script>
</head>
<body>
  <header>
    <div class="container">
      <h1>Transfer Certificate List <span class="muted status" id="status"></span></h1>
      <p style="text-align:center; margin:.35rem 0 0; font-size:.8rem;" class="muted">TC এন্ট্রিকরার পর প্রসেসিং এর জন্য, ৫ মিনিট অপেক্ষা করুণ। word button > download</p>
            <p style="text-align:center; margin:.35rem 0 0; font-size:.8rem;" class="muted">ইস্যু করা Transfer Certificate এর তালিকা</p>

      <div class="toolbar">
        <input id="search" type="search" placeholder="Filter by any text…" aria-label="Filter" />
        <span class="muted">Rows: <span id="count">0</span></span>
        <a class="nav-btn" href="../index.html">Home</a>
        <a class="nav-btn secondary" href="./tcentryform.html">TC Entry Form</a>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="table-wrap">
        <table role="table" aria-label="Testimonials">
          <thead>
            <tr>
              <th>TC Serial</th>
              <th>Name</th>
              <th>Father</th>
              <th>Class</th>
              <th>Roll</th>
              <th>IID</th>
              <th>Certificate</th>
            </tr>
          </thead>
            <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>
</body>
</html>
