<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Edit Transfer Certificate Record</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7f9;color:#111;}
  header{background:#fff;border-bottom:1px solid #e5e7eb;padding:.9rem 1rem;position:sticky;top:0;z-index:10;}
  h1{margin:0;font-size:1.1rem;text-align:center;}
  main{max-width:900px;margin:1rem auto 3rem;padding:0 1rem;}
  form{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:1.1rem 1.25rem;box-shadow:0 6px 22px -8px rgba(0,0,0,.12);} 
  fieldset{border:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.85rem .95rem;}
  label{display:flex;flex-direction:column;font-size:.68rem;font-weight:600;letter-spacing:.4px;text-transform:uppercase;color:#374151;gap:.3rem;}
  input,select,textarea{font:inherit;padding:.55rem .65rem;border:1px solid #d1d5db;border-radius:8px;background:#fff;}
  textarea{min-height:70px;resize:vertical;}
  input:focus,select:focus,textarea:focus{outline:2px solid #2563eb33;border-color:#2563eb;}
  .row-span-2{grid-row:span 2;}
  .actions{display:flex;gap:.75rem;flex-wrap:wrap;margin-top:1.1rem;}
  .btn{background:#2563eb;color:#fff;border:none;border-radius:8px;padding:.6rem 1rem;font-size:.75rem;font-weight:600;cursor:pointer;letter-spacing:.3px;}
  .btn.secondary{background:#6b7280;}
  .btn.danger{background:#b91c1c;}
  .btn:disabled{opacity:.55;cursor:not-allowed;}
  .status{font-size:.75rem;margin-left:.35rem;}
  .error{color:#b91c1c;font-weight:600;}
  .muted{color:#6b7280;}
  .bar{display:flex;justify-content:center;flex-wrap:wrap;gap:.6rem;margin:.75rem 0 0;font-size:.7rem;}
  .nav-link{background:#2563eb;color:#fff;text-decoration:none;padding:.5rem .85rem;border-radius:7px;font-weight:600;letter-spacing:.3px;font-size:.68rem;}
  .nav-link.alt{background:#475569;}
  .nav-link.warn{background:#d97706;}
  @media (prefers-color-scheme:dark){body{background:#0b1020;color:#e5e7eb;}header,form{background:#111729;border-color:#263148;}label{color:#9ca3af;}input,select,textarea{background:#0f162a;border-color:#263148;color:#e5e7eb;} .nav-link.alt{background:#334155;} }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl='https://rtfefxghfbtirfnlbucb.supabase.co';
  const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
  const tableName='termination_table';
  const client=window.supabase.createClient(supabaseUrl,supabaseKey);

  function qs(id){return document.getElementById(id);}  
  function setStatus(msg, isErr=false){const el=qs('status'); el.textContent=msg; el.classList.toggle('error', !!isErr);}  
  function formDataToUpdate(){
    const f=document.forms.tcForm;
    return {
      student_name_en:f.name.value.trim(),
      father_name_en:f.father.value.trim(),
      mother_name_en:f.mother.value.trim(),
      tc_class:f.tc_class.value.trim(),
      tc_section:f.tc_section.value.trim(),
      tc_roll:f.tc_roll.value.trim(),
      board_registration:f.board_registration.value.trim(),
      student_dateofbirth:f.student_dateofbirth.value.trim(),
      paid_month:f.paid_month.value.trim(),
      student_character:f.student_character.value.trim(),
      next_class:f.next_class.value.trim(),
      tc_session:f.tc_session.value.trim(),
      issued_by:f.issued_by.value.trim(),
      note:f.note.value.trim(),
      father_mobile:f.father_mobile.value.trim(),
      tc_date:f.tc_date.value.trim()
    };
  }
  function fillForm(row){
    const f=document.forms.tcForm;
    f.name.value=row.student_name_en||'';
    f.father.value=row.father_name_en||'';
    f.mother.value=row.mother_name_en||'';
    f.tc_class.value=row.tc_class||'';
    f.tc_section.value=row.tc_section||'';
    f.tc_roll.value=row.tc_roll||'';
    f.board_registration.value=row.board_registration||'';
    f.student_dateofbirth.value=row.student_dateofbirth||'';
    f.paid_month.value=row.paid_month||'';
    f.student_character.value=row.student_character||'';
    f.next_class.value=row.next_class||'';
    f.tc_session.value=row.tc_session||'';
    f.issued_by.value=row.issued_by||'';
    f.note.value=row.note||'';
    f.father_mobile.value=row.father_mobile||'';
    f.tc_date.value=row.tc_date||'';
  }
  async function loadRecord(){
    const params=new URLSearchParams(location.search);
    const iid=params.get('iid');
    if(!iid){setStatus('iid param missing',true);return;}
    setStatus('Loading record…');
    const { data, error } = await client.from(tableName).select('*').eq('iid', iid).limit(1);
    if(error){console.error(error); setStatus('Load failed',true); return;}
    if(!data||!data.length){setStatus('Not found',true);return;}
    const row=data[0];
    window.__ROW=row; // keep copy for debugging
    qs('recordTitle').textContent='Edit TC: IID '+(row.iid||'')+' (SL '+(row.tc_sl||'-')+')';
    fillForm(row);
    setStatus('Ready');
    const certLink=qs('certLink'); if(certLink) certLink.href='./certificate_word.html?iid='+encodeURIComponent(row.iid)+'&sl='+encodeURIComponent(row.tc_sl||'');
  }
  async function handleSubmit(e){
    e.preventDefault();
    const params=new URLSearchParams(location.search); const iid=params.get('iid'); if(!iid){setStatus('iid missing',true);return;}
    setStatus('Updating…');
    const payload=formDataToUpdate();
    // Determine primary key: tc_sl maybe more stable; update by iid to keep simple
    const { error } = await client.from(tableName).update(payload).eq('iid', iid);
    if(error){console.error(error); setStatus('Update failed',true); return;}
    setStatus('Saved');
  }
  function today(){const d=new Date(); return d.toISOString().slice(0,10);}  
  window.addEventListener('DOMContentLoaded',()=>{loadRecord(); document.forms.tcForm.addEventListener('submit',handleSubmit); if(!qs('tc_date').value) qs('tc_date').value=today();});
</script>
</head>
<body>
<header>
  <h1 id="recordTitle">Edit Transfer Certificate <span id="status" class="status muted"></span></h1>
  <div class="bar">
    <a class="nav-link" href="./test_list.html">← Back to List</a>
    <a class="nav-link alt" id="certLink" href="#" target="_blank" rel="noopener">View Certificate ↗</a>
  </div>
</header>
<main>
  <form id="tcForm" autocomplete="off">
    <fieldset>
      <label>Student Name
        <input name="name" required />
      </label>
      <label>Father Name
        <input name="father" />
      </label>
      <label>Mother Name
        <input name="mother" />
      </label>
      <label>Class
        <input name="tc_class" />
      </label>
      <label>Section
        <input name="tc_section" />
      </label>
      <label>Roll
        <input name="tc_roll" />
      </label>
      <label>Registration No
        <input name="board_registration" />
      </label>
      <label>Date of Birth
        <input name="student_dateofbirth" placeholder="DD-MM-YYYY" />
      </label>
      <label>Paid Upto
        <input name="paid_month" />
      </label>
      <label>Character
        <input name="student_character" />
      </label>
      <label>Next Class
        <input name="next_class" />
      </label>
      <label>Session
        <input name="tc_session" />
      </label>
      <label>Issued By
        <input name="issued_by" />
      </label>
      <label>Father Mobile
        <input name="father_mobile" />
      </label>
      <label class="row-span-2">Note
        <textarea name="note"></textarea>
      </label>
      <label>TC Date
        <input name="tc_date" id="tc_date" />
      </label>
    </fieldset>
    <div class="actions">
      <button class="btn" type="submit">Save</button>
      <a class="btn secondary" href="./test_list.html">Cancel</a>
    </div>
  </form>
</main>
</body>
</html>
