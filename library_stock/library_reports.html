<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Reports - Library Management</title>
  <script src="../login/auth-check_copy.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.15);
    }
    h1 {
      color: #ea580c;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #6b7280;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .report-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #fed7aa;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    .tab:hover {
      color: #f97316;
    }
    .tab.active {
      color: #f97316;
      border-bottom-color: #f97316;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-card {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(249, 115, 22, 0.25);
    }
    .stat-label {
      font-size: 13px;
      opacity: 0.95;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 26px;
      font-weight: 700;
    }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    .filter-group label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
    }
    input, select {
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #f97316;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(249, 115, 22, 0.3);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }
    th {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
    }
    tbody tr:hover {
      background: #fef7f0;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .status-overdue {
      color: #dc2626;
      font-weight: 600;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    @media print {
      .btn, .filter-bar, .report-tabs, .top-bar { display: none !important; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div>
        <h1>üìä Library Reports</h1>
        <p class="subtitle">Generate and view library statistics and reports</p>
      </div>
      <a href="library_dashboard.html" class="btn btn-secondary">‚Üê Dashboard</a>
    </div>

    <!-- Report Tabs -->
    <div class="report-tabs">
      <button class="tab active" onclick="switchTab('overview')">üìà Overview</button>
      <button class="tab" onclick="switchTab('issued')">üì§ Issued Books</button>
      <button class="tab" onclick="switchTab('overdue')">‚è∞ Overdue</button>
      <button class="tab" onclick="switchTab('popular')">üî• Popular Books</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Books</div>
          <div class="stat-value" id="totalBooks">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Currently Issued</div>
          <div class="stat-value" id="currentlyIssued">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Available Books</div>
          <div class="stat-value" id="availableBooks">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Overdue Books</div>
          <div class="stat-value" id="overdueBooks">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Students</div>
          <div class="stat-value" id="totalStudents">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Books Returned</div>
          <div class="stat-value" id="totalReturned">0</div>
        </div>
      </div>
    </div>

    <!-- Issued Books Tab -->
    <div id="issued-tab" class="tab-content">
      <div class="filter-bar">
        <button class="btn btn-primary" onclick="loadIssuedBooks()">üîÑ Refresh</button>
        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Student IID</th>
              <th>Student Name</th>
              <th>Class</th>
              <th>Book Title</th>
              <th>Tracking #</th>
              <th>Issue Date</th>
              <th>Due Date</th>
              <th>Days Left</th>
            </tr>
          </thead>
          <tbody id="issuedBooksBody">
            <tr><td colspan="8" style="text-align: center; color: #9ca3af;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Overdue Tab -->
    <div id="overdue-tab" class="tab-content">
      <div class="filter-bar">
        <button class="btn btn-primary" onclick="loadOverdueBooks()">üîÑ Refresh</button>
        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Student IID</th>
              <th>Student Name</th>
              <th>Class</th>
              <th>Mobile</th>
              <th>Book Title</th>
              <th>Due Date</th>
              <th>Days Overdue</th>
            </tr>
          </thead>
          <tbody id="overdueBooksBody">
            <tr><td colspan="7" style="text-align: center; color: #9ca3af;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Popular Books Tab -->
    <div id="popular-tab" class="tab-content">
      <div class="filter-bar">
        <button class="btn btn-primary" onclick="loadPopularBooks()">üîÑ Refresh</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Book Title</th>
              <th>Author</th>
              <th>Category</th>
              <th>Times Issued</th>
            </tr>
          </thead>
          <tbody id="popularBooksBody">
            <tr><td colspan="5" style="text-align: center; color: #9ca3af;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    const SUPABASE_URL = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';

    let supabase;
    if (window.supabase && typeof window.supabase.createClient === 'function') {
      window.__supabaseClients = window.__supabaseClients || {};
      supabase = window.__supabaseClients[SUPABASE_URL] || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.__supabaseClients[SUPABASE_URL] = supabase;
    } else {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    window.switchTab = function(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');

      if (tab === 'issued') loadIssuedBooks();
      if (tab === 'overdue') loadOverdueBooks();
      if (tab === 'popular') loadPopularBooks();
    };

    async function loadOverview() {
      try {
        // Total Books
        const { count: bookCount } = await supabase
          .from('library_book')
          .select('*', { count: 'exact', head: true });
        document.getElementById('totalBooks').textContent = bookCount || 0;

        // Currently Issued
        const { count: issuedCount } = await supabase
          .from('library_book_issue')
          .select('*', { count: 'exact', head: true })
          .is('return_date', null);
        document.getElementById('currentlyIssued').textContent = issuedCount || 0;

        // Available (simplified calculation)
        document.getElementById('availableBooks').textContent = (bookCount || 0) - (issuedCount || 0);

        // Overdue
        const today = new Date().toISOString().split('T')[0];
        const { count: overdueCount } = await supabase
          .from('library_book_issue')
          .select('*', { count: 'exact', head: true })
          .is('return_date', null)
          .lt('due_date', today);
        document.getElementById('overdueBooks').textContent = overdueCount || 0;

        // Total Students
        const { count: studentCount } = await supabase
          .from('student_database')
          .select('*', { count: 'exact', head: true });
        document.getElementById('totalStudents').textContent = studentCount || 0;

        // Total Returned
        const { count: returnedCount } = await supabase
          .from('library_book_issue')
          .select('*', { count: 'exact', head: true })
          .not('return_date', 'is', null);
        document.getElementById('totalReturned').textContent = returnedCount || 0;
      } catch (err) {
        console.error('Error loading overview:', err);
      }
    }

    window.loadIssuedBooks = async function() {
      const tbody = document.getElementById('issuedBooksBody');
      try {
        const { data, error } = await supabase
          .from('library_book_issue')
          .select('*')
          .is('return_date', null)
          .order('issue_date', { ascending: false });

        if (error) throw error;

        tbody.innerHTML = '';
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">No issued books</td></tr>';
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        data.forEach(issue => {
          const dueDate = new Date(issue.due_date);
          dueDate.setHours(0, 0, 0, 0);
          const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${issue.iid || '-'}</td>
            <td><strong>${issue.student_name_en || '-'}</strong></td>
            <td>${issue.active_class || '-'} (${issue.active_section || '-'})</td>
            <td>${issue.tracking_number || '-'}</td>
            <td>-</td>
            <td>${issue.issue_date || '-'}</td>
            <td>${issue.due_date || '-'}</td>
            <td class="${diffDays < 0 ? 'status-overdue' : ''}">${diffDays} days</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error:', err);
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Error loading data</td></tr>';
      }
    };

    window.loadOverdueBooks = async function() {
      const tbody = document.getElementById('overdueBooksBody');
      try {
        const today = new Date().toISOString().split('T')[0];
        const { data, error } = await supabase
          .from('library_book_issue')
          .select('*')
          .is('return_date', null)
          .lt('due_date', today)
          .order('due_date', { ascending: true });

        if (error) throw error;

        tbody.innerHTML = '';
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #9ca3af;">No overdue books! üéâ</td></tr>';
          return;
        }

        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);

        data.forEach(issue => {
          const dueDate = new Date(issue.due_date);
          dueDate.setHours(0, 0, 0, 0);
          const daysOverdue = Math.ceil((todayDate - dueDate) / (1000 * 60 * 60 * 24));

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${issue.iid || '-'}</td>
            <td><strong>${issue.student_name_en || '-'}</strong></td>
            <td>${issue.active_class || '-'} (${issue.active_section || '-'})</td>
            <td>${issue.father_mobile || '-'}</td>
            <td>-</td>
            <td>${issue.due_date || '-'}</td>
            <td class="status-overdue">${daysOverdue} days</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error:', err);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Error loading data</td></tr>';
      }
    };

    window.loadPopularBooks = async function() {
      const tbody = document.getElementById('popularBooksBody');
      try {
        const { data, error } = await supabase
          .from('library_book_issue')
          .select('tracking_number');

        if (error) throw error;

        // Count occurrences
        const bookCounts = {};
        data.forEach(issue => {
          const tracking = issue.tracking_number;
          bookCounts[tracking] = (bookCounts[tracking] || 0) + 1;
        });

        // Get book details
        const popularBooks = Object.entries(bookCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        tbody.innerHTML = '';
        if (popularBooks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No data available</td></tr>';
          return;
        }

        for (let i = 0; i < popularBooks.length; i++) {
          const [tracking, count] = popularBooks[i];
          const { data: bookData } = await supabase
            .from('library_book')
            .select('title, author, category')
            .eq('tracking_number', parseInt(tracking))
            .single();

          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>#${i + 1}</strong></td>
            <td>${bookData?.title || '-'}</td>
            <td>${bookData?.author || '-'}</td>
            <td>${bookData?.category || '-'}</td>
            <td><strong>${count}</strong></td>
          `;
          tbody.appendChild(row);
        }
      } catch (err) {
        console.error('Error:', err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc2626;">Error loading data</td></tr>';
      }
    };

    loadOverview();
  </script>
</body>
</html>
