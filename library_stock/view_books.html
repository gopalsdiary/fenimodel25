<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Books - Library Management</title>
  <script src="../login/auth-check_copy.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.15);
    }
    h1 {
      color: #ea580c;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #6b7280;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .filter-section {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    .filter-group label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
    }
    input, select {
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #f97316;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(249, 115, 22, 0.3);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .btn-edit {
      background: #f97316;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
    .btn-edit:hover {
      background: #ea580c;
    }
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }
    th {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
    }
    tbody tr:hover {
      background: #fef7f0;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-usable {
      background: #d1fae5;
      color: #059669;
    }
    .status-damaged {
      background: #fed7aa;
      color: #c2410c;
    }
    .status-unusable {
      background: #fecaca;
      color: #dc2626;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      color: #f97316;
      font-size: 22px;
    }
    .close-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
    }
    .close-btn:hover {
      background: #dc2626;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #374151;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìö View All Books</h1>
    <p class="subtitle">Browse, filter, and manage library books</p>

    <div class="top-bar">
      <div class="filter-section">
        <div class="filter-group">
          <label>Search</label>
          <input type="text" id="searchInput" placeholder="Title, Author, Tracking#">
        </div>
        <div class="filter-group">
          <label>Category</label>
          <select id="filterCategory">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Status</label>
          <select id="filterStatus">
            <option value="">All Status</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="loadBooks()" style="margin-top: 18px;">üîç Search</button>
        <button class="btn btn-secondary" onclick="clearFilters()" style="margin-top: 18px;">‚úñÔ∏è Clear</button>
      </div>
      <a href="library_dashboard.html" class="btn btn-secondary">‚Üê Dashboard</a>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Tracking #</th>
            <th>Title</th>
            <th>Author</th>
            <th>Publisher</th>
            <th>Year</th>
            <th>Qty</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="booksTableBody">
          <tr>
            <td colspan="9" style="text-align: center; color: #9ca3af;">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úèÔ∏è Edit Book</h2>
        <button class="close-btn" onclick="closeModal()">‚úï</button>
      </div>
      <form id="editBookForm">
        <input type="hidden" id="edit_tracking_number_hidden" name="tracking_number">
        <div class="form-grid">
          <div class="form-group">
            <label>Tracking Number</label>
            <input type="text" id="edit_tracking_number" readonly style="background: #f3f4f6;">
          </div>
          <div class="form-group">
            <label>Book Title *</label>
            <input type="text" id="edit_book_title" required>
          </div>
          <div class="form-group">
            <label>Author</label>
            <input type="text" id="edit_author">
          </div>
          <div class="form-group">
            <label>Category</label>
            <input type="text" id="edit_category">
          </div>
          <div class="form-group">
            <label>Publisher</label>
            <input type="text" id="edit_publisher">
          </div>
          <div class="form-group">
            <label>Year</label>
            <input type="number" id="edit_publication_year" min="1900" max="2100">
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="edit_quantity" min="1">
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="edit_status">
              <option value="usable">Usable</option>
              <option value="unusable">Unusable</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary">üíæ Update Book</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    const SUPABASE_URL = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';

    let supabaseClient;
    if (window.supabase && typeof window.supabase.createClient === 'function') {
      window.__supabaseClients = window.__supabaseClients || {};
      supabaseClient = window.__supabaseClients[SUPABASE_URL] || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.__supabaseClients[SUPABASE_URL] = supabaseClient;
    } else {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    window.loadBooks = async function() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('filterCategory').value;
      const status = document.getElementById('filterStatus').value;
      const tbody = document.getElementById('booksTableBody');

      try {
        let query = supabaseClient
          .from('library_book')
          .select('*')
          .order('tracking_number', { ascending: false });

        if (category) query = query.eq('category', category);

        const { data, error } = await query;
        if (error) throw error;

        let filteredData = data;
        if (search) {
          filteredData = data.filter(book => 
            (book.title?.toLowerCase().includes(search)) ||
            (book.author?.toLowerCase().includes(search)) ||
            (book.tracking_number?.toString().includes(search))
          );
        }

        tbody.innerHTML = '';
        if (!filteredData || filteredData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">No books found</td></tr>';
          return;
        }

        filteredData.forEach(book => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${book.tracking_number || '-'}</td>
            <td><strong>${book.title || '-'}</strong></td>
            <td>${book.author || '-'}</td>
            <td>${book.publisher || '-'}</td>
            <td>${book.publication_year || '-'}</td>
            <td>${book.quantity || 0}</td>
            <td><span class="status-badge">${book.status || 'usable'}</span></td>
            <td><button class="btn-edit" onclick="editBook(${book.tracking_number})">‚úèÔ∏è Edit</button></td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading books:', err);
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #dc2626;">Error loading data</td></tr>';
      }
    };

    window.editBook = async function(trackingNumber) {
      try {
        const { data, error } = await supabaseClient
          .from('library_book')
          .select('*')
          .eq('tracking_number', trackingNumber)
          .single();

        if (error) throw error;

        document.getElementById('edit_tracking_number').value = data.tracking_number || '';
        document.getElementById('edit_book_title').value = data.title || '';
        document.getElementById('edit_author').value = data.author || '';
        document.getElementById('edit_category').value = data.category || '';
        document.getElementById('edit_publisher').value = data.publisher || '';
        document.getElementById('edit_publication_year').value = data.publication_year || '';
        document.getElementById('edit_quantity').value = data.quantity || 1;
        document.getElementById('edit_status').value = data.status || 'usable';

        // Store tracking number for update
        document.getElementById('edit_tracking_number_hidden').value = trackingNumber;
        document.getElementById('editModal').classList.add('active');
      } catch (err) {
        console.error('Error loading book:', err);
        alert('Error loading book details');
      }
    };

    window.closeModal = function() {
      document.getElementById('editModal').classList.remove('active');
    };

    document.getElementById('editBookForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const trackingNumber = parseInt(document.getElementById('edit_tracking_number_hidden').value);

      const updateData = {
        title: document.getElementById('edit_book_title').value,
        author: document.getElementById('edit_author').value,
        category: document.getElementById('edit_category').value,
        publisher: document.getElementById('edit_publisher').value,
        publication_year: document.getElementById('edit_publication_year').value ? parseInt(document.getElementById('edit_publication_year').value) : null,
        quantity: parseInt(document.getElementById('edit_quantity').value),
        status: document.getElementById('edit_status').value
      };

      try {
        const { error } = await supabaseClient
          .from('library_book')
          .update(updateData)
          .eq('tracking_number', trackingNumber);

        if (error) throw error;

        alert('‚úÖ Book updated successfully!');
        closeModal();
        loadBooks();
      } catch (err) {
        console.error('Error updating book:', err);
        alert('‚ùå Error: ' + err.message);
      }
    });

    window.clearFilters = function() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterStatus').value = '';
      loadBooks();
    };

    async function loadCategories() {
      try {
        const { data, error } = await supabaseClient
          .from('library_book')
          .select('category')
          .not('category', 'is', null)
          .not('category', 'eq', '');

        if (!error && data) {
          const categories = [...new Set(data.map(item => item.category))];
          const select = document.getElementById('filterCategory');
          categories.forEach(cat => {
            select.innerHTML += `<option value="${cat}">${cat}</option>`;
          });
        }
      } catch (err) {
        console.error('Error loading categories:', err);
      }
    }

    loadBooks();
    loadCategories();
  </script>
</body>
</html>
