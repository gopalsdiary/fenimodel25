<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-sca        

  <title>প্রত্যয়ন তালিকা </title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- Kalpurush Bangla font -->
  <link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: 'Kalpurush','Noto Sans Bengali','Hind Siliguri','SolaimanLipi','Vrinda','Siyam Rupali', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7f9; color: #111; }
    .container { max-width: 1100px; margin: 0 auto; width: 100%; padding: 0 1rem; box-sizing: border-box; }
    header { position: sticky; top: 0; background: white; padding: 0.85rem 0; border-bottom: 1px solid #e5e7eb; z-index: 10; }
    h1 { margin: 0; font-size: 1.2rem; text-align:center; }
    main { padding: 1rem 0 2rem; }
    .toolbar { display: flex; gap: .75rem; align-items: center; margin: 0.75rem 0 1.1rem; flex-wrap:wrap; justify-content:center; }
    .nav-btn { background:#2563eb; color:#fff; text-decoration:none; padding:.55rem .9rem; font-size:.7rem; font-weight:600; border-radius:6px; letter-spacing:.4px; display:inline-block; }
    .nav-btn:hover { background:#1d4ed8; }
    .nav-btn.secondary { background:#64748b; }
    .nav-btn.secondary:hover { background:#475569; }
    input[type="search"]{ padding: .5rem .75rem; border: 1px solid #d1d5db; border-radius: 8px; min-width: 240px; }
    .table-wrap { overflow: auto; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    table { border-collapse: collapse; width: 100%; min-width: 720px; }
    thead th { position: sticky; top: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; text-align: left; padding: .75rem; font-size: .9rem; }
    tbody td { border-top: 1px solid #f1f5f9; padding: .65rem .75rem; font-size: .92rem; }
    tbody tr:hover { background: #f9fafb; }
    .muted { color: #6b7280; }
    .link { color: #2563eb; text-decoration: none; font-weight: 600; }
    .link:hover { text-decoration: underline; }
    .status { margin-left: .5rem; font-size: .9rem; }
    .error { color: #b91c1c; }
    .sep { color: #9ca3af; margin: 0 .25rem; }
  /* PDF badge */
  .pdf-badge { display:inline-block; background:#dc2626; color:#fff; font-size:.65rem; font-weight:600; padding:.35rem .6rem .4rem; border-radius:999px; text-decoration:none; letter-spacing:.5px; box-shadow:0 2px 4px rgba(0,0,0,.15); line-height:1; }
  .pdf-badge:hover { background:#b91c1c; text-decoration:none; }
  #genAllBtn { background:#0d9488; }
  #genAllBtn:hover { background:#0f766e; }
  .cert-card { position:relative; padding:1rem; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); font-size:.7rem; line-height:1.4; }
  .cert-card h3 { margin:.1rem 0 .4rem; font-size:.85rem; }
  .cert-qr { position:absolute; top:1rem; right:1rem; text-align:center; font-size:.55rem; }
  .cert-qr img { width:80px; height:80px; display:block; }
  #allCertificates { display:none; margin-top:2rem; display:block; }
    @media (prefers-color-scheme: dark) {
      body { background: #0b1020; color: #e5e7eb; }
      header, .table-wrap { background: #111729; border-color: #263148; box-shadow: 0 8px 24px rgba(0,0,0,.4); }
      thead th { background: #0f162a; border-bottom-color: #263148; }
      tbody td { border-top-color: #1d2845; }
      input[type="search"]{ background: #0f162a; color: #e5e7eb; border-color: #263148; }
      .muted { color: #9aa5b1; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration
    const supabaseUrl = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    const tableName = 'protoyon_data';
    const studentTable = 'student_database';
    const client = window.supabase.createClient(supabaseUrl, supabaseKey);

    const DEBUG = new URLSearchParams(location.search).has('debug');
    function logDbg(...a){ if(DEBUG) console.log('[PROTOYON-LIST]', ...a); }

    function createRow(tr, cells){
      cells.forEach(c => { const td = document.createElement('td'); if(c && c.element) td.appendChild(c.element); else td.textContent = c ?? ''; tr.appendChild(td); });
      return tr;
    }

    function renderTable(rows){ const tbody=document.querySelector('#tbody'); tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r)); document.querySelector('#count').textContent=`${rows.length}`; }

    function buildRows(data){
      const rows=[];
      for(const obj of data){
        const sl = obj.protoyon_sl ?? '';
        const name = obj.student_name_bn ?? '';
        const father = obj.father_name_bn ?? '';
        const iid = obj.iid ?? '';
        const klass = obj.active_class ?? '';
        const section = obj.active_section ?? '';
        const roll = obj.active_roll ?? '';
        
        // Create PDF button for certificate
        const pdfLink = document.createElement('a');
        pdfLink.className = 'pdf-badge';
        pdfLink.textContent = 'PDF';
        pdfLink.href = `./certificate_word.html?iid=${encodeURIComponent(iid)}`;
        pdfLink.target = '_blank';
        pdfLink.rel = 'noopener';
        pdfLink.title = 'Open certificate (use browser Print to save as PDF)';
        
        const tr=document.createElement('tr');
        createRow(tr,[sl, name, father, iid, klass, section, roll, {element: pdfLink}]);
        rows.push(tr);
      }
      return rows;
    }

    function setupFilter(allRows){ const input=document.querySelector('#search'); const apply=()=>{ const q=input.value.toLowerCase().trim(); if(!q) return renderTable(allRows); const filtered=allRows.filter(tr=>tr.textContent.toLowerCase().includes(q)); renderTable(filtered); }; input.addEventListener('input',apply); apply(); }

    async function loadData(){
      const statusEl=document.querySelector('#status');
      statusEl.classList.remove('error');
      statusEl.textContent='Loading…';
      try{
        const { data, error } = await client.from(tableName)
          .select('protoyon_sl, student_name_bn, father_name_bn, iid, active_class, active_section, active_roll')
          .order('protoyon_sl', { ascending:false })
          .limit(1000);
        if(error) throw error;
        logDbg('Fetched rows', data?.length||0);
        const rows=buildRows(data||[]);
        setupFilter(rows);
        statusEl.textContent='Loaded';
      }catch(e){
        console.error('Load failed', e);
        statusEl.textContent='Failed to load';
        statusEl.classList.add('error');
        if(!document.getElementById('retryBtn')){
          const btn=document.createElement('button');
          btn.id='retryBtn'; btn.textContent='Retry'; btn.style.marginLeft='.75rem'; btn.style.padding='.35rem .7rem'; btn.style.fontSize='.65rem'; btn.style.cursor='pointer'; btn.onclick=()=>{ btn.remove(); loadData(); }; statusEl.parentElement.appendChild(btn);
        }
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</head>
<body>
  <header>
    <div class="container">
      <h1>প্রত্যয়ন তালিকা (বাংলা) <span class="muted status" id="status"></span></h1>
      <p style="text-align:center; margin:.35rem 0 0; font-size:.8rem;" class="muted"> প্রত্যয়ন এন্ট্রিকরার পর প্রসেসিং এর জন্য ৫ মিনিট অপেক্ষা করুণ।</p>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Filter by any text…" aria-label="Filter" />
        <span class="muted">Rows: <span id="count">0</span></span>
          <a class="nav-btn" href="../index.html">Home</a>
  <a id="genAllBtn" class="nav-btn" href="#">প্রত্যয়ন ফরম</a>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="table-wrap">
        <table role="table" aria-label="Protoyon List">
          <thead>
            <tr>
              <th>Serial</th>
              <th>Student Name (বাংলা)</th>
              <th>Father Name (বাংলা)</th>
              <th>IID</th>
              <th>Class</th>
              <th>Section</th>
              <th>Roll</th>
              <th>Certificate</th>
            </tr>
          </thead>
            <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>
  
  <!-- Modal for Protoyon Entry Form -->
  <div id="protoyonModal" aria-hidden="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);z-index:200;">
    <div role="dialog" aria-modal="true" aria-labelledby="protoyonModalTitle" style="background:#fff;border-radius:14px;max-width:560px;width:100%;padding:1rem 1.15rem;box-shadow:0 10px 38px -8px rgba(0,0,0,.35);font-family:'Kalpurush','Noto Sans Bengali','Hind Siliguri','SolaimanLipi','Vrinda','Siyam Rupali',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;position:relative;">
      <button type="button" id="closeProtoyonModal" aria-label="Close" style="position:absolute;top:8px;right:8px;background:#e2e8f0;border:1px solid #cbd5e1;border-radius:6px;padding:.25rem .5rem;font-size:.65rem;font-weight:600;cursor:pointer;">✕</button>
      <h2 id="protoyonModalTitle" style="margin:.25rem 0 1rem;font-size:1rem;">নতুন প্রত্যয়ন এন্ট্রি</h2>
      <div id="protoyonModalStatus" style="font-size:.7rem;margin:-.5rem 0 .75rem;color:#6b7280;">IID দিন এবং ছাত্রের তথ্য লোড করুন</div>
      <form id="protoyonEntryForm" autocomplete="off">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:.75rem .85rem;align-items:start;">
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">
            IID
            <div style="display:flex;gap:.4rem;">
              <input name="iid" id="iidInputProtoyon" required style="flex:1;padding:.55rem .6rem;border:1px solid #d1d5db;border-radius:8px;" />
              <button type="button" id="loadIIDBtnProtoyon" style="background:#2563eb;color:#fff;border:0;border-radius:8px;padding:.55rem .75rem;font-size:.65rem;font-weight:600;cursor:pointer;">Load</button>
            </div>
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">ছাত্রের নাম (বাংলা)
            <input name="student_name_bn" id="student_name_bn" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">পিতার নাম (বাংলা)
            <input name="father_name_bn" id="father_name_bn" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">মাতার নাম (বাংলা)
            <input name="mother_name_bn" id="mother_name_bn" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">গ্রাম (বাংলা)
            <input name="village_bn" id="village_bn" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">ডাকঘর (বাংলা)
            <input name="postoffice_bn" id="postoffice_bn" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">উপজেলা (বাংলা)
            <input name="upazilla_bn" id="upazilla_bn" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">জেলা (বাংলা)
            <input name="district_bn" id="district_bn" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">বর্তমান শ্রেণী
            <input name="active_class" id="active_class" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">বর্তমান শাখা
            <input name="active_section" id="active_section" readonly />
          </label>
          <label style="display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.35px;gap:.35rem;">বর্তমান রোল
            <input name="active_roll" id="active_roll" readonly />
          </label>
        </div>
        <div style="display:flex;gap:.7rem;margin-top:1rem;flex-wrap:wrap;">
          <button type="submit" class="nav-btn" style="background:#16a34a;">Save</button>
          <button type="button" id="resetProtoyonForm" class="nav-btn" style="background:#6b7280;">Reset</button>
        </div>
      </form>
      <div style="margin-top:.9rem;font-size:.6rem;line-height:1.3;color:#6b7280;">
        সেভ করার পর, উইন্ডো বন্ধ করুন এবং প্রয়োজনে তালিকা রিফ্রেশ করুন।
      </div>
    </div>
  </div>

  <script>
    // Modal / Protoyon Entry logic
    const modal = document.getElementById('protoyonModal');
    const openBtn = document.getElementById('genAllBtn');
    const closeBtn = document.getElementById('closeProtoyonModal');
    const loadIIDBtn = document.getElementById('loadIIDBtnProtoyon');
    const entryStatus = document.getElementById('protoyonModalStatus');
    const form = document.getElementById('protoyonEntryForm');
    
    function showModal(){ 
      modal.style.display='flex'; 
      entryStatus.textContent='IID দিন এবং ছাত্রের তথ্য লোড করুন'; 
      entryStatus.style.color='';
      document.getElementById('iidInputProtoyon').focus(); 
    }
    function hideModal(){ modal.style.display='none'; form.reset(); }
    
    if(openBtn) openBtn.addEventListener('click', (e) => { e.preventDefault(); showModal(); });
    closeBtn?.addEventListener('click', hideModal);
    modal?.addEventListener('click', e=>{ if(e.target===modal) hideModal(); });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.style.display==='flex') hideModal(); });
    
    async function loadStudent(){
      const iid = document.getElementById('iidInputProtoyon').value.trim();
      if(!iid){ entryStatus.textContent='IID প্রদান করুন'; entryStatus.style.color='#b91c1c'; return; }
      entryStatus.textContent='Loading…'; entryStatus.style.color='';
      try {
        const { data, error } = await client.from(studentTable).select('*').eq('iid', iid).limit(1);
        if(error) throw error;
        if(!data || !data.length){ entryStatus.textContent='পাওয়া যায়নি'; entryStatus.style.color='#b91c1c'; return; }
        const row = data[0];
        
        // Map fields from student_database to form
        document.getElementById('student_name_bn').value = row.student_name_bn || row.name_bn || '';
        document.getElementById('father_name_bn').value = row.father_name_bn || row.father_bn || '';
        document.getElementById('mother_name_bn').value = row.mother_name_bn || row.mother_bn || '';
        document.getElementById('village_bn').value = row.village_bn || row.village || '';
        document.getElementById('postoffice_bn').value = row.postoffice_bn || row.postoffice || '';
        document.getElementById('upazilla_bn').value = row.upazilla_bn || row.upazilla || '';
        document.getElementById('district_bn').value = row.district_bn || row.district || '';
        document.getElementById('active_class').value = row.active_class || row.class || '';
        document.getElementById('active_section').value = row.active_section || row.section || '';
        document.getElementById('active_roll').value = row.active_roll || row.roll || '';
        
        entryStatus.textContent='তথ্য লোড হয়েছে। সেভ করুন।';
      } catch(e){ 
        console.error(e); 
        entryStatus.textContent='লোড ব্যর্থ'; 
        entryStatus.style.color='#b91c1c'; 
      }
    }
    
    loadIIDBtn?.addEventListener('click', loadStudent);
    document.getElementById('iidInputProtoyon')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); loadStudent(); }});
    document.getElementById('resetProtoyonForm')?.addEventListener('click', ()=>{ 
      const keepIID=document.getElementById('iidInputProtoyon').value; 
      form.reset(); 
      document.getElementById('iidInputProtoyon').value=keepIID; 
      entryStatus.textContent='ফর্ম রিসেট'; 
      entryStatus.style.color='';
    });
    
    form?.addEventListener('submit', async e=>{
      e.preventDefault();
      entryStatus.textContent='সেভ করা হচ্ছে…'; entryStatus.style.color='';
      const payload = {
        iid: form.iid.value.trim(),
        student_name_bn: form.student_name_bn.value.trim(),
        father_name_bn: form.father_name_bn.value.trim(),
        mother_name_bn: form.mother_name_bn.value.trim(),
        village_bn: form.village_bn.value.trim(),
        postoffice_bn: form.postoffice_bn.value.trim(),
        upazilla_bn: form.upazilla_bn.value.trim(),
        district_bn: form.district_bn.value.trim(),
        active_class: form.active_class.value.trim(),
        active_section: form.active_section.value.trim(),
        active_roll: form.active_roll.value.trim()
      };
      
      if(!payload.iid){ entryStatus.textContent='IID প্রয়োজন'; entryStatus.style.color='#b91c1c'; return; }
      
      try {
        // Check if already exists
        const { data: existing, error: existErr } = await client.from(tableName).select('iid').eq('iid', payload.iid).limit(1);
        if(existErr) throw existErr;
        if(existing && existing.length){ entryStatus.textContent='ইতিমধ্যে আছে (iid)'; entryStatus.style.color='#b91c1c'; return; }
        
        const { data: inserted, error } = await client.from(tableName).insert(payload).select('protoyon_sl').single();
        if(error) throw error;
        
        entryStatus.textContent='সেভ হয়েছে ✔'; entryStatus.style.color='#15803d';
        // Auto-close modal and refresh data
        setTimeout(()=>{ 
          try{ 
            hideModal(); 
            loadData(); // Refresh the list
          }catch(_e){} 
        }, 800);
      } catch(err){ 
        console.error(err); 
        entryStatus.textContent='সেভ ব্যর্থ'; 
        entryStatus.style.color='#b91c1c'; 
      }
    });
  </script>
</body>
</html>
