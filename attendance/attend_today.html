<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Today's Attendance</title>
  <!-- Prevent favicon 404 error -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
  <style>
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;margin:0;padding:20px;background:linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);color:#1f2937;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;background:#fff;padding:30px;border-radius:16px;box-shadow:0 20px 40px rgba(249, 115, 22, 0.1), 0 8px 16px rgba(0, 0, 0, 0.05);border:1px solid #fed7aa}
    h1{margin:0 0 20px;font-size:28px;color:#ea580c;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:20px;justify-content:center;flex-wrap:wrap}
    .filter-group{display:flex;gap:8px;align-items:center}
    .filter-group label{font-weight:600;color:#374151}
    .filter-group select,.filter-group input[type="date"]{padding:8px 16px;border:2px solid #fed7aa;border-radius:8px;font-size:14px;background:#fff;color:#374151;cursor:pointer;transition:all 0.3s ease}
    .filter-group select:hover,.filter-group input[type="date"]:hover{border-color:#f97316}
    .filter-group select:focus,.filter-group input[type="date"]:focus{outline:none;border-color:#ea580c;box-shadow:0 0 0 3px rgba(234, 88, 12, 0.1)}
    .filter-group select:disabled{background:#f3f4f6;cursor:not-allowed;opacity:0.6}
    .btn{background:linear-gradient(135deg, #ea580c 0%, #dc2626 100%);color:#fff;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-weight:600;font-size:16px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(249, 115, 22, 0.3)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(249, 115, 22, 0.4)}
    .btn:active{transform:translateY(0)}
    table{width:100%;border-collapse:collapse;margin-top:20px;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,0.08);border:2px solid #fed7aa}
  th,td{padding:16px;text-align:left;border:1px solid #fed7aa;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-size:14px}
  /* Utility classes for alignment */
  .col-center { text-align: center; }
    th{background:linear-gradient(135deg, #ea580c 0%, #f97316 100%);color:#fff;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    tbody tr{background:#fff;transition:background 0.2s ease}
    tbody tr:nth-child(even){background:#fef7f0}
    tbody tr:hover{background:#fed7aa}
    .muted{color:#9ca3af;font-size:14px;text-align:center;padding:40px}
    .error{color:#dc2626;background:#fef2f2;padding:12px;border-radius:8px;border-left:4px solid #dc2626;margin-bottom:20px;display:none}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .status-present{background:#10b981;color:#fff}
    .status-absent{background:#ef4444;color:#fff}
    .date-highlight{font-weight:700;color:#ea580c}
    .rfid-code{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f3f4f6;padding:4px 8px;border-radius:6px;font-size:14px}
    .student-name{font-weight:600;color:#374151;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-size:14px}
    .time-display{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-size:14px;color:#6b7280}
    .btn-print{background: linear-gradient(135deg, #059669 0%, #047857 100%);}
    .btn-assign{background:#f59e0b;color:#111827;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px}
    .btn-assign:hover{background:#f59e0bcc}
    .stats-container{display:flex;gap:20px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
    .stat-box{background:linear-gradient(135deg, #fff 0%, #fef7f0 100%);padding:20px 30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:2px solid #fed7aa;min-width:150px;text-align:center}
    .stat-label{font-size:14px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
    .stat-value{font-size:32px;font-weight:700;color:#ea580c}
    .stat-box.present .stat-value{color:#10b981}
    .stat-box.absent .stat-value{color:#ef4444}
    .no-rfid-marker{color:#ef4444;font-weight:700;margin-left:4px}
    /* Hide print-only elements on screen */
    @media screen {
      .print-header{display:none !important;}
      .print-info{display:none !important;}
    }
    @media print {
      /* Hide interactive elements */
      .btn, .btn-print, .controls, .print-section, #status { display: none !important; }
      #error { display: none !important; }
      
      /* Reset body and container */
      body { 
        background: white !important; 
        margin: 0;
        padding: 8mm;
        font-size: 10pt;
      }
      
      .container { 
        box-shadow: none; 
        border: none;
        padding: 0;
        max-width: 100%;
      }
      
      /* Header styling */
      h1 { 
        color: #000 !important; 
        font-size: 16pt !important; 
        text-align: center;
        margin-bottom: 8px;
        border-bottom: 2px solid #000;
        padding-bottom: 6px;
        text-shadow: none !important;
      }
      
      /* Statistics box styling */
      .stats-container { 
        display: flex !important; 
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
        page-break-inside: avoid;
      }
      
      .stat-box { 
        box-shadow: none !important;
        border: 1.5px solid #333 !important;
        background: white !important;
        padding: 6px 15px !important;
        min-width: 100px;
      }
      
      .stat-label {
        color: #000 !important;
        font-size: 8pt;
        margin-bottom: 3px;
      }
      
      .stat-value {
        color: #000 !important;
        font-size: 18pt;
      }
      
      /* Table styling */
      table { 
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
        box-shadow: none !important;
        border: 1.5px solid #000 !important;
        page-break-inside: auto;
      }
      
      thead {
        display: table-header-group;
      }
      
      tbody {
        orphans: 5;
        widows: 5;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      th, td { 
        padding: 4px 6px !important;
        border: 0.5px solid #666 !important;
        font-size: 9pt;
        text-align: left;
        line-height: 1.3;
      }
      /* Ensure centered columns remain centered in print/screen */
      .col-center { text-align: center !important; }
      
      th { 
        background: #e8e8e8 !important;
        color: #000 !important;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 8pt;
        letter-spacing: 0.3px;
        padding: 5px 6px !important;
      }
      
      tbody tr {
        background: white !important;
      }
      
      tbody tr:nth-child(even) {
        background: #f9f9f9 !important;
      }
      
      tbody tr:hover {
        background: inherit !important;
      }
      
      /* Maintain present student highlighting */
      tbody tr[style*="background-color: rgb(209, 250, 229)"],
      tbody tr[style*="background-color:#d1fae5"] {
        background: #e8e8e8 !important;
      }
      
      /* Bold present students in print */
      tbody tr[style*="background-color"] .student-name {
        font-weight: bold !important;
      }
      
      /* Student name styling */
      .student-name {
        font-weight: normal !important;
        color: #000 !important;
        font-size: 9pt;
      }
      
      .time-display {
        color: #000 !important;
        font-family: 'Courier New', monospace;
        font-size: 8.5pt;
      }
      
      /* RFID marker */
      .no-rfid-marker {
        color: #000 !important;
        font-weight: bold;
        font-size: 10pt;
      }
      
      /* Error messages */
      .error {
        display: none !important;
      }
      
      .muted {
        color: #666 !important;
      }
      
      /* Page break settings */
      @page {
        margin: 10mm 12mm;
        size: A4 portrait;
      }
      
      /* First page with more header space */
      @page :first {
        margin-top: 10mm;
      }
      
      /* Footer with page numbers */
      @page {
        @bottom-right {
          content: "Page " counter(page);
          font-size: 8pt;
          color: #666;
        }
      }
      
      /* Show print-only elements - FORCE VISIBILITY */
      body .print-header {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        text-align: center;
        margin-bottom: 8px;
        border-bottom: 2px solid #333;
        padding-bottom: 6px;
        page-break-after: avoid;
        height: auto !important;
        overflow: visible !important;
      }
      
      body .print-header h2 {
        display: block !important;
        visibility: visible !important;
        margin: 0 !important;
        font-size: 14pt !important;
        line-height: 1.2;
        color: #000 !important;
      }
      
      body .print-header p {
        display: block !important;
        visibility: visible !important;
        margin: 3px 0 !important;
        font-size: 9pt !important;
        color: #333 !important;
      }
      
      body .print-info {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        justify-content: space-between;
        margin-top: 5px;
        margin-bottom: 8px;
        font-size: 9pt;
        padding: 8px 10px;
        border: 1.5px solid #333;
        background: #f5f5f5 !important;
        page-break-after: avoid;
        page-break-inside: avoid;
        height: auto !important;
        overflow: visible !important;
      }
      
      body .print-info-item {
        display: flex !important;
        visibility: visible !important;
        gap: 5px;
        align-items: center;
      }
      
      body .print-info-label {
        display: inline !important;
        visibility: visible !important;
        font-weight: bold;
        color: #000 !important;
      }
      
      body .print-info span {
        display: inline !important;
        visibility: visible !important;
        color: #000 !important;
      }
      
      body #printClass, body #printSection, body #printDate, body #printTime {
        display: inline !important;
        visibility: visible !important;
        opacity: 1 !important;
        color: #000 !important;
        font-weight: bold !important;
      }
      
      /* Show print footer */
      .print-footer {
        display: block !important;
        page-break-inside: avoid;
        margin-top: 15px !important;
        padding-top: 10px !important;
        font-size: 8pt !important;
      }
      
      .print-footer p {
        margin: 3px 0 !important;
        font-size: 8pt !important;
      }
      
      .print-footer strong {
        font-size: 8.5pt;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Print-only header -->
    <div class="print-header">
      <h2 style="margin:0;font-size:18pt;">FENI MODEL HIGH SCHOOL</h2>
      <p style="margin:5px 0;font-size:11pt;">Daily Attendance Report</p>
    </div>
    
    <h1 id="pageTitle">üìÖ Today's Attendance</h1>
    
    <!-- Print-only info section -->
    <div class="print-info" id="printInfo">
      <div class="print-info-item">
        <span class="print-info-label">Class:</span>
        <span id="printClass">-</span>
      </div>
      <div class="print-info-item">
        <span class="print-info-label">Section:</span>
        <span id="printSection">-</span>
      </div>
      <div class="print-info-item">
        <span class="print-info-label">Date:</span>
        <span id="printDate">-</span>
      </div>
      <div class="print-info-item">
        <span class="print-info-label">Printed:</span>
        <span id="printTime">-</span>
      </div>
    </div>
    
    <div class="controls">
      <div class="filter-group">
        <label for="dateFilter">üìÖ Date:</label>
        <input type="date" id="dateFilter" />
      </div>
      <div class="filter-group">
        <label for="classFilter">Class:</label>
        <select id="classFilter">
          <option value="">Select Class</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="sectionFilter">Section:</label>
        <select id="sectionFilter" disabled>
          <option value="">Select Section</option>
        </select>
      </div>
      <button id="refresh" class="btn">üîÑ Refresh</button>
      <div id="status" class="muted">Ready</div>
    </div>

    <div id="error" class="error"></div>

    <div class="stats-container">
      <div class="stat-box">
        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</div>
        <div class="stat-value" id="totalCount">0</div>
      </div>
      <div class="stat-box present">
        <div class="stat-label">‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§</div>
        <div class="stat-value" id="presentCount">0</div>
      </div>
      <div class="stat-box absent">
        <div class="stat-label">‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§</div>
        <div class="stat-value" id="absentCount">0</div>
      </div>
    </div>

    <table id="reportTable">
      <thead>
        <tr><th class="col-center">Roll</th><th class="col-center">üÜî IID</th><th>üë§ Student Name</th><th>‚è∞ In Time</th><th>‚è∞ Out Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="print-footer" style="display:none;margin-top:20px;padding-top:15px;border-top:1px solid #ccc;font-size:10pt;color:#666;">
      <p style="margin:5px 0;"><strong>Note:</strong> * indicates student without RFID card | Highlighted rows indicate present students</p>
      <div style="display:flex;justify-content:space-between;margin-top:15px;">
        <div>
          <p style="margin:5px 0;">__________________________</p>
          <p style="margin:0;font-size:9pt;">Teacher's Signature</p>
        </div>
        <div>
          <p style="margin:5px 0;">__________________________</p>
          <p style="margin:0;font-size:9pt;">Head Teacher's Signature</p>
        </div>
      </div>
    </div>

    <div class="print-section">
      <button id="printBtn" class="btn btn-print">üñ®Ô∏è Print Report</button>
    </div>
  </div>

  <!-- Load Supabase UMD (creates window.supabase). If not present, the module import will be used. -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    // --- CONFIG: replace with your project's values ---
    const SUPABASE_URL = 'https://rtfefxghfbtirfnlbucb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZmVmeGdoZmJ0aXJmbmxidWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MDg3OTcsImV4cCI6MjA1NjA4NDc5N30.fb7_myCmFzbV7WPNjFN_NEl4z0sOmRCefnkQbk6c10w';
    // --------------------------------------------------

    // Supabase client is now configured

    // Prefer the UMD client created on window (admin-dashboard does this). Fall back to ESM createClient import.
    let supabase;
    if (window.supabase && typeof window.supabase.createClient === 'function') {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    const tableBody = document.querySelector('#reportTable tbody');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const classFilter = document.getElementById('classFilter');
    const sectionFilter = document.getElementById('sectionFilter');
    const dateFilter = document.getElementById('dateFilter');
    const totalCountEl = document.getElementById('totalCount');
    const presentCountEl = document.getElementById('presentCount');
    const absentCountEl = document.getElementById('absentCount');

    // Today's date in YYYY-MM-DD format
    const today = new Date().toISOString().split('T')[0];
    
    // Set default date to today
    dateFilter.value = today;

    // Update page title with selected date
    function updatePageTitle() {
      const selectedDate = new Date(dateFilter.value + 'T00:00:00');
      const formattedDate = selectedDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      const titleElement = document.getElementById('pageTitle');
      if (titleElement) {
        titleElement.textContent = `üìÖ ${formattedDate} Attendance`;
      }
    }
    
    updatePageTitle();

    // Load class filter
    async function loadClassFilter() {
      try {
        const { data: classes, error: classError } = await supabase
          .from('student_database')
          .select('active_class')
          .not('active_class', 'is', null)
          .order('active_class');

        if (classError) throw classError;

        const uniqueClasses = [...new Set(classes.map(c => c.active_class))].sort();
        
        // Clear existing options except first
        classFilter.innerHTML = '<option value="">Select Class</option>';
        
        uniqueClasses.forEach(cls => {
          const option = document.createElement('option');
          option.value = cls;
          option.textContent = cls;
          classFilter.appendChild(option);
        });
      } catch (err) {
        console.error('Error loading class filter:', err);
      }
    }

    // Load sections based on selected class
    async function loadSectionFilter() {
      const selectedClass = classFilter.value;
      
      // Reset section dropdown
      sectionFilter.innerHTML = '<option value="">Select Section</option>';
      
      if (!selectedClass) {
        sectionFilter.disabled = true;
        return;
      }

      try {
        const { data: sections, error: sectionError } = await supabase
          .from('student_database')
          .select('active_section')
          .eq('active_class', selectedClass)
          .not('active_section', 'is', null)
          .order('active_section');

        if (sectionError) throw sectionError;

        const uniqueSections = [...new Set(sections.map(s => s.active_section))].sort();
        
        uniqueSections.forEach(sec => {
          const option = document.createElement('option');
          option.value = sec;
          option.textContent = sec;
          sectionFilter.appendChild(option);
        });
        
        sectionFilter.disabled = false;
      } catch (err) {
        console.error('Error loading section filter:', err);
        sectionFilter.disabled = true;
      }
    }

    async function loadEntries() {
      statusEl.textContent = 'Loading...';
      errorEl.style.display = 'none';

      const selectedClass = classFilter.value;
      const selectedSection = sectionFilter.value;

      // Validate filters
      if (!selectedClass) {
        tableBody.innerHTML = '<tr><td colspan="5" class="muted">Please select a class first. üìã</td></tr>';
        statusEl.textContent = 'Please select a class';
        totalCountEl.textContent = '0';
        presentCountEl.textContent = '0';
        absentCountEl.textContent = '0';
        return;
      }

      if (!selectedSection) {
        tableBody.innerHTML = '<tr><td colspan="5" class="muted">Please select a section. üìã</td></tr>';
        statusEl.textContent = 'Please select a section';
        totalCountEl.textContent = '0';
        presentCountEl.textContent = '0';
        absentCountEl.textContent = '0';
        return;
      }

      try {
        // Get students (include those without RFID)
        const { data: students, error: studentError } = await supabase
          .from('student_database')
          .select('iid, rfid_card_no, student_name_en, active_roll, active_class, active_section')
          .eq('active_class', selectedClass)
          .eq('active_section', selectedSection)
          .order('active_roll', { ascending: true });

        if (studentError) throw studentError;

        // Get selected date
        const selectedDate = dateFilter.value;

        // Get attendance entries for selected date
        const { data: attendanceData, error: attendanceError } = await supabase
          .from('attendence_entry')
          .select('*')
          .eq('attendence_date', selectedDate)
          .order('attendence_time', { ascending: true });

        if (attendanceError) throw attendanceError;

        // Group attendance by RFID to find first and last scan times
        const rfidScans = new Map();
        if (attendanceData && attendanceData.length > 0) {
          attendanceData.forEach(entry => {
            const rfid = entry.rfid_card_no;
            if (!rfid) return;

            if (!rfidScans.has(rfid)) {
              rfidScans.set(rfid, { first: entry.attendence_time, last: entry.attendence_time });
            } else {
              rfidScans.get(rfid).last = entry.attendence_time;
            }
          });
        }

        // Helper function to format time
        function formatTime(timeStr) {
          if (!timeStr) return '-';
          if (timeStr.includes(':')) {
            const [hours, minutes] = timeStr.split(':');
            const hour24 = parseInt(hours);
            const ampm = hour24 >= 12 ? 'PM' : 'AM';
            const hour12 = hour24 % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
          }
          return timeStr;
        }

        tableBody.innerHTML = '';
        if (!students || students.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" class="muted">No students found with the selected filters. üì≠</td></tr>';
          statusEl.textContent = 'No students found';
          totalCountEl.textContent = '0';
          presentCountEl.textContent = '0';
          absentCountEl.textContent = '0';
          return;
        }

        let presentCount = 0;

        for (const student of students) {
          const tr = document.createElement('tr');
          const hasRfid = student.rfid_card_no && student.rfid_card_no.trim() !== '';
          const scans = hasRfid ? rfidScans.get(student.rfid_card_no) : null;
          const inTime = scans ? formatTime(scans.first) : '-';
          const outTime = scans ? formatTime(scans.last) : '-';

          // Check if present
          const isPresent = !!scans;
          if (isPresent) presentCount++;

          // Add * marker if no RFID
          const rollDisplay = hasRfid
            ? (student.active_roll ?? '-')
            : `${student.active_roll ?? '-'}<span class="no-rfid-marker">*</span>`;

          tr.innerHTML = `
            <td class="col-center">${rollDisplay}</td>
            <td class="col-center">${student.iid ?? '-'}</td>
            <td class="student-name">${student.student_name_en ?? '-'}</td>
            <td class="time-display">${inTime}</td>
            <td class="time-display">${outTime}</td>
          `;
          if (isPresent) {
            tr.style.backgroundColor = '#d1fae5';
          }
          tableBody.appendChild(tr);
        }

        // Update statistics
        const totalStudents = students.length;
        const absentCount = totalStudents - presentCount;

        totalCountEl.textContent = totalStudents;
        presentCountEl.textContent = presentCount;
        absentCountEl.textContent = absentCount;

        statusEl.textContent = `Loaded ${totalStudents} students (${presentCount} present, ${absentCount} absent) ‚úÖ`;
      } catch (err) {
        console.error(err);
        errorEl.style.display = 'block';
        errorEl.textContent = 'Error loading data: ' + (err.message || JSON.stringify(err));
        statusEl.textContent = 'Error';
      }
    }

    // Event listeners
    document.getElementById('refresh').addEventListener('click', loadEntries);
    
    // Print button event listener
    document.getElementById('printBtn').addEventListener('click', preparePrint);
    
    // test helper removed
    
    // Function to update print info without printing (for test button)
    function preparePrintInfo() {
      updatePrintValues();
    }
    
    classFilter.addEventListener('change', () => {
      loadSectionFilter();
      // Clear table when class changes
      tableBody.innerHTML = '<tr><td colspan="5" class="muted">Please select a section. üìã</td></tr>';
      statusEl.textContent = 'Please select a section';
      totalCountEl.textContent = '0';
      presentCountEl.textContent = '0';
      absentCountEl.textContent = '0';
    });
    
    sectionFilter.addEventListener('change', loadEntries);
    
    dateFilter.addEventListener('change', () => {
      updatePageTitle();
      if (classFilter.value && sectionFilter.value) {
        loadEntries();
      }
    });

    // Update print info values (called before print)
    function updatePrintValues() {
      console.log('=== Updating Print Values ===');
      
      const printClassEl = document.getElementById('printClass');
      const printSectionEl = document.getElementById('printSection');
      const printDateEl = document.getElementById('printDate');
      const printTimeEl = document.getElementById('printTime');
      
      // Get current values from filters
      const classValue = classFilter ? classFilter.value : '';
      const sectionValue = sectionFilter ? sectionFilter.value : '';
      const dateValue = dateFilter ? dateFilter.value : '';
      
      console.log('Current filter values:', { classValue, sectionValue, dateValue });
      
      // Update Class
      if (printClassEl) {
        const text = classValue || 'Not Selected';
        printClassEl.textContent = text;
        printClassEl.innerText = text;
        console.log('Updated printClass:', text);
      }
      
      // Update Section
      if (printSectionEl) {
        const text = sectionValue || 'Not Selected';
        printSectionEl.textContent = text;
        printSectionEl.innerText = text;
        console.log('Updated printSection:', text);
      }
      
      // Update Date
      if (printDateEl) {
        let text = 'Not Selected';
        if (dateValue) {
          try {
            const selectedDate = new Date(dateValue + 'T00:00:00');
            text = selectedDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          } catch (e) {
            console.error('Date formatting error:', e);
          }
        }
        printDateEl.textContent = text;
        printDateEl.innerText = text;
        console.log('Updated printDate:', text);
      }
      
      // Update Print Time
      if (printTimeEl) {
        const now = new Date();
        const text = now.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
        printTimeEl.textContent = text;
        printTimeEl.innerText = text;
        console.log('Updated printTime:', text);
      }
      
      console.log('=== Print Values Update Complete ===');
    }
    
    // Browser's beforeprint event - fires right before print dialog
    window.addEventListener('beforeprint', function() {
      console.log('Before print event fired');
      updatePrintValues();
    });
    
    // Prepare print information and make it globally accessible
    function preparePrint() {
      try {
        console.log('preparePrint called');
        
        // Update print info immediately
        updatePrintValues();
        
        // Force a reflow
        document.body.offsetHeight;
        
        // Trigger print
        window.print();
        
      } catch (error) {
        console.error('Error preparing print:', error);
        alert('Error preparing print. Please try again.');
      }
    }
    
    // Make function globally accessible
    window.preparePrint = preparePrint;

    // Initial load
    loadClassFilter();
  </script>
</body>
</html>
